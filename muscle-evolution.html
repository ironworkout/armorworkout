<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArmorWorkout - Suivi Évolution</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        /* --- Variables Globales & Thèmes (Inspiré de l'image + Modifs) --- */
        :root {
            /* Thème Sombre (Défaut) */
            --bg-color-dark: #0a0f1e;
            --secondary-bg-color-dark: #141a30;
            --primary-text-color-dark: #e0e0ff;
            --secondary-text-color-dark: #8a94c1;
            --border-color-dark: #2a3150;
            --accent-border-color-dark: #4b558a;
            --input-bg-dark: #0a0f1e;

            /* Couleurs "Néon" / Gradient */
            --neon-blue: #6fa8ff;
            --neon-purple: #b18cff;
            --gradient-start: var(--neon-purple);
            --gradient-end: var(--neon-blue);
            --neon-green: #3fb950; /* Succès / Atteint */
            --neon-red: #ff7b72; /* Erreur / Déconnexion */
            --neon-orange: #f9a825; /* Warning */
            --neon-yellow: #facc15; /* Loading / Attention */

            /* Couleurs Niveaux (RGBA pour bg transparent) */
            --level-beginner-color: #8a94c1; --level-beginner-bg: rgba(138, 148, 193, 0.1);
            --level-bronze-color: #cd7f32;   --level-bronze-bg: rgba(205, 127, 50, 0.15);
            --level-silver-color: #c0c0c0;   --level-silver-bg: rgba(192, 192, 192, 0.15);
            --level-gold-color: #ffd700;     --level-gold-bg: rgba(255, 215, 0, 0.15);
            --level-crystal-color: #a7d8de;  --level-crystal-bg: rgba(167, 216, 222, 0.15);
            --level-master-color: #e384f1;   --level-master-bg: rgba(227, 132, 241, 0.15);
            --level-champion-color: #ff7b72; --level-champion-bg: rgba(255, 123, 114, 0.15);
            --level-titan-color: #aa99ff;    --level-titan-bg: rgba(170, 153, 255, 0.15); /* Violet pâle */
            --level-legende-color: #fff7a3;  --level-legende-bg: rgba(255, 247, 163, 0.2); /* Or très pâle / Blanc cassé */
            --level-marvel-color: #e62429;   --level-marvel-bg: rgba(230, 36, 41, 0.1);   /* Rouge Marvel */

            /* Glows */
            --glow-gradient: 0 0 20px rgba(177, 140, 255, 0.4), 0 0 30px rgba(111, 168, 255, 0.3);
            --glow-level-reached: 0 0 15px rgba(63, 185, 80, 0.7);
            --glow-connect: 0 0 10px rgba(63, 185, 80, 0.6);
            --glow-disconnect: 0 0 10px rgba(255, 123, 114, 0.6);

            /* Autres */
            --font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --border-radius-lg: 18px;
            --border-radius-md: 12px;
            --border-radius-sm: 8px;
            --transition-speed: 0.3s;

            /* RGBA */
            --bg-color-dark-rgb: 10, 15, 30;
            --secondary-bg-color-dark-rgb: 20, 26, 48;
            --primary-text-color-dark-rgb: 224, 224, 255;
            --secondary-text-color-dark-rgb: 138, 148, 193;
            --border-color-dark-rgb: 42, 49, 80;
            --neon-blue-rgb: 111, 168, 255;
            --neon-purple-rgb: 177, 140, 255;
            --neon-green-rgb: 63, 185, 80;
            --neon-red-rgb: 255, 123, 114;
            --neon-orange-rgb: 249, 168, 37;

            /* Application Thème Sombre par défaut */
            --bg-color: var(--bg-color-dark);
            --secondary-bg-color: var(--secondary-bg-color-dark);
            --primary-text-color: var(--primary-text-color-dark);
            --secondary-text-color: var(--secondary-text-color-dark);
            --border-color: var(--border-color-dark);
            --accent-border-color: var(--accent-border-color-dark);
            --input-bg: var(--input-bg-dark);
            --bg-color-rgb: var(--bg-color-dark-rgb);
            --secondary-bg-color-rgb: var(--secondary-bg-color-dark-rgb);
            /* ... autres variables rgb ... */

            /* Styles spécifiques */
            --link-color: var(--neon-blue);
            --button-connect-color: var(--neon-green);
            --button-connect-glow: var(--glow-connect);
            --button-disconnect-color: var(--neon-red);
            --button-disconnect-glow: var(--glow-disconnect);

            /* Barres de progression */
            --progress-bar-bg: rgba(var(--primary-text-color-rgb), 0.1);
            --progress-bar-fill: linear-gradient(90deg, var(--gradient-start), var(--gradient-end));
        }

        /* --- Styles de Base & Réinitialisation --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; font-size: 16px; }
        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--primary-text-color);
            line-height: 1.6;
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
            padding-top: 90px; /* Espace ajusté pour header fixe */
        }
        .container {
            max-width: 450px; /* Mobile-first */
            margin: 0 auto;
            padding: 20px 15px;
            width: 100%;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        /* --- En-tête Simplifié --- */
        header {
            position: fixed; top: 0; left: 0; width: 100%; padding: 15px 0;
            z-index: 1000; background-color: rgba(var(--bg-color-rgb), 0.85);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border-color);
            transition: border-color var(--transition-speed) ease, background-color var(--transition-speed) ease;
        }
        .header-content {
            display: flex; flex-direction: column; align-items: center;
            max-width: 450px; margin: 0 auto; padding: 0 15px; gap: 12px;
        }
        header .title-container { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        header .title-container i.header-icon { font-size: 1.8em; color: var(--primary-text-color); opacity: 0.8; }
        header h1 {
            font-size: 1.1em; color: var(--primary-text-color); margin: 0;
            font-weight: 500; letter-spacing: 0.1em; text-transform: uppercase;
        }
        .header-actions { display: flex; gap: 15px; align-items: center; justify-content: center; width: 100%; }
        .auth-controls { display: flex; gap: 10px; align-items: center; }
        .auth-controls button {
            background: none; border: 1px solid var(--border-color); color: var(--secondary-text-color);
            padding: 5px 12px; border-radius: var(--border-radius-md); font-size: 0.8em;
            font-weight: 500; cursor: pointer; transition: all var(--transition-speed) ease;
            display: inline-flex; align-items: center; gap: 5px;
        }
        .auth-controls button:disabled { opacity: 0.4; cursor: not-allowed; background: transparent !important; border-color: var(--border-color) !important; color: var(--secondary-text-color) !important; box-shadow: none !important; }
        .auth-controls button:not(:disabled):hover { border-color: var(--accent-border-color); color: var(--primary-text-color); background-color: rgba(var(--primary-text-color-rgb), 0.05); }
        #signin-button, #signin-button-prompt { border-color: var(--button-connect-color); color: var(--button-connect-color); }
        #signin-button:not(:disabled):hover, #signin-button-prompt:not(:disabled):hover { background-color: rgba(var(--neon-green-rgb), 0.1); box-shadow: var(--button-connect-glow); }
        #signout-button { border-color: var(--button-disconnect-color); color: var(--button-disconnect-color); }
        #signout-button:not(:disabled):hover { background-color: rgba(var(--neon-red-rgb), 0.1); box-shadow: var(--button-disconnect-glow); }

        #drive-status { display: none; } /* Caché */
        .theme-toggle button { background: none; border: none; color: var(--secondary-text-color); font-size: 1.1em; padding: 5px; cursor: pointer; transition: color var(--transition-speed) ease; }
        .theme-toggle button:hover { color: var(--neon-purple); }

        /* Affichage conditionnel */
        body.logged-out #signin-button, body.logged-out #signin-button-prompt { display: inline-flex; }
        body.logged-out #signout-button { display: none; }
        body.logged-in #signin-button, body.logged-in #signin-button-prompt { display: none; }
        body.logged-in #signout-button { display: inline-flex; }
        body.logged-out #connection-prompt { display: block; }
        body.logged-in #connection-prompt { display: none; }
        body.logged-out #evolution-tracker-area { display: none; }
        body.logged-in #evolution-tracker-area { display: flex; }

        /* --- Contenu Principal --- */
        main { flex-grow: 1; display: flex; flex-direction: column; align-items: center; padding-top: 20px; }
        #connection-prompt { text-align: center; padding: 30px 20px; background-color: var(--secondary-bg-color); border-radius: var(--border-radius-lg); border: 1px dashed var(--border-color); margin: 20px auto; max-width: 90%; }
        #connection-prompt p { margin-bottom: 15px; color: var(--secondary-text-color); font-size: 0.9em;}
        #connection-prompt button { padding: 8px 18px; font-size: 0.9em; }

        /* Zone principale */
        #evolution-tracker-area { width: 100%; display: flex; flex-direction: column; gap: 20px; margin-top: 0; background: none; border: none; padding: 0; box-shadow: none; }

        /* Carte Principale ELO Score */
        .global-stats-card { background-color: var(--secondary-bg-color); border-radius: var(--border-radius-lg); padding: 25px 20px; text-align: center; border: 1px solid var(--border-color); box-shadow: 0 10px 30px rgba(0,0,0, 0.2); position: relative; overflow: hidden; }
        .global-stats-card::before { content: ''; position: absolute; top: -30%; left: -30%; width: 160%; height: 160%; background: radial-gradient(circle, rgba(var(--neon-blue-rgb), 0.08) 0%, rgba(var(--neon-blue-rgb), 0) 60%); animation: rotateGlow 15s linear infinite; pointer-events: none; opacity: 0.7; }
        @keyframes rotateGlow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .global-stats-card .card-title { font-size: 0.9em; color: var(--secondary-text-color); margin-bottom: 10px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; }
        #overall-elo-display .value { font-size: 4.5em; font-weight: 900; line-height: 1; margin-bottom: 15px; display: block; background: linear-gradient(90deg, var(--gradient-start), var(--gradient-end)); -webkit-background-clip: text; background-clip: text; color: transparent; text-shadow: var(--glow-gradient); animation: pulse-text 3s infinite ease-in-out; }
        @keyframes pulse-text { 0%, 100% { text-shadow: var(--glow-gradient); opacity: 1; } 50% { text-shadow: 0 0 15px rgba(177, 140, 255, 0.3), 0 0 25px rgba(111, 168, 255, 0.2); opacity: 0.95; } }
        #level-badge { display: inline-flex; align-items: center; gap: 8px; padding: 6px 15px; border-radius: var(--border-radius-md); font-size: 0.9em; font-weight: 700; margin-bottom: 8px; border: 1px solid transparent; transition: all var(--transition-speed) ease; cursor: help; /* Pour indiquer tooltip */ }
        #level-badge i { font-size: 1.2em; }
        #target-elo-info { font-size: 0.85em; color: var(--secondary-text-color); }
        #target-elo-info strong { font-weight: 700; color: var(--primary-text-color); }

        /* Animation spéciale passage niveau global */
         @keyframes levelUpGlow {
             0% { box-shadow: 0 10px 30px rgba(0,0,0, 0.2), 0 0 0px rgba(var(--neon-green-rgb), 0); border-color: var(--border-color);}
             50% { box-shadow: 0 10px 30px rgba(0,0,0, 0.1), 0 0 30px rgba(var(--neon-green-rgb), 0.7); border-color: var(--neon-green);}
             100% { box-shadow: 0 10px 30px rgba(0,0,0, 0.2), 0 0 0px rgba(var(--neon-green-rgb), 0); border-color: var(--border-color);}
         }


        /* Conteneur des groupes musculaires */
        #muscle-groups-container { display: flex; flex-direction: column; gap: 15px; }

        /* Carte pour un groupe musculaire */
        .muscle-group-card { background-color: var(--secondary-bg-color); border: 1px solid var(--border-color); border-radius: var(--border-radius-md); padding: 15px; display: flex; flex-direction: column; gap: 10px; transition: all var(--transition-speed) ease; position: relative; overflow: hidden; }
        .muscle-group-card:hover { border-color: var(--accent-border-color); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0, 0.15); }
        .muscle-group-card .card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 5px; }
        .muscle-group-card .icon-container { flex-shrink: 0; color: var(--secondary-text-color); font-size: 1.8em; width: 35px; text-align: center; opacity: 0.7; }
        .muscle-group-card .title-container { flex-grow: 1; }
        .muscle-group-card .group-title { font-size: 1.05em; font-weight: 700; color: var(--primary-text-color); line-height: 1.2; }
        .muscle-group-card .group-subtitle { font-size: 0.85em; color: var(--secondary-text-color); font-weight: 400; line-height: 1.2; margin-bottom: 2px; }
        /* Nouveau: Affichage du niveau atteint */
        .muscle-group-card .group-level-name {
            font-size: 0.8em; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.05em; line-height: 1; padding: 2px 6px;
            border-radius: var(--border-radius-sm); display: inline-block; margin-top: 4px;
            /* Couleur et fond seront ajoutés par JS */
         }
        .muscle-group-card .elo-details { font-size: 0.9em; font-weight: 500; color: var(--secondary-text-color); text-align: right; white-space: nowrap; }
        .muscle-group-card .elo-details .current { color: var(--primary-text-color); font-weight: 700; }
        .muscle-group-card .elo-details .target { /* Objectif (seuil suivant) */ }

        /* Conteneur Barre + Pourcentage */
        .progress-section { display: flex; align-items: center; gap: 10px; margin-top: 5px; }

        /* Barre de progression stylée */
        .progress-bar-container { flex-grow: 1; /* Prend l'espace restant */ height: 8px; background-color: var(--progress-bar-bg); border-radius: 4px; overflow: hidden; position: relative; }
        .progress-bar { height: 100%; width: 0%; background: var(--progress-bar-fill); border-radius: 4px; transition: width 0.8s cubic-bezier(0.25, 1, 0.5, 1); box-shadow: var(--glow-gradient); }
        /* Affichage Numérique Pourcentage */
        .progress-percentage-value {
            font-size: 0.9em; font-weight: 700; color: var(--secondary-text-color);
            flex-shrink: 0; /* Ne réduit pas sa taille */
            width: 40px; /* Espace réservé */
            text-align: right;
            transition: color 0.3s ease;
        }

        /* Style pour objectif atteint sur une carte */
        .muscle-group-card.level-target-reached { border-color: var(--neon-green); box-shadow: 0 0 15px rgba(var(--neon-green-rgb), 0.3); }
        .muscle-group-card.level-target-reached .progress-percentage-value { color: var(--neon-green); }
         /* Checkmark indicateur (optionnel mais sympa) */
        .muscle-group-card.level-target-reached::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute; top: 10px; right: 10px; color: var(--neon-green); font-size: 0.9em; opacity: 0; animation: fadeInCheck 0.5s 0.5s ease forwards; }
         @keyframes fadeInCheck{ from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }


        /* Pied de page simplifié */
        footer { color: var(--secondary-text-color); opacity: 0.6; border-top: 1px solid var(--border-color); margin-top: 40px; padding: 20px 15px; text-align: center; font-size: 0.8em; transition: border-color var(--transition-speed) ease, color var(--transition-speed) ease; }
        footer a { color: var(--link-color); text-decoration: none; }
        footer a:hover { color: var(--primary-text-color); }

        /* Zone de Messages Flottante */
        .message-area { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(var(--secondary-bg-color-rgb), 0.9); color: var(--primary-text-color); border: 1px solid var(--border-color); padding: 10px 20px; border-radius: var(--border-radius-md); z-index: 3000; opacity: 0; transition: opacity 0.5s ease, transform 0.5s ease, bottom 0.5s ease; pointer-events: none; font-size: 0.9em; box-shadow: 0 4px 15px rgba(0,0,0,0.2); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); max-width: 90%; text-align: center; }
        .message-area.visible { opacity: 1; transform: translate(-50%, 0); bottom: 30px; pointer-events: auto; }
        .message-area.error { background-color: rgba(var(--neon-red-rgb), 0.9); color: #fff; border-color: var(--neon-red); }
        .message-area.success { background-color: rgba(var(--neon-green-rgb), 0.9); color: #fff; border-color: var(--neon-green); }
        .message-area.warning { background-color: rgba(var(--neon-orange-rgb), 0.9); color: #fff; border-color: var(--neon-orange); }
        .message-area.info { background-color: rgba(var(--neon-blue-rgb), 0.9); color: #fff; border-color: var(--neon-blue); }

        /* Placeholder/Error styling */
        #muscle-groups-container .loading-placeholder,
        #muscle-groups-container .error-placeholder { background-color: var(--secondary-bg-color); border-radius: var(--border-radius-md); padding: 30px 20px; text-align: center; color: var(--secondary-text-color); font-style: italic; border: 1px dashed var(--border-color); margin-top: 10px; }
        #muscle-groups-container .error-placeholder { color: var(--neon-red); border-color: var(--neon-red); }

        /* Responsive (Minime car mobile-first) */
        @media (min-width: 768px) {
             .container { max-width: 600px; }
             .header-content { flex-direction: row; justify-content: space-between; max-width: 900px;}
             .header-actions { width: auto; }
             body { padding-top: 80px; }
        }
    </style>
</head>
<body class="logged-out dark-theme">

<header>
    <div class="header-content">
         <div class="title-container">
             <i class="fas fa-shield header-icon"></i>
             <h1>ArmorWorkout</h1>
         </div>
        <div class="header-actions">
            <div class="auth-controls">
                <button id="signin-button" disabled><i class="fab fa-google"></i> Connexion</button>
                <button id="signout-button" disabled><i class="fas fa-sign-out-alt"></i> Déconnexion</button>
            </div>
             <span id="drive-status" aria-live="polite"></span>
            <div class="theme-toggle">
                <button id="theme-toggle-btn" aria-label="Basculer le thème"><i class="fas fa-sun"></i></button>
            </div>
        </div>
    </div>
</header>

<div class="container">
    <main>
        <div id="connection-prompt">
            <p>Connectez-vous via Google pour suivre votre évolution.</p>
            <button id="signin-button-prompt" disabled><i class="fab fa-google"></i> Se connecter</button>
        </div>

        <div id="evolution-tracker-area">
            <!-- Carte Stats Globales -->
            <div class="global-stats-card">
                 <div class="card-title">Upper Body ELO Score</div>
                 <div id="overall-elo-display">
                     <span class="value">--</span>
                 </div>
                 <div id="level-badge" class="level-unknown" title="Niveau global basé sur l'ELO moyen">
                      <i class="fas fa-question-circle"></i>
                      <span>Indéterminé</span>
                 </div>
                 <div id="target-elo-info">
                      Objectif (Niv. Suivant): <strong>-- ELO</strong>
                 </div>
            </div>

            <!-- Section Groupes Musculaires -->
            <div id="muscle-groups-container" aria-live="polite">
                 <p class="loading-placeholder">Connectez-vous pour charger vos données...</p>
            </div>
        </div>
    </main>
</div>

<footer>
     <p>© 2024 ArmorWorkout | <a href="https://github.com/ironworkout/armorworkout" target="_blank" rel="noopener noreferrer"><i class="fab fa-github" aria-hidden="true"></i> GitHub</a></p>
</footer>

<!-- Zone de Message Flottante -->
<div id="message-area" class="message-area" role="status" aria-live="polite"></div>

<!-- Google Identity Services Script -->
<script async defer src="https://accounts.google.com/gsi/client"></script>

<script>
    // --- CONFIGURATION & CONSTANTES ---
    const GOOGLE_CLIENT_ID = "731283926358-viam3ulpgna14flfdeb9m92l8s620hoi.apps.googleusercontent.com";
    const GOOGLE_DRIVE_SCOPES = 'https://www.googleapis.com/auth/drive.file';
    const PROGRAM_FILENAMES = { Push: "armorworkout_push_program.json", Pull: "armorworkout_pull_program.json", Legs: "armorworkout_legs_program.json" };
    const PROGRAM_TYPES = ['Push', 'Pull', 'Legs'];
    const GIS_CHECK_INTERVAL = 100;
    const GIS_MAX_RETRIES = 50;

    // --- PARAMÈTRES ELO ---
    const ELO_BASE = 800; // Seuil pour entrer dans "Débutant"
    const INTENSITY_TECHNIQUE_BONUS_MULTIPLIER = 1.05;
    const POLYARTICULAR_WEIGHT = 1.2;
    const ISOLATION_WEIGHT = 1.0;
    const RESISTANCE_BONUS = { 'Bodyweight': 75, 'Haltères 5kg': 50, 'Élastique 15kg': 50, 'Élastique 15kg doublé': 100, 'Élastique 25kg': 125, 'Élastique 15+25kg': 200, 'Élastique 15+25kg + 1 haltère 5kg': 225, 'Élastique 15+25kg + 2x5kg haltères': 250 };
    const REPS_FACTORS = { 8: 0.9, 12: 1.0, 18: 1.2, 25: 1.3, Infinity: 1.4 };

    // --- NIVEAUX & DESCRIPTIONS PHYSIQUES ---
    // Chaque niveau a un minELO requis pour y entrer.
    const TARGET_ELO_LEVELS = {
        'L0_Base':    { name: "Débutant",      minELO: 0,    description: "Point de départ. Focus sur la technique et la régularité. Le potentiel est là !", colorVar: '--level-beginner-color', bgVar: '--level-beginner-bg', iconClass: 'fa-seedling' },
        'L1_Bronze':  { name: "Bronze",        minELO: 800,  description: "Fondations posées. Force de base acquise, les muscles commencent à répondre aux stimulis. Légère amélioration de la posture et de l'endurance.", colorVar: '--level-bronze-color',   bgVar: '--level-bronze-bg',   iconClass: 'fa-shield-halved' },
        'L2_Silver':  { name: "Argent",        minELO: 950,  description: "Physique athlétique naissant. Les formes musculaires principales (pecs, dos, épaules, bras) sont visibles, surtout sous tension. Début de définition légère.", colorVar: '--level-silver-color',   bgVar: '--level-silver-bg',   iconClass: 'fa-shield' },
        'L3_Gold':    { name: "Or",            minELO: 1050, description: "Force confirmée, muscles plus denses et pleins. La définition est visible même au repos léger. Bonne séparation entre les groupes musculaires.", colorVar: '--level-gold-color',     bgVar: '--level-gold-bg',     iconClass: 'fa-trophy' },
        'L4_Crystal': { name: "Crystal",       minELO: 1150, description: "Niveau avancé. Volume musculaire significatif et définition nette. La vascularité peut commencer à apparaître. Physique impressionnant et équilibré.", colorVar: '--level-crystal-color',  bgVar: '--level-crystal-bg',  iconClass: 'fa-gem' },
        'L5_Master':  { name: "Master",        minELO: 1250, description: "Maîtrise physique. Muscles très développés, striés et secs. Force fonctionnelle élevée. Physique esthétique et performant.", colorVar: '--level-master-color',   bgVar: '--level-master-bg',   iconClass: 'fa-crown' },
        'L6_Champion':{ name: "Champion",      minELO: 1350, description: "Élite. Volume et définition exceptionnels. Chaque groupe musculaire est ciselé. Force et endurance remarquables.", colorVar: '--level-champion-color', bgVar: '--level-champion-bg', iconClass: 'fa-skull-crossbones' },
        'L7_Titan':   { name: "Titan",         minELO: 1500, description: "Force herculéenne et physique massif. Dépassement des limites conventionnelles. Présence imposante.", colorVar: '--level-titan-color',    bgVar: '--level-titan-bg',    iconClass: 'fa-mountain-sun' },
        'L8_Legende': { name: "Legende",       minELO: 1650, description: "Statut mythique. Incarnation de la puissance et de l'esthétique ultime. Un physique qui inspire.", colorVar: '--level-legende-color',  bgVar: '--level-legende-bg',  iconClass: 'fa-meteor' },
        // --- Niveau Benchmark Spécial ---
        'L_Marvel':   { name: "Marvel Physique", targetELO: 1200, description: "Esthétique super-héroïque : athlétique, définie, fonctionnelle. Muscles dessinés, faible masse grasse.", colorVar: '--level-marvel-color', bgVar: '--level-marvel-bg', iconClass: 'fa-bolt-lightning' }
    };
    // Ordre pour la progression linéaire (Marvel n'est pas inclus ici)
    const LEVEL_ORDER = ['L0_Base', 'L1_Bronze', 'L2_Silver', 'L3_Gold', 'L4_Crystal', 'L5_Master', 'L6_Champion', 'L7_Titan', 'L8_Legende'];

    // Groupes affichés et icônes
    const MUSCLE_GROUPS_DISPLAY_CONFIG = {
        "Chest":    { subtitle: "Pectoraux", icon: 'fa-dot-circle' }, // Icône plus abstraite/moderne
        "Back":     { subtitle: "Dos",       icon: 'fa-bars-staggered' }, // Lignes pour le dos
        "Shoulders":{ subtitle: "Épaules",   icon: 'fa-atom' }, // Pour la forme ronde/complexe
        "Biceps":   { subtitle: "Biceps",    icon: 'fa-link' }, // Maillon pour force/connexion
        "Triceps":  { subtitle: "Triceps",   icon: 'fa-diamond' }, // Pour la forme en "fer à cheval"
        "Core":     { subtitle: "Core",      icon: 'fa-bullseye' } // Cible/centre
    };
    const LOGIC_TO_DISPLAY_MAP = { Pectoraux: "Chest", Dos: "Back", Épaules: "Shoulders", Biceps: "Biceps", Triceps: "Triceps", Core: "Core" };
    const ALL_MUSCLE_GROUPS_LOGIC = Object.keys(LOGIC_TO_DISPLAY_MAP);

    // --- Éléments DOM ---
    let signInButton, signOutButton, driveStatusElement, themeToggleBtn,
        signInButtonPrompt, connectionPrompt, evolutionTrackerArea,
        overallEloDisplayValue, levelBadge, levelBadgeIcon, levelBadgeText,
        targetEloInfoStrong, muscleGroupsContainer, messageArea;

    // --- Variables d'État ---
    let googleAccessToken = null; let tokenClient = null; let programFileIds = { Push: null, Pull: null, Legs: null };
    let loadedPrograms = { Push: [], Pull: [], Legs: [] }; let programsAnalysisStatus = 'pending';
    let currentELOValues = {}; let overallAvgELO = ELO_BASE; // Commence à la base
    let currentGlobalLevelKey = LEVEL_ORDER[0]; // Clé du niveau global actuel
    let currentTheme = 'dark'; let messageTimeoutId = null; let gisCheckRetries = 0;
    let previousOverallAvgELO = null; // Pour détecter passage de niveau global

    // --- Audio & Google API Stubs (Identiques aux versions précédentes) ---
    let audioContext = null;
    function initAudioContext() { /* ... identique ... */ }
    function playSound(type = 'confirm', volume = 0.15) { /* ... identique, inclut level_up ... */ }
    async function gisInitInternal() { /* ... identique ... */ }
    function checkAndInitGis() { /* ... identique ... */ }
    function handleTokenError(error) { /* ... identique ... */ }
    async function tokenCallback(tokenResponse) { /* ... identique, reset previousOverallAvgELO ... */ }
    function handleAuthClick() { /* ... identique ... */ }
    function handleSignoutClick(showMessages = true) { /* ... identique, reset previousOverallAvgELO ... */ }
    async function findFileId(filename) { /* ... identique ... */ }
    async function readFileContent(fileId) { /* ... identique ... */ }
    async function loadProgramsFromDrive() { /* ... identique ... */ }

     // --- Audio ---
     function initAudioContext() { if (!audioContext && typeof AudioContext !== 'undefined') { try { audioContext = new AudioContext(); } catch (e) { console.warn("AudioContext non supporté ou bloqué.", e); } } }
     function playSound(type = 'confirm', volume = 0.15) { if (!audioContext) return; try { const o = audioContext.createOscillator(), g = audioContext.createGain(); o.connect(g); g.connect(audioContext.destination); g.gain.setValueAtTime(0, audioContext.currentTime); g.gain.linearRampToValueAtTime(volume, audioContext.currentTime + 0.01); const t = audioContext.currentTime; switch (type) { case 'confirm': o.type = 'sine'; o.frequency.setValueAtTime(523.25, t); o.frequency.linearRampToValueAtTime(783.99, t + 0.1); break; case 'error': o.type = 'square'; o.frequency.setValueAtTime(220, t); o.frequency.linearRampToValueAtTime(110, t + 0.15); break; case 'level_up': o.type = 'triangle'; g.gain.linearRampToValueAtTime(volume * 1.2, t + 0.01); o.frequency.setValueAtTime(440, t); o.frequency.linearRampToValueAtTime(554.37, t + 0.08); o.frequency.linearRampToValueAtTime(659.25, t + 0.16); o.frequency.linearRampToValueAtTime(880, t + 0.24); g.gain.exponentialRampToValueAtTime(0.0001, t + 0.4); o.stop(t + 0.4); break; default: o.type = 'triangle'; o.frequency.setValueAtTime(659.25, t); break; } if (type !== 'level_up') { o.start(t); g.gain.exponentialRampToValueAtTime(0.0001, t + 0.2); o.stop(t + 0.2); } else { o.start(t); } } catch (e) { console.warn("Erreur lecture son:", e); } }
     // --- Google Identity Services & Drive API ---
     async function gisInitInternal() { try { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: GOOGLE_CLIENT_ID, scope: GOOGLE_DRIVE_SCOPES, callback: tokenCallback, error_callback: handleTokenError, }); console.log("GIS Token Client initialisé."); updateAuthUI(googleAccessToken !== null); } catch (error) { console.error("Erreur init GIS:", error); showMessage("Impossible d'init Google.", 5000, 'error'); if (signInButton) signInButton.disabled = true; if (signInButtonPrompt) signInButtonPrompt.disabled = true; } }
     function checkAndInitGis() { if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) { console.log("GIS prêt, init..."); gisInitInternal(); } else if (gisCheckRetries < GIS_MAX_RETRIES) { gisCheckRetries++; console.log(`GIS non prêt, retry ${gisCheckRetries}/${GIS_MAX_RETRIES}...`); setTimeout(checkAndInitGis, GIS_CHECK_INTERVAL); } else { console.error("Échec chargement GIS."); showMessage("Service Auth Google indisponible.", 6000, 'error'); if (signInButton) signInButton.disabled = true; if (signInButtonPrompt) signInButtonPrompt.disabled = true;} }
     function handleTokenError(error) { console.error("Erreur Auth Google:", error); let msg = "Erreur connexion Google."; if (error?.type === 'popup_closed_by_user') msg = "Connexion annulée."; else if (error?.type === 'access_denied') msg = "Accès Drive refusé."; else if (error?.error === 'popup_blocked_by_browser') msg = "Popup connexion bloqué."; else if (error?.details) msg += ` Détails: ${error.details}`; showMessage(msg, 5000, 'error'); playSound('error'); googleAccessToken = null; previousOverallAvgELO = null; updateAuthUI(false); resetEvolutionDisplay(); }
     async function tokenCallback(tokenResponse) { if (tokenResponse.error) { handleTokenError(tokenResponse); return; } if (tokenResponse && tokenResponse.access_token) { console.log("Access Token reçu."); googleAccessToken = tokenResponse.access_token; previousOverallAvgELO = null; playSound('confirm'); showMessage("Connecté ! Analyse...", 2500, 'info'); if (muscleGroupsContainer) { muscleGroupsContainer.innerHTML = '<p class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i> Analyse Google Drive...</p>'; } resetEvolutionDisplay(); try { programsAnalysisStatus = await loadProgramsFromDrive(); console.log("Statut analyse:", programsAnalysisStatus); if (programsAnalysisStatus === 'success') { showMessage("Programmes analysés. Calcul...", 3000, 'success'); } else if (programsAnalysisStatus === 'partial') { showMessage("Programmes partiels/invalides. Évolution partielle.", 5000, 'warning'); } else { showMessage("Erreur chargement/analyse programmes.", 6000, 'error'); playSound('error'); } calculateAndDisplayEvolution(); } catch (error) { console.error("Erreur CRITIQUE chargement/analyse:", error); showMessage("Erreur majeure analyse.", 6000, 'error'); playSound('error'); programsAnalysisStatus = 'error'; if (muscleGroupsContainer) { muscleGroupsContainer.innerHTML = `<p class="error-placeholder">Erreur critique : ${error.message}</p>`; } resetEvolutionDisplay(); } finally { updateAuthUI(true); } } else { handleTokenError({ error: "invalid_response", details: "Réponse Google invalide." }); } }
     function handleAuthClick() { initAudioContext(); if (tokenClient) { console.log("Demande token Google..."); showMessage("Ouverture connexion Google...", 2000, 'info'); tokenClient.requestAccessToken({ prompt: '' }); } else { console.error("Auth sans tokenClient initialisé."); showMessage("Erreur : Service connexion non prêt.", 4000, 'error'); checkAndInitGis(); } }
     function handleSignoutClick(showMessages = true) { const token = googleAccessToken; if (!token) { console.log("Déjà déconnecté."); updateAuthUI(false); return; } initAudioContext(); if (showMessages) showMessage("Déconnexion...", 1500, 'info'); google.accounts.oauth2.revoke(token, () => { console.log('Token Google révoqué.'); googleAccessToken = null; programFileIds = { Push: null, Pull: null, Legs: null }; programsAnalysisStatus = 'pending'; loadedPrograms = { Push: [], Pull: [], Legs: [] }; currentELOValues = {}; overallAvgELO = ELO_BASE; currentGlobalLevelKey = LEVEL_ORDER[0]; previousOverallAvgELO = null; if (showMessages) { showMessage("Déconnecté.", 3000, 'info'); playSound('confirm'); } resetEvolutionDisplay(); updateAuthUI(false); }); }
     async function findFileId(filename) { if (!googleAccessToken) return null; try { const r = await fetch(`https://www.googleapis.com/drive/v3/files?q=name='${filename}' and trashed=false&fields=files(id, name)`, { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }); if (!r.ok) { if (r.status === 401 || r.status === 403) { console.warn(`Auth expirée (find ${filename}). Déco.`); handleSignoutClick(false); } else { console.error(`Erreur Drive (find ${filename}): ${r.status} ${r.statusText}`); } throw new Error(`Erreur Drive ${r.status}`); } const d = await r.json(); if (d.files && d.files.length > 0) return d.files[0].id; return null; } catch (e) { console.error(`Erreur recherche ${filename}:`, e); return null; } }
     async function readFileContent(fileId) { if (!googleAccessToken || !fileId) return null; try { const r = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }); if (!r.ok) { if (r.status === 401 || r.status === 403) { console.warn(`Auth expirée (read ${fileId}). Déco.`); handleSignoutClick(false); } else { console.error(`Erreur Drive (read ${fileId}): ${r.status} ${r.statusText}`); } throw new Error(`Erreur Drive ${r.status}`); } return await r.text(); } catch (e) { console.error(`Erreur lecture ${fileId}:`, e); return null; } }
     async function loadProgramsFromDrive() { if (!googleAccessToken) return 'error'; console.log("Chargement programmes Drive..."); let allOk = true, anyOk = false; const tmp = { Push: [], Pull: [], Legs: [] }; for (const type of PROGRAM_TYPES) { programFileIds[type] = await findFileId(PROGRAM_FILENAMES[type]); let fileOk = false; if (programFileIds[type]) { const content = await readFileContent(programFileIds[type]); if (content !== null) { try { const p = JSON.parse(content || '[]'); if (Array.isArray(p)) { tmp[type] = p; fileOk = true; anyOk = true; if (p.length === 0) console.warn(`Prog ${type} vide.`); } else { console.error(`Contenu ${type} non-Array.`); showMessage(`Format invalide ${PROGRAM_FILENAMES[type]}.`, 4000, 'warning'); allOk = false; } } catch (e) { console.error(`Erreur parsing JSON ${type}:`, e); showMessage(`Erreur format JSON ${PROGRAM_FILENAMES[type]}.`, 4000, 'error'); playSound('error'); allOk = false; } } else { console.warn(`Lecture ${type} échouée.`); showMessage(`Impossible lire ${PROGRAM_FILENAMES[type]}.`, 4000, 'warning'); allOk = false; } } else { console.error(`Fichier ${PROGRAM_FILENAMES[type]} introuvable.`); showMessage(`Fichier ${PROGRAM_FILENAMES[type]} introuvable.`, 4000, 'warning'); allOk = false; } } loadedPrograms = tmp; console.log(`Fin chargement. Global: ${allOk}, Partiel: ${anyOk}`); if (allOk) return 'success'; if (anyOk) return 'partial'; return 'error'; }


    // --- Logique de Calcul et Affichage ELO ---
    function getRepsFactor(reps) { const n = parseInt(reps, 10); if (isNaN(n) || reps === 'AMRAP' || reps === 'MAX') return REPS_FACTORS[Infinity]; if (n <= 8) return REPS_FACTORS[8]; if (n <= 12) return REPS_FACTORS[12]; if (n <= 18) return REPS_FACTORS[18]; if (n <= 25) return REPS_FACTORS[25]; return REPS_FACTORS[Infinity]; }
    function isPolyarticular(name) { const l = name.toLowerCase(); const k = ['pompes', 'push up', 'dips', 'tractions', 'pull up', 'chin up', 'rowing', 'tirage', 'squat', 'fentes', 'soulevé', 'deadlift', 'développé', 'press', 'overhead press']; return k.some(w => l.includes(w)); }
    function calculateExerciseELO(step) { if (!step || step.type !== 'exercise' || !step.details) return 0; const d = step.details; const r = RESISTANCE_BONUS[d.resistance] || 0; const f = getRepsFactor(d.reps); const t = (d.intensityTechnique && d.intensityTechnique !== 'Aucune') ? INTENSITY_TECHNIQUE_BONUS_MULTIPLIER : 1.0; return ELO_BASE / 10 + (r * f * t); }
    function mapExerciseToMuscleGroup(name) { const l = name.toLowerCase(); if (l.includes('pompes') || l.includes('push up') || l.includes('dips') || l.includes('développé couché') || l.includes('chest press')) return ['Pectoraux', 'Triceps', 'Épaules']; if (l.includes('tractions') || l.includes('pull up') || l.includes('chin up') || l.includes('rowing') || l.includes('tirage')) return ['Dos', 'Biceps']; if (l.includes('développé militaire') || l.includes('overhead press') || l.includes('élévations latérales') || l.includes('shoulder press')) return ['Épaules', 'Triceps']; if (l.includes('curl') || l.includes('biceps')) return ['Biceps']; if (l.includes('extension triceps') || l.includes('triceps pushdown') || l.includes('skullcrusher')) return ['Triceps']; if (l.includes('gainage') || l.includes('planche') || l.includes('crunch') || l.includes('abdos') || l.includes('core')) return ['Core']; if (l.includes('squat') || l.includes('fentes') || l.includes('leg press') || l.includes('leg extension') || l.includes('leg curl') || l.includes('mollets')) return ['Legs']; console.warn(`Mapping muscle inconnu: ${name}`); return []; }
    function analyzeProgramsAndCalculateELO() {
        console.log("Analyse programmes & calcul ELO...");
        const groupData = {};
        [...ALL_MUSCLE_GROUPS_LOGIC, 'Legs'].forEach(g => { groupData[g] = { totalWeightedElo: 0, totalWeight: 0 }; });
        currentELOValues = {};

        if (programsAnalysisStatus === 'error' || programsAnalysisStatus === 'pending') {
            console.warn("Analyse ELO annulée: programmes non chargés.");
            ALL_MUSCLE_GROUPS_LOGIC.forEach(g => { currentELOValues[g] = ELO_BASE; });
            overallAvgELO = ELO_BASE; previousOverallAvgELO = null; return;
        }

        PROGRAM_TYPES.forEach(type => {
            const program = loadedPrograms[type]; if (!program || program.length === 0) return;
            let currentExo = null, sets = 0, lastStep = null;
            program.forEach((step, idx) => {
                if (step.type === 'exercise') { if (step.name === currentExo && lastStep) { sets++; } else { if (lastStep) processExerciseBlock(lastStep, sets, groupData); currentExo = step.name; sets = 1; } lastStep = step; if (idx === program.length - 1) processExerciseBlock(lastStep, sets, groupData); }
                else if (step.type === 'break' || step.type === 'info') { if (lastStep) processExerciseBlock(lastStep, sets, groupData); currentExo = null; sets = 0; lastStep = null; }
            });
        });

        let totalEloSum = 0, totalWeight = 0;
        ALL_MUSCLE_GROUPS_LOGIC.forEach(g => {
            const d = groupData[g]; currentELOValues[g] = d.totalWeight > 0 ? ELO_BASE + Math.round(d.totalWeightedElo / d.totalWeight) : ELO_BASE;
            if (g !== 'Legs' && d.totalWeight > 0) { totalEloSum += (currentELOValues[g] - ELO_BASE) * d.totalWeight; totalWeight += d.totalWeight; }
        });

        if (overallAvgELO > ELO_BASE) { previousOverallAvgELO = overallAvgELO; } // Stocke l'ancien ELO significatif
        overallAvgELO = totalWeight > 0 ? ELO_BASE + Math.round(totalEloSum / totalWeight) : ELO_BASE;

        console.log(`ELO Global: ${overallAvgELO} (Préc: ${previousOverallAvgELO})`); console.log("ELO Groupes:", currentELOValues);
    }
    function processExerciseBlock(step, sets, data) { const elo = calculateExerciseELO(step); if (elo > 0 && sets > 0) { const poly = isPolyarticular(step.name); const w = poly ? POLYARTICULAR_WEIGHT : ISOLATION_WEIGHT; const groups = mapExerciseToMuscleGroup(step.name); groups.forEach(g => { if (data[g]) { data[g].totalWeightedElo += elo * sets * w; data[g].totalWeight += sets * w; } else { console.warn(`Groupe logique inconnu : ${g} pour ${step.name}`); } }); } }

    // Nouvelle fonction pour trouver la clé de niveau basée sur l'ELO
    function getEloLevelKey(eloScore) {
        // Parcours de haut en bas pour trouver le premier seuil atteint
        for (let i = LEVEL_ORDER.length - 1; i >= 0; i--) {
            const levelKey = LEVEL_ORDER[i];
            if (TARGET_ELO_LEVELS[levelKey] && eloScore >= TARGET_ELO_LEVELS[levelKey].minELO) {
                return levelKey;
            }
        }
        return LEVEL_ORDER[0]; // Retourne Base si aucun seuil atteint (devrait être L0_Base)
    }

    // Fonction principale pour calculer et mettre à jour l'affichage
    function calculateAndDisplayEvolution() {
        console.log("Mise à jour affichage évolution...");
        if (!evolutionTrackerArea || !overallEloDisplayValue || !levelBadge || !targetEloInfoStrong || !muscleGroupsContainer) {
            console.error("DOM manquant pour affichage."); if(muscleGroupsContainer) muscleGroupsContainer.innerHTML = '<p class="error-placeholder">Erreur interne: DOM manquant.</p>'; return;
        }

        if (programsAnalysisStatus !== 'pending') { analyzeProgramsAndCalculateELO(); }
        else { ALL_MUSCLE_GROUPS_LOGIC.forEach(g => { currentELOValues[g] = ELO_BASE; }); overallAvgELO = ELO_BASE; previousOverallAvgELO = null; }

        const previousGlobalLevelKey = currentGlobalLevelKey; // Sauvegarde avant màj
        currentGlobalLevelKey = getEloLevelKey(overallAvgELO);
        const currentGlobalLevel = TARGET_ELO_LEVELS[currentGlobalLevelKey];
        const currentGlobalLevelIndex = LEVEL_ORDER.indexOf(currentGlobalLevelKey);
        const nextGlobalLevelKey = currentGlobalLevelIndex < LEVEL_ORDER.length - 1 ? LEVEL_ORDER[currentGlobalLevelIndex + 1] : null;
        const nextGlobalLevel = nextGlobalLevelKey ? TARGET_ELO_LEVELS[nextGlobalLevelKey] : null;

        // Détection passage niveau global
        if (previousOverallAvgELO !== null && currentGlobalLevelKey !== previousGlobalLevelKey && TARGET_ELO_LEVELS[previousGlobalLevelKey]) {
             if (overallAvgELO >= TARGET_ELO_LEVELS[previousGlobalLevelKey].minELO) { // Check si on a bien dépassé le *seuil précédent*
                 console.log(`NIVEAU GLOBAL ATTEINT ! ${previousGlobalLevelKey} -> ${currentGlobalLevelKey}`);
                 showMessage(`Félicitations ! Niveau Global ${currentGlobalLevel.name} atteint !`, 5000, 'success');
                 playSound('level_up', 0.2);
                 const eloCard = document.querySelector('.global-stats-card');
                 if (eloCard) { eloCard.style.animation = 'levelUpGlow 1.5s ease-out'; setTimeout(() => { eloCard.style.animation = ''; }, 1500); }
             }
        }

        // Màj carte ELO globale
        animateValue(overallEloDisplayValue, parseFloat(overallEloDisplayValue.textContent.replace(/[^0-9.]/g, '')) || ELO_BASE, overallAvgELO, 700);
        levelBadgeIcon.className = `fas ${currentGlobalLevel.iconClass}`;
        levelBadgeText.textContent = currentGlobalLevel.name;
        levelBadge.style.color = `var(${currentGlobalLevel.colorVar})`;
        levelBadge.style.backgroundColor = `var(${currentGlobalLevel.bgVar})`;
        levelBadge.style.borderColor = `var(${currentGlobalLevel.colorVar})`;
        levelBadge.setAttribute('title', currentGlobalLevel.description);
        targetEloInfoStrong.textContent = nextGlobalLevel ? `${nextGlobalLevel.minELO} ELO` : "MAX";

        // Génération cartes muscles
        muscleGroupsContainer.innerHTML = '';
        let hasData = false;
        for (const displayGroup in MUSCLE_GROUPS_DISPLAY_CONFIG) {
            const logicGroup = Object.keys(LOGIC_TO_DISPLAY_MAP).find(key => LOGIC_TO_DISPLAY_MAP[key] === displayGroup);
            if (!logicGroup || currentELOValues[logicGroup] === undefined) { continue; }

            hasData = true;
            const config = MUSCLE_GROUPS_DISPLAY_CONFIG[displayGroup];
            const currentElo = currentELOValues[logicGroup];
            const muscleLevelKey = getEloLevelKey(currentElo);
            const muscleLevel = TARGET_ELO_LEVELS[muscleLevelKey];
            const muscleLevelIndex = LEVEL_ORDER.indexOf(muscleLevelKey);
            const nextMuscleLevelKey = muscleLevelIndex < LEVEL_ORDER.length - 1 ? LEVEL_ORDER[muscleLevelIndex + 1] : null;
            const nextMuscleLevel = nextMuscleLevelKey ? TARGET_ELO_LEVELS[nextMuscleLevelKey] : null;

            const minEloCurrent = muscleLevel.minELO;
            const minEloNext = nextMuscleLevel ? nextMuscleLevel.minELO : minEloCurrent + 100; // Fallback pour dernier niveau
            const range = minEloNext - minEloCurrent;
            let progress = 0;
            if (range > 0) { progress = ((currentElo - minEloCurrent) / range) * 100; }
            else if (currentElo >= minEloCurrent) { progress = 100; } // Atteint ou dernier niveau

            const displayPercent = Math.max(0, Math.min(100, Math.round(progress)));
            const isTargetReached = nextMuscleLevel ? currentElo >= minEloNext : true; // Considéré atteint au dernier niveau

            const card = renderMuscleGroupCard(
                displayGroup, config.subtitle, config.icon,
                currentElo, minEloNext, displayPercent,
                muscleLevel.name, muscleLevel.colorVar, muscleLevel.bgVar, isTargetReached
            );
            muscleGroupsContainer.appendChild(card);
        }

        if (!hasData && programsAnalysisStatus !== 'pending') {
             const msg = programsAnalysisStatus === 'error' ? 'Aucune donnée valide analysée.' : 'Aucune donnée évolution.';
             muscleGroupsContainer.innerHTML = `<p class="${programsAnalysisStatus === 'error' ? 'error' : 'loading'}-placeholder">${msg}</p>`;
         }
        console.log("Affichage évolution mis à jour.");
    }

    // Crée le HTML pour une carte de groupe musculaire
    function renderMuscleGroupCard(title, subtitle, iconClass, currentElo, targetEloNextMin, displayPercent, currentLevelName, currentLevelColorVar, currentLevelBgVar, isTargetReached) {
         const card = document.createElement('div');
         card.className = 'muscle-group-card';
         if (isTargetReached) { card.classList.add('level-target-reached'); }

         const targetDisplay = targetEloNextMin > currentElo ? targetEloNextMin : "MAX"; // Affiche MAX si dernier niveau atteint
         card.setAttribute('title', `${title} (${subtitle}) - Niveau: ${currentLevelName} - ELO: ${currentElo} / ${targetDisplay}. Progression vers niv. suivant: ${displayPercent}%.`);

         card.innerHTML = `
             <div class="card-header">
                 <div class="icon-container"><i class="fas ${iconClass}" aria-hidden="true"></i></div>
                 <div class="title-container">
                     <div class="group-title">${title}</div>
                     <div class="group-subtitle">${subtitle}</div>
                     <div class="group-level-name" style="color: var(${currentLevelColorVar}); background-color: var(${currentLevelBgVar}); border: 1px solid var(${currentLevelColorVar});">
                         ${currentLevelName}
                     </div>
                 </div>
                 <div class="elo-details" title="ELO Actuel / Seuil ELO Niveau Suivant">
                     <span class="current">${currentElo}</span> / <span class="target">${targetDisplay}</span>
                 </div>
             </div>
             <div class="progress-section">
                 <div class="progress-bar-container" title="Progression: ${displayPercent}%">
                     <div class="progress-bar" style="width: 0%;" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                 </div>
                 <span class="progress-percentage-value">${displayPercent}%</span>
             </div>
         `;

         requestAnimationFrame(() => {
             setTimeout(() => {
                 const progressBar = card.querySelector('.progress-bar');
                 if (progressBar) { progressBar.style.width = `${displayPercent}%`; progressBar.setAttribute('aria-valuenow', displayPercent); }
             }, 50);
         });
         return card;
     }

    // Réinitialise l'affichage ELO
    function resetEvolutionDisplay() {
        console.log("Réinitialisation affichage...");
        if (muscleGroupsContainer) { muscleGroupsContainer.innerHTML = `<p class="loading-placeholder">${googleAccessToken ? 'Analyse...' : 'Connectez-vous...'}</p>`; }
        if (overallEloDisplayValue) overallEloDisplayValue.textContent = '--';
        const baseLevel = TARGET_ELO_LEVELS[LEVEL_ORDER[0]];
        if (levelBadge && baseLevel) {
             levelBadgeIcon.className = `fas ${baseLevel.iconClass}`;
             levelBadgeText.textContent = baseLevel.name;
             levelBadge.style.color = `var(${baseLevel.colorVar})`;
             levelBadge.style.backgroundColor = `var(${baseLevel.bgVar})`;
             levelBadge.style.borderColor = `var(${baseLevel.colorVar})`;
             levelBadge.setAttribute('title', baseLevel.description);
        }
         // Trouve le niveau après Base (normalement Bronze) pour l'objectif initial
         const firstRealLevelKey = LEVEL_ORDER.length > 1 ? LEVEL_ORDER[1] : null;
         const firstRealLevel = firstRealLevelKey ? TARGET_ELO_LEVELS[firstRealLevelKey] : null;
         if (targetEloInfoStrong) targetEloInfoStrong.textContent = firstRealLevel ? `${firstRealLevel.minELO} ELO` : '-- ELO';

        previousOverallAvgELO = null;
        currentGlobalLevelKey = LEVEL_ORDER[0]; // Reset au niveau de base
    }

    // --- Animation & UI Update & Thème & Message (Identiques) ---
    function animateValue(el, start, end, duration) { if (!el) return; if (start === end) { el.textContent = Math.round(end); return; } const range = end - start; let current = start; const inc = end > start ? 1 : -1; const stepTime = Math.abs(Math.floor(duration / range)); const effStepTime = Math.max(1, Math.min(stepTime, 50)); const timer = setInterval(() => { current += inc * Math.max(1, Math.round(Math.abs(end - current) / 10)); if ((inc > 0 && current >= end) || (inc < 0 && current <= end)) { current = end; clearInterval(timer); } el.textContent = Math.round(current); }, effStepTime); }
    function updateAuthUI(isLoggedIn) { console.log(`Update UI - Connecté: ${isLoggedIn}, GIS prêt: ${!!tokenClient}`); const b = document.body; b.classList.toggle('logged-in', isLoggedIn); b.classList.toggle('logged-out', !isLoggedIn); if(signInButton) signInButton.disabled = isLoggedIn || !tokenClient; if(signInButtonPrompt) signInButtonPrompt.disabled = isLoggedIn || !tokenClient; if(signOutButton) signOutButton.disabled = !isLoggedIn; if(themeToggleBtn) themeToggleBtn.disabled = false; if (connectionPrompt) connectionPrompt.style.display = isLoggedIn ? 'none' : 'block'; if (evolutionTrackerArea) evolutionTrackerArea.style.display = isLoggedIn ? 'flex' : 'none'; if (!isLoggedIn) { programsAnalysisStatus = 'pending'; resetEvolutionDisplay(); } }
    function applyTheme(theme) { document.body.classList.remove('light-theme', 'dark-theme'); document.body.classList.add(theme + '-theme'); currentTheme = theme; localStorage.setItem('armorWorkoutTheme', theme); if (themeToggleBtn) { const i = themeToggleBtn.querySelector('i'); if (i) i.className = `fas fa-${theme === 'dark' ? 'sun' : 'moon'}`; themeToggleBtn.setAttribute('aria-label', `Passer au thème ${theme === 'dark' ? 'clair' : 'sombre'}`); } console.log(`Thème appliqué: ${theme}`); }
    function toggleTheme() { showMessage("Thème clair non disponible.", 2000, 'info'); playSound('confirm'); /* const newTheme = currentTheme === 'dark' ? 'light' : 'dark'; applyTheme(newTheme); */ }
    function loadSavedTheme() { applyTheme('dark'); /* const savedTheme = localStorage.getItem('armorWorkoutTheme') || 'dark'; applyTheme(savedTheme); */ }
    function showMessage(msg, duration = 3000, type = 'info') { if (!messageArea) return; messageArea.textContent = msg; messageArea.className = `message-area ${type} visible`; if (messageTimeoutId) clearTimeout(messageTimeoutId); messageTimeoutId = setTimeout(() => { messageArea.classList.remove('visible'); setTimeout(() => { if (!messageArea.classList.contains('visible')) { messageArea.className = 'message-area'; } }, 500); }, duration); }

    // --- Initialisation ---
    function initializeDOMReferences() {
        console.log("Init DOM Refs...");
        signInButton = document.getElementById('signin-button');
        signOutButton = document.getElementById('signout-button');
        driveStatusElement = document.getElementById('drive-status');
        themeToggleBtn = document.getElementById('theme-toggle-btn');
        signInButtonPrompt = document.getElementById('signin-button-prompt');
        connectionPrompt = document.getElementById('connection-prompt');
        evolutionTrackerArea = document.getElementById('evolution-tracker-area');
        overallEloDisplayValue = document.querySelector('#overall-elo-display .value');
        levelBadge = document.getElementById('level-badge');
        if (levelBadge) { levelBadgeIcon = levelBadge.querySelector('i'); levelBadgeText = levelBadge.querySelector('span'); }
        targetEloInfoStrong = document.querySelector('#target-elo-info strong');
        muscleGroupsContainer = document.getElementById('muscle-groups-container');
        messageArea = document.getElementById('message-area');
        const critical = [signInButton, signOutButton, themeToggleBtn, signInButtonPrompt, connectionPrompt, evolutionTrackerArea, overallEloDisplayValue, levelBadge, levelBadgeIcon, levelBadgeText, targetEloInfoStrong, muscleGroupsContainer, messageArea];
        if (critical.some(el => !el)) { console.error("DOM CRITIQUES MANQUANTS!", critical); showMessage("Erreur critique: UI incomplète.", 10000, 'error'); document.body.innerHTML = '<p style="color:red; padding: 20px; text-align: center;">Erreur critique interface.</p>'; return false; }
        console.log("DOM Refs OK."); return true;
    }
    function addEventListeners() { if(signInButton) signInButton.addEventListener('click', handleAuthClick); if(signInButtonPrompt) signInButtonPrompt.addEventListener('click', handleAuthClick); if(signOutButton) signOutButton.addEventListener('click', () => handleSignoutClick(true)); if(themeToggleBtn) themeToggleBtn.addEventListener('click', toggleTheme); document.body.addEventListener('click', initAudioContext, { once: true }); document.body.addEventListener('keydown', initAudioContext, { once: true }); console.log("Écouteurs OK."); }

    // --- Point d'entrée ---
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM Chargé. Initialisation...");
        try {
            if (!initializeDOMReferences()) return;
            addEventListeners(); loadSavedTheme(); updateAuthUI(false); resetEvolutionDisplay(); checkAndInitGis();
            console.log("Init terminée. Attente API Google & utilisateur...");
        } catch (error) {
            console.error("Erreur Init DOMContentLoaded:", error); showMessage("Erreur critique chargement.", 10000, 'error');
            const b = document.querySelector('body'); if(b) b.innerHTML = '<p style="color:red; padding: 20px; text-align: center;">Erreur critique chargement. Voir console.</p>';
        }
    });
</script>

</body>
</html>
