<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArmorWorkout - Suivi Évolution</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">

    <style>
        /* --- Variables Globales & Thèmes (Inchangé) --- */
        :root {
            /* Thème Sombre */
            --bg-color-dark: #0a0f1e; --secondary-bg-color-dark: #141a30; --primary-text-color-dark: #e0e0ff; --secondary-text-color-dark: #8a94c1; --border-color-dark: #2a3150; --accent-border-color-dark: #4b558a; --input-bg-dark: #0a0f1e;
            /* Couleurs Néon/Gradient */
            --neon-blue: #6fa8ff; --neon-purple: #b18cff; --gradient-start: var(--neon-purple); --gradient-end: var(--neon-blue); --neon-green: #3fb950; --neon-red: #ff7b72; --neon-orange: #f9a825; --neon-yellow: #facc15;
            /* Couleurs Niveaux (RGBA pour bg) */
            --level-beginner-color: #8a94c1; --level-beginner-bg: rgba(138, 148, 193, 0.1);
            --level-bronze-color: #cd7f32;   --level-bronze-bg: rgba(205, 127, 50, 0.15);
            --level-silver-color: #c0c0c0;   --level-silver-bg: rgba(192, 192, 192, 0.15);
            --level-gold-color: #ffd700;     --level-gold-bg: rgba(255, 215, 0, 0.15);
            --level-crystal-color: #a7d8de;  --level-crystal-bg: rgba(167, 216, 222, 0.15);
            --level-master-color: #e384f1;   --level-master-bg: rgba(227, 132, 241, 0.15);
            --level-champion-color: #ff7b72; --level-champion-bg: rgba(255, 123, 114, 0.15);
            --level-titan-color: #aa99ff;    --level-titan-bg: rgba(170, 153, 255, 0.15);
            --level-legende-color: #fff7a3;  --level-legende-bg: rgba(255, 247, 163, 0.2);
            --level-marvel-color: #e62429;   --level-marvel-bg: rgba(230, 36, 41, 0.1);
            /* Glows */
            --glow-gradient: 0 0 20px rgba(177, 140, 255, 0.4), 0 0 30px rgba(111, 168, 255, 0.3); --glow-level-reached: 0 0 15px rgba(63, 185, 80, 0.7); --glow-connect: 0 0 10px rgba(63, 185, 80, 0.6); --glow-disconnect: 0 0 10px rgba(255, 123, 114, 0.6); --glow-marvel: 0 0 15px rgba(230, 36, 41, 0.6);
            /* Autres */
            --font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; --border-radius-lg: 18px; --border-radius-md: 12px; --border-radius-sm: 8px; --transition-speed: 0.3s;
            /* RGBA */
            --bg-color-dark-rgb: 10, 15, 30; --secondary-bg-color-dark-rgb: 20, 26, 48; --primary-text-color-dark-rgb: 224, 224, 255; --secondary-text-color-dark-rgb: 138, 148, 193; --border-color-dark-rgb: 42, 49, 80; --neon-blue-rgb: 111, 168, 255; --neon-purple-rgb: 177, 140, 255; --neon-green-rgb: 63, 185, 80; --neon-red-rgb: 255, 123, 114; --neon-orange-rgb: 249, 168, 37;
            /* Thème Sombre */
            --bg-color: var(--bg-color-dark); --secondary-bg-color: var(--secondary-bg-color-dark); --primary-text-color: var(--primary-text-color-dark); --secondary-text-color: var(--secondary-text-color-dark); --border-color: var(--border-color-dark); --accent-border-color: var(--accent-border-color-dark); --input-bg: var(--input-bg-dark); --bg-color-rgb: var(--bg-color-dark-rgb); --secondary-bg-color-rgb: var(--secondary-bg-color-dark-rgb);
            /* Styles Spécifiques */
            --link-color: var(--neon-blue); --button-connect-color: var(--neon-green); --button-connect-glow: var(--glow-connect); --button-disconnect-color: var(--neon-red); --button-disconnect-glow: var(--glow-disconnect);
            /* Barres Progression */
            --progress-bar-bg: rgba(var(--primary-text-color-rgb), 0.1); --progress-bar-fill: linear-gradient(90deg, var(--gradient-start), var(--gradient-end));
        }

        /* --- Styles de Base & Réinitialisation (Inchangé) --- */
        * { box-sizing: border-box; margin: 0; padding: 0; } html { scroll-behavior: smooth; font-size: 16px; }
        body { font-family: var(--font-family); background-color: var(--bg-color); color: var(--primary-text-color); line-height: 1.6; transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease; display: flex; flex-direction: column; min-height: 100vh; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; overflow-x: hidden; padding-top: 125px; }
        .container { max-width: 450px; margin: 0 auto; padding: 20px 15px; width: 100%; flex-grow: 1; display: flex; flex-direction: column; }

        /* --- En-tête & Navigation (Inchangé) --- */
        #app-header { position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; background-color: rgba(var(--bg-color-rgb), 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid var(--border-color); transition: border-color var(--transition-speed) ease, background-color var(--transition-speed) ease; }
        .header-content { display: flex; flex-direction: column; align-items: center; max-width: 450px; margin: 0 auto; padding: 10px 15px 5px; gap: 8px; }
        header .title-container { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        header .title-container i.header-icon { font-size: 1.8em; color: var(--primary-text-color); opacity: 0.8; }
        header h1 { font-size: 1.1em; color: var(--primary-text-color); margin: 0; font-weight: 500; letter-spacing: 0.1em; text-transform: uppercase; }
        .header-actions { display: flex; gap: 15px; align-items: center; justify-content: space-between; width: 100%; }
        .auth-controls { display: flex; gap: 10px; align-items: center; }
        .auth-controls button { background: none; border: 1px solid var(--border-color); color: var(--secondary-text-color); padding: 5px 12px; border-radius: var(--border-radius-md); font-size: 0.8em; font-weight: 500; cursor: pointer; transition: all var(--transition-speed) ease; display: inline-flex; align-items: center; gap: 5px; }
        .auth-controls button:disabled { opacity: 0.4; cursor: not-allowed; background: transparent !important; border-color: var(--border-color) !important; color: var(--secondary-text-color) !important; box-shadow: none !important; }
        .auth-controls button:not(:disabled):hover { border-color: var(--accent-border-color); color: var(--primary-text-color); background-color: rgba(var(--primary-text-color-rgb), 0.05); }
        #signin-button, #signin-button-prompt { border-color: var(--button-connect-color); color: var(--button-connect-color); }
        #signin-button:not(:disabled):hover, #signin-button-prompt:not(:disabled):hover { background-color: rgba(var(--neon-green-rgb), 0.1); box-shadow: var(--button-connect-glow); }
        #signout-button { border-color: var(--button-disconnect-color); color: var(--button-disconnect-color); }
        #signout-button:not(:disabled):hover { background-color: rgba(var(--neon-red-rgb), 0.1); box-shadow: var(--button-disconnect-glow); }
        #drive-status { display: none; }
        .theme-toggle button { background: none; border: none; color: var(--secondary-text-color); font-size: 1.1em; padding: 5px; cursor: pointer; transition: color var(--transition-speed) ease; }
        .theme-toggle button:hover { color: var(--neon-purple); }
        #app-nav { display: flex; justify-content: center; gap: 10px; padding: 8px 15px; border-top: 1px solid var(--border-color); background-color: rgba(var(--secondary-bg-color-rgb), 0.5); }
        .nav-button { background: none; border: none; color: var(--secondary-text-color); font-size: 0.85em; font-weight: 500; padding: 6px 12px; border-radius: var(--border-radius-md); cursor: pointer; transition: all 0.2s ease; border: 1px solid transparent; display: inline-flex; align-items: center; gap: 6px;}
        .nav-button i { font-size: 1.1em; }
        .nav-button:hover { color: var(--primary-text-color); background-color: rgba(var(--primary-text-color-rgb), 0.05); }
        .nav-button.active { color: var(--neon-blue); border-color: var(--neon-blue); background-color: rgba(var(--neon-blue-rgb), 0.1); font-weight: 700; }
        .nav-button:disabled { opacity: 0.5; cursor: not-allowed; color: var(--secondary-text-color) !important; background: none !important; border-color: transparent !important;}

        /* Affichage conditionnel (Inchangé) */
        body.logged-out .nav-button { display: none; } body.logged-out #signin-button, body.logged-out #signin-button-prompt { display: inline-flex; } body.logged-out #signout-button { display: none; } body.logged-in #signin-button, body.logged-in #signin-button-prompt { display: none; } body.logged-in #signout-button { display: inline-flex; } body.logged-out #connection-prompt { display: block; } body.logged-in #connection-prompt { display: none; } body.logged-out .app-section { display: none; } body.logged-in .app-section { display: none; }

        /* --- Contenu Principal (Inchangé) --- */
        main { flex-grow: 1; display: flex; flex-direction: column; align-items: center; padding-top: 20px; }
        #connection-prompt { text-align: center; padding: 30px 20px; background-color: var(--secondary-bg-color); border-radius: var(--border-radius-lg); border: 1px dashed var(--border-color); margin: 20px auto; max-width: 90%; }
        #connection-prompt p { margin-bottom: 15px; color: var(--secondary-text-color); font-size: 0.9em;}
        #connection-prompt button { padding: 8px 18px; font-size: 0.9em; } .app-section { width: 100%; }

        /* Section Suivi Évolution (Inchangé) */
        #evolution-tracker-area { display: flex; flex-direction: column; gap: 20px; }
        .global-stats-card { background-color: var(--secondary-bg-color); border-radius: var(--border-radius-lg); padding: 25px 20px; text-align: center; border: 1px solid var(--border-color); box-shadow: 0 10px 30px rgba(0,0,0, 0.2); position: relative; overflow: hidden; }
        .global-stats-card::before { content: ''; position: absolute; top: -30%; left: -30%; width: 160%; height: 160%; background: radial-gradient(circle, rgba(var(--neon-blue-rgb), 0.08) 0%, rgba(var(--neon-blue-rgb), 0) 60%); animation: rotateGlow 15s linear infinite; pointer-events: none; opacity: 0.7; }
        @keyframes rotateGlow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .global-stats-card .card-title { font-size: 0.9em; color: var(--secondary-text-color); margin-bottom: 10px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.05em; }
        #overall-elo-display .value { font-size: 4.5em; font-weight: 900; line-height: 1; margin-bottom: 15px; display: block; background: linear-gradient(90deg, var(--gradient-start), var(--gradient-end)); -webkit-background-clip: text; background-clip: text; color: transparent; text-shadow: var(--glow-gradient); animation: pulse-text 3s infinite ease-in-out; }
        @keyframes pulse-text { 0%, 100% { text-shadow: var(--glow-gradient); opacity: 1; } 50% { text-shadow: 0 0 15px rgba(177, 140, 255, 0.3), 0 0 25px rgba(111, 168, 255, 0.2); opacity: 0.95; } }
        #level-badge-container { display: inline-flex; align-items: center; gap: 10px; position: relative; cursor: default; }
        #level-badge { display: inline-flex; align-items: center; gap: 8px; padding: 6px 15px; border-radius: var(--border-radius-md); font-size: 0.9em; font-weight: 700; border: 1px solid transparent; transition: all var(--transition-speed) ease; cursor: pointer; }
        #level-badge i { font-size: 1.2em; width: 1.2em; text-align: center;}
        .marvel-achieved-icon { font-size: 1.1em; color: var(--level-marvel-color); vertical-align: middle; cursor: help; text-shadow: var(--glow-marvel); animation: marvelIconPulse 2s infinite ease-in-out; }
        @keyframes marvelIconPulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } }
        .target-info-container { margin-top: 10px; font-size: 0.85em; color: var(--secondary-text-color); display: flex; flex-wrap: wrap; justify-content: center; gap: 5px 10px; }
        .target-info-container span { margin: 0; } .target-info-container strong { font-weight: 700; color: var(--primary-text-color); } .target-info-container .marvel-target { color: var(--level-marvel-color); font-weight: 700;}
        @keyframes levelUpGlow { 0% { box-shadow: 0 10px 30px rgba(0,0,0, 0.2), 0 0 0px rgba(var(--neon-green-rgb), 0); border-color: var(--border-color);} 50% { box-shadow: 0 10px 30px rgba(0,0,0, 0.1), 0 0 30px rgba(var(--neon-green-rgb), 0.7); border-color: var(--neon-green);} 100% { box-shadow: 0 10px 30px rgba(0,0,0, 0.2), 0 0 0px rgba(var(--neon-green-rgb), 0); border-color: var(--border-color);} }
        #muscle-groups-container { display: flex; flex-direction: column; gap: 15px; }
        .muscle-group-card { background-color: var(--secondary-bg-color); border: 1px solid var(--border-color); border-radius: var(--border-radius-md); padding: 15px; display: flex; flex-direction: column; gap: 10px; transition: all var(--transition-speed) ease; position: relative; overflow: hidden; }
        .muscle-group-card:hover { border-color: var(--accent-border-color); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0, 0.15); }
        .muscle-group-card .card-header { display: flex; align-items: center; gap: 12px; margin-bottom: 5px; }
        .muscle-group-card .icon-container { flex-shrink: 0; color: var(--secondary-text-color); font-size: 1.8em; width: 35px; text-align: center; opacity: 0.7; }
        .muscle-group-card .title-container { flex-grow: 1; } .muscle-group-card .group-title { font-size: 1.05em; font-weight: 700; color: var(--primary-text-color); line-height: 1.2; } .muscle-group-card .group-subtitle { font-size: 0.85em; color: var(--secondary-text-color); font-weight: 400; line-height: 1.2; margin-bottom: 2px; }
        .muscle-group-card .group-level-name { font-size: 0.8em; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; line-height: 1; padding: 2px 6px; border-radius: var(--border-radius-sm); display: inline-block; margin-top: 4px; border: 1px solid; cursor: pointer; }
        .muscle-group-card .elo-details { font-size: 0.9em; font-weight: 500; color: var(--secondary-text-color); text-align: right; white-space: nowrap; } .muscle-group-card .elo-details .current { color: var(--primary-text-color); font-weight: 700; } .muscle-group-card .elo-details .target { }
        .progress-section { display: flex; align-items: center; gap: 10px; margin-top: 5px; }
        .progress-bar-container { flex-grow: 1; height: 8px; background-color: var(--progress-bar-bg); border-radius: 4px; overflow: hidden; position: relative; }
        .progress-bar { height: 100%; width: 0%; background: var(--progress-bar-fill); border-radius: 4px; transition: width 0.8s cubic-bezier(0.25, 1, 0.5, 1); box-shadow: var(--glow-gradient); }
        .progress-percentage-value { font-size: 0.9em; font-weight: 700; color: var(--secondary-text-color); flex-shrink: 0; width: 40px; text-align: right; transition: color 0.3s ease; }
        .muscle-group-card.level-target-reached { border-color: var(--neon-green); box-shadow: 0 0 15px rgba(var(--neon-green-rgb), 0.3); }
        .muscle-group-card.level-target-reached .progress-percentage-value { color: var(--neon-green); }
        .muscle-group-card.level-target-reached::after { content: '\f00c'; font-family: 'Font Awesome 6 Free'; font-weight: 900; position: absolute; top: 10px; right: 10px; color: var(--neon-green); font-size: 0.9em; opacity: 0; animation: fadeInCheck 0.5s 0.5s ease forwards; }
        @keyframes fadeInCheck{ from { opacity: 0; transform: scale(0.5); } to { opacity: 1; transform: scale(1); } }

        /* Section Configuration Équipement (Inchangé) */
        #program-config-area { /* ... styles ... */ } #program-config-area h2 { /* ... styles ... */ } #program-config-content { /* ... styles ... */ } .program-config-section { /* ... styles ... */ } .program-config-section h3 { /* ... styles ... */ } .config-exercise-item { /* ... styles ... */ } .config-exercise-item .exercise-name { /* ... styles ... */ } .config-equipment-options { /* ... styles ... */ } .config-equipment-options label { /* ... styles ... */ } .config-equipment-options label:hover { /* ... styles ... */ } .config-equipment-options input[type="checkbox"] { /* ... styles ... */ } #save-config-button { /* ... styles ... */ } #save-config-button:hover { /* ... styles ... */ } #save-config-button:disabled { /* ... styles ... */ } #save-config-button .spinner { /* ... styles ... */ } #save-config-button.saving .spinner { /* ... styles ... */ } #save-config-button.saving span { /* ... styles ... */ }

        /* Section Détails Niveaux (Inchangé) */
        #level-details-area { /* ... styles ... */ } #level-details-area h2 { /* ... styles ... */ } #level-details-content { /* ... styles ... */ } .level-detail-item { /* ... styles ... */ } .level-detail-header { /* ... styles ... */ } .level-detail-icon { /* ... styles ... */ } .level-detail-name { /* ... styles ... */ } .level-detail-elo { /* ... styles ... */ } .level-detail-description { /* ... styles ... */ } .level-detail-celebrity { /* ... styles ... */ }

        /* Modal (Inchangé) */
        .modal-overlay { /* ... styles ... */ } .modal-overlay.visible { /* ... styles ... */ } .modal-content { /* ... styles ... */ } .modal-overlay.visible .modal-content { /* ... styles ... */ } .modal-header { /* ... styles ... */ } .modal-title { /* ... styles ... */ } .modal-title i { /* ... styles ... */ } .modal-close-btn { /* ... styles ... */ } .modal-close-btn:hover { /* ... styles ... */ } .modal-body { /* ... styles ... */ } .modal-body::-webkit-scrollbar { /* ... styles ... */ } .modal-body::-webkit-scrollbar-track { /* ... styles ... */ } .modal-body::-webkit-scrollbar-thumb { /* ... styles ... */ } .modal-body::-webkit-scrollbar-thumb:hover { /* ... styles ... */ }

        /* Footer & Messages & Placeholders (Inchangé) */
        footer { /* ... styles ... */ } footer a { /* ... styles ... */ } footer a:hover { /* ... styles ... */ } .message-area { /* ... styles ... */ } .message-area.visible { /* ... styles ... */ } .message-area.error { /* ... styles ... */ } .message-area.success { /* ... styles ... */ } .message-area.warning { /* ... styles ... */ } .message-area.info { /* ... styles ... */ } #muscle-groups-container .loading-placeholder, #muscle-groups-container .error-placeholder, #program-config-content .loading-placeholder, #level-details-content .loading-placeholder { /* ... styles ... */ } #muscle-groups-container .error-placeholder { /* ... styles ... */ }

        /* Responsive (Inchangé) */
        @media (min-width: 768px) { /* ... styles ... */ }
    </style>
</head>
<body class="logged-out dark-theme">

<header id="app-header">
    <div class="header-content">
         <div class="title-container"> <i class="fas fa-shield header-icon"></i> <h1>ArmorWorkout</h1> </div>
        <div class="header-actions">
            <div class="auth-controls"> <button id="signin-button" disabled><i class="fab fa-google"></i> Connexion</button> <button id="signout-button" disabled><i class="fas fa-sign-out-alt"></i> Déconnexion</button> </div>
             <span id="drive-status" aria-live="polite"></span>
            <div class="theme-toggle"> <button id="theme-toggle-btn" aria-label="Basculer le thème"><i class="fas fa-sun"></i></button> </div>
        </div>
    </div>
    <nav id="app-nav">
        <button class="nav-button active" data-section="evolution-tracker-area" disabled><i class="fas fa-chart-line"></i> Évolution</button>
        <button class="nav-button" data-section="program-config-area" disabled><i class="fas fa-cogs"></i> Équipement</button>
        <button class="nav-button" data-section="level-details-area" disabled><i class="fas fa-layer-group"></i> Niveaux</button>
    </nav>
</header>

<div class="container">
    <main>
        <div id="connection-prompt">
            <p>Connectez-vous via Google pour suivre votre évolution et configurer votre équipement.</p>
            <button id="signin-button-prompt" disabled><i class="fab fa-google"></i> Se connecter</button>
        </div>

        <!-- Section Suivi Évolution -->
        <div id="evolution-tracker-area" class="app-section" style="display: none;">
            <div class="global-stats-card">
                 <div class="card-title">Score ELO Haut du Corps</div>
                 <div id="overall-elo-display"> <span class="value">--</span> </div>
                 <div id="level-badge-container" title="Cliquez pour voir la description du niveau">
                     <div id="level-badge" class="level-unknown" data-level-key="L0_Base"> <i class="fas fa-question-circle"></i> <span>Indéterminé</span> </div>
                 </div>
                 <div class="target-info-container">
                      <span id="target-elo-info">Objectif Niv. Suivant: <strong>-- ELO</strong></span>
                      <span id="marvel-target-info" style="display: inline-block;"> | Benchmark <strong class="marvel-target">Marvel: -- ELO</strong></span>
                 </div>
            </div>
            <div id="muscle-groups-container" aria-live="polite">
                 <p class="loading-placeholder">Connectez-vous pour charger vos données...</p>
            </div>
        </div>

        <!-- Section Configuration Équipement -->
        <div id="program-config-area" class="app-section" style="display: none;">
             <h2><i class="fas fa-dumbbell"></i> Configuration Équipement Additionnel</h2>
             <div id="program-config-content">
                 <p class="loading-placeholder">Chargez vos programmes pour configurer...</p>
             </div>
             <button id="save-config-button" disabled>
                 <span><i class="fas fa-save"></i> Sauvegarder Équipement</span>
                 <i class="fas fa-spinner fa-spin spinner"></i>
             </button>
        </div>

         <!-- Section Détails Niveaux -->
         <div id="level-details-area" class="app-section" style="display: none;">
             <h2><i class="fas fa-layer-group"></i> Détails des Niveaux</h2>
             <div id="level-details-content">
                  <p class="loading-placeholder">Connectez-vous pour voir les détails...</p>
             </div>
         </div>
    </main>
</div>

<footer>
     <p>© 2024 ArmorWorkout | <a href="https://github.com/ironworkout/armorworkout" target="_blank" rel="noopener noreferrer"><i class="fab fa-github" aria-hidden="true"></i> GitHub</a></p>
</footer>

<!-- Modal & Message Area -->
<div id="level-info-modal" class="modal-overlay"> <div class="modal-content"> <div class="modal-header"> <h3 id="modal-title" class="modal-title"> <i id="modal-icon" class="fas fa-info-circle"></i> <span id="modal-level-name"></span> </h3> <button id="modal-close-btn" class="modal-close-btn">×</button> </div> <div id="modal-body" class="modal-body"></div> </div> </div>
<div id="message-area" class="message-area" role="status" aria-live="polite"></div>

<!-- Scripts -->
<script async defer src="https://accounts.google.com/gsi/client"></script>
<script>
    // --- CONFIGURATION & CONSTANTES ---
    const GOOGLE_CLIENT_ID = "731283926358-viam3ulpgna14flfdeb9m92l8s620hoi.apps.googleusercontent.com"; const GOOGLE_DRIVE_SCOPES = 'https://www.googleapis.com/auth/drive.file'; const PROGRAM_FILENAMES = { Push: "armorworkout_push_program.json", Pull: "armorworkout_pull_program.json", Legs: "armorworkout_legs_program.json" }; const EQUIPMENT_CONFIG_FILENAME = "armorworkout_exercise_config.json"; const PROGRAM_TYPES = ['Push', 'Pull', 'Legs']; const GIS_CHECK_INTERVAL = 100; const GIS_MAX_RETRIES = 50;

    // --- PARAMÈTRES ELO ---
    const ELO_BASE = 800; const INTENSITY_TECHNIQUE_BONUS_MULTIPLIER = 1.05; const POLYARTICULAR_WEIGHT = 1.2; const ISOLATION_WEIGHT = 1.0;
    const RESISTANCE_BONUS = { 'Poids du corps': 75, '1 haltère 5kg': 25, '2 haltères 5kg': 50, '1 élastique 15 kg': 50, '1 élastique 15 kg doublé': 100, '1 élastique 25 kg': 125, 'Élastique 15+25kg': 200, };
    const REPS_FACTORS = { 8: 0.9, 12: 1.0, 18: 1.2, 25: 1.3, Infinity: 1.4 };
    const DURATION_FACTORS = { 30: 0.8, 45: 1.0, 60: 1.15, 90: 1.3, 120: 1.4, Infinity: 1.5 };
    const ISOMETRIC_BASE_RESISTANCE_KEY = 'Poids du corps';
    const AVAILABLE_EQUIPMENT = [ '1 haltère 5kg', '2 haltères 5kg', '1 élastique 15 kg', '1 élastique 15 kg doublé', '1 élastique 25 kg', ];

    // --- NIVEAUX & DESCRIPTIONS PHYSIQUES (avec Icônes FA Thématiques & Exemples) ---
    const TARGET_ELO_LEVELS = {
        'L0_Base':    { name: "Débutant",      minELO: 0,    description: "Point de départ. Focus sur la technique, la connexion esprit-muscle et la régularité. Construire les fondations.", celebrity_example: "N/A", colorVar: '--level-beginner-color', bgVar: '--level-beginner-bg', iconClass: 'fa-seedling' },
        'L1_Bronze':  { name: "Bronze",        minELO: 800,  description: "Fondations posées. Force de base acquise, endurance améliorée. Premiers changements physiques subtils.", celebrity_example: "Début de transformation (ex: acteur avant préparation rôle)", colorVar: '--level-bronze-color',   bgVar: '--level-bronze-bg',   iconClass: 'fa-shield-halved' },
        'L2_Silver':  { name: "Argent",        minELO: 950,  description: "Physique athlétique naissant. Contours musculaires nets sous tension. Légère définition.", celebrity_example: "Sportif amateur régulier, physique 'fit' (ex: Zac Efron 'Baywatch')", colorVar: '--level-silver-color',   bgVar: '--level-silver-bg',   iconClass: 'fa-shield' },
        'L3_Gold':    { name: "Or",            minELO: 1050, description: "Force confirmée. Muscles plus pleins. Définition visible au repos léger.", celebrity_example: "Physique bien entraîné et défini (ex: Ryan Reynolds 'Deadpool')", colorVar: '--level-gold-color',     bgVar: '--level-gold-bg',     iconClass: 'fa-trophy' },
        'L_Marvel':   { name: "Marvel Physique", targetELO: 1200, description: "Benchmark : Une esthétique 'super-héroïque' moderne...", celebrity_example: "Chris Hemsworth ('Thor'), Chris Evans ('Captain America')", colorVar: '--level-marvel-color', bgVar: '--level-marvel-bg', iconClass: 'fa-bolt-lightning' },
        'L4_Crystal': { name: "Crystal",       minELO: 1150, description: "Niveau avancé. Volume musculaire notable et définition claire. Vascularité possible.", celebrity_example: "Athlète haut niveau, couv. magazine fitness (ex: Michael B. Jordan 'Creed')", colorVar: '--level-crystal-color',  bgVar: '--level-crystal-bg',  iconClass: 'fa-gem' },
        'L5_Master':  { name: "Master",        minELO: 1250, description: "Maîtrise physique. Muscles très développés, potentiellement striés. Force impressionnante.", celebrity_example: "Compétiteurs Men's Physique (ex: Henry Cavill 'Superman')", colorVar: '--level-master-color',   bgVar: '--level-master-bg',   iconClass: 'fa-chess-king' },
        'L6_Champion':{ name: "Champion",      minELO: 1350, description: "Physique d'élite. Volume et définition exceptionnels, aspect 'ciselé'.", celebrity_example: "Bodybuilders avancés (ex: Dwayne 'The Rock' Johnson)", colorVar: '--level-champion-color', bgVar: '--level-champion-bg', iconClass: 'fa-crown' },
        'L7_Titan':   { name: "Titan",         minELO: 1500, description: "Force et masse colossales. Dépassement des normes. Présence imposante.", celebrity_example: "Strongmen élite (ex: Hafþór Júlíus Björnsson 'The Mountain')", colorVar: '--level-titan-color',    bgVar: '--level-titan-bg',    iconClass: 'fa-mountain-sun' },
        'L8_Legende': { name: "Legende",       minELO: 1650, description: "Statut quasi-mythique. Incarnation de la puissance et de l'esthétique ultime.", celebrity_example: "Bodybuilders pro au sommet (ex: Arnold Schwarzenegger à son apogée)", colorVar: '--level-legende-color',  bgVar: '--level-legende-bg',  iconClass: 'fa-meteor' },
    };
    const LEVEL_ORDER = ['L0_Base', 'L1_Bronze', 'L2_Silver', 'L3_Gold', 'L4_Crystal', 'L5_Master', 'L6_Champion', 'L7_Titan', 'L8_Legende']; const MARVEL_BENCHMARK_KEY = 'L_Marvel';
    const MUSCLE_GROUPS_DISPLAY_CONFIG = { "Pectoraux": { subtitle: "Poitrine", icon: 'fa-dot-circle' }, "Dos": { subtitle: "Dorsaux/Trapèzes", icon: 'fa-bars-staggered' }, "Épaules":{ subtitle: "Deltoïdes", icon: 'fa-atom' }, "Biceps": { subtitle: "Bras (Flex.)", icon: 'fa-link' }, "Triceps": { subtitle: "Bras (Ext.)", icon: 'fa-diamond' }, "Core": { subtitle: "Abdos/Lombaires", icon: 'fa-bullseye' } };
    const LOGIC_TO_DISPLAY_MAP = { Pectoraux: "Pectoraux", Dos: "Dos", Épaules: "Épaules", Biceps: "Biceps", Triceps: "Triceps", Core: "Core" }; const ALL_MUSCLE_GROUPS_LOGIC = Object.keys(LOGIC_TO_DISPLAY_MAP);

    // --- Éléments DOM ---
    let signInButton, signOutButton, driveStatusElement, themeToggleBtn, signInButtonPrompt, connectionPrompt, evolutionTrackerArea, overallEloDisplayValue, levelBadgeContainer, levelBadge, levelBadgeIcon, levelBadgeText, targetEloInfoStrong, marvelTargetInfoSpan, muscleGroupsContainer, messageArea, levelInfoModal, modalTitle, modalIcon, modalLevelName, modalBody, modalCloseBtn, appNav, navButtons, appSections, programConfigArea, programConfigContent, saveConfigButton, levelDetailsArea, levelDetailsContent;

    // --- Variables d'État ---
    let googleAccessToken = null; let tokenClient = null; let programFileIds = { Push: null, Pull: null, Legs: null }; let equipmentConfigFileId = null; let loadedPrograms = { Push: [], Pull: [], Legs: [] }; let exerciseConfig = {}; let programsAnalysisStatus = 'pending'; let configLoadStatus = 'pending'; let currentELOValues = {}; let overallAvgELO = ELO_BASE; let currentGlobalLevelKey = LEVEL_ORDER[0]; let currentTheme = 'dark'; let messageTimeoutId = null; let gisCheckRetries = 0; let previousOverallAvgELO = null;

    // --- Audio ---
    let audioContext = null; function initAudioContext() { if (!audioContext && typeof AudioContext !== 'undefined') { try { audioContext = new AudioContext(); } catch (e) { console.warn("AudioContext non supporté.", e); } } } function playSound(type = 'confirm', volume = 0.15) { if (!audioContext) return; try { const o = audioContext.createOscillator(), g = audioContext.createGain(); o.connect(g); g.connect(audioContext.destination); g.gain.setValueAtTime(0, audioContext.currentTime); g.gain.linearRampToValueAtTime(volume, audioContext.currentTime + 0.01); const t = audioContext.currentTime; let stopTime = t + 0.2; switch (type) { case 'confirm': o.type = 'sine'; o.frequency.setValueAtTime(523.25, t); o.frequency.linearRampToValueAtTime(783.99, t + 0.1); break; case 'error': o.type = 'square'; o.frequency.setValueAtTime(220, t); o.frequency.linearRampToValueAtTime(110, t + 0.15); break; case 'level_up': o.type = 'triangle'; g.gain.linearRampToValueAtTime(volume * 1.2, t + 0.01); o.frequency.setValueAtTime(440, t); o.frequency.linearRampToValueAtTime(554.37, t + 0.08); o.frequency.linearRampToValueAtTime(659.25, t + 0.16); o.frequency.linearRampToValueAtTime(880, t + 0.24); g.gain.exponentialRampToValueAtTime(0.0001, t + 0.4); stopTime = t + 0.4; break; default: o.type = 'triangle'; o.frequency.setValueAtTime(659.25, t); break; } o.start(t); /* Correction: Ne pas appeler stop ici si déjà fait dans level_up */ if (type !== 'level_up') { g.gain.exponentialRampToValueAtTime(0.0001, stopTime); o.stop(stopTime); } } catch (e) { console.warn("Erreur lecture son:", e); } }

    // --- Google Identity Services & Drive API ---
    async function gisInitInternal() { try { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: GOOGLE_CLIENT_ID, scope: GOOGLE_DRIVE_SCOPES, callback: tokenCallback, error_callback: handleTokenError, }); console.log("GIS Client init."); updateAuthUI(googleAccessToken !== null); } catch (error) { console.error("Erreur init GIS:", error); showMessage("Init Google impossible.", 5000, 'error'); if (signInButton) signInButton.disabled = true; if (signInButtonPrompt) signInButtonPrompt.disabled = true; } } function checkAndInitGis() { if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) { console.log("GIS prêt, init..."); gisInitInternal(); } else if (gisCheckRetries < GIS_MAX_RETRIES) { gisCheckRetries++; console.log(`GIS non prêt, retry ${gisCheckRetries}/${GIS_MAX_RETRIES}...`); setTimeout(checkAndInitGis, GIS_CHECK_INTERVAL); } else { console.error("Échec chargement GIS."); showMessage("Service Auth Google indispo.", 6000, 'error'); if (signInButton) signInButton.disabled = true; if (signInButtonPrompt) signInButtonPrompt.disabled = true;} } function handleTokenError(error) { console.error("Erreur Auth Google:", error); let msg = "Erreur connexion Google."; if (error?.type === 'popup_closed_by_user') msg = "Connexion annulée."; else if (error?.type === 'access_denied') msg = "Accès Drive refusé."; else if (error?.error === 'popup_blocked_by_browser') msg = "Popup connexion bloqué."; else if (error?.details) msg += ` Détails: ${error.details}`; showMessage(msg, 5000, 'error'); playSound('error'); googleAccessToken = null; previousOverallAvgELO = null; updateAuthUI(false); resetEvolutionDisplay(); resetConfigUI(); resetLevelDetailsUI(); }
    async function tokenCallback(tokenResponse) { if (tokenResponse.error) { handleTokenError(tokenResponse); return; } if (tokenResponse && tokenResponse.access_token) { console.log("Access Token reçu."); googleAccessToken = tokenResponse.access_token; previousOverallAvgELO = null; playSound('confirm'); showMessage("Connecté ! Chargement données...", 2500, 'info'); if (muscleGroupsContainer) muscleGroupsContainer.innerHTML = '<p class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i> Chargement Données...</p>'; if (programConfigContent) programConfigContent.innerHTML = '<p class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i> Chargement Données...</p>'; if (levelDetailsContent) levelDetailsContent.innerHTML = '<p class="loading-placeholder"><i class="fas fa-spinner fa-spin"></i> Chargement Données...</p>'; resetEvolutionDisplay(); try { const [programsStatus, configStatus] = await Promise.all([ loadProgramsFromDrive(), loadExerciseConfigFromDrive() ]); programsAnalysisStatus = programsStatus; configLoadStatus = configStatus; console.log("Statut analyse progs:", programsAnalysisStatus); console.log("Statut chargement config:", configLoadStatus); if (programsAnalysisStatus === 'error' || configLoadStatus === 'error') { showMessage("Erreur chargement programmes ou config.", 6000, 'error'); playSound('error'); } else if (programsAnalysisStatus === 'partial' || configLoadStatus === 'partial') { showMessage("Données partielles (progs ou config manquante).", 5000, 'warning'); } else { showMessage("Données chargées. Calcul évolution...", 3000, 'success'); } calculateAndDisplayEvolution(); renderProgramConfigUI(); renderLevelDetailsUI(); } catch (error) { console.error("Erreur CRITIQUE chargement/analyse:", error); showMessage("Erreur majeure chargement.", 6000, 'error'); playSound('error'); programsAnalysisStatus = 'error'; configLoadStatus = 'error'; if (muscleGroupsContainer) muscleGroupsContainer.innerHTML = `<p class="error-placeholder">Erreur critique : ${error.message}</p>`; if (programConfigContent) programConfigContent.innerHTML = `<p class="error-placeholder">Erreur critique : ${error.message}</p>`; if (levelDetailsContent) levelDetailsContent.innerHTML = `<p class="error-placeholder">Erreur critique : ${error.message}</p>`; resetEvolutionDisplay(); } finally { updateAuthUI(true); } } else { handleTokenError({ error: "invalid_response", details: "Réponse Google invalide." }); } }
    function handleAuthClick() { initAudioContext(); if (tokenClient) { console.log("Demande token Google..."); showMessage("Ouverture connexion Google...", 2000, 'info'); tokenClient.requestAccessToken({ prompt: '' }); } else { console.error("Auth sans tokenClient."); showMessage("Erreur : Service connexion non prêt.", 4000, 'error'); checkAndInitGis(); } }
    function handleSignoutClick(showMessages = true) { const token = googleAccessToken; if (!token) { console.log("Déjà déconnecté."); updateAuthUI(false); return; } initAudioContext(); if (showMessages) showMessage("Déconnexion...", 1500, 'info'); google.accounts.oauth2.revoke(token, () => { console.log('Token Google révoqué.'); googleAccessToken = null; programFileIds = { Push: null, Pull: null, Legs: null }; equipmentConfigFileId = null; programsAnalysisStatus = 'pending'; configLoadStatus = 'pending'; loadedPrograms = { Push: [], Pull: [], Legs: [] }; exerciseConfig = {}; currentELOValues = {}; overallAvgELO = ELO_BASE; currentGlobalLevelKey = LEVEL_ORDER[0]; previousOverallAvgELO = null; if (showMessages) { showMessage("Déconnecté.", 3000, 'info'); playSound('confirm'); } resetEvolutionDisplay(); resetConfigUI(); resetLevelDetailsUI(); updateAuthUI(false); }); }
    async function findFileId(filename) { if (!googleAccessToken) return null; try { const r = await fetch(`https://www.googleapis.com/drive/v3/files?q=name='${filename}' and trashed=false&fields=files(id, name)`, { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }); if (!r.ok) { if (r.status === 401 || r.status === 403) { console.warn(`Auth expirée (find ${filename}). Déco.`); handleSignoutClick(false); } else { console.error(`Erreur Drive (find ${filename}): ${r.status} ${r.statusText}`); } throw new Error(`Erreur Drive ${r.status}`); } const d = await r.json(); if (d.files && d.files.length > 0) return d.files[0].id; return null; } catch (e) { console.error(`Erreur recherche ${filename}:`, e); return null; } }
    async function readFileContent(fileId) { if (!googleAccessToken || !fileId) return null; try { const r = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }); if (!r.ok) { if (r.status === 401 || r.status === 403) { console.warn(`Auth expirée (read ${fileId}). Déco.`); handleSignoutClick(false); } else { console.error(`Erreur Drive (read ${fileId}): ${r.status} ${r.statusText}`); } throw new Error(`Erreur Drive ${r.status}`); } return await r.text(); } catch (e) { console.error(`Erreur lecture ${fileId}:`, e); return null; } }
    async function loadProgramsFromDrive() { if (!googleAccessToken) return 'error'; console.log("Chargement programmes Drive..."); let allOk = true, anyOk = false; const tmp = { Push: [], Pull: [], Legs: [] }; for (const type of PROGRAM_TYPES) { programFileIds[type] = await findFileId(PROGRAM_FILENAMES[type]); let fileOk = false; if (programFileIds[type]) { const content = await readFileContent(programFileIds[type]); if (content !== null) { try { const p = JSON.parse(content || '[]'); if (Array.isArray(p)) { tmp[type] = p; fileOk = true; anyOk = true; if (p.length === 0) console.warn(`Prog ${type} vide.`); } else { console.error(`Contenu ${type} non-Array.`); showMessage(`Format invalide ${PROGRAM_FILENAMES[type]}.`, 4000, 'warning'); allOk = false; } } catch (e) { console.error(`Erreur parsing JSON ${type}:`, e); showMessage(`Erreur format JSON ${PROGRAM_FILENAMES[type]}.`, 4000, 'error'); playSound('error'); allOk = false; } } else { console.warn(`Lecture ${type} échouée.`); showMessage(`Impossible lire ${PROGRAM_FILENAMES[type]}.`, 4000, 'warning'); allOk = false; } } else { console.warn(`Fichier ${PROGRAM_FILENAMES[type]} introuvable.`); allOk = false; } } loadedPrograms = tmp; console.log(`Fin chargement progs. Global: ${allOk}, Partiel: ${anyOk}`); if (allOk) return 'success'; if (anyOk) return 'partial'; return 'error'; }
    async function loadExerciseConfigFromDrive() { if (!googleAccessToken) return 'error'; console.log("Chargement config équipement..."); equipmentConfigFileId = await findFileId(EQUIPMENT_CONFIG_FILENAME); if (equipmentConfigFileId) { const content = await readFileContent(equipmentConfigFileId); if (content !== null) { try { const parsedConfig = JSON.parse(content || '{}'); exerciseConfig = typeof parsedConfig === 'object' && parsedConfig !== null ? parsedConfig : {}; console.log("Config équipement chargée."); return 'success'; } catch (e) { console.error("Erreur parsing JSON config:", e); showMessage("Erreur format JSON config équipement.", 4000, 'error'); playSound('error'); exerciseConfig = {}; return 'error'; } } else { console.warn("Lecture config échouée."); showMessage("Impossible lire config équipement.", 4000, 'warning'); exerciseConfig = {}; return 'error'; } } else { console.warn(`Fichier config "${EQUIPMENT_CONFIG_FILENAME}" introuvable.`); exerciseConfig = {}; return 'partial'; } }
    async function saveExerciseConfigToDrive() { if (!googleAccessToken || !saveConfigButton) return; console.log("Sauvegarde config équipement..."); saveConfigButton.disabled = true; saveConfigButton.classList.add('saving'); const currentConfig = {}; const checkboxes = programConfigContent.querySelectorAll('input[type="checkbox"]'); checkboxes.forEach(cb => { const exerciseName = cb.dataset.exerciseName; const equipmentName = cb.value; if (!exerciseName || !equipmentName) return; if (!currentConfig[exerciseName]) { currentConfig[exerciseName] = { added_equipment: [] }; } if (cb.checked) { currentConfig[exerciseName].added_equipment.push(equipmentName); } }); for (const exo in currentConfig) { if (currentConfig[exo].added_equipment.length === 0) { delete currentConfig[exo]; } } const configJson = JSON.stringify(currentConfig, null, 2); try { let method = 'PATCH'; let url = `https://www.googleapis.com/upload/drive/v3/files/${equipmentConfigFileId}?uploadType=media`; let body = configJson; let headers = { 'Authorization': `Bearer ${googleAccessToken}`, 'Content-Type': 'application/json' }; if (!equipmentConfigFileId) { console.log("Aucun ID config, tentative création..."); method = 'POST'; url = 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart'; const metadata = { name: EQUIPMENT_CONFIG_FILENAME, mimeType: 'application/json' }; const form = new FormData(); form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' })); form.append('file', new Blob([configJson], { type: 'application/json' })); body = form; headers = { 'Authorization': `Bearer ${googleAccessToken}` }; } const response = await fetch(url, { method: method, headers: headers, body: body }); if (!response.ok) { if (response.status === 401 || response.status === 403) { handleSignoutClick(false); } const errorBody = await response.text(); console.error("Erreur sauvegarde fichier:", response.status, errorBody); throw new Error(`Erreur Drive ${response.status} (${method === 'POST' ? 'Création' : 'MàJ'})`); } const result = await response.json(); if (method === 'POST' && result.id) { equipmentConfigFileId = result.id; console.log("Fichier config créé avec ID:", equipmentConfigFileId); } console.log("Config équipement sauvegardée."); exerciseConfig = currentConfig; showMessage("Configuration équipement sauvegardée !", 3000, 'success'); playSound('confirm'); calculateAndDisplayEvolution(); } catch (error) { console.error("Erreur sauvegarde config:", error); showMessage(`Erreur sauvegarde config: ${error.message}`, 5000, 'error'); playSound('error'); } finally { saveConfigButton.disabled = false; saveConfigButton.classList.remove('saving'); } }

    // --- Logique de Calcul ELO ---
    function getRepsFactor(reps) { const n = parseInt(reps, 10); if (isNaN(n) || reps === 'AMRAP' || reps === 'MAX') return REPS_FACTORS[Infinity]; if (n <= 8) return REPS_FACTORS[8]; if (n <= 12) return REPS_FACTORS[12]; if (n <= 18) return REPS_FACTORS[18]; if (n <= 25) return REPS_FACTORS[25]; return REPS_FACTORS[Infinity]; }
    function isPolyarticular(name) { const l = name.toLowerCase(); const k = ['pompes', 'push up', 'dips', 'tractions', 'pull up', 'chin up', 'rowing', 'tirage', 'squat', 'fentes', 'soulevé', 'deadlift', 'développé', 'press', 'overhead press']; return k.some(w => l.includes(w)); }
    function getDurationFactor(durationInSeconds) { if (isNaN(durationInSeconds) || durationInSeconds <= 0) return DURATION_FACTORS[30]; if (durationInSeconds <= 30) return DURATION_FACTORS[30]; if (durationInSeconds <= 45) return DURATION_FACTORS[45]; if (durationInSeconds <= 60) return DURATION_FACTORS[60]; if (durationInSeconds <= 90) return DURATION_FACTORS[90]; if (durationInSeconds <= 120) return DURATION_FACTORS[120]; return DURATION_FACTORS[Infinity]; }
    function calculateExerciseELO(step) { if (!step || step.type !== 'exercise' || !step.details) return 0; const details = step.details; const isDurationBased = details.duration && parseInt(details.duration, 10) > 0 && (!details.reps || details.reps === 'N/A' || parseInt(details.reps, 10) === 0); let baseResistanceValue = RESISTANCE_BONUS[details.resistance] || RESISTANCE_BONUS['Poids du corps'] || 0; let addedResistanceValue = 0; const configForThisExo = exerciseConfig[step.name]; if (configForThisExo?.added_equipment?.length > 0) { configForThisExo.added_equipment.forEach(equipKey => { addedResistanceValue += (RESISTANCE_BONUS[equipKey] || 0); }); } const totalResistanceBonus = baseResistanceValue + addedResistanceValue; const techniqueBonus = (details.intensityTechnique && details.intensityTechnique !== 'Aucune') ? INTENSITY_TECHNIQUE_BONUS_MULTIPLIER : 1.0; let calculatedElo = 0; if (isDurationBased) { const durationFactor = getDurationFactor(parseInt(details.duration, 10)); const isoResistance = totalResistanceBonus > 0 ? totalResistanceBonus : (RESISTANCE_BONUS[ISOMETRIC_BASE_RESISTANCE_KEY] || 75); calculatedElo = ELO_BASE / 10 + (isoResistance * durationFactor * techniqueBonus); } else { const repsFactor = getRepsFactor(details.reps); calculatedElo = ELO_BASE / 10 + (totalResistanceBonus * repsFactor * techniqueBonus); } return calculatedElo; }
    function mapExerciseToMuscleGroup(name) { const cleanedName = name.replace(/\s*\d+$/, '').trim(); const l = cleanedName.toLowerCase(); if (l.includes('pompes') || l.includes('push up') || l.includes('dips') || l.includes('développé couché') || l.includes('chest press') || l.includes('écarté') || l.includes('band floor press')) return ['Pectoraux', 'Triceps', 'Épaules']; if (l.includes('tractions') || l.includes('pull up') || l.includes('chin up') || l.includes('rowing') || l.includes('tirage') || l.includes('band bent-over row') || l.includes('band kneeling lat pulldown')) return ['Dos', 'Biceps']; if (l.includes('développé militaire') || l.includes('overhead press') || l.includes('élévations latérales') || l.includes('shoulder press') || l.includes('dumbbell lateral raises') || l.includes('band face pull')) return ['Épaules', 'Triceps']; if (l.includes('curl') || l.includes('biceps')) return ['Biceps']; if (l.includes('extension triceps') || l.includes('triceps pushdown') || l.includes('skullcrusher') || l.includes('overhead triceps extension (band)')) return ['Triceps']; if (l.includes('gainage') || l.includes('planche') || l.includes('crunch') || l.includes('abdos') || l.includes('core') || l.includes('hollow body') || l.includes('band sit-up') || l.includes('leg raises')) return ['Core']; if (l.includes('squat') || l.includes('fentes') || l.includes('leg press') || l.includes('leg extension') || l.includes('leg curl') || l.includes('mollets') || l.includes('calf raises')) return ['Legs']; console.warn(`Mapping muscle inconnu pour: "${name}" (nettoyé en "${cleanedName}")`); return []; }
    // Correction Bug ELO Identique: Revu le calcul de la moyenne par groupe
    function analyzeProgramsAndCalculateELO() {
        console.log("Analyse programmes & calcul ELO...");
        const groupData = {};
        [...ALL_MUSCLE_GROUPS_LOGIC, 'Legs'].forEach(g => { groupData[g] = { totalWeightedElo: 0, totalWeight: 0 }; });
        currentELOValues = {};

        if (programsAnalysisStatus === 'error' || programsAnalysisStatus === 'pending' || configLoadStatus === 'error') {
            console.warn("Analyse ELO annulée.");
            ALL_MUSCLE_GROUPS_LOGIC.forEach(g => { currentELOValues[g] = ELO_BASE; });
            overallAvgELO = ELO_BASE; previousOverallAvgELO = null;
            return;
        }

        PROGRAM_TYPES.forEach(type => {
            const program = loadedPrograms[type];
            if (!program || program.length === 0) return;
            let currentExo = null, sets = 0, lastStep = null;
            program.forEach((step, idx) => {
                if (step.type === 'exercise') {
                    if (step.name === currentExo && lastStep) { sets++; }
                    else { if (lastStep) processExerciseBlock(lastStep, sets, groupData); currentExo = step.name; sets = 1; }
                    lastStep = step;
                    if (idx === program.length - 1) processExerciseBlock(lastStep, sets, groupData);
                } else if (step.type === 'break' || step.type === 'info') {
                    if (lastStep) processExerciseBlock(lastStep, sets, groupData);
                    currentExo = null; sets = 0; lastStep = null;
                }
            });
        });

        let totalEloSumGain = 0; // Somme des GAINS pondérés
        let totalWeightOverall = 0; // Poids total pour la moyenne globale

        ALL_MUSCLE_GROUPS_LOGIC.forEach(g => {
            const d = groupData[g];
            let averageWeightedEloGain = 0;
            if (d.totalWeight > 0) {
                averageWeightedEloGain = d.totalWeightedElo / d.totalWeight; // Calcul de la moyenne du *gain* ELO pondéré
            }
            // ELO final = Base + Gain moyen (arrondi)
            currentELOValues[g] = ELO_BASE + Math.round(averageWeightedEloGain);
            // Assurer que l'ELO ne descend pas SOUS la base (peut arriver si ELO négatif par accident)
            currentELOValues[g] = Math.max(ELO_BASE, currentELOValues[g]);

            console.log(`Debug ELO Calcul [${g}]: TotalELO=${d.totalWeightedElo.toFixed(2)}, TotalWeight=${d.totalWeight.toFixed(2)}, AvgGain=${averageWeightedEloGain.toFixed(2)}, ELO Final=${currentELOValues[g]}`);

            // Calcul pour la moyenne globale (haut du corps)
            if (g !== 'Legs' && d.totalWeight > 0) {
                totalEloSumGain += averageWeightedEloGain * d.totalWeight; // Somme des gains pondérés
                totalWeightOverall += d.totalWeight;
            }
        });

        if (overallAvgELO >= ELO_BASE) { previousOverallAvgELO = overallAvgELO; }
        // Moyenne globale = Base + Moyenne pondérée des GAINS
        overallAvgELO = totalWeightOverall > 0 ? ELO_BASE + Math.round(totalEloSumGain / totalWeightOverall) : ELO_BASE;
        overallAvgELO = Math.max(ELO_BASE, overallAvgELO); // Assurer minimum ELO_BASE

        console.log(`ELO Global: ${overallAvgELO} (Préc: ${previousOverallAvgELO})`);
        console.log("ELO Groupes Finaux:", currentELOValues);
    }
    function processExerciseBlock(step, sets, data) { const eloGain = calculateExerciseELO(step) - ELO_BASE; /* Calculer le GAIN par rapport à la base */ if (eloGain > -(ELO_BASE/10) && sets > 0) { /* Permettre léger gain négatif mais pas trop */ const poly = isPolyarticular(step.name); const w = poly ? POLYARTICULAR_WEIGHT : ISOLATION_WEIGHT; const groups = mapExerciseToMuscleGroup(step.name); groups.forEach(g => { if (data[g]) { data[g].totalWeightedElo += eloGain * sets * w; /* Accumuler le GAIN pondéré */ data[g].totalWeight += sets * w; } else { console.warn(`Groupe logique inconnu : ${g} pour ${step.name}`); } }); } }
    function getEloLevelKey(eloScore) { for (let i = LEVEL_ORDER.length - 1; i >= 0; i--) { const k = LEVEL_ORDER[i]; if (TARGET_ELO_LEVELS[k] && eloScore >= TARGET_ELO_LEVELS[k].minELO) { return k; } } return LEVEL_ORDER[0]; }

    // --- Logique Affichage ---
    function calculateAndDisplayEvolution() { console.log("Mise à jour affichage évolution..."); if (!evolutionTrackerArea || !overallEloDisplayValue || !levelBadge || !targetEloInfoStrong || !muscleGroupsContainer || !levelBadgeContainer || !marvelTargetInfoSpan) { console.error("DOM manquant."); if(muscleGroupsContainer) muscleGroupsContainer.innerHTML = '<p class="error-placeholder">Erreur interne: DOM manquant.</p>'; return; } if (programsAnalysisStatus !== 'pending') { analyzeProgramsAndCalculateELO(); } else { ALL_MUSCLE_GROUPS_LOGIC.forEach(g => { currentELOValues[g] = ELO_BASE; }); overallAvgELO = ELO_BASE; previousOverallAvgELO = null; } const previousGlobalLevelKey = currentGlobalLevelKey; currentGlobalLevelKey = getEloLevelKey(overallAvgELO); const currentGlobalLevel = TARGET_ELO_LEVELS[currentGlobalLevelKey]; const currentGlobalLevelIndex = LEVEL_ORDER.indexOf(currentGlobalLevelKey); const nextGlobalLevelKey = currentGlobalLevelIndex < LEVEL_ORDER.length - 1 ? LEVEL_ORDER[currentGlobalLevelIndex + 1] : null; const nextGlobalLevel = nextGlobalLevelKey ? TARGET_ELO_LEVELS[nextGlobalLevelKey] : null; const marvelBenchmark = TARGET_ELO_LEVELS[MARVEL_BENCHMARK_KEY]; if (previousOverallAvgELO !== null && currentGlobalLevelKey !== previousGlobalLevelKey && TARGET_ELO_LEVELS[previousGlobalLevelKey]) { if (overallAvgELO >= TARGET_ELO_LEVELS[previousGlobalLevelKey].minELO) { console.log(`NIVEAU GLOBAL ATTEINT ! ${previousGlobalLevelKey} -> ${currentGlobalLevelKey}`); showMessage(`Félicitations ! Niveau Global ${currentGlobalLevel.name} atteint !`, 5000, 'success'); playSound('level_up', 0.2); const card = document.querySelector('.global-stats-card'); if (card) { card.style.animation = 'levelUpGlow 1.5s ease-out'; setTimeout(() => { card.style.animation = ''; }, 1500); } } } animateValue(overallEloDisplayValue, parseFloat(overallEloDisplayValue.textContent.replace(/[^0-9.]/g, '')) || ELO_BASE, overallAvgELO, 700); levelBadgeIcon.className = `fas ${currentGlobalLevel.iconClass}`; levelBadgeText.textContent = currentGlobalLevel.name; levelBadge.style.color = `var(${currentGlobalLevel.colorVar})`; levelBadge.style.backgroundColor = `var(${currentGlobalLevel.bgVar})`; levelBadge.style.borderColor = `var(${currentGlobalLevel.colorVar})`; levelBadge.setAttribute('data-level-key', currentGlobalLevelKey); targetEloInfoStrong.textContent = nextGlobalLevel ? `${nextGlobalLevel.minELO} ELO` : "MAX"; marvelTargetInfoSpan.textContent = marvelBenchmark ? `${marvelBenchmark.targetELO} ELO` : "-- ELO"; const isMarvelAchieved = marvelBenchmark && overallAvgELO >= marvelBenchmark.targetELO; const existingMarvelIcon = document.getElementById('marvel-icon'); if (isMarvelAchieved) { if (!existingMarvelIcon) { const marvelIcon = document.createElement('i'); marvelIcon.id = 'marvel-icon'; marvelIcon.className = `fas ${marvelBenchmark.iconClass} marvel-achieved-icon`; marvelIcon.setAttribute('title', `Benchmark "${marvelBenchmark.name}" (${marvelBenchmark.targetELO} ELO) atteint ! ${marvelBenchmark.description}`); levelBadgeContainer.appendChild(marvelIcon); } } else { if (existingMarvelIcon) { existingMarvelIcon.remove(); } } muscleGroupsContainer.innerHTML = ''; let hasData = false; for (const displayGroup in MUSCLE_GROUPS_DISPLAY_CONFIG) { const logicGroup = ALL_MUSCLE_GROUPS_LOGIC.find(key => LOGIC_TO_DISPLAY_MAP[key] === displayGroup); if (!logicGroup || currentELOValues[logicGroup] === undefined) { console.warn(`Skipping render for ${displayGroup} - Logic group ${logicGroup} not found or ELO undefined`); continue; } hasData = true; const config = MUSCLE_GROUPS_DISPLAY_CONFIG[displayGroup]; const currentElo = currentELOValues[logicGroup]; const muscleLevelKey = getEloLevelKey(currentElo); const muscleLevel = TARGET_ELO_LEVELS[muscleLevelKey]; const muscleLevelIndex = LEVEL_ORDER.indexOf(muscleLevelKey); const nextMuscleLevelKey = muscleLevelIndex < LEVEL_ORDER.length - 1 ? LEVEL_ORDER[muscleLevelIndex + 1] : null; const nextMuscleLevel = nextMuscleLevelKey ? TARGET_ELO_LEVELS[nextMuscleLevelKey] : null; const minEloCurrent = muscleLevel.minELO; const minEloNext = nextMuscleLevel ? nextMuscleLevel.minELO : minEloCurrent; const range = minEloNext - minEloCurrent; let progress = 0; if (range > 0) { progress = ((currentElo - minEloCurrent) / range) * 100; } else if (currentElo >= minEloCurrent) { progress = 100; } const displayPercent = Math.max(0, Math.min(100, Math.round(progress))); const isTargetReached = nextMuscleLevel ? currentElo >= minEloNext : true; const targetDisplay = nextMuscleLevel ? minEloNext : "MAX"; const card = renderMuscleGroupCard(displayGroup, config.subtitle, config.icon, currentElo, targetDisplay, displayPercent, muscleLevelKey, muscleLevel.name, muscleLevel.colorVar, muscleLevel.bgVar, isTargetReached); muscleGroupsContainer.appendChild(card); } if (!hasData && programsAnalysisStatus !== 'pending') { const msg = programsAnalysisStatus === 'error' ? 'Aucune donnée valide analysée.' : 'Aucune donnée évolution.'; muscleGroupsContainer.innerHTML = `<p class="${programsAnalysisStatus === 'error' ? 'error' : 'loading'}-placeholder">${msg}</p>`; } console.log("Affichage évolution mis à jour."); }
    function renderMuscleGroupCard(title, subtitle, iconClass, currentElo, targetEloNextMin, displayPercent, currentLevelKey, currentLevelName, currentLevelColorVar, currentLevelBgVar, isTargetReached) { const card = document.createElement('div'); card.className = 'muscle-group-card'; if (isTargetReached) { card.classList.add('level-target-reached'); } card.setAttribute('title', `${title} (${subtitle}) - Niveau: ${currentLevelName} - ELO: ${currentElo} / ${targetEloNextMin}. Progression: ${displayPercent}%.`); card.innerHTML = `<div class="card-header"><div class="icon-container"><i class="fas ${iconClass}" aria-hidden="true"></i></div><div class="title-container"><div class="group-title">${title}</div><div class="group-subtitle">${subtitle}</div><div class="group-level-name" style="color: var(${currentLevelColorVar}); background-color: var(${currentLevelBgVar}); border-color: var(${currentLevelColorVar});" data-level-key="${currentLevelKey}">${currentLevelName}</div></div><div class="elo-details" title="ELO Actuel / Seuil ELO Niveau Suivant"><span class="current">${currentElo}</span> / <span class="target">${targetEloNextMin}</span></div></div><div class="progress-section"><div class="progress-bar-container" title="Progression: ${displayPercent}%"><div class="progress-bar" style="width: 0%;" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div></div><span class="progress-percentage-value">${displayPercent}%</span></div>`; requestAnimationFrame(() => { setTimeout(() => { const pb = card.querySelector('.progress-bar'); if (pb) { pb.style.width = `${displayPercent}%`; pb.setAttribute('aria-valuenow', displayPercent); } }, 50); }); return card; }
    function resetEvolutionDisplay() { console.log("Réinitialisation affichage..."); if (muscleGroupsContainer) { muscleGroupsContainer.innerHTML = `<p class="loading-placeholder">${googleAccessToken ? 'Analyse...' : 'Connectez-vous...'}</p>`; } if (overallEloDisplayValue) overallEloDisplayValue.textContent = '--'; const baseLevel = TARGET_ELO_LEVELS[LEVEL_ORDER[0]]; if (levelBadge && baseLevel) { levelBadgeIcon.className = `fas ${baseLevel.iconClass}`; levelBadgeText.textContent = baseLevel.name; levelBadge.style.color = `var(${baseLevel.colorVar})`; levelBadge.style.backgroundColor = `var(${baseLevel.bgVar})`; levelBadge.style.borderColor = `var(${baseLevel.colorVar})`; levelBadge.setAttribute('data-level-key', LEVEL_ORDER[0]); } const firstRealLevelKey = LEVEL_ORDER.length > 1 ? LEVEL_ORDER[1] : null; const firstRealLevel = firstRealLevelKey ? TARGET_ELO_LEVELS[firstRealLevelKey] : null; if (targetEloInfoStrong) targetEloInfoStrong.textContent = firstRealLevel ? `${firstRealLevel.minELO} ELO` : '-- ELO'; const marvelBenchmark = TARGET_ELO_LEVELS[MARVEL_BENCHMARK_KEY]; if (marvelTargetInfoSpan && marvelBenchmark) { marvelTargetInfoSpan.textContent = `${marvelBenchmark.targetELO} ELO`; } const existingMarvelIcon = document.getElementById('marvel-icon'); if (existingMarvelIcon) { existingMarvelIcon.remove(); } previousOverallAvgELO = null; currentGlobalLevelKey = LEVEL_ORDER[0]; }

    // --- Rendu UI Config Équipement ---
    function renderProgramConfigUI() { if (!programConfigContent || programsAnalysisStatus === 'pending' || programsAnalysisStatus === 'error') { programConfigContent.innerHTML = '<p class="loading-placeholder">Chargez d\'abord vos programmes.</p>'; if(saveConfigButton) saveConfigButton.disabled = true; return; } let html = ''; let hasExercises = false; const uniqueExercises = new Set(); PROGRAM_TYPES.forEach(type => { const program = loadedPrograms[type]; if (program && program.length > 0) { program.forEach(step => { if (step.type === 'exercise' && !uniqueExercises.has(step.name)) { uniqueExercises.add(step.name); } }); } }); if (uniqueExercises.size === 0) { programConfigContent.innerHTML = '<p class="loading-placeholder">Aucun exercice trouvé.</p>'; if(saveConfigButton) saveConfigButton.disabled = true; return; } html += `<div class="program-config-section"><h3>Tous les exercices</h3>`; uniqueExercises.forEach(exerciseName => { hasExercises = true; html += `<div class="config-exercise-item"><span class="exercise-name">${exerciseName}</span><div class="config-equipment-options">`; AVAILABLE_EQUIPMENT.forEach(equip => { const isChecked = exerciseConfig[exerciseName]?.added_equipment?.includes(equip) || false; html += `<label><input type="checkbox" value="${equip}" data-exercise-name="${exerciseName}" ${isChecked ? 'checked' : ''}> ${equip}</label>`; }); html += `</div></div>`; }); html += `</div>`; if(saveConfigButton) saveConfigButton.disabled = false; programConfigContent.innerHTML = html; }
    function resetConfigUI() { if (programConfigContent) { programConfigContent.innerHTML = '<p class="loading-placeholder">Connectez-vous.</p>'; } if(saveConfigButton) saveConfigButton.disabled = true; exerciseConfig = {}; }

    // --- Rendu UI Détails Niveaux ---
    function renderLevelDetailsUI() { if (!levelDetailsContent) return; let html = ''; LEVEL_ORDER.forEach(levelKey => { const level = TARGET_ELO_LEVELS[levelKey]; if (level) { html += `<div class="level-detail-item" style="border-left-color: var(${level.colorVar});"><div class="level-detail-header"><i class="fas ${level.iconClass} level-detail-icon" style="color: var(${level.colorVar});"></i><span class="level-detail-name" style="color: var(${level.colorVar});">${level.name}</span><span class="level-detail-elo">ELO Min: ${level.minELO}+</span></div><p class="level-detail-description">${level.description}</p><p class="level-detail-celebrity">Exemple Physique: <strong>${level.celebrity_example || 'N/A'}</strong></p></div>`; } }); const marvelLevel = TARGET_ELO_LEVELS[MARVEL_BENCHMARK_KEY]; if (marvelLevel) { html += `<div class="level-detail-item" style="border-left-color: var(${marvelLevel.colorVar}); margin-top: 30px;"><div class="level-detail-header"><i class="fas ${marvelLevel.iconClass} level-detail-icon" style="color: var(${marvelLevel.colorVar});"></i><span class="level-detail-name" style="color: var(${marvelLevel.colorVar});">${marvelLevel.name} (Benchmark)</span><span class="level-detail-elo">Objectif: ${marvelLevel.targetELO} ELO</span></div><p class="level-detail-description">${marvelLevel.description}</p><p class="level-detail-celebrity">Exemple Physique: <strong>${marvelLevel.celebrity_example || 'N/A'}</strong></p></div>`; } levelDetailsContent.innerHTML = html || '<p class="loading-placeholder">Impossible de charger les détails des niveaux.</p>'; }
    function resetLevelDetailsUI() { if (levelDetailsContent) { levelDetailsContent.innerHTML = '<p class="loading-placeholder">Connectez-vous pour voir les détails...</p>'; } }

    // --- Fonctions Modal ---
    function openLevelInfoModal(levelKey) { if (!levelInfoModal || !TARGET_ELO_LEVELS[levelKey]) return; const levelData = TARGET_ELO_LEVELS[levelKey]; modalIcon.className = `fas ${levelData.iconClass}`; modalLevelName.textContent = levelData.name; modalBody.innerHTML = `<p>${levelData.description.replace(/\n/g, '<br>')}</p>`; modalTitle.style.color = `var(${levelData.colorVar})`; levelInfoModal.classList.add('visible'); } function closeLevelInfoModal() { if (levelInfoModal) levelInfoModal.classList.remove('visible'); }

    // --- Animation & UI Update & Thème & Message ---
    function animateValue(el, start, end, duration) { if (!el) return; if (start === end) { el.textContent = Math.round(end); return; } const range = end - start; let current = start; const inc = end > start ? 1 : -1; const stepTime = Math.abs(Math.floor(duration / range)); const effStepTime = Math.max(1, Math.min(stepTime, 50)); const timer = setInterval(() => { current += inc * Math.max(1, Math.round(Math.abs(end - current) / 10)); if ((inc > 0 && current >= end) || (inc < 0 && current <= end)) { current = end; clearInterval(timer); } el.textContent = Math.round(current); }, effStepTime); }
    function updateAuthUI(isLoggedIn) { console.log(`Update UI - Connecté: ${isLoggedIn}, GIS prêt: ${!!tokenClient}`); const b = document.body; b.classList.toggle('logged-in', isLoggedIn); b.classList.toggle('logged-out', !isLoggedIn); if(signInButton) signInButton.disabled = isLoggedIn || !tokenClient; if(signInButtonPrompt) signInButtonPrompt.disabled = isLoggedIn || !tokenClient; if(signOutButton) signOutButton.disabled = !isLoggedIn; if(themeToggleBtn) themeToggleBtn.disabled = false; if (connectionPrompt) connectionPrompt.style.display = isLoggedIn ? 'none' : 'block'; navButtons.forEach(btn => btn.disabled = !isLoggedIn); if (isLoggedIn) { switchTab(document.querySelector('.nav-button.active')?.dataset.section || 'evolution-tracker-area'); } else { appSections.forEach(sec => sec.style.display = 'none'); } if (!isLoggedIn) { programsAnalysisStatus = 'pending'; configLoadStatus = 'pending'; resetEvolutionDisplay(); resetConfigUI(); resetLevelDetailsUI(); } }
    function applyTheme(theme) { document.body.classList.remove('light-theme', 'dark-theme'); document.body.classList.add(theme + '-theme'); currentTheme = theme; localStorage.setItem('armorWorkoutTheme', theme); if (themeToggleBtn) { const i = themeToggleBtn.querySelector('i'); if (i) i.className = `fas fa-${theme === 'dark' ? 'sun' : 'moon'}`; themeToggleBtn.setAttribute('aria-label', `Passer au thème ${theme === 'dark' ? 'clair' : 'sombre'}`); } console.log(`Thème appliqué: ${theme}`); }
    function toggleTheme() { showMessage("Thème clair non disponible.", 2000, 'info'); playSound('confirm'); } function loadSavedTheme() { applyTheme('dark'); }
    function showMessage(msg, duration = 3000, type = 'info') { if (!messageArea) return; messageArea.textContent = msg; messageArea.className = `message-area ${type} visible`; if (messageTimeoutId) clearTimeout(messageTimeoutId); messageTimeoutId = setTimeout(() => { messageArea.classList.remove('visible'); setTimeout(() => { if (!messageArea.classList.contains('visible')) { messageArea.className = 'message-area'; } }, 500); }, duration); }

    // --- Gestion Navigation ---
    function switchTab(targetSectionId) { if (!targetSectionId) return; console.log("Switch tab to:", targetSectionId); appSections.forEach(section => { section.style.display = 'none'; }); const targetSection = document.getElementById(targetSectionId); if (targetSection) { targetSection.style.display = 'flex'; targetSection.style.flexDirection = 'column'; } else { console.error("Section cible non trouvée:", targetSectionId); } navButtons.forEach(btn => { btn.classList.toggle('active', btn.dataset.section === targetSectionId); }); if (targetSectionId === 'program-config-area') { renderProgramConfigUI(); } else if (targetSectionId === 'level-details-area') { renderLevelDetailsUI(); } }

    // --- Initialisation ---
    function initializeDOMReferences() { console.log("Init DOM Refs..."); signInButton = document.getElementById('signin-button'); signOutButton = document.getElementById('signout-button'); driveStatusElement = document.getElementById('drive-status'); themeToggleBtn = document.getElementById('theme-toggle-btn'); signInButtonPrompt = document.getElementById('signin-button-prompt'); connectionPrompt = document.getElementById('connection-prompt'); evolutionTrackerArea = document.getElementById('evolution-tracker-area'); overallEloDisplayValue = document.querySelector('#overall-elo-display .value'); levelBadgeContainer = document.getElementById('level-badge-container'); levelBadge = document.getElementById('level-badge'); if (levelBadge) { levelBadgeIcon = levelBadge.querySelector('i'); levelBadgeText = levelBadge.querySelector('span'); } targetEloInfoStrong = document.querySelector('#target-elo-info strong'); marvelTargetInfoSpan = document.querySelector('#marvel-target-info strong'); muscleGroupsContainer = document.getElementById('muscle-groups-container'); programConfigArea = document.getElementById('program-config-area'); programConfigContent = document.getElementById('program-config-content'); saveConfigButton = document.getElementById('save-config-button'); levelDetailsArea = document.getElementById('level-details-area'); levelDetailsContent = document.getElementById('level-details-content'); messageArea = document.getElementById('message-area'); levelInfoModal = document.getElementById('level-info-modal'); modalTitle = document.getElementById('modal-title'); modalIcon = document.getElementById('modal-icon'); modalLevelName = document.getElementById('modal-level-name'); modalBody = document.getElementById('modal-body'); modalCloseBtn = document.getElementById('modal-close-btn'); appNav = document.getElementById('app-nav'); navButtons = document.querySelectorAll('.nav-button'); appSections = document.querySelectorAll('.app-section'); const critical = [signInButton, signOutButton, themeToggleBtn, signInButtonPrompt, connectionPrompt, evolutionTrackerArea, overallEloDisplayValue, levelBadgeContainer, levelBadge, levelBadgeIcon, levelBadgeText, targetEloInfoStrong, marvelTargetInfoSpan, muscleGroupsContainer, programConfigArea, programConfigContent, saveConfigButton, levelDetailsArea, levelDetailsContent, messageArea, levelInfoModal, modalTitle, modalIcon, modalLevelName, modalBody, modalCloseBtn, appNav, navButtons, appSections]; if (critical.some(el => !el || (NodeList.prototype.isPrototypeOf(el) && el.length === 0))) { console.error("DOM CRITIQUES MANQUANTS!", critical); showMessage("Erreur critique: UI incomplète.", 10000, 'error'); document.body.innerHTML = '<p style="color:red; padding: 20px;">Erreur critique interface.</p>'; return false; } console.log("DOM Refs OK."); return true; }
    function addEventListeners() { if(signInButton) signInButton.addEventListener('click', handleAuthClick); if(signInButtonPrompt) signInButtonPrompt.addEventListener('click', handleAuthClick); if(signOutButton) signOutButton.addEventListener('click', () => handleSignoutClick(true)); if(themeToggleBtn) themeToggleBtn.addEventListener('click', toggleTheme); document.body.addEventListener('click', initAudioContext, { once: true }); document.body.addEventListener('keydown', initAudioContext, { once: true }); if (levelBadge) levelBadge.addEventListener('click', () => { const key = levelBadge.getAttribute('data-level-key'); if(key) openLevelInfoModal(key); }); if (modalCloseBtn) modalCloseBtn.addEventListener('click', closeLevelInfoModal); if (levelInfoModal) levelInfoModal.addEventListener('click', (event) => { if (event.target === levelInfoModal) closeLevelInfoModal(); }); if (muscleGroupsContainer) { muscleGroupsContainer.addEventListener('click', (event) => { const el = event.target.closest('.group-level-name'); if (el) { const key = el.getAttribute('data-level-key'); if (key) openLevelInfoModal(key); } }); } navButtons.forEach(button => { button.addEventListener('click', () => switchTab(button.dataset.section)); }); if (saveConfigButton) saveConfigButton.addEventListener('click', saveExerciseConfigToDrive); console.log("Écouteurs OK."); }

    // --- Point d'entrée ---
    document.addEventListener('DOMContentLoaded', () => { console.log("DOM Chargé. Init..."); try { if (!initializeDOMReferences()) return; addEventListeners(); loadSavedTheme(); updateAuthUI(false); resetEvolutionDisplay(); resetConfigUI(); resetLevelDetailsUI(); checkAndInitGis(); console.log("Init terminée. Attente API Google & utilisateur..."); } catch (error) { console.error("Erreur Init DOMContentLoaded:", error); showMessage("Erreur critique chargement.", 10000, 'error'); const b = document.querySelector('body'); if(b) b.innerHTML = '<p style="color:red; padding: 20px;">Erreur critique chargement. Voir console.</p>'; } });
</script>

</body>
</html>
