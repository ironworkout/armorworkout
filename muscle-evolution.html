<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArmorWorkout - Suivi Évolution Musculaire</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <!-- Chart.js (pour l'historique ELO) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script> <!-- Adapter pour les dates -->

    <style>
        /* --- Variables Globales & Thèmes (Identiques aux autres pages) --- */
        :root {
            /* Thème Sombre */
            --bg-color-dark: #0D1117; --secondary-bg-color-dark: #161B22; --primary-text-color-dark: #c9d1d9; --secondary-text-color-dark: #8b949e; --border-color-dark: #30363d; --accent-border-color-dark: #58a6ff33; --input-bg-dark: #0d1117;
            /* Couleurs Néon */
            --neon-blue: #58a6ff; --neon-pink: #f778ba; --neon-red: #ff7b72; --neon-yellow: #facc15; --neon-green: #3fb950; --neon-purple: #bc8cff; --neon-orange: #f9a825;
            /* Glows */
            --glow-blue: 0 0 12px rgba(88, 166, 255, 0.6); --glow-pink: 0 0 12px rgba(247, 120, 186, 0.6); --glow-red: 0 0 10px rgba(255, 123, 114, 0.6); --glow-yellow: 0 0 10px rgba(250, 204, 21, 0.5); --glow-green: 0 0 10px rgba(63, 185, 80, 0.6); --glow-purple: 0 0 12px rgba(188, 140, 255, 0.6); --glow-orange: 0 0 10px rgba(249, 168, 37, 0.6);
            /* Autres */
            --font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; --border-radius-lg: 12px; --border-radius-md: 8px; --border-radius-sm: 6px; --transition-speed: 0.25s;
            /* Défaut Sombre */
            --bg-color: var(--bg-color-dark); --secondary-bg-color: var(--secondary-bg-color-dark); --primary-text-color: var(--primary-text-color-dark); --secondary-text-color: var(--secondary-text-color-dark); --border-color: var(--border-color-dark); --accent-border-color: var(--accent-border-color-dark); --input-bg: var(--input-bg-dark);
             /* RGBA */
             --neon-blue-rgb: 88, 166, 255; --neon-pink-rgb: 247, 120, 186; --neon-red-rgb: 255, 123, 114; --neon-yellow-rgb: 250, 204, 21; --neon-green-rgb: 63, 185, 80; --neon-purple-rgb: 188, 140, 255; --neon-orange-rgb: 249, 168, 37;
            --secondary-text-color-dark-rgb: 139, 148, 158; --bg-color-dark-rgb: 13, 17, 23; --secondary-bg-color-dark-rgb: 22, 27, 34; --primary-text-color-dark-rgb: 201, 209, 217;
             --link-color: var(--neon-blue);
             --button-connect-color: var(--neon-green); --button-connect-glow: var(--glow-green); --button-disconnect-color: var(--neon-red); --button-disconnect-glow: var(--glow-red);
             /* Couleurs Progression */
             --progress-bar-bg: rgba(var(--primary-text-color-dark-rgb), 0.1);
             --progress-bar-fill: linear-gradient(90deg, var(--neon-blue), var(--neon-purple));
             --global-progress-bar-fill: linear-gradient(90deg, var(--neon-green), var(--neon-yellow)); /* Gradient pour barre globale */
        }
        body.light-theme {
            /* Thème Clair */
            --bg-color: #ffffff; --secondary-bg-color: #f6f8fa; --primary-text-color: #24292f; --secondary-text-color: #57606a; --border-color: #d0d7de; --accent-border-color: #0969da33; --input-bg: #f6f8fa;
            --neon-blue: #0969da; --neon-pink: #bf3989; --neon-red: #d73a49; --neon-yellow: #dbab09; --neon-green: #2da44e; --neon-purple: #8250df; --neon-orange: #f66a0a;
            --glow-blue: 0 0 8px rgba(9, 105, 218, 0.3); --glow-pink: 0 0 8px rgba(191, 57, 137, 0.3); --glow-red: 0 0 8px rgba(215, 58, 73, 0.3); --glow-yellow: 0 0 8px rgba(219, 171, 9, 0.3); --glow-green: 0 0 8px rgba(45, 164, 78, 0.3); --glow-purple: 0 0 8px rgba(130, 80, 223, 0.3); --glow-orange: 0 0 8px rgba(246, 106, 10, 0.3);
             --link-color: #0969da;
            --bg-color-dark-rgb: 255, 255, 255; --secondary-bg-color-dark-rgb: 246, 248, 250; --primary-text-color-dark-rgb: 36, 41, 47; --secondary-text-color-dark-rgb: 87, 96, 106;
             --neon-orange-rgb: 246, 106, 10;
             --progress-bar-bg: #e1e4e8;
             --secondary-bg-color-dark-rgb: 246, 248, 250; /* MAJ pour thème clair message area */
        }

        /* --- Styles de Base & Réinitialisation --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; font-size: 16px; }
        body { font-family: var(--font-family); background-color: var(--bg-color); color: var(--primary-text-color); line-height: 1.6; transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease; display: flex; flex-direction: column; min-height: 100vh; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; overflow-x: hidden; }
        .container { max-width: 950px; margin: 0 auto; padding: 30px 20px; width: 100%; flex-grow: 1; display: flex; flex-direction: column; }

        /* --- En-tête --- */
        header { padding: 15px 0; border-bottom: 1px solid var(--border-color); transition: border-color var(--transition-speed) ease, background-color var(--transition-speed) ease; position: sticky; top: 0; z-index: 1000; background-color: rgba(var(--bg-color-dark-rgb), 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1100px; margin: 0 auto; padding: 0 25px; flex-wrap: wrap; gap: 15px 20px; }
        header h1 { font-size: 1.5em; color: var(--primary-text-color); margin: 0; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        header h1 i { color: var(--neon-blue); animation: pulse 2s infinite ease-in-out; }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.1); opacity: 1; } }
        .header-link { color: var(--secondary-text-color); font-size: 0.9em; text-decoration: none; display: inline-flex; align-items: center; gap: 5px; transition: color var(--transition-speed) ease; }
        .header-link:hover { color: var(--link-color); }
        .header-actions { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
        .auth-controls { display: flex; gap: 10px; align-items: center; }
        .auth-controls button { background: none; border: 1px solid var(--accent-border-color); color: var(--secondary-text-color); padding: 6px 14px; border-radius: var(--border-radius-md); font-size: 0.85em; font-weight: 500; cursor: pointer; transition: all var(--transition-speed) ease; display: inline-flex; align-items: center; gap: 6px; }
        .auth-controls button:disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; border-color: var(--border-color) !important; color: var(--secondary-text-color) !important; box-shadow: none !important; background-color: transparent !important; }
        .auth-controls button:not(:disabled):hover { border-color: var(--primary-text-color); color: var(--primary-text-color); }
        #signin-button { border-color: var(--button-connect-color); color: var(--button-connect-color); }
        #signin-button:not(:disabled):hover { background-color: rgba(var(--neon-green-rgb), 0.1); box-shadow: var(--glow-green); border-color: var(--neon-green); }
        #signout-button { border-color: var(--button-disconnect-color); color: var(--button-disconnect-color); }
        #signout-button:not(:disabled):hover { background-color: rgba(var(--neon-red-rgb), 0.1); box-shadow: var(--glow-red); border-color: var(--neon-red); }
        #drive-status { font-size: 0.8em; color: var(--secondary-text-color); margin-left: 5px; transition: opacity 0.3s, color 0.3s, border-color 0.3s; min-width: fit-content; text-align: right; font-style: normal; padding: 4px 8px; background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.5); border-radius: var(--border-radius-sm); border: 1px solid var(--border-color); display: none; }
        #drive-status.loading { color: var(--neon-yellow); border-color: var(--neon-yellow); animation: blink-border 1.5s infinite ease-in-out; }
        #drive-status.error { color: var(--neon-red); border-color: var(--neon-red); }
        #drive-status.success { color: var(--neon-green); border-color: var(--neon-green); }
        @keyframes blink-border { 50% { border-color: rgba(var(--neon-yellow-rgb), 0.4); } }
        .theme-toggle button { background: none; border: none; color: var(--secondary-text-color); font-size: 1.2em; padding: 5px; cursor: pointer; transition: color var(--transition-speed) ease; }
        .theme-toggle button:hover { color: var(--neon-yellow); }
        body.logged-out #signin-button { display: inline-flex; } body.logged-out #signout-button { display: none; } body.logged-out #drive-status { display: none; }
        body.logged-in #signin-button { display: none; } body.logged-in #signout-button { display: inline-flex; } body.logged-in #drive-status { display: inline-block; }

        /* --- Contenu Principal --- */
        main { flex-grow: 1; display: flex; flex-direction: column; align-items: center; padding-top: 40px; }
        main h2 { font-size: 1.6em; font-weight: 700; margin-bottom: 15px; text-align: center; color: var(--primary-text-color); display: flex; align-items: center; gap: 10px; justify-content: center;}
        main h2 i { color: var(--neon-purple); }

        /* Message si non connecté */
        #connection-prompt { text-align: center; padding: 40px 20px; background-color: var(--secondary-bg-color); border-radius: var(--border-radius-lg); border: 1px dashed var(--border-color); margin: 20px auto; max-width: 600px; }
        #connection-prompt p { margin-bottom: 15px; color: var(--secondary-text-color); }
        #connection-prompt button { border-color: var(--button-connect-color); color: var(--button-connect-color); background: transparent; padding: 8px 18px; border: 1px solid; border-radius: var(--border-radius-md); font-size: 0.9em; font-weight: 500; cursor: pointer; transition: all var(--transition-speed) ease; display: inline-flex; align-items: center; gap: 6px; }
        #connection-prompt button:disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; border-color: var(--border-color) !important; color: var(--secondary-text-color) !important; box-shadow: none !important; background-color: transparent !important; }
        #connection-prompt button:not(:disabled):hover { background-color: rgba(var(--neon-green-rgb), 0.1); box-shadow: var(--glow-green); border-color: var(--neon-green); }

        /* Zone principale d'affichage */
        #evolution-tracker-area { width: 100%; background-color: var(--secondary-bg-color); border-radius: var(--border-radius-lg); border: 1px solid var(--border-color); padding: 30px 25px; display: none; flex-direction: column; gap: 35px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); margin-top: 20px; }
        body.logged-in #evolution-tracker-area { display: flex; }

        /* Affichage ELO Global et Objectif */
        .global-stats { text-align: center; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        #overall-elo-display { font-size: 2.2em; font-weight: 900; color: var(--neon-purple); margin-bottom: 5px; line-height: 1.1;}
        #overall-elo-display span { font-size: 0.5em; font-weight: 500; color: var(--secondary-text-color); display: block; }
        #goal-info { font-size: 1.1em; color: var(--primary-text-color); font-weight: 500; margin-top: 10px; }
        #goal-info .target-level { color: var(--neon-green); font-weight: 700; }
        #goal-info .target-elo-value { font-weight: 700; }
        /* Placeholder pour sélecteur d'objectif (stylisé comme du texte normal pour l'instant) */
        #goal-selector-container { font-size: 0.9em; margin-top: 8px; color: var(--secondary-text-color);}
        #goal-selector-container label { margin-right: 5px;}
        #goal-selector { background-color: var(--input-bg); color: var(--primary-text-color); border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); padding: 3px 6px; font-size: 0.9em;}
        #goal-description { font-size: 0.9em; color: var(--secondary-text-color); font-style: italic; margin-top: 8px; max-width: 600px; margin-left: auto; margin-right: auto; line-height: 1.5; }

        /* Conteneur des catégories et groupes */
        #muscle-groups-container { display: flex; flex-direction: column; gap: 30px; }
        .muscle-category { }
        .muscle-category-header { font-size: 1.3em; font-weight: 700; color: var(--neon-orange); margin-bottom: 15px; padding-bottom: 5px; border-bottom: 2px solid var(--neon-orange); display: inline-block; }
        .muscle-group-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }

        /* Carte pour un groupe musculaire */
        .muscle-group-card { background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: var(--border-radius-md); padding: 20px; display: flex; flex-direction: column; gap: 12px; transition: all var(--transition-speed) ease; cursor: pointer; /* Pour indiquer qu'elle est cliquable */ }
        .muscle-group-card:hover { border-color: var(--accent-border-color); box-shadow: 0 4px 15px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .muscle-group-header { display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 5px; }
        .muscle-group-header i { font-size: 1.4em; width: 25px; text-align: center; color: var(--neon-blue); }
        .muscle-group-title { font-size: 1.15em; font-weight: 700; color: var(--primary-text-color); }
        .elo-info { display: flex; justify-content: space-between; align-items: baseline; font-size: 0.9em; color: var(--secondary-text-color); }
        .current-elo { font-weight: 700; font-size: 1.1em; color: var(--neon-purple); }
        .target-elo { font-weight: 500; }
        .target-elo strong { color: var(--neon-green); }

        /* Barre de progression */
        .progress-bar-container { width: 100%; height: 12px; background-color: var(--progress-bar-bg); border-radius: 6px; overflow: hidden; margin-top: 5px; border: 1px solid var(--border-color); }
        .progress-bar { height: 100%; width: 0%; background: var(--progress-bar-fill); border-radius: 6px; transition: width 0.5s ease-out; position: relative; display: flex; align-items: center; justify-content: flex-end; overflow: hidden; }
        .progress-bar::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0) 100%); opacity: 0.5; }
        .progress-percentage { font-size: 0.8em; font-weight: 700; color: white; margin-right: 8px; text-shadow: 0 0 3px rgba(0,0,0,0.5); z-index: 1; line-height: 12px; opacity: 0; transition: opacity 0.3s ease; }
         .progress-bar:not([style*="width: 0%"]) .progress-percentage { opacity: 1; }

        /* Barre Globale "Objectif Marvel" */
        .global-goal-progress { margin-top: 40px; padding: 20px; background-color: rgba(var(--bg-color-dark-rgb), 0.1); border: 1px solid var(--border-color); border-radius: var(--border-radius-md); }
        .global-goal-progress h3 { font-size: 1.2em; font-weight: 700; color: var(--primary-text-color); margin-bottom: 15px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .global-goal-progress h3 i { color: var(--neon-green); }
        .global-progress-bar-container { width: 100%; height: 18px; background-color: var(--progress-bar-bg); border-radius: 9px; overflow: hidden; border: 1px solid var(--border-color); }
        .global-progress-bar { height: 100%; width: 0%; background: var(--global-progress-bar-fill); border-radius: 9px; transition: width 0.8s ease-out; display: flex; align-items: center; justify-content: center; }
        .global-progress-percentage { font-size: 0.9em; font-weight: 700; color: rgba(0,0,0,0.7); text-shadow: 0 0 2px rgba(255,255,255,0.5); z-index: 1; line-height: 18px; opacity: 0; transition: opacity 0.5s ease; }
         .global-progress-bar:not([style*="width: 0%"]) .global-progress-percentage { opacity: 1; }

        /* --- Historique ELO (Graphique) --- */
        #history-chart-container { margin-top: 40px; padding: 25px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: var(--border-radius-md); }
        #history-chart-container h3 { font-size: 1.2em; font-weight: 700; color: var(--primary-text-color); margin-bottom: 20px; text-align: center; display: flex; align-items: center; justify-content: center; gap: 8px; }
        #history-chart-container h3 i { color: var(--neon-yellow); }
        #elo-history-chart { max-height: 350px; width: 100% !important; } /* Important pour forcer la largeur */

        /* --- Modale Détails Exercice --- */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { background-color: var(--secondary-bg-color); margin: 10% auto; padding: 25px 30px; border: 1px solid var(--border-color); border-radius: var(--border-radius-lg); width: 80%; max-width: 650px; position: relative; box-shadow: 0 5px 20px rgba(0,0,0,0.2); animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-close-button { color: var(--secondary-text-color); position: absolute; top: 15px; right: 20px; font-size: 1.8em; font-weight: bold; cursor: pointer; transition: color var(--transition-speed); }
        .modal-close-button:hover, .modal-close-button:focus { color: var(--primary-text-color); text-decoration: none; }
        .modal h4 { font-size: 1.4em; color: var(--neon-blue); margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; }
        .modal-exercise-list { list-style: none; padding: 0; max-height: 40vh; overflow-y: auto; }
        .modal-exercise-list li { background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: var(--border-radius-md); padding: 12px 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; font-size: 0.95em; }
        .modal-exercise-list .exercise-name { font-weight: 600; color: var(--primary-text-color); flex-basis: 50%; }
        .modal-exercise-list .exercise-details { font-size: 0.9em; color: var(--secondary-text-color); text-align: right; flex-basis: 45%; }
        .modal-exercise-list .exercise-elo { font-weight: 700; color: var(--neon-purple); }

        /* --- Zone de Messages Flottante --- */
        .message-area { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.9); color: var(--primary-text-color); border: 1px solid var(--border-color); padding: 12px 25px; border-radius: var(--border-radius-md); z-index: 3000; opacity: 0; transition: opacity 0.5s ease, transform 0.5s ease, bottom 0.5s ease, background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; pointer-events: none; font-size: 0.95em; box-shadow: 0 4px 15px rgba(0,0,0,0.2); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); max-width: 90%; text-align: center; }
        .message-area.visible { opacity: 1; transform: translate(-50%, 0); bottom: 40px; pointer-events: auto; }
        .message-area.error { background-color: var(--neon-red); color: #fff; border-color: var(--neon-red); }
        .message-area.success { background-color: var(--neon-green); color: #fff; border-color: var(--neon-green); }

        /* --- Pied de Page --- */
        footer { color: var(--secondary-text-color); opacity: 0.7; border-top: 1px solid var(--border-color); margin-top: 60px; padding: 25px; text-align: center; transition: border-color var(--transition-speed) ease, color var(--transition-speed) ease; }
        footer a { color: var(--link-color); text-decoration: none; transition: color var(--transition-speed) ease; }
        footer a:hover { color: var(--primary-text-color); text-decoration: underline; }
        footer .fab.fa-google-drive { color: #4CAF50; }

        /* --- Responsive --- */
        @media (max-width: 768px) {
            .container { padding: 20px 15px; }
            main h2 { font-size: 1.4em; }
            .global-stats { margin-bottom: 15px; padding-bottom: 15px; }
            #overall-elo-display { font-size: 1.8em; }
            #goal-info { font-size: 1em; }
            .muscle-category-header { font-size: 1.2em; }
            .muscle-group-grid { grid-template-columns: 1fr; gap: 15px; }
            .muscle-group-card { padding: 15px; }
            .muscle-group-title { font-size: 1.1em; }
            .global-goal-progress h3 {font-size: 1.1em;}
            #history-chart-container h3 { font-size: 1.1em; }
            .modal-content { width: 90%; margin: 15% auto; }
        }
        @media (max-width: 480px) {
            .header-content { padding: 0 15px; }
            .header-actions { gap: 10px; }
            .auth-controls button { padding: 5px 10px; font-size: 0.8em; }
            main h2 { font-size: 1.3em; }
            #overall-elo-display { font-size: 1.6em; }
            #goal-info { font-size: 0.95em; }
            #goal-description { font-size: 0.85em; }
            .global-goal-progress h3 {font-size: 1em;}
            .global-progress-bar-container {height: 16px;}
            .global-progress-percentage{font-size: 0.8em;}
            #history-chart-container h3 { font-size: 1em; }
            .modal-content { margin: 20% auto; }
            .modal-exercise-list .exercise-name { flex-basis: 100%; }
            .modal-exercise-list .exercise-details { flex-basis: 100%; text-align: left; margin-top: 5px;}
        }

    </style>
</head>
<body class="logged-out dark-theme">

<header>
    <div class="header-content">
         <div>
             <a href="timer.html" class="header-link" style="margin-right: 15px;"><i class="fas fa-stopwatch"></i> Timer</a>
             <a href="program-editor.html" class="header-link"><i class="fas fa-edit"></i> Éditeur</a>
         </div>
        <h1><i class="fas fa-shield-halved"></i> ArmorWorkout</h1>
        <div class="header-actions">
            <div class="auth-controls">
                <button id="signin-button" disabled><i class="fab fa-google"></i> Connecter Drive</button>
                <button id="signout-button" disabled><i class="fas fa-sign-out-alt"></i> Déconnecter</button>
            </div>
            <span id="drive-status"></span>
            <div class="theme-toggle">
                <button id="theme-toggle-btn" aria-label="Basculer le thème"><i class="fas fa-sun"></i></button>
            </div>
        </div>
    </div>
</header>

<div class="container">
    <main>
        <h2><i class="fas fa-chart-line"></i> Suivi d'Évolution</h2>

        <div id="connection-prompt">
            <p>Connectez-vous à Google Drive pour analyser vos programmes, suivre votre évolution et voir votre historique.</p>
            <button id="signin-button-prompt" disabled><i class="fab fa-google"></i> Connecter Drive</button>
        </div>

        <div id="evolution-tracker-area">
            <div class="global-stats">
                <div id="overall-elo-display">
                    -- <span>ELO Moyen (Haut du Corps)</span>
                </div>
                <div id="goal-info">
                    Objectif Actuel : <span class="target-level">Chargement...</span> (ELO Cible Groupe <span class="target-elo-value">--</span>)
                </div>
                 <!-- Placeholder pour sélection d'objectif future -->
                 <div id="goal-selector-container" style="display: none;"> <!-- Caché pour l'instant -->
                     <label for="goal-selector">Choisir objectif:</label>
                     <select id="goal-selector">
                         <!-- Options chargées par JS -->
                     </select>
                 </div>
                <div id="goal-description">
                    <!-- Description chargée par JS -->
                </div>
            </div>

            <div id="muscle-groups-container">
                <!-- Catégories et cartes générées par JS -->
                 <p style="text-align: center; color: var(--secondary-text-color); grid-column: 1 / -1;">Chargement des données...</p>
            </div>

             <!-- Section Barre de Progression Globale -->
             <div class="global-goal-progress" id="global-goal-progress-section">
                 <h3><i class="fas fa-bullseye"></i> Progression vers Objectif "<span id="final-goal-name">Tom Holland</span>"</h3>
                 <div class="global-progress-bar-container" aria-label="Progression globale vers l'objectif final">
                     <div class="global-progress-bar" id="global-progress-bar" style="width: 0%;" role="progressbar" aria-valuenow="0" aria-valuemin="800" aria-valuemax="1150">
                         <span class="global-progress-percentage" id="global-progress-percentage">0%</span>
                     </div>
                 </div>
             </div>

             <!-- Section Historique ELO -->
             <div id="history-chart-container" style="display: none;"> <!-- Caché initialement -->
                <h3><i class="fas fa-timeline"></i> Historique ELO Global</h3>
                <canvas id="elo-history-chart"></canvas>
                <p id="history-loading-msg" style="text-align: center; color: var(--secondary-text-color); margin-top: 15px;">Chargement de l'historique...</p>
             </div>

        </div>

    </main>
</div>

<!-- Modale Détails Exercice -->
<div id="exercise-detail-modal" class="modal">
    <div class="modal-content">
        <span class="modal-close-button" id="modal-close-btn">×</span>
        <h4 id="modal-title">Détails Groupe Musculaire</h4>
        <ul id="modal-exercise-list" class="modal-exercise-list">
            <!-- Contenu généré par JS -->
            <li>Chargement...</li>
        </ul>
    </div>
</div>


<footer>
    <p>© 2024 ArmorWorkout Evolution Tracker. Analyse basée sur vos programmes Drive.</p>
     <p><a href="timer.html">Timer</a> | <a href="program-editor.html">Éditeur</a> | <a href="https://github.com/ironworkout/armorworkout" target="_blank" rel="noopener noreferrer"><i class="fab fa-github" aria-hidden="true"></i> GitHub</a></p>
</footer>

<!-- Zone de Message Flottante -->
<div id="message-area" class="message-area" role="status" aria-live="polite"></div>

<!-- Google Identity Services Script -->
<script async defer src="https://accounts.google.com/gsi/client"></script>

<script>
    // --- CONFIGURATION & CONSTANTES ---
    const GOOGLE_CLIENT_ID = "731283926358-viam3ulpgna14flfdeb9m92l8s620hoi.apps.googleusercontent.com";
    const GOOGLE_DRIVE_SCOPES = 'https://www.googleapis.com/auth/drive.file'; // Garder .file pour créer/modifier historique
    const PROGRAM_FILENAMES = { Push: "armorworkout_push_program.json", Pull: "armorworkout_pull_program.json", Legs: "armorworkout_legs_program.json" };
    const ELO_HISTORY_FILENAME = "armorworkout_elo_history.json"; // Nouveau fichier pour l'historique
    const PROGRAM_TYPES = ['Push', 'Pull', 'Legs'];
    const GIS_CHECK_INTERVAL = 100;
    const GIS_MAX_RETRIES = 50;
    const MAX_HISTORY_ENTRIES = 100; // Limiter la taille de l'historique

    // --- ELO PARAMETERS & TARGETS ---
    const ELO_BASE = 800;
    const INTENSITY_TECHNIQUE_BONUS_MULTIPLIER = 1.05; // +5% ELO bonus
    const POLYARTICULAR_WEIGHT = 1.2; // Poids pour exos polyarticulaires
    const ISOLATION_WEIGHT = 1.0;     // Poids pour exos d'isolation
    const DURATION_ELO_FACTOR = 1.5; // Facteur pour ELO basé sur durée (ex: ELO = BASE + duration * FACTOR) - À AJUSTER
    const RESISTANCE_BONUS = { // Clés triées par longueur DESC pour meilleure correspondance
        'Élastique 15+25kg + 2x5kg haltères': 250,
        'Élastique 15+25kg + 1 haltère 5kg': 225,
        'Élastique 15+25kg': 200,
        'Élastique 25kg': 125,
        'Élastique 15kg doublé': 100,
        'Élastique 15kg': 50,
        'Haltères 5kg': 50, // Attention si utilisé avec élastiques, la clé plus longue primera
        'Bodyweight': 75,
    };
    const REPS_FACTORS = { 8: 0.8, 12: 1.0, 18: 1.2, 25: 1.3, Infinity: 1.4 }; // Ajout seuil 8 reps
    const TARGET_ELO_LEVELS = { // Structure prête pour plus de niveaux / personnalisation
        'L1_MaxReps': { name: "Solide via Reps 💪", targetELO: 950, description: "Niveau solide atteignable en maximisant les répétitions avec l'équipement actuel. Physique athlétique visible, bonne endurance musculaire.", groups: { Pectoraux: 900, Dos: 920, Épaules: 865, Biceps: 940, Triceps: 865, Core: 880, Legs: 900 } }, // Ajout Legs
        'L2_TomHolland': { name: "Athlétique Avancé / Tom Holland Style 🕷️", targetELO: 1150, description: "Niveau avancé style 'acteur film d'action'. Nécessite l'application des techniques de progression (combinaison d'élastiques, pompes lestées...). Muscles plus développés, meilleure définition (avec diète adaptée).", groups: { Pectoraux: 1150, Dos: 1150, Épaules: 1150, Biceps: 1100, Triceps: 1100, Core: 950, Legs: 1100 } } // Ajout Legs
        // Potentiellement L3_CaptainAmerica etc.
    };
    const FINAL_TARGET_LEVEL_KEY = 'L2_TomHolland'; // Clé du niveau visé par la barre globale
    const FINAL_TARGET_ELO = TARGET_ELO_LEVELS[FINAL_TARGET_LEVEL_KEY].targetELO || 1150; // Cible finale pour la barre globale
    const MUSCLE_GROUPS_DISPLAY_ORDER = { // Ajout catégorie Jambes
        "Torse": ["Pectoraux", "Dos"],
        "Épaules": ["Épaules"],
        "Bras": ["Biceps", "Triceps"],
        "Core": ["Core"],
        "Jambes": ["Legs"] // Nouvelle catégorie
    };
    const MUSCLE_GROUP_ICONS = { // Ajout icône Jambes
        Pectoraux: 'fa-heart-pulse', Dos: 'fa-circle-nodes', Épaules: 'fa-person-burst',
        Biceps: 'fa-dumbbell', Triceps: 'fa-hand-back-fist', Core: 'fa-fire',
        Legs: 'fa-person-walking' // Nouvelle icône
    };

    // --- Éléments DOM ---
    let signInButton, signOutButton, driveStatusElement, themeToggleBtn,
        signInButtonPrompt, connectionPrompt, evolutionTrackerArea,
        overallEloDisplay, goalInfo, goalDescriptionElement, goalSelectorContainer, goalSelector,
        muscleGroupsContainer, messageArea,
        globalProgressBar, globalProgressPercentage, finalGoalNameSpan,
        historyChartContainer, eloHistoryChartCanvas, historyLoadingMsg,
        exerciseDetailModal, modalCloseBtn, modalTitle, modalExerciseList;

    // --- Variables d'État ---
    let googleAccessToken = null; let tokenClient = null;
    let programFileIds = { Push: null, Pull: null, Legs: null };
    let eloHistoryFileId = null; // ID du fichier d'historique
    let loadedPrograms = { Push: [], Pull: [], Legs: [] }; let programsLoaded = false;
    let eloHistoryData = []; // Stockage de l'historique [{timestamp, eloValues, overallAvgELO}, ...]
    let currentELOValues = {}; let overallAvgELO = 0; let currentGoalLevelKey = 'L1_MaxReps';
    let exerciseDetailsPerGroup = {}; // Stocke les détails des exos pour la modale: { Pectoraux: [{name, sets, reps, equipment, elo}, ...], ...}
    let currentTheme = 'dark'; let messageTimeoutId = null; let gisCheckRetries = 0;
    let historyChart = null; // Instance Chart.js

    // --- Audio ---
    let audioContext = null;
    function initAudioContext() { if (!audioContext && typeof AudioContext !== 'undefined') { try { audioContext = new AudioContext(); } catch (e) { console.warn("AudioContext non supporté ou bloqué.", e); } } }

    // --- Google Identity Services & Drive API ---
    async function gisInitInternal() { /* ... (Identique, mais vérifie le scope .file) ... */ console.log(">>> gisInitInternal appelée (Evolution v2)... Scope demandé:", GOOGLE_DRIVE_SCOPES); const clientIdValid = GOOGLE_CLIENT_ID && !GOOGLE_CLIENT_ID.includes("YOUR_CLIENT_ID"); if (!clientIdValid) { console.error("CRITICAL: GOOGLE_CLIENT_ID non configuré !"); showMessage("Erreur critique : ID Client Google manquant.", 10000, true); if(signInButton) signInButton.disabled = true; if(signInButtonPrompt) signInButtonPrompt.disabled = true; return; } if (!google || !google.accounts || !google.accounts.oauth2) { console.error("L'API Google Identity Services n'a pas été correctement chargée ou initialisée (Evolution v2)."); showMessage("Erreur chargement API Google.", 6000, true); if(signInButton) signInButton.disabled = true; if(signInButtonPrompt) signInButtonPrompt.disabled = true; return; } try { console.log("Tentative d'initialisation de initTokenClient (Evolution v2)..."); tokenClient = google.accounts.oauth2.initTokenClient({ client_id: GOOGLE_CLIENT_ID, scope: GOOGLE_DRIVE_SCOPES, callback: tokenCallback, error_callback: handleTokenError, prompt: '' }); console.log("Token Client Google initialisé avec succès (Evolution v2)."); if (signInButton) signInButton.disabled = false; if (signInButtonPrompt) signInButtonPrompt.disabled = false; } catch (error) { console.error("Erreur lors de l'appel à google.accounts.oauth2.initTokenClient (Evolution v2):", error); showMessage("Erreur initialisation services Google.", 5000, true); updateAuthUI(false); if (driveStatusElement) { driveStatusElement.textContent = 'Erreur Init Auth'; driveStatusElement.classList.remove('loading', 'success'); driveStatusElement.classList.add('error'); driveStatusElement.style.display = 'inline-block'; } if(signInButton) signInButton.disabled = true; if(signInButtonPrompt) signInButtonPrompt.disabled = true; } console.log(">>> gisInitInternal (Evolution v2) - Fin d'exécution"); }
    function checkAndInitGis() { /* ... (Identique) ... */ console.log(`Vérification GIS (Evolution v2 - Essai ${gisCheckRetries + 1}/${GIS_MAX_RETRIES})...`); if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2 && typeof google.accounts.oauth2.initTokenClient === 'function') { console.log("API Google OAuth2 détectée (Evolution v2)! Lancement de gisInitInternal."); gisInitInternal(); } else if (gisCheckRetries < GIS_MAX_RETRIES) { gisCheckRetries++; setTimeout(checkAndInitGis, GIS_CHECK_INTERVAL); } else { console.error(`Échec de la détection de l'API Google (Evolution v2) après ${GIS_MAX_RETRIES} essais.`); showMessage("Impossible de charger les services Google. Vérifiez votre connexion ou bloqueur de script.", 10000, true); if(signInButton) signInButton.disabled = true; if(signInButtonPrompt) signInButtonPrompt.disabled = true; } }
    function handleTokenError(error) { /* ... (Identique) ... */ console.error("Erreur Google Token Client (Evolution v2):", error); let userMessage = `Erreur Auth Google: ${error.type || error.error || 'Inconnue'}`; let statusText = 'Erreur Auth'; if (driveStatusElement) { driveStatusElement.classList.remove('loading', 'success'); driveStatusElement.classList.add('error'); driveStatusElement.style.display = 'inline-block'; } if (error.error === 'popup_closed_by_user' || error.error === 'user_cancel' || error.type === 'popup_closed') { userMessage = "Connexion Google annulée."; statusText = 'Annulé'; } else if (error.error === 'popup_failed_to_open' || error.type === 'popup_failed_to_open') { userMessage = "Pop-up Google bloquée."; statusText = 'Popup Bloqué'; } else if (error.error === 'access_denied' || error.type === 'access_denied') { userMessage = "Accès Drive refusé."; statusText = 'Accès Refusé'; } else if (error.error === 'token_network_error') { userMessage = "Erreur réseau lors de l'auth."; statusText = 'Erreur Réseau'; } else if (error.error === 'invalid_grant') { userMessage = "Autorisation invalide."; statusText = 'Autorisation Invalide'; googleAccessToken = null; } showMessage(userMessage, 6000, true); if (driveStatusElement) driveStatusElement.textContent = statusText; updateAuthUI(false); }
    async function tokenCallback(tokenResponse) { /* MAJ pour charger aussi l'historique */ if (driveStatusElement) { driveStatusElement.classList.remove('loading', 'error', 'success'); driveStatusElement.style.display = 'inline-block'; } if (tokenResponse.error) { handleTokenError(tokenResponse); return; } if (tokenResponse && tokenResponse.access_token) { console.log("Access Token reçu (Evolution v2)."); googleAccessToken = tokenResponse.access_token; showMessage("Connecté ! Analyse des données...", 2500, false, 'success'); if (driveStatusElement) { driveStatusElement.textContent = 'Chargement...'; driveStatusElement.classList.add('loading'); } if (muscleGroupsContainer) muscleGroupsContainer.innerHTML = '<p style="text-align: center; color: var(--secondary-text-color); grid-column: 1 / -1;">Analyse des programmes et de l\'historique en cours...</p>'; if(historyChartContainer) historyChartContainer.style.display = 'block'; if(historyLoadingMsg) historyLoadingMsg.textContent = 'Chargement de l\'historique...'; if(historyChart) historyChart.destroy(); historyChart = null; try { const programsOk = await loadProgramsFromDrive(); const historyOk = await loadEloHistory(); programsLoaded = programsOk; // historyOk n'empêche pas l'affichage principal if (programsLoaded) { showMessage("Programmes analysés. Calcul ELO...", 2000); calculateAndDisplayEvolution(); // Ceci déclenchera aussi saveCurrentEloToHistory if (historyOk && eloHistoryData.length > 0) { displayEloHistoryChart(); showMessage("Programmes et historique chargés.", 3000, false, 'success'); if(historyLoadingMsg) historyLoadingMsg.style.display = 'none'; } else if (historyOk) { showMessage("Programmes chargés. Historique vide.", 3000); if(historyLoadingMsg) historyLoadingMsg.textContent = 'Aucun historique trouvé. Il sera créé après cette analyse.'; } else { showMessage("Programmes chargés. Erreur chargement historique.", 4000, true); if(historyLoadingMsg) historyLoadingMsg.textContent = 'Erreur chargement historique.'; } if (driveStatusElement) { driveStatusElement.textContent = 'Connecté'; driveStatusElement.classList.remove('loading', 'error'); driveStatusElement.classList.add('success'); } } else { showMessage("Erreur chargement programmes. Impossible d'analyser l'évolution.", 5000, true); if (driveStatusElement) { driveStatusElement.textContent = 'Erreur Progs'; driveStatusElement.classList.remove('loading'); driveStatusElement.classList.add('error'); } if (muscleGroupsContainer) muscleGroupsContainer.innerHTML = '<p style="text-align: center; color: var(--secondary-text-color); grid-column: 1 / -1;">Impossible de charger les programmes depuis Drive.</p>'; if(historyChartContainer) historyChartContainer.style.display = 'none'; } } catch (error) { console.error("Erreur CRITIQUE pendant le chargement/analyse (Evolution v2):", error); showMessage("Erreur majeure lors de l'analyse des données.", 6000, true); if (driveStatusElement) { driveStatusElement.textContent = 'Erreur Analyse'; driveStatusElement.classList.remove('loading', 'success'); driveStatusElement.classList.add('error'); } programsLoaded = false; if (muscleGroupsContainer) muscleGroupsContainer.innerHTML = '<p style="text-align: center; color: var(--secondary-text-color); grid-column: 1 / -1;">Erreur lors de l\'analyse des programmes.</p>'; if(historyChartContainer) historyChartContainer.style.display = 'none'; } finally { updateAuthUI(true); } } else { handleTokenError({ error: "invalid_response", details: "Réponse inattendue du serveur Google (Evolution v2)." }); } }
    function handleAuthClick() { /* ... (Identique) ... */ initAudioContext(); if (!tokenClient) { showMessage("Services Google non prêts...", 3000); console.warn("Tentative de connexion avant init tokenClient (Evolution v2)."); if (!GOOGLE_CLIENT_ID || GOOGLE_CLIENT_ID.includes("YOUR_CLIENT_ID")) { showMessage("Erreur critique : ID Client Google manquant.", 8000, true); } return; } if (driveStatusElement) { driveStatusElement.textContent = 'Connexion...'; driveStatusElement.classList.add('loading'); driveStatusElement.classList.remove('error', 'success'); driveStatusElement.style.display = 'inline-block'; } tokenClient.requestAccessToken({ prompt: 'consent' }); }
    function handleSignoutClick(showMessages = true) { /* MAJ pour reset history aussi */ const token = googleAccessToken; if (!token) { console.log("Déjà déconnecté (Evolution v2)."); updateAuthUI(false); return; } if (showMessages && driveStatusElement) { driveStatusElement.textContent = 'Déconnexion...'; driveStatusElement.classList.add('loading'); driveStatusElement.style.display = 'inline-block'; } google.accounts.oauth2.revoke(token, () => { console.log('Token Google révoqué (Evolution v2).'); googleAccessToken = null; programFileIds = { Push: null, Pull: null, Legs: null }; eloHistoryFileId = null; programsLoaded = false; loadedPrograms = { Push: [], Pull: [], Legs: [] }; eloHistoryData = []; currentELOValues = {}; overallAvgELO = 0; exerciseDetailsPerGroup = {}; currentGoalLevelKey = 'L1_MaxReps'; if (historyChart) { historyChart.destroy(); historyChart = null; } if (showMessages) { showMessage("Déconnecté de Google Drive.", 3000); } if (driveStatusElement) { driveStatusElement.textContent = ''; driveStatusElement.style.display = 'none'; } // Reset UI elements if (muscleGroupsContainer) muscleGroupsContainer.innerHTML = ''; if (overallEloDisplay) overallEloDisplay.innerHTML = '-- <span>ELO Moyen (Haut du Corps)</span>'; if (goalInfo) goalInfo.innerHTML = 'Objectif Actuel : <span class="target-level">N/A</span> (ELO <span class="target-elo-value">--</span>)'; if(goalDescriptionElement) goalDescriptionElement.textContent = ''; if(globalProgressBar) globalProgressBar.style.width = '0%'; if(globalProgressPercentage) globalProgressPercentage.textContent = '0%'; if(historyChartContainer) historyChartContainer.style.display = 'none'; updateAuthUI(false); }); }
    async function findOrCreateFile(filename, defaultContent = "[]", mimeType = 'application/json') { /* MAJ pour écrire contenu si création */ console.log(`Drive (Evolution v2): Recherche/Création de ${filename}`); if (!googleAccessToken) { console.warn(`findOrCreateFile (${filename}): Pas de token Google.`); return null; } const searchUrl = `https://www.googleapis.com/drive/v3/files?q=name='${encodeURIComponent(filename)}'+and+trashed=false&spaces=drive&fields=files(id,name)`; try { const searchRes = await fetch(searchUrl, { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }); if (!searchRes.ok) { if (searchRes.status === 401 || searchRes.status === 403) { console.warn(`findOrCreateFile(${filename}): Erreur d'autorisation (${searchRes.status}). Déconnexion.`); handleSignoutClick(false); showMessage("Session Google expirée ou accès refusé. Reconnectez-vous.", 5000, true); return null; } throw new Error(`Recherche échouée (${searchRes.status}): ${await searchRes.text()}`); } const searchData = await searchRes.json(); if (searchData.files && searchData.files.length > 0) { console.log(`Drive: Fichier ${filename} trouvé (ID: ${searchData.files[0].id}).`); return searchData.files[0].id; } console.log(`Drive: Fichier ${filename} non trouvé. Création...`); const createUrl = `https://www.googleapis.com/drive/v3/files`; const metadata = { name: filename, mimeType: mimeType }; const createRes = await fetch(createUrl, { method: 'POST', headers: { 'Authorization': `Bearer ${googleAccessToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify(metadata) }); if (!createRes.ok) { throw new Error(`Création échouée (${createRes.status}): ${await createRes.text()}`); } const createData = await createRes.json(); const newFileId = createData.id; console.log(`Drive: Fichier ${filename} créé (ID: ${newFileId}). Écriture du contenu par défaut...`); const updateOk = await updateFileContent(newFileId, defaultContent); if (updateOk) { console.log(`Drive: Contenu par défaut écrit dans ${filename}.`); } else { console.error(`Drive: Échec de l'écriture du contenu par défaut dans ${filename}.`); // Pas critique, la lecture renverra vide } return newFileId; } catch (error) { console.error(`Erreur Drive (findOrCreate ${filename}):`, error); showMessage(`Erreur Drive (${filename.substring(0, 15)}...): ${error.message}`, 6000, true); return null; } }
    async function readFileContent(fileId) { /* ... (Identique) ... */ if (!googleAccessToken || !fileId) { console.warn("readFileContent (Evolution v2): Pas de token ou d'ID."); return null; } console.log(`Drive (Evolution v2): Lecture du fichier ${fileId}`); const url = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`; try { const response = await fetch(url, { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }); if (!response.ok) { if (response.status === 404) { console.warn(`readFileContent(${fileId}): Fichier non trouvé (404).`); return ""; // Renvoyer chaîne vide pour permettre création/parsing facile } if (response.status === 401 || response.status === 403) { console.warn(`readFileContent(${fileId}): Erreur d'autorisation (${response.status}). Déconnexion.`); handleSignoutClick(false); showMessage("Session Google expirée ou accès refusé. Reconnectez-vous.", 5000, true); return null; } throw new Error(`Lecture échouée (${response.status}): ${await response.text()}`); } const content = await response.text(); console.log(`Drive: Contenu du fichier ${fileId} lu.`); return content; } catch (error) { console.error(`Erreur Drive (readFile ${fileId}):`, error); showMessage(`Erreur Lecture Drive (${fileId}): ${error.message}`, 6000, true); return null; } }
    async function updateFileContent(fileId, content, mimeType = 'application/json') { // Nouvelle fonction pour écrire/MAJ
        if (!googleAccessToken || !fileId) { console.warn("updateFileContent: Pas de token ou d'ID."); return false; }
        console.log(`Drive: Mise à jour du fichier ${fileId}...`);
        const url = `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`;
        try {
            const response = await fetch(url, {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${googleAccessToken}`,
                    'Content-Type': mimeType
                },
                body: content
            });
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                     console.warn(`updateFileContent(${fileId}): Erreur d'autorisation (${response.status}). Déconnexion.`); handleSignoutClick(false); showMessage("Session Google expirée ou accès refusé. Reconnectez-vous.", 5000, true); return false;
                }
                throw new Error(`Mise à jour échouée (${response.status}): ${await response.text()}`);
            }
            console.log(`Drive: Fichier ${fileId} mis à jour avec succès.`);
            return true;
        } catch (error) {
            console.error(`Erreur Drive (updateFile ${fileId}):`, error);
            showMessage(`Erreur Sauvegarde Drive (${fileId}): ${error.message}`, 6000, true);
            return false;
        }
    }

    // --- Chargement des Programmes & Historique ---
    async function loadProgramsFromDrive() { /* ... (Identique mais log plus clair) ... */ if (!googleAccessToken) return false; console.log("Chargement des programmes depuis Drive (Evolution v2)..."); let allLoadedSuccessfully = true; const tempLoadedPrograms = {}; for (const type of PROGRAM_TYPES) { console.log(`Chargement programme: ${type}...`); const defaultJsonString = JSON.stringify([], null, 2); programFileIds[type] = await findOrCreateFile(PROGRAM_FILENAMES[type], defaultJsonString); if (programFileIds[type]) { const content = await readFileContent(programFileIds[type]); if (content !== null) { try { const parsedContent = JSON.parse(content || '[]'); tempLoadedPrograms[type] = Array.isArray(parsedContent) ? parsedContent : []; if (tempLoadedPrograms[type].length === 0) console.warn(`Programme ${type} chargé mais vide ou invalide.`); else console.log(`Programme ${type} chargé/parsé (${tempLoadedPrograms[type].length} étapes).`); } catch (e) { console.error(`Erreur parsing JSON programme ${type}:`, e, "Contenu:", content); showMessage(`Erreur format programme ${type}. Utilisation vide.`, 4000, true); tempLoadedPrograms[type] = []; allLoadedSuccessfully = false; } } else { console.warn(`Lecture programme ${type} échouée. Utilisation programme vide.`); tempLoadedPrograms[type] = []; allLoadedSuccessfully = false; } } else { console.error(`Impossible d'obtenir/créer l'ID pour ${type}. Utilisation programme vide.`); tempLoadedPrograms[type] = []; allLoadedSuccessfully = false; } } loadedPrograms = tempLoadedPrograms; console.log("Fin chargement programmes (Evolution v2). Global success:", allLoadedSuccessfully); return allLoadedSuccessfully; }
    async function loadEloHistory() { // Nouvelle fonction pour charger l'historique
        if (!googleAccessToken) return false;
        console.log("Chargement de l'historique ELO depuis Drive...");
        const defaultHistory = JSON.stringify([], null, 2);
        eloHistoryFileId = await findOrCreateFile(ELO_HISTORY_FILENAME, defaultHistory);
        if (eloHistoryFileId) {
            const content = await readFileContent(eloHistoryFileId);
            if (content !== null) {
                try {
                    const parsedHistory = JSON.parse(content || '[]');
                    eloHistoryData = Array.isArray(parsedHistory) ? parsedHistory : [];
                    // Trier par date au cas où et limiter la taille
                    eloHistoryData.sort((a, b) => a.timestamp - b.timestamp);
                    if (eloHistoryData.length > MAX_HISTORY_ENTRIES) {
                        eloHistoryData = eloHistoryData.slice(-MAX_HISTORY_ENTRIES);
                        console.warn(`Historique tronqué aux ${MAX_HISTORY_ENTRIES} dernières entrées.`);
                        // Optionnel: Sauvegarder l'historique tronqué immédiatement ? Non, on attend la prochaine sauvegarde.
                    }
                    console.log(`Historique ELO chargé (${eloHistoryData.length} entrées).`);
                    return true;
                } catch (e) {
                    console.error("Erreur parsing JSON historique ELO:", e, "Contenu:", content);
                    showMessage("Erreur format historique ELO. Historique ignoré.", 4000, true);
                    eloHistoryData = [];
                    return false;
                }
            } else {
                console.warn("Lecture historique ELO échouée.");
                eloHistoryData = [];
                return false;
            }
        } else {
            console.error("Impossible d'obtenir/créer l'ID pour l'historique ELO.");
            eloHistoryData = [];
            return false;
        }
    }
    async function saveCurrentEloToHistory() { // Nouvelle fonction pour sauvegarder l'ELO actuel
        if (!googleAccessToken || !eloHistoryFileId || Object.keys(currentELOValues).length === 0) {
            console.warn("Sauvegarde historique annulée: non connecté, ID manquant ou ELO non calculé.");
            return;
        }

        const now = Date.now();
        const newEntry = {
            timestamp: now,
            eloValues: { ...currentELOValues }, // Copie
            overallAvgELO: overallAvgELO
        };

        // Éviter les doublons si calculé plusieurs fois rapidement
        const lastEntry = eloHistoryData[eloHistoryData.length - 1];
        if (lastEntry && (now - lastEntry.timestamp < 60000)) { // Moins d'1 minute
             // Comparaison rapide (pas parfaite mais suffisante)
             if(JSON.stringify(lastEntry.eloValues) === JSON.stringify(newEntry.eloValues) && lastEntry.overallAvgELO === newEntry.overallAvgELO) {
                 console.log("Sauvegarde historique ignorée: données ELO identiques à la dernière entrée récente.");
                 return;
             }
        }


        eloHistoryData.push(newEntry);

        // Limiter la taille
        if (eloHistoryData.length > MAX_HISTORY_ENTRIES) {
            eloHistoryData = eloHistoryData.slice(-MAX_HISTORY_ENTRIES);
        }

        console.log("Préparation sauvegarde historique ELO...");
        try {
            const historyJsonString = JSON.stringify(eloHistoryData, null, 2);
            const success = await updateFileContent(eloHistoryFileId, historyJsonString);
            if (success) {
                console.log("Historique ELO sauvegardé sur Drive.");
                // Mettre à jour le graphique immédiatement
                 if (historyChart) {
                    displayEloHistoryChart(); // Re-render avec la nouvelle donnée
                 }
            } else {
                console.error("Échec sauvegarde historique ELO sur Drive.");
                // Retirer la dernière entrée ajoutée localement si la sauvegarde échoue? Peut-être pas nécessaire.
                 showMessage("Erreur sauvegarde historique.", 4000, true);
            }
        } catch (e) {
            console.error("Erreur lors de la sérialisation/sauvegarde de l'historique:", e);
             showMessage("Erreur interne sauvegarde historique.", 4000, true);
        }
    }

    // --- Logique de Calcul et Affichage ELO (MAJ v3) ---

    function getRepsFactor(reps) { /* ... (Identique avec seuil 8) ... */ if (reps === null || reps === undefined) return 0.8; if (reps === Infinity) return REPS_FACTORS[Infinity]; const thresholds = Object.keys(REPS_FACTORS).map(Number).filter(n => isFinite(n)).sort((a, b) => a - b); for (let i = thresholds.length - 1; i >= 0; i--) { if (reps >= thresholds[i]) { return REPS_FACTORS[thresholds[i]]; } } return 0.8; // Default for less than 8 }

    function isPolyarticular(exerciseName) { /* ... (Identique) ... */ const name = (exerciseName || '').toLowerCase(); const polyKeywords = ['press', 'pompe', 'row', 'pulldown', 'ohp', 'squat', 'fente']; return polyKeywords.some(keyword => name.includes(keyword)); }

    function calculateExerciseELO(step) { // MAJ pour durée et résistance affinée
        if (step.type !== 'exercise') return 0;

        const base = ELO_BASE;

        // 1. Calcul ELO basé sur la durée (prioritaire si défini)
        if (step.duration !== null && step.duration !== undefined && step.duration > 0) {
             // Formule simple: Base + Durée * Facteur. À affiner potentiellement.
             // On pourrait aussi avoir des paliers de durée.
            const durationElo = base + (step.duration * DURATION_ELO_FACTOR);
            // console.log(`ELO Calc (${step.name}): Durée=${step.duration}s => ELO=${Math.round(durationElo)}`); // DEBUG
            // Appliquer bonus technique (si pertinent pour exos statiques?)
             if (step.intensity_technique === true) { return Math.round(durationElo * INTENSITY_TECHNIQUE_BONUS_MULTIPLIER); }
            return Math.round(durationElo);
        }

        // 2. Calcul ELO basé sur Répétitions et Résistance
        let bonusResistance = 0;
        let bonusReps = 0;
        const equipmentString = step.equipment || '';
        let matchedKey = null;

        // Recherche de la clé la plus spécifique (la plus longue) dans RESISTANCE_BONUS
        const sortedResistanceKeys = Object.keys(RESISTANCE_BONUS).sort((a, b) => b.length - a.length);
        for (const key of sortedResistanceKeys) {
            // Utiliser une regex pour chercher le mot/groupe exact peut être mieux,
            // mais pour l'instant on garde includes() pour la flexibilité
            if (equipmentString.toLowerCase().includes(key.toLowerCase())) {
                 bonusResistance = RESISTANCE_BONUS[key];
                 matchedKey = key;
                 // console.log(`ELO Calc (${step.name}): Matched resistance key "${matchedKey}" -> Bonus ${bonusResistance}`); // DEBUG
                 break; // Prend la première (la plus longue) correspondance
            }
        }

        // Fallback sur step.weight si aucune clé n'a matché via 'equipment'
        if (bonusResistance === 0 && step.weight !== null && step.weight !== undefined) {
            console.warn(`ELO Calc (${step.name}): Résistance non trouvée via 'equipment' ("${equipmentString}"). Utilisation de 'weight' (${step.weight}) comme fallback.`);
            // Mapping simple weight -> bonus (peut être amélioré)
                 if (step.weight === 0) bonusResistance = RESISTANCE_BONUS['Bodyweight'] || 75;
                 else if (step.weight <= 5) bonusResistance = RESISTANCE_BONUS['Haltères 5kg'] || 50; // Catche 5kg
                 else if (step.weight <= 15) bonusResistance = RESISTANCE_BONUS['Élastique 15kg'] || 50; // Catche 15kg
                 else if (step.weight <= 25) bonusResistance = RESISTANCE_BONUS['Élastique 25kg'] || 125; // Catche 25kg
                 else if (step.weight <= 40) bonusResistance = RESISTANCE_BONUS['Élastique 15+25kg'] || 200; // Catche 40kg
                 else if (step.weight <= 45) bonusResistance = RESISTANCE_BONUS['Élastique 15+25kg + 1 haltère 5kg'] || 225; // Catche 45kg
                 else if (step.weight <= 50) bonusResistance = RESISTANCE_BONUS['Élastique 15+25kg + 2x5kg haltères'] || 250; // Catche 50kg
                 else bonusResistance = step.weight * 2; // Fallback générique pour poids > 50
            // console.log(`ELO Calc (${step.name}): Fallback weight ${step.weight} -> Bonus ${bonusResistance}`); // DEBUG
        } else if (bonusResistance === 0 && equipmentString) {
             console.warn(`ELO Calc (${step.name}): Equipment "${equipmentString}" non reconnu dans RESISTANCE_BONUS et pas de poids fallback.`);
        }


        // Calculer bonus reps basé sur la résistance trouvée
        if (bonusResistance > 0 && step.reps !== null && step.reps !== undefined) {
            const reps = step.reps === 'max' ? Infinity : step.reps; // Gérer 'max'
            const repsFactor = getRepsFactor(reps);
            bonusReps = bonusResistance * Math.max(0, repsFactor - 1.0); // Bonus = % au dessus du facteur 1.0
            // console.log(`ELO Calc (${step.name}): Reps=${reps} (Factor ${repsFactor}) -> Bonus Reps ${Math.round(bonusReps)}`); // DEBUG
        }

        let elo = base + bonusResistance + bonusReps;

        // Appliquer bonus technique d'intensité
        if (step.intensity_technique === true) {
            elo *= INTENSITY_TECHNIQUE_BONUS_MULTIPLIER;
             // console.log(`ELO Calc (${step.name}): Bonus Intensité appliqué -> ELO ${Math.round(elo)}`); // DEBUG
        }

        return Math.round(elo);
    }

    function mapExerciseToMuscleGroup(exerciseName) { // Assurer que Legs est bien mappé
        const name = (exerciseName || '').toLowerCase();
        if (!name) return [];

        // Priorité aux plus spécifiques
        if (name.includes('squat') || name.includes('bulgarian') || name.includes('fente') || name.includes('leg press') || name.includes('leg extension') || name.includes('leg curl') || name.includes('hip thrust') || name.includes('glute bridge') || name.includes('calf raise') || name.includes('mollet')) return ['Legs'];
        if (name.includes('sit-up') || name.includes('hollow') || name.includes('leg raise') || name.includes('crunch') || name.includes('planche') || name.includes('gainage') || name.includes('abdo') || name.includes('oblique') || name.includes('russian twist')) return ['Core'];
        if (name.includes('pec deck') || name.includes('chest fly')) return ['Pectoraux'];
        if (name.includes('pull over') || name.includes('pullover')) return ['Dos', 'Pectoraux']; // Poly
        if (name.includes('row') || name.includes('tirage horizontal') || name.includes('rowing')) return ['Dos'];
        if (name.includes('pulldown') || name.includes('tirage vertical') || name.includes('traction')) return ['Dos', 'Biceps']; // Poly
        if (name.includes('face pull')) return ['Dos', 'Épaules']; // Poly
        if (name.includes('shrug')) return ['Dos', 'Épaules']; // Trapèzes (souvent classé dos ou épaules)
        if (name.includes('press') || name.includes('pompe') || name.includes('push up') || name.includes('dips')) { // Exos de poussée
            if (name.includes('bench') || name.includes('incline') || name.includes('decline') || name.includes('pec')) return ['Pectoraux', 'Triceps', 'Épaules']; // Poly Pectoraux dominant
            if (name.includes('overhead') || name.includes('ohp') || name.includes('shoulder') || name.includes('militaire')) return ['Épaules', 'Triceps']; // Poly Épaules dominant
            if (name.includes('close grip')) return ['Triceps', 'Pectoraux']; // Poly Triceps dominant
            return ['Pectoraux', 'Triceps', 'Épaules']; // Cas général push (pompes classiques)
        }
        if (name.includes('curl') || name.includes('bicep')) return ['Biceps'];
        if (name.includes('tricep extension') || name.includes('skullcrusher') || name.includes('pushdown') || name.includes('kickback')) return ['Triceps'];
        if (name.includes('lateral raise') || name.includes('elevation laterale')) return ['Épaules'];
        if (name.includes('front raise') || name.includes('elevation frontale')) return ['Épaules'];
        if (name.includes('rear delt') || name.includes('oiseau')) return ['Épaules', 'Dos']; // Arrière épaule

        console.warn(`Groupe musculaire non mappé pour : "${exerciseName}"`);
        return [];
    }

    function analyzeProgramsAndCalculateELO() { // MAJ pour stocker détails exos
        console.log("Analyse des programmes et calcul ELO (v3)...");
        // Reset state
        const groupData = {};
        exerciseDetailsPerGroup = {}; // Reset details for modal
        Object.keys(MUSCLE_GROUPS_DISPLAY_ORDER).flatMap(cat => MUSCLE_GROUPS_DISPLAY_ORDER[cat]).forEach(group => {
            groupData[group] = { totalWeightedElo: 0, totalWeight: 0 };
            exerciseDetailsPerGroup[group] = []; // Initialize array for each group
        });
        currentELOValues = {};

        if (!programsLoaded) { console.warn("Programmes non chargés, analyse annulée."); return; }

        PROGRAM_TYPES.forEach(type => {
            if (!loadedPrograms[type] || loadedPrograms[type].length === 0) { return; }

            let currentExerciseName = null;
            let currentExerciseSets = 0;
            let lastExerciseStep = null;

            loadedPrograms[type].forEach((step, index) => {
                 if (step.type === 'exercise') {
                     if (step.name === currentExerciseName) {
                         currentExerciseSets++;
                     } else {
                         if (lastExerciseStep) {
                             processExerciseBlock(lastExerciseStep, currentExerciseSets, groupData, exerciseDetailsPerGroup);
                         }
                         currentExerciseName = step.name;
                         currentExerciseSets = 1;
                     }
                     lastExerciseStep = step;

                     if (index === loadedPrograms[type].length - 1) {
                          processExerciseBlock(lastExerciseStep, currentExerciseSets, groupData, exerciseDetailsPerGroup);
                     }

                 } else if (step.type === 'break') {
                     if (lastExerciseStep) {
                          processExerciseBlock(lastExerciseStep, currentExerciseSets, groupData, exerciseDetailsPerGroup);
                     }
                     currentExerciseName = null;
                     currentExerciseSets = 0;
                     lastExerciseStep = null;
                 }
            });
        });

        // Calculer les moyennes pondérées finales
        let totalOverallEloSum = 0;
        let totalOverallWeight = 0;
        Object.keys(groupData).forEach(group => {
            const data = groupData[group];
            if (data.totalWeight > 0) {
                currentELOValues[group] = Math.round(data.totalWeightedElo / data.totalWeight);
            } else {
                currentELOValues[group] = ELO_BASE; // Si aucun exercice pour ce groupe
            }
            // Ajouter à la moyenne globale (UNIQUEMENT Haut du Corps)
            if (group !== 'Legs') { // Exclure les jambes de l'ELO moyen global
                totalOverallEloSum += currentELOValues[group] * data.totalWeight; // Pondérer par le poids total du groupe
                totalOverallWeight += data.totalWeight;
            }
        });

        overallAvgELO = totalOverallWeight > 0 ? Math.round(totalOverallEloSum / totalOverallWeight) : ELO_BASE;
        console.log("ELO Moyen Global Pondéré (Haut Corps):", overallAvgELO);
        console.log("ELO Moyen Pondéré par Groupe:", currentELOValues);
        // console.log("Données agrégées:", groupData); // Debug
        // console.log("Détails Exercices par Groupe:", exerciseDetailsPerGroup); // Debug
    }

    function processExerciseBlock(exerciseStep, numSets, groupData, detailsStore) { // MAJ pour stocker détails
        const eloPerSet = calculateExerciseELO(exerciseStep);
        if (eloPerSet > 0) {
            const isPoly = isPolyarticular(exerciseStep.name);
            const weight = isPoly ? POLYARTICULAR_WEIGHT : ISOLATION_WEIGHT;
            const groups = mapExerciseToMuscleGroup(exerciseStep.name);

            groups.forEach(group => {
                if (groupData[group]) {
                    groupData[group].totalWeightedElo += eloPerSet * numSets * weight;
                    groupData[group].totalWeight += numSets * weight;

                    // Stocker les détails pour la modale
                    if (detailsStore[group]) {
                        detailsStore[group].push({
                            name: exerciseStep.name,
                            sets: numSets,
                            reps: exerciseStep.reps ?? null,
                            duration: exerciseStep.duration ?? null,
                            equipment: exerciseStep.equipment || 'N/A',
                            elo: eloPerSet,
                             weighting: weight // Juste pour info éventuelle
                        });
                    }
                }
            });
        }
    }


    function determineCurrentGoalLevel() { // Utilise la clé d'état
        // Ici on pourrait ajouter la logique pour lire la sélection utilisateur si implémentée
        // Pour l'instant, on garde la logique automatique basée sur l'ELO actuel vs L1
        if (overallAvgELO >= (TARGET_ELO_LEVELS.L1_MaxReps.targetELO || 950)) {
             if (TARGET_ELO_LEVELS.L2_TomHolland) { return 'L2_TomHolland'; }
        }
        return 'L1_MaxReps';
    }

    function calculateAndDisplayEvolution() { // MAJ pour Legs, modale, objectif final, et sauvegarde historique
        if (!evolutionTrackerArea || !overallEloDisplay || !goalInfo || !goalDescriptionElement || !muscleGroupsContainer || !globalProgressBar || !globalProgressPercentage || !finalGoalNameSpan) return;

        analyzeProgramsAndCalculateELO(); // Calcule ELO et remplit exerciseDetailsPerGroup

        currentGoalLevelKey = determineCurrentGoalLevel(); // Détermine L1 ou L2 (ou autre si sélectionné)
        const currentGoal = TARGET_ELO_LEVELS[currentGoalLevelKey];
        const finalGoal = TARGET_ELO_LEVELS[FINAL_TARGET_LEVEL_KEY];

        // Trouver le niveau précédent pour calculer la progression DANS le niveau actuel
        const goalKeys = Object.keys(TARGET_ELO_LEVELS);
        const currentGoalIndex = goalKeys.indexOf(currentGoalLevelKey);
        const previousGoalLevelKey = currentGoalIndex > 0 ? goalKeys[currentGoalIndex - 1] : null;
        const previousGoal = previousGoalLevelKey ? TARGET_ELO_LEVELS[previousGoalLevelKey] : { targetELO: ELO_BASE, groups: {} }; // Base ELO comme "niveau 0"

        overallEloDisplay.innerHTML = `${overallAvgELO} <span>ELO Moyen (Haut du Corps)</span>`;
        goalInfo.innerHTML = `Objectif Actuel : <span class="target-level">${currentGoal.name}</span> (ELO Cible Groupe <span class="target-elo-value">${currentGoal.targetELO}</span>)`;
        goalDescriptionElement.textContent = currentGoal.description || "";
        finalGoalNameSpan.textContent = finalGoal.name || "Final"; // Nom pour la barre globale

        muscleGroupsContainer.innerHTML = ''; // Vider avant de remplir
        for (const category in MUSCLE_GROUPS_DISPLAY_ORDER) {
             const categoryDiv = document.createElement('div'); categoryDiv.className = 'muscle-category';
             const categoryHeader = document.createElement('h3'); categoryHeader.className = 'muscle-category-header'; categoryHeader.textContent = category; categoryDiv.appendChild(categoryHeader);
             const groupGridDiv = document.createElement('div'); groupGridDiv.className = 'muscle-group-grid';

             MUSCLE_GROUPS_DISPLAY_ORDER[category].forEach(group => {
                 // NE PAS ignorer 'Legs' ici pour afficher la carte
                 const currentAvgELO = currentELOValues[group] || ELO_BASE;
                 const targetELO = currentGoal.groups[group] || currentGoal.targetELO; // ELO cible pour CE niveau
                 const stageStartELO = previousGoal.groups[group] || previousGoal.targetELO || ELO_BASE; // ELO de départ pour CE niveau

                 let progressPercent = 0;
                 if (targetELO > stageStartELO) {
                     progressPercent = ((currentAvgELO - stageStartELO) / (targetELO - stageStartELO)) * 100;
                 } else if (currentAvgELO >= targetELO) { // Si cible <= départ (peu probable) ou si cible atteinte
                     progressPercent = 100;
                 }
                 progressPercent = Math.max(0, Math.min(100, Math.round(progressPercent)));

                 const card = renderMuscleGroupCard(group, currentAvgELO, targetELO, progressPercent);
                 groupGridDiv.appendChild(card);
             });
             categoryDiv.appendChild(groupGridDiv);
             muscleGroupsContainer.appendChild(categoryDiv);
        }

        // Calcul et MAJ Barre Globale vers l'objectif FINAL
        let globalProgressPercent = 0;
        const finalTargetEloValue = finalGoal.targetELO || FINAL_TARGET_ELO; // Assurer qu'on a une valeur numérique
        if (finalTargetEloValue > ELO_BASE) {
             globalProgressPercent = ((overallAvgELO - ELO_BASE) / (finalTargetEloValue - ELO_BASE)) * 100;
        } else if (overallAvgELO >= finalTargetEloValue) {
             globalProgressPercent = 100;
        }
        globalProgressPercent = Math.max(0, Math.min(100, Math.round(globalProgressPercent)));

        globalProgressPercentage.textContent = `${globalProgressPercent}%`;
        globalProgressBar.style.width = `0%`; // Reset pour animation
        globalProgressBar.setAttribute('aria-valuenow', overallAvgELO); // Valeur actuelle ELO
        globalProgressBar.setAttribute('aria-valuemin', ELO_BASE);
        globalProgressBar.setAttribute('aria-valuemax', finalTargetEloValue); // Cible finale
        requestAnimationFrame(() => {
             setTimeout(() => { globalProgressBar.style.width = `${globalProgressPercent}%`; }, 50);
        });

        // Sauvegarder l'état actuel dans l'historique (après que tout soit calculé)
        saveCurrentEloToHistory();
    }

    function renderMuscleGroupCard(groupName, currentElo, targetElo, progressPercent) { // MAJ pour data-group et event listener
        const card = document.createElement('div');
        card.className = 'muscle-group-card';
        card.dataset.group = groupName; // Stocker le nom du groupe pour le clic
        const iconClass = MUSCLE_GROUP_ICONS[groupName] || 'fa-question-circle';
        card.innerHTML = `
            <div class="muscle-group-header">
                <i class="fas ${iconClass}" aria-hidden="true"></i>
                <h3 class="muscle-group-title">${groupName}</h3>
            </div>
            <div class="elo-info">
                <span class="current-elo">${currentElo}</span>
                <span class="target-elo">Objectif: <strong>${targetElo}</strong></span>
            </div>
            <div class="progress-bar-container" title="${progressPercent}% vers l'objectif ELO ${targetElo} du niveau actuel">
                <div class="progress-bar" style="width: 0%;" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                    <span class="progress-percentage">${progressPercent}%</span>
                </div>
            </div>
        `;
        // Animation de la barre
        requestAnimationFrame(() => {
            setTimeout(() => {
                const progressBar = card.querySelector('.progress-bar');
                if (progressBar) {
                    progressBar.style.width = `${progressPercent}%`;
                    progressBar.setAttribute('aria-valuenow', progressPercent);
                }
            }, 50);
        });
        // Ajouter l'écouteur pour ouvrir la modale
        card.addEventListener('click', handleMuscleGroupClick);
        return card;
    }

    // --- Affichage Historique ELO ---
    function displayEloHistoryChart() {
        if (!eloHistoryChartCanvas || !Chart || eloHistoryData.length === 0) {
            console.log("Canvas non prêt, Chart.js non chargé ou historique vide.");
             if(historyLoadingMsg && eloHistoryData.length === 0 && programsLoaded) historyLoadingMsg.textContent = 'Aucune donnée historique à afficher.';
            return;
        }
         if(historyLoadingMsg) historyLoadingMsg.style.display = 'none'; // Masquer message chargement

        const ctx = eloHistoryChartCanvas.getContext('2d');

        // Détruire l'ancien graphique s'il existe
        if (historyChart) {
            historyChart.destroy();
        }

        // Préparer les données pour Chart.js
        const labels = eloHistoryData.map(entry => entry.timestamp); // Utiliser timestamp directement
        const overallEloValues = eloHistoryData.map(entry => entry.overallAvgELO);
        // Optionnel: Ajouter d'autres groupes si souhaité
        // const pectorauxEloValues = eloHistoryData.map(entry => entry.eloValues?.Pectoraux || ELO_BASE);

        historyChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'ELO Moyen Global (Haut Corps)',
                    data: overallEloValues,
                    borderColor: 'var(--neon-purple)',
                    backgroundColor: 'rgba(var(--neon-purple-rgb), 0.1)',
                    borderWidth: 2,
                    tension: 0.1, // Lisser la courbe
                    pointBackgroundColor: 'var(--neon-purple)',
                    fill: true,
                }
                // Ajoutez d'autres datasets ici pour les groupes spécifiques si besoin
                // {
                //     label: 'ELO Pectoraux',
                //     data: pectorauxEloValues,
                //     borderColor: 'var(--neon-blue)',
                //     ...
                // }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time', // Utiliser l'échelle de temps
                        time: {
                            unit: 'day', // Ajuster l'unité (day, week, month)
                            tooltipFormat: 'PPP', // Format date dans tooltip (ex: Sep 14, 2023) Requires date-fns
                             displayFormats: { // Format date sur l'axe
                                 day: 'd MMM', // ex: 14 Sep
                                 week: 'PP',
                                 month: 'MMM yyyy'
                             }
                        },
                        title: {
                            display: true,
                            text: 'Date',
                            color: 'var(--secondary-text-color)' // Couleur titre axe X
                        },
                        grid: {
                            color: 'rgba(var(--secondary-text-color-dark-rgb), 0.2)'
                         },
                         ticks: {
                             color: 'var(--secondary-text-color)' // Couleur labels axe X
                         }
                    },
                    y: {
                        beginAtZero: false, // Ne pas commencer à 0 mais proche de ELO_BASE
                        min: ELO_BASE - 50, // Ajuster si besoin
                        title: {
                            display: true,
                            text: 'ELO Score',
                             color: 'var(--secondary-text-color)' // Couleur titre axe Y
                        },
                         grid: {
                            color: 'rgba(var(--secondary-text-color-dark-rgb), 0.2)'
                         },
                          ticks: {
                             color: 'var(--secondary-text-color)' // Couleur labels axe Y
                         }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: 'var(--primary-text-color)' // Couleur légende
                        }
                    },
                     tooltip: {
                         mode: 'index',
                         intersect: false,
                         backgroundColor: 'rgba(var(--bg-color-dark-rgb), 0.9)',
                         titleColor: 'var(--primary-text-color)',
                         bodyColor: 'var(--secondary-text-color)',
                         borderColor: 'var(--border-color)',
                         borderWidth: 1,
                     }
                },
                interaction: { // Améliore l'interaction tooltip
                     mode: 'index',
                     intersect: false,
                }
            }
        });
        console.log("Graphique historique ELO affiché/mis à jour.");
    }


    // --- Gestion Modale Détails Exercice ---
    function handleMuscleGroupClick(event) {
        const groupName = event.currentTarget.dataset.group;
        if (!groupName || !exerciseDetailsPerGroup[groupName]) {
            console.error("Impossible de récupérer les détails pour le groupe:", groupName);
            return;
        }

        const details = exerciseDetailsPerGroup[groupName];
        modalTitle.textContent = `Détails Exercices - ${groupName}`;
        modalExerciseList.innerHTML = ''; // Vider la liste

        if (details.length === 0) {
            modalExerciseList.innerHTML = '<li>Aucun exercice trouvé pour ce groupe dans les programmes analysés.</li>';
        } else {
            // Trier par ELO décroissant?
             details.sort((a, b) => b.elo - a.elo);

            details.forEach(ex => {
                const li = document.createElement('li');
                let detailText = `${ex.sets} série(s)`;
                if (ex.reps !== null) detailText += ` x ${ex.reps} reps`;
                if (ex.duration !== null) detailText += ` (${ex.duration}s)`;
                detailText += ` | ${ex.equipment}`;

                li.innerHTML = `
                    <span class="exercise-name">${ex.name}</span>
                    <span class="exercise-details">
                        ${detailText} - ELO/set: <span class="exercise-elo">${ex.elo}</span>
                    </span>
                `;
                modalExerciseList.appendChild(li);
            });
        }

        exerciseDetailModal.style.display = "block";
    }

    function closeModal() {
        if (exerciseDetailModal) {
            exerciseDetailModal.style.display = "none";
            modalExerciseList.innerHTML = '<li>Chargement...</li>'; // Reset content
        }
    }

    function initModal() { // Ajouter les écouteurs pour la modale
        if (modalCloseBtn) {
            modalCloseBtn.addEventListener('click', closeModal);
        }
        // Fermer si on clique en dehors de la modale
        window.addEventListener('click', (event) => {
            if (event.target === exerciseDetailModal) {
                closeModal();
            }
        });
         // Fermer avec la touche Echap
         window.addEventListener('keydown', (event) => {
             if (event.key === 'Escape' && exerciseDetailModal && exerciseDetailModal.style.display === 'block') {
                 closeModal();
             }
         });
    }

    // --- UI Update ---
    function updateAuthUI(isLoggedIn) { /* MAJ pour gérer historique et modale */ console.log(`Update UI (Evolution v2) - Connecté: ${isLoggedIn}, Programmes Chargés: ${programsLoaded}`); const body = document.body; body.classList.toggle('logged-in', isLoggedIn); body.classList.toggle('logged-out', !isLoggedIn); if (connectionPrompt) connectionPrompt.style.display = isLoggedIn ? 'none' : 'block'; if (evolutionTrackerArea) evolutionTrackerArea.style.display = isLoggedIn && programsLoaded ? 'flex' : 'none'; // Afficher si loggué ET programmes OK if(signInButton) signInButton.disabled = isLoggedIn || !tokenClient; if(signInButtonPrompt) signInButtonPrompt.disabled = isLoggedIn || !tokenClient; if(signOutButton) signOutButton.disabled = !isLoggedIn; if(themeToggleBtn) themeToggleBtn.disabled = false; if(driveStatusElement) { driveStatusElement.style.display = isLoggedIn ? 'inline-block' : 'none'; if (!isLoggedIn) driveStatusElement.textContent = ''; } if (!isLoggedIn) { // Reset UI quand déconnecté if (muscleGroupsContainer) muscleGroupsContainer.innerHTML = ''; if (overallEloDisplay) overallEloDisplay.innerHTML = '-- <span>ELO Moyen (Haut du Corps)</span>'; if (goalInfo) goalInfo.innerHTML = 'Objectif Actuel : <span class="target-level">N/A</span> (ELO <span class="target-elo-value">--</span>)'; if(goalDescriptionElement) goalDescriptionElement.textContent = ''; if(globalProgressBar) globalProgressBar.style.width = '0%'; if(globalProgressPercentage) globalProgressPercentage.textContent = '0%'; if(historyChartContainer) historyChartContainer.style.display = 'none'; if(historyChart) { historyChart.destroy(); historyChart = null; } closeModal(); // Fermer la modale si ouverte } }

    // --- Gestion Thème ---
    function applyTheme(theme) { /* MAJ pour graphique */ const body = document.body; currentTheme = theme; body.classList.remove('light-theme', 'dark-theme'); body.classList.add(theme + '-theme'); if (themeToggleBtn) { themeToggleBtn.innerHTML = theme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>'; themeToggleBtn.setAttribute('aria-label', theme === 'dark' ? 'Passer au thème clair' : 'Passer au thème sombre'); } try { localStorage.setItem('theme', theme); console.log(`Thème appliqué/sauvegardé (Evolution v2): ${theme}`); } catch (e) { console.warn("Impossible de sauvegarder le thème (Evolution v2):", e); } // Re-render le graphique si visible pour appliquer les couleurs du thème if (historyChart && historyChart.ctx) { // Vérifier que le graphique existe encore historyChart.destroy(); // Recréer complètement est plus simple pour assurer la prise en compte des variables CSS displayEloHistoryChart(); } }
    function toggleTheme() { /* ... (Identique) ... */ const newTheme = currentTheme === 'dark' ? 'light' : 'dark'; applyTheme(newTheme); }
    function loadSavedTheme() { /* ... (Identique) ... */ let savedTheme = 'dark'; try { savedTheme = localStorage.getItem('theme') || 'dark'; } catch (e) { console.warn("Impossible de lire le thème depuis localStorage (Evolution v2):", e); } applyTheme(savedTheme); }

    // --- Message Area ---
    function showMessage(msg, duration = 3000, isError = false, type = null) { // type: 'error', 'success', 'warning', null (default)
        if (!messageArea) return;
        messageArea.textContent = msg;
        messageArea.classList.remove('error', 'success', 'warning'); // Reset types

        // Reset inline styles qui pourraient interférer
        messageArea.style.backgroundColor = '';
        messageArea.style.color = '';
        messageArea.style.borderColor = '';

        if (type === 'error' || isError) { // isError pour compatibilité ascendante
            messageArea.classList.add('error'); // Utilise les styles CSS de .message-area.error
        } else if (type === 'success') {
             messageArea.classList.add('success'); // Utilise les styles CSS de .message-area.success
        } else if (type === 'warning') {
             // Ajouter une classe 'warning' si un style différent est défini en CSS
             // messageArea.classList.add('warning');
             // Pour l'instant, on utilise un style inline pour le warning
             messageArea.style.backgroundColor = 'rgba(var(--neon-yellow-rgb), 0.8)';
             messageArea.style.color = '#000'; // Texte noir sur jaune?
             messageArea.style.borderColor = 'var(--neon-yellow)';
        } else {
            // Style par défaut (ni erreur, ni succès, ni warning)
             // Utilise les styles CSS de .message-area (pas besoin d'inline ici)
        }

        messageArea.classList.add('visible');
        if (messageTimeoutId) clearTimeout(messageTimeoutId);
        messageTimeoutId = setTimeout(() => {
            messageArea.classList.remove('visible');
        }, duration);
    }


    // --- Initialisation ---
    function initializeDOMReferences() { // MAJ pour nouveaux éléments
        console.log("Init DOM Refs (Evolution v2)...");
        signInButton = document.getElementById('signin-button');
        signOutButton = document.getElementById('signout-button');
        driveStatusElement = document.getElementById('drive-status');
        themeToggleBtn = document.getElementById('theme-toggle-btn');
        signInButtonPrompt = document.getElementById('signin-button-prompt');
        connectionPrompt = document.getElementById('connection-prompt');
        evolutionTrackerArea = document.getElementById('evolution-tracker-area');
        overallEloDisplay = document.getElementById('overall-elo-display');
        goalInfo = document.getElementById('goal-info');
        goalDescriptionElement = document.getElementById('goal-description');
        goalSelectorContainer = document.getElementById('goal-selector-container'); // Pour personnalisation future
        goalSelector = document.getElementById('goal-selector'); // Pour personnalisation future
        muscleGroupsContainer = document.getElementById('muscle-groups-container');
        messageArea = document.getElementById('message-area');
        globalProgressBar = document.getElementById('global-progress-bar');
        globalProgressPercentage = document.getElementById('global-progress-percentage');
        finalGoalNameSpan = document.getElementById('final-goal-name');
        // Historique
        historyChartContainer = document.getElementById('history-chart-container');
        eloHistoryChartCanvas = document.getElementById('elo-history-chart');
        historyLoadingMsg = document.getElementById('history-loading-msg');
        // Modale
        exerciseDetailModal = document.getElementById('exercise-detail-modal');
        modalCloseBtn = document.getElementById('modal-close-btn');
        modalTitle = document.getElementById('modal-title');
        modalExerciseList = document.getElementById('modal-exercise-list');

        console.log("DOM Refs initialisées (Evolution v2).");
    }
    function addEventListeners() { /* MAJ pour modale */
        console.log("Ajout Event Listeners (Evolution v2)...");
        if(signInButton) signInButton.addEventListener('click', handleAuthClick);
        if(signInButtonPrompt) signInButtonPrompt.addEventListener('click', handleAuthClick);
        if(signOutButton) signOutButton.addEventListener('click', () => handleSignoutClick(true)); // Passer true explicitement
        if(themeToggleBtn) themeToggleBtn.addEventListener('click', toggleTheme);
        // L'écouteur pour les cartes est ajouté dynamiquement dans renderMuscleGroupCard
        initModal(); // Initialise les écouteurs de la modale (fermeture, etc.)
        console.log("Event Listeners ajoutés (Evolution v2).");
    } // <<<=== ACCOLADE MANQUANTE CORRIGÉE ICI

    // --- Point d'entrée ---
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM Chargé (Evolution v2). Initialisation...");
        try {
            initializeDOMReferences();
            addEventListeners();
            loadSavedTheme();
            updateAuthUI(false); // Commence en état déconnecté
            checkAndInitGis(); // Lance la vérification de l'API Google
            console.log("Initialisation Evolution v2 terminée. Attente API Google...");
        } catch (error) {
            console.error("Erreur majeure lors de l'initialisation DOMContentLoaded (Evolution v2):", error);
             showMessage("Erreur critique au chargement du suivi d'évolution.", 10000, true);
             const body = document.querySelector('body');
             if(body) {
                const errorDiv = document.createElement('div');
                errorDiv.textContent = "Erreur chargement suivi: " + error.message;
                errorDiv.style.color='red'; errorDiv.style.padding='10px'; errorDiv.style.backgroundColor='white';
                body.prepend(errorDiv);
             }
        }
    });

    /*
    =========================================
    LISTE DES AMÉLIORATIONS POSSIBLES (Mise à jour v3.1 - Post Debug)
    =========================================
    (Identique à v3, mais avec code fonctionnel)

    **Implémentées / Initiées dans cette version:**
    1.  ✅ **Pondération Poly/Iso:** Maintenue.
    2.  ✅ **Impact Techniques Intensité:** Maintenu (via `intensity_technique`).
    3.  ✅ **Prise en Compte des Séries:** Maintenue.
    4.  ✅ **Affiner Bonus Résistance:** Logique de matching améliorée (plus longue clé d'abord), fallback `weight` conservé.
    5.  ✅ **Historique ELO:** Implémenté (stockage Drive `elo_history.json`, affichage Chart.js). Sauvegarde auto. Limitation taille.
    6.  ❓ **Normalisation ELO?** Échelle 800+ conservée.
    7.  ✅ **Détail par Exercice:** Implémenté (Modale cliquable sur les cartes).
    8.  ❓ **Conseils Personnalisés:** Non implémenté. Nécessite logique conditionnelle.
    9.  ❓ **Visualisation Muscle Map:** Non implémenté. Nécessite SVG/Canvas complexe.
    10. ✅ **Personnalisation Objectifs:** Préparé conceptuellement (structure `TARGET_ELO_LEVELS`, `determineCurrentGoalLevel`), UI selecteur cachée. Logique de sélection à ajouter.
    11. ❓ **Tooltips d'Information:** Peu ajouté (juste sur barre de progression). Pourrait être étendu.
    12. ❓ **Animation des Chiffres ELO:** Non implémenté. Nécessite librairie ou logique JS.
    13. ❓ **Feedback Visuel Progrès:** Non implémenté.
    14. ✅ **Lien vers l'Éditeur:** Maintenu.
    15. ❓ **Lien vers l'Historique (Timer):** Non implémenté.
    16. ❓ **Rappel Nutrition:** Non implémenté.
    17. ✅ **Prise en Compte du Temps (Duration):** Implémenté dans `calculateExerciseELO` avec facteur simple. À affiner potentiellement.
    18. ⏳ **Modularité du Code:** Non fait (contrainte "sans remettre en question"). **RECOMMANDÉ FORTEMENT** pour l'avenir.
    19. ❓ **Gestion Erreurs JSON (Programmes):** Basique (utilise tableau vide). Pourrait être améliorée (message + spécifique).
    20. ❓ **Tests Unitaires:** Non implémenté. **RECOMMANDÉ** pour logique ELO/Historique.
    21. ❓ **Optimisation Chargement:** Programmes toujours chargés en série. Historique chargé en parallèle.

    **Prochaines Étapes Potentielles:**
    *   **Modularisation JS/CSS.**
    *   **Affiner calcul ELO durée.**
    *   **Implémenter la sélection d'objectif utilisateur.**
    *   **Ajouter des tooltips explicatifs.**
    *   **Améliorer la gestion/visualisation de l'historique (zoom, sélection groupes...).**
    *   **Refactoriser les appels Drive (regrouper?).**
    */

</script>

</body>
</html>
