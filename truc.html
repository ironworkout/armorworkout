<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>THE HUNTER v20</title>
    
    <!-- Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">

    <style>
        /* --- THEME SYSTEM --- */
        :root {
            --bg: #0a0a0a;
            --surface: #141414;
            --glass: rgba(20, 20, 20, 0.85);
            --border: rgba(255, 255, 255, 0.08);
            --primary: #4f46e5; /* Indigo */
            --accent: #ef4444;  /* Red */
            --success: #10b981; /* Green */
            --gold: #f59e0b;    /* Gold */
            --text: #ffffff;
            --text-muted: #a3a3a3;
            --font: 'Inter', sans-serif;
            --ease: cubic-bezier(0.2, 0.8, 0.2, 1);
            
            /* Dimensions responsive */
            --hud-width: 100%;
            --hud-left: 0;
            --hud-top: 0;
            --list-width: 100%;
        }

        /* --- RESET & BASE --- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { 
            margin: 0; font-family: var(--font); background: var(--bg); color: var(--text); 
            height: 100dvh; width: 100vw; overflow: hidden; position: fixed; 
        }

        /* Input Fixes for interactivity */
        input, textarea { user-select: text !important; -webkit-user-select: text !important; }

        /* --- MAP --- */
        #map { width: 100%; height: 100%; z-index: 0; background: #0a0a0a; }
        .leaflet-container { background: #0a0a0a; font-family: var(--font); }
        .leaflet-tile { filter: brightness(0.8) contrast(1.2) grayscale(0.2); }
        .leaflet-control-attribution { display: none; }

        /* --- RESPONSIVE LAYOUT (PC vs MOBILE) --- */
        @media (min-width: 768px) {
            :root {
                --hud-width: 400px;
                --hud-left: 20px;
                --hud-top: 20px;
                --list-width: 450px;
            }
            /* Sur PC, la nav est flottante en bas */
            .nav { 
                width: 300px !important; 
                left: 50% !important; 
                transform: translateX(-50%); 
                bottom: 30px !important; 
                border-radius: 30px !important; 
                border: 1px solid var(--border) !important;
            }
            .brand-bar { border-radius: 16px; margin-bottom: 10px; }
            .hud-container { border-radius: 16px; }
            /* Liste en panneau latéral */
            .list-view { 
                width: var(--list-width) !important; 
                border-right: 1px solid var(--border);
                transform: translateX(-100%) !important;
            }
            .list-view.active { transform: translateX(0) !important; }
            .side-stack { right: 30px; top: 30px; }
        }

        /* --- BRANDING BAR --- */
        .hud-wrapper {
            position: absolute; top: var(--hud-top); left: var(--hud-left); 
            width: var(--hud-width); z-index: 3000; padding: 10px;
            pointer-events: none; /* Let clicks pass through gaps */
            display: flex; flex-direction: column; gap: 8px;
        }

        .brand-bar {
            background: var(--glass); border: 1px solid var(--border);
            padding: 12px 20px; width: 100%; pointer-events: auto;
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            /* Mobile rounded adjustments handled by default, PC overrides above */
        }
        .brand-logo { font-weight: 900; font-size: 18px; letter-spacing: -0.5px; display: flex; align-items: center; gap: 10px; }
        .brand-logo i { color: var(--accent); }
        .brand-logo span { color: var(--text-muted); font-weight: 400; font-size: 14px; margin-left: 5px; }

        /* --- SEARCH & FILTER --- */
        .controls-row { display: flex; gap: 8px; width: 100%; pointer-events: auto; }
        
        .pill {
            height: 48px; border-radius: 12px;
            background: var(--glass); border: 1px solid var(--border);
            display: flex; align-items: center; padding: 0 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3); transition: 0.2s;
            backdrop-filter: blur(20px); flex: 1;
        }
        .pill:focus-within { border-color: var(--primary); background: #1a1a1a; }
        .pill i { color: #666; margin-right: 10px; font-size: 14px; }
        .pill input { background: transparent; border: none; color: white; width: 100%; font-weight: 600; font-family: var(--font); font-size: 14px; }
        .pill input::placeholder { color: #555; font-weight: 500; }

        .suggestions-list {
            background: #1a1a1a; border: 1px solid var(--border); border-radius: 12px;
            max-height: 200px; overflow-y: auto; display: none;
            flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.8);
            margin-top: 5px; pointer-events: auto;
        }
        .suggestions-list.active { display: flex; }
        .sugg-item { padding: 12px 16px; border-bottom: 1px solid #333; font-size: 13px; color: #ccc; cursor: pointer; display: flex; gap: 10px; align-items: center; }
        .sugg-item:hover { background: #222; }

        /* --- MAP CONTROLS --- */
        .side-stack {
            position: absolute; bottom: 120px; right: 16px; z-index: 900;
            display: flex; flex-direction: column; gap: 12px; pointer-events: auto;
        }
        .btn-round {
            width: 44px; height: 44px; border-radius: 12px;
            background: var(--glass); border: 1px solid var(--border);
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 18px; cursor: pointer;
            box-shadow: 0 8px 20px rgba(0,0,0,0.5); backdrop-filter: blur(10px);
            transition: 0.2s;
        }
        .btn-round:active { transform: scale(0.95); }
        .btn-round.white { background: white; color: black; border: none; }

        /* --- MARKERS --- */
        .pin-wrap { width: 40px; height: 40px; pointer-events: none; transition: 0.4s var(--ease); }
        
        /* GHOST MODE (Filtered out) */
        .pin-wrap.ghost { opacity: 0.15; filter: grayscale(1); transform: scale(0.7); }
        
        .pin-body {
            width: 32px; height: 32px; border-radius: 50% 50% 0 50%; transform: rotate(45deg); 
            position: absolute; left: 4px; top: 0; border: 2px solid #fff; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center;
            background: #333; pointer-events: auto; transition: 0.3s;
        }
        .pin-body i { transform: rotate(-45deg); font-size: 14px; color: #fff; }
        
        /* Pin Colors based on Filter */
        .pin-saved .pin-body { background: var(--gold); border-color: #fff; z-index: 200; box-shadow: 0 0 15px rgba(245, 158, 11, 0.4); }
        .pin-saved .pin-body i { color: black; font-weight: bold; }
        
        .pin-match .pin-body { background: var(--primary); border-color: #fff; box-shadow: 0 0 15px rgba(79, 70, 229, 0.4); }

        /* --- BANNER --- */
        .banner {
            position: absolute; bottom: 100px; left: 16px; right: 16px;
            background: rgba(20, 20, 20, 0.95); border-radius: 16px; padding: 16px;
            display: flex; align-items: center; gap: 15px; z-index: 1100;
            transform: translateY(150%); transition: 0.4s var(--ease); 
            border: 1px solid var(--border); backdrop-filter: blur(20px);
            max-width: 500px; margin: 0 auto; /* Centered on big screens */
        }
        .banner.active { transform: translateY(0); }
        .banner-img { width: 50px; height: 50px; border-radius: 10px; object-fit: cover; background: #333; }
        .banner-info { flex: 1; overflow: hidden; }
        .banner-title { margin: 0; font-size: 15px; font-weight: 700; }
        .banner-addr { font-size: 11px; color: #888; margin-top: 3px; }
        .btn-fab { 
            width: 40px; height: 40px; border-radius: 10px; background: #333; color: white; 
            border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; 
        }
        .banner.saved .btn-fab { background: var(--gold); color: black; }

        /* --- LIST VIEW (Panel) --- */
        .list-view {
            position: absolute; inset: 0; background: #0a0a0a; z-index: 2500;
            padding-top: 20px; transform: translateX(100%); transition: 0.4s var(--ease);
            display: flex; flex-direction: column;
        }
        .list-view.active { transform: translateX(0); }
        
        .list-header { 
            padding: 20px 24px; font-size: 24px; font-weight: 800; border-bottom: 1px solid #222; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .list-scroll { overflow-y: auto; flex: 1; padding-bottom: 100px; }
        
        .city-group { margin-bottom: 10px; }
        .city-header { 
            position: sticky; top: 0; background: rgba(10,10,10,0.95); z-index: 10;
            padding: 10px 24px; font-size: 12px; font-weight: 700; color: var(--primary);
            border-bottom: 1px solid #222; backdrop-filter: blur(10px); text-transform: uppercase; letter-spacing: 1px;
        }
        
        .list-item { 
            padding: 16px 24px; border-bottom: 1px solid #1a1a1a; display: flex; gap: 15px; 
            cursor: pointer; transition: 0.2s; 
        }
        .list-item:hover { background: #111; }
        .list-thumb { width: 50px; height: 50px; border-radius: 12px; object-fit: cover; background: #222; }
        .tag { font-size: 10px; padding: 3px 8px; border-radius: 6px; background: #222; color: #888; display: inline-block; margin-top: 6px; }
        .tag.saved { background: rgba(245, 158, 11, 0.15); color: var(--gold); }

        /* --- NAV --- */
        .nav { 
            position: absolute; bottom: 0; left: 0; width: 100%; height: 80px; 
            background: rgba(10,10,10,0.95); display: flex; justify-content: space-around; 
            padding-top: 15px; border-top: 1px solid #222; z-index: 4000; 
            backdrop-filter: blur(20px);
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #555; font-size: 10px; font-weight: 600; cursor: pointer; width: 60px; }
        .nav-item i { font-size: 20px; transition: 0.2s; }
        .nav-item.active { color: white; }
        .nav-item.active i { color: var(--primary); transform: translateY(-2px); }

        /* --- MODAL --- */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 5000; display: flex; align-items: flex-end; opacity: 0; pointer-events: none; transition: 0.3s; }
        .modal.open { opacity: 1; pointer-events: auto; }
        .sheet { background: #141414; width: 100%; max-width: 600px; margin: 0 auto; border-radius: 24px 24px 0 0; padding: 24px; transform: translateY(100%); transition: 0.3s var(--ease); border-top: 1px solid #333; }
        .modal.open .sheet { transform: translateY(0); }
        .inp { width: 100%; background: #222; border: 1px solid #333; padding: 14px; border-radius: 12px; margin-bottom: 10px; color: white; font-family: var(--font); }
        .btn-main { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 14px; font-weight: 700; margin-top: 10px; cursor: pointer; }

        /* --- LOADER --- */
        .loader { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 30px; border: 1px solid #333; z-index: 2000; display: none; color: white; font-size: 12px; gap: 10px; align-items: center; }
        .loader.active { display: flex; }

        /* --- CREATION --- */
        .creation-ui { position: absolute; bottom: 100px; left: 0; right: 0; text-align: center; pointer-events: none; opacity: 0; z-index: 2000; transition: 0.3s; }
        .creation-ui.active { opacity: 1; pointer-events: auto; }
        .btn-confirm { background: var(--accent); color: white; padding: 12px 24px; border-radius: 30px; border: none; font-weight: bold; box-shadow: 0 10px 30px rgba(239, 68, 68, 0.4); cursor: pointer; pointer-events: auto; }
        .pin-target { margin-top: -24px; margin-left: -24px; pointer-events: none; }
        .pin-target .pin-body { width: 48px; height: 48px; background: var(--accent); border: 3px solid white; box-shadow: 0 0 30px rgba(239, 68, 68, 0.6); }

    </style>
</head>
<body>

    <!-- MAP LAYER -->
    <div id="map"></div>

    <!-- LOADER -->
    <div class="loader" id="loader"><i class="fa-solid fa-spinner fa-spin" style="color:var(--primary)"></i> <span>Recherche en cours...</span></div>

    <!-- BRANDING & SEARCH WRAPPER -->
    <div class="hud-wrapper" id="hud">
        <!-- BRAND BAR -->
        <div class="brand-bar">
            <div class="brand-logo">THE HUNTER <span>v20</span></div>
            <i class="fa-solid fa-crosshairs" style="color:var(--accent)"></i>
        </div>
        
        <!-- SEARCH & FILTER -->
        <div class="controls-row">
            <!-- VILLE -->
            <div class="search-group" style="flex: 2;">
                <div class="pill">
                    <i class="fa-solid fa-location-dot"></i>
                    <input type="text" id="inp-city" placeholder="Ville..." autocomplete="off">
                </div>
                <div class="suggestions-list" id="sugg-list"></div>
            </div>
            <!-- FILTRE -->
            <div class="search-group" style="flex: 1.5;">
                <div class="pill">
                    <i class="fa-solid fa-filter" style="color:var(--primary)"></i>
                    <input type="text" id="inp-filter" placeholder="Sushi, Bar..." oninput="App.applyFilters()">
                </div>
            </div>
        </div>
    </div>

    <!-- MAP CONTROLS -->
    <div class="side-stack" id="side-ui">
        <div class="btn-round white" onclick="App.startCreation()"><i class="fa-solid fa-plus"></i></div>
        <div class="btn-round" onclick="App.locate()"><i class="fa-solid fa-location-arrow"></i></div>
    </div>

    <!-- CREATION MODE -->
    <div class="creation-ui" id="creation-ui">
        <button class="btn-confirm" onclick="App.confirmCreation()">VALIDER CE LIEU</button>
        <div style="margin-top:10px;"><span onclick="App.cancelCreation()" style="background:rgba(0,0,0,0.6); padding:5px 10px; border-radius:10px; font-size:12px; cursor:pointer;">Annuler</span></div>
    </div>

    <!-- BANNER -->
    <div class="banner" id="banner">
        <img src="" class="banner-img" id="ban-img">
        <div class="banner-info">
            <h3 class="banner-title" id="ban-title">...</h3>
            <div class="banner-addr" id="ban-addr">...</div>
        </div>
        <button class="btn-fab" id="btn-action" onclick="App.openModal()"><i class="fa-solid fa-pen"></i></button>
    </div>

    <!-- LIST VIEW PANEL -->
    <div class="list-view" id="view-list">
        <div class="list-header">
            <span>Carnet</span>
            <i class="fa-solid fa-xmark" style="font-size:20px; cursor:pointer; opacity:0.5;" onclick="App.nav('map')"></i>
        </div>
        <div class="list-scroll" id="list-container"></div>
    </div>

    <!-- MODAL EDIT -->
    <div class="modal" id="modal">
        <div class="sheet">
            <h3 style="margin-top:0">Détails du Lieu</h3>
            <input type="text" class="inp" id="edit-name" placeholder="Nom du lieu">
            <input type="text" class="inp" id="edit-addr" placeholder="Adresse">
            <textarea class="inp" id="edit-memo" rows="3" placeholder="Notes persos..."></textarea>
            <button class="btn-main" onclick="App.save()">ENREGISTRER</button>
            <button class="btn-main" onclick="App.removePlace()" style="background:#222; color:#ef4444; margin-top:8px">SUPPRIMER</button>
            <div style="text-align:center; margin-top:15px; opacity:0.5; font-size:12px; cursor:pointer" onclick="App.closeModal()">Fermer</div>
        </div>
    </div>

    <!-- NAVIGATION -->
    <nav class="nav" id="nav">
        <div class="nav-item active" onclick="App.nav('map')" id="nav-map"><i class="fa-solid fa-map"></i><span>Explorer</span></div>
        <div class="nav-item" onclick="App.nav('list')" id="nav-list"><i class="fa-solid fa-book-bookmark"></i><span>Carnet</span></div>
    </nav>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const App = (() => {
            let map, db;
            let markers = [];
            let allPlaces = []; 
            let savedPlaces = [];
            let selectedPlace = null;
            let creationMarker = null;
            let cityDebounce;
            let isScanning = false;

            const normalize = (str) => str ? str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase() : "";
            const getImage = (id) => `https://picsum.photos/seed/${id}/150/150`;

            const init = async () => {
                await initDB();
                await loadSaved();
                initMap();
                
                // Event Listeners
                document.getElementById('inp-city').addEventListener('input', (e) => fetchCitySuggestions(e.target.value));
                document.getElementById('modal').addEventListener('click', (e) => { if(e.target.id === 'modal') closeModal(); });
            };

            const initDB = () => new Promise(r => {
                const req = indexedDB.open('HunterV20', 1);
                req.onupgradeneeded = e => e.target.result.createObjectStore('places', {keyPath: 'id'});
                req.onsuccess = e => { db = e.target.result; r(); };
            });

            const loadSaved = () => new Promise(r => {
                db.transaction('places', 'readonly').objectStore('places').getAll().onsuccess = e => {
                    savedPlaces = e.target.result || [];
                    r();
                };
            });

            const initMap = () => {
                map = L.map('map', {zoomControl: false, attributionControl: false}).setView([48.8566, 2.3522], 13);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 20 }).addTo(map);
                
                updateAll([]);
                if(savedPlaces.length === 0) setTimeout(() => scan(true), 1500);
                else setTimeout(() => {
                    if(savedPlaces.length > 0) {
                        const group = new L.featureGroup(markers.map(m=>m.marker));
                        map.fitBounds(group.getBounds(), {padding: [50,50]});
                    }
                }, 500);

                map.on('moveend', () => { if(map.getZoom()>=14) scan(false); });
            };

            // --- FILTER LOGIC (Improved) ---
            const applyFilters = () => {
                const term = normalize(document.getElementById('inp-filter').value);
                
                markers.forEach(obj => {
                    const p = obj.data;
                    const isSaved = savedPlaces.find(s => s.id === p.id);
                    
                    // Match Logic: If no term, everything is visible. If term, must match blob.
                    const isMatch = !term || p.blob.includes(term);
                    
                    // Visual States
                    const div = obj.marker.getElement();
                    if(!div) return; // Not rendered yet
                    
                    if (isMatch) {
                        // Highlighted State
                        div.classList.remove('ghost');
                        div.style.zIndex = isSaved ? 300 : 100; // Bring matches to front
                        
                        // Update color based on match
                        if(term) div.querySelector('.pin-wrap').classList.add('pin-match');
                        else div.querySelector('.pin-wrap').classList.remove('pin-match');
                        
                    } else {
                        // Ghost State (Filtered out)
                        if (isSaved) {
                            // Saved items are never completely hidden, just dimmed if not matching
                             div.classList.add('ghost'); 
                        } else {
                            // Non-saved items are heavily ghosted
                            div.classList.add('ghost');
                        }
                        div.style.zIndex = 10; // Send to back
                    }
                });
            };

            // --- SCANNING ---
            const scan = async (manual) => {
                if(isScanning) return;
                isScanning = true;
                setLoading(manual);

                const b = map.getBounds();
                const q = `[out:json][timeout:10];node["amenity"~"restaurant|bar|cafe|fast_food|pub"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});out 40;`;

                try {
                    const r = await fetch('https://overpass-api.de/api/interpreter', {method:'POST', body:q});
                    const d = await r.json();
                    
                    const apiData = d.elements.map(el => {
                        const t = el.tags;
                        const addr = [t['addr:housenumber'], t['addr:street']].filter(Boolean).join(' ') || "";
                        return {
                            id: el.id, name: t.name || "Inconnu", addr: addr,
                            blob: normalize(`${t.name} ${addr} ${t.cuisine} ${t.amenity}`),
                            lat: el.lat, lon: el.lon, img: getImage(el.id),
                            type: t.amenity
                        };
                    });
                    updateAll(apiData);
                } catch(e) {}
                setLoading(false); isScanning = false;
            };

            const updateAll = (apiData) => {
                // Merge data
                allPlaces = [...savedPlaces];
                apiData.forEach(p => { if(!savedPlaces.find(s=>s.id === p.id)) allPlaces.push(p); });
                
                // Rebuild Markers (Clean slate needed for complex state)
                markers.forEach(m => map.removeLayer(m.marker));
                markers = [];

                allPlaces.forEach(p => {
                    const isSaved = savedPlaces.find(s => s.id === p.id);
                    
                    const div = document.createElement('div');
                    div.className = `pin-wrap ${isSaved ? 'pin-saved' : ''}`;
                    
                    let icon = 'fa-utensils';
                    if(p.type === 'bar' || p.type === 'pub') icon = 'fa-martini-glass';
                    if(p.type === 'cafe') icon = 'fa-mug-hot';

                    div.innerHTML = `<div class="pin-body"><i class="fa-solid ${isSaved ? 'fa-check' : icon}"></i></div>`;
                    
                    const m = L.marker([p.lat, p.lon], {
                        icon: L.divIcon({className:'c', html:div.outerHTML, iconAnchor:[20,40]})
                    }).addTo(map);
                    
                    m.on('click', () => select(p, isSaved));
                    markers.push({id:p.id, marker:m, data:p});
                });
                
                applyFilters(); // Re-apply current filter
            };

            // --- CITY SEARCH ---
            const fetchCitySuggestions = (val) => {
                const list = document.getElementById('sugg-list');
                clearTimeout(cityDebounce);
                if(!val || val.length < 3) { list.classList.remove('active'); return; }

                cityDebounce = setTimeout(async () => {
                    const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${val}&addressdetails=1&limit=4&accept-language=fr`);
                    const data = await r.json();
                    list.innerHTML = '';
                    if(data.length) {
                        data.forEach(item => {
                            const d = document.createElement('div');
                            d.className = 'sugg-item';
                            d.innerHTML = `<i class="fa-solid fa-map-pin" style="color:#666"></i> ${item.display_name.split(',')[0]} <span style="opacity:0.5;font-size:11px">${item.address.country||''}</span>`;
                            d.onclick = () => {
                                document.getElementById('inp-city').value = item.display_name.split(',')[0];
                                list.classList.remove('active');
                                map.setView([item.lat, item.lon], 15);
                            }
                            list.appendChild(d);
                        });
                        list.classList.add('active');
                    }
                }, 400);
            };

            // --- LIST & GROUPING ---
            const renderList = () => {
                const c = document.getElementById('list-container');
                if(!savedPlaces.length) { c.innerHTML = '<div style="padding:20px;text-align:center;color:#666">Carnet vide.</div>'; return; }
                
                // Group by City (Basic Heuristic)
                const groups = {};
                savedPlaces.forEach(p => {
                    let city = "Divers";
                    if(p.addr && p.addr.length > 5) {
                        // Mockup extraction. Real extraction needs geocoding details stored.
                        // Here we assume if filtering works, we group by generic "Saved" if no city field.
                        // Let's create a fake grouping for UI demo
                        city = "Mes Favoris"; 
                    }
                    if(!groups[city]) groups[city] = [];
                    groups[city].push(p);
                });

                let html = '';
                for(const [city, items] of Object.entries(groups)) {
                    html += `<div class="city-group"><div class="city-header">${city}</div>`;
                    items.forEach(s => {
                        html += `
                        <div class="list-item" onclick="App.goto(${s.id})">
                            <img src="${s.img}" class="list-thumb">
                            <div style="flex:1">
                                <div style="font-weight:700">${s.name}</div>
                                <div style="font-size:12px;color:#888">${s.addr}</div>
                                <div class="tag saved"><i class="fa-solid fa-check"></i> Enregistré</div>
                            </div>
                        </div>`;
                    });
                    html += '</div>';
                }
                c.innerHTML = html;
            };

            // --- STANDARD UI FUNCTIONS ---
            const locate = () => navigator.geolocation.getCurrentPosition(p=>map.setView([p.coords.latitude, p.coords.longitude], 16));
            
            const startCreation = () => {
                document.getElementById('hud').style.display='none';
                document.getElementById('side-ui').style.display='none';
                document.getElementById('creation-ui').classList.add('active');
                creationMarker = L.marker(map.getCenter(), {draggable:true, icon: L.divIcon({className:'pin-target', html:'<div class="pin-body"></div>'}), zIndexOffset:10000}).addTo(map);
            };
            
            const cancelCreation = () => {
                if(creationMarker) map.removeLayer(creationMarker);
                creationMarker = null;
                document.getElementById('hud').style.display='flex';
                document.getElementById('side-ui').style.display='flex';
                document.getElementById('creation-ui').classList.remove('active');
            };

            const confirmCreation = async () => {
                if(!creationMarker) return;
                const pos = creationMarker.getLatLng();
                const newPlace = { id: Date.now(), name: "Nouveau Lieu", addr: "Position épinglée", blob: "nouveau lieu", lat: pos.lat, lon: pos.lng, img: getImage(Date.now()), type: 'custom' };
                cancelCreation();
                savedPlaces.push(newPlace);
                updateAll([]);
                select(newPlace, newPlace);
                openModal();
            };

            const select = (p, saved) => {
                selectedPlace = p;
                map.flyTo([p.lat - 0.002, p.lon], 16); // Offset for banner
                document.getElementById('ban-title').innerText = p.name;
                document.getElementById('ban-addr').innerText = p.addr;
                document.getElementById('ban-img').src = saved?.customImg || p.img;
                const b = document.getElementById('banner');
                if(saved) b.classList.add('saved'); else b.classList.remove('saved');
                b.classList.add('active');
                document.getElementById('btn-action').innerHTML = saved ? '<i class="fa-solid fa-pen"></i>' : '<i class="fa-solid fa-plus"></i>';
            };

            const openModal = () => {
                const s = savedPlaces.find(x=>x.id===selectedPlace.id) || selectedPlace;
                document.getElementById('edit-name').value = s.name;
                document.getElementById('edit-addr').value = s.addr;
                document.getElementById('edit-memo').value = s.memo || "";
                document.getElementById('modal').classList.add('open');
            };
            const closeModal = () => document.getElementById('modal').classList.remove('open');
            
            const save = () => {
                const name = document.getElementById('edit-name').value;
                const entry = { ...selectedPlace, name, addr: document.getElementById('edit-addr').value, memo: document.getElementById('edit-memo').value, blob: normalize(name) };
                const tx = db.transaction('places', 'readwrite');
                tx.objectStore('places').put(entry);
                
                const idx = savedPlaces.findIndex(s=>s.id===entry.id);
                if(idx>-1) savedPlaces[idx]=entry; else savedPlaces.push(entry);
                
                closeModal(); updateAll([]); select(entry, entry);
            };

            const removePlace = () => {
                if(!confirm('Supprimer ?')) return;
                db.transaction('places', 'readwrite').objectStore('places').delete(selectedPlace.id);
                savedPlaces = savedPlaces.filter(s=>s.id!==selectedPlace.id);
                closeModal(); document.getElementById('banner').classList.remove('active');
                updateAll([]);
            };

            const nav = (view) => {
                document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
                document.getElementById('nav-'+view).classList.add('active');
                if(view==='list') { renderList(); document.getElementById('view-list').classList.add('active'); }
                else document.getElementById('view-list').classList.remove('active');
            };

            const goto = (id) => {
                const s = savedPlaces.find(x=>x.id===id);
                if(s) { nav('map'); select(s, s); }
            };

            const setLoading = (show) => {
                const l = document.getElementById('loader');
                if(show) l.classList.add('active'); else l.classList.remove('active');
            };

            return { init, scan, locate, applyFilters, startCreation, cancelCreation, confirmCreation, openModal, closeModal, save, removePlace, nav, goto };
        })();

        window.onload = App.init;
    </script>
</body>
</html>
