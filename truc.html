<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>Guide Michelin SIL</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Fonts: Playfair (Titre) & Inter (Texte) -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;900&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        /* --- VARIABLES THEME --- */
        :root {
            --primary: #bd0000; /* Rouge Michelin */
            --bg: #ffffff;
            --text: #1a1a1a;
            --text-light: #666666;
            --border: #e0e0e0;
            --shadow: 0 4px 20px rgba(0,0,0,0.1);
            --font-title: 'Playfair Display', serif;
            --font-body: 'Inter', sans-serif;
            --z-map: 1;
            --z-ui: 1000;
            --z-modal: 5000;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        
        /* Inputs doivent être sélectionnables */
        input, textarea { user-select: text !important; -webkit-user-select: text !important; }

        body { 
            margin: 0; padding: 0; width: 100vw; height: 100dvh; 
            background: var(--bg); color: var(--text); font-family: var(--font-body);
            overflow: hidden; position: fixed;
        }

        /* --- MAP FIX (Position Absolue) --- */
        #map { 
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; 
            z-index: var(--z-map); background: #e5e5e5; 
        }
        .leaflet-container { font-family: var(--font-body); }
        .leaflet-control-attribution { display: none; }

        /* --- UI LAYER --- */
        .ui-layer {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            z-index: var(--z-ui); pointer-events: none;
            display: flex; flex-direction: column;
        }

        /* --- HEADER --- */
        .header-wrapper {
            padding: max(15px, env(safe-area-inset-top)) 15px 10px;
            background: linear-gradient(180deg, rgba(255,255,255,0.95) 50%, rgba(255,255,255,0) 100%);
            pointer-events: auto; display: flex; flex-direction: column; gap: 10px;
        }

        .brand-badge {
            background: #fff; border: 1px solid var(--border); padding: 8px 16px; 
            border-radius: 30px; align-self: center; box-shadow: var(--shadow);
            display: flex; align-items: center; gap: 8px;
            font-family: var(--font-title); font-weight: 900; color: var(--primary); font-size: 16px;
        }

        .search-row { display: flex; gap: 10px; max-width: 600px; margin: 0 auto; width: 100%; }
        
        .pill {
            flex: 1; height: 46px; background: #fff; border: 1px solid var(--border);
            border-radius: 12px; display: flex; align-items: center; padding: 0 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: 0.2s;
        }
        .pill:focus-within { border-color: var(--primary); transform: translateY(-1px); }
        .pill i { color: #999; margin-right: 10px; font-size: 14px; }
        .pill input { 
            border: none; background: transparent; width: 100%; font-family: var(--font-body);
            font-size: 14px; font-weight: 600; color: var(--text);
        }

        .suggestions-box {
            background: white; border-radius: 12px; margin-top: 5px; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.15); max-height: 200px; overflow-y: auto;
            display: none; pointer-events: auto; width: 100%; max-width: 600px; align-self: center;
        }
        .suggestions-box.active { display: block; }
        .sugg-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; justify-content: space-between; font-size: 13px; }
        .sugg-item:hover { background: #f9f9f9; }

        /* --- SIDE CONTROLS --- */
        .controls-stack {
            position: absolute; bottom: 110px; right: 15px; pointer-events: auto;
            display: flex; flex-direction: column; gap: 12px;
        }
        .fab {
            width: 48px; height: 48px; background: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); cursor: pointer; color: #333;
            transition: 0.2s; border: 1px solid var(--border);
        }
        .fab:active { transform: scale(0.9); }
        .fab i { font-size: 18px; }
        .fab.primary { color: var(--primary); }

        /* --- BOTTOM BANNER --- */
        .banner {
            position: absolute; bottom: 95px; left: 15px; right: 15px; margin: 0 auto; max-width: 500px;
            background: white; padding: 12px; border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15); border: 1px solid var(--border);
            display: flex; align-items: center; gap: 12px; pointer-events: auto;
            transform: translateY(150%); transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .banner.active { transform: translateY(0); }
        
        .banner-img { width: 50px; height: 50px; border-radius: 10px; background: #eee; object-fit: cover; }
        .banner-content { flex: 1; overflow: hidden; }
        .banner-title { font-family: var(--font-title); font-weight: 700; font-size: 16px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .banner-rating { color: var(--primary); font-weight: 800; font-size: 12px; display: flex; align-items: center; gap: 4px; margin-top: 2px; }
        
        .btn-edit { width: 36px; height: 36px; border-radius: 10px; background: #333; color: white; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        /* --- CREATION UI --- */
        .creation-ui {
            position: absolute; bottom: 100px; left: 0; right: 0; 
            display: flex; flex-direction: column; align-items: center; pointer-events: none;
            opacity: 0; transition: 0.3s;
        }
        .creation-ui.active { opacity: 1; pointer-events: auto; }
        .btn-validate {
            background: var(--primary); color: white; padding: 12px 24px; border-radius: 30px;
            font-weight: 700; border: none; box-shadow: 0 5px 20px rgba(189,0,0,0.4);
            font-size: 14px; cursor: pointer; margin-bottom: 10px;
        }
        .btn-cancel { background: white; padding: 6px 14px; border-radius: 20px; font-size: 12px; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }

        /* --- MARKERS --- */
        .pin-wrap { width: 32px; height: 32px; pointer-events: none; transition: 0.3s; }
        .pin-wrap.ghost { opacity: 0.2; filter: grayscale(1); transform: scale(0.8); }
        .pin-head {
            width: 32px; height: 32px; background: #444; border: 2px solid white;
            border-radius: 50% 50% 0 50%; transform: rotate(45deg);
            box-shadow: 0 3px 10px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;
            pointer-events: auto;
        }
        .pin-head i { transform: rotate(-45deg); color: white; font-size: 12px; }
        
        .pin-wrap.saved .pin-head { background: var(--primary); z-index: 100; box-shadow: 0 4px 15px rgba(189,0,0,0.4); }
        
        /* Target Marker */
        .pin-target { margin-left: -20px; margin-top: -20px; pointer-events: none; z-index: 2000 !important; }
        .pin-target .pin-head { width: 40px; height: 40px; background: var(--primary); border: 3px solid white; }

        /* --- LIST OVERLAY --- */
        .list-overlay {
            position: fixed; inset: 0; background: #f8f9fa; z-index: 4500;
            transform: translateY(100%); transition: 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex; flex-direction: column; pointer-events: auto;
        }
        .list-overlay.open { transform: translateY(0); }
        
        .list-nav { padding: 40px 20px 15px; background: white; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .list-nav h2 { margin: 0; font-family: var(--font-title); color: var(--primary); }
        .list-close { font-size: 24px; cursor: pointer; color: #333; padding: 5px; }
        
        .list-content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; }
        .list-card {
            background: white; border-radius: 12px; padding: 12px; margin-bottom: 12px;
            display: flex; gap: 12px; border: 1px solid var(--border); cursor: pointer;
        }
        .list-card img { width: 70px; height: 70px; border-radius: 8px; object-fit: cover; background: #eee; }

        /* --- MODAL EDIT --- */
        .modal { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: var(--z-modal);
            display: flex; align-items: flex-end; opacity: 0; pointer-events: none; transition: 0.3s;
            backdrop-filter: blur(4px);
        }
        .modal.open { opacity: 1; pointer-events: auto; }
        .sheet {
            background: white; width: 100%; max-width: 600px; margin: 0 auto; border-radius: 24px 24px 0 0;
            max-height: 90vh; display: flex; flex-direction: column; transform: translateY(100%); transition: 0.3s;
        }
        .modal.open .sheet { transform: translateY(0); }
        .sheet-scroll { overflow-y: auto; padding: 24px; padding-bottom: 50px; }

        .form-section { margin-bottom: 20px; }
        .lbl { font-size: 12px; font-weight: 700; color: #999; text-transform: uppercase; margin-bottom: 8px; display: block; }
        .inp-text { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; background: #fcfcfc; font-family: var(--font-body); margin-bottom: 10px; }
        
        /* Note UI */
        .score-circle {
            width: 80px; height: 80px; background: var(--primary); color: white; border-radius: 50%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            margin: 0 auto 20px; font-family: var(--font-title);
        }
        .score-val { font-size: 28px; font-weight: 700; line-height: 1; }
        .score-lbl { font-size: 10px; font-family: var(--font-body); opacity: 0.8; }
        
        .range-wrap { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .range-wrap span { width: 70px; font-size: 13px; font-weight: 600; }
        input[type=range] { flex: 1; accent-color: var(--primary); }
        .val-disp { font-weight: 700; color: var(--primary); width: 25px; text-align: right; }

        /* Photo Upload */
        .photo-area {
            width: 100%; height: 140px; border: 2px dashed #ddd; border-radius: 12px;
            display: flex; align-items: center; justify-content: center; margin-bottom: 20px;
            cursor: pointer; background: #fafafa; position: relative; overflow: hidden;
        }
        .photo-area img { width: 100%; height: 100%; object-fit: cover; position: absolute; }
        .photo-label { z-index: 2; color: #888; display: flex; flex-direction: column; align-items: center; gap: 5px; font-size: 12px; }

        .btn-block { width: 100%; padding: 15px; border-radius: 12px; border: none; font-weight: 700; font-size: 15px; cursor: pointer; margin-top: 10px; }
        .btn-save { background: var(--primary); color: white; box-shadow: 0 5px 15px rgba(189,0,0,0.3); }
        .btn-del { background: transparent; color: #ef4444; margin-top: 5px; font-size: 13px; }

        /* --- NAV --- */
        .nav-bar {
            position: absolute; bottom: 0; left: 0; right: 0; height: 80px; background: white;
            border-top: 1px solid var(--border); display: flex; justify-content: space-around;
            padding-top: 12px; z-index: 4000; padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #aaa; cursor: pointer; width: 70px; }
        .nav-item.active { color: var(--primary); }
        .nav-item i { font-size: 20px; }
        .nav-item span { font-size: 10px; font-weight: 600; }

    </style>
</head>
<body>

    <!-- 1. MAP LAYER (Absolute priority) -->
    <div id="map"></div>

    <!-- 2. UI LAYER -->
    <div class="ui-layer">
        
        <!-- HEADER -->
        <div class="header-wrapper" id="hud">
            <div class="brand-badge"><i class="fa-solid fa-star"></i> Guide Michelin SIL</div>
            <div class="search-row">
                <div class="pill">
                    <i class="fa-solid fa-location-arrow"></i>
                    <input type="text" id="inp-city" placeholder="Ville...">
                </div>
                <div class="pill">
                    <i class="fa-solid fa-magnifying-glass"></i>
                    <input type="text" id="inp-filter" placeholder="Nom du restaurant..." oninput="App.applyFilters()">
                </div>
            </div>
            <!-- Suggestion dropdown inside header flow -->
            <div class="suggestions-box" id="sugg-box"></div>
        </div>

        <!-- SIDE CONTROLS -->
        <div class="controls-stack" id="side-ctrl">
            <div class="fab primary" onclick="App.startCreation()"><i class="fa-solid fa-plus"></i></div>
            <div class="fab" onclick="App.locate()"><i class="fa-solid fa-crosshairs"></i></div>
        </div>

        <!-- CREATION UI -->
        <div class="creation-ui" id="creation-ui">
            <button class="btn-validate" onclick="App.confirmCreation()">VALIDER L'EMPLACEMENT</button>
            <div class="btn-cancel" onclick="App.cancelCreation()">Annuler</div>
        </div>

        <!-- BANNER -->
        <div class="banner" id="banner">
            <img src="" class="banner-img" id="ban-img">
            <div class="banner-content">
                <div class="banner-title" id="ban-title">...</div>
                <div class="banner-rating" id="ban-rating"></div>
            </div>
            <button class="btn-edit" id="btn-edit" onclick="App.openModal()"><i class="fa-solid fa-pen"></i></button>
        </div>

    </div>

    <!-- 3. OVERLAYS (Outside UI Layer for interaction) -->
    
    <!-- LIST OVERLAY -->
    <div class="list-overlay" id="list-overlay">
        <div class="list-nav">
            <h2>Mon Carnet</h2>
            <i class="fa-solid fa-xmark list-close" onclick="App.nav('map')"></i>
        </div>
        <div class="list-content" id="list-container"></div>
    </div>

    <!-- MODAL FORM -->
    <div class="modal" id="modal">
        <div class="sheet">
            <div class="sheet-scroll">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                    <h2 style="margin:0; font-family:var(--font-title)">Le Restaurant</h2>
                    <i class="fa-solid fa-xmark" onclick="App.closeModal()" style="font-size:24px; cursor:pointer; padding:5px"></i>
                </div>

                <!-- PHOTO -->
                <div class="photo-area" onclick="document.getElementById('file-inp').click()">
                    <img id="edit-img-preview" style="display:none">
                    <div class="photo-label" id="edit-img-lbl">
                        <i class="fa-solid fa-camera" style="font-size:24px"></i>
                        <span>Ajouter une photo</span>
                    </div>
                </div>
                <input type="file" id="file-inp" accept="image/*" hidden onchange="App.handleImage(this)">

                <div class="form-section">
                    <label class="lbl">Informations</label>
                    <input type="text" class="inp-text" id="edit-name" placeholder="Nom du restaurant">
                    <input type="text" class="inp-text" id="edit-addr" placeholder="Adresse complète">
                </div>

                <div class="form-section">
                    <label class="lbl">La Note du Chef</label>
                    <div class="score-circle">
                        <div class="score-val" id="score-total">0.0</div>
                        <div class="score-lbl">/ 10</div>
                    </div>

                    <div class="range-wrap">
                        <span>Qualité/Prix</span>
                        <input type="range" min="0" max="10" step="0.5" id="rng-qp" oninput="App.calcScore()">
                        <div class="val-disp" id="val-qp">5</div>
                    </div>
                    <div class="range-wrap">
                        <span>Goût</span>
                        <input type="range" min="0" max="10" step="0.5" id="rng-taste" oninput="App.calcScore()">
                        <div class="val-disp" id="val-taste">5</div>
                    </div>
                    <div class="range-wrap">
                        <span>Ambiance</span>
                        <input type="range" min="0" max="10" step="0.5" id="rng-vibe" oninput="App.calcScore()">
                        <div class="val-disp" id="val-vibe">5</div>
                    </div>
                </div>

                <div class="form-section">
                    <label class="lbl">Budget (€)</label>
                    <div style="display:flex; gap:10px">
                        <input type="number" class="inp-text" id="price-min" placeholder="Min">
                        <input type="number" class="inp-text" id="price-max" placeholder="Max">
                    </div>
                </div>

                <div class="form-section">
                    <label class="lbl">Notes Perso</label>
                    <textarea class="inp-text" id="edit-memo" rows="3" placeholder="Plats, code wifi, avis..."></textarea>
                </div>

                <button class="btn-block btn-save" onclick="App.save()">ENREGISTRER</button>
                <button class="btn-block btn-del" onclick="App.removePlace()">Supprimer ce lieu</button>
            </div>
        </div>
    </div>

    <!-- NAV BAR -->
    <div class="nav-bar">
        <div class="nav-item active" id="nav-map" onclick="App.nav('map')">
            <i class="fa-solid fa-map-location-dot"></i> <span>Carte</span>
        </div>
        <div class="nav-item" id="nav-list" onclick="App.nav('list')">
            <i class="fa-solid fa-book-open"></i> <span>Carnet</span>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const App = (() => {
            let map, db;
            let markers = [];
            let allPlaces = [], savedPlaces = [];
            let selectedPlace = null;
            let creationMarker = null;
            let currentImg = null;
            let searchTimeout;

            const DEFAULT_IMG = "https://images.unsplash.com/photo-1552566626-52f8b828add9?auto=format&fit=crop&w=300&q=80";

            // --- INIT ---
            const init = async () => {
                initMap(); // Map first for visual speed
                await initDB();
                await loadSaved();
                updateMapMarkers(); // Refresh with DB data

                // Events
                document.getElementById('inp-city').addEventListener('input', e => searchCity(e.target.value));
            };

            // --- DATABASE ---
            const initDB = () => new Promise(resolve => {
                const r = indexedDB.open('GuideMichelinDB', 1);
                r.onupgradeneeded = e => e.target.result.createObjectStore('places', {keyPath: 'id'});
                r.onsuccess = e => { db = e.target.result; resolve(); };
                r.onerror = () => resolve(); // Fail grace
            });
            const loadSaved = () => new Promise(resolve => {
                if(!db) return resolve();
                db.transaction('places', 'readonly').objectStore('places').getAll().onsuccess = e => {
                    savedPlaces = e.target.result || [];
                    resolve();
                };
            });

            // --- MAP ---
            const initMap = () => {
                map = L.map('map', {zoomControl: false, attributionControl: false}).setView([48.8566, 2.3522], 13);
                
                // CARTO POSITRON (Light & Clean)
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                    maxZoom: 20,
                    subdomains: 'abcd'
                }).addTo(map);

                // Auto Scan on move
                map.on('moveend', () => { if(map.getZoom() > 14) scan(); });
                // Initial Scan delay
                setTimeout(() => scan(), 1000);
            };

            // --- SCANNING (Overpass) ---
            let isScanning = false;
            const scan = async () => {
                if(isScanning) return;
                isScanning = true;
                
                const b = map.getBounds();
                const q = `[out:json][timeout:5];node["amenity"~"restaurant|bar|cafe"](${b.getSouth()},${b.getWest()},${b.getNorth()},${b.getEast()});out 30;`;
                
                try {
                    const res = await fetch('https://overpass-api.de/api/interpreter', {method:'POST', body:q});
                    const data = await res.json();
                    
                    const newItems = data.elements.map(el => ({
                        id: el.id, 
                        name: el.tags.name || "Inconnu",
                        addr: (el.tags['addr:street'] || "") + " " + (el.tags['addr:city'] || ""),
                        lat: el.lat, lon: el.lon,
                        saved: false
                    }));
                    
                    // Merge
                    allPlaces = [...savedPlaces]; // Start with saved
                    newItems.forEach(ni => {
                        if(!savedPlaces.find(s => s.id === ni.id)) allPlaces.push(ni);
                    });
                    
                    updateMapMarkers();
                } catch(e) {}
                isScanning = false;
            };

            const updateMapMarkers = () => {
                // Clear
                markers.forEach(m => map.removeLayer(m.marker));
                markers = [];
                
                applyFilters(); // Filter & Rebuild
            };

            const applyFilters = () => {
                const term = document.getElementById('inp-filter').value.toLowerCase();

                // Clean existing layer
                markers.forEach(m => map.removeLayer(m.marker));
                markers = [];

                allPlaces.forEach(p => {
                    const isSaved = savedPlaces.find(s => s.id === p.id);
                    
                    // STRICT FILTER: Match Name OR Saved
                    // If filter exists: Show matches. If not matches but saved -> show ghosted? No, let's show ghosted.
                    const match = !term || (p.name && p.name.toLowerCase().includes(term));
                    
                    // Marker HTML
                    const div = document.createElement('div');
                    div.className = `pin-wrap ${isSaved ? 'saved' : ''} ${!match ? 'ghost' : ''}`;
                    // If not match and not saved, don't show to avoid clutter? 
                    // Let's show filtered items as very faint ghosts
                    
                    div.innerHTML = `<div class="pin-head"><i class="fa-solid ${isSaved?'fa-star':'fa-utensils'}"></i></div>`;
                    
                    const m = L.marker([p.lat, p.lon], {
                        icon: L.divIcon({className:'c', html:div.outerHTML, iconAnchor:[16,32]}),
                        zIndexOffset: isSaved ? 1000 : 0
                    }).addTo(map);

                    m.on('click', () => selectPlace(p, isSaved));
                    markers.push({marker: m});
                });
            };

            // --- CITY SEARCH ---
            const searchCity = (val) => {
                const box = document.getElementById('sugg-box');
                clearTimeout(searchTimeout);
                if(val.length < 3) { box.classList.remove('active'); return; }

                searchTimeout = setTimeout(async () => {
                    const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${val}&limit=3&accept-language=fr`);
                    const d = await r.json();
                    box.innerHTML = '';
                    d.forEach(city => {
                        const div = document.createElement('div');
                        div.className = 'sugg-item';
                        div.innerHTML = `<span>${city.display_name.split(',')[0]}</span>`;
                        div.onclick = () => {
                            map.setView([city.lat, city.lon], 14);
                            box.classList.remove('active');
                            document.getElementById('inp-city').value = city.display_name.split(',')[0];
                        };
                        box.appendChild(div);
                    });
                    box.classList.add('active');
                }, 500);
            };

            // --- SELECTION & BANNER ---
            const selectPlace = (p, saved) => {
                selectedPlace = saved || p; // Use saved version if exists
                
                // Fly to
                map.flyTo([p.lat - 0.002, p.lon], 16);

                // Update Banner
                document.getElementById('ban-title').innerText = p.name;
                document.getElementById('ban-img').src = selectedPlace.img || DEFAULT_IMG;
                
                const score = selectedPlace.score?.total;
                document.getElementById('ban-rating').innerHTML = score 
                    ? `<i class="fa-solid fa-star"></i> ${score} / 10` 
                    : `<span style="color:#999;font-weight:400">Non noté</span>`;
                
                document.getElementById('btn-edit').innerHTML = saved ? '<i class="fa-solid fa-pen"></i>' : '<i class="fa-solid fa-plus"></i>';
                
                document.getElementById('banner').classList.add('active');
            };

            // --- CREATION MODE ---
            const startCreation = () => {
                document.getElementById('hud').style.display = 'none';
                document.getElementById('side-ctrl').style.display = 'none';
                document.getElementById('banner').classList.remove('active');
                document.getElementById('creation-ui').classList.add('active');
                
                creationMarker = L.marker(map.getCenter(), {
                    zIndexOffset: 5000,
                    icon: L.divIcon({className:'pin-target', html:'<div class="pin-head"></div>'})
                }).addTo(map);
                
                // Keep marker centered
                map.on('move', () => creationMarker.setLatLng(map.getCenter()));
            };

            const cancelCreation = () => {
                if(creationMarker) map.removeLayer(creationMarker);
                map.off('move');
                document.getElementById('hud').style.display = 'flex';
                document.getElementById('side-ctrl').style.display = 'flex';
                document.getElementById('creation-ui').classList.remove('active');
            };

            const confirmCreation = () => {
                const pos = creationMarker.getLatLng();
                const newObj = {
                    id: Date.now(), name: "", addr: "Position repérée",
                    lat: pos.lat, lon: pos.lng, img: null
                };
                cancelCreation();
                // Select it immediately to allow edit
                selectPlace(newObj, false); 
                openModal();
            };

            // --- MODAL & LOGIC ---
            const openModal = () => {
                const p = selectedPlace;
                
                document.getElementById('edit-name').value = p.name || "";
                document.getElementById('edit-addr').value = p.addr || "";
                document.getElementById('edit-memo').value = p.memo || "";
                document.getElementById('price-min').value = p.price?.min || "";
                document.getElementById('price-max').value = p.price?.max || "";

                // Scores
                const s = p.score || {qp:5, taste:5, vibe:5, total:5};
                document.getElementById('rng-qp').value = s.qp;
                document.getElementById('rng-taste').value = s.taste;
                document.getElementById('rng-vibe').value = s.vibe;
                
                // Image
                currentImg = p.img || DEFAULT_IMG;
                if(p.img) {
                    document.getElementById('edit-img-preview').src = p.img;
                    document.getElementById('edit-img-preview').style.display='block';
                    document.getElementById('edit-img-lbl').style.display='none';
                } else {
                    document.getElementById('edit-img-preview').style.display='none';
                    document.getElementById('edit-img-lbl').style.display='flex';
                }

                calcScore();
                document.getElementById('modal').classList.add('open');
            };

            const calcScore = () => {
                const qp = parseFloat(document.getElementById('rng-qp').value);
                const taste = parseFloat(document.getElementById('rng-taste').value);
                const vibe = parseFloat(document.getElementById('rng-vibe').value);
                
                document.getElementById('val-qp').innerText = qp;
                document.getElementById('val-taste').innerText = taste;
                document.getElementById('val-vibe').innerText = vibe;

                const total = ((qp + taste + vibe) / 3).toFixed(1);
                document.getElementById('score-total').innerText = total;
                return {qp, taste, vibe, total};
            };

            const handleImage = (input) => {
                if(input.files && input.files[0]) {
                    const r = new FileReader();
                    r.onload = e => {
                        currentImg = e.target.result;
                        document.getElementById('edit-img-preview').src = currentImg;
                        document.getElementById('edit-img-preview').style.display='block';
                        document.getElementById('edit-img-lbl').style.display='none';
                    };
                    r.readAsDataURL(input.files[0]);
                }
            };

            const save = () => {
                const name = document.getElementById('edit-name').value || "Sans nom";
                
                const finalObj = {
                    ...selectedPlace,
                    name: name,
                    addr: document.getElementById('edit-addr').value,
                    memo: document.getElementById('edit-memo').value,
                    price: { min: document.getElementById('price-min').value, max: document.getElementById('price-max').value },
                    score: calcScore(),
                    img: currentImg === DEFAULT_IMG ? null : currentImg
                };

                // DB Save
                const tx = db.transaction('places', 'readwrite');
                tx.objectStore('places').put(finalObj);

                // Local Update
                const idx = savedPlaces.findIndex(s=>s.id===finalObj.id);
                if(idx>-1) savedPlaces[idx] = finalObj; else savedPlaces.push(finalObj);
                
                closeModal();
                updateMapMarkers();
                selectPlace(finalObj, finalObj);
            };

            const removePlace = () => {
                if(!confirm("Supprimer ?")) return;
                const tx = db.transaction('places', 'readwrite');
                tx.objectStore('places').delete(selectedPlace.id);
                
                savedPlaces = savedPlaces.filter(s=>s.id !== selectedPlace.id);
                closeModal();
                document.getElementById('banner').classList.remove('active');
                updateMapMarkers();
            };

            const closeModal = () => document.getElementById('modal').classList.remove('open');

            // --- LIST & NAV ---
            const nav = (view) => {
                document.getElementById('nav-map').classList.toggle('active', view==='map');
                document.getElementById('nav-list').classList.toggle('active', view==='list');
                
                if(view === 'list') {
                    renderList();
                    document.getElementById('list-overlay').classList.add('open');
                } else {
                    document.getElementById('list-overlay').classList.remove('open');
                }
            };

            const renderList = () => {
                const c = document.getElementById('list-container');
                if(!savedPlaces.length) { c.innerHTML = '<div style="text-align:center;color:#999;margin-top:40px">Carnet vide.</div>'; return; }
                
                c.innerHTML = savedPlaces.map(s => `
                    <div class="list-card" onclick="App.goto(${s.id})">
                        <img src="${s.img || DEFAULT_IMG}">
                        <div style="flex:1">
                            <div style="font-weight:700; font-size:16px">${s.name}</div>
                            <div style="font-size:12px; color:#666">${s.addr}</div>
                            <div style="margin-top:6px; font-weight:700; color:var(--primary); font-size:12px">
                                <i class="fa-solid fa-star"></i> ${s.score?.total || '-'} / 10
                            </div>
                        </div>
                    </div>
                `).join('');
            };

            const goto = (id) => {
                const s = savedPlaces.find(x=>x.id===id);
                nav('map');
                setTimeout(() => selectPlace(s, s), 400);
            };

            const locate = () => {
                navigator.geolocation.getCurrentPosition(p => {
                    map.setView([p.coords.latitude, p.coords.longitude], 16);
                });
            };

            return { 
                init, searchCity, applyFilters, locate, 
                startCreation, cancelCreation, confirmCreation, 
                openModal, closeModal, save, removePlace, 
                calcScore, handleImage, nav, goto 
            };
        })();

        window.onload = App.init;
    </script>
</body>
</html>
