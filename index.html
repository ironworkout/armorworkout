<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArmorWorkout</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg-dark: #121212;
            --bg-light: #f8f9fa;
            --text-dark: #e0e0e0;
            --text-light: #333333;
            --accent-blue: #00f0ff;
            --accent-pink: #ff00f0;
            --accent-green: #00ff8f;
            --accent-yellow: #fff000;
            --accent-red: #ff3d3d;
            --accent-purple: #b400ff;
            --glow-blue: 0 0 10px rgba(0, 240, 255, 0.7);
            --glow-pink: 0 0 10px rgba(255, 0, 240, 0.7);
            --glow-green: 0 0 10px rgba(0, 255, 143, 0.7);
            --glow-yellow: 0 0 10px rgba(255, 240, 0, 0.7);
            --glow-red: 0 0 10px rgba(255, 61, 61, 0.7);
            --glow-purple: 0 0 10px rgba(180, 0, 255, 0.7);
            --transition: all 0.3s ease;
        }

        body {
            font-family: 'Inter', sans-serif;
            transition: var(--transition);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .dark-theme {
            background-color: var(--bg-dark);
            color: var(--text-dark);
        }

        .light-theme {
            background-color: var(--bg-light);
            color: var(--text-light);
        }

        .timer-circle {
            position: relative;
            width: 300px;
            height: 300px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 2rem auto;
        }

        .timer-outer {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            box-shadow: var(--glow-blue);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .timer-inner {
            position: absolute;
            width: 90%;
            height: 90%;
            border-radius: 50%;
            background-color: var(--bg-dark);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            box-shadow: var(--glow-pink);
        }

        .light-theme .timer-inner {
            background-color: var(--bg-light);
        }

        #time-left {
            font-size: 3rem;
            font-weight: 700;
        }

        #timer-state {
            font-size: 1.2rem;
            margin-top: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .section-hidden {
            display: none !important;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: var(--transition);
        }

        .modal.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-content {
            background-color: var(--bg-dark);
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        .light-theme .modal-content {
            background-color: var(--bg-light);
        }

        .message {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            transform: translateY(100px);
            opacity: 0;
            transition: var(--transition);
            z-index: 1000;
        }

        .message.show {
            transform: translateY(0);
            opacity: 1;
        }

        .message.success {
            background-color: var(--accent-green);
        }

        .message.error {
            background-color: var(--accent-red);
        }

        .message.info {
            background-color: var(--accent-blue);
        }

        .history-item {
            transition: var(--transition);
        }

        .history-item:hover {
            transform: translateX(5px);
        }

        .rep-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .rep-btn {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }

        .rep-value {
            min-width: 2rem;
            text-align: center;
        }

        .nav-btn.active {
            box-shadow: var(--glow-blue);
        }

        .workout-info {
            min-height: 120px;
        }

        @media (max-width: 640px) {
            .timer-circle {
                width: 250px;
                height: 250px;
            }

            #time-left {
                font-size: 2.5rem;
            }

            .modal-content {
                width: 95%;
                padding: 1rem;
            }
        }
    </style>
</head>
<body class="dark-theme">
    <header class="py-4 px-6 shadow-md">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3">
                <i class="fas fa-shield-halved text-3xl text-blue-400"></i>
                <h1 class="text-2xl font-bold">ArmorWorkout</h1>
            </div>
            
            <nav class="flex flex-wrap justify-center gap-2">
                <button id="push-btn" class="nav-btn px-4 py-2 rounded-lg bg-gray-700 text-white disabled:opacity-50">
                    Push
                </button>
                <button id="pull-btn" class="nav-btn px-4 py-2 rounded-lg bg-gray-700 text-white disabled:opacity-50">
                    Pull
                </button>
                <button id="legs-btn" class="nav-btn px-4 py-2 rounded-lg bg-gray-700 text-white disabled:opacity-50">
                    Legs
                </button>
                <button id="history-btn" class="px-4 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700 transition">
                    Historique
                </button>
            </nav>
            
            <div class="flex items-center gap-3">
                <button id="auth-btn" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition flex items-center gap-2">
                    <i class="fab fa-google"></i>
                    <span>Connecter Drive</span>
                </button>
                <button id="signout-btn" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 transition flex items-center gap-2 hidden">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Déconnecter</span>
                </button>
                <button id="theme-toggle" class="p-2 rounded-full bg-gray-700 text-white hover:bg-gray-600 transition">
                    <i class="fas fa-moon"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="flex-grow container mx-auto px-4 py-8">
        <!-- Workout Section (default visible) -->
        <section id="workout-section" class="max-w-3xl mx-auto">
            <div class="text-center mb-8">
                <h2 id="workout-type-display" class="text-2xl font-bold mb-2">Aucun entraînement sélectionné</h2>
                <p id="progress-tracker" class="text-gray-400">Connectez-vous à Google Drive pour sauvegarder votre progression</p>
            </div>

            <div id="timer-display-clickable" class="cursor-pointer">
                <div class="timer-circle">
                    <div id="timer-outer" class="timer-outer">
                        <div id="timer-inner" class="timer-inner">
                            <div id="time-left">00:00</div>
                            <div id="timer-state">Prêt</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="workout-info text-center mb-8">
                <h3 id="current-exercise-name-display" class="text-xl font-semibold mb-2">Sélectionnez un programme</h3>
                <div id="current-exercise-container" class="text-gray-400">
                    Choisissez un type d'entraînement dans le menu
                </div>
            </div>

            <div class="flex flex-wrap justify-center gap-4 mb-8">
                <button id="start-pause-btn" class="px-6 py-3 rounded-lg bg-green-600 text-white hover:bg-green-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                    <i class="fas fa-play"></i>
                    <span>Commencer</span>
                </button>
                <button id="skip-btn" class="px-6 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                    <i class="fas fa-forward"></i>
                    <span>Suivant</span>
                </button>
                <button id="finish-btn" class="px-6 py-3 rounded-lg bg-purple-600 text-white hover:bg-purple-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                    <i class="fas fa-flag-checkered"></i>
                    <span>Finir</span>
                </button>
                <button id="reset-btn" class="px-6 py-3 rounded-lg bg-red-600 text-white hover:bg-red-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2">
                    <i class="fas fa-undo"></i>
                    <span>Réinitialiser</span>
                </button>
            </div>
        </section>

        <!-- History Section (hidden by default) -->
        <section id="history-section" class="max-w-6xl mx-auto section-hidden">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-bold">Historique des entraînements</h2>
                <button id="back-to-workout-btn" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition flex items-center gap-2">
                    <i class="fas fa-arrow-left"></i>
                    <span>Retour à l'entraînement</span>
                </button>
            </div>

            <div class="flex flex-wrap gap-4 mb-8">
                <button data-period="week" class="history-filters px-4 py-2 rounded-lg bg-gray-700 text-white hover:bg-gray-600 transition">
                    Cette semaine
                </button>
                <button data-period="month" class="history-filters px-4 py-2 rounded-lg bg-gray-700 text-white hover:bg-gray-600 transition">
                    Ce mois
                </button>
                <button data-period="year" class="history-filters px-4 py-2 rounded-lg bg-gray-700 text-white hover:bg-gray-600 transition active-filter">
                    Cette année
                </button>
                <button data-period="all" class="history-filters px-4 py-2 rounded-lg bg-gray-700 text-white hover:bg-gray-600 transition">
                    Tous
                </button>
            </div>

            <div class="grid md:grid-cols-2 gap-8">
                <div class="bg-gray-800 p-6 rounded-xl">
                    <h3 class="text-xl font-semibold mb-4">Statistiques</h3>
                    <div id="stats-display" class="space-y-4">
                        <p>Connectez-vous pour voir vos statistiques</p>
                    </div>
                </div>

                <div class="bg-gray-800 p-6 rounded-xl">
                    <h3 class="text-xl font-semibold mb-4">Graphique</h3>
                    <canvas id="history-chart" height="300"></canvas>
                </div>
            </div>

            <div class="mt-8 bg-gray-800 p-6 rounded-xl">
                <h3 class="text-xl font-semibold mb-4">Détails</h3>
                <div id="history-list" class="space-y-3">
                    <p>Connectez-vous pour voir votre historique</p>
                </div>
            </div>
        </section>
    </main>

    <!-- Post Workout Summary Modal -->
    <div id="post-workout-summary" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">Résumé de l'entraînement</h2>
            
            <div class="mb-6">
                <h3 class="text-xl font-semibold mb-2">Exercices effectués</h3>
                <ul id="summary-items-list" class="space-y-3">
                    <!-- Will be populated dynamically -->
                </ul>
            </div>
            
            <div class="flex flex-wrap justify-between gap-3">
                <button id="confirm-summary-btn" class="px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 transition flex-1 flex items-center justify-center gap-2">
                    <i class="fas fa-check"></i>
                    <span>Valider & Fermer</span>
                </button>
                <button id="discard-summary-btn" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 transition flex-1 flex items-center justify-center gap-2">
                    <i class="fas fa-times"></i>
                    <span>Rejeter Changements</span>
                </button>
                <button id="close-summary-btn" class="px-4 py-2 rounded-lg bg-gray-600 text-white hover:bg-gray-700 transition flex-1 flex items-center justify-center gap-2">
                    <i class="fas fa-times"></i>
                    <span>Fermer</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Message Area -->
    <div id="message-area" class="message"></div>

    <footer class="py-4 px-6 bg-gray-800 text-center text-gray-400">
        <p>&copy; <span id="current-year"></span> ArmorWorkout - Tous droits réservés</p>
    </footer>

    <script>
        // DOM Elements
        const elements = {
            // Header elements
            themeToggle: document.getElementById('theme-toggle'),
            
            // Navigation buttons
            pushBtn: document.getElementById('push-btn'),
            pullBtn: document.getElementById('pull-btn'),
            legsBtn: document.getElementById('legs-btn'),
            historyBtn: document.getElementById('history-btn'),
            backToWorkoutBtn: document.getElementById('back-to-workout-btn'),
            
            // Auth elements
            authBtn: document.getElementById('auth-btn'),
            signoutBtn: document.getElementById('signout-btn'),
            
            // Timer elements
            timerDisplayClickable: document.getElementById('timer-display-clickable'),
            timeLeft: document.getElementById('time-left'),
            timerState: document.getElementById('timer-state'),
            timerOuter: document.getElementById('timer-outer'),
            timerInner: document.getElementById('timer-inner'),
            
            // Workout info elements
            workoutTypeDisplay: document.getElementById('workout-type-display'),
            currentExerciseNameDisplay: document.getElementById('current-exercise-name-display'),
            currentExerciseContainer: document.getElementById('current-exercise-container'),
            progressTracker: document.getElementById('progress-tracker'),
            
            // Control buttons
            startPauseBtn: document.getElementById('start-pause-btn'),
            skipBtn: document.getElementById('skip-btn'),
            finishBtn: document.getElementById('finish-btn'),
            resetBtn: document.getElementById('reset-btn'),
            
            // Sections
            workoutSection: document.getElementById('workout-section'),
            historySection: document.getElementById('history-section'),
            
            // History elements
            historyFilters: document.querySelectorAll('.history-filters'),
            statsDisplay: document.getElementById('stats-display'),
            historyList: document.getElementById('history-list'),
            historyChart: document.getElementById('history-chart'),
            
            // Modal elements
            postWorkoutSummary: document.getElementById('post-workout-summary'),
            summaryItemsList: document.getElementById('summary-items-list'),
            confirmSummaryBtn: document.getElementById('confirm-summary-btn'),
            discardSummaryBtn: document.getElementById('discard-summary-btn'),
            closeSummaryBtn: document.getElementById('close-summary-btn'),
            
            // Message area
            messageArea: document.getElementById('message-area'),
            
            // Footer
            currentYear: document.getElementById('current-year')
        };

        // App State
        const state = {
            theme: 'dark',
            isAuthenticated: false,
            googleAccessToken: null,
            GOOGLE_CLIENT_ID: 'YOUR_CLIENT_ID.apps.googleusercontent.com', // Replace with your actual client ID
            timerInterval: null,
            timeLeft: 0,
            totalDuration: 0,
            currentState: 'idle', // 'idle', 'preparing', 'exercise', 'break', 'paused', 'finished'
            currentWorkoutType: null,
            currentWorkout: [],
            currentItemIndex: 0,
            workoutHistory: [],
            loadedWorkouts: {
                push: [],
                pull: [],
                legs: []
            },
            chart: null,
            summaryChanged: false
        };

        // Default workouts
        const DEFAULT_WORKOUTS = {
            push: [
                { type: 'exercise', name: 'Développé couché', details: '4 séries', reps: '8-12', duration: 0 },
                { type: 'break', name: 'Repos', details: '', reps: '', duration: 90 },
                { type: 'exercise', name: 'Développé incliné haltères', details: '3 séries', reps: '10-12', duration: 0 },
                { type: 'break', name: 'Repos', details: '', reps: '', duration: 90 },
                { type: 'exercise', name: 'Écarté couché', details: '3 séries', reps: '12-15', duration: 0 },
                { type: 'break', name: 'Repos', details: '', reps: '', duration: 60 },
                { type: 'exercise', name: 'Dips', details: '3 séries', reps: 'Max', duration: 0 },
                { type: 'break', name: 'Repos', details: '', reps: '', duration: 60 },
                { type: 'exercise', name: 'Triceps poulie haute', details: '3 séries', reps: '12-15', duration: 0 },
                { type: 'break', name: 'Repos', details: '', reps: '', duration: 60 }
            ],
            pull: [
                { type: 'exercise', name: 'Tractions', details: '4 séries', reps: 'Max', duration: 0 },
                { type: 'break', name: 'Repos', details: '', reps: '', duration: 90 },
                { type: 'exercise', name: 'Rowing barre', details: '3 séries', reps: '8-12', duration: 0 },
                { type: 'break', name: 'Repos', details: '', reps: '', duration: 90 },
                { type: 'exercise', name: 'Face pull', details: '3 séries', reps: '12-15', duration: 0 },
                { type: 'break', name: 'Repos', details: '', reps: '', duration: 60 },
                { type: 'exercise', name: 'Curl haltères', details: '3 séries', reps: '10-12', duration: 0 },
                { type: 'break', name: 'Repos', details: '', reps: '', duration: 60 },
                { type: 'exercise', name: 'Curl marteau', details: '3 séries', reps: '12-15', duration: 0 },
                { type: 'break', name: 'Repos', details: '', reps: '', duration: 60 }
            ],
            legs: [
                { type: 'exercise', name: 'Squat', details: '4 séries', reps: '6-10', duration: 0 },
                { type: 'break', name: 'Repos', details: '', reps: '', duration: 120 },
                { type: 'exercise', name: 'Presse à cuisses', details: '3 séries', reps: '8-12', duration: 0 },
                { type: 'break', name: 'Repos', details: '', reps: '', duration: 90 },
                { type: 'exercise', name: 'Fentes', details: '3 séries', reps: '10-12 par jambe', duration: 0 },
                { type: 'break', name: 'Repos', details: '', reps: '', duration: 60 },
                { type: 'exercise', name: 'Leg curl', details: '3 séries', reps: '12-15', duration: 0 },
                { type: 'break', name: 'Repos', details: '', reps: '', duration: 60 },
                { type: 'exercise', name: 'Mollets', details: '4 séries', reps: '15-20', duration: 0 },
                { type: 'break', name: 'Repos', details: '', reps: '', duration: 60 }
            ]
        };

        // Initialize the app
        function init() {
            // Set current year in footer
            elements.currentYear.textContent = new Date().getFullYear();
            
            // Load theme preference
            loadTheme();
            
            // Set up event listeners
            setupEventListeners();
            
            // Initialize default workouts
            state.loadedWorkouts = JSON.parse(JSON.stringify(DEFAULT_WORKOUTS));
            
            // Check for in-progress workout
            loadInProgressState();
            
            // Update UI based on initial state
            updateAuthUI();
            setState('idle');
        }

        // Set up event listeners
        function setupEventListeners() {
            // Theme toggle
            elements.themeToggle.addEventListener('click', toggleTheme);
            
            // Navigation buttons
            elements.pushBtn.addEventListener('click', () => loadWorkout('push'));
            elements.pullBtn.addEventListener('click', () => loadWorkout('pull'));
            elements.legsBtn.addEventListener('click', () => loadWorkout('legs'));
            elements.historyBtn.addEventListener('click', showHistorySection);
            elements.backToWorkoutBtn.addEventListener('click', showWorkoutSection);
            
            // Auth buttons
            elements.authBtn.addEventListener('click', handleAuthClick);
            elements.signoutBtn.addEventListener('click', handleSignoutClick);
            
            // Timer controls
            elements.startPauseBtn.addEventListener('click', toggleStartPause);
            elements.skipBtn.addEventListener('click', handleSkip);
            elements.finishBtn.addEventListener('click', handleFinish);
            elements.resetBtn.addEventListener('click', handleReset);
            elements.timerDisplayClickable.addEventListener('click', handleTimerClick);
            
            // History filters
            elements.historyFilters.forEach(btn => {
                btn.addEventListener('click', () => displayHistory(btn.dataset.period));
            });
            
            // Modal buttons
            elements.confirmSummaryBtn.addEventListener('click', handleConfirmSummary);
            elements.discardSummaryBtn.addEventListener('click', handleDiscardSummary);
            elements.closeSummaryBtn.addEventListener('click', closeSummary);
        }

        // Theme functions
        function toggleTheme() {
            state.theme = state.theme === 'dark' ? 'light' : 'dark';
            applyTheme();
            saveThemePreference();
        }

        function applyTheme() {
            if (state.theme === 'dark') {
                document.body.classList.add('dark-theme');
                document.body.classList.remove('light-theme');
                elements.themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            } else {
                document.body.classList.add('light-theme');
                document.body.classList.remove('dark-theme');
                elements.themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            }
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('armorworkout-theme');
            if (savedTheme) {
                state.theme = savedTheme;
            }
            applyTheme();
        }

        function saveThemePreference() {
            localStorage.setItem('armorworkout-theme', state.theme);
        }

        // Timer functions
        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function updateTimerDisplay() {
            elements.timeLeft.textContent = formatTime(state.timeLeft);
            
            // Update circle progress
            if (state.currentState !== 'idle' && state.currentState !== 'finished') {
                const currentItem = state.currentWorkout[state.currentItemIndex];
                const totalDuration = currentItem.duration;
                const progress = (totalDuration - state.timeLeft) / totalDuration;
                
                // Update inner circle (current step progress)
                if (state.currentState === 'exercise' || state.currentState === 'break') {
                    const circumference = 2 * Math.PI * 135; // Approximate radius
                    const offset = circumference * (1 - progress);
                    elements.timerInner.style.background = `conic-gradient(from 0deg, var(--accent-${state.currentState === 'exercise' ? 'green' : 'blue'}) ${progress * 360}deg, transparent ${progress * 360}deg)`;
                }
                
                // Update outer circle (total workout progress)
                if (state.totalDuration > 0) {
                    const totalProgress = calculateTotalProgress();
                    elements.timerOuter.style.background = `conic-gradient(from 0deg, var(--accent-purple) ${totalProgress * 360}deg, transparent ${totalProgress * 360}deg)`;
                }
            }
        }

        function calculateTotalProgress() {
            if (state.currentState === 'idle' || state.currentWorkout.length === 0) return 0;
            
            let totalTime = 0;
            let completedTime = 0;
            
            // Calculate total time
            state.currentWorkout.forEach(item => {
                totalTime += item.duration;
            });
            
            // Calculate completed time
            for (let i = 0; i < state.currentItemIndex; i++) {
                completedTime += state.currentWorkout[i].duration;
            }
            
            // Add progress of current item
            const currentItem = state.currentWorkout[state.currentItemIndex];
            if (currentItem) {
                completedTime += (currentItem.duration - state.timeLeft);
            }
            
            return Math.min(completedTime / totalTime, 1);
        }

        function startTimer() {
            if (state.timerInterval) clearInterval(state.timerInterval);
            
            state.timerInterval = setInterval(() => {
                state.timeLeft--;
                updateTimerDisplay();
                
                if (state.timeLeft <= 0) {
                    clearInterval(state.timerInterval);
                    handleItemCompletion();
                }
            }, 1000);
        }

        function pauseTimer() {
            if (state.timerInterval) {
                clearInterval(state.timerInterval);
                state.timerInterval = null;
            }
        }

        // State management
        function setState(newState) {
            state.currentState = newState;
            
            // Update UI based on state
            updateUIForState();
            
            // Save in-progress state
            if (newState !== 'idle' && newState !== 'finished') {
                saveInProgressState();
            } else if (newState === 'finished') {
                clearInProgressState();
            }
        }

        function updateUIForState() {
            // Update timer display
            updateTimerDisplay();
            
            // Update timer colors based on state
            switch (state.currentState) {
                case 'idle':
                    elements.timerOuter.style.boxShadow = 'var(--glow-blue)';
                    elements.timerInner.style.boxShadow = 'var(--glow-pink)';
                    elements.timerState.textContent = 'Prêt';
                    break;
                case 'preparing':
                    elements.timerOuter.style.boxShadow = 'var(--glow-yellow)';
                    elements.timerInner.style.boxShadow = 'var(--glow-yellow)';
                    elements.timerState.textContent = 'Prêt?';
                    break;
                case 'exercise':
                    elements.timerOuter.style.boxShadow = 'var(--glow-green)';
                    elements.timerInner.style.boxShadow = 'var(--glow-green)';
                    elements.timerState.textContent = 'Exercice';
                    break;
                case 'break':
                    elements.timerOuter.style.boxShadow = 'var(--glow-blue)';
                    elements.timerInner.style.boxShadow = 'var(--glow-blue)';
                    elements.timerState.textContent = 'Repos';
                    break;
                case 'paused':
                    elements.timerOuter.style.boxShadow = 'var(--glow-yellow)';
                    elements.timerInner.style.boxShadow = 'var(--glow-yellow)';
                    elements.timerState.textContent = 'Pause';
                    break;
                case 'finished':
                    elements.timerOuter.style.boxShadow = 'var(--glow-purple)';
                    elements.timerInner.style.boxShadow = 'var(--glow-purple)';
                    elements.timerState.textContent = 'Terminé';
                    break;
            }
            
            // Update control buttons
            updateControlButtons();
            
            // Update workout info
            updateWorkoutInfo();
        }

        function updateControlButtons() {
            // Start/Pause button
            if (state.currentState === 'idle') {
                elements.startPauseBtn.innerHTML = '<i class="fas fa-play"></i><span>Commencer</span>';
                elements.startPauseBtn.disabled = state.currentWorkout.length === 0;
            } else if (state.currentState === 'paused') {
                elements.startPauseBtn.innerHTML = '<i class="fas fa-play"></i><span>Reprendre</span>';
                elements.startPauseBtn.disabled = false;
            } else {
                elements.startPauseBtn.innerHTML = '<i class="fas fa-pause"></i><span>Pause</span>';
                elements.startPauseBtn.disabled = false;
            }
            
            // Skip button
            elements.skipBtn.disabled = state.currentState === 'idle' || state.currentState === 'finished';
            
            // Finish button
            elements.finishBtn.disabled = state.currentState === 'idle' || state.currentState === 'finished';
            
            // Reset button
            elements.resetBtn.disabled = state.currentState === 'idle';
        }

        // Workout functions
        function loadWorkout(type) {
            if (!['push', 'pull', 'legs'].includes(type)) return;
            
            // Reset current workout
            if (state.timerInterval) clearInterval(state.timerInterval);
            
            state.currentWorkoutType = type;
            state.currentWorkout = [...state.loadedWorkouts[type]];
            state.currentItemIndex = 0;
            state.totalDuration = calculateTotalEstimatedTime();
            
            // Update UI
            elements.workoutTypeDisplay.textContent = `Entraînement ${type.charAt(0).toUpperCase() + type.slice(1)}`;
            elements.currentExerciseNameDisplay.textContent = 'Prêt à commencer';
            elements.currentExerciseContainer.textContent = `Durée estimée: ${formatTime(state.totalDuration)}`;
            
            // Reset navigation buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(`${type}-btn`).classList.add('active');
            
            // Set state to idle
            setState('idle');
        }

        function calculateTotalEstimatedTime() {
            return state.currentWorkout.reduce((total, item) => total + item.duration, 0);
        }

        function updateWorkoutInfo() {
            if (state.currentState === 'idle') {
                if (state.currentWorkout.length > 0) {
                    elements.currentExerciseNameDisplay.textContent = 'Prêt à commencer';
                    elements.currentExerciseContainer.textContent = `Durée estimée: ${formatTime(state.totalDuration)}`;
                } else {
                    elements.currentExerciseNameDisplay.textContent = 'Sélectionnez un programme';
                    elements.currentExerciseContainer.textContent = 'Choisissez un type d\'entraînement dans le menu';
                }
                return;
            }
            
            if (state.currentState === 'finished') {
                elements.currentExerciseNameDisplay.textContent = 'Entraînement terminé!';
                elements.currentExerciseContainer.innerHTML = '<i class="fas fa-trophy text-yellow-400"></i> Bravo!';
                return;
            }
            
            const currentItem = state.currentWorkout[state.currentItemIndex];
            if (!currentItem) return;
            
            elements.currentExerciseNameDisplay.textContent = currentItem.name;
            
            if (currentItem.type === 'exercise') {
                elements.currentExerciseContainer.innerHTML = `
                    <div class="text-lg font-medium">${currentItem.details}</div>
                    <div class="text-gray-400">Reps: ${currentItem.reps}</div>
                `;
            } else {
                elements.currentExerciseContainer.innerHTML = `
                    <div class="text-lg font-medium">${formatTime(state.timeLeft)}</div>
                    <div class="text-gray-400">Prochain: ${getNextExerciseName()}</div>
                `;
            }
        }

        function getNextExerciseName() {
            for (let i = state.currentItemIndex + 1; i < state.currentWorkout.length; i++) {
                if (state.currentWorkout[i].type === 'exercise') {
                    return state.currentWorkout[i].name;
                }
            }
            return 'Fin';
        }

        function startWorkout() {
            if (state.currentState === 'idle') {
                // Start with preparation countdown
                state.timeLeft = 3;
                setState('preparing');
                startTimer();
            } else if (state.currentState === 'paused') {
                // Resume from paused state
                setState(state.previousState || 'exercise');
                startTimer();
            }
        }

        function toggleStartPause() {
            if (state.currentState === 'idle' || state.currentState === 'paused') {
                startWorkout();
            } else {
                // Pause the current state
                state.previousState = state.currentState;
                setState('paused');
                pauseTimer();
            }
        }

        function handleItemCompletion() {
            if (state.currentState === 'preparing') {
                // Preparation done, start first exercise
                startNextItem();
            } else if (state.currentState === 'exercise' || state.currentState === 'break') {
                // Current item done, move to next
                state.currentItemIndex++;
                
                if (state.currentItemIndex < state.currentWorkout.length) {
                    startNextItem();
                } else {
                    // Workout completed
                    completeWorkout();
                }
            }
        }

        function startNextItem() {
            const nextItem = state.currentWorkout[state.currentItemIndex];
            if (!nextItem) return;
            
            state.timeLeft = nextItem.duration;
            
            if (nextItem.type === 'exercise') {
                setState('exercise');
            } else {
                setState('break');
            }
            
            updateWorkoutInfo();
            startTimer();
        }

        function handleSkip() {
            if (state.currentState === 'idle' || state.currentState === 'finished') return;
            
            // Skip current item
            pauseTimer();
            handleItemCompletion();
        }

        function handleFinish() {
            if (state.currentState === 'idle' || state.currentState === 'finished') return;
            
            // Finish workout early
            pauseTimer();
            completeWorkout();
        }

        function handleReset() {
            if (state.currentState === 'idle') return;
            
            // Reset workout
            pauseTimer();
            state.currentItemIndex = 0;
            state.timeLeft = 0;
            setState('idle');
        }

        function completeWorkout() {
            pauseTimer();
            setState('finished');
            
            // Add to history
            const workoutRecord = {
                type: state.currentWorkoutType,
                date: new Date().toISOString(),
                duration: calculateCompletedDuration(),
                completedItems: state.currentItemIndex + 1,
                totalItems: state.currentWorkout.length
            };
            
            state.workoutHistory.unshift(workoutRecord);
            
            // Save history to Drive if authenticated
            if (state.isAuthenticated) {
                saveHistoryToDrive();
            }
            
            // Show summary modal
            showSummaryModal();
        }

        function calculateCompletedDuration() {
            let completedDuration = 0;
            
            for (let i = 0; i <= state.currentItemIndex; i++) {
                if (i < state.currentItemIndex) {
                    completedDuration += state.currentWorkout[i].duration;
                } else {
                    completedDuration += (state.currentWorkout[i].duration - state.timeLeft);
                }
            }
            
            return completedDuration;
        }

        function handleTimerClick() {
            if (state.currentState === 'break') {
                // Mark break as done
                handleItemCompletion();
            } else if (state.currentState === 'exercise') {
                // Toggle pause/resume
                toggleStartPause();
            }
        }

        // Section navigation
        function showHistorySection() {
            elements.workoutSection.classList.add('section-hidden');
            elements.historySection.classList.remove('section-hidden');
            
            // Load history data
            displayHistory('year');
        }

        function showWorkoutSection() {
            elements.historySection.classList.add('section-hidden');
            elements.workoutSection.classList.remove('section-hidden');
        }

        // History functions
        function displayHistory(period) {
            if (!state.isAuthenticated) {
                elements.statsDisplay.innerHTML = '<p>Connectez-vous pour voir vos statistiques</p>';
                elements.historyList.innerHTML = '<p>Connectez-vous pour voir votre historique</p>';
                return;
            }
            
            // Filter history by period
            const filteredHistory = filterHistoryByPeriod(period);
            
            // Update active filter button
            elements.historyFilters.forEach(btn => {
                btn.classList.remove('active-filter');
                if (btn.dataset.period === period) {
                    btn.classList.add('active-filter');
                }
            });
            
            // Display stats
            displayStatsAndMotivation(filteredHistory);
            
            // Display history list
            displayHistoryList(filteredHistory);
            
            // Display chart
            renderHistoryChart(filteredHistory, period);
        }

        function filterHistoryByPeriod(period) {
            const now = new Date();
            let cutoffDate;
            
            switch (period) {
                case 'week':
                    cutoffDate = new Date(now.setDate(now.getDate() - 7));
                    break;
                case 'month':
                    cutoffDate = new Date(now.setMonth(now.getMonth() - 1));
                    break;
                case 'year':
                    cutoffDate = new Date(now.setFullYear(now.getFullYear() - 1));
                    break;
                default:
                    return state.workoutHistory;
            }
            
            return state.workoutHistory.filter(workout => {
                return new Date(workout.date) >= cutoffDate;
            });
        }

        function displayStatsAndMotivation(history) {
            if (history.length === 0) {
                elements.statsDisplay.innerHTML = `
                    <p class="text-gray-400">Aucun entraînement enregistré pour cette période</p>
                    <p class="mt-4 text-lg font-medium">Commencez votre premier entraînement!</p>
                `;
                return;
            }
            
            const stats = calculateStats(history);
            const motivation = generateMotivationalMessage(stats);
            
            elements.statsDisplay.innerHTML = `
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-gray-700 p-3 rounded-lg">
                        <p class="text-sm text-gray-400">Séances</p>
                        <p class="text-2xl font-bold">${stats.totalSessions}</p>
                    </div>
                    <div class="bg-gray-700 p-3 rounded-lg">
                        <p class="text-sm text-gray-400">Durée totale</p>
                        <p class="text-2xl font-bold">${formatTime(stats.totalDuration)}</p>
                    </div>
                    <div class="bg-gray-700 p-3 rounded-lg">
                        <p class="text-sm text-gray-400">Durée moyenne</p>
                        <p class="text-2xl font-bold">${formatTime(stats.avgDuration)}</p>
                    </div>
                    <div class="bg-gray-700 p-3 rounded-lg">
                        <p class="text-sm text-gray-400">Type favori</p>
                        <p class="text-2xl font-bold">${stats.mostFrequentType}</p>
                    </div>
                </div>
                <div class="mt-4 p-3 bg-gray-700 rounded-lg">
                    <p class="text-sm text-gray-400">Motivation</p>
                    <p class="text-lg font-medium">${motivation}</p>
                </div>
            `;
        }

        function calculateStats(history) {
            if (history.length === 0) return {
                totalSessions: 0,
                totalDuration: 0,
                avgDuration: 0,
                mostFrequentType: 'Aucun'
            };
            
            const totalSessions = history.length;
            const totalDuration = history.reduce((sum, workout) => sum + workout.duration, 0);
            const avgDuration = Math.round(totalDuration / totalSessions);
            
            // Count workout types
            const typeCounts = {};
            history.forEach(workout => {
                typeCounts[workout.type] = (typeCounts[workout.type] || 0) + 1;
            });
            
            // Find most frequent type
            let mostFrequentType = 'Aucun';
            let maxCount = 0;
            for (const type in typeCounts) {
                if (typeCounts[type] > maxCount) {
                    maxCount = typeCounts[type];
                    mostFrequentType = type;
                }
            }
            
            return {
                totalSessions,
                totalDuration,
                avgDuration,
                mostFrequentType: mostFrequentType.charAt(0).toUpperCase() + mostFrequentType.slice(1)
            };
        }

        function generateMotivationalMessage(stats) {
            if (stats.totalSessions === 0) return "Commencez votre premier entraînement aujourd'hui!";
            
            const messages = [
                "Continuez comme ça! La régularité est la clé du succès.",
                "Excellent travail! Votre persévérance porte ses fruits.",
                "Impressionnant! Vous êtes sur la bonne voie.",
                "Chaque séance vous rapproche de vos objectifs. Ne lâchez rien!",
                "La discipline que vous montrez est inspirante."
            ];
            
            return messages[Math.floor(Math.random() * messages.length)];
        }

        function displayHistoryList(history) {
            if (history.length === 0) {
                elements.historyList.innerHTML = '<p class="text-gray-400">Aucun entraînement enregistré pour cette période</p>';
                return;
            }
            
            elements.historyList.innerHTML = history.map(workout => `
                <div class="history-item bg-gray-700 p-4 rounded-lg flex justify-between items-center">
                    <div>
                        <h4 class="font-semibold">${workout.type.charAt(0).toUpperCase() + workout.type.slice(1)}</h4>
                        <p class="text-sm text-gray-400">${new Date(workout.date).toLocaleDateString('fr-FR')}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-medium">${formatTime(workout.duration)}</p>
                        <p class="text-sm text-gray-400">${workout.completedItems}/${workout.totalItems} exercices</p>
                    </div>
                </div>
            `).join('');
        }

        function renderHistoryChart(history, period) {
            if (state.chart) {
                state.chart.destroy();
            }
            
            if (history.length === 0) {
                // Display message when no data
                const ctx = elements.historyChart.getContext('2d');
                ctx.font = '16px Inter';
                ctx.fillStyle = state.theme === 'dark' ? '#e0e0e0' : '#333333';
                ctx.textAlign = 'center';
                ctx.fillText('Aucune donnée disponible', elements.historyChart.width / 2, elements.historyChart.height / 2);
                return;
            }
            
            // Group data by time period
            const groupedData = groupHistoryData(history, period);
            
            // Prepare chart data
            const labels = Object.keys(groupedData);
            const data = Object.values(groupedData).map(group => ({
                duration: group.reduce((sum, workout) => sum + workout.duration, 0),
                count: group.length
            }));
            
            const ctx = elements.historyChart.getContext('2d');
            state.chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Durée (minutes)',
                            data: data.map(item => Math.round(item.duration / 60)),
                            backgroundColor: 'rgba(180, 0, 255, 0.7)',
                            borderColor: 'rgba(180, 0, 255, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Nombre de séances',
                            data: data.map(item => item.count),
                            backgroundColor: 'rgba(0, 240, 255, 0.7)',
                            borderColor: 'rgba(0, 240, 255, 1)',
                            borderWidth: 1,
                            type: 'line',
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: state.theme === 'dark' ? '#e0e0e0' : '#333333'
                            }
                        },
                        title: {
                            display: true,
                            text: `Activité par ${period === 'week' ? 'jour' : period === 'month' ? 'semaine' : 'mois'}`,
                            color: state.theme === 'dark' ? '#e0e0e0' : '#333333'
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: state.theme === 'dark' ? '#e0e0e0' : '#333333'
                            },
                            grid: {
                                color: state.theme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Minutes',
                                color: state.theme === 'dark' ? '#e0e0e0' : '#333333'
                            },
                            ticks: {
                                color: state.theme === 'dark' ? '#e0e0e0' : '#333333'
                            },
                            grid: {
                                color: state.theme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Séances',
                                color: state.theme === 'dark' ? '#e0e0e0' : '#333333'
                            },
                            ticks: {
                                color: state.theme === 'dark' ? '#e0e0e0' : '#333333'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        function groupHistoryData(history, period) {
            const grouped = {};
            
            history.forEach(workout => {
                const date = new Date(workout.date);
                let key;
                
                switch (period) {
                    case 'week':
                        key = date.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric' });
                        break;
                    case 'month':
                        // Group by week number
                        const firstDayOfYear = new Date(date.getFullYear(), 0, 1);
                        const pastDaysOfYear = (date - firstDayOfYear) / 86400000;
                        const weekNumber = Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
                        key = `Semaine ${weekNumber}`;
                        break;
                    case 'year':
                        key = date.toLocaleDateString('fr-FR', { month: 'short' });
                        break;
                    default:
                        key = date.toLocaleDateString('fr-FR');
                }
                
                if (!grouped[key]) {
                    grouped[key] = [];
                }
                
                grouped[key].push(workout);
            });
            
            return grouped;
        }

        // Summary modal functions
        function showSummaryModal() {
            // Reset summary changed flag
            state.summaryChanged = false;
            
            // Populate summary items
            elements.summaryItemsList.innerHTML = state.currentWorkout
                .filter(item => item.type === 'exercise')
                .map((item, index) => `
                    <li class="bg-gray-700 p-3 rounded-lg">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-medium">${item.name}</h4>
                            <span class="text-sm text-gray-400">${index + 1}/${state.currentWorkout.filter(i => i.type === 'exercise').length}</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <div class="rep-control">
                                <span class="text-sm text-gray-400">Reps:</span>
                                <button class="rep-btn bg-gray-600 hover:bg-gray-500" onclick="changeRep(this, -1)">-</button>
                                <span class="rep-value">${item.reps}</span>
                                <button class="rep-btn bg-gray-600 hover:bg-gray-500" onclick="changeRep(this, 1)">+</button>
                            </div>
                            <div>
                                <span class="text-sm text-gray-400">${item.details}</span>
                            </div>
                        </div>
                    </li>
                `).join('');
            
            // Show modal
            elements.postWorkoutSummary.classList.add('active');
            
            // Update summary buttons state
            updateSummaryButtonsState();
        }

        function closeSummary() {
            elements.postWorkoutSummary.classList.remove('active');
            
            // Reset workout state
            setState('idle');
        }

        function handleConfirmSummary() {
            if (state.summaryChanged) {
                // Update workout with modified reps
                let exerciseIndex = 0;
                state.currentWorkout.forEach(item => {
                    if (item.type === 'exercise') {
                        const repValue = document.querySelectorAll('.rep-value')[exerciseIndex].textContent;
                        item.reps = repValue;
                        exerciseIndex++;
                    }
                });
                
                // Save modified workout to Drive if authenticated
                if (state.isAuthenticated) {
                    saveModifiedWorkout();
                }
            }
            
            closeSummary();
        }

        function handleDiscardSummary() {
            closeSummary();
        }

        function markSummaryChanged() {
            state.summaryChanged = true;
            updateSummaryButtonsState();
        }

        function updateSummaryButtonsState() {
            elements.confirmSummaryBtn.disabled = !state.summaryChanged;
            elements.discardSummaryBtn.disabled = !state.summaryChanged;
        }

        // Global function for rep changes (accessible from inline onclick)
        window.changeRep = function(button, change) {
            const repContainer = button.closest('.rep-control');
            const repValue = repContainer.querySelector('.rep-value');
            
            // Parse current reps (could be "8-12" or "Max")
            let reps = repValue.textContent;
            
            if (reps.includes('-')) {
                // Range like "8-12"
                let [min, max] = reps.split('-').map(Number);
                min = Math.max(1, min + change);
                max = Math.max(min, max + change);
                reps = `${min}-${max}`;
            } else if (reps === 'Max') {
                // Keep as "Max" but mark as changed
                reps = 'Max';
            } else {
                // Single number
                let num = parseInt(reps) || 0;
                num = Math.max(1, num + change);
                reps = num.toString();
            }
            
            repValue.textContent = reps;
            markSummaryChanged();
        };

        // Google Drive functions
        function gisLoadedCallback() {
            console.log('Google Identity Services loaded');
        }

        function handleAuthClick() {
            if (!window.google) {
                showMessage('Google Identity Services non chargé', 'error');
                return;
            }
            
            const client = google.accounts.oauth2.initTokenClient({
                client_id: state.GOOGLE_CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/drive.file',
                callback: tokenCallback,
                error_callback: handleTokenError
            });
            
            client.requestAccessToken();
        }

        function handleSignoutClick() {
            if (!window.google) return;
            
            google.accounts.oauth2.revoke(state.googleAccessToken, () => {
                state.isAuthenticated = false;
                state.googleAccessToken = null;
                updateAuthUI();
                showMessage('Déconnecté de Google Drive', 'success');
            });
        }

        function tokenCallback(response) {
            if (response.error) {
                handleTokenError(response);
                return;
            }
            
            state.googleAccessToken = response.access_token;
            state.isAuthenticated = true;
            updateAuthUI();
            showMessage('Connecté à Google Drive', 'success');
            
            // Load data from Drive
            loadProgramsFromDrive();
            loadHistoryFromDrive();
        }

        function handleTokenError(error) {
            console.error('Token error:', error);
            showMessage('Erreur d\'authentification', 'error');
        }

        function updateAuthUI() {
            elements.authBtn.classList.toggle('hidden', state.isAuthenticated);
            elements.signoutBtn.classList.toggle('hidden', !state.isAuthenticated);
            
            // Enable/disable workout buttons based on auth state
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.disabled = !state.isAuthenticated;
            });
            
            // Update progress tracker message
            if (state.isAuthenticated) {
                elements.progressTracker.textContent = 'Connecté à Google Drive';
            } else {
                elements.progressTracker.textContent = 'Connectez-vous à Google Drive pour sauvegarder votre progression';
            }
        }

        async function loadProgramsFromDrive() {
            if (!state.isAuthenticated) return;
            
            try {
                // Try to load push program
                const pushFile = await findOrCreateFile('armorworkout_push_program.csv', await convertProgramToCsv('push'));
                const pushContent = await readFileContent(pushFile.id);
                state.loadedWorkouts.push = parseProgramCsvData(pushContent) || state.loadedWorkouts.push;
                
                // Try to load pull program
                const pullFile = await findOrCreateFile('armorworkout_pull_program.csv', await convertProgramToCsv('pull'));
                const pullContent = await readFileContent(pullFile.id);
                state.loadedWorkouts.pull = parseProgramCsvData(pullContent) || state.loadedWorkouts.pull;
                
                // Try to load legs program
                const legsFile = await findOrCreateFile('armorworkout_legs_program.csv', await convertProgramToCsv('legs'));
                const legsContent = await readFileContent(legsFile.id);
                state.loadedWorkouts.legs = parseProgramCsvData(legsContent) || state.loadedWorkouts.legs;
                
                showMessage('Programmes chargés depuis Drive', 'success');
            } catch (error) {
                console.error('Error loading programs:', error);
                showMessage('Erreur lors du chargement des programmes', 'error');
            }
        }

        async function loadHistoryFromDrive() {
            if (!state.isAuthenticated) return;
            
            try {
                const historyFile = await findOrCreateFile('armorworkout_history.csv', 'type,date,duration,completedItems,totalItems\n');
                const historyContent = await readFileContent(historyFile.id);
                state.workoutHistory = parseAndLoadHistoryCsvData(historyContent) || [];
                
                showMessage('Historique chargé depuis Drive', 'success');
                
                // Update history display if on history section
                if (!elements.historySection.classList.contains('section-hidden')) {
                    displayHistory('year');
                }
            } catch (error) {
                console.error('Error loading history:', error);
                showMessage('Erreur lors du chargement de l\'historique', 'error');
            }
        }

        async function saveHistoryToDrive() {
            if (!state.isAuthenticated || state.workoutHistory.length === 0) return;
            
            try {
                const historyFile = await findOrCreateFile('armorworkout_history.csv', 'type,date,duration,completedItems,totalItems\n');
                const csvContent = state.workoutHistory.map(workout => 
                    `${workout.type},${workout.date},${workout.duration},${workout.completedItems},${workout.totalItems}`
                ).join('\n');
                
                await updateFileContent(historyFile.id, 'type,date,duration,completedItems,totalItems\n' + csvContent);
                showMessage('Historique sauvegardé sur Drive', 'success');
            } catch (error) {
                console.error('Error saving history:', error);
                showMessage('Erreur lors de la sauvegarde de l\'historique', 'error');
            }
        }

        async function saveModifiedWorkout() {
            if (!state.isAuthenticated || !state.currentWorkoutType) return;
            
            try {
                const filename = `armorworkout_${state.currentWorkoutType}_program.csv`;
                const csvContent = await convertProgramToCsv(state.currentWorkoutType);
                
                const file = await findOrCreateFile(filename, csvContent);
                await updateFileContent(file.id, csvContent);
                
                showMessage('Programme mis à jour sur Drive', 'success');
            } catch (error) {
                console.error('Error saving modified workout:', error);
                showMessage('Erreur lors de la mise à jour du programme', 'error');
            }
        }

        async function findOrCreateFile(filename, initialContent) {
            try {
                // First try to find the file
                const response = await fetch('https://www.googleapis.com/drive/v3/files', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${state.googleAccessToken}`,
                        'Content-Type': 'application/json'
                    },
                    params: {
                        q: `name='${filename}' and trashed=false`,
                        fields: 'files(id,name)'
                    }
                });
                
                const data = await response.json();
                
                if (data.files && data.files.length > 0) {
                    return data.files[0];
                }
                
                // If not found, create it
                const createResponse = await fetch('https://www.googleapis.com/drive/v3/files', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${state.googleAccessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: filename,
                        mimeType: 'text/csv'
                    })
                });
                
                const file = await createResponse.json();
                
                // Add initial content
                await updateFileContent(file.id, initialContent);
                
                return file;
            } catch (error) {
                console.error('Error finding/creating file:', error);
                throw error;
            }
        }

        async function readFileContent(fileId) {
            try {
                const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${state.googleAccessToken}`
                    }
                });
                
                return await response.text();
            } catch (error) {
                console.error('Error reading file content:', error);
                throw error;
            }
        }

        async function updateFileContent(fileId, content) {
            try {
                const response = await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${state.googleAccessToken}`,
                        'Content-Type': 'text/csv'
                    },
                    body: content
                });
                
                return await response.json();
            } catch (error) {
                console.error('Error updating file content:', error);
                throw error;
            }
        }

        function parseProgramCsvData(csvData) {
            if (!csvData) return null;
            
            try {
                const lines = csvData.split('\n').filter(line => line.trim() !== '');
                if (lines.length < 2) return null;
                
                const workouts = [];
                
                // Skip header line
                for (let i = 1; i < lines.length; i++) {
                    const [type, name, details, reps, duration] = lines[i].split(',');
                    
                    if (type && name) {
                        workouts.push({
                            type,
                            name,
                            details: details || '',
                            reps: reps || '',
                            duration: parseInt(duration) || 0
                        });
                    }
                }
                
                return workouts;
            } catch (error) {
                console.error('Error parsing program CSV:', error);
                return null;
            }
        }

        function parseAndLoadHistoryCsvData(csvData) {
            if (!csvData) return null;
            
            try {
                const lines = csvData.split('\n').filter(line => line.trim() !== '');
                if (lines.length < 2) return null;
                
                const history = [];
                
                // Skip header line
                for (let i = 1; i < lines.length; i++) {
                    const [type, date, duration, completedItems, totalItems] = lines[i].split(',');
                    
                    if (type && date && duration) {
                        history.push({
                            type,
                            date,
                            duration: parseInt(duration),
                            completedItems: parseInt(completedItems),
                            totalItems: parseInt(totalItems)
                        });
                    }
                }
                
                return history;
            } catch (error) {
                console.error('Error parsing history CSV:', error);
                return null;
            }
        }

        async function convertProgramToCsv(type) {
            const workouts = state.loadedWorkouts[type] || [];
            let csv = 'type,name,details,reps,duration\n';
            
            workouts.forEach(workout => {
                csv += `${workout.type},${workout.name},${workout.details},${workout.reps},${workout.duration}\n`;
            });
            
            return csv;
        }

        // Local storage functions
        function saveInProgressState() {
            const inProgressState = {
                workoutType: state.currentWorkoutType,
                workout: state.currentWorkout,
                itemIndex: state.currentItemIndex,
                timeLeft: state.timeLeft,
                currentState: state.currentState,
                timestamp: new Date().getTime()
            };
            
            localStorage.setItem('armorworkout-in-progress', JSON.stringify(inProgressState));
        }

        function loadInProgressState() {
            const savedState = localStorage.getItem('armorworkout-in-progress');
            if (!savedState) return;
            
            try {
                const stateData = JSON.parse(savedState);
                
                // Check if saved state is older than 24 hours
                const now = new Date().getTime();
                if (now - stateData.timestamp > 24 * 60 * 60 * 1000) {
                    localStorage.removeItem('armorworkout-in-progress');
                    return;
                }
                
                // Ask user if they want to resume
                if (confirm('Un entraînement en cours a été trouvé. Voulez-vous reprendre?')) {
                    state.currentWorkoutType = stateData.workoutType;
                    state.currentWorkout = stateData.workout;
                    state.currentItemIndex = stateData.itemIndex;
                    state.timeLeft = stateData.timeLeft;
                    state.totalDuration = calculateTotalEstimatedTime();
                    
                    // Load the workout UI
                    elements.workoutTypeDisplay.textContent = `Entraînement ${state.currentWorkoutType.charAt(0).toUpperCase() + state.currentWorkoutType.slice(1)}`;
                    document.getElementById(`${state.currentWorkoutType}-btn`).classList.add('active');
                    
                    // Set the state (this will update the UI)
                    setState(stateData.currentState);
                    
                    // If not paused, start the timer
                    if (state.currentState !== 'paused' && state.currentState !== 'idle') {
                        startTimer();
                    }
                } else {
                    localStorage.removeItem('armorworkout-in-progress');
                }
            } catch (error) {
                console.error('Error loading in-progress state:', error);
                localStorage.removeItem('armorworkout-in-progress');
            }
        }

        function clearInProgressState() {
            localStorage.removeItem('armorworkout-in-progress');
        }

        // Utility functions
        function showMessage(text, type = 'info') {
            const message = elements.messageArea;
            message.textContent = text;
            message.className = `message ${type} show`;
            
            setTimeout(() => {
                message.classList.remove('show');
            }, 3000);
        }

        function vibrate(duration = 200) {
            if ('vibrate' in navigator) {
                navigator.vibrate(duration);
            }
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
