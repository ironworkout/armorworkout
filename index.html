<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArmorWorkout - High Voltage</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            /* --- PALETTE CŒUR DU RÉACTEUR --- */
            --bg-deep: #02040a;
            --bg-panel: #0a101f;
            --text-main: #e2e8f0;
            --text-dim: #94a3b8;
            
            /* --- COULEURS ÉLECTRIQUES --- */
            --cyan-core: #00f3ff;
            --cyan-glow: #00e1ff;
            --blue-plasma: #3b82f6;
            --purple-flux: #a855f7;
            --green-stable: #22c55e;
            --yellow-warning: #eab308;
            --red-critical: #ef4444;
            --neon-pink: #f472b6; /* Spécial Superset */

            /* --- RGB --- */
            --cyan-rgb: 0, 243, 255;
            
            /* --- ÉTATS DU SYSTÈME --- */
            --color-idle: var(--blue-plasma);
            --color-preparing: var(--purple-flux);
            --color-exercise: var(--blue-plasma);
            --color-exercise-timed: var(--yellow-warning);
            --color-break: var(--cyan-core);
            --color-superset: var(--neon-pink);
            --color-finished: var(--green-stable);
            --color-paused: #64748b;

            /* --- UI VARS --- */
            --font-ui: 'Inter', sans-serif;
            --font-hud: 'Orbitron', sans-serif;
            --radius-ui: 2px; /* Angles vifs style HUD */
            --hud-border: 1px solid rgba(0, 243, 255, 0.2);
            --timer-circumference: 289; /* 2 * PI * 46 */
        }

        /* --- BASE & AMBIANCE --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: var(--font-ui);
            min-height: 100vh;
            overflow-x: hidden;
            display: flex; flex-direction: column;
            /* Grille technique en fond */
            background-image: 
                linear-gradient(rgba(0, 243, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 243, 255, 0.03) 1px, transparent 1px),
                radial-gradient(circle at 50% 0%, rgba(0, 191, 255, 0.1), transparent 80%);
            background-size: 40px 40px, 40px 40px, 100% 100%;
            transition: background-color 0.1s;
        }

        /* EFFET FLASH ÉCRAN */
        body.flash-active {
            background-color: rgba(255, 255, 255, 0.15);
        }

        /* --- HEADER TACTIQUE --- */
        header {
            background: rgba(2, 4, 10, 0.9);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 243, 255, 0.15);
            padding: 15px 0;
            position: sticky; top: 0; z-index: 1000;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        header::after {
            content:''; position:absolute; bottom:0; left:0; width:100%; height:1px;
            background: linear-gradient(90deg, transparent, var(--cyan-core), transparent); opacity:0.5;
        }
        .header-content { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        
        h1 { 
            font-family: var(--font-hud); font-weight: 900; font-size: 1.5em; text-transform: uppercase; letter-spacing: 2px;
            color: #fff; text-shadow: 0 0 10px rgba(0, 243, 255, 0.5); display: flex; align-items: center; gap: 10px;
        }
        h1 i { color: var(--cyan-core); animation: pulse-opacity 2s infinite; }

        .header-actions button, .header-actions div {
            background: rgba(0, 243, 255, 0.05);
            border: 1px solid rgba(0, 243, 255, 0.2);
            color: var(--cyan-core);
            font-family: var(--font-hud);
            font-size: 0.75em; letter-spacing: 1px; text-transform: uppercase;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex; align-items: center; gap: 8px;
        }
        #signin-button:hover:not(:disabled) {
            background: rgba(0, 243, 255, 0.15);
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.3);
            border-color: var(--cyan-core);
            transform: translateY(-1px);
        }
        button:disabled { opacity: 0.4; cursor: not-allowed; filter: grayscale(1); }
        
        #drive-status.success { color: var(--green-stable); border-color: var(--green-stable); background: rgba(34, 197, 94, 0.05); }
        #drive-status.loading { color: var(--yellow-warning); border-color: var(--yellow-warning); }

        /* --- CONTENEUR PRINCIPAL --- */
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; flex-grow: 1; width: 100%; position: relative; }
        .app-section { width: 100%; animation: fadeIn 0.5s ease-out; }
        .section-hidden { display: none !important; }

        /* --- HOME & CALENDRIER --- */
        .home-grid { display: flex; flex-wrap: wrap; gap: 25px; }
        .home-main { flex: 1 1 60%; }
        .home-sidebar { flex: 1 1 35%; min-width: 300px; }

        /* Module Sidebar (Style HUD) */
        .sidebar-module {
            background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(255,255,255,0.1);
            padding: 20px; margin-bottom: 20px; position: relative;
        }
        .sidebar-module::before {
            content:''; position:absolute; top:-1px; left:-1px; width:10px; height:10px;
            border-top: 2px solid var(--cyan-core); border-left: 2px solid var(--cyan-core);
        }
        .sidebar-module h3 { 
            font-family:var(--font-hud); border-bottom:1px solid var(--text-dim); 
            padding-bottom:10px; margin-bottom:15px; color:var(--cyan-core); font-size: 1em;
        }

        /* Calendrier */
        .monthly-calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; font-size: 0.85em; }
        .calendar-header { color: var(--text-dim); padding-bottom: 5px; }
        .calendar-day {
            height: 32px; display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.03); border-radius: 2px; position: relative;
            transition: all 0.2s;
        }
        .calendar-day.today {
            border: 1px solid var(--cyan-core); color: var(--cyan-core);
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.2); font-weight: 700;
            background: rgba(0, 243, 255, 0.1);
        }
        .day-dot {
            width: 6px; height: 6px; background: var(--cyan-core);
            border-radius: 50%; box-shadow: 0 0 8px var(--cyan-core);
            position: absolute; bottom: 3px; left: 50%; transform: translateX(-50%);
            border: 1px solid rgba(255,255,255,0.8);
        }

        /* Cartes Session */
        .session-card-large {
            background: linear-gradient(145deg, rgba(10,16,31,0.8), rgba(5,8,15,0.9));
            border: 1px solid rgba(59, 130, 246, 0.3);
            margin-bottom: 20px; padding: 0;
            position: relative; overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        .session-card-large::before { /* Barre latérale style HUD */
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
            background: var(--blue-plasma); box-shadow: 0 0 10px var(--blue-plasma);
            transition: background 0.3s;
        }
        .session-card-large:hover {
            transform: translateY(-3px); border-color: var(--cyan-core);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5), 0 0 15px rgba(0, 243, 255, 0.1);
        }
        .session-card-large:hover::before { background: var(--cyan-core); box-shadow: 0 0 15px var(--cyan-core); }
        
        .session-card-summary { padding: 25px; }
        .session-card-header h3 { font-family: var(--font-hud); font-size: 1.4em; margin-bottom: 5px; color: #fff; }
        .session-card-large p { color: var(--text-dim); font-size: 0.9em; }

        /* --- MODE WORKOUT (FULL SCREEN) --- */
        body.workout-active main { 
            position: fixed; inset: 0; z-index: 2000; 
            background: var(--bg-deep); padding: 10px; 
            overflow-y: auto; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; 
        }
        /* En mode workout, on cache tout sauf la section workout */
        body.workout-active header, body.workout-active footer { display: none; }
        #workout-section { width: 100%; max-width: 600px; margin: 0 auto; text-align: center; }

        /* --- LE RÉACTEUR ARC (TIMER) --- */
        .timer-display {
            width: 280px; height: 280px; margin: 0 auto 30px;
            position: relative; display: flex; justify-content: center; align-items: center;
            cursor: pointer; user-select: none; -webkit-tap-highlight-color: transparent;
        }
        
        .timer-progress-circle-bg { fill: none; stroke: rgba(255,255,255,0.05); stroke-width: 4; }
        .timer-progress-circle {
            fill: none; stroke-width: 4; stroke-linecap: round;
            stroke: var(--cyan-core);
            filter: drop-shadow(0 0 8px var(--cyan-core));
            transform-origin: center; transform: rotate(-90deg);
            transition: stroke-dashoffset 0.5s linear, stroke 0.3s ease;
        }

        .reactor {
            width: 200px; height: 200px; border-radius: 50%;
            position: relative; z-index: 10;
            background: radial-gradient(circle, rgba(10,16,31,0.8) 0%, rgba(2,4,10,1) 100%);
            box-shadow: inset 0 0 30px rgba(0,0,0,1);
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; border: 1px solid rgba(255,255,255,0.05);
        }

        /* TRIANGLE CENTRAL (Stabilisé) */
        .triangle {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); /* Centrage strict */
            width: 140px; aspect-ratio: 1;
            background-color: var(--color-idle);
            clip-path: polygon(50% 85%, 0 0, 100% 0);
            opacity: 0.8;
            box-shadow: 0 0 20px currentColor;
            transition: background-color 0.3s ease; /* PAS DE TRANSITION SUR TRANSFORM */
        }
        .triangle::after {
            content: ''; position: absolute; top: 2px; left: 50%; 
            transform: translateX(-50%);
            width: 110px; aspect-ratio: 1;
            background-color: var(--bg-deep);
            clip-path: polygon(50% 85%, 0 0, 100% 0);
        }

        /* Animation Rotation */
        @keyframes reactor-spin { 
            from { transform: translate(-50%, -50%) rotate(0deg); } 
            to { transform: translate(-50%, -50%) rotate(360deg); } 
        }
        
        /* États du triangle */
        body.state-preparing .triangle { animation: reactor-spin 2s linear infinite; background-color: var(--color-preparing); }
        body.state-exercise .triangle { background-color: var(--color-exercise); }
        body.state-exercise[data-timed="true"] .triangle { background-color: var(--color-exercise-timed); }
        body.state-break .triangle { background-color: var(--color-break); }
        body.state-finished .triangle { background-color: var(--color-finished); }
        
        #time-left {
            position: absolute; z-index: 20;
            font-family: var(--font-hud); font-size: 4em; font-weight: 700;
            color: #fff; text-shadow: 0 0 15px currentColor; pointer-events: none;
        }

        /* --- INFO EXERCICE --- */
        #current-exercise-name-display {
            font-family: var(--font-hud); font-size: 1.8em; font-weight: 700;
            color: #fff; text-transform: uppercase; letter-spacing: 1px;
            margin-bottom: 15px; text-shadow: 0 0 10px rgba(0, 243, 255, 0.3);
        }

        .exercise-details {
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1);
            padding: 15px 30px; border-radius: var(--radius-ui);
            display: inline-flex; flex-direction: column; gap: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            position: relative; overflow: hidden; margin-bottom: 20px;
        }
        .exercise-details::after { /* Barre de soulignement couleur */
            content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px;
            background: currentColor; box-shadow: 0 0 10px currentColor;
        }
        .main-stats { font-size: 1.4em; font-weight: 600; display: flex; gap: 20px; color: #fff; justify-content: center; }

        /* --- SUPERSET PREVIEW (Amélioration Demandée) --- */
        .next-exercise-preview {
            margin-top: 10px;
            background: rgba(10, 16, 31, 0.8);
            border: 1px dashed var(--text-dim);
            padding: 15px; width: 90%; max-width: 400px; margin-left: auto; margin-right: auto;
            text-align: left; position: relative;
        }
        
        /* Style spécial Superset */
        .next-exercise-preview.is-superset {
            border: 1px solid var(--color-superset);
            background: rgba(244, 114, 182, 0.05);
            box-shadow: 0 0 20px rgba(244, 114, 182, 0.15);
            animation: pulse-border 2s infinite;
        }
        .superset-badge {
            display: inline-block; background: var(--color-superset); color: #000;
            font-family: var(--font-hud); font-weight: 900; font-size: 0.75em;
            padding: 4px 8px; margin-bottom: 10px; border-radius: 2px;
            text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 0 10px var(--color-superset);
        }
        
        .preview-list { list-style: none; padding-left: 0; }
        .preview-list li {
            display: flex; align-items: center; justify-content: space-between;
            padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 0.95em; color: var(--text-main);
        }
        .preview-list li:last-child { border-bottom: none; }
        .preview-list li i { margin-right: 10px; color: var(--text-dim); width: 20px; text-align: center;}
        .is-superset .preview-list li i { color: var(--color-superset); }

        /* --- CONTROLS --- */
        .controls { margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .controls button {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            color: var(--text-dim); padding: 15px 20px; font-family: var(--font-hud);
            font-size: 0.9em; cursor: pointer; transition: all 0.2s;
            border-radius: 2px; text-transform: uppercase;
            flex: 1; min-width: 100px; max-width: 150px;
        }
        .controls button:hover:not(:disabled) { background: rgba(255,255,255,0.1); border-color: var(--text-main); color: #fff; }
        .controls button:disabled { opacity: 0.3; cursor: not-allowed; }
        
        #start-pause-btn.start-btn {
            border-color: var(--cyan-core); color: var(--cyan-core);
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.1);
        }
        #start-pause-btn.start-btn:hover {
            background: var(--cyan-core); color: #000;
            box-shadow: 0 0 25px var(--cyan-core);
        }

        /* --- ANIMATIONS --- */
        @keyframes pulse-opacity { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes pulse-border { 0%, 100% { border-color: var(--color-superset); } 50% { border-color: transparent; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- FOOTER --- */
        footer { 
            margin-top: auto; padding: 20px; text-align: center; font-size: 0.8em; color: var(--text-dim);
            border-top: 1px solid rgba(0,243,255,0.1); background: rgba(2,4,10,0.8);
        }
        footer a { color: var(--cyan-core); text-decoration: none; }

        /* --- MESSAGE AREA --- */
        .message-area {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(10, 16, 31, 0.95); color: #fff;
            border: 1px solid var(--cyan-core); box-shadow: 0 0 20px rgba(0,0,0,0.5);
            padding: 15px 30px; border-radius: 2px; font-weight: 600;
            z-index: 9999; opacity: 0; pointer-events: none; transition: opacity 0.3s;
            font-family: var(--font-hud); text-transform: uppercase; letter-spacing: 1px;
        }
        .message-area.visible { opacity: 1; pointer-events: auto; }

        /* --- RESPONSIVE --- */
        @media (max-width: 600px) {
            .timer-display { width: 240px; height: 240px; }
            .reactor { width: 170px; height: 170px; }
            #time-left { font-size: 3em; }
            .triangle { width: 110px; } .triangle::after { width: 85px; }
            .home-grid { flex-direction: column; }
        }
    </style>
</head>
<body class="logged-out state-idle">

    <header>
        <div class="header-content">
            <h1><i class="fas fa-bolt"></i> ArmorWorkout</h1>
            <div class="header-actions">
                <div id="drive-status" style="display: none; padding: 5px 10px; border: 1px solid; font-size: 0.8em;"> 
                    <span id="drive-status-text">SYNC</span>
                </div>
                <button id="signin-button" disabled><i class="fab fa-google"></i> CONNEXION</button>
            </div>
        </div>
    </header>

    <div class="container">
        <main>
            <!-- SECTION ACCUEIL -->
            <div id="home-section" class="app-section">
                <!-- Le contenu sera injecté par JS -->
                <div style="text-align: center; padding: 50px;">
                    <i class="fas fa-circle-notch fa-spin" style="color: var(--cyan-core); font-size: 2em;"></i>
                    <p style="margin-top: 20px; color: var(--text-dim);">Initialisation du système...</p>
                </div>
            </div>

            <!-- SECTION WORKOUT (Active) -->
            <div class="workout-section app-section section-hidden" id="workout-section">
                
                <div id="workout-info">
                    <div id="current-exercise-name-display">PRÊT ?</div>
                    <div id="current-exercise-container"></div>
                </div>

                <div class="timer-display" id="timer-display-clickable">
                    <!-- Cercle SVG -->
                    <div style="position: absolute; inset: 0; z-index: 20;">
                        <svg viewBox="0 0 100 100" style="width: 100%; height: 100%;">
                            <circle class="timer-progress-circle-bg" cx="50" cy="50" r="46"></circle>
                            <circle id="timer-progress-indicator" class="timer-progress-circle" cx="50" cy="50" r="46" stroke-dasharray="289" stroke-dashoffset="0"></circle>
                        </svg>
                    </div>
                    
                    <!-- Cœur du réacteur -->
                    <div class="reactor">
                        <div class="triangle"></div>
                        <div id="time-left">00:00</div>
                    </div>
                </div>
    
                <div class="controls">
                    <button id="prev-btn" disabled><i class="fas fa-backward"></i></button>
                    <button id="start-pause-btn" disabled class="start-btn">DÉMARRER</button>
                    <button id="skip-btn" disabled><i class="fas fa-forward"></i></button>
                    <button id="finish-btn" disabled><i class="fas fa-flag-checkered"></i></button>
                    <button id="reset-btn" disabled><i class="fas fa-times"></i></button>
                </div>
    
                <div id="progress-tracker" style="margin-top: 20px; color: var(--text-dim); font-family: var(--font-hud); font-size: 0.8em;">
                    <span id="progress-text-area">PRÊT AU DÉPART</span>
                </div>
            </div>
        </main>
    </div>
    
    <div id="message-area" class="message-area"></div>
    
    <!-- MODAL RESUME (Simplifiée pour le fichier unique, fonctionnelle) -->
    <div id="post-workout-summary" style="display:none;"></div>

    <footer>
        <p>ARMORWORKOUT OS v2.0 // <a href="https://github.com/ironworkout/armorworkout">GITHUB</a></p>
    </footer>

    <!-- SCRIPTS GOOGLE -->
    <script async defer src="https://accounts.google.com/gsi/client"></script>
    <script>
        "use strict";

        // --- CONFIGURATION ---
        const GOOGLE_CLIENT_ID = "731283926358-viam3ulpgna14flfdeb9m92l8s620hoi.apps.googleusercontent.com";
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const FILES = { 
            HISTORY: "armorworkout_history.json", 
            PROGRAM: "programmeCompletHypertrophieElite_v1.json" 
        };
        const PREPARE_DURATION = 5;
        const CIRCUMFERENCE = 289; // 2 * PI * 46

        // --- ÉTAT ---
        let state = {
            token: null,
            fullProgram: null,
            history: [],
            currentPlan: [],
            index: 0,
            status: 'idle',
            timeLeft: 0,
            totalTime: 0,
            startTime: null,
            workoutType: null
        };
        
        let timers = { main: null };
        let ui = {};

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            initRefs();
            initSounds();
            checkGIS();
            
            // Listeners
            ui.btnStart.onclick = togglePlayPause;
            ui.btnSkip.onclick = nextStep;
            ui.btnPrev.onclick = prevStep;
            ui.btnFinish.onclick = finishWorkout;
            ui.btnReset.onclick = resetWorkout;
            ui.btnAuth.onclick = handleAuthClick;
            ui.timerArea.onclick = () => { if(state.status === 'exercise' && !ui.body.dataset.timed) nextStep(); };

            // Initialisation Vue
            renderHome();
        });

        function initRefs() {
            ui = {
                home: document.getElementById('home-section'),
                workout: document.getElementById('workout-section'),
                timeLeft: document.getElementById('time-left'),
                circle: document.getElementById('timer-progress-indicator'),
                exName: document.getElementById('current-exercise-name-display'),
                exContainer: document.getElementById('current-exercise-container'),
                btnStart: document.getElementById('start-pause-btn'),
                btnSkip: document.getElementById('skip-btn'),
                btnPrev: document.getElementById('prev-btn'),
                btnFinish: document.getElementById('finish-btn'),
                btnReset: document.getElementById('reset-btn'),
                btnAuth: document.getElementById('signin-button'),
                driveStatus: document.getElementById('drive-status'),
                msgArea: document.getElementById('message-area'),
                body: document.body,
                timerArea: document.getElementById('timer-display-clickable')
            };
        }

        // --- SONS ---
        let sounds = {};
        function initSounds() {
            const bp = "https://ironworkout.github.io/armorworkout/";
            ['laser', '5', '4', '3', '2', '1', 'e-t'].forEach(s => {
                sounds[s] = new Audio(bp + s + '.mp3');
            });
        }
        function play(name) { if(sounds[name]) { sounds[name].currentTime=0; sounds[name].play().catch(()=>{}); } }

        // --- LOGIQUE MOTEUR ---
        function loadSession(name) {
            const s = state.fullProgram.sessions.find(x => x.nom_session === name);
            if(!s) return showMsg("Erreur session", true);
            
            state.workoutType = name;
            state.currentPlan = JSON.parse(JSON.stringify(s.exercices_et_pauses));
            state.index = 0;
            state.startTime = Date.now();
            changeState('preparing');
        }

        function changeState(newStatus) {
            state.status = newStatus;
            clearInterval(timers.main);
            ui.body.className = `workout-active state-${newStatus}`;
            updateControls();

            if(newStatus === 'idle') {
                ui.body.className = 'logged-in state-idle'; // Reset
                renderHome();
            }
            else if(newStatus === 'preparing') {
                state.timeLeft = PREPARE_DURATION;
                state.totalTime = PREPARE_DURATION;
                runTimer(nextStep);
            }
            else if(newStatus === 'exercise' || newStatus === 'break') {
                // Flash Effect
                ui.body.classList.add('flash-active');
                setTimeout(() => ui.body.classList.remove('flash-active'), 300);
                
                if(newStatus === 'break') play('laser');

                const item = state.currentPlan[state.index];
                const isTimed = (item.duration !== undefined && item.duration !== null);
                
                if(isTimed || newStatus === 'break') {
                    // Utilise la durée de l'item, sinon fallback break
                    let dur = item.duration;
                    // Si c'est un break mais pas de durée définie dans le json (rare), défaut 60s
                    if(newStatus === 'break' && !dur) dur = 60;
                    
                    state.timeLeft = dur;
                    state.totalTime = dur;
                    runTimer(nextStep);
                } else {
                    state.timeLeft = 0;
                    state.totalTime = 0;
                    updateTimerUI("GO");
                    ui.circle.style.strokeDashoffset = 0;
                }
            }
            else if(newStatus === 'finished') {
                play('e-t');
                saveWorkout();
                showMsg("SÉANCE TERMINÉE !", false);
                setTimeout(() => changeState('idle'), 2000);
            }
            updateDisplay();
        }

        function runTimer(onEnd) {
            updateTimerUI(formatTime(state.timeLeft));
            timers.main = setInterval(() => {
                state.timeLeft--;
                updateTimerUI(formatTime(state.timeLeft));
                
                // Progress
                const ratio = state.timeLeft / state.totalTime;
                ui.circle.style.strokeDashoffset = CIRCUMFERENCE * (1 - ratio);

                // Sounds
                if(state.timeLeft <= 5 && state.timeLeft > 0) play(state.timeLeft.toString());
                
                if(state.timeLeft <= 0) {
                    clearInterval(timers.main);
                    onEnd();
                }
            }, 1000);
        }

        function nextStep() {
            state.index++;
            if(state.index >= state.currentPlan.length) changeState('finished');
            else {
                const type = state.currentPlan[state.index].type;
                changeState(type === 'break' ? 'break' : 'exercise');
            }
        }

        function prevStep() {
            if(state.index > 0) {
                state.index--;
                const type = state.currentPlan[state.index].type;
                changeState(type === 'break' ? 'break' : 'exercise');
            }
        }

        function togglePlayPause() {
            if(state.status === 'paused') {
                // Resume simple : on relance le timer là où il en était
                state.status = ui.body.dataset.prevStatus || 'exercise';
                ui.body.classList.remove('state-paused');
                ui.body.classList.add('state-'+state.status);
                if(state.timeLeft > 0) runTimer(nextStep);
            } else {
                ui.body.dataset.prevStatus = state.status;
                state.status = 'paused';
                clearInterval(timers.main);
                ui.body.className = 'workout-active state-paused';
                updateControls();
            }
        }

        function finishWorkout() { if(confirm("Finir la séance ?")) changeState('finished'); }
        function resetWorkout() { if(confirm("Quitter sans sauver ?")) changeState('idle'); }

        // --- AFFICHAGE ---
        function updateDisplay() {
            if(state.status === 'idle') return;
            const item = state.currentPlan[state.index] || {};

            // TEXTES
            if(state.status === 'preparing') {
                ui.exName.innerText = "PRÉPARATION";
                ui.exContainer.innerHTML = `<div style="color:var(--color-preparing); font-family:var(--font-hud)">PRÉPAREZ-VOUS</div>`;
            }
            else if(state.status === 'break') {
                ui.exName.innerText = "REPOS";
                
                // --- LOGIQUE SUPERSET (Nouveauté) ---
                // On regarde les exercices suivants jusqu'au prochain repos
                let upcoming = [];
                for(let i = state.index + 1; i < state.currentPlan.length; i++) {
                    if(state.currentPlan[i].type === 'break') break;
                    upcoming.push(state.currentPlan[i]);
                }

                let html = '';
                if(upcoming.length > 0) {
                    const isSuperset = upcoming.length > 1;
                    html = `<div class="next-exercise-preview ${isSuperset ? 'is-superset' : ''}">`;
                    
                    if(isSuperset) html += `<span class="superset-badge"><i class="fas fa-link"></i> SUPERSET DÉTECTÉ</span>`;
                    else html += `<div style="color:var(--text-dim); font-size:0.8em; margin-bottom:5px;">À SUIVRE :</div>`;
                    
                    html += `<ul class="preview-list">`;
                    upcoming.forEach(ex => {
                        html += `<li>
                            <span><i class="fas fa-dumbbell"></i> ${ex.name}</span>
                            <span style="font-family:var(--font-hud)">${formatReps(ex)}</span>
                        </li>`;
                    });
                    html += `</ul></div>`;
                } else {
                    html = `<div style="color:var(--text-dim)">Dernière ligne droite !</div>`;
                }
                ui.exContainer.innerHTML = html;
            }
            else {
                // EXERCISE
                ui.exName.innerText = item.name || "EXO";
                const isTimed = (item.duration !== undefined && item.duration !== null);
                ui.body.dataset.timed = isTimed;
                
                const color = isTimed ? 'var(--color-exercise-timed)' : 'var(--color-exercise)';
                
                ui.exContainer.innerHTML = `
                    <div class="exercise-details" style="color:${color}; border-color:${color}; box-shadow: 0 0 10px ${color};">
                        <div class="main-stats">
                            <span>${formatReps(item)}</span>
                            <span>${item.weight_text || (item.weight ? item.weight+'kg' : 'PDC')}</span>
                        </div>
                        <div style="font-size:0.8em; opacity:0.7; text-align:center;">${item.sets_info || ''}</div>
                    </div>
                `;
            }
        }

        function updateControls() {
            const active = ['exercise','break','preparing'].includes(state.status);
            ui.btnStart.disabled = (!active && state.status !== 'paused');
            ui.btnStart.innerHTML = (state.status === 'paused') ? "REPRENDRE" : "PAUSE";
            
            if(state.status === 'exercise' && !ui.body.dataset.timed) ui.btnStart.innerHTML = "VALIDER"; // Exo reps
            if(state.status === 'idle') ui.btnStart.innerHTML = "DÉMARRER"; // Fallback

            ui.btnSkip.disabled = !active;
            ui.btnPrev.disabled = state.index === 0;
            ui.btnFinish.disabled = !active;
        }

        function updateTimerUI(txt) { ui.timeLeft.innerText = txt; }
        function formatTime(s) { 
            const m = Math.floor(s/60).toString().padStart(2,'0');
            const sc = (s%60).toString().padStart(2,'0');
            return `${m}:${sc}`;
        }
        function formatReps(it) { return it.duration ? it.duration+"s" : (it.reps||"?")+" reps"; }

        // --- DRIVE & DATA ---
        let tokenClient;
        function checkGIS() {
            if(typeof google !== 'undefined') {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CLIENT_ID,
                    scope: SCOPES,
                    callback: async (resp) => {
                        if(resp.access_token) {
                            state.token = resp.access_token;
                            ui.btnAuth.style.display = 'none';
                            ui.driveStatus.style.display = 'inline-flex';
                            ui.driveStatus.className = 'loading';
                            document.getElementById('drive-status-text').innerText = "CHARGEMENT...";
                            
                            await loadAllData();
                            
                            ui.driveStatus.className = 'success';
                            document.getElementById('drive-status-text').innerText = "SYNC OK";
                        }
                    }
                });
                ui.btnAuth.disabled = false;
            } else {
                setTimeout(checkGIS, 500);
            }
        }

        function handleAuthClick() { tokenClient.requestAccessToken(); }

        async function loadAllData() {
            state.history = await loadFile(FILES.HISTORY, []);
            state.fullProgram = await loadFile(FILES.PROGRAM, null);
            renderHome();
        }

        async function loadFile(name, defaultVal) {
            // 1. Find ID
            const q = `name='${name}' and trashed=false`;
            const res = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}`, {
                headers: { 'Authorization': `Bearer ${state.token}` }
            });
            const data = await res.json();
            if(data.files && data.files.length > 0) {
                const id = data.files[0].id;
                // 2. Read Content
                const contentRes = await fetch(`https://www.googleapis.com/drive/v3/files/${id}?alt=media`, {
                    headers: { 'Authorization': `Bearer ${state.token}` }
                });
                return await contentRes.json();
            }
            return defaultVal;
        }

        async function saveWorkout() {
            if(!state.token || !state.workoutType) return;
            
            // DATE LOCALE (Fix bug +1 jour)
            const localDate = new Date().toLocaleDateString('sv-SE'); // YYYY-MM-DD
            
            const newEntry = {
                date: localDate,
                type: state.workoutType,
                duration: Math.floor((Date.now() - state.startTime)/1000)
            };
            state.history.push(newEntry);

            // Save to Drive (Find ID then Update)
            const q = `name='${FILES.HISTORY}' and trashed=false`;
            const res = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}`, {
                headers: { 'Authorization': `Bearer ${state.token}` }
            });
            const data = await res.json();
            let fileId;
            
            if(data.files && data.files.length > 0) fileId = data.files[0].id;
            else {
                // Create file logic omitted for brevity in single file, assuming file exists or will be handled manually if missing. 
                // For robust code, insert creation logic here.
                showMsg("Historique non trouvé sur Drive", true);
                return;
            }

            await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                method: 'PATCH',
                headers: { 'Authorization': `Bearer ${state.token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(state.history)
            });
            renderHome(); // Update calendar
        }

        // --- RENDER HOME ---
        function renderHome() {
            if(!state.fullProgram) {
                ui.home.innerHTML = `<div style="text-align:center; padding:40px;">
                    <h2 style="color:var(--cyan-core)">SYSTÈME EN ATTENTE</h2>
                    <p>Connectez-vous au Drive pour initialiser.</p>
                </div>`;
                return;
            }

            let html = `<div class="home-grid">`;
            
            // CALENDRIER
            html += `<div class="home-sidebar"><div class="sidebar-module">
                <h3><i class="fas fa-calendar-alt"></i> HISTORIQUE</h3>
                ${renderCalendar()}
            </div></div>`;

            // SESSIONS
            html += `<div class="home-main">`;
            state.fullProgram.sessions.forEach(s => {
                html += `
                <div class="session-card-large" onclick="loadSession('${s.nom_session}')">
                    <div class="session-card-summary">
                        <div class="session-card-header">
                            <h3>${s.nom_session}</h3>
                            <p>${s.description_session || 'Entraînement'}</p>
                        </div>
                    </div>
                </div>`;
            });
            html += `</div></div>`;
            ui.home.innerHTML = html;
        }

        function renderCalendar() {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            // Set des dates d'entrainement (Strings YYYY-MM-DD)
            const workoutDates = new Set(state.history.map(h => h.date));

            let grid = `<div class="monthly-calendar">`;
            ['L','M','M','J','V','S','D'].forEach(d => grid+=`<div class="calendar-header">${d}</div>`);

            // Padding jours vides (simplifié, assume start Lundi pour démo, ajuster si besoin)
            const firstDay = new Date(year, month, 1).getDay(); 
            const offset = (firstDay + 6) % 7;
            for(let i=0; i<offset; i++) grid+=`<div></div>`;

            for(let i=1; i<=daysInMonth; i++) {
                // Construction string YYYY-MM-DD locale
                const dStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                const isToday = (i === today.getDate());
                const hasWorkout = workoutDates.has(dStr);

                grid += `<div class="calendar-day ${isToday?'today':''}">
                    ${i}
                    ${hasWorkout ? '<span class="day-dot"></span>' : ''}
                </div>`;
            }
            grid += `</div>`;
            return grid;
        }

        function showMsg(txt, err) {
            ui.msgArea.textContent = txt;
            ui.msgArea.style.color = err ? 'var(--red-critical)' : 'var(--green-stable)';
            ui.msgArea.style.borderColor = err ? 'var(--red-critical)' : 'var(--green-stable)';
            ui.msgArea.classList.add('visible');
            setTimeout(() => ui.msgArea.classList.remove('visible'), 3000);
        }

    </script>
</body>
</html>
