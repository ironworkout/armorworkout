<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArmorWorkout - Timer d'Entraînement Avancé</title>
    <!-- Font Awesome (CDNJS for reliability) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <!-- Google Identity Services (GIS) - chargé à la fin du body -->
    <style>
        /* --- Variables Globales & Thèmes --- */
        :root {
            /* Thème Sombre (Base) */
            --bg-color-dark: #0D1117; --secondary-bg-color-dark: #161B22; --primary-text-color-dark: #c9d1d9; --secondary-text-color-dark: #8b949e; --border-color-dark: #30363d; --accent-border-color-dark: #58a6ff33; --input-bg-dark: #0d1117;
            /* Couleurs Néon (Thème Sombre) */
            --neon-blue: #58a6ff; --neon-pink: #f778ba; --neon-red: #ff7b72; --neon-yellow: #facc15; --neon-green: #3fb950; --neon-purple: #bc8cff; --neon-orange: #f9a825;
            /* Glows (Thème Sombre) */
            --glow-blue: 0 0 12px rgba(88, 166, 255, 0.6); --glow-pink: 0 0 12px rgba(247, 120, 186, 0.6); --glow-red: 0 0 10px rgba(255, 123, 114, 0.6); --glow-yellow: 0 0 10px rgba(250, 204, 21, 0.5); --glow-green: 0 0 10px rgba(63, 185, 80, 0.6); --glow-purple: 0 0 12px rgba(188, 140, 255, 0.6); --glow-orange: 0 0 10px rgba(249, 168, 37, 0.6);
            /* Couleurs spécifiques aux états/types */
            --color-exercise: var(--neon-pink); --glow-exercise: var(--glow-pink); --color-exercise-rgb: 247, 120, 186; --icon-exercise: "\f44b"; /* fa-dumbbell */
            --color-break: var(--neon-yellow); --glow-break: var(--glow-yellow); --color-break-rgb: 250, 204, 21; --icon-break: "\f252"; /* fa-hourglass-half */
            --color-prepare: var(--neon-yellow); --glow-prepare: var(--glow-yellow); --color-prepare-rgb: 250, 204, 21; --icon-prepare: "\f110"; /* fa-spinner */
            --color-finished: var(--neon-green); --glow-finished: var(--glow-green); --color-finished-rgb: 63, 185, 80; --icon-finished: "\f058"; /* fa-check-circle */
            --color-paused: var(--neon-purple); --glow-paused: var(--glow-purple); --color-paused-rgb: 188, 140, 255; --icon-paused: "\f28b"; /* fa-pause-circle */
            --color-idle: var(--secondary-text-color-dark); --glow-idle: none; --color-idle-rgb: 139, 148, 158; --icon-idle: "\f144"; /* fa-play-circle */
            /* --- Autres Variables --- */
            --font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; --border-radius-lg: 12px; --border-radius-md: 8px; --border-radius-sm: 6px; --transition-speed: 0.25s; --section-transition-speed: 0.3s;
            /* Initialisation Thème Sombre par Défaut */
            --bg-color: var(--bg-color-dark); --secondary-bg-color: var(--secondary-bg-color-dark); --primary-text-color: var(--primary-text-color-dark); --secondary-text-color: var(--secondary-text-color-dark); --border-color: var(--border-color-dark); --accent-border-color: var(--accent-border-color-dark); --input-bg: var(--input-bg-dark);
            /* Variables pour le timer */
            --current-step-color: var(--color-idle); --current-step-glow: var(--glow-idle);
            --total-progress-gradient: var(--total-progress-bg, #2a2f36); --total-progress-bg: #2a2f36;
            /* Boutons Contrôle Timer */
            --button-reset-color: var(--neon-red); --button-reset-glow: var(--glow-red); --button-next-color: var(--neon-purple); --button-next-glow: var(--glow-purple); --button-prev-color: var(--neon-orange); --button-prev-glow: var(--glow-orange); --button-end-color: var(--secondary-text-color-dark); --button-end-glow: none; --button-start-color: var(--neon-blue); --button-start-glow: var(--glow-blue); --button-pause-color: var(--color-paused); --button-pause-glow: var(--glow-paused); --button-resume-color: var(--color-paused); --button-resume-glow: var(--glow-paused); --button-done-color: var(--color-exercise); --button-done-glow: var(--glow-exercise);
            /* Boutons Connexion */
            --button-connect-color: var(--neon-green); --button-connect-glow: var(--glow-green); --button-disconnect-color: var(--neon-red); --button-disconnect-glow: var(--glow-red); --link-color: var(--neon-blue);
            /* Variables RGBA */
            --neon-blue-rgb: 88, 166, 255; --neon-pink-rgb: 247, 120, 186; --neon-red-rgb: 255, 123, 114; --neon-yellow-rgb: 250, 204, 21; --neon-green-rgb: 63, 185, 80; --neon-purple-rgb: 188, 140, 255; --neon-orange-rgb: 249, 168, 37;
            --secondary-text-color-dark-rgb: 139, 148, 158; --bg-color-dark-rgb: 13, 17, 23; --secondary-bg-color-dark-rgb: 22, 27, 34; --primary-text-color-dark-rgb: 201, 209, 217;
            --color-exercise-rgb: 247, 120, 186; --color-break-rgb: 250, 204, 21; --color-prepare-rgb: 250, 204, 21; --color-finished-rgb: 63, 185, 80; --color-paused-rgb: 188, 140, 255; --color-idle-rgb: 139, 148, 158;
        }

        body.light-theme {
            /* Thème Clair */
            --bg-color: #ffffff; --secondary-bg-color: #f6f8fa; --primary-text-color: #24292f; --secondary-text-color: #57606a; --border-color: #d0d7de; --accent-border-color: #0969da33; --input-bg: #f6f8fa;
            /* Couleurs Néon adaptées */
            --neon-blue: #0969da; --neon-pink: #bf3989; --neon-red: #d73a49; --neon-yellow: #dbab09; --neon-green: #2da44e; --neon-purple: #8250df; --neon-orange: #f66a0a;
            /* Glows (Subtils ou désactivés en clair) */
            --glow-blue: 0 0 8px rgba(9, 105, 218, 0.3); --glow-pink: 0 0 8px rgba(191, 57, 137, 0.3); --glow-red: 0 0 8px rgba(215, 58, 73, 0.3); --glow-yellow: 0 0 8px rgba(219, 171, 9, 0.3); --glow-green: 0 0 8px rgba(45, 164, 78, 0.3); --glow-purple: 0 0 8px rgba(130, 80, 223, 0.3); --glow-orange: 0 0 8px rgba(246, 106, 10, 0.3);
            --total-progress-bg: #e1e4e8; --button-end-color: #57606a; --link-color: #0969da;
            /* Adapter les variables RGBA */
            --bg-color-dark-rgb: 255, 255, 255; --secondary-bg-color-dark-rgb: 246, 248, 250; --primary-text-color-dark-rgb: 36, 41, 47; --secondary-text-color-dark-rgb: 87, 96, 106;
            --color-exercise-rgb: 191, 57, 137; --color-break-rgb: 219, 171, 9; --color-prepare-rgb: 219, 171, 9; --color-finished-rgb: 45, 164, 78; --color-paused-rgb: 130, 80, 223; --color-idle-rgb: 87, 96, 106; --neon-orange-rgb: 246, 106, 10;
        }

        /* --- Styles de Base & Réinitialisation --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; font-size: 16px; }
        body {
            font-family: var(--font-family); background-color: var(--bg-color); color: var(--primary-text-color);
            line-height: 1.6; transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
            display: flex; flex-direction: column; min-height: 100vh;
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden; /* Empêche le débordement horizontal */
        }
        .container { max-width: 1100px; margin: 0 auto; padding: 30px 25px; width: 100%; flex-grow: 1; display: flex; flex-direction: column; }

        /* --- En-tête --- */
        header {
            padding: 15px 0; border-bottom: 1px solid var(--border-color);
            transition: border-color var(--transition-speed) ease, background-color var(--transition-speed) ease;
            position: sticky; top: 0; z-index: 1000;
            background-color: rgba(var(--bg-color-dark-rgb), 0.8); /* Effet verre dépoli */
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1100px; margin: 0 auto; padding: 0 25px; flex-wrap: wrap; gap: 15px 20px; }
        header h1 { font-size: 1.5em; color: var(--primary-text-color); margin: 0; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        header h1 i { color: var(--neon-blue); animation: pulse 2s infinite ease-in-out; }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.1); opacity: 1; } }

        /* --- Navigation Header --- */
        nav ul { list-style: none; display: flex; gap: 25px; flex-wrap: wrap; justify-content: center; align-items: center; }
        nav button {
            background: none; border: none; color: var(--secondary-text-color); font-size: 1em; font-weight: 500; padding: 5px 0;
            cursor: pointer; transition: color var(--transition-speed) ease, box-shadow var(--transition-speed) ease, border-color var(--transition-speed) ease;
            position: relative; border-bottom: 2px solid transparent;
        }
        nav button:disabled {
             color: rgba(var(--secondary-text-color-dark-rgb), 0.5); cursor: not-allowed; border-bottom-color: transparent !important; box-shadow: none !important; opacity: 0.6; pointer-events: none; /* Ajouté */
        }
        nav button:not(:disabled):hover { color: var(--primary-text-color); }
        nav button.active { color: var(--neon-blue); font-weight: 700; border-bottom-color: var(--neon-blue); box-shadow: 0 5px 15px -5px rgba(var(--neon-blue-rgb), 0.4); }

        /* Styles spécifiques pour boutons Historique et Progression */
        #nav-history { color: var(--secondary-text-color); border-bottom-color: transparent; }
        #nav-history:hover:not(:disabled) { color: var(--neon-pink); }
        #nav-history.active { color: var(--neon-pink); border-bottom-color: var(--neon-pink); box-shadow: 0 5px 15px -5px rgba(var(--neon-pink-rgb), 0.4); }
        #nav-history i { margin-right: 5px; }

        #nav-progress { color: var(--secondary-text-color); border-bottom-color: transparent; }
        #nav-progress:hover:not(:disabled) { color: var(--neon-green); }
        #nav-progress.active { color: var(--neon-green); border-bottom-color: var(--neon-green); box-shadow: 0 5px 15px -5px rgba(var(--neon-green-rgb), 0.4); }
        #nav-progress i { margin-right: 5px; }

        /* --- Actions Header --- */
        .header-actions { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
        .auth-controls { display: flex; gap: 10px; align-items: center; }
        .auth-controls button {
            background: none; border: 1px solid var(--accent-border-color); color: var(--secondary-text-color); padding: 6px 14px;
            border-radius: var(--border-radius-md); font-size: 0.85em; font-weight: 500; cursor: pointer;
            transition: all var(--transition-speed) ease; display: inline-flex; align-items: center; gap: 6px;
        }
        .auth-controls button:disabled {
            opacity: 0.5; cursor: not-allowed; /* pointer-events: none; */ border-color: var(--border-color) !important; color: var(--secondary-text-color) !important; box-shadow: none !important; background-color: transparent !important;
        }
        .auth-controls button:not(:disabled):hover { border-color: var(--primary-text-color); color: var(--primary-text-color); }
        #signin-button { border-color: var(--button-connect-color); color: var(--button-connect-color); }
        #signin-button:not(:disabled):hover { background-color: rgba(var(--neon-green-rgb), 0.1); box-shadow: var(--glow-green); border-color: var(--neon-green); }
        #signout-button { border-color: var(--button-disconnect-color); color: var(--button-disconnect-color); }
        #signout-button:not(:disabled):hover { background-color: rgba(var(--neon-red-rgb), 0.1); box-shadow: var(--glow-red); border-color: var(--neon-red); }
        #export-button { border-color: var(--neon-blue); color: var(--neon-blue); }
        #export-button:not(:disabled):hover { background-color: rgba(var(--neon-blue-rgb), 0.1); box-shadow: var(--glow-blue); border-color: var(--neon-blue); }

        #drive-status {
            font-size: 0.8em; color: var(--secondary-text-color); margin-left: 5px; transition: opacity 0.3s, color 0.3s, border-color 0.3s;
            min-width: fit-content; text-align: right; font-style: normal; padding: 4px 8px; background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.5);
            border-radius: var(--border-radius-sm); border: 1px solid var(--border-color); display: none; /* Initialement caché */
        }
        #drive-status.loading { color: var(--neon-yellow); border-color: var(--neon-yellow); animation: blink-border 1.5s infinite ease-in-out; }
        #drive-status.error { color: var(--neon-red); border-color: var(--neon-red); }
        #drive-status.success { color: var(--neon-green); border-color: var(--neon-green); }
        @keyframes blink-border { 50% { border-color: rgba(var(--neon-yellow-rgb), 0.4); } }

        .theme-toggle button { background: none; border: none; color: var(--secondary-text-color); font-size: 1.2em; padding: 5px; cursor: pointer; transition: color var(--transition-speed) ease; }
        .theme-toggle button:hover { color: var(--neon-yellow); }

        /* Logique affichage connexion/déconnexion */
        body.logged-out #signin-button { display: inline-flex; }
        body.logged-out #signout-button { display: none; }
        body.logged-out #drive-status { display: none; }
        body.logged-out .history-actions { display: none !important; } /* Forcé car contrôlé par JS */
        body.logged-out #drive-connection-status-main { display: none; }
        body.logged-out #export-button { display: none; }
        body.logged-out #nav-progress { display: none; } /* Cacher progression si pas loggué */

        body.logged-in #signin-button { display: none; }
        body.logged-in #signout-button { display: inline-flex; }
        body.logged-in #drive-status { display: inline-block; }
        body.logged-in .history-actions { display: flex !important; } /* Forcé car contrôlé par JS */
        body.logged-in #drive-connection-status-main { display: inline-flex; }
        body.logged-in #export-button { display: inline-flex; }
        body.logged-in #nav-progress { display: inline-block; }

        /* --- Contenu Principal --- */
        main { flex-grow: 1; display: flex; flex-direction: column; align-items: center; padding-top: 50px; position: relative; }
        /* Style de base pour toutes les sections + transition */
        .app-section {
            background-color: var(--secondary-bg-color);
            padding: 35px;
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--border-color);
            width: 100%;
            margin-bottom: 40px;
            transition: opacity var(--section-transition-speed) ease-in-out, /* Transition fade */
                        visibility 0s linear var(--section-transition-speed), /* Cacher après fade */
                        max-height 0s linear var(--section-transition-speed), /* Cacher après fade */
                        border-color var(--transition-speed) ease,
                        background-color var(--transition-speed) ease;
            max-height: 5000px; /* Assez grand pour contenir n'importe quoi */
            opacity: 1;
            visibility: visible;
            overflow: hidden;
        }
        /* Style spécifique workout section (pas de fond/bordure) */
        .workout-section {
            background-color: transparent;
            border: none;
            padding: 0;
            max-width: 600px;
            text-align: center;
            /* Transition pour la section workout reste potentiellement utile si on la cache */
            transition: opacity var(--section-transition-speed) ease-in-out,
                        visibility 0s linear var(--section-transition-speed),
                        max-height 0s linear var(--section-transition-speed);
        }
         .history-section, .progress-section {
            max-width: 850px;
            text-align: left;
         }

        /* Style pour cacher les sections */
        .section-hidden {
            opacity: 0;
            max-height: 0 !important; /* Forcer collapse */
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            margin-bottom: 0 !important;
            border-width: 0 !important;
            visibility: hidden;
            transition: opacity var(--section-transition-speed) ease-in-out, /* Transition fade */
                        visibility 0s linear var(--section-transition-speed),
                        max-height 0s linear var(--section-transition-speed),
                        padding var(--section-transition-speed) ease-out,
                        margin var(--section-transition-speed) ease-out,
                        border-width var(--section-transition-speed) ease-out;
        }
        /* Ajustement spécifique pour workout-section cachée */
         .workout-section.section-hidden {
             border: none !important;
         }

        /* --- Infos globales de progression --- */
        .overall-progress-info {
            text-align: center;
            font-size: 0.9em;
            color: var(--secondary-text-color);
            margin-bottom: 15px; /* Space before timer */
            min-height: 1.2em; /* Prevent layout shifts */
            opacity: 0; /* Hide initially */
            transition: opacity 0.3s ease;
            position: relative; /* Pour z-index si besoin */
            z-index: 5; /* Au dessus des cercles, en dessous de l'overlay reps */
        }
        body.workout-active .overall-progress-info {
            opacity: 0.8; /* Show when workout is active */
        }
        .overall-progress-info span {
             margin: 0 8px; /* Spacing between elements */
             font-variant-numeric: tabular-nums; /* Align numbers */
        }
         .overall-progress-info i {
             margin-right: 4px;
             opacity: 0.7;
         }


        /* --- Affichage Timer --- */
        .timer-display { margin-bottom: 30px; position: relative; display: flex; justify-content: center; align-items: center; width: 320px; height: 320px; margin-left: auto; margin-right: auto; cursor: pointer; user-select: none; -webkit-tap-highlight-color: transparent; }
        .timer-circle-container { position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; pointer-events: none; }
        #total-progress-circle, .timer-circle { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; display: flex; justify-content: center; align-items: center; border: 12px solid transparent; background-clip: padding-box; background-origin: border-box; box-sizing: border-box; }
        #total-progress-circle {
            border-color: var(--total-progress-bg);
            background: var(--total-progress-gradient, var(--total-progress-bg)); /* Utilise la variable JS */
            box-shadow: 0 0 25px rgba(var(--neon-blue-rgb), 0.3), 0 0 35px rgba(var(--neon-pink-rgb), 0.2), inset 0 0 20px rgba(var(--bg-color-dark-rgb), 0.5);
            z-index: 1; transition: background 0.3s linear;
        }
        .timer-circle {
            width: calc(100% - 48px); height: calc(100% - 48px); top: 24px; left: 24px;
            border-color: var(--border-color);
            background-image: conic-gradient(var(--current-step-color, var(--color-idle)) 0%, transparent 0%); /* Progression étape actuelle */
            box-shadow: var(--current-step-glow, var(--glow-idle)), inset 0 0 15px rgba(var(--bg-color-dark-rgb), 0.6);
            z-index: 3; transition: background-image 0.15s linear, box-shadow var(--transition-speed) ease, border-color var(--transition-speed) ease;
            background-size: 100% 100%; background-repeat: no-repeat; background-position: center center;
        }
        .timer-circle::before { /* Cache interne pour masquer la progression */
             content: ''; position: absolute; width: calc(100% - 24px); height: calc(100% - 24px); background-color: var(--bg-color); border-radius: 50%; z-index: 4; transition: background-color var(--transition-speed) ease;
        }
        .time-left { font-size: 5.5em; font-weight: 900; color: var(--primary-text-color); z-index: 5; transition: color var(--transition-speed) ease; font-variant-numeric: tabular-nums; position: relative; text-shadow: 0 0 10px rgba(var(--primary-text-color-dark-rgb), 0.3); }

        .timer-state {
            position: absolute; bottom: 15%; left: 50%; transform: translateX(-50%); font-size: 0.9em; letter-spacing: 0.08em;
            color: var(--current-step-color, var(--color-idle));
            font-weight: 500; text-transform: uppercase; opacity: 0; transition: opacity 0.3s ease, color var(--transition-speed) ease;
            background-color: transparent; padding: 0; box-shadow: none; z-index: 6;
            text-shadow: 0 0 8px rgba(var(--bg-color-dark-rgb), 0.7);
        }
        .timer-state.visible { opacity: 0.9; }
        .timer-state.preparing { animation: countdown-pulse 1s infinite; font-size: 1.1em; }
        @keyframes countdown-pulse { 0%, 100% { transform: translateX(-50%) scale(1); opacity: 1; } 50% { transform: translateX(-50%) scale(1.05); opacity: 0.85; } }

        /* --- Rep Adjustment Overlay --- */
        .rep-adjustment-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 10; background-color: rgba(var(--bg-color-dark-rgb), 0.85);
            padding: 20px; border-radius: var(--border-radius-md); border: 1px solid var(--border-color);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3); display: none; flex-direction: column;
            align-items: center; gap: 15px; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            width: 280px; /* Fix width */
        }
        .rep-adjustment-overlay.visible { display: flex; animation: fadeInScale 0.3s ease-out forwards; }
        @keyframes fadeInScale { from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); } to { opacity: 1; transform: translate(-50%, -50%) scale(1); } }
        .rep-adjustment-overlay .title { font-size: 1.1em; font-weight: 700; color: var(--primary-text-color); text-align: center; margin-bottom: 5px;}
        .rep-adjustment-controls { display: flex; align-items: center; gap: 15px; }
        .rep-adjustment-btn {
            width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1.4em; font-weight: 700; background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.9);
            border: 1px solid var(--border-color); color: var(--primary-text-color); cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        .rep-adjustment-btn.minus { border-color: var(--neon-red); color: var(--neon-red); }
        .rep-adjustment-btn.minus:hover { background-color: rgba(var(--neon-red-rgb), 0.15); box-shadow: var(--glow-red); }
        .rep-adjustment-btn.plus { border-color: var(--neon-green); color: var(--neon-green); }
        .rep-adjustment-btn.plus:hover { background-color: rgba(var(--neon-green-rgb), 0.15); box-shadow: var(--glow-green); }
        .rep-adjustment-btn:active { transform: scale(0.95); }
        .current-reps {
            font-size: 2.2em; font-weight: 900; color: var(--primary-text-color); font-variant-numeric: tabular-nums;
            min-width: 60px; text-align: center;
        }
        .rep-adjustment-next-exercise { font-size: 0.95em; color: var(--color-exercise); font-weight: 500; text-align: center; margin-top: 5px; }

        /* --- Infos Exercice --- */
        .workout-info { margin-bottom: 40px; min-height: 100px; position: relative; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        #current-exercise-name-display { display: block; font-size: 1.4em; font-weight: 700; color: var(--primary-text-color); margin-bottom: 8px; padding: 0 10px; min-height: 1.5em; transition: color 0.3s ease; }
        /* Coloration du titre selon l'état via classe body */
        body.state-exercise #current-exercise-name-display { color: var(--color-exercise); }
        body.state-break #current-exercise-name-display { color: var(--color-break); }
        body.state-paused #current-exercise-name-display { color: var(--color-paused); }
        body.state-preparing #current-exercise-name-display { color: var(--color-prepare); }
        body.state-finished #current-exercise-name-display { color: var(--color-finished); }

        #current-exercise-container { display: flex; flex-direction: column; align-items: center; gap: 8px; font-size: 1.1em; color: var(--secondary-text-color); min-height: 3em; width: 100%; }
        #current-exercise-container .exercise-details,
        #current-exercise-container .break-info,
        #current-exercise-container .idle-message {
            display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 10px 20px;
            background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.3); padding: 10px 18px; border-radius: var(--border-radius-md);
            border: 1px solid var(--border-color); width: fit-content; max-width: 90%;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        #current-exercise-container .exercise-details span,
        #current-exercise-container .break-info span { display: flex; align-items: center; gap: 6px; font-weight: 500; }
        #current-exercise-container .exercise-details span i { color: var(--color-exercise); width: 16px; text-align: center; } /* Icônes alignées */
        #current-exercise-container .break-info i { color: var(--color-break); width: 16px; text-align: center; }
        #current-exercise-container .exercise-details .details-text { font-size: 0.9em; opacity: 0.8; }
        #current-exercise-container .idle-message { border-style: dashed; opacity: 0.7; }
        #current-exercise-container .idle-message i { color: var(--neon-blue); }

        /* Performances Précédentes */
        .previous-performance {
            margin-top: 10px; padding: 8px 15px; background-color: rgba(var(--neon-blue-rgb), 0.1);
            border: 1px dashed var(--neon-blue); border-radius: var(--border-radius-md); font-size: 0.9em;
            color: var(--neon-blue); display: flex; align-items: center; gap: 10px; max-width: 90%;
            opacity: 0; animation: fadeIn 0.5s 0.2s ease-out forwards; /* Animation d'apparition */
        }
        @keyframes fadeIn { to { opacity: 1; } }
        .previous-performance i { font-size: 1.1em; }
        .previous-performance strong { font-weight: 700; }

        /* --- Progress Tracker --- */
        .progress-tracker { font-size: 0.9em; color: var(--secondary-text-color); margin-top: 30px; opacity: 0.8; font-weight: 500; display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 5px 15px; min-height: 1.2em; }
        #drive-connection-status-main { align-items: center; gap: 6px; }
        #drive-connection-status-main i.fa-google-drive { color: var(--neon-green); font-size: 1.1em; transition: color 0.3s ease; }
        #drive-connection-status-main i.fa-google-drive.fa-spin { animation: fa-spin 2s linear infinite; }
        #drive-connection-status-main i.fa-google-drive.error { color: var(--neon-red); animation: none; }
        @keyframes fa-spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #progress-text-area { font-weight: 500; }

        /* --- Contrôles Timer --- */
        .controls { display: flex; justify-content: center; gap: 10px; margin-top: 40px; flex-wrap: wrap; } /* Espace réduit */
        .controls button {
            background: transparent; border: 2px solid var(--accent-border-color); color: var(--primary-text-color); flex-grow: 1; /* Prend espace dispo */ max-width: 150px; /* Limite largeur */ padding: 10px 15px; /* Padding ajusté */
            border-radius: var(--border-radius-lg); font-size: 1.05em; font-weight: 500; cursor: pointer; transition: all var(--transition-speed) ease;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .controls button i { font-size: 0.9em; transition: transform 0.2s ease; }
        .controls button:disabled {
             border-color: var(--border-color) !important; color: var(--secondary-text-color) !important; opacity: 0.5; cursor: not-allowed; box-shadow: none !important; transform: none !important; background-color: transparent !important; pointer-events: none;
        }
        .controls button:not(:disabled):hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .controls button:not(:disabled):hover i { transform: scale(1.1); }
        .controls button:not(:disabled):active { transform: scale(0.97); }

        /* Styles spécifiques aux boutons basés sur la classe JS */
        #start-pause-btn.start-btn { border-color: var(--button-start-color); color: var(--button-start-color); }
        #start-pause-btn.start-btn:not(:disabled):hover { box-shadow: var(--glow-blue), 0 4px 8px rgba(0,0,0,0.1); background-color: rgba(var(--neon-blue-rgb), 0.08); }
        #start-pause-btn.pause-btn { border-color: var(--button-pause-color); color: var(--button-pause-color); }
        #start-pause-btn.pause-btn:not(:disabled):hover { box-shadow: var(--glow-paused), 0 4px 8px rgba(0,0,0,0.1); background-color: rgba(var(--color-paused-rgb), 0.08); }
        #start-pause-btn.resume-btn { border-color: var(--button-resume-color); color: var(--button-resume-color); }
        #start-pause-btn.resume-btn:not(:disabled):hover { box-shadow: var(--glow-paused), 0 4px 8px rgba(0,0,0,0.1); background-color: rgba(var(--color-paused-rgb), 0.08); }
        #start-pause-btn.done-btn { border-color: var(--button-done-color); color: var(--button-done-color); }
        #start-pause-btn.done-btn:not(:disabled):hover { box-shadow: var(--glow-exercise), 0 4px 8px rgba(0,0,0,0.1); background-color: rgba(var(--color-exercise-rgb), 0.08); }
        #start-pause-btn.finished-btn { border-color: var(--color-finished); color: var(--color-finished); }
        #start-pause-btn.finished-btn:not(:disabled):hover { box-shadow: var(--glow-finished), 0 4px 8px rgba(0,0,0,0.1); background-color: rgba(var(--color-finished-rgb), 0.08); }
        #start-pause-btn.preparing-btn { border-color: var(--color-prepare); color: var(--color-prepare); opacity: 0.7; cursor: default; pointer-events: none; } /* Style pour bouton pendant prépa */

        #skip-btn { border-color: var(--button-next-color); color: var(--button-next-color); }
        #skip-btn:not(:disabled):hover { box-shadow: var(--glow-purple), 0 4px 8px rgba(0,0,0,0.1); background-color: rgba(var(--neon-purple-rgb), 0.08); }
        #prev-btn { border-color: var(--button-prev-color); color: var(--button-prev-color); } /* Style Précédent */
        #prev-btn:not(:disabled):hover { box-shadow: var(--glow-orange), 0 4px 8px rgba(0,0,0,0.1); background-color: rgba(var(--neon-orange-rgb), 0.08); }
        #finish-btn { border-color: var(--button-end-color); color: var(--button-end-color); }
        #finish-btn:not(:disabled):hover { background-color: rgba(var(--secondary-text-color-dark-rgb), 0.1); border-color: var(--primary-text-color); color: var(--primary-text-color); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        #reset-btn { border-color: var(--button-reset-color); color: var(--button-reset-color); }
        #reset-btn:not(:disabled):hover { box-shadow: var(--glow-red), 0 4px 8px rgba(0,0,0,0.1); background-color: rgba(var(--neon-red-rgb), 0.08); }

        /* --- Section Historique --- */
        .history-section h2 { color: var(--primary-text-color); margin-bottom: 25px; text-align: center; }
        .history-controls { padding-bottom: 20px; margin-bottom: 25px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .history-filters { display: flex; gap: 10px; flex-wrap: wrap; }
        .history-filters button { background-color: transparent; border: 1px solid var(--accent-border-color); color: var(--secondary-text-color); opacity: 1; font-size: 0.85em; padding: 6px 12px; border-radius: var(--border-radius-md); cursor: pointer; transition: all var(--transition-speed) ease; display: inline-flex; align-items: center; gap: 5px; }
        .history-filters button:not(:disabled):hover { border-color: var(--primary-text-color); color: var(--primary-text-color); background-color: rgba(var(--secondary-text-color-dark-rgb), 0.1); }
        .history-filters button.active { border-color: var(--neon-blue); color: var(--neon-blue); background-color: rgba(var(--neon-blue-rgb), 0.1); font-weight: 500; box-shadow: var(--glow-blue); }
        .history-actions { display: flex; gap: 15px; align-items: center; color: var(--secondary-text-color); }
        .history-actions i.fab.fa-google-drive { color: var(--neon-green); font-size: 1.1em; }
        #history-drive-status { font-size: 0.8em; padding: 3px 6px; background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.5); border-radius: var(--border-radius-sm); border: 1px solid var(--border-color); transition: color 0.3s ease, border-color 0.3s ease; }
        #history-drive-status.syncing { color: var(--neon-yellow); border-color: var(--neon-yellow); animation: blink-border 1.5s infinite ease-in-out; }
        #history-drive-status.error { color: var(--neon-red); border-color: var(--neon-red); }
        #history-drive-status.success { color: var(--neon-green); border-color: var(--neon-green); }

        .chart-container { height: 350px; margin-bottom: 30px; background-color: transparent; border: 1px solid var(--border-color); border-radius: var(--border-radius-md); padding: 15px; box-shadow: none; position: relative; transition: border-color var(--transition-speed) ease; }
        .chart-placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--secondary-text-color); font-style: italic; text-align: center; padding: 0 10px; transition: opacity 0.3s ease; }
        #history-chart-canvas { display: block; width: 100% !important; height: 100% !important; transition: opacity 0.3s ease; }

        .stats-display { margin-bottom: 30px; padding: 20px; background-color: transparent; border: 1px solid var(--border-color); border-radius: var(--border-radius-md); box-shadow: none; transition: border-color var(--transition-speed) ease; }
        .stats-display h3 { color: var(--primary-text-color); margin-bottom: 15px; font-size: 1.15em;}
        .stats-display .content-wrapper p { margin-bottom: 8px; display: flex; align-items: center; gap: 8px;} /* Cibler le contenu généré */
        .stats-display .content-wrapper p i { width: 16px; text-align: center; color: var(--neon-blue); opacity: 0.8;}
        .stats-display .content-wrapper p strong { color: var(--primary-text-color); font-weight: 500; }
        .stats-display .content-wrapper p:last-child { margin-bottom: 0; }
        .stats-display .motivational-message {
            font-style: italic; font-weight: 500; margin-top: 15px !important;
            background: linear-gradient(90deg, var(--neon-green), var(--neon-blue));
            -webkit-background-clip: text; background-clip: text;
            -webkit-text-fill-color: transparent; /* Correction pour compatibilité */
            color: transparent; /* Fallback */
        }

        .history-list { list-style: none; border: 1px solid var(--border-color); border-radius: var(--border-radius-md); background-color: transparent; box-shadow: none; max-height: 400px; overflow-y: auto; transition: border-color var(--transition-speed) ease; }
        .history-list li { display: grid; /* Utiliser grid pour meilleur alignement */ grid-template-columns: auto 1fr auto auto; align-items: center; padding: 12px 15px; border-bottom: 1px solid var(--border-color); transition: background-color 0.2s ease, border-color var(--transition-speed) ease; gap: 10px 15px; }
        .history-list li:last-child { border-bottom: none; }
        .history-list li:nth-child(even) { background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.3); }
        .history-list li:hover { background-color: rgba(var(--neon-blue-rgb), 0.08); }
        .history-item-date { color: var(--primary-text-color); font-size: 0.9em; grid-column: 1 / 2; }
        .history-item-date small { color: var(--secondary-text-color); font-size: 0.9em;}
        .history-item-type { color: var(--neon-pink); background-color: rgba(var(--neon-pink-rgb), 0.1); border-radius: var(--border-radius-sm); padding: 3px 8px; font-size: 0.85em; font-weight: 500; text-align: center; grid-column: 2 / 3; justify-self: start; /* Aligner à gauche dans la colonne */ }
        .history-item-reps { color: var(--neon-purple); font-weight: 500; font-size: 0.9em; grid-column: 3 / 4; justify-self: end; /* Aligner à droite */ }
        .history-item-reps i { margin-right: 4px; }
        .history-item-duration { color: var(--neon-blue); font-weight: 500; font-variant-numeric: tabular-nums; grid-column: 4 / 5; justify-self: end; /* Aligner à droite */ }
        .history-list .no-history { grid-column: 1 / -1; color: var(--secondary-text-color); text-align: center; padding: 30px 15px; font-style: italic; border: none; background: none !important; }

        /* --- Section Progression --- */
        .progress-section h2 { color: var(--primary-text-color); margin-bottom: 25px; text-align: center; }
        .progress-controls { padding-bottom: 20px; margin-bottom: 25px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }

        .progress-filters { display: flex; gap: 10px; flex-wrap: wrap; }
        .progress-filters .filter-group { display: flex; flex-direction: column; gap: 8px; min-width: 180px; }
        .progress-filters .filter-group label { font-size: 0.85em; color: var(--secondary-text-color); margin-bottom: -2px; }
        .progress-filters select {
            background-color: var(--secondary-bg-color); border: 1px solid var(--border-color); color: var(--primary-text-color);
            border-radius: var(--border-radius-sm); padding: 6px 10px; font-size: 0.9em; cursor: pointer;
            transition: all var(--transition-speed) ease; max-width: 100%; appearance: none; -webkit-appearance: none;
            /* Dynamically set chevron color in JS if needed, or use a fixed color */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%238b949e'%3E%3Cpath fill-rule='evenodd' d='M4.22 6.22a.75.75 0 011.06 0L8 8.94l2.72-2.72a.75.75 0 111.06 1.06l-3.25 3.25a.75.75 0 01-1.06 0L4.22 7.28a.75.75 0 010-1.06z' clip-rule='evenodd'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 8px center; background-size: 16px 16px; padding-right: 30px;
        }
        .progress-filters select:hover { border-color: var(--neon-blue); }
        .progress-filters select:focus { outline: none; border-color: var(--neon-blue); box-shadow: var(--glow-blue); }
        .progress-filters option { background-color: var(--bg-color); color: var(--primary-text-color); }
        /* Cacher le filtre métrique car une seule option */
        .filter-group:has(#metric-select) { display: none; }

        .muscle-map-container {
            margin-bottom: 30px; padding: 20px; background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.3);
            border: 1px solid var(--border-color); border-radius: var(--border-radius-md);
            display: flex; flex-direction: column; align-items: center; gap: 15px; transition: border-color var(--transition-speed) ease;
        }
        .muscle-map-container h3 { color: var(--primary-text-color); font-size: 1.15em; margin-bottom: 5px; }
        .muscle-map {
            position: relative; width: 100%; max-width: 600px; height: 400px;
            background-color: rgba(var(--bg-color-dark-rgb), 0.2); border-radius: var(--border-radius-sm);
            display: flex; justify-content: center; align-items: center;
        }
        .muscle-map-placeholder { color: var(--secondary-text-color); font-style: italic; text-align: center; font-size: 0.9em; }

        .exercise-progress-container { margin-bottom: 30px; }
        .exercise-progress-container h3 { color: var(--primary-text-color); font-size: 1.15em; margin-bottom: 15px; }
        .exercise-chart-container {
            height: 350px; background-color: transparent; border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md); padding: 15px; position: relative; transition: border-color var(--transition-speed) ease;
        }
        #exercise-progress-chart { display: block; width: 100% !important; height: 100% !important; transition: opacity 0.3s ease; } /* Canvas, pas la classe */

        /* --- Résumé Post-Workout (MODAL) --- */
        .post-workout-summary {
            position: fixed; inset: 0; background-color: rgba(var(--bg-color-dark-rgb), 0.85); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; opacity: 0; visibility: hidden; pointer-events: none;
            transition: opacity 0.3s ease, visibility 0s linear 0.3s;
        }
        .post-workout-summary.visible { opacity: 1; visibility: visible; pointer-events: auto; transition: opacity 0.3s ease, visibility 0s linear 0s; }
        .post-workout-summary-content {
            background-color: var(--secondary-bg-color); border: 1px solid var(--border-color); border-radius: var(--border-radius-lg); box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 100%; max-width: 550px; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden;
            transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), background-color var(--transition-speed) ease, border-color var(--transition-speed) ease;
        }
        .post-workout-summary.visible .post-workout-summary-content { transform: scale(1); }
        .post-workout-summary h2 { color: var(--primary-text-color); font-size: 1.5em; font-weight: 700; padding: 20px 25px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; text-align: center; background-color: rgba(var(--bg-color-dark-rgb), 0.2); transition: color var(--transition-speed) ease, border-color var(--transition-speed) ease, background-color var(--transition-speed) ease; }
        .summary-items-list { list-style: none; padding: 15px 25px; overflow-y: auto; flex-grow: 1; background: var(--bg-color); border-bottom: 1px solid var(--border-color); transition: background-color var(--transition-speed) ease, border-color var(--transition-speed) ease; }
        .summary-item {
            display: grid;
            grid-template-columns: 1fr auto; /* Nom | Input reps + boutons */
            gap: 10px 15px;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .summary-item:last-child { border-bottom: none; }
        .summary-item .exercise-name {
            color: var(--primary-text-color);
            font-weight: 500;
            font-size: 1em;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
         .summary-item .exercise-name i {
             color: var(--color-exercise);
             margin-right: 8px;
             opacity: 0.9;
         }
         .summary-item .exercise-name small {
             font-size: 0.8em;
             color: var(--secondary-text-color);
             margin-left: 8px;
         }
        .summary-item .input-container {
            display: flex;
            align-items: center;
            gap: 5px; /* Espace réduit pour les boutons */
            justify-self: end; /* Aligner à droite */
        }
         .summary-item label { /* Label pour accessibilité */
             position: absolute;
             width: 1px; height: 1px;
             padding: 0; margin: -1px;
             overflow: hidden; clip: rect(0, 0, 0, 0);
             white-space: nowrap; border: 0;
         }
         .summary-item input[type="number"] {
            background-color: var(--input-bg); border: 1px solid var(--border-color); color: var(--primary-text-color);
            border-radius: var(--border-radius-sm); padding: 6px 10px; font-size: 0.95em;
            width: 55px; /* Largeur réduite pour input reps */
            text-align: center;
            transition: border-color var(--transition-speed) ease, background-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease, color var(--transition-speed) ease;
            -moz-appearance: textfield;
        }
        .summary-item input[type="number"]::-webkit-outer-spin-button,
        .summary-item input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .summary-item input:focus { border-color: var(--neon-blue); background-color: var(--bg-color); outline: none; box-shadow: 0 0 0 3px rgba(var(--neon-blue-rgb), 0.3); }

        /* Nouveaux boutons +/- dans le résumé */
        .summary-rep-btn {
            width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 1.1em; font-weight: bold; background-color: transparent;
            border: 1px solid var(--border-color); color: var(--primary-text-color); cursor: pointer;
            transition: all var(--transition-speed) ease; padding: 0;
        }
        .summary-rep-btn.minus { border-color: var(--neon-red); color: var(--neon-red); }
        .summary-rep-btn.minus:hover { background-color: rgba(var(--neon-red-rgb), 0.1); }
        .summary-rep-btn.plus { border-color: var(--neon-green); color: var(--neon-green); }
        .summary-rep-btn.plus:hover { background-color: rgba(var(--neon-green-rgb), 0.1); }
        .summary-rep-btn:active { transform: scale(0.95); }


        .summary-controls {
            padding: 20px 25px; display: flex; justify-content: center; /* Centrer le bouton Fin */ gap: 15px;
            flex-shrink: 0; flex-wrap: wrap; border-top: 1px solid var(--border-color); background-color: rgba(var(--bg-color-dark-rgb), 0.2); transition: border-color var(--transition-speed) ease, background-color var(--transition-speed) ease;
        }
        .summary-controls button {
            border: none; color: white; min-width: 160px; padding: 10px 22px; border-radius: var(--border-radius-md);
            font-size: 1em; font-weight: 500; cursor: pointer; transition: all var(--transition-speed) ease;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .summary-controls button:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; background-color: var(--secondary-text-color) !important; }
        .summary-controls button:not(:disabled):hover { filter: brightness(1.1); box-shadow: 0 4px 10px rgba(0,0,0,0.25); transform: translateY(-1px); }
        .summary-controls button:not(:disabled):active { filter: brightness(0.95); transform: translateY(0); box-shadow: 0 1px 3px rgba(0,0,0,0.2); }

        #finish-summary-btn { background-color: var(--neon-green); } /* Nouveau bouton unique */

        /* --- Animation Fin Workout --- */
        .timer-display.finished-animation .timer-circle { animation: finish-circle-glow 1.5s ease-out forwards; }
        @keyframes finish-circle-glow {
            0% { box-shadow: var(--current-step-glow), inset 0 0 15px rgba(var(--bg-color-dark-rgb), 0.6); border-color: var(--border-color); }
            50% { box-shadow: 0 0 35px 15px rgba(var(--color-finished-rgb), 0.7), inset 0 0 15px rgba(var(--bg-color-dark-rgb), 0.4); border-color: var(--color-finished); }
            100% { box-shadow: var(--glow-finished), inset 0 0 15px rgba(var(--bg-color-dark-rgb), 0.6); border-color: var(--color-finished); }
        }

        /* --- Zone de Messages Flottante --- */
        .message-area {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
            background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.9); color: var(--primary-text-color);
            border: 1px solid var(--border-color); padding: 12px 25px; border-radius: var(--border-radius-md);
            z-index: 3000; opacity: 0; transition: opacity 0.5s ease, transform 0.5s ease, bottom 0.5s ease, background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
            pointer-events: none; font-size: 0.95em; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); max-width: 90%; text-align: center;
        }
        .message-area.visible { opacity: 1; transform: translate(-50%, 0); bottom: 40px; pointer-events: auto; }

        /* --- Pied de Page --- */
        footer {
            color: var(--secondary-text-color); opacity: 0.7; border-top: 1px solid var(--border-color);
            margin-top: 60px; padding: 25px; text-align: center; transition: border-color var(--transition-speed) ease, color var(--transition-speed) ease;
        }
        footer a { color: var(--link-color); text-decoration: none; transition: color var(--transition-speed) ease; }
        footer a:hover { color: var(--primary-text-color); text-decoration: underline; }
        footer .fab.fa-google-drive { color: #4CAF50; }

        /* --- Styles Responsives --- */
        @media (max-width: 768px) {
             .history-list li { font-size: 0.9em; grid-template-columns: auto 1fr auto; gap: 5px 10px; } /* Ajuster grid pour petit écran */
             .history-item-reps { grid-column: 3 / 4; justify-self: start; } /* Aligner reps à gauche */
             .history-item-duration { grid-column: 1 / -1; grid-row: 2 / 3; justify-self: end; } /* Durée sur 2ème ligne à droite */
             .controls button { max-width: none; } /* Permettre boutons de prendre plus de place */
             .summary-item { grid-template-columns: 1fr auto; } /* Simplifier grille résumé */
             .overall-progress-info { font-size: 0.85em; } /* Taille texte progresse réduite */
        }
        @media (max-width: 480px) {
            .controls { flex-direction: row; flex-wrap: wrap; } /* Revenir à row pour très petits */
            .controls button { flex-basis: calc(50% - 5px); /* 2 boutons par ligne */ max-width: none;}
             .history-list li { grid-template-columns: auto 1fr; }
             .history-item-type { grid-column: 2 / 3; }
             .history-item-reps { grid-column: 1 / 2; grid-row: 2 / 3; justify-self: start; }
             .history-item-duration { grid-column: 2 / 3; grid-row: 2 / 3; justify-self: end; }
             .summary-controls button { width: 100%; }
             .summary-item { grid-template-columns: 1fr auto; }
             .summary-item .exercise-name { font-size: 0.9em;} /* Réduire nom exo */
             .summary-item .input-container { gap: 3px; }
             .summary-item input[type="number"] { width: 45px; font-size: 0.9em; padding: 5px 8px;}
             .summary-rep-btn { width: 25px; height: 25px; font-size: 1em; }
             .overall-progress-info { flex-direction: column; gap: 5px; } /* Mettre sur deux lignes si trop petit */
             .overall-progress-info span { margin: 0; }
        }
    </style>
</head>
<body class="logged-out dark-theme state-idle"> <!-- Classe d'état initiale -->

<header>
    <div class="header-content">
        <h1><i class="fas fa-shield-halved"></i> ArmorWorkout</h1>
        <nav>
            <ul>
                <li><button id="nav-push" data-workout="Push" disabled>Push</button></li>
                <li><button id="nav-pull" data-workout="Pull" disabled>Pull</button></li>
                <li><button id="nav-legs" data-workout="Legs" disabled>Legs</button></li>
                <li><button id="nav-history"><i class="fas fa-history"></i> Historique</button></li>
                <li><button id="nav-progress" disabled><i class="fas fa-chart-line"></i> Progression</button></li>
            </ul>
        </nav>
        <div class="header-actions">
            <div class="auth-controls">
                <!-- Bouton désactivé par défaut, activé par JS après chargement GIS -->
                <button id="signin-button" disabled><i class="fab fa-google"></i> Connecter Drive</button>
                <button id="signout-button" disabled><i class="fas fa-sign-out-alt"></i> Déconnecter</button>
                <button id="export-button" disabled><i class="fas fa-file-export"></i> Exporter</button>
            </div>
            <span id="drive-status"></span>
            <div class="theme-toggle">
                <button id="theme-toggle-btn" aria-label="Basculer le thème"><i class="fas fa-sun"></i></button>
            </div>
        </div>
    </div>
</header>

<div class="container">
    <main>
        <!-- Section Entraînement -->
        <div class="workout-section app-section" id="workout-section"> <!-- Ajout app-section -->

            <!-- Zone d'info de progression globale -->
            <div id="overall-progress-info" class="overall-progress-info">
                <!-- Contenu généré par JS -->
            </div>

            <div class="timer-display" id="timer-display-clickable" aria-label="Affichage du timer - Cliquer pour ajuster les répétitions (sauf si en pause)">
                <div class="timer-circle-container">
                    <div id="total-progress-circle" aria-hidden="true"></div>
                    <div class="timer-circle" id="timer-circle" aria-hidden="true">
                        <span class="time-left" id="time-left">00:00</span>
                    </div>
                </div>
                <div class="timer-state" id="timer-state" aria-live="polite"></div>
                <!-- Overlay Ajustement Répétitions -->
                <div class="rep-adjustment-overlay" id="rep-adjustment-overlay">
                    <div class="title">Ajuster Répétitions</div>
                    <div class="rep-adjustment-next-exercise" id="rep-adjustment-exercise-name">Exercice</div>
                    <div class="rep-adjustment-controls">
                        <button class="rep-adjustment-btn minus" id="rep-adjust-minus" aria-label="Diminuer répétitions">-</button>
                        <span class="current-reps" id="current-reps-display" aria-live="polite">12</span>
                        <button class="rep-adjustment-btn plus" id="rep-adjust-plus" aria-label="Augmenter répétitions">+</button>
                    </div>
                </div>
            </div>

            <div class="workout-info" id="workout-info">
                <div id="current-exercise-name-display">ArmorWorkout</div> <!-- Titre initial -->
                <div id="current-exercise-container" aria-live="polite">
                    <div class="idle-message"><i class="fas fa-info-circle"></i> Connectez-vous à Google Drive pour commencer.</div>
                </div>
            </div>
            <div class="controls">
                 <button id="prev-btn" disabled><i class="fas fa-backward-step"></i> Précédent</button> <!-- Bouton Précédent -->
                <button id="start-pause-btn" disabled><i class="fas fa-play"></i> Démarrer</button>
                <button id="skip-btn" disabled><i class="fas fa-forward-step"></i> Suivant</button>
                <button id="finish-btn" disabled><i class="fas fa-flag-checkered"></i> Finir</button>
                <button id="reset-btn" disabled><i class="fas fa-redo"></i> Reset</button>
            </div>
            <div class="progress-tracker" id="progress-tracker">
                <span id="progress-text-area">Sélectionnez un entraînement</span>
                <span id="drive-connection-status-main" style="display: none;">
                    <i class="fab fa-google-drive"></i>
                    <span id="drive-connection-text">Connecté</span>
                </span>
            </div>
        </div>

        <!-- Section Historique -->
        <div class="history-section app-section section-hidden" id="history-section"> <!-- Ajout app-section -->
            <h2><i class="fas fa-history"></i> Historique & Statistiques</h2>
            <div class="history-controls">
                <div class="history-filters" role="group" aria-label="Filtres période historique">
                    <button data-period="week" class="active"><i class="fas fa-calendar-week"></i> Semaine</button>
                    <button data-period="month"><i class="fas fa-calendar-alt"></i> Mois</button>
                    <button data-period="year"><i class="fas fa-calendar-check"></i> Année</button>
                    <button data-period="all"><i class="fas fa-infinity"></i> Tout</button>
                </div>
                <div class="history-actions" style="display: none;">
                    <i class="fab fa-google-drive" aria-hidden="true"></i>
                    <span id="history-drive-status">Synchro Drive</span>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="history-chart-canvas" role="img" aria-label="Graphique de la durée d'entraînement"></canvas>
                <p id="history-chart-placeholder" class="chart-placeholder" style="display: none;"></p> <!-- ID HTML Correct -->
            </div>
            <div class="stats-display" id="stats-display">
                <h3>Statistiques</h3>
                <div class="content-wrapper" aria-live="polite">
                     <p>Connectez-vous pour voir les statistiques.</p>
                </div>
                <p class="motivational-message"></p>
            </div>
            <ul class="history-list" id="history-list">
                <li class="no-history">Connectez-vous pour voir l'historique.</li>
            </ul>
        </div>

        <!-- Section Progression -->
        <div class="progress-section app-section section-hidden" id="progress-section"> <!-- Ajout app-section -->
            <h2><i class="fas fa-chart-line"></i> Analyse de Progression</h2>
            <div class="progress-controls">
                <div class="progress-filters">
                    <div class="filter-group">
                        <label for="exercise-select">Exercice</label>
                        <select id="exercise-select" aria-label="Sélectionner un exercice">
                            <option value="all">Tous les exercices (Total Reps)</option> <!-- Texte clarifié -->
                            <!-- Rempli dynamiquement -->
                        </select>
                    </div>
                    <!-- Filtre métrique retiré -->
                    <div class="filter-group" style="display:none;">
                        <label for="metric-select">Métrique</label>
                        <select id="metric-select" aria-label="Sélectionner une métrique">
                            <option value="reps">Répétitions</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="period-select">Période</label>
                        <select id="period-select" aria-label="Sélectionner une période">
                            <option value="3months">3 derniers mois</option>
                            <option value="6months">6 derniers mois</option>
                            <option value="all">Tout l'historique</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="exercise-progress-container">
                <h3>Progression (Répétitions)</h3>
                <div class="exercise-chart-container">
                    <canvas id="exercise-progress-chart" role="img" aria-label="Graphique de progression des répétitions"></canvas>
                    <p id="exercise-progress-placeholder" class="chart-placeholder">Sélectionnez un exercice pour voir sa progression.</p> <!-- ID HTML Correct -->
                </div>
            </div>

            <div class="muscle-map-container">
                <h3>Carte des Groupes Musculaires</h3>
                <div class="muscle-map">
                    <p class="muscle-map-placeholder">La visualisation des groupes musculaires sera disponible prochainement.</p>
                </div>
            </div>
        </div>
    </main>
</div>

<footer>
    <p>© 2024 ArmorWorkout. Sauvegarde automatique sur <i class="fab fa-google-drive" aria-hidden="true"></i> Google Drive.</p>
    <p><a href="https://github.com/ironworkout/armorworkout" target="_blank" rel="noopener noreferrer"><i class="fab fa-github" aria-hidden="true"></i> Voir sur GitHub</a></p>
</footer>

<!-- Zone de Message Flottante -->
<div id="message-area" class="message-area" role="status" aria-live="polite"></div>

<!-- Modal Résumé Post-Workout -->
<div id="post-workout-summary" class="post-workout-summary" role="dialog" aria-modal="true" aria-labelledby="summary-title">
    <div class="post-workout-summary-content">
        <h2 id="summary-title">Résumé & Objectifs Prochaine Séance</h2>
        <ul id="summary-items-list" class="summary-items-list">
             <!-- Contenu généré par JS -->
        </ul>
        <div class="summary-controls">
            <button id="finish-summary-btn"><i class="fas fa-check"></i> Fin & Sauvegarder Objectifs</button>
        </div>
    </div>
</div>

<!-- Google Identity Services Script - SANS onload -->
<script async defer src="https://accounts.google.com/gsi/client"></script>

<script>
    // --- CONFIGURATION & CONSTANTES ---
    const GOOGLE_CLIENT_ID = "731283926358-viam3ulpgna14flfdeb9m92l8s620hoi.apps.googleusercontent.com";
    const GOOGLE_DRIVE_SCOPES = 'https://www.googleapis.com/auth/drive.file';
    const HISTORY_FILENAME = "armorworkout_history.json";
    const PROGRAM_FILENAMES = { Push: "armorworkout_push_program.json", Pull: "armorworkout_pull_program.json", Legs: "armorworkout_legs_program.json" };
    const PROGRAM_TYPES = ['Push', 'Pull', 'Legs'];
    const PREPARE_DURATION = 3;
    const SECONDS_PER_REP = 2.5; // Estimatif pour calcul durée
    const EXERCISE_DEFAULT_DURATION = 30; // Durée par défaut si pas de reps spécifiées
    const IN_PROGRESS_KEY = 'armorWorkoutStateInProgress';
    const GIS_CHECK_INTERVAL = 100; // ms
    const GIS_MAX_RETRIES = 50; // 50 * 100ms = 5 secondes

    // --- DONNÉES PAR DÉFAUT ---
    const defaultWorkouts = { Push: [ {type:"exercise",name:"Band Standing Chest Press",details:"Élastique 15kg à porte",reps:13,weight:15}, {type:"exercise",name:"Band Bench Press",details:"Élastique 25kg",reps:15,weight:25}, {type:"break",duration:75,name:"Repos"}, {type:"exercise",name:"Band Standing Chest Press",details:"Élastique 15kg à porte",reps:13,weight:15}, {type:"exercise",name:"Band Bench Press",details:"Élastique 25kg",reps:15,weight:25}, {type:"break",duration:75,name:"Repos"}, {type:"exercise",name:"Band Standing Chest Press",details:"Élastique 15kg à porte",reps:14,weight:15}, {type:"exercise",name:"Band Bench Press",details:"Élastique 25kg",reps:15,weight:25}, {type:"break",duration:75,name:"Repos"}, {type:"exercise",name:"Overhead Press",details:"Élastique 15kg",reps:12,weight:15}, {type:"exercise",name:"Triceps Pushdown",details:"Élastique 15kg",reps:15,weight:15}, {type:"break",duration:60,name:"Repos"}, {type:"exercise",name:"Overhead Press",details:"Élastique 15kg",reps:12,weight:15}, {type:"exercise",name:"Triceps Pushdown",details:"Élastique 15kg",reps:15,weight:15} ], Pull: [ {type:"exercise",name:"Band Bent-over Row",details:"Élastique 25 kg",reps:12,weight:25}, {type:"exercise",name:"Band Face Pull",details:"Élastique 15 kg",reps:14,weight:15}, {type:"break",duration:75,name:"Repos"}, {type:"exercise",name:"Band Bent-over Row",details:"Élastique 25 kg",reps:12,weight:25}, {type:"exercise",name:"Band Face Pull",details:"Élastique 15 kg",reps:14,weight:15}, {type:"break",duration:75,name:"Repos"}, {type:"exercise",name:"Band Bent-over Row",details:"Élastique 25 kg",reps:13,weight:25}, {type:"exercise",name:"Band Face Pull",details:"Élastique 15 kg",reps:15,weight:15}, {type:"break",duration:75,name:"Repos"}, {type:"exercise",name:"Bicep Curls",details:"Élastique 15 kg",reps:12,weight:15}, {type:"exercise",name:"Lat Pulldown (Band)",details:"Élastique 25 kg",reps:12,weight:25}, {type:"break",duration:60,name:"Repos"}, {type:"exercise",name:"Bicep Curls",details:"Élastique 15 kg",reps:12,weight:15}, {type:"exercise",name:"Lat Pulldown (Band)",details:"Élastique 25 kg",reps:12,weight:25} ], Legs: [ {type:"exercise",name:"Front squat",details:"Élastique 15+25 kg + Haltère 5kg",reps:13,weight:45}, {type:"exercise",name:"Fentes Arrière",details:"Élastique 25 kg",reps:10,weight:25}, {type:"break",duration:90,name:"Repos"}, {type:"exercise",name:"Front squat",details:"Élastique 15+25 kg + Haltère 5kg",reps:13,weight:45}, {type:"exercise",name:"Fentes Arrière",details:"Élastique 25 kg",reps:10,weight:25}, {type:"break",duration:90,name:"Repos"}, {type:"exercise",name:"Front squat",details:"Élastique 15+25 kg + Haltère 5kg",reps:14,weight:45}, {type:"exercise",name:"Fentes Arrière",details:"Élastique 25 kg",reps:11,weight:25}, {type:"break",duration:90,name:"Repos"}, {type:"exercise",name:"Romanian Deadlift (Band)",details:"Élastique 25kg",reps:15,weight:25}, {type:"exercise",name:"Calf Raises",details:"Bodyweight or Band",reps:20,weight:10}, {type:"break",duration:60,name:"Repos"}, {type:"exercise",name:"Romanian Deadlift (Band)",details:"Élastique 25kg",reps:15,weight:25}, {type:"exercise",name:"Calf Raises",details:"Bodyweight or Band",reps:20,weight:10} ] };

    // --- Éléments DOM ---
    let timeLeftDisplay, timerCircle, timerStateDisplay, currentExerciseContainer,
        progressTracker, startPauseBtn, skipBtn, finishBtn, resetBtn, navButtons = [],
        navHistoryBtn, navProgressBtn, themeToggleBtn, messageArea, workoutSection, historySection, progressSection,
        historyList, statsDisplay, statsContentWrapper, historyFilterBtns = [],
        signInButton, signOutButton, exportButton, driveStatusElement,
        postWorkoutSummary, summaryTitle, summaryItemsList, finishSummaryBtn,
        historyDriveStatus, totalProgressCircle,
        currentExerciseNameDisplay, driveConnectionStatusMain, driveConnectionText,
        timerDisplayElement, chartPlaceholder, progressTextArea, historyActionsContainer,
        exerciseSelect, metricSelect, periodSelect,
        exerciseChartPlaceholder,
        repAdjustmentOverlay, repAdjustMinusBtn, repAdjustPlusBtn, currentRepsDisplay, repAdjustmentExerciseName,
        historyChartCanvasEl, exerciseProgressChartCanvasEl,
        prevBtn, overallProgressInfoElement;

    // --- Variables d'État ---
    let currentWorkoutType = null, currentWorkoutPlan = [], originalCompletedWorkoutPlan = [];
    let currentItemIndex = 0, timerInterval = null, prepareCountdownInterval = null;
    let totalTime = 0, timeLeft = 0, prepareTimeLeft = 0, exerciseTimeElapsed = 0;
    let totalWorkoutEstimatedSeconds = 0, elapsedWorkoutEstimatedSeconds = 0;
    let isTimerRunning = false, isWorkoutActive = false, workoutFinished = false, wasFinishedState = false;
    let currentState = 'idle';
    let workoutStartTime = null, workoutHistory = [];
    let currentHistoryPeriod = 'week';
    let historyChartInstance = null, exercisePerfChartInstance = null;
    let googleAccessToken = null, tokenClient = null;
    let historyFileId = null, programFileIds = { Push: null, Pull: null, Legs: null };
    let programsLoaded = false, loadedWorkouts = JSON.parse(JSON.stringify(defaultWorkouts));
    let isSavingDriveData = false;
    let currentTheme = 'dark', messageTimeoutId = null;
    let audioContext = null;
    let nextExerciseIndexForAdjustment = -1, currentRepAdjustment = 0, isRepAdjustmentVisible = false;
    let gisCheckRetries = 0;
    let halfwayTimeoutId = null;

    // --- Audio & Vibration ---
    // ... (Fonctions initSounds, playSound, initAudioContext, playTransitionSound, vibrate inchangées) ...
    function initSounds() { /* ... (code inchangé) ... */ }
    function playSound(audioElement) { /* ... (code inchangé) ... */ }
    function initAudioContext() { /* ... (code inchangé) ... */ }
    const playTransitionSound = () => playSound(soundLaser);
    const vibrate = (pattern = [100]) => { /* ... (code inchangé) ... */ };

    // --- Google Identity Services (GIS) & Drive API ---
    // MODIFICATION: On garde la fonction gisInitInternal telle quelle
    async function gisInitInternal() {
        console.log(">>> gisInitInternal appelée - Initialisation du Token Client...");
        console.log("Vérification état Google API:", `google: ${typeof google}`, `google.accounts: ${typeof google?.accounts}`, `google.accounts.oauth2: ${typeof google?.accounts?.oauth2}`, `google.accounts.oauth2.initTokenClient: ${typeof google?.accounts?.oauth2?.initTokenClient}`);

        const clientIdValid = GOOGLE_CLIENT_ID && !GOOGLE_CLIENT_ID.includes("YOUR_CLIENT_ID");
        if (!clientIdValid) {
            console.error("CRITICAL: GOOGLE_CLIENT_ID n'est pas configuré !");
            showMessage("Erreur critique : ID Client Google manquant.", 10000, true);
             if(signInButton) signInButton.disabled = true;
            return;
        }
        if (!google || !google.accounts || !google.accounts.oauth2 || typeof google.accounts.oauth2.initTokenClient !== 'function') {
            console.error("L'API Google Identity Services n'est pas prête ou fonction initTokenClient manquante.");
            showMessage("Erreur chargement API Google.", 6000, true);
            if(signInButton) { signInButton.disabled = true; console.log("Bouton Sign In désactivé car API Google non prête (gisInitInternal)."); }
            return;
        }
        try {
            console.log("Tentative d'initialisation de initTokenClient...");
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: GOOGLE_DRIVE_SCOPES,
                callback: tokenCallback,
                error_callback: handleTokenError,
                prompt: '' // Pas de prompt auto
            });
            console.log("Token Client Google initialisé :", tokenClient ? "Succès" : "Échec (tokenClient est null/undefined)");
            if (signInButton) {
                signInButton.disabled = false; // <<== ENABLING STEP
                console.log(">>>> BOUTON SIGN IN ACTIVÉ DANS gisInitInternal <<<<");
            } else {
                console.warn("Le bouton Sign In (#signin-button) n'a pas été trouvé dans le DOM au moment de l'activation (gisInitInternal).");
            }
        } catch (error) {
            console.error("Erreur lors de l'appel à google.accounts.oauth2.initTokenClient (gisInitInternal):", error);
            showMessage("Erreur initialisation services Google.", 5000, true);
            console.log("Appel updateAuthUI(false) depuis catch gisInitInternal");
            updateAuthUI(false);
            if (driveStatusElement) { driveStatusElement.textContent = 'Erreur Init Auth'; driveStatusElement.classList.remove('loading', 'success'); driveStatusElement.classList.add('error'); driveStatusElement.style.display = 'inline-block'; }
             if(signInButton) { signInButton.disabled = true; console.log("Bouton Sign In désactivé suite à erreur dans gisInitInternal."); }
        }
         console.log(">>> gisInitInternal - Fin d'exécution");
    }

    // MODIFICATION: checkAndInitGis reste la même (avec la boucle de vérification)
    function checkAndInitGis() {
        console.log(`Vérification GIS (Essai ${gisCheckRetries + 1}/${GIS_MAX_RETRIES})...`);
        console.log(`État actuel: google: ${typeof google}, google.accounts: ${typeof google?.accounts}, oauth2: ${typeof google?.accounts?.oauth2}, initTokenClient: ${typeof google?.accounts?.oauth2?.initTokenClient}`);

        // La condition clé est que la fonction initTokenClient soit définie
        if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2 && typeof google.accounts.oauth2.initTokenClient === 'function') {
            console.log("API Google OAuth2 détectée ! Lancement de gisInitInternal.");
            gisInitInternal(); // Lancer l'initialisation du client token
        } else if (gisCheckRetries < GIS_MAX_RETRIES) {
            gisCheckRetries++;
            setTimeout(checkAndInitGis, GIS_CHECK_INTERVAL); // Réessayer
        } else {
            console.error(`Échec de la détection de l'API Google après ${GIS_MAX_RETRIES} essais.`);
            showMessage("Impossible de charger les services Google. Vérifiez votre connexion ou bloqueur de script.", 10000, true);
            if(signInButton) {
                 signInButton.disabled = true;
                 console.log("Bouton Sign In désactivé car détection API Google a échoué.");
            }
             // Mettre à jour l'UI pour indiquer l'échec de chargement
             if (driveStatusElement) {
                 driveStatusElement.textContent = 'Erreur API Google';
                 driveStatusElement.classList.remove('loading', 'success');
                 driveStatusElement.classList.add('error');
                 driveStatusElement.style.display = 'inline-block';
             }
             console.log("Appel updateAuthUI(false) car échec détection API Google");
             updateAuthUI(false); // S'assurer que l'UI reflète l'état déconnecté/erreur
        }
    }

    // ... (Fonctions handleTokenError, tokenCallback, handleAuthClick, handleSignoutClick, updateAuthUI inchangées) ...
     function handleTokenError(error) { /* ... (code inchangé) ... */ }
     async function tokenCallback(tokenResponse) { /* ... (code inchangé) ... */ }
     function handleAuthClick() { /* ... (code inchangé) ... */ }
     function handleSignoutClick(showMessages = true) { /* ... (code inchangé) ... */ }
     function updateAuthUI(isLoggedIn) { /* ... (code inchangé) ... */ }
     async function findOrCreateFile(filename, defaultContent = "", mimeType = 'application/json') { /* ... (code inchangé) ... */ }
     async function readFileContent(fileId) { /* ... (code inchangé) ... */ }
     async function updateFileContent(fileId, content) { /* ... (code inchangé) ... */ }

    // --- Fonctions Cœur du Timer ---
    // ... (Fonctions formatTime, calculateTotalEstimatedTime, updateTotalProgressCircle, updateOverallProgressDisplay, updateTimerDisplay inchangées) ...
     function formatTime(seconds) { /* ... (code inchangé) ... */ }
     function calculateTotalEstimatedTime(plan) { /* ... (code inchangé) ... */ }
     function updateTotalProgressCircle() { /* ... (code inchangé) ... */ }
     function updateOverallProgressDisplay() { /* ... (code inchangé) ... */ }
     function updateTimerDisplay() { /* ... (code inchangé) ... */ }
     function findPreviousPerformance(exerciseName) { /* ... (code inchangé) ... */ }
     function updateWorkoutInfo() { /* ... (code inchangé) ... */ }
     function getIconForState(state){ /* ... (code inchangé) ... */ }
     function getIconForType(type){ /* ... (code inchangé) ... */ }
     function setState(newState) { /* ... (code inchangé) ... */ }
     function startPrepareCountdown() { /* ... (code inchangé) ... */ }
     function startExerciseTimer() { /* ... (code inchangé) ... */ }
     function startBreakTimer() { /* ... (code inchangé) ... */ }
     function handleItemCompletion(naturalEnd = false) { /* ... (code inchangé) ... */ }
     function handlePreviousClick() { /* ... (code inchangé) ... */ }
     function forceFinishWorkout() { /* ... (code inchangé) ... */ }
     function loadWorkout(type) { /* ... (code inchangé) ... */ }
     function resetCurrentWorkout() { /* ... (code inchangé) ... */ }
     function showMessage(msg, duration = 3000, isError = false) { /* ... (code inchangé) ... */ }

    // --- Gestion Thème ---
    // ... (Fonctions applyTheme, toggleTheme, loadSavedTheme inchangées) ...
     function applyTheme(theme) { /* ... (code inchangé) ... */ }
     function toggleTheme() { /* ... (code inchangé) ... */ }
     function loadSavedTheme() { /* ... (code inchangé) ... */ }

    // --- Navigation & Affichage Sections ---
    // ... (Fonctions showSection, setActiveWorkoutNav inchangées) ...
     function showSection(sectionId) { /* ... (code inchangé) ... */ }
     function setActiveWorkoutNav(type) { /* ... (code inchangé) ... */ }

    // --- Gestion Historique & Statistiques ---
    // ... (Fonctions displayHistory, filterHistoryByPeriod, renderHistoryList, calculateAndDisplayStats inchangées) ...
     function displayHistory(period = 'week') { /* ... (code inchangé) ... */ }
     function filterHistoryByPeriod(history, period) { /* ... (code inchangé) ... */ }
     function renderHistoryList(filteredHistory) { /* ... (code inchangé) ... */ }
     function calculateAndDisplayStats(filteredHistory) { /* ... (code inchangé) ... */ }

    // --- Fonctions Graphiques ---
    // ... (Fonctions aggregateChartData, getChartXAxisTitle, renderHistoryChart, updateChartColors, clearCharts, setChartPlaceholder inchangées) ...
     function aggregateChartData(hist, period, metric = 'durationSeconds') { /* ... (code inchangé) ... */ }
     function getChartXAxisTitle(period){ /* ... (code inchangé) ... */ }
     function renderHistoryChart(filteredHistory) { /* ... (code inchangé) ... */ }
     function updateChartColors() { /* ... (code inchangé) ... */ }
     function clearCharts() { /* ... (code inchangé) ... */ }
     function setChartPlaceholder(canvasId, message, show = true) { /* ... (code inchangé) ... */ }

    // --- Gestion Progression ---
    // ... (Fonctions populateExerciseSelect, displayExerciseProgress inchangées) ...
     function populateExerciseSelect() { /* ... (code inchangé) ... */ }
     function displayExerciseProgress() { /* ... (code inchangé) ... */ }

    // --- Résumé Post-Workout (Modal) ---
    // ... (Fonctions populateAndShowSummary, handleSummaryRepButtonClick, finishSummary, closeSummary inchangées) ...
     function populateAndShowSummary() { /* ... (code inchangé) ... */ }
     function handleSummaryRepButtonClick(button) { /* ... (code inchangé) ... */ }
     async function finishSummary() { /* ... (code inchangé) ... */ }
     function closeSummary(updateUI = true) { /* ... (code inchangé) ... */ }

    // --- Sauvegarde & Chargement (Drive & LocalStorage) ---
    // ... (Fonctions saveHistoryToDrive, loadHistoryFromDrive, saveProgramsToDrive, loadProgramsFromDrive, saveInProgressState, loadInProgressState, clearInProgressState, saveWorkoutToHistory, exportHistory inchangées) ...
     async function saveHistoryToDrive() { /* ... (code inchangé) ... */ }
     async function loadHistoryFromDrive() { /* ... (code inchangé) ... */ }
     async function saveProgramsToDrive() { /* ... (Code inchangé) ... */ }
     async function loadProgramsFromDrive() { /* ... (code inchangé) ... */ }
     function saveInProgressState() { /* ... (code inchangé) ... */ }
     function loadInProgressState() { /* ... (code inchangé) ... */ }
     function clearInProgressState() { /* ... (code inchangé) ... */ }
     function saveWorkoutToHistory() { /* ... (code inchangé) ... */ }
     function exportHistory() { /* ... (code inchangé) ... */ }

    // --- Gestion Overlay Ajustement Répétitions ---
    // ... (Fonctions showRepAdjustmentOverlay, hideRepAdjustmentOverlay, handleRepAdjustClick, findNextExerciseForAdjustment inchangées) ...
     function showRepAdjustmentOverlay() { /* ... (code inchangé) ... */ }
     function hideRepAdjustmentOverlay() { /* ... (code inchangé) ... */ }
     function handleRepAdjustClick(event) { /* ... (code inchangé) ... */ }
     function findNextExerciseForAdjustment() { /* ... (code inchangé) ... */ }

    // --- Initialisation Générale ---
    function initializeDOMReferences() {
        console.log("Début initializeDOMReferences");
        // Utiliser try...catch individuellement pour mieux cerner l'élément manquant si besoin
        try { timeLeftDisplay = document.getElementById('time-left'); } catch(e) { console.error("Erreur init time-left:", e); }
        try { timerCircle = document.getElementById('timer-circle'); } catch(e) { console.error("Erreur init timer-circle:", e); }
        try { timerStateDisplay = document.getElementById('timer-state'); } catch(e) { console.error("Erreur init timer-state:", e); }
        try { currentExerciseContainer = document.getElementById('current-exercise-container'); } catch(e) { console.error("Erreur init current-exercise-container:", e); }
        try { progressTracker = document.getElementById('progress-tracker'); } catch(e) { console.error("Erreur init progress-tracker:", e); }
        try { startPauseBtn = document.getElementById('start-pause-btn'); } catch(e) { console.error("Erreur init start-pause-btn:", e); }
        try { skipBtn = document.getElementById('skip-btn'); } catch(e) { console.error("Erreur init skip-btn:", e); }
        try { finishBtn = document.getElementById('finish-btn'); } catch(e) { console.error("Erreur init finish-btn:", e); }
        try { resetBtn = document.getElementById('reset-btn'); } catch(e) { console.error("Erreur init reset-btn:", e); }
        try { prevBtn = document.getElementById('prev-btn'); } catch(e) { console.error("Erreur init prev-btn:", e); }
        try { themeToggleBtn = document.getElementById('theme-toggle-btn'); } catch(e) { console.error("Erreur init theme-toggle-btn:", e); }
        try { messageArea = document.getElementById('message-area'); } catch(e) { console.error("Erreur init message-area:", e); }
        try { workoutSection = document.getElementById('workout-section'); } catch(e) { console.error("Erreur init workout-section:", e); }
        try { historySection = document.getElementById('history-section'); } catch(e) { console.error("Erreur init history-section:", e); }
        try { progressSection = document.getElementById('progress-section'); } catch(e) { console.error("Erreur init progress-section:", e); }
        try { historyList = document.getElementById('history-list'); } catch(e) { console.error("Erreur init history-list:", e); }
        try { statsDisplay = document.getElementById('stats-display'); } catch(e) { console.error("Erreur init stats-display:", e); }
        try { statsContentWrapper = statsDisplay?.querySelector('.content-wrapper'); } catch(e) { console.error("Erreur init stats-content-wrapper:", e); }
        try { historyFilterBtns = Array.from(document.querySelectorAll('.history-filters button')); } catch(e) { console.error("Erreur init history-filter-btns:", e); }
        try { historyChartCanvasEl = document.getElementById('history-chart-canvas'); } catch(e) { console.error("Erreur init history-chart-canvas:", e); }
        try { exerciseProgressChartCanvasEl = document.getElementById('exercise-progress-chart'); } catch(e) { console.error("Erreur init exercise-progress-chart:", e); }
        try { signInButton = document.getElementById('signin-button'); } catch(e) { console.error("Erreur init signin-button:", e); }
        try { signOutButton = document.getElementById('signout-button'); } catch(e) { console.error("Erreur init signout-button:", e); }
        try { exportButton = document.getElementById('export-button'); } catch(e) { console.error("Erreur init export-button:", e); }
        try { driveStatusElement = document.getElementById('drive-status'); } catch(e) { console.error("Erreur init drive-status:", e); }
        try { postWorkoutSummary = document.getElementById('post-workout-summary'); } catch(e) { console.error("Erreur init post-workout-summary:", e); }
        try { summaryTitle = document.getElementById('summary-title'); } catch(e) { console.error("Erreur init summary-title:", e); }
        try { summaryItemsList = document.getElementById('summary-items-list'); } catch(e) { console.error("Erreur init summary-items-list:", e); }
        try { finishSummaryBtn = document.getElementById('finish-summary-btn'); } catch(e) { console.error("Erreur init finish-summary-btn:", e); }
        try { historyDriveStatus = document.getElementById('history-drive-status'); } catch(e) { console.error("Erreur init history-drive-status:", e); }
        try { totalProgressCircle = document.getElementById('total-progress-circle'); } catch(e) { console.error("Erreur init total-progress-circle:", e); }
        try { currentExerciseNameDisplay = document.getElementById('current-exercise-name-display'); } catch(e) { console.error("Erreur init current-exercise-name-display:", e); }
        try { driveConnectionStatusMain = document.getElementById('drive-connection-status-main'); } catch(e) { console.error("Erreur init drive-connection-status-main:", e); }
        try { driveConnectionText = document.getElementById('drive-connection-text'); } catch(e) { console.error("Erreur init drive-connection-text:", e); }
        try { timerDisplayElement = document.querySelector('.timer-display'); } catch(e) { console.error("Erreur init timer-display:", e); }
        try { progressTextArea = document.getElementById('progress-text-area'); } catch(e) { console.error("Erreur init progress-text-area:", e); }
        try { historyActionsContainer = document.querySelector('.history-actions'); } catch(e) { console.error("Erreur init history-actions:", e); }
        try { exerciseSelect = document.getElementById('exercise-select'); } catch(e) { console.error("Erreur init exercise-select:", e); }
        try { metricSelect = document.getElementById('metric-select'); } catch(e) { console.error("Erreur init metric-select:", e); }
        try { periodSelect = document.getElementById('period-select'); } catch(e) { console.error("Erreur init period-select:", e); }
        try { exerciseChartPlaceholder = document.getElementById('exercise-progress-placeholder'); } catch(e) { console.error("Erreur init exercise-progress-placeholder:", e); }
        try { repAdjustmentOverlay = document.getElementById('rep-adjustment-overlay'); } catch(e) { console.error("Erreur init rep-adjustment-overlay:", e); }
        try { repAdjustMinusBtn = document.getElementById('rep-adjust-minus'); } catch(e) { console.error("Erreur init rep-adjust-minus:", e); }
        try { repAdjustPlusBtn = document.getElementById('rep-adjust-plus'); } catch(e) { console.error("Erreur init rep-adjust-plus:", e); }
        try { currentRepsDisplay = document.getElementById('current-reps-display'); } catch(e) { console.error("Erreur init current-reps-display:", e); }
        try { repAdjustmentExerciseName = document.getElementById('rep-adjustment-exercise-name'); } catch(e) { console.error("Erreur init rep-adjustment-exercise-name:", e); }
        try { navHistoryBtn = document.getElementById('nav-history'); } catch(e) { console.error("Erreur init nav-history:", e); }
        try { navProgressBtn = document.getElementById('nav-progress'); } catch(e) { console.error("Erreur init nav-progress:", e); }
        try { navButtons = [ document.getElementById('nav-push'), document.getElementById('nav-pull'), document.getElementById('nav-legs') ]; } catch(e) { console.error("Erreur init navButtons:", e); }
        try { overallProgressInfoElement = document.getElementById('overall-progress-info'); } catch(e) { console.error("Erreur init overall-progress-info:", e); }
        console.log("Fin initializeDOMReferences");
    }

    function addEventListeners() { /* ... (code inchangé) ... */ }

    // --- Point d'entrée ---
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM Chargé. Initialisation ArmorWorkout...");
        try {
            initializeDOMReferences(); // 1. Références DOM
            // Log de vérification *après* initialisation
            console.log("Vérification après initializeDOMReferences:",
                `startPauseBtn: ${!!startPauseBtn}`,
                `skipBtn: ${!!skipBtn}`,
                `finishBtn: ${!!finishBtn}`,
                `resetBtn: ${!!resetBtn}`,
                `timerStateDisplay: ${!!timerStateDisplay}`,
                `workoutSection: ${!!workoutSection}`,
                `timerDisplayElement: ${!!timerDisplayElement}`,
                `prevBtn: ${!!prevBtn}`,
                `overallProgressInfoElement: ${!!overallProgressInfoElement}`
            );

            initSounds();            // 2. Sons
            addEventListeners();     // 3. Listeners
            loadSavedTheme();        // 4. Thème

            // Vérification *avant* setState
            if (!startPauseBtn || !skipBtn || !finishBtn || !resetBtn || !timerStateDisplay || !workoutSection || !timerDisplayElement || !prevBtn || !overallProgressInfoElement) {
                console.error("Éléments DOM CRITIQUES MANQUANTS avant setState('idle') ! Arrêt de l'initialisation.");
                 // Afficher un message d'erreur visible à l'utilisateur
                 const body = document.querySelector('body');
                 if (body) {
                    const errorDiv = document.createElement('div');
                    errorDiv.textContent = "Erreur critique au chargement des éléments de la page. Rechargez ou vérifiez la console.";
                    errorDiv.style.position='fixed'; errorDiv.style.top='50px'; errorDiv.style.left='10px'; errorDiv.style.right='10px';
                    errorDiv.style.padding='15px'; errorDiv.style.backgroundColor='var(--neon-red, red)'; errorDiv.style.color='white';
                    errorDiv.style.zIndex='10000'; errorDiv.style.textAlign='center'; errorDiv.style.borderRadius='8px';
                    body.prepend(errorDiv);
                 }
                 return; // Bloquer l'exécution si un élément essentiel manque
            }

            setState('idle');        // 5. État initial (seulement si DOM OK)
            console.log("Appel initial updateAuthUI(false) depuis DOMContentLoaded");
            updateAuthUI(false);     // 6. UI initiale déconnectée

            // 7. Lancer la vérification GSI *après* le reste de l'initialisation de base
            // On utilise setTimeout pour laisser le thread principal finir et donner une chance à GSI de charger
            setTimeout(() => {
                 console.log("Lancement de checkAndInitGis via setTimeout.");
                 checkAndInitGis();
            }, 150); // Délai court

            // 8. Placeholders pour les graphiques
            setChartPlaceholder('history-chart-canvas', "Connectez-vous pour voir le graphique.");
            setChartPlaceholder('exercise-progress-chart', "Connectez-vous et sélectionnez un exercice.");

            console.log("Initialisation DOMContentLoaded terminée (attente GSI via timeout).");

        } catch (error) {
             console.error("Erreur majeure lors de l'initialisation DOMContentLoaded:", error);
             const body = document.querySelector('body');
             if (body) {
                 const errorDiv = document.createElement('div');
                 errorDiv.textContent = "Erreur critique au chargement. Vérifiez la console (F12).";
                 errorDiv.style.position = 'fixed'; errorDiv.style.top = '0'; errorDiv.style.left = '0'; errorDiv.style.width = '100%';
                 errorDiv.style.padding = '20px'; errorDiv.style.backgroundColor = 'red'; errorDiv.style.color = 'white';
                 errorDiv.style.zIndex = '9999'; errorDiv.style.textAlign = 'center';
                 body.prepend(errorDiv);
             }
        }
    });

</script>

</body>
</html>
