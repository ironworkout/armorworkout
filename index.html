<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArmorWorkout - Intelligence Athl√©tique</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* --- VARIABLES DYNAMIQUES (LIGUES) --- */
            --theme-color: #22D3EE; 
            --theme-rgb: 34, 211, 238;
            --reactor-speed: 10s;

            /* --- BASE --- */
            --bg-dark: #030712; 
            --bg-panel: #0B132B; 
            --text-main: #F0F4F8; 
            --text-muted: #A0AEC0; 
            --border: #1E293B; 
            
            /* --- STATUS --- */
            --neon-green: #39FF14; 
            --neon-red: #FF3131; 
            --neon-yellow: #FFF01F; 
            
            /* --- CONFIG --- */
            --font-main: 'Inter', sans-serif;
            --font-tech: 'Orbitron', sans-serif;
            --radius: 12px;
            
            /* Mapping Compatibilit√© */
            --electric-blue-rgb: 0, 191, 255;
            --break-color-val: #38bdf8;
        }

        /* --- ANIMATIONS --- */
        @keyframes rotate-right { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }
        @keyframes rotate-left { from { transform: translate(-50%, -50%) rotate(360deg); } to { transform: translate(-50%, -50%) rotate(0deg); } }
        @keyframes pulse-theme { 0%, 100% { box-shadow: 0 0 10px rgba(var(--theme-rgb), 0.2); } 50% { box-shadow: 0 0 25px rgba(var(--theme-rgb), 0.6); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes textGlow { 0%, 100% { text-shadow: 0 0 5px rgba(var(--theme-rgb), 0.5); } 50% { text-shadow: 0 0 15px rgba(var(--theme-rgb), 0.9); } }

        /* --- GLOBAL --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--font-main); background-color: var(--bg-dark); color: var(--text-main);
            min-height: 100vh; overflow-x: hidden; display: flex; flex-direction: column;
            background-image: radial-gradient(circle at 50% 0%, rgba(var(--theme-rgb), 0.1) 0%, transparent 70%), linear-gradient(0deg, #020617 0%, #0f172a 100%);
            transition: background-image 1s ease;
        }
        body::before { 
            content: ""; position: fixed; inset: 0; pointer-events: none; z-index: -1;
            background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 40px 40px; 
        }

        /* Mode Workout */
        body.workout-active header, body.workout-active footer { display: none; }
        body.workout-active main { position: fixed; inset: 0; z-index: 100; background: var(--bg-dark); padding: 0; display: flex; justify-content: center; }
        body.workout-active .app-section:not(#workout-section) { display: none; }
        body.workout-active #workout-section { display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; height: 100%; }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; width: 100%; flex-grow: 1; }

        /* --- HEADER --- */
        header {
            padding: 15px 0; background: rgba(11, 19, 43, 0.8); backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(var(--theme-rgb), 0.3); position: sticky; top: 0; z-index: 100;
        }
        .header-content { display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        header h1 { font-family: var(--font-tech); font-size: 1.5em; letter-spacing: 2px; text-shadow: 0 0 10px rgba(var(--theme-rgb), 0.5); display: flex; gap: 10px; align-items: center; }
        header h1 i { color: var(--theme-color); }

        .header-actions { display: flex; gap: 15px; align-items: center; }
        
        #edit-program-btn {
            background: transparent; border: 1px solid var(--text-muted); color: var(--text-muted);
            padding: 8px 12px; border-radius: 6px; cursor: pointer; font-family: var(--font-tech); transition: 0.3s;
        }
        #edit-program-btn.active { border-color: var(--neon-yellow); color: var(--neon-yellow); box-shadow: 0 0 10px rgba(255, 240, 31, 0.2); }

        #signin-button { 
            background: transparent; border: 1px solid var(--theme-color); color: var(--theme-color);
            padding: 8px 18px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; font-family: var(--font-tech);
        }
        #signin-button:hover { background: rgba(var(--theme-rgb), 0.15); box-shadow: 0 0 15px var(--theme-color); }
        
        #drive-status { display: none; align-items: center; gap: 8px; color: var(--neon-green); font-family: var(--font-tech); font-size: 0.9em; }
        body.logged-in #drive-status { display: flex; }
        body.logged-in #signin-button { display: none; }

        /* --- HOME --- */
        .app-section { animation: fadeIn 0.6s ease-out; width: 100%; }
        .section-hidden { display: none !important; opacity: 0; }

        .home-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-top: 20px; }
        @media (max-width: 900px) { .home-grid { grid-template-columns: 1fr; } }

        .session-card {
            background: rgba(30, 41, 59, 0.5); border: 1px solid var(--border);
            padding: 25px; border-radius: var(--radius); cursor: pointer; transition: 0.3s;
            position: relative; overflow: hidden; margin-bottom: 20px;
        }
        .session-card:hover { 
            border-color: var(--theme-color); transform: translateY(-4px); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5), inset 0 0 20px rgba(var(--theme-rgb), 0.1); 
        }
        .session-card.edit-mode { border-color: var(--neon-yellow); border-style: dashed; }
        .session-card h3 { font-family: var(--font-tech); color: var(--theme-color); font-size: 1.4em; margin-bottom: 8px; }
        .session-card .meta { margin-top: 15px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; opacity: 0.8; }

        /* Sidebar */
        .sidebar-module {
            background: rgba(15, 23, 42, 0.7); border: 1px solid var(--border);
            padding: 20px; border-radius: var(--radius); margin-bottom: 20px;
        }
        .sidebar-module h3 { font-family: var(--font-tech); font-size: 1em; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 15px; color: #fff; }

        .league-badge { text-align: center; padding: 10px; }
        .league-icon { font-size: 4em; color: var(--theme-color); margin-bottom: 10px; filter: drop-shadow(0 0 15px rgba(var(--theme-rgb), 0.8)); animation: pulse-theme 3s infinite; }
        .league-name { font-family: var(--font-tech); font-weight: 900; font-size: 1.4em; text-transform: uppercase; color: var(--theme-color); letter-spacing: 1px; }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; margin-top: 15px; }
        .cal-day { padding: 5px 0; border-radius: 4px; color: var(--text-muted); font-size: 0.8em; position: relative; }
        .cal-day.today { border: 1px solid var(--theme-color); color: #fff; font-weight: bold; background: rgba(var(--theme-rgb), 0.1); }
        .cal-day.active::after { content: ''; position: absolute; bottom: 3px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; background: var(--theme-color); border-radius: 50%; box-shadow: 0 0 5px var(--theme-color); }

        /* --- ARC REACTOR --- */
        .timer-display { position: relative; width: 300px; height: 300px; margin: 0 auto 40px; display: flex; align-items: center; justify-content: center; }
        
        .reactor { position: relative; width: 200px; height: 200px; display: flex; align-items: center; justify-content: center; border-radius: 50%; z-index: 10; }
        
        /* Cercles Complexes */
        .circle-1 { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 1px solid rgba(var(--theme-rgb), 0.3); animation: rotate-right var(--reactor-speed) linear infinite; }
        .circle-2 { position: absolute; width: 90%; height: 90%; border-radius: 50%; border: 4px solid var(--theme-color); border-left-color: transparent; border-right-color: transparent; animation: rotate-left 5s linear infinite; box-shadow: 0 0 15px rgba(var(--theme-rgb), 0.3); }
        .circle-3 { position: absolute; width: 80%; height: 80%; border-radius: 50%; border: 2px dashed rgba(var(--theme-rgb), 0.6); animation: rotate-right 12s linear infinite; }
        .circle-4 { position: absolute; width: 60%; height: 60%; border-radius: 50%; background: radial-gradient(circle, rgba(var(--theme-rgb), 0.2) 0%, transparent 70%); }
        
        .triangle { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 160px; height: 160px; 
            background: var(--theme-color); clip-path: polygon(50% 0%, 0% 100%, 100% 100%); 
            opacity: 0.15; animation: rotate-right var(--reactor-speed) linear infinite; z-index: 1;
        }

        #time-left { 
            position: relative; z-index: 20; font-family: var(--font-tech); font-size: 3.8em; font-weight: 700; color: #fff;
            text-shadow: 0 0 15px rgba(var(--theme-rgb), 0.8); 
        }

        .timer-svg { position: absolute; inset: 0; width: 100%; height: 100%; transform: rotate(-90deg); pointer-events: none; }
        .timer-track { fill: none; stroke: rgba(255,255,255,0.05); stroke-width: 4; }
        .timer-fill { fill: none; stroke: var(--theme-color); stroke-width: 4; stroke-linecap: round; transition: stroke-dashoffset 1s linear; filter: drop-shadow(0 0 5px var(--theme-color)); }

        /* --- WORKOUT INFO --- */
        .workout-info { text-align: center; margin-bottom: 30px; width: 100%; }
        #current-ex-name { font-family: var(--font-tech); font-size: 1.6em; color: var(--theme-color); margin-bottom: 10px; animation: textGlow 3s infinite; }
        
        .ex-stats { 
            background: rgba(15, 23, 42, 0.8); border: 1px solid var(--border); border-left: 4px solid var(--theme-color);
            padding: 15px 30px; border-radius: 8px; display: inline-flex; gap: 30px; align-items: center; 
            font-family: var(--font-tech); font-size: 1.3em; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .ex-stats i { color: var(--theme-color); margin-right: 8px; font-size: 0.8em; }

        /* --- CONTROLS --- */
        .controls { display: flex; justify-content: center; gap: 15px; width: 100%; flex-wrap: wrap; }
        .btn-ctrl {
            background: rgba(30, 41, 59, 0.6); border: 1px solid var(--border); color: var(--text-muted);
            padding: 15px 25px; border-radius: 8px; font-family: var(--font-tech); cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; gap: 8px; min-width: 120px; justify-content: center;
        }
        .btn-ctrl:hover:not(:disabled) { border-color: var(--theme-color); color: #fff; background: rgba(var(--theme-rgb), 0.1); transform: translateY(-2px); }
        .btn-ctrl:disabled { opacity: 0.5; cursor: not-allowed; }
        
        #btn-main { 
            background: var(--theme-color); color: #000; border: none; font-weight: 900; 
            box-shadow: 0 0 20px rgba(var(--theme-rgb), 0.4); min-width: 160px;
        }
        #btn-main:hover { box-shadow: 0 0 30px rgba(var(--theme-rgb), 0.7); transform: scale(1.05); }

        /* --- MODALE --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000;
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px);
        }
        .modal-overlay.visible { display: flex; animation: fadeIn 0.3s ease-out; }
        
        .modal-content {
            background: var(--bg-panel); width: 95%; max-width: 600px; max-height: 90vh; overflow-y: auto;
            border: 1px solid var(--theme-color); border-radius: var(--radius); padding: 25px;
            box-shadow: 0 0 40px rgba(var(--theme-rgb), 0.2);
        }
        
        .summary-item {
            background: rgba(255,255,255,0.03); margin-bottom: 12px; padding: 15px; border-radius: 8px;
            border-left: 3px solid var(--theme-color);
        }
        .summary-row { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; gap: 10px; }
        
        .stepper { display: flex; align-items: center; background: #020617; border: 1px solid var(--border); border-radius: 6px; padding: 2px; }
        .stepper button { background: none; border: none; color: var(--theme-color); width: 30px; height: 30px; cursor: pointer; font-size: 1.2em; }
        .stepper span { font-family: var(--font-tech); font-weight: bold; width: 50px; text-align: center; font-size: 0.9em; }
        
        .btn-finish { width: 100%; padding: 15px; margin-top: 20px; background: var(--neon-green); color: #000; border: none; border-radius: 8px; font-weight: 900; font-family: var(--font-tech); cursor: pointer; }

        /* --- TOAST --- */
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: #fff; padding: 12px 24px; border-radius: 50px;
            border: 1px solid var(--theme-color); box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            font-weight: 500; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 9999;
        }
        .toast.visible { opacity: 1; bottom: 40px; }

        footer { padding: 30px; text-align: center; color: var(--text-muted); font-size: 0.8em; border-top: 1px solid var(--border); margin-top: 40px; }
    </style>
</head>
<body class="logged-out state-idle">

    <header>
        <div class="header-content">
            <h1><i class="fas fa-shield-alt"></i> ARMOR<span>WORKOUT</span></h1>
            <div class="header-actions">
                <button id="edit-program-btn">√âDITION</button>
                <button id="signin-button"><i class="fab fa-google"></i> CONNEXION</button>
                <div id="drive-status"><i class="fas fa-satellite-dish"></i> SYNC ACTIVE</div>
            </div>
        </div>
    </header>

    <div class="container">
        <main>
            <!-- ACCUEIL -->
            <div id="home-section" class="app-section">
                <div class="home-grid">
                    <div id="session-cards-container">
                        <!-- JS Inject -->
                    </div>
                    <div class="home-sidebar">
                        <div class="sidebar-module" style="text-align:center;">
                            <div class="league-badge" id="league-display"></div>
                        </div>
                        <div class="sidebar-module">
                            <h3><i class="fas fa-calendar-check"></i> CIBLE HEBDO</h3>
                            <div class="consistency-info">
                                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                                    <span>Objectif</span>
                                    <strong id="weekly-count-display">0 / 2</strong>
                                </div>
                                <div style="height:8px; background:var(--border); border-radius:4px; overflow:hidden;">
                                    <div id="weekly-progress-bar" style="height:100%; width:0%; background:var(--theme-color); transition:1s;"></div>
                                </div>
                                <p id="streak-display" style="margin-top:10px; font-size:0.8em; color:var(--text-muted)"></p>
                                <div class="calendar-grid" id="calendar-grid"></div>
                            </div>
                        </div>
                        <div class="sidebar-module">
                            <h3><i class="fas fa-history"></i> LOGS</h3>
                            <ul id="history-list" style="list-style:none; font-size:0.85em; opacity:0.8; padding:0;"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- WORKOUT -->
            <div id="workout-section" class="app-section section-hidden">
                <div class="timer-display">
                    <svg class="timer-svg" viewBox="0 0 100 100">
                        <circle class="timer-track" cx="50" cy="50" r="45"></circle>
                        <circle id="timer-progress" class="timer-fill" cx="50" cy="50" r="45" stroke-dasharray="283" stroke-dashoffset="0"></circle>
                    </svg>
                    <div class="reactor">
                        <div class="circle-1"></div>
                        <div class="circle-2"></div>
                        <div class="circle-3"></div>
                        <div class="circle-4"></div>
                        <div class="triangle"></div>
                        <div id="time-left">00:00</div>
                    </div>
                </div>

                <div class="workout-info">
                    <h2 id="current-ex-name">-</h2>
                    <div id="current-ex-container"></div>
                    <p id="current-ex-details" style="margin-top:15px; opacity:0.7; font-size:0.9em;">-</p>
                </div>

                <div class="controls">
                    <button class="btn-ctrl" id="prev-btn"><i class="fas fa-backward"></i></button>
                    <button class="btn-ctrl" id="btn-main">D√âMARRER</button>
                    <button class="btn-ctrl" id="skip-btn"><i class="fas fa-forward"></i></button>
                    <button class="btn-ctrl" id="quit-btn" style="color:var(--neon-red)"><i class="fas fa-power-off"></i></button>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL -->
    <div id="summary-modal" class="modal-overlay">
        <div class="modal-content">
            <div style="text-align:center; margin-bottom:20px; border-bottom:1px solid var(--border); padding-bottom:15px;">
                <h2 id="modal-title" style="font-family:var(--font-tech); color:var(--theme-color)">Rapport</h2>
                <p style="font-size:0.9em; color:var(--text-muted)">Ajustez les valeurs pour la surcharge progressive.</p>
            </div>
            <div id="summary-list"></div>
            <button id="save-btn" class="btn-finish">VALIDER</button>
        </div>
    </div>

    <div id="toast" class="toast"><span>Info</span></div>

    <footer>
        <p>&copy; 2026 ARMORWORKOUT | Protocol Arc Reactor v6.0</p>
    </footer>

    <!-- GOOGLE -->
    <script async defer src="https://accounts.google.com/gsi/client"></script>
    
    <script>
        "use strict";

        // =================================================================================
        // 1. CONSTANTES & CONFIGURATION
        // =================================================================================
        const GOOGLE_CLIENT_ID = "731283926358-viam3ulpgna14flfdeb9m92l8s620hoi.apps.googleusercontent.com";
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const PROGRAM_FILE = "programme.json";
        const HISTORY_FILE = "armorworkout_history.json";
        const WEEKLY_GOAL = 2;

        const LEAGUES = [
            { name: "Bois", min: 0, color: "#A0522D", rgb: "160, 82, 45", speed: "12s" },
            { name: "Pierre", min: 2, color: "#78909C", rgb: "120, 144, 156", speed: "10s" },
            { name: "Bronze", min: 4, color: "#CD7F32", rgb: "205, 127, 50", speed: "9s" },
            { name: "Argent", min: 6, color: "#C0C0C0", rgb: "192, 192, 192", speed: "8s" },
            { name: "Or", min: 8, color: "#FFD700", rgb: "255, 215, 0", speed: "7s" },
            { name: "Platine", min: 12, color: "#E5E4E2", rgb: "229, 228, 226", speed: "6s" },
            { name: "√âmeraude", min: 16, color: "#50C878", rgb: "80, 200, 120", speed: "5s" },
            { name: "Rubis", min: 20, color: "#E0115F", rgb: "224, 17, 95", speed: "4s" },
            { name: "Diamant", min: 26, color: "#B9F2FF", rgb: "185, 242, 255", speed: "3s" },
            { name: "Vibranium", min: 32, color: "#FFFFFF", rgb: "255, 255, 255", speed: "1s" }
        ];

        const DEFAULT_PROGRAM = {
            "nom_programme": "ROI V√äTU 2025",
            "sessions": [
                { "nom_session": "S√âANCE A : V-FRAME", "description_session": "Focus √âpaules & Dos", "exercices_et_pauses": [] },
                { "nom_session": "S√âANCE B : THICKNESS", "description_session": "Focus Pecs & Bras", "exercices_et_pauses": [] }
            ]
        };

        // --- VARIABLES GLOBALES (D√âCLARATION EXPLIQUEE POUR EVITER ERREURS) ---
        let googleAccessToken = null;
        let tokenClient = null;
        let loadedProgram = null;
        let workoutHistory = [];
        let programFileId = null;
        let historyFileId = null;

        // Variables de session
        let currentPlan = [];
        let currentIdx = 0;
        let currentSessionName = "";
        let timerInterval = null;
        let timeLeft = 0;
        let totalTime = 0;
        let isTimerRunning = false;
        let isEditMode = false;
        let currentSummaryContext = { mode: '', sessionName: '' }; // D√©claration explicite

        // =================================================================================
        // 2. INITIALISATION
        // =================================================================================
        document.addEventListener('DOMContentLoaded', () => {
            // Attente active de la lib Google
            const checkG = setInterval(() => {
                if (typeof google !== 'undefined' && google.accounts) {
                    clearInterval(checkG);
                    initGis();
                }
            }, 200);

            // Setup UI
            updateTheme(LEAGUES[0]);
            renderHome();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('signin-button').onclick = () => tokenClient.requestAccessToken();
            document.getElementById('btn-main').onclick = toggleTimer;
            document.getElementById('skip-btn').onclick = () => navigate(1);
            document.getElementById('prev-btn').onclick = () => navigate(-1);
            document.getElementById('quit-btn').onclick = quitWorkout;
            document.getElementById('save-btn').onclick = finishWorkout;
            document.getElementById('edit-program-btn').onclick = toggleEditMode;
            
            // D√©l√©gation d'√©v√©nements pour le stepper (Plus robuste)
            document.getElementById('summary-list').addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
                
                const stepper = btn.closest('.stepper');
                const span = stepper.querySelector('span');
                let val = parseFloat(span.textContent);
                const isWeight = stepper.dataset.type === 'weight';
                const step = isWeight ? 0.5 : 1;
                
                if (btn.classList.contains('minus')) val = Math.max(0, val - step);
                else val += step;
                
                span.textContent = Number.isInteger(val) ? val : val.toFixed(1);
            });
        }

        function initGis() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID, scope: SCOPES,
                callback: async (resp) => {
                    if (resp.access_token) {
                        googleAccessToken = resp.access_token;
                        document.body.classList.replace('logged-out', 'logged-in');
                        document.getElementById('drive-status').style.display = 'flex';
                        showToast("Connexion r√©ussie. Synchronisation...");
                        await syncDrive();
                    }
                }
            });
        }

        // =================================================================================
        // 3. DRIVE SYNC (CORRECTION ERREUR 400)
        // =================================================================================
        async function syncDrive() {
            try {
                // Chargement Programme
                programFileId = await findFile(PROGRAM_FILE);
                if (programFileId) {
                    const txt = await downloadFile(programFileId);
                    loadedProgram = JSON.parse(txt);
                } else {
                    loadedProgram = DEFAULT_PROGRAM;
                    programFileId = await createFile(PROGRAM_FILE, JSON.stringify(DEFAULT_PROGRAM));
                    showToast("Programme cr√©√©.");
                }

                // Chargement Historique
                historyFileId = await findFile(HISTORY_FILE);
                if (historyFileId) {
                    const txt = await downloadFile(historyFileId);
                    workoutHistory = JSON.parse(txt);
                } else {
                    workoutHistory = [];
                    historyFileId = await createFile(HISTORY_FILE, "[]");
                }

                calculateLeague();
                renderHome();
                showToast("Donn√©es synchronis√©es.");
            } catch (e) {
                console.error(e);
                showToast("Erreur Drive.");
            }
        }

        async function findFile(name) {
            // FIX CRITIQUE : encodeURIComponent pour les espaces
            const q = `name = '${name}' and trashed = false`;
            const url = `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}&fields=files(id,name)`;
            const res = await fetch(url, { headers: { Authorization: `Bearer ${googleAccessToken}` } });
            const data = await res.json();
            return data.files && data.files.length > 0 ? data.files[0].id : null;
        }

        async function downloadFile(id) {
            const res = await fetch(`https://www.googleapis.com/drive/v3/files/${id}?alt=media`, { headers: { Authorization: `Bearer ${googleAccessToken}` } });
            return await res.text();
        }

        async function createFile(name, content) {
            const meta = { name, mimeType: 'application/json' };
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(meta)], { type: 'application/json' }));
            form.append('file', new Blob([content], { type: 'application/json' }));
            const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST', headers: { Authorization: `Bearer ${googleAccessToken}` }, body: form
            });
            const data = await res.json();
            return data.id;
        }

        async function updateFile(id, content) {
            await fetch(`https://www.googleapis.com/upload/drive/v3/files/${id}?uploadType=media`, {
                method: 'PATCH', headers: { Authorization: `Bearer ${googleAccessToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(content, null, 2)
            });
        }

        // =================================================================================
        // 4. LIGUES & THEMES
        // =================================================================================
        function calculateLeague() {
            if (!workoutHistory.length) return updateTheme(LEAGUES[0]);

            const weeks = {};
            workoutHistory.forEach(h => {
                const d = new Date(h.date);
                const k = `${d.getFullYear()}-${getWeek(d)}`;
                weeks[k] = (weeks[k] || 0) + 1;
            });

            let streak = 0;
            let d = new Date();
            const currK = `${d.getFullYear()}-${getWeek(d)}`;
            
            // UI Hebdo
            const count = weeks[currK] || 0;
            document.getElementById('weekly-count-display').textContent = `${count} / ${WEEKLY_GOAL}`;
            document.getElementById('weekly-progress-bar').style.width = Math.min((count/WEEKLY_GOAL)*100, 100) + "%";

            // Calcul Streak
            while(true) {
                const k = `${d.getFullYear()}-${getWeek(d)}`;
                if (weeks[k] >= WEEKLY_GOAL) {
                    streak++;
                    d.setDate(d.getDate() - 7);
                } else {
                    if (k === currK && streak === 0) { d.setDate(d.getDate() - 7); continue; }
                    break;
                }
            }

            let league = LEAGUES[0];
            for(let l of LEAGUES) { if(streak >= l.min) league = l; }

            document.getElementById('streak-display').textContent = `S√©rie : ${streak} semaine(s)`;
            updateTheme(league);
        }

        function getWeek(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function updateTheme(l) {
            const r = document.documentElement;
            const hex = l.color.replace('#','');
            const rgb = `${parseInt(hex.substring(0,2),16)}, ${parseInt(hex.substring(2,4),16)}, ${parseInt(hex.substring(4,6),16)}`;
            
            r.style.setProperty('--theme-color', l.color);
            r.style.setProperty('--theme-rgb', rgb);
            r.style.setProperty('--reactor-speed', l.speed);

            document.getElementById('league-display').innerHTML = `
                <i class="fas ${l.icon || 'fa-trophy'} league-icon"></i>
                <div class="league-name">${l.name}</div>
            `;
        }

        // =================================================================================
        // 5. WORKOUT ENGINE (CORRECTION VARIABLES)
        // =================================================================================
        function renderHome() {
            const container = document.getElementById('session-cards-container');
            container.innerHTML = '';
            
            if (!loadedProgram) return;

            loadedProgram.sessions.forEach(session => {
                const card = document.createElement('div');
                card.className = `session-card ${isEditMode ? 'edit-mode' : ''}`;
                const count = session.exercices_et_pauses.filter(e => e.type === 'exercise').length;
                card.innerHTML = `
                    <h3>${session.nom_session}</h3>
                    <p>${session.description_session || 'Aucune description'}</p>
                    <div class="meta"><span><i class="fas fa-dumbbell"></i> ${count} Exos</span><span>GO <i class="fas fa-play"></i></span></div>
                `;
                card.onclick = () => {
                    // FIX: Gestion correcte du clic en mode √©dition
                    if (isEditMode) openSummary(session.nom_session, 'edit');
                    else startSession(session);
                };
                container.appendChild(card);
            });

            // Historique
            const list = document.getElementById('recent-history-list');
            list.innerHTML = '';
            workoutHistory.slice(-5).reverse().forEach(h => {
                const li = document.createElement('li');
                li.style.marginBottom = "5px";
                li.innerHTML = `<span style="color:var(--theme-color)">${h.date}</span> ${h.type}`;
                list.appendChild(li);
            });
            
            // Calendrier
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            const now = new Date();
            for(let i=13; i>=0; i--) {
                const d = new Date(); d.setDate(now.getDate() - i);
                const iso = d.toISOString().split('T')[0];
                const dayEl = document.createElement('div');
                dayEl.className = 'cal-day';
                if(i===0) dayEl.classList.add('today');
                if(workoutHistory.some(h => h.date === iso)) dayEl.classList.add('active');
                dayEl.textContent = d.getDate();
                grid.appendChild(dayEl);
            }
        }

        function startSession(session) {
            currentSessionName = session.nom_session;
            currentPlan = JSON.parse(JSON.stringify(session.exercices_et_pauses));
            currentIdx = 0;
            
            document.body.classList.add('workout-active');
            document.getElementById('home-section').classList.add('section-hidden');
            document.getElementById('workout-section').classList.remove('section-hidden');
            
            loadStep();
        }

        function loadStep() {
            const item = currentPlan[currentIdx];
            const isRest = item.type === 'break';
            const btn = document.getElementById('btn-main');
            
            // FIX: R√©initialisation explicite du flag timer
            isTimerRunning = false;

            document.getElementById('current-ex-name').textContent = item.name || (isRest ? "R√âCUP√âRATION" : "Exercice");
            document.getElementById('current-ex-details').textContent = item.details || "";
            
            const cont = document.getElementById('current-ex-container');
            
            if (isRest) {
                totalTime = item.duration || 60;
                btn.innerHTML = `<i class="fas fa-play"></i> CHRONO`;
                cont.innerHTML = `<div class="exercise-details" style="border-color:var(--break-color-val)">Respirez...</div>`;
            } else {
                // Parsing Mat√©riel
                const wTxt = item.weight_text || "";
                let displayW = wTxt;
                if (wTxt.includes('Sac')) displayW = wTxt.replace('Sac', 'üéí');
                else if (wTxt.includes('√âlastique')) displayW = wTxt.replace('√âlastique', 'üßò');
                else if (!wTxt || wTxt.includes('PDC')) displayW = "üí™ PDC";
                
                const reps = item.reps || (item.duration ? item.duration+"s" : "-");

                cont.innerHTML = `
                    <div class="ex-stats">
                        <span><i class="fas fa-repeat"></i> ${reps}</span>
                        <span>${displayW}</span>
                    </div>
                `;
                
                if (item.duration) {
                    totalTime = item.duration;
                    btn.innerHTML = `<i class="fas fa-play"></i> GO`;
                } else {
                    totalTime = 0;
                    btn.innerHTML = `<i class="fas fa-check"></i> VALID√â`;
                }
            }
            timeLeft = totalTime;
            updateTimerDisplay();
        }

        function toggleTimer() {
            if (totalTime === 0) { navigate(1); return; }
            
            const btn = document.getElementById('btn-main');
            if (isTimerRunning) {
                clearInterval(timerInterval);
                isTimerRunning = false;
                btn.innerHTML = `<i class="fas fa-play"></i> REPRENDRE`;
            } else {
                isTimerRunning = true;
                btn.innerHTML = `<i class="fas fa-pause"></i> PAUSE`;
                timerInterval = setInterval(() => {
                    timeLeft--;
                    updateTimerDisplay();
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        isTimerRunning = false;
                        navigate(1);
                    }
                }, 1000);
            }
        }

        function updateTimerDisplay() {
            const el = document.getElementById('time-left');
            const ring = document.getElementById('timer-progress');
            
            if (totalTime > 0) {
                const m = Math.floor(timeLeft/60).toString().padStart(2,'0');
                const s = (timeLeft%60).toString().padStart(2,'0');
                el.textContent = `${m}:${s}`;
                const offset = 283 * (1 - timeLeft/totalTime);
                ring.style.strokeDashoffset = offset;
            } else {
                el.textContent = "PR√äT";
                ring.style.strokeDashoffset = 0;
            }
        }

        function navigate(dir) {
            clearInterval(timerInterval);
            currentIdx += dir;
            if (currentIdx >= currentPlan.length) showSummary();
            else if (currentIdx < 0) { currentIdx = 0; loadStep(); }
            else loadStep();
        }

        function quitWorkout() {
            if(confirm("Quitter ?")) {
                clearInterval(timerInterval);
                document.body.classList.remove('workout-active');
                document.getElementById('workout-section').classList.add('section-hidden');
                document.getElementById('home-section').classList.remove('section-hidden');
            }
        }

        // =================================================================================
        // 6. MODALE DE FIN / √âDITION (FIXED)
        // =================================================================================
        function showSummary() {
            openSummary(currentSessionName, 'workout');
        }

        function openSummary(sessionName, mode) {
            // FIX: Initialisation correcte du contexte
            currentSummaryContext = { mode: mode, sessionName: sessionName };
            
            const session = loadedProgram.sessions.find(s => s.nom_session === sessionName);
            const plan = (mode === 'workout') ? currentPlan : JSON.parse(JSON.stringify(session.exercices_et_pauses));
            
            const list = document.getElementById('summary-list');
            list.innerHTML = '';
            
            document.getElementById('modal-title').textContent = (mode === 'workout') ? "Rapport de Mission" : "√âdition du Programme";

            plan.forEach((item, i) => {
                if (item.type === 'exercise') {
                    // Extraction Poids/Type
                    let wVal = 0;
                    let emoji = "üèãÔ∏è";
                    const wTxt = item.weight_text || "";
                    
                    if (wTxt.includes('Sac')) emoji = "üéí";
                    else if (wTxt.includes('√âlastique') || wTxt.includes('Band')) emoji = "üßò";
                    else if (wTxt.includes('PDC')) emoji = "üí™";
                    
                    wVal = parseFloat(wTxt.replace(/[^0-9.]/g, '')) || 0;

                    const div = document.createElement('div');
                    div.className = 'summary-item';
                    div.innerHTML = `
                        <div class="exercise-name">${item.name}</div>
                        <div class="summary-row">
                            <div class="stepper" data-idx="${i}" data-type="reps">
                                <button class="minus">-</button>
                                <span>${item.reps || item.duration || 0}</span>
                                <button class="plus">+</button>
                            </div>
                            <div class="stepper" data-idx="${i}" data-type="weight" data-emoji="${emoji}">
                                <button class="minus">-</button>
                                <span>${wVal}</span>
                                <button class="plus">+</button>
                                <span style="font-size:1.2em">${emoji}</span>
                            </div>
                        </div>
                    `;
                    list.appendChild(div);
                }
            });

            document.getElementById('summary-modal').classList.add('visible');
        }

        async function finishWorkout() {
            const btn = document.getElementById('save-btn');
            btn.disabled = true; btn.textContent = "SAUVEGARDE...";

            const sessionIdx = loadedProgram.sessions.findIndex(s => s.nom_session === currentSummaryContext.sessionName);
            const items = document.querySelectorAll('.summary-item');
            
            // Reconstitution du plan avec les nouvelles valeurs
            // FIX: Utilisation du bon plan source selon le mode
            let planToSave = (currentSummaryContext.mode === 'workout') ? currentPlan : JSON.parse(JSON.stringify(loadedProgram.sessions[sessionIdx].exercices_et_pauses));

            items.forEach(div => {
                const repEl = div.querySelector('.stepper[data-type="reps"]');
                const wEl = div.querySelector('.stepper[data-type="weight"]');
                const idx = parseInt(repEl.dataset.idx);
                
                const rVal = parseFloat(repEl.querySelector('span').textContent);
                const wVal = parseFloat(wEl.querySelector('span').textContent);
                const emoji = wEl.dataset.emoji;

                const ex = planToSave[idx];
                if (ex.reps) ex.reps = rVal;
                else if (ex.duration) ex.duration = rVal;

                // Reconstruction texte poids
                if (emoji === "üéí") ex.weight_text = `üéí Sac ${wVal} kg`;
                else if (emoji === "üßò") ex.weight_text = `üßò √âlastique ${wVal} kg`;
                else if (emoji === "üí™") ex.weight_text = `üí™ PDC`;
                else ex.weight_text = `üèãÔ∏è ${wVal} kg`;
            });

            // Sauvegarde Local
            loadedProgram.sessions[sessionIdx].exercices_et_pauses = planToSave;

            // Ajout Historique si Workout
            if (currentSummaryContext.mode === 'workout') {
                workoutHistory.push({
                    date: new Date().toISOString().split('T')[0],
                    type: currentSessionName,
                    exercises: planToSave.filter(e => e.type === 'exercise').map(e => ({
                        name: e.name, reps: e.reps || e.duration, weight: e.weight_text
                    }))
                });
                if (googleAccessToken) await updateFile(historyFileId, workoutHistory);
            }

            // Sauvegarde Programme
            if (googleAccessToken) await updateFile(programFileId, loadedProgram);

            // UI Reset
            document.getElementById('summary-modal').classList.remove('visible');
            btn.disabled = false; btn.textContent = "VALIDER";

            if (currentSummaryContext.mode === 'workout') {
                quitWorkout();
            } else {
                renderHome(); // Rafra√Æchir les cartes avec les nouvelles valeurs
                showToast("Modifications enregistr√©es !");
                toggleEditMode(); // Quitter le mode √©dition
            }
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            const btn = document.getElementById('edit-program-btn');
            btn.classList.toggle('active', isEditMode);
            renderHome(); // Re-render pour appliquer la classe CSS edit-mode
            showToast(isEditMode ? "Mode √âdition Activ√©" : "Mode √âdition D√©sactiv√©");
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.querySelector('span').textContent = msg;
            t.classList.add('visible');
            setTimeout(() => t.classList.remove('visible'), 3000);
        }

    </script>
</body>
    </html>
