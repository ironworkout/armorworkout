<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArmorWorkout</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            /* --- COULEURS DYNAMIQUES DE LIGUE (Valeurs par d√©faut) --- */
            --theme-color: #22D3EE; /* Cyan par d√©faut */
            --theme-color-rgb: 34, 211, 238;
            --reactor-speed: 10s; /* Vitesse rotation */
            --glow-intensity: 0.5;
            
            /* --- BASE --- */
            --bg-color-dark: #030712; 
            --secondary-bg-color-dark: #0B132B; 
            --primary-text-color-dark: #F0F4F8; 
            --secondary-text-color-dark: #A0AEC0; 
            --border-color-dark: #1E293B; 
            
            /* --- STATUS COLORS --- */
            --neon-green: #39FF14; 
            --neon-red: #FF3131; 
            --neon-yellow: #FFF01F; 
            --neon-purple: #9400D3; 
            --neon-green-rgb: 57, 255, 20;
            --neon-red-rgb: 255, 49, 49;
            --neon-yellow-rgb: 255, 240, 31;

            /* --- STATES --- */
            --exercise-color-val: var(--theme-color);
            --break-color-val: #38bdf8;
            --finished-color-val: var(--neon-green);
            --paused-color-val: #A78BFA;

            /* --- FONTS --- */
            --font-family-main: 'Inter', sans-serif;
            --font-family-timer: 'Orbitron', sans-serif;
            --font-family-titles: 'Orbitron', sans-serif; 
            --border-radius-lg: 12px;
            --border-radius-md: 8px;
            --transition-speed: 0.3s;
        }

        /* ANIMATIONS G√âN√âRALES */
        @keyframes subtlePulse { 0%, 100% { opacity: 0.8; transform: scale(1); } 50% { opacity: 1; transform: scale(1.02); } }
        @keyframes electricBorder {
            0% { box-shadow: 0 0 5px rgba(var(--theme-color-rgb), 0.3); border-color: rgba(var(--theme-color-rgb), 0.5); }
            50% { box-shadow: 0 0 15px rgba(var(--theme-color-rgb), 0.8); border-color: var(--theme-color); }
            100% { box-shadow: 0 0 5px rgba(var(--theme-color-rgb), 0.3); border-color: rgba(var(--theme-color-rgb), 0.5); }
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* ROTATIONS DU REACTEUR (Vitesse dynamique) */
        @keyframes rotate-reactor { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }
        @keyframes rotate-reactor-reverse { from { transform: translate(-50%, -50%) rotate(360deg); } to { transform: translate(-50%, -50%) rotate(0deg); } }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; font-size: 16px; }
        
        body {
            font-family: var(--font-family-main); background-color: var(--bg-color-dark); color: var(--primary-text-color-dark); 
            line-height: 1.6; display: flex; flex-direction: column; min-height: 100vh; overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 50% 0%, rgba(var(--theme-color-rgb), 0.15) 0%, transparent 60%),
                linear-gradient(0deg, #020617 0%, #0f172a 100%);
            transition: background-image 1s ease;
        }

        /* GRID BACKGROUND */
        body::before { 
            content: ""; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 40px 40px; z-index: -1; pointer-events: none;
        }
        
        /* MODE WORKOUT - UI MINIMALISTE */
        body.workout-active header, body.workout-active footer { display: none; }
        body.workout-active main { position: fixed; inset: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; background: var(--bg-color-dark); }
        body.workout-active .app-section:not(#workout-section) { display: none; }
        body.workout-active #workout-section { display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 500px; }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; width: 100%; flex-grow: 1; display: flex; flex-direction: column; }
        
        /* HEADER */
        header {
            padding: 15px 0; background-color: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(var(--theme-color-rgb), 0.3); position: sticky; top:0; z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        header h1 { font-family: var(--font-family-titles); font-size: 1.5em; margin: 0; display: flex; align-items: center; gap: 10px; text-shadow: 0 0 10px rgba(var(--theme-color-rgb), 0.6); }
        header h1 i { color: var(--theme-color); }
        
        /* BOUTONS AUTH */
        #signin-button {
            background: transparent; border: 1px solid var(--border-color-dark); color: var(--secondary-text-color-dark);
            padding: 8px 16px; border-radius: var(--border-radius-md); font-weight: 500; cursor: pointer; transition: 0.3s;
            display: flex; align-items: center; gap: 8px;
        }
        #signin-button:hover:not(:disabled) { border-color: var(--theme-color); color: var(--theme-color); background: rgba(var(--theme-color-rgb), 0.1); }
        #drive-status { display: flex; align-items: center; gap: 8px; font-size: 0.9em; font-family: var(--font-family-timer); color: var(--neon-green); }
        body.logged-in #signin-button { display: none; }
        body.logged-out #drive-status { display: none; }

        /* SECTIONS & CARTES */
        .app-section { width: 100%; animation: fadeIn 0.6s ease-out; }
        .section-hidden { display: none !important; }

        .home-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; }
        @media (max-width: 900px) { .home-grid { grid-template-columns: 1fr; } }

        .session-card-large {
            background: rgba(30, 41, 59, 0.6); border: 1px solid var(--border-color-dark);
            border-radius: var(--border-radius-lg); padding: 25px; margin-bottom: 20px;
            cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden;
        }
        .session-card-large:hover { 
            border-color: var(--theme-color); transform: translateY(-3px); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3), inset 0 0 20px rgba(var(--theme-color-rgb), 0.05); 
        }
        .session-card-large h3 { font-family: var(--font-family-titles); color: var(--theme-color); font-size: 1.4em; margin-bottom: 10px; }
        .session-card-large p { color: var(--secondary-text-color-dark); font-size: 0.95em; }
        .global-performance-chart-container { height: 200px; margin-top: 15px; position: relative; }

        /* SIDEBAR MODULES */
        .sidebar-module {
            background: rgba(30, 41, 59, 0.6); border: 1px solid var(--border-color-dark);
            border-radius: var(--border-radius-lg); padding: 20px; margin-bottom: 20px;
        }
        .sidebar-module h3 { font-family: var(--font-family-titles); color: #fff; border-bottom: 1px solid var(--border-color-dark); padding-bottom: 10px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        
        /* LEAGUE BADGE */
        .league-badge { text-align: center; padding: 10px; position: relative; }
        .league-icon { font-size: 3.5em; margin-bottom: 10px; color: var(--theme-color); filter: drop-shadow(0 0 15px rgba(var(--theme-color-rgb), 0.6)); transition: 0.5s; }
        .league-name { font-family: var(--font-family-titles); font-size: 1.2em; font-weight: bold; color: var(--theme-color); text-transform: uppercase; letter-spacing: 1px; }
        .streak-count { font-size: 0.9em; color: var(--secondary-text-color-dark); margin-top: 5px; }

        /* ARC REACTOR TIMER */
        .timer-display { position: relative; width: 280px; height: 280px; margin: 0 auto 30px; display: flex; align-items: center; justify-content: center; }
        .timer-progress-svg { position: absolute; top:0; left:0; width: 100%; height: 100%; transform: rotate(-90deg); }
        .timer-track { fill: none; stroke: rgba(255,255,255,0.05); stroke-width: 6; }
        .timer-indicator { fill: none; stroke: var(--theme-color); stroke-width: 6; stroke-linecap: round; transition: stroke-dashoffset 1s linear; filter: drop-shadow(0 0 5px var(--theme-color)); }
        
        .reactor { 
            position: relative; width: 200px; height: 200px; border-radius: 50%; 
            background: radial-gradient(circle, #1a202c 40%, #000 100%);
            box-shadow: 0 0 20px rgba(var(--theme-color-rgb), 0.3), inset 0 0 30px rgba(var(--theme-color-rgb), 0.2);
            border: 4px solid rgba(var(--theme-color-rgb), 0.3);
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }
        /* Reactor Core */
        .reactor::after { content:""; position:absolute; inset: 15px; border-radius: 50%; border: 2px dashed rgba(var(--theme-color-rgb), 0.6); animation: rotate-reactor-reverse var(--reactor-speed) linear infinite; }
        
        .triangle { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 160px; height: 160px; 
            background: conic-gradient(from 0deg, transparent 0%, var(--theme-color) 15%, transparent 30%);
            border-radius: 50%; opacity: 0.3; animation: rotate-reactor var(--reactor-speed) linear infinite; 
        }
        
        #time-left { 
            position: relative; z-index: 10; font-family: var(--font-family-timer); font-size: 3.5em; 
            font-weight: 700; color: #fff; text-shadow: 0 0 10px rgba(var(--theme-color-rgb), 0.8); 
        }

        /* WORKOUT INFO */
        .workout-info { text-align: center; margin-bottom: 20px; width: 100%; }
        #current-exercise-name-display { font-family: var(--font-family-titles); font-size: 1.4em; color: var(--theme-color); margin-bottom: 10px; min-height: 1.5em; text-shadow: 0 0 8px rgba(var(--theme-color-rgb), 0.4); }
        .exercise-details { 
            background: rgba(15, 23, 42, 0.8); border: 1px solid var(--border-color-dark); border-left: 4px solid var(--theme-color);
            padding: 15px 25px; border-radius: var(--border-radius-md); display: inline-block; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .main-stats { font-size: 1.2em; font-weight: bold; font-family: var(--font-family-timer); display: flex; gap: 20px; justify-content: center; }
        
        /* CONTROLS */
        .controls { display: flex; gap: 15px; justify-content: center; margin-top: 20px; width: 100%; flex-wrap: wrap; }
        .controls button { 
            background: rgba(30, 41, 59, 0.5); border: 1px solid var(--border-color-dark); color: #fff;
            padding: 12px 24px; border-radius: 8px; font-family: var(--font-family-titles); cursor: pointer; transition: all 0.2s;
            display: flex; align-items: center; gap: 8px; min-width: 60px; justify-content: center;
        }
        .controls button:hover:not(:disabled) { border-color: var(--theme-color); color: var(--theme-color); background: rgba(var(--theme-color-rgb), 0.1); transform: translateY(-2px); }
        .controls button:disabled { opacity: 0.5; cursor: not-allowed; }
        #start-pause-btn { background: var(--theme-color); color: #000; border: none; font-weight: bold; min-width: 140px; box-shadow: 0 0 15px rgba(var(--theme-color-rgb), 0.4); }
        #start-pause-btn:hover:not(:disabled) { background: #fff; box-shadow: 0 0 25px rgba(var(--theme-color-rgb), 0.8); color: #000; transform: scale(1.05); }

        /* R√âSUM√â MODAL */
        .post-workout-summary { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; display: none; 
            align-items: center; justify-content: center; backdrop-filter: blur(10px); 
        }
        .post-workout-summary.visible { display: flex; animation: fadeIn 0.3s; }
        .summary-content { 
            background: #0f172a; width: 90%; max-width: 650px; max-height: 90vh; overflow-y: auto; padding: 25px; 
            border-radius: 16px; border: 1px solid var(--theme-color); box-shadow: 0 0 30px rgba(var(--theme-color-rgb), 0.2); 
        }
        .summary-header { text-align: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-color-dark); padding-bottom: 15px; }
        .summary-header h2 { font-family: var(--font-family-titles); color: var(--theme-color); }
        
        .summary-item { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 10px; }
        .summary-row { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .stepper { display: flex; align-items: center; background: #020617; border-radius: 6px; border: 1px solid var(--border-color-dark); overflow: hidden; }
        .stepper button { background: none; border: none; color: var(--theme-color); width: 35px; height: 35px; cursor: pointer; font-size: 1.1em; transition: 0.2s; }
        .stepper button:hover { background: rgba(var(--theme-color-rgb), 0.1); }
        .stepper span { width: 50px; text-align: center; font-weight: bold; font-family: var(--font-family-timer); }
        .finish-btn-large { width: 100%; padding: 15px; margin-top: 20px; background: var(--neon-green); color: #000; border: none; border-radius: 8px; font-weight: bold; font-family: var(--font-family-titles); cursor: pointer; font-size: 1.1em; }
        .finish-btn-large:hover { filter: brightness(1.2); box-shadow: 0 0 20px var(--neon-green); }

        /* MESSAGE AREA */
        .message-area { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #1e293b; color: #fff; padding: 12px 24px; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); opacity: 0; pointer-events: none; transition: 0.3s; z-index: 5000; border: 1px solid var(--theme-color); }
        .message-area.visible { opacity: 1; transform: translate(-50%, -10px); }

        /* FOOTER */
        footer { padding: 30px; text-align: center; font-size: 0.85em; color: var(--secondary-text-color-dark); border-top: 1px solid var(--border-color-dark); margin-top: 50px; }
    </style>
</head>
<body class="logged-out state-idle">

    <header>
        <div class="header-content">
            <h1><i class="fas fa-shield-alt"></i> Armor<span>Workout</span></h1>
            <div class="header-actions">
                <button id="signin-button"><i class="fab fa-google"></i> Connexion Drive</button>
                <div id="drive-status"><i class="fas fa-check-circle"></i> Sync Active</div>
            </div>
        </div>
    </header>

    <div class="container">
        <main>
            <!-- ACCUEIL -->
            <div id="home-section" class="app-section">
                <div class="home-grid">
                    <div class="home-main-content" id="session-cards-container">
                        <!-- Cartes g√©n√©r√©es par JS -->
                        <div style="text-align:center; padding: 40px; opacity: 0.7;">Chargement du programme...</div>
                    </div>
                    
                    <div class="home-sidebar">
                        <!-- Module Ligue -->
                        <div class="sidebar-module" style="border-color: var(--theme-color); box-shadow: 0 0 15px rgba(var(--theme-color-rgb), 0.1);">
                            <div class="league-badge" id="league-display">
                                <!-- G√©n√©r√© par JS -->
                            </div>
                        </div>

                        <!-- Module Assiduit√© -->
                        <div class="sidebar-module">
                            <h3><i class="fas fa-calendar-check"></i> Assiduit√©</h3>
                            <div class="consistency-info">
                                <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                                    <span style="font-size:0.9em">Objectif Semaine</span>
                                    <strong id="weekly-count-display">0 / 2</strong>
                                </div>
                                <div class="weekly-goal-progress-bar" style="height:8px; background:#1e293b; border-radius:4px; overflow:hidden;">
                                    <div id="weekly-progress-bar" style="height:100%; width:0%; background: var(--theme-color); transition: 1s;"></div>
                                </div>
                                <p id="streak-display" style="margin-top:10px; font-size:0.9em; color:var(--neon-green);"><i class="fas fa-fire"></i> S√©rie : 0 semaines</p>
                            </div>
                        </div>

                        <!-- Module Historique -->
                        <div class="sidebar-module">
                            <h3><i class="fas fa-history"></i> Historique R√©cent</h3>
                            <ul id="recent-history-list" style="list-style:none; padding:0; font-size:0.9em;"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- WORKOUT -->
            <div id="workout-section" class="app-section section-hidden">
                <div class="timer-display">
                    <div class="timer-progress-circle-container" style="position:absolute; inset:0;">
                        <svg class="timer-progress-svg" viewBox="0 0 100 100">
                            <circle class="timer-track" cx="50" cy="50" r="45"></circle>
                            <circle id="timer-progress-indicator" class="timer-indicator" cx="50" cy="50" r="45" stroke-dasharray="283" stroke-dashoffset="0"></circle>
                        </svg>
                    </div>
                    <div class="reactor">
                        <div class="triangle"></div>
                        <div id="time-left">00:00</div>
                    </div>
                </div>

                <div class="workout-info">
                    <div id="current-exercise-name-display">Exercice</div>
                    <div id="current-exercise-container"></div>
                </div>

                <div class="controls">
                    <button id="prev-btn"><i class="fas fa-backward"></i></button>
                    <button id="start-pause-btn"><i class="fas fa-play"></i> D√âMARRER</button>
                    <button id="skip-btn"><i class="fas fa-forward"></i></button>
                    <button id="reset-btn" style="border-color:var(--neon-red); color:var(--neon-red);"><i class="fas fa-times"></i></button>
                </div>
            </div>
        </main>
    </div>

    <!-- SUMMARY MODAL -->
    <div id="post-workout-summary" class="post-workout-summary">
        <div class="summary-content">
            <div class="summary-header">
                <h2>Mission Accomplie</h2>
                <p>Validez vos performances pour la surcharge progressive.</p>
            </div>
            <div id="summary-items-list"></div>
            <button id="finish-summary-btn" class="finish-btn-large">ENREGISTRER & FERMER</button>
        </div>
    </div>

    <div id="message-area" class="message-area"></div>

    <footer>
        <p>&copy; <span id="current-year"></span> ArmorWorkout. Powered by Arc Reactor Core.</p>
    </footer>

    <script async defer src="https://accounts.google.com/gsi/client"></script>
    <script>
        "use strict";

        // =================================================================================
        // 1. CONSTANTES & CONFIGURATION
        // =================================================================================
        const GOOGLE_CLIENT_ID = "731283926358-viam3ulpgna14flfdeb9m92l8s620hoi.apps.googleusercontent.com";
        const GOOGLE_DRIVE_SCOPES = 'https://www.googleapis.com/auth/drive.file';
        
        const PROGRAM_FILENAME = "programme.json";
        const HISTORY_FILENAME = "armorworkout_history.json";
        
        const WEEKLY_GOAL = 2; // Objectif 2 s√©ances/semaine
        
        // Syst√®me de Ligues
        const LEAGUES = [
            { name: "Bois", minStreak: 0, color: "#A0522D", speed: "10s", glow: 0.3, icon: "fa-tree" },
            { name: "Pierre", minStreak: 2, color: "#78909C", speed: "9s", glow: 0.3, icon: "fa-cube" },
            { name: "Bronze", minStreak: 4, color: "#CD7F32", speed: "8s", glow: 0.4, icon: "fa-medal" },
            { name: "Argent", minStreak: 6, color: "#C0C0C0", speed: "7s", glow: 0.5, icon: "fa-shield-alt" },
            { name: "Or", minStreak: 8, color: "#FFD700", speed: "6s", glow: 0.6, icon: "fa-trophy" },
            { name: "Platine", minStreak: 12, color: "#E5E4E2", speed: "5s", glow: 0.7, icon: "fa-crown" },
            { name: "√âmeraude", minStreak: 16, color: "#50C878", speed: "4s", glow: 0.8, icon: "fa-gem" },
            { name: "Rubis", minStreak: 20, color: "#E0115F", speed: "3s", glow: 0.8, icon: "fa-heart" },
            { name: "Diamant", minStreak: 26, color: "#B9F2FF", speed: "2s", glow: 0.9, icon: "fa-sun" },
            { name: "Vibranium", minStreak: 32, color: "#FFFFFF", speed: "0.8s", glow: 1.0, icon: "fa-atom" }
        ];

        // √âtat Global
        let loadedProgram = null;
        let workoutHistory = [];
        let googleAccessToken = null;
        let tokenClient = null;
        let programFileId = null;
        let historyFileId = null;

        // √âtat S√©ance
        let currentSession = null;
        let currentPlan = [];
        let currentIdx = 0;
        let timerInterval = null;
        let timeLeft = 0;
        let totalTime = 0;
        let isTimerRunning = false;
        let workoutStartTime = null;
        let currentState = 'idle';

        // =================================================================================
        // 2. INITIALISATION
        // =================================================================================
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('current-year').textContent = new Date().getFullYear();
            initGis();
            addEventListeners();
            
            // Fallback: update UI with default theme if no login
            updateThemeForLeague(LEAGUES[0]);
        });

        function addEventListeners() {
            document.getElementById('signin-button').addEventListener('click', handleAuthClick);
            document.getElementById('start-pause-btn').addEventListener('click', toggleTimer);
            document.getElementById('skip-btn').addEventListener('click', nextExercise);
            document.getElementById('prev-btn').addEventListener('click', prevExercise);
            document.getElementById('reset-btn').addEventListener('click', confirmQuit);
            document.getElementById('finish-summary-btn').addEventListener('click', finalizeWorkout);
            
            // D√©l√©gation d'√©v√©nements pour le stepper
            document.getElementById('summary-items-list').addEventListener('click', handleStepperClick);
        }

        // =================================================================================
        // 3. LOGIQUE LIGUES & ASSIDUIT√â
        // =================================================================================
        function calculateCurrentLeague() {
            if (!workoutHistory || workoutHistory.length === 0) return LEAGUES[0];

            // 1. Grouper par semaine ISO (YYYY-WW)
            const weeks = {};
            workoutHistory.forEach(h => {
                const date = new Date(h.date);
                const year = date.getFullYear();
                const onejan = new Date(year, 0, 1);
                const week = Math.ceil((((date - onejan) / 86400000) + onejan.getDay() + 1) / 7);
                const key = `${year}-${week.toString().padStart(2,'0')}`;
                weeks[key] = (weeks[key] || 0) + 1;
            });

            // 2. Calculer le Streak actuel (en remontant les semaines)
            let streak = 0;
            const now = new Date();
            let year = now.getFullYear();
            let onejan = new Date(year, 0, 1);
            let currentWeek = Math.ceil((((now - onejan) / 86400000) + onejan.getDay() + 1) / 7);
            
            // V√©rifier la semaine en cours
            const currentKey = `${year}-${currentWeek.toString().padStart(2,'0')}`;
            let countThisWeek = weeks[currentKey] || 0;
            
            // Mise √† jour de la barre de progression hebdo
            updateWeeklyProgress(countThisWeek);

            // Algorithme de Streak (simplifi√© : on regarde les semaines pass√©es)
            // Note: Pour une vraie prod, il faudrait une gestion parfaite des dates.
            // Ici, on approxime en comptant les semaines "valides" cons√©cutives.
            const sortedWeeks = Object.keys(weeks).sort().reverse();
            for (let w of sortedWeeks) {
                if (w === currentKey) continue; // On ignore la semaine en cours pour le streak pass√©
                if (weeks[w] >= WEEKLY_GOAL) streak++;
                else break;
            }
            // Si la semaine courante est valid√©e, on l'ajoute
            if (countThisWeek >= WEEKLY_GOAL) streak++;

            document.getElementById('streak-display').innerHTML = `<i class="fas fa-fire"></i> S√©rie : ${streak} semaine${streak>1?'s':''}`;

            // 3. Trouver la ligue
            let myLeague = LEAGUES[0];
            for (let l of LEAGUES) {
                if (streak >= l.minStreak) myLeague = l;
            }
            return myLeague;
        }

        function updateWeeklyProgress(count) {
            const el = document.getElementById('weekly-progress-bar');
            const txt = document.getElementById('weekly-count-display');
            const pct = Math.min((count / WEEKLY_GOAL) * 100, 100);
            el.style.width = pct + '%';
            txt.textContent = `${count} / ${WEEKLY_GOAL}`;
            
            if (count >= WEEKLY_GOAL) {
                el.style.background = "var(--neon-green)";
                el.style.boxShadow = "0 0 10px var(--neon-green)";
            }
        }

        function updateThemeForLeague(league) {
            const root = document.documentElement;
            root.style.setProperty('--theme-color', league.color);
            // Conversion Hex to RGB approximative pour les opacit√©s
            // Pour faire simple ici on garde les couleurs d√©finies
            root.style.setProperty('--reactor-speed', league.speed);
            
            // Mise √† jour du badge
            const badge = document.getElementById('league-display');
            badge.innerHTML = `
                <div class="league-icon"><i class="fas ${league.icon}"></i></div>
                <div class="league-name">${league.name}</div>
                <div class="streak-count">Seuil : ${league.minStreak} semaines</div>
            `;
        }

        // =================================================================================
        // 4. GOOGLE DRIVE SYNC
        // =================================================================================
        function initGis() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID, scope: GOOGLE_DRIVE_SCOPES,
                callback: async (resp) => {
                    if (resp.access_token) {
                        googleAccessToken = resp.access_token;
                        document.body.classList.replace('logged-out', 'logged-in');
                        showMessage("Connexion r√©ussie. Synchronisation...");
                        await loadDataFromDrive();
                    }
                }
            });
        }

        function handleAuthClick() { tokenClient.requestAccessToken(); }

        async function loadDataFromDrive() {
            try {
                // Programme
                programFileId = await findFile(PROGRAM_FILENAME);
                if (programFileId) {
                    const content = await downloadFile(programFileId);
                    loadedProgram = JSON.parse(content);
                } else {
                    showMessage("‚ö†Ô∏è programme.json introuvable !", 5000);
                }

                // Historique
                historyFileId = await findFile(HISTORY_FILENAME);
                if (historyFileId) {
                    const content = await downloadFile(historyFileId);
                    workoutHistory = JSON.parse(content);
                } else {
                    // Cr√©ation si inexistant
                    historyFileId = await createFile(HISTORY_FILENAME, JSON.stringify([]));
                    workoutHistory = [];
                }

                renderHomeScreen();
            } catch (e) {
                console.error(e);
                showMessage("Erreur Sync Drive", 4000);
            }
        }

        // Helpers Drive basiques
        async function findFile(name) {
            const q = `name='${name}'+and+trashed=false`;
            const res = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}`, { headers: { Authorization: `Bearer ${googleAccessToken}` } });
            const data = await res.json();
            return data.files && data.files.length > 0 ? data.files[0].id : null;
        }
        async function downloadFile(id) {
            const res = await fetch(`https://www.googleapis.com/drive/v3/files/${id}?alt=media`, { headers: { Authorization: `Bearer ${googleAccessToken}` } });
            return await res.text();
        }
        async function updateFile(id, content) {
            await fetch(`https://www.googleapis.com/upload/drive/v3/files/${id}?uploadType=media`, {
                method: 'PATCH', headers: { Authorization: `Bearer ${googleAccessToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(content, null, 2)
            });
        }
        async function createFile(name, content) {
            const meta = { name, mimeType: 'application/json' };
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(meta)], { type: 'application/json' }));
            form.append('file', new Blob([content], { type: 'application/json' }));
            const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST', headers: { Authorization: `Bearer ${googleAccessToken}` }, body: form
            });
            const data = await res.json();
            return data.id;
        }

        // =================================================================================
        // 5. MOTEUR D'ENTRA√éNEMENT (Arc Reactor Logic)
        // =================================================================================
        function renderHomeScreen() {
            // Mettre √† jour la Ligue avant d'afficher
            const league = calculateCurrentLeague();
            updateThemeForLeague(league);

            const container = document.getElementById('session-cards-container');
            container.innerHTML = '';

            if (!loadedProgram) {
                container.innerHTML = `<div style="text-align:center; padding:20px;">En attente de programme.json...</div>`;
                return;
            }

            loadedProgram.sessions.forEach(session => {
                const card = document.createElement('div');
                card.className = 'session-card-large';
                card.innerHTML = `
                    <h3>${session.nom_session}</h3>
                    <p>${session.description_session || 'Pas de description'}</p>
                    <div style="margin-top:15px; color:var(--theme-color); font-weight:bold;">
                        <i class="fas fa-play-circle"></i> LANCER
                    </div>
                `;
                card.onclick = () => startSession(session);
                container.appendChild(card);
            });

            // Afficher l'historique
            const list = document.getElementById('recent-history-list');
            list.innerHTML = '';
            workoutHistory.slice(-5).reverse().forEach(h => {
                const li = document.createElement('li');
                li.innerHTML = `<span style="color:var(--secondary-text-color-dark)">${h.date}</span> : <strong style="color:#fff">${h.type}</strong>`;
                li.style.marginBottom = "8px";
                li.style.borderBottom = "1px solid rgba(255,255,255,0.05)";
                li.style.paddingBottom = "5px";
                list.appendChild(li);
            });
        }

        function startSession(session) {
            currentSession = session;
            currentPlan = JSON.parse(JSON.stringify(session.exercices_et_pauses)); // Deep copy
            currentIdx = 0;
            workoutStartTime = new Date();
            
            document.getElementById('home-section').classList.add('section-hidden');
            document.getElementById('workout-section').classList.remove('section-hidden');
            document.body.classList.add('workout-active');
            
            loadExercise();
        }

        function loadExercise() {
            const item = currentPlan[currentIdx];
            const isRest = item.type === 'break';
            const nameEl = document.getElementById('current-exercise-name-display');
            const contEl = document.getElementById('current-exercise-container');
            const btn = document.getElementById('start-pause-btn');

            currentState = isRest ? 'break' : 'exercise';
            document.body.className = `workout-active state-${currentState}`;

            nameEl.textContent = item.name || (isRest ? "REPOS" : "Exercice");
            
            if (isRest) {
                totalTime = item.duration || 60;
                timeLeft = totalTime;
                contEl.innerHTML = `<div class="exercise-details" style="border-color:var(--break-color-val)">R√©cup√©ration</div>`;
                btn.innerHTML = `<i class="fas fa-play"></i> CHRONO`;
                isTimerRunning = false;
            } else {
                // Gestion affichage poids/reps avec emojis
                const weightClean = item.weight_text || (item.weight ? item.weight + 'kg' : 'PDC');
                const repsClean = item.reps || item.duration + 's';
                
                contEl.innerHTML = `
                    <div class="exercise-details">
                        <div class="main-stats">
                            <span><i class="fas fa-repeat"></i> ${repsClean}</span>
                            <span><i class="fas fa-weight-hanging"></i> ${weightClean}</span>
                        </div>
                        <p style="margin-top:10px; opacity:0.8; font-size:0.9em;">${item.details || ''}</p>
                    </div>
                `;
                
                if (item.duration) {
                    totalTime = item.duration;
                    timeLeft = totalTime;
                    btn.innerHTML = `<i class="fas fa-play"></i> GO`;
                    isTimerRunning = false;
                } else {
                    totalTime = 0;
                    timeLeft = 0;
                    btn.innerHTML = `<i class="fas fa-check"></i> VALID√â`;
                    isTimerRunning = false;
                }
            }
            updateTimerDisplay();
        }

        function toggleTimer() {
            const item = currentPlan[currentIdx];
            const btn = document.getElementById('start-pause-btn');

            // Si c'est un exo aux reps (pas de dur√©e) -> Validation directe
            if (item.type !== 'break' && !item.duration) {
                nextExercise();
                return;
            }

            // Sinon gestion du chrono
            if (isTimerRunning) {
                clearInterval(timerInterval);
                isTimerRunning = false;
                btn.innerHTML = `<i class="fas fa-play"></i> REPRENDRE`;
                document.body.classList.add('state-paused');
            } else {
                isTimerRunning = true;
                btn.innerHTML = `<i class="fas fa-pause"></i> PAUSE`;
                document.body.classList.remove('state-paused');
                
                timerInterval = setInterval(() => {
                    timeLeft--;
                    updateTimerDisplay();
                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        isTimerRunning = false;
                        if (item.type === 'break') {
                            nextExercise(); // Fin de pause auto
                        } else {
                            btn.innerHTML = `<i class="fas fa-check"></i> TERMIN√â`; // Fin d'exo temps
                        }
                    }
                }, 1000);
            }
        }

        function updateTimerDisplay() {
            const el = document.getElementById('time-left');
            const circle = document.getElementById('timer-progress-indicator');
            
            if (totalTime > 0) {
                const m = Math.floor(timeLeft / 60).toString().padStart(2,'0');
                const s = (timeLeft % 60).toString().padStart(2,'0');
                el.textContent = `${m}:${s}`;
                
                const pct = timeLeft / totalTime;
                const circumference = 2 * Math.PI * 45; // r=45
                circle.style.strokeDashoffset = circumference * (1 - pct);
            } else {
                el.textContent = "00:00";
                circle.style.strokeDashoffset = 0;
            }
        }

        function nextExercise() {
            clearInterval(timerInterval);
            currentIdx++;
            if (currentIdx >= currentPlan.length) {
                showPostWorkoutSummary();
            } else {
                loadExercise();
            }
        }

        function prevExercise() {
            if (currentIdx > 0) {
                clearInterval(timerInterval);
                currentIdx--;
                loadExercise();
            }
        }

        function confirmQuit() {
            if(confirm("Quitter la s√©ance en cours ?")) {
                clearInterval(timerInterval);
                document.body.classList.remove('workout-active');
                document.getElementById('workout-section').classList.add('section-hidden');
                document.getElementById('home-section').classList.remove('section-hidden');
            }
        }

        // =================================================================================
        // 6. R√âSUM√â & SAUVEGARDE
        // =================================================================================
        function showPostWorkoutSummary() {
            const list = document.getElementById('summary-items-list');
            list.innerHTML = '';
            
            // On ne liste que les exercices (pas les pauses)
            currentPlan.forEach((item, index) => {
                if (item.type === 'exercise') {
                    const el = document.createElement('div');
                    el.className = 'summary-item';
                    
                    // Parsing du poids pour isoler la valeur num√©rique et l'emoji
                    // Ex: "üéí 7.6 kg" -> emoji="üéí", val=7.6
                    let weightVal = parseFloat(item.weight_text.replace(/[^0-9.]/g, '')) || 0;
                    let emoji = "üèãÔ∏è";
                    if (item.weight_text.includes('üéí')) emoji = "üéí";
                    if (item.weight_text.includes('üü™')) emoji = "üü™";
                    if (item.weight_text.includes('üü¶')) emoji = "üü¶";
                    if (item.weight_text.includes('üßò')) emoji = "üßò";

                    el.innerHTML = `
                        <div class="summary-row">
                            <strong>${item.name}</strong>
                        </div>
                        <div class="summary-row">
                            <div class="input-group">
                                <label style="font-size:0.8em; color:var(--secondary-text-color-dark)">Reps/Temps</label>
                                <div class="stepper" data-type="reps" data-idx="${index}">
                                    <button class="minus">-</button>
                                    <span>${item.reps || item.duration}</span>
                                    <button class="plus">+</button>
                                </div>
                            </div>
                            <div class="input-group">
                                <label style="font-size:0.8em; color:var(--secondary-text-color-dark)">Charge (${emoji})</label>
                                <div class="stepper" data-type="weight" data-idx="${index}" data-emoji="${emoji}">
                                    <button class="minus">-</button>
                                    <span>${weightVal}</span>
                                    <button class="plus">+</button>
                                </div>
                            </div>
                        </div>
                    `;
                    list.appendChild(el);
                }
            });

            document.getElementById('post-workout-summary').classList.add('visible');
        }

        function handleStepperClick(e) {
            const btn = e.target.closest('button');
            if (!btn) return;
            
            const stepper = btn.closest('.stepper');
            const span = stepper.querySelector('span');
            let val = parseFloat(span.textContent);
            const isWeight = stepper.dataset.type === 'weight';
            const step = isWeight ? 0.5 : 1;

            if (btn.classList.contains('minus')) val = Math.max(0, val - step);
            else val += step;

            // Formattage : pas de d√©cimale si entier
            span.textContent = Number.isInteger(val) ? val : val.toFixed(1);
        }

        async function finalizeWorkout() {
            const btn = document.getElementById('finish-summary-btn');
            btn.disabled = true;
            btn.textContent = "SAUVEGARDE EN COURS...";

            // 1. Appliquer les modifs au Programme charg√©
            const summaryItems = document.querySelectorAll('.summary-item');
            summaryItems.forEach(row => {
                const repStepper = row.querySelector('.stepper[data-type="reps"]');
                const weightStepper = row.querySelector('.stepper[data-type="weight"]');
                const idx = parseInt(repStepper.dataset.idx);
                
                const newValReps = parseFloat(repStepper.querySelector('span').textContent);
                const newValWeight = parseFloat(weightStepper.querySelector('span').textContent);
                const emoji = weightStepper.dataset.emoji;

                // Mise √† jour de l'objet item
                const item = currentPlan[idx];
                if (item.reps) item.reps = newValReps;
                else if (item.duration) item.duration = newValReps;
                
                // Reconstruction du texte poids
                item.weight_text = `${emoji} ${newValWeight} kg`;
            });

            // 2. Mettre √† jour l'objet global loadedProgram
            // On doit trouver la bonne session dans loadedProgram
            const targetSession = loadedProgram.sessions.find(s => s.nom_session === currentSession.nom_session);
            if (targetSession) {
                targetSession.exercices_et_pauses = currentPlan;
            }

            // 3. Cr√©er l'entr√©e d'historique
            const historyEntry = {
                date: new Date().toISOString().split('T')[0], // YYYY-MM-DD
                type: currentSession.nom_session,
                exercises: currentPlan.filter(i => i.type === 'exercise').map(i => ({
                    name: i.name,
                    reps: i.reps || i.duration,
                    weight: i.weight_text
                }))
            };
            workoutHistory.push(historyEntry);

            // 4. Sauvegarde Drive
            if (googleAccessToken) {
                try {
                    await updateFile(programFileId, loadedProgram);
                    await updateFile(historyFileId, workoutHistory);
                    showMessage("Sauvegarde r√©ussie !", 3000);
                } catch (e) {
                    console.error(e);
                    showMessage("Erreur sauvegarde !", 5000);
                }
            }

            // UI Reset
            document.getElementById('post-workout-summary').classList.remove('visible');
            document.body.classList.remove('workout-active');
            document.getElementById('workout-section').classList.add('section-hidden');
            document.getElementById('home-section').classList.remove('section-hidden');
            
            btn.disabled = false;
            btn.textContent = "ENREGISTRER & FERMER";
            
            // Recalculer les ligues avec la nouvelle entr√©e
            renderHomeScreen();
        }

        function showMessage(txt, duration = 3000) {
            const el = document.getElementById('message-area');
            el.textContent = txt;
            el.classList.add('visible');
            setTimeout(() => el.classList.remove('visible'), duration);
        }

    </script>
</body>
    </html>
