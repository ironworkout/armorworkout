Vous avez raison, c'est encore une erreur de ma part dans la réorganisation du code.


<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArmorWorkout - Électrique</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color-dark: #030712; 
            --secondary-bg-color-dark: #0B132B; 
            --primary-text-color-dark: #F0F4F8; 
            --secondary-text-color-dark: #A0AEC0; 
            --border-color-dark: #1E293B; 
            --electric-blue: #00BFFF; 
            --electric-cyan: #22D3EE; 
            --electric-blue-light: #4D94FF; 
            --glow-accent: #0AF; 
            --electric-blue-rgb: 0, 191, 255;
            --electric-cyan-rgb: 34, 211, 238;
            --glow-accent-rgb: 0, 170, 255;
            --secondary-bg-color-dark-rgb: 11, 19, 43;
            --bg-color-dark-rgb: 3, 7, 18;
            --neon-pink: #FF1493; 
            --neon-purple: #9400D3; 
            --neon-green: #39FF14; 
            --neon-red: #FF3131; 
            --neon-yellow: #FFF01F; 
            --neon-pink-rgb: 255, 20, 147;
            --neon-purple-rgb: 148, 0, 211;
            --neon-green-rgb: 57, 255, 20;
            --neon-red-rgb: 255, 49, 49;
            --neon-yellow-rgb: 255, 240, 31;
            --glow-red: 0 0 8px var(--neon-red), 0 0 12px rgba(var(--neon-red-rgb),0.7);
            --glow-green: 0 0 8px var(--neon-green), 0 0 12px rgba(var(--neon-green-rgb),0.7);
            --glow-yellow: 0 0 8px var(--neon-yellow), 0 0 12px rgba(var(--neon-yellow-rgb),0.7);
            --glow-pink: 0 0 8px var(--neon-pink), 0 0 12px rgba(var(--neon-pink-rgb),0.7);
            --glow-purple: 0 0 8px var(--neon-purple), 0 0 12px rgba(var(--neon-purple-rgb),0.7);
            --electric-yellow: var(--neon-yellow); 
            --electric-yellow-rgb: var(--neon-yellow-rgb);
            --exercise-color-val: var(--electric-blue-light);
            --break-color-val: var(--electric-cyan);
            --paused-color-val: #A78BFA; 
            --finished-color-val: var(--neon-green); 
            --preparing-color-val: var(--electric-cyan);
            --idle-color-val: var(--electric-blue);
            --exercise-color-rgb: 77, 148, 255; 
            --break-color-rgb: var(--electric-cyan-rgb);
            --paused-color-rgb: 167, 139, 250;
            --finished-color-rgb: var(--neon-green-rgb); 
            --preparing-color-rgb: var(--electric-cyan-rgb);
            --idle-color-rgb: var(--electric-blue-rgb);
            --color-exercise: var(--exercise-color-val);
            --color-break: var(--break-color-val);
            --color-prepare: var(--preparing-color-val);
            --color-finished: var(--finished-color-val);
            --color-paused: var(--paused-color-val);
            --color-idle: var(--secondary-text-color-dark);
            --font-family-main: 'Inter', sans-serif;
            --font-family-timer: 'Orbitron', sans-serif;
            --font-family-titles: 'Orbitron', sans-serif; 
            --border-radius-lg: 10px;
            --border-radius-md: 8px;
            --border-radius-sm: 6px;
            --transition-speed: 0.3s;
            --section-transition-speed: 0.4s;
            --bg-color: var(--bg-color-dark);
            --secondary-bg-color: var(--secondary-bg-color-dark);
            --primary-text-color: var(--primary-text-color-dark);
            --secondary-text-color: var(--secondary-text-color-dark);
            --border-color: var(--border-color-dark);
            --accent-border-color: rgba(var(--electric-blue-rgb), 0.4); 
            --input-bg: #1A202C; 
            --current-timer-state-color: var(--idle-color-val);
            --current-timer-state-color-rgb: var(--idle-color-rgb);
            --timer-text-color-main: #FFFFFF;
            --timer-text-glow-main: 0 0 5px #fff, 
                                    0 0 8px #fff, 
                                    0 0 12px rgba(var(--electric-cyan-rgb), 0.6), 
                                    0 0 18px rgba(var(--electric-cyan-rgb), 0.4);
            --timer-progress-circle-color: var(--electric-cyan);
        }

        @keyframes subtlePulse { 0%, 100% { opacity: 0.7; transform: scale(1); } 50% { opacity: 1; transform: scale(1.015); } }
        @keyframes electricBorder {
            0% { box-shadow: 0 0 6px rgba(var(--electric-cyan-rgb), 0.6), inset 0 0 4px rgba(var(--electric-cyan-rgb), 0.4); border-color: rgba(var(--electric-cyan-rgb), 0.7); }
            50% { box-shadow: 0 0 18px rgba(var(--electric-blue-rgb), 0.8), inset 0 0 10px rgba(var(--electric-blue-rgb), 0.6); border-color: rgba(var(--electric-blue-rgb), 0.9); }
            100% { box-shadow: 0 0 6px rgba(var(--electric-cyan-rgb), 0.6), inset 0 0 4px rgba(var(--electric-cyan-rgb), 0.4); border-color: rgba(var(--electric-cyan-rgb), 0.7); }
        }
        @keyframes textGlowPulseState {
            0%, 100% { text-shadow: 0 0 5px rgba(var(--current-timer-state-color-rgb), 0.7), 0 0 10px rgba(var(--current-timer-state-color-rgb), 0.5), 0 0 15px rgba(var(--current-timer-state-color-rgb), 0.3); }
            50% { text-shadow: 0 0 8px rgba(var(--current-timer-state-color-rgb), 0.9), 0 0 15px rgba(var(--current-timer-state-color-rgb), 0.7), 0 0 25px rgba(var(--current-timer-state-color-rgb), 0.5); }
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; font-size: 16px; }
        body {
            font-family: var(--font-family-main); background-color: var(--bg-color); color: var(--primary-text-color); line-height: 1.65;
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease; display: flex; flex-direction: column;
            min-height: 100vh; -webkit-font-smoothing: antialiased; overflow-x: hidden;
            background-image: radial-gradient(ellipse at center, rgba(var(--electric-blue-rgb), 0.08) 0%, transparent 60%), linear-gradient(0deg, rgba(var(--bg-color-dark-rgb), 0.5) 0%, rgba(var(--bg-color-dark-rgb), 0.9) 100%);
            position: relative; 
        }
        body.no-scroll { overflow: hidden; } 
        body::before { 
            content: ""; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-image: linear-gradient(rgba(var(--electric-blue-rgb), 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(var(--electric-blue-rgb), 0.05) 1px, transparent 1px);
            background-size: 30px 30px; z-index: -1; opacity: 0.7;
        }
        .container { max-width: 1100px; margin: 0 auto; padding: 30px 25px; width: 100%; flex-grow: 1; display: flex; flex-direction: column; }
        header {
            padding: 15px 0; background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.5); backdrop-filter: blur(8px) saturate(150%);
            border-bottom: 1px solid rgba(var(--electric-blue-rgb), 0.3); box-shadow: 0 2px 15px rgba(var(--electric-blue-rgb), 0.1);
            position: sticky; top:0; z-index: 1000; 
            transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out, visibility 0s linear 0s; 
        }
        body.workout-active header { transform: translateY(-100%); opacity: 0; visibility: hidden; transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out, visibility 0s linear 0.4s; }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1100px; margin: 0 auto; padding: 0 25px; flex-wrap: wrap; gap: 15px 20px; }
        header h1 { font-size: 1.6em; color: var(--primary-text-color); margin: 0; font-weight: 700; display: flex; align-items: center; gap: 10px; font-family: var(--font-family-titles); text-shadow: 0 0 8px rgba(var(--electric-cyan-rgb), 0.7); }
        header h1 i { color: var(--electric-cyan); animation: subtlePulse 3s infinite ease-in-out; }
        nav ul { list-style: none; display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; align-items: baseline; }
        nav button, nav a.nav-link {
            background: none; border: none; color: var(--secondary-text-color); font-size: 0.9em; font-weight: 500; padding: 8px 12px;
            cursor: pointer; text-decoration: none; transition: all var(--transition-speed) ease; position: relative;
            border-radius: var(--border-radius-sm); border: 1px solid transparent; display: inline-flex; align-items: center; gap: 6px;
        }
        nav button:hover, nav a.nav-link:hover:not(.disabled-link-look) { color: var(--primary-text-color); background-color: rgba(var(--electric-blue-rgb), 0.1); border-color: rgba(var(--electric-blue-rgb), 0.4); text-shadow: 0 0 5px rgba(var(--electric-blue-rgb), 0.5); }
        nav a.nav-link.disabled-link-look { opacity: 0.5; pointer-events: none; cursor: not-allowed; }
        nav button.active { color: var(--electric-cyan); font-weight: 600; background-color: rgba(var(--electric-cyan-rgb), 0.15); border-color: var(--electric-cyan); box-shadow: 0 0 10px rgba(var(--electric-cyan-rgb), 0.3); }
        #nav-history.active { border-color: var(--neon-pink); background-color: rgba(var(--neon-pink-rgb),0.15); color: var(--neon-pink); }
        nav button:disabled { color: rgba(156, 163, 175, 0.4); cursor: not-allowed; background-color: transparent !important; border-color: transparent !important; opacity: 0.6; pointer-events: none; }
        #nav-history i, nav a.nav-link i { margin-right: 5px; }
        .header-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        #drive-status-text, #signin-button {
            background-color: transparent; border: 1px solid var(--border-color-dark); color: var(--secondary-text-color-dark);
            padding: 5px 12px; border-radius: var(--border-radius-md); font-size: 0.9em; font-weight: 500; cursor: pointer;
            transition: all var(--transition-speed) ease; display: inline-flex; align-items: center; gap: 5px;
        }
        #signin-button:disabled { opacity: 0.5; cursor: not-allowed; border-color: var(--border-color-dark) !important; color: var(--secondary-text-color-dark) !important; background-color: transparent !important; box-shadow: none !important; text-shadow: none !important; pointer-events: auto; }
        #drive-status-text:hover, #signin-button:not(:disabled):hover { border-color: var(--electric-blue); color: var(--electric-blue); background-color: rgba(var(--electric-blue-rgb), 0.1); }
        #drive-status.success #drive-status-text { border-color: var(--neon-green); color: var(--neon-green); cursor: default; }
        #drive-status.loading #drive-status-text { border-color: var(--neon-yellow); color: var(--neon-yellow); }
        #drive-status.error #drive-status-text { border-color: var(--neon-red); color: var(--neon-red); }
        #signin-button { border-color: var(--neon-green); color: var(--neon-green); }
        #drive-status { display: inline-flex; align-items: center; gap: 10px; margin-left: 10px; padding: 0; background: none; border: none; font-size: 1em; color: inherit; }
        body.logged-out #signin-button { display: inline-flex; } body.logged-out #drive-status { display: none; }
        body.logged-in #signin-button { display: none; } body.logged-in #drive-status { display: inline-flex; }
        main { flex-grow: 1; display: flex; flex-direction: column; align-items: center; padding-top: 40px; position: relative; }
        body.workout-active main { padding-top: 20px; }
        .app-section {
            background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.6); backdrop-filter: blur(10px) saturate(130%); padding: 25px;
            border: 1px solid rgba(var(--electric-blue-rgb), 0.2); width: 100%; margin-bottom: 40px;
            transition: opacity var(--section-transition-speed) ease-in-out, transform 0.3s ease-in-out, visibility 0s linear var(--section-transition-speed);
            max-height: 5000px; opacity: 1; visibility: visible; overflow: hidden; border-radius: var(--border-radius-lg);
            box-shadow: 0 5px 25px rgba(var(--bg-color-dark-rgb), 0.5), inset 0 0 15px rgba(var(--electric-blue-rgb), 0.1);
        }
        .workout-section { max-width: 650px; text-align: center; }
        .history-section { max-width: 900px; text-align: left; }
        .section-hidden {
            opacity: 0; max-height: 0 !important; padding-top: 0 !important; padding-bottom: 0 !important; margin-bottom: 0 !important;
            border-width: 0 !important; visibility: hidden; transform: translateY(20px) scale(0.98);
            transition: opacity var(--section-transition-speed) ease-in-out, visibility 0s linear var(--section-transition-speed), 
                        max-height 0s linear var(--section-transition-speed), padding var(--section-transition-speed) ease-out,
                        margin var(--section-transition-speed) ease-out, border-width var(--section-transition-speed) ease-out,
                        transform 0.3s ease-in-out;
        }
        .timer-and-image-wrapper { display: flex; flex-direction: column; align-items: center; gap: 20px; margin-bottom: 25px; }
        .exercise-image-area {
            width: 100%; max-width: 260px; margin: 0 auto; padding: 8px; background-color: rgba(var(--secondary-bg-color-dark-rgb),0.4);
            border: 1px solid rgba(var(--electric-cyan-rgb), 0.3); border-radius: var(--border-radius-md); display: none; 
            justify-content: center; align-items: center; box-shadow: 0 4px 12px rgba(var(--bg-color-dark-rgb), 0.4), inset 0 0 8px rgba(var(--electric-cyan-rgb),0.2);
            z-index: 5; transition: opacity 0.4s ease-in-out, transform 0.3s ease-in-out; opacity: 0; transform: scale(0.95) translateY(10px);
        }
        .exercise-image-area.visible { display: flex; opacity: 1; transform: scale(1) translateY(0); }
        #exercise-image-display { display: block; max-width: 100%; max-height: 200px; object-fit: contain; border-radius: var(--border-radius-sm); filter: brightness(0.8) contrast(1.1); }
        .timer-display { 
            position: relative; display: flex; justify-content: center; align-items: center;
            width: 280px; height: 280px; margin: 0 auto; cursor: pointer; user-select: none; -webkit-tap-highlight-color: transparent;
        }
        .timer-progress-circle-container {
            position: absolute; top: 50%; left: 50%; width: 230px; height: 230px;
            transform: translate(-50%, -50%); pointer-events: none; 
        }
        .timer-progress-circle {
            fill: none; stroke: var(--timer-progress-circle-color); stroke-width: 6; stroke-linecap: round;
            transform-origin: center; transform: rotate(-90deg); 
            transition: stroke-dashoffset 1s linear, stroke 0.3s ease;
        }
        .timer-progress-circle-bg { fill: none; stroke: rgba(var(--electric-blue-rgb), 0.15); stroke-width: 6; }
        .timer-step-info-display { 
            position: absolute; top: 15px; left: 0; right: 0; padding: 0 20px; display: flex;
            justify-content: space-between; font-family: var(--font-family-timer); font-size: 0.8em;
            color: var(--secondary-text-color); opacity: 0; transition: opacity var(--transition-speed) ease;
            pointer-events: none; z-index: 15;
        }
        .timer-step-info-display.visible { opacity: 0.8; }
        #workout-step-current-display, #workout-step-total-display { 
            padding: 3px 8px; background-color: rgba(var(--bg-color-dark-rgb), 0.6); border-radius: var(--border-radius-sm);
            text-shadow: 0 0 4px rgba(var(--electric-cyan-rgb), 0.6); border: 1px solid rgba(var(--electric-cyan-rgb), 0.2);
        }
        .reactor { 
            position: relative; width: 180px; height: 180px; display: flex; align-items: center; justify-content: center;
            border-radius: 50%; overflow: hidden; z-index: 10; background-color: transparent; 
        }
        .reactor::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(var(--bg-color-dark-rgb), 0.3); z-index: 1; border-radius: 50%; }
        .triangle {
            z-index: 5; position: absolute; top: 66%; left: 50%; transform: translate(-50%, -50%);
            width: 155px; aspect-ratio: 1; background-color: var(--electric-cyan);
            -webkit-clip-path: polygon(50% 88%, 0 0, 100% 0); clip-path: polygon(50% 88%, 0 0, 100% 0);
            transition: transform 0.5s ease-out, background-color var(--transition-speed) ease; 
        }
        .triangle::after {
            content: ''; display: block; position: absolute; top: 45%; left: 50%; z-index: 6;
            width: 120px; height: 120px; transform: translate(-50%, -50%); background-color: var(--bg-color); 
            -webkit-clip-path: polygon(50% 90%, 0 0, 100% 0); clip-path: polygon(50% 90%, 0 0, 100% 0);
            transition: background-color var(--transition-speed) ease;
        }
        @keyframes rotate-right { to { transform: rotate(360deg); } } @keyframes rotate-left { to { transform: rotate(-360deg); } }
        @keyframes rotate-left-right { 0% { transform: translate(-50%, -50%) rotate(0deg); } 50% { transform: translate(-50%, -50%) rotate(-180deg); } 100% { transform: translate(-50%, -50%) rotate(0deg); } }
        .circle-1 { z-index: 2; position: absolute; width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(rgba(var(--electric-cyan-rgb), 0.8), rgba(var(--electric-blue-rgb), 0.8)); animation: rotate-right 2s linear infinite; }
        .circle-1::before { content: ''; position: absolute; z-index: 1; inset: 10px; border-radius: 50%; background-color: var(--bg-color); transition: background-color var(--transition-speed) ease; }
        .circle-1 span { position: absolute; width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(rgba(var(--electric-cyan-rgb), 0.8), rgba(var(--electric-blue-rgb), 0.8)); top:0; left: 0; }
        .circle-1 span:nth-child(1) { filter: blur(15px); } .circle-1 span:nth-child(2) { filter: blur(15px); } .circle-1 span:nth-child(3) { filter: blur(15px); } .circle-1 span:nth-child(4) { filter: blur(75px); }
        .circle-2 {
            z-index: 4; position: absolute; top: 30px; left: 30px; width: calc(100% - 60px); height: calc(100% - 60px); 
            border-radius: 50%; border: 10px solid var(--electric-cyan); box-shadow: 0 0 30px 30px rgba(var(--electric-cyan-rgb), 0.2);
            animation: rotate-left 4s linear infinite; transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
        }
        .circle-2 span { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: calc(100% + 20px); height: 10px; background-color: var(--bg-color); transition: background-color var(--transition-speed) ease; }
        .circle-2 span:nth-child(1) { transform: translate(-50%, -50%) rotate(90deg); } .circle-2 span:nth-child(2) { transform: translate(-50%, -50%) rotate(45deg); } .circle-2 span:nth-child(3) { transform: translate(-50%, -50%) rotate(-45deg); }
        .circle-2 span:nth-child(4) { transform: translate(-50%, -50%) rotate(30deg); } .circle-2 span:nth-child(5) { transform: translate(-50%, -50%) rotate(-30deg); } .circle-2 span:nth-child(6) { transform: translate(-50%, -50%) rotate(0deg); }
        .circle-2 span:nth-child(7) { transform: translate(-50%, -50%) rotate(55deg); height: 5px; } .circle-2 span:nth-child(8) { transform: translate(-50%, -50%) rotate(125deg); height: 5px; }
        .circle-3 { z-index: 7; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: 50%; box-shadow: 0 0 10px 10px rgba(var(--electric-cyan-rgb), 0.2); transition: box-shadow var(--transition-speed) ease; }
        .circle-3::after { content: ''; display: block; width: 115px; height: 115px; border-radius: 50%; border: 3px dotted rgba(var(--electric-cyan-rgb), 0.8); animation: rotate-right 10s linear infinite; transition: border-color var(--transition-speed) ease; }
        .circle-4 { z-index: 8; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100px; height: 100px; border-radius: 50%; box-shadow: 0 0 10px 10px rgba(var(--electric-cyan-rgb), 0.1); animation: rotate-left-right 20s infinite ease-in; transition: box-shadow var(--transition-speed) ease; }
        .circle-4 span { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; height: 100%; border-radius: 50%; border: 3px solid; border-color: var(--electric-cyan) transparent transparent; transition: border-color var(--transition-speed) ease; }
        .circle-4 span:nth-child(1) { transform: translate(-50%, -50%) rotate(45deg); } .circle-4 span:nth-child(2) { transform: translate(-50%, -50%) rotate(-75deg); } .circle-4 span:nth-child(3) { transform: translate(-50%, -50%) rotate(165deg); }
        .circle-5 { z-index: 9; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 64px; height: 64px; border-radius: 50%; animation: rotate-left-right 10s infinite ease-in; background-color: rgba(var(--electric-cyan-rgb), 0.2); box-shadow: 0 0 20px 20px rgba(var(--electric-cyan-rgb), 0.2); transition: background-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease, opacity 0.3s ease; }
        .circle-5 span { position: absolute; inset: 0; z-index: 10; width: 54px; height: 54px; border-radius: 50%; border: 5px solid; border-color: var(--electric-cyan) transparent transparent; margin: auto; transition: border-color var(--transition-speed) ease; }
        .circle-5 span:nth-child(1) { transform: rotate(0deg); } .circle-5 span:nth-child(2) { transform: rotate(120deg); } .circle-5 span:nth-child(3) { transform: rotate(240deg); }
        .circle-6 { z-index: 11; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .circle-6::after { content: ''; display: block; width: 40px; height: 40px; border-radius: 50%; border: 3px dashed var(--electric-cyan); animation: rotate-left 5s infinite ease-in; transition: border-color var(--transition-speed) ease; }
        .circle-7 { z-index: 12; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .circle-7::after { content: ''; display: block; width: 27px; height: 27px; border-radius: 50%; background-color: var(--electric-cyan); animation: rotate-left 5s infinite ease-in; box-shadow: 0 0 5px 5px rgba(var(--electric-cyan-rgb), 0.2); transition: box-shadow var(--transition-speed) ease, transform 0.3s ease, background-color var(--transition-speed) ease; }
        .circle-8 { z-index: 13; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 15px; height: 15px; border-radius: 50%; animation: rotate-left-right 5s infinite ease-in; }
        .circle-8 span { position: absolute; inset: 0; z-index: 14; width: 13px; height: 13px; border-radius: 50%; border: 1px solid; border-color: var(--bg-color) transparent transparent; margin: auto; transition: border-color var(--transition-speed) ease; }
        .circle-8 span:nth-child(1) { transform: rotate(120deg); } .circle-8 span:nth-child(2) { transform: rotate(240deg); }
        @keyframes pulsePausedGlow { 0%, 100% { box-shadow: 0 0 5px 5px rgba(var(--paused-color-rgb), 0.2); transform: scale(1); } 50% { box-shadow: 0 0 10px 10px rgba(var(--paused-color-rgb), 0.4); transform: scale(1.1); } }
        @keyframes pulsePausedRing { 0%, 100% { box-shadow: 0 0 20px 20px rgba(var(--paused-color-rgb), 0.2); opacity: 1; } 50% { box-shadow: 0 0 25px 25px rgba(var(--paused-color-rgb), 0.3); opacity: 0.8; } }
        .state-paused .circle-7::after { background-color: var(--paused-color-val); animation: pulsePausedGlow 1.5s infinite ease-in-out; }
        .state-paused .circle-5 { animation: pulsePausedRing 1.5s infinite ease-in-out; background-color: rgba(var(--paused-color-rgb), 0.3); }
        .state-paused .circle-1, .state-paused .circle-1 span { background: linear-gradient(rgba(var(--paused-color-rgb), 0.8), rgba(var(--paused-color-rgb),0.5));}
        .state-paused .circle-2 { border-color: var(--paused-color-val); box-shadow: 0 0 30px 30px rgba(var(--paused-color-rgb), 0.2); }
        .state-paused .circle-3::after { border-color: rgba(var(--paused-color-rgb), 0.8); }
        .state-paused .circle-4 span { border-color: var(--paused-color-val) transparent transparent; } .state-paused .circle-5 span { border-color: var(--paused-color-val) transparent transparent; }
        .state-paused .circle-6::after { border-color: var(--paused-color-val); } .state-paused .triangle { background-color: var(--paused-color-val); }
        .state-paused .timer-progress-circle { stroke: var(--paused-color-val); }
        @keyframes rotateSpinOnce { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }
        .state-preparing .triangle { animation: rotateSpinOnce 5s linear infinite; background-color: var(--preparing-color-val); }
        .state-preparing .circle-1, .state-preparing .circle-1 span { background: linear-gradient(rgba(var(--preparing-color-rgb), 0.8), rgba(var(--preparing-color-rgb),0.5));}
        .state-preparing .circle-2 { border-color: var(--preparing-color-val); box-shadow: 0 0 30px 30px rgba(var(--preparing-color-rgb), 0.2); }
        .state-preparing .circle-3::after { border-color: rgba(var(--preparing-color-rgb), 0.8); }
        .state-preparing .circle-4 span { border-color: var(--preparing-color-val) transparent transparent; }
        .state-preparing .circle-5 { background-color: rgba(var(--preparing-color-rgb),0.2); box-shadow: 0 0 20px 20px rgba(var(--preparing-color-rgb),0.2);}
        .state-preparing .circle-5 span { border-color: var(--preparing-color-val) transparent transparent; }
        .state-preparing .circle-6::after { border-color: var(--preparing-color-val); }
        .state-preparing .circle-7::after { background-color: var(--preparing-color-val); box-shadow: 0 0 5px 5px rgba(var(--preparing-color-rgb),0.2); }
        .state-preparing .timer-progress-circle { stroke: var(--preparing-color-val); }
        .triangle.spin-transition { animation: rotateSpinOnce 0.6s ease-out forwards; }
        #time-left {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 20; 
            font-family: var(--font-family-timer); font-size: 3.6em; font-weight: 700;
            color: var(--timer-text-color-main); text-shadow: var(--timer-text-glow-main); 
            transition: font-size 0.2s ease; pointer-events: none; white-space: nowrap; 
        }
        #timer-state { display: none !important; } 

        @keyframes countdown-pulse { 0%, 100% { opacity: 0.7; transform: scale(1) translateX(-50%); } 50% { opacity: 1; transform: scale(1.05) translateX(-50%); } }
        .state-exercise #time-left { font-size: 4em; letter-spacing: 0.05em; }
        .state-exercise .triangle { background-color: var(--exercise-color-val); }
        .state-exercise .circle-1, .state-exercise .circle-1 span { background: linear-gradient(rgba(var(--exercise-color-rgb), 0.8), rgba(var(--exercise-color-rgb),0.5));}
        .state-exercise .circle-2 { border-color: var(--exercise-color-val); box-shadow: 0 0 30px 30px rgba(var(--exercise-color-rgb), 0.2); }
        .state-exercise .circle-3::after { border-color: rgba(var(--exercise-color-rgb), 0.8); }
        .state-exercise .circle-4 span { border-color: var(--exercise-color-val) transparent transparent; }
        .state-exercise .circle-5 { background-color: rgba(var(--exercise-color-rgb),0.2); box-shadow: 0 0 20px 20px rgba(var(--exercise-color-rgb),0.2);}
        .state-exercise .circle-5 span { border-color: var(--exercise-color-val) transparent transparent; }
        .state-exercise .circle-6::after { border-color: var(--exercise-color-val); }
        .state-exercise .circle-7::after { background-color: var(--exercise-color-val); box-shadow: 0 0 5px 5px rgba(var(--exercise-color-rgb),0.2); }
        .state-exercise .timer-progress-circle { stroke: var(--exercise-color-val); } 
        .state-break .triangle { background-color: var(--break-color-val); }
        .state-break .circle-1, .state-break .circle-1 span { background: linear-gradient(rgba(var(--break-color-rgb), 0.8), rgba(var(--break-color-rgb),0.5));}
        .state-break .circle-2 { border-color: var(--break-color-val); box-shadow: 0 0 30px 30px rgba(var(--break-color-rgb), 0.2); }
        .state-break .circle-3::after { border-color: rgba(var(--break-color-rgb), 0.8); }
        .state-break .circle-4 span { border-color: var(--break-color-val) transparent transparent; }
        .state-break .circle-5 { background-color: rgba(var(--break-color-rgb),0.2); box-shadow: 0 0 20px 20px rgba(var(--break-color-rgb),0.2);}
        .state-break .circle-5 span { border-color: var(--break-color-val) transparent transparent; }
        .state-break .circle-6::after { border-color: var(--break-color-val); }
        .state-break .circle-7::after { background-color: var(--break-color-val); box-shadow: 0 0 5px 5px rgba(var(--break-color-rgb),0.2); }
        .state-break .timer-progress-circle { stroke: var(--break-color-val); }
        .state-finished .triangle { background-color: var(--finished-color-val); }
        .state-finished .circle-1, .state-finished .circle-1 span { background: linear-gradient(rgba(var(--finished-color-rgb), 0.8), rgba(var(--finished-color-rgb),0.5));}
        .state-finished .circle-2 { border-color: var(--finished-color-val); box-shadow: 0 0 30px 30px rgba(var(--finished-color-rgb), 0.2); }
        .state-finished .circle-3::after { border-color: rgba(var(--finished-color-rgb), 0.8); }
        .state-finished .circle-4 span { border-color: var(--finished-color-val) transparent transparent; }
        .state-finished .circle-5 { background-color: rgba(var(--finished-color-rgb),0.2); box-shadow: 0 0 20px 20px rgba(var(--finished-color-rgb),0.2);}
        .state-finished .circle-5 span { border-color: var(--finished-color-val) transparent transparent; }
        .state-finished .circle-6::after { border-color: var(--finished-color-val); }
        .state-finished .circle-7::after { background-color: var(--finished-color-val); box-shadow: 0 0 5px 5px rgba(var(--finished-color-rgb),0.2); }
        .state-finished .timer-progress-circle { stroke: var(--finished-color-val); }
        .workout-info { margin-bottom: 20px; min-height: auto; position: relative; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        #current-exercise-name-display { display: block; font-size: 1.3em; font-weight: 600; color: var(--primary-text-color); margin-bottom: 8px; padding: 0 10px; line-height: 1.3; text-shadow: none; }
        body.state-exercise #current-exercise-name-display, body.state-break #current-exercise-name-display { animation: textGlowPulseState 2s infinite ease-in-out; }
        body.state-exercise #current-exercise-name-display { color: var(--color-exercise); } body.state-break #current-exercise-name-display { color: var(--color-break); }
        
        #current-exercise-container { display: flex; flex-direction: column; align-items: center; gap: 10px; font-size: 1em; color: var(--secondary-text-color); min-height: auto; width: 100%; }
        .workout-prompt { display: inline-flex; align-items: center; gap: 10px; border: 1px dashed rgba(var(--electric-blue-rgb), 0.3); padding: 12px 22px; border-radius: var(--border-radius-md); color: var(--secondary-text-color-dark); font-size: 0.95em; margin-top: 0; cursor: default; background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.2); box-shadow: inset 0 0 8px rgba(var(--electric-blue-rgb),0.1); }
        .workout-prompt i { color: var(--electric-blue); font-size: 1.1em; }
        
        .exercise-details, .break-info {
            display: flex; flex-direction: column; flex-wrap: nowrap; justify-content: center; align-items: center; gap: 8px; 
            background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.5); padding: 12px 15px; border-radius: var(--border-radius-sm);
            border: 1px solid rgba(var(--accent-border-color), 0.5); width: fit-content; max-width: 95%; 
            box-shadow: 0 2px 5px rgba(var(--bg-color-dark-rgb),0.2);
        }
        .exercise-details .main-stats { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px 20px; font-size: 1.1em; font-weight: 500; color: var(--primary-text-color); margin-bottom: 5px;}
        .exercise-details .main-stats span { display: flex; align-items: center; gap: 8px; }
        .exercise-details .main-stats i { color: var(--color-exercise); opacity: 0.9; }
        .sets-info-text, .details-text { font-size: 0.8em; color: var(--secondary-text-color); opacity: 0.85; text-align: center; width: 100%; letter-spacing: 0.02em; padding: 0 5px; line-height: 1.4; }
        .sets-info-text i { color: var(--electric-cyan); margin-right: 5px; } 
        .details-text i { color: var(--electric-yellow); margin-right: 5px; } 
        
        .break-info { font-size: 1em; }
        .break-info > i { font-size: 1.2em; margin-bottom: 3px;} 
        .break-info > span { font-weight: 500; color: var(--primary-text-color); } 
        
        .next-exercise-preview {
            font-size: 0.85em; color: var(--secondary-text-color); margin-top: 10px; padding: 8px 12px;
            border: 1px dashed rgba(var(--accent-border-color), 0.4); border-radius: var(--border-radius-sm);
            background-color: rgba(var(--bg-color-dark-rgb), 0.2);
            display: flex; flex-direction: column; align-items: center; gap: 4px; text-align: center;
        }
        .next-exercise-preview i { color: var(--color-exercise); opacity: 0.8; margin-bottom: 2px; }
        .next-exercise-preview strong { color: var(--primary-text-color); font-weight: 500; display: block; }
        .next-exercise-preview .next-details { font-size: 0.9em; }
        
        .controls { display: flex; justify-content: center; gap: 8px; margin-top: 20px; flex-wrap: wrap; }
        .controls button {
            background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.4); border: 1px solid var(--border-color); color: var(--secondary-text-color);
            padding: 8px 14px; border-radius: var(--border-radius-md); font-size: 0.9em; font-weight: 500; cursor: pointer;
            transition: all var(--transition-speed) ease; display: inline-flex; align-items: center; justify-content: center;
            gap: 6px; min-width: 100px; box-shadow: 0 2px 5px rgba(var(--bg-color-dark-rgb),0.3);
        }
        .controls button:disabled {
            opacity: 0.5; cursor: not-allowed; background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.2); border-color: var(--border-color-dark);
            color: var(--secondary-text-color-dark); box-shadow: none !important; transform: none !important; text-shadow: none !important; pointer-events: auto; 
        }
        .controls button:not(:disabled):hover {
            border-color: var(--electric-blue); color: var(--electric-blue); background-color: rgba(var(--electric-blue-rgb), 0.15);
            box-shadow: 0 0 10px rgba(var(--electric-blue-rgb), 0.3), inset 0 0 5px rgba(var(--electric-blue-rgb),0.1); transform: translateY(-1px);
        }
        .controls button i { font-size: 1em; margin-right: 4px; opacity: 0.8; transition: opacity var(--transition-speed) ease; }
        .controls button:not(:disabled):hover i { opacity: 1; }
        #start-pause-btn:not(:disabled) { animation: electricBorder 3s infinite linear; border-color: var(--electric-cyan); }
        #start-pause-btn:not(:disabled):hover { animation-play-state: paused; }
        .progress-tracker {
            font-size: 0.85em; color: var(--secondary-text-color-dark); margin-top: 15px; opacity: 0.7; font-weight: 500;
            display: flex; flex-direction: column; align-items: center; gap: 8px; min-height: 1.2em; 
        }
        #estimated-end-time-container {
            display: none; 
            font-weight: 500; letter-spacing: 0.05em; 
        }
        #drive-connection-status-main { display: inline-flex; align-items: center; gap: 6px; color: var(--neon-green); font-weight: 500; transition: color 0.3s ease; }
        #drive-connection-status-main i.fa-google-drive { display: inline-block; font-size: 1.1em; }
        #drive-connection-status-main.error { color: var(--neon-red); } #drive-connection-status-main.loading { color: var(--neon-yellow); }
        #progress-text-area { font-weight: 500; letter-spacing: 0.05em; }
        .rep-adjustment-overlay { display: none !important; }
        .history-section h2 { color: var(--primary-text-color); margin-bottom: 25px; text-align: center; font-family: var(--font-family-titles); text-shadow: 0 0 6px rgba(var(--electric-cyan-rgb), 0.6); }
        .chart-container, .stats-display, .history-list { border-color: var(--border-color-dark); background-color: transparent; }
        .history-filters button.active { border-color: var(--electric-cyan); color: var(--electric-cyan); background-color: rgba(var(--electric-cyan-rgb), 0.1); box-shadow: 0 0 8px rgba(var(--electric-cyan-rgb),0.4); text-shadow: 0 0 5px var(--electric-cyan); }
        .stats-display .motivational-message { background: linear-gradient(90deg, var(--neon-green), var(--electric-cyan)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; color: transparent; font-weight: 500; }
        .history-list li:nth-child(even) { background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.2); }
        .history-list li:hover { background-color: rgba(var(--electric-cyan-rgb), 0.05); }
        .history-item-type { color: var(--neon-pink); background-color: rgba(var(--neon-pink-rgb), 0.1); }
        .history-item-reps { color: var(--neon-purple); } .history-item-duration { color: var(--electric-blue); }
        .history-controls { padding-bottom: 20px; margin-bottom: 25px; border-bottom: 1px solid var(--border-color-dark); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .history-filters { display: flex; gap: 10px; flex-wrap: wrap; }
        .history-actions { display: flex; gap: 15px; align-items: center; color: var(--secondary-text-color-dark); }
        #history-drive-status { font-size: 0.8em; padding: 3px 6px; background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.5); border-radius: var(--border-radius-sm); border: 1px solid var(--border-color-dark); transition: color 0.3s ease, border-color 0.3s ease; }
        #history-drive-status.syncing { color: var(--neon-yellow); border-color: var(--neon-yellow); }
        #history-drive-status.error { color: var(--neon-red); border-color: var(--neon-red); }
        #history-drive-status.success { color: var(--neon-green); border-color: var(--neon-green); }
        .chart-container { position: relative; width: 100%; height: 300px; margin-bottom: 25px; background-color: rgba(var(--bg-color-dark-rgb), 0.3); border: 1px solid var(--border-color-dark); border-radius: var(--border-radius-md); padding: 15px; }
        .chart-placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--secondary-text-color-dark); font-style: italic; text-align: center; padding: 0 10px; transition: opacity 0.3s ease; }
        #history-chart-canvas { display: block; width: 100% !important; height: 100% !important; transition: opacity 0.3s ease; }
        .stats-display { margin-bottom: 25px; padding: 20px; background-color: rgba(var(--bg-color-dark-rgb), 0.3); border: 1px solid var(--border-color-dark); border-radius: var(--border-radius-md); }
        .stats-display h3 { color: var(--primary-text-color); font-size: 1.15em; margin-bottom: 15px; }
        .stats-display .content-wrapper p { margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .stats-display .content-wrapper p i { width: 16px; text-align: center; color: var(--electric-cyan); opacity: 0.8; }
        .stats-display .content-wrapper p strong { color: var(--primary-text-color); font-weight: 500; }
        .history-list { list-style: none; border: 1px solid var(--border-color-dark); border-radius: var(--border-radius-md); background-color: transparent; box-shadow: none; max-height: 400px; overflow-y: auto; transition: border-color var(--transition-speed) ease; }
        .history-list li { display: grid; grid-template-columns: auto 1fr auto auto; align-items: center; padding: 12px 15px; border-bottom: 1px solid var(--border-color-dark); transition: background-color 0.2s ease, border-color var(--transition-speed) ease; gap: 10px 15px; }
        .history-list li:last-child { border-bottom: none; } .history-list li:nth-child(even) { background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.2); }
        .history-list li:hover { background-color: rgba(var(--electric-cyan-rgb), 0.05); }
        .history-item-date { color: var(--primary-text-color); font-size: 0.9em; grid-column: 1 / 2; }
        .history-item-date small { color: var(--secondary-text-color); font-size: 0.9em;}
        .history-item-type { color: var(--neon-pink); background-color: rgba(var(--neon-pink-rgb), 0.1); border-radius: var(--border-radius-sm); padding: 3px 8px; font-size: 0.85em; font-weight: 500; text-align: center; grid-column: 2 / 3; justify-self: start; }
        .history-item-reps { color: var(--neon-purple); font-weight: 500; font-size: 0.9em; grid-column: 3 / 4; justify-self: end; }
        .history-item-reps i { margin-right: 4px; }
        .history-item-duration { color: var(--electric-blue); font-weight: 500; font-variant-numeric: tabular-nums; grid-column: 4 / 5; justify-self: end; }
        .history-list .no-history { grid-column: 1 / -1; color: var(--secondary-text-color); text-align: center; padding: 30px 15px; font-style: italic; border: none; background: none !important; }
        
        .post-workout-summary {
            position: fixed; inset: 0; background-color: rgba(var(--bg-color-dark-rgb), 0.9); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; 
            opacity: 0; visibility: hidden; pointer-events: none; transition: opacity 0.3s ease, visibility 0s linear 0.3s;
        }
        .post-workout-summary.visible { opacity: 1; visibility: visible; pointer-events: auto; transition: opacity 0.3s ease, visibility 0s linear 0s; }
        .post-workout-summary-content {
            background-color: var(--secondary-bg-color); border: 1px solid var(--border-color); border-radius: var(--border-radius-lg);
            box-shadow: 0 10px 30px rgba(0,0,0,0.4), 0 0 20px rgba(var(--electric-cyan-rgb), 0.1); 
            width: 100%; max-width: 600px; 
            max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; 
            transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), background-color var(--transition-speed) ease, border-color var(--transition-speed) ease;
        }
        .post-workout-summary.visible .post-workout-summary-content { transform: scale(1); }
        .post-workout-summary h2 {
            color: var(--electric-cyan); font-size: 1.5em; font-weight: 700; padding: 20px 25px; border-bottom: 1px solid var(--border-color);
            flex-shrink: 0; text-align: center; background-color: rgba(var(--bg-color-dark-rgb), 0.2); 
            transition: color var(--transition-speed) ease, border-color var(--transition-speed) ease, background-color var(--transition-speed) ease;
            text-shadow: 0 0 5px var(--electric-cyan);
        }
        .summary-items-list { list-style: none; padding: 15px 25px; overflow-y: auto; flex-grow: 1; background: var(--bg-color); border-bottom: 1px solid var(--border-color); transition: background-color var(--transition-speed) ease, border-color var(--transition-speed) ease; }
        .summary-item { 
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 12px; 
            align-items: start; 
            padding: 15px 0; 
            border-bottom: 1px solid var(--border-color); 
        }
        .summary-item:last-child { border-bottom: none; }
        .summary-item .exercise-name { 
            grid-column: 1 / -1; 
            color: var(--primary-text-color); font-weight: 500; font-size: 1.05em; text-align: left; 
            white-space: normal; 
            margin-bottom: 5px; 
        }
        .summary-item .exercise-name i { color: var(--color-exercise); margin-right: 8px; opacity: 0.9; }
        
        .summary-item .fields-grid { 
            grid-column: 1 / -1; 
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
            gap: 10px 15px;
            align-items: end; 
        }

        .summary-item .input-group { display: flex; flex-direction: column; gap: 4px; }
        .summary-item label { 
            font-size: 0.8em; color: var(--secondary-text-color); margin-bottom: 2px;
            display: block; text-align: left;
        }
        .summary-item input[type="number"], .summary-item input[type="text"], .summary-item textarea {
            background-color: var(--input-bg); border: 1px solid var(--border-color); color: var(--primary-text-color);
            border-radius: var(--border-radius-sm); padding: 8px 10px; font-size: 0.95em; width: 100%;
            transition: border-color var(--transition-speed) ease, background-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease, color var(--transition-speed) ease;
        }
        .summary-item input[type="number"] { text-align: center; -moz-appearance: textfield; }
        .summary-item input[type="number"]::-webkit-outer-spin-button, .summary-item input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .summary-item textarea { min-height: 60px; resize: vertical; font-family: inherit;}

        .summary-item input:focus, .summary-item textarea:focus { 
            border-color: var(--electric-cyan); background-color: var(--secondary-bg-color); outline: none; 
            box-shadow: 0 0 0 3px rgba(var(--electric-cyan-rgb), 0.3); 
        }
        .summary-item .input-group.notes-group { grid-column: 1 / -1; } 

        .summary-controls {
            padding: 20px 25px; display: flex; justify-content: center; gap: 15px; flex-shrink: 0; flex-wrap: wrap; 
            border-top: 1px solid var(--border-color); background-color: rgba(var(--bg-color-dark-rgb), 0.2); 
            transition: border-color var(--transition-speed) ease, background-color var(--transition-speed) ease;
        }
        .summary-controls button {
            border: none; color: #fff; min-width: 160px; padding: 10px 22px; border-radius: var(--border-radius-md);
            font-size: 1em; font-weight: 500; cursor: pointer; transition: all var(--transition-speed) ease;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); text-transform: uppercase; letter-spacing: 0.05em;
        }
        .summary-controls button:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; background-color: var(--secondary-text-color) !important; filter: grayscale(50%); }
        #finish-summary-btn { background-color: var(--neon-green); --button-finish-glow: var(--glow-green); }
        #finish-summary-btn:not(:disabled):hover { filter: brightness(1.15); box-shadow: 0 4px 10px rgba(0,0,0,0.3), 0 0 10px var(--button-finish-glow); transform: translateY(-1px); text-shadow: 0 0 5px rgba(255,255,255,0.5); }
        #finish-summary-btn:not(:disabled):active { filter: brightness(0.95); transform: translateY(0); box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        
        .message-area {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.9);
            color: var(--primary-text-color); border: 1px solid var(--border-color); padding: 12px 25px; border-radius: var(--border-radius-md);
            z-index: 3000; opacity: 0; transition: all 0.5s ease; pointer-events: none; font-size: 0.95em;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3), 0 0 10px rgba(var(--electric-cyan-rgb), 0.1); 
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); max-width: 90%; text-align: center; 
        }
        .message-area.visible { opacity: 1; transform: translate(-50%, 0); bottom: 40px; pointer-events: auto; }
        .message-area.error-message { background-color: rgba(var(--neon-red-rgb), 0.8); color: #fff; border-color: var(--neon-red); text-shadow: 0 0 5px rgba(0,0,0,0.5); box-shadow: 0 4px 15px rgba(0,0,0,0.3), 0 0 10px var(--glow-red); }
        footer {
            padding: 25px; text-align: center; font-size: 0.9em; color: var(--secondary-text-color);
            border-top: 1px solid rgba(var(--electric-blue-rgb), 0.2); margin-top: 50px; 
            background-color: rgba(var(--bg-color-dark-rgb), 0.7); backdrop-filter: blur(3px); 
        }
        footer p { margin-bottom: 8px; }
        footer a { color: var(--electric-cyan); text-decoration: none; transition: color var(--transition-speed) ease, text-shadow var(--transition-speed) ease; }
        footer a:hover { color: var(--primary-text-color); text-decoration: underline; text-shadow: 0 0 8px var(--electric-cyan); }
        footer .fab.fa-google-drive { color: var(--neon-green); } footer .fab.fa-github { color: var(--neon-purple); }
        @media (min-width: 769px) { 
            .timer-and-image-wrapper { flex-direction: row; justify-content: center; align-items: center; gap: 30px; }
            .exercise-image-area { max-width: 220px; margin: 0; } 
            #exercise-image-display { max-height: 180px; }
            .timer-display { margin: 0; width: 300px; height: 300px;} 
            .reactor { width: 190px; height: 190px; } 
            .timer-progress-circle-container { width: 250px; height: 250px; }
            #current-exercise-name-display { font-size: 1.5em; } 
            .exercise-details .main-stats { font-size: 1.2em; }
            .sets-info-text, .details-text { font-size: 0.85em; }
            .break-info { font-size: 1.1em; }
            .next-exercise-preview { font-size: 0.9em; }
        }
        @media (max-width: 768px) { 
            .timer-display { width: 260px; height: 260px; } 
            .reactor { width: 170px; height: 170px; } 
            .timer-progress-circle-container { width: 220px; height: 220px; }
            #time-left { font-size: 3.0em; } 
            .triangle { width: 125px; } .triangle::after { width: 95px; height: 95px; }
            .circle-2 { border-width: 7px; box-shadow: 0 0 20px 20px rgba(var(--electric-cyan-rgb), 0.2); } 
            .circle-3::after { width: 90px; height: 90px; }
            .circle-5 { width: 50px; height: 50px; } .circle-5 span { width: 40px; height: 40px; }
            .controls button { font-size: 0.85em; padding: 8px 10px; min-width: 90px; } 
            header h1 { font-size: 1.3em; }
            nav ul { gap: 12px; } nav button, nav a.nav-link { font-size: 0.85em; padding: 6px 10px;}
            .history-list li { font-size: 0.9em; grid-template-columns: auto 1fr auto; gap: 5px 10px; }
            .history-item-reps { grid-column: 3 / 4; justify-self: start; } 
            .history-item-duration { grid-column: 1 / -1; grid-row: 2 / 3; justify-self: end; }
            .exercise-image-area { max-width: 200px; margin-bottom: 15px; } 
            #exercise-image-display { max-height: 160px; }
            .summary-item .fields-grid { grid-template-columns: 1fr; } 
        }
        @media (max-width: 480px) { 
            .timer-and-image-wrapper { gap: 10px; margin-bottom:15px; } 
            .timer-display { width: 220px; height: 220px; }
            .reactor { width: 140px; height: 140px; } 
            .timer-progress-circle-container { width: 190px; height: 190px; }
            #time-left { font-size: 2.5em; } 
            .triangle { width: 100px; } .triangle::after { width: 75px; height: 75px; }
            .circle-1::before { inset: 6px; } 
            .circle-2 { top: 20px; left: 20px; width: calc(100% - 40px); height: calc(100% - 40px); border-width: 5px; }
            .circle-3::after { width: 70px; height: 70px; } 
            .circle-5 { width: 40px; height: 40px; } .circle-5 span { width: 32px; height: 32px; border-width: 4px;}
            .circle-7::after { width: 18px; height: 18px;}
            #current-exercise-name-display { font-size: 1.1em; } 
            .exercise-details .main-stats { font-size: 1em; gap: 8px 15px; }
            .sets-info-text, .details-text { font-size: 0.75em; }
            .break-info { font-size: 0.9em; }
            .next-exercise-preview { font-size: 0.8em; }
            .controls button { flex-basis: calc(50% - 6px); padding: 8px; font-size: 0.8em; min-width: 80px; }
            .header-content { justify-content: center; text-align: center; } nav ul { justify-content: center; } 
            .header-actions { justify-content: center; width: 100%; margin-top: 10px; }
            .exercise-image-area { max-width: 160px; } 
            #exercise-image-display { max-height: 120px; }
            .post-workout-summary-content { max-width: 95%; } 
        }
    </style>
</head>
<body class="logged-out dark-theme state-idle"> 

    <header>
        <div class="header-content">
            <h1><i class="fas fa-bolt"></i> ArmorWorkout</h1>
            <nav>
                <ul>
                    <li><button id="nav-push" data-session-name="PUSH V4 - Pectoraux, Épaules, Triceps" disabled>Push</button></li>
                    <li><button id="nav-pull" data-session-name="PULL V5.2 - Dos, Arrière Épaules, Biceps" disabled>Pull</button></li>
                    <li><button id="nav-legs" data-session-name="LEGS & ABDOS V1.7 - Jambes & Sangle Abdominale" disabled>Legs</button></li>
                    <li><button id="nav-history"><i class="fas fa-history"></i> Historique</button></li>
                    <li><a href="https://ironworkout.github.io/armorworkout/prog" target="_blank" class="nav-link"><i class="fas fa-tasks"></i> Prog V1</a></li>
                    <li><a href="https://ironworkout.github.io/armorworkout/muscle-evolution.html" target="_blank" class="nav-link"><i class="fas fa-chart-pie"></i> Évolution</a></li>
                </ul>
            </nav>
            <div class="header-actions">
                <div id="drive-status" style="display: none;"> 
                    <span id="drive-status-text">Connecté</span>
                </div>
                <button id="signin-button" disabled><i class="fab fa-google"></i> Connecter Drive</button>
            </div>
        </div>
    </header>

    <div class="container">
        <main>
            <div class="workout-section app-section" id="workout-section">
                <div class="timer-and-image-wrapper">
                    <div id="exercise-image-container" class="exercise-image-area">
                        <img id="exercise-image-display" src="" alt="">
                    </div>

                    <div class="timer-display" id="timer-display-clickable" aria-label="Affichage du timer Arc Reactor">
                        <div class="timer-progress-circle-container">
                            <svg viewBox="0 0 100 100">
                                <circle class="timer-progress-circle-bg" cx="50" cy="50" r="45"></circle>
                                <circle id="timer-progress-indicator" class="timer-progress-circle" cx="50" cy="50" r="45"
                                        stroke-dasharray="282.74" stroke-dashoffset="282.74"> 
                                </circle>
                            </svg>
                        </div>
                        <div class="timer-step-info-display" id="workout-step-info-display">
                            <span id="workout-step-current-display" title="Étape actuelle">--</span>
                            <span id="workout-step-total-display" title="Nombre total d'étapes">--</span>
                        </div>

                        <div class="reactor">
                            <div class="triangle"></div>
                            <div class="circle-1"><span></span><span></span><span></span><span></span></div>
                            <div class="circle-2"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></div>
                            <div class="circle-3"></div>
                            <div class="circle-4"><span></span><span></span><span></span></div>
                            <div class="circle-5"><span></span><span></span><span></span></div>
                            <div class="circle-6"></div>
                            <div class="circle-7"></div>
                            <div class="circle-8"><span></span><span></span><span></span></div>

                            <div id="time-left" aria-live="polite">00:00</div>
                        </div>
                    </div>
                </div>

                <div class="workout-info" id="workout-info">
                    <div id="current-exercise-name-display">ArmorWorkout</div>
                    <div id="current-exercise-container" aria-live="polite">
                        <div class="workout-prompt">
                            <i class="fas fa-sign-in-alt"></i>
                            <span>Connectez-vous pour charger le programme depuis votre Google Drive.</span>
                        </div>
                    </div>
                </div>

                 <div class="progress-tracker" id="progress-tracker">
                    <div id="estimated-end-time-container">
                        <i class="fas fa-flag-checkered"></i> Fin estimée: <span id="estimated-end-time">--:--</span>
                    </div>
                    <div id="drive-connection-status-main" style="display: none;"> 
                        <i class="fab fa-google-drive"></i>
                        <span id="drive-connection-text">Connecté</span>
                    </div>
                </div>

                <div class="controls">
                    <button id="prev-btn" disabled><i class="fas fa-backward-step"></i> Précédent</button>
                    <button id="start-pause-btn" disabled><i class="fas fa-play"></i> Démarrer</button>
                    <button id="skip-btn" disabled><i class="fas fa-forward-step"></i> Suivant</button>
                    <button id="finish-btn" disabled><i class="fas fa-flag-checkered"></i> Finir</button>
                    <button id="reset-btn" disabled><i class="fas fa-redo"></i> Reset</button>
                </div>

            </div>

            <div class="history-section app-section section-hidden" id="history-section">
                <h2><i class="fas fa-history"></i> Historique & Statistiques</h2>
                <div class="history-controls">
                    <div class="history-filters" role="group" aria-label="Filtres période historique">
                        <button data-period="week" class="active"><i class="fas fa-calendar-week"></i> Semaine</button>
                        <button data-period="month"><i class="fas fa-calendar-alt"></i> Mois</button>
                        <button data-period="year"><i class="fas fa-calendar-check"></i> Année</button>
                        <button data-period="all"><i class="fas fa-infinity"></i> Tout</button>
                    </div>
                    <div class="history-actions" style="display: none;"> 
                        <span id="history-drive-status">Synchro Drive</span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="history-chart-canvas" role="img" aria-label="Graphique de la durée d'entraînement"></canvas>
                    <p id="history-chart-placeholder" class="chart-placeholder" style="display: none;"></p> 
                </div>
                <div class="stats-display" id="stats-display">
                    <h3>Statistiques</h3>
                    <div class="content-wrapper" aria-live="polite">
                        <p>Connectez-vous pour voir les statistiques.</p>
                    </div>
                    <p class="motivational-message"></p> 
                </div>
                <ul class="history-list" id="history-list">
                    <li class="no-history">Connectez-vous pour voir l'historique.</li> 
                </ul>
            </div>
        </main>
    </div>

    <footer>
        <p>© <span id="current-year">2024</span> ArmorWorkout. Sauvegarde sur <i class="fab fa-google-drive" aria-hidden="true"></i> Google Drive.</p>
        <p><a href="https://github.com/ironworkout/armorworkout" target="_blank" rel="noopener noreferrer"><i class="fab fa-github" aria-hidden="true"></i> Voir sur GitHub</a></p>
    </footer>

    <div id="message-area" class="message-area" role="status" aria-live="polite"></div>

    <div id="post-workout-summary" class="post-workout-summary" role="dialog" aria-modal="true" aria-labelledby="summary-title">
        <div class="post-workout-summary-content">
            <h2 id="summary-title">Résumé & Objectifs</h2>
            <ul id="summary-items-list" class="summary-items-list"></ul>
            <div class="summary-controls">
                <button id="finish-summary-btn"><i class="fas fa-check"></i> Fin & Sauvegarder</button>
            </div>
        </div>
    </div>

    <script async defer src="https://accounts.google.com/gsi/client"></script>
    <script>
        // --- Ordre des Fonctions Corrigé ---

        // Les fonctions appelées par les event listeners sont définies avant.
        function showMessage(msg, duration = 3000, isError = false) { if (!messageArea) return; messageArea.textContent = msg; messageArea.classList.add('visible'); messageArea.classList.toggle('error-message', isError); if (messageTimeoutId) clearTimeout(messageTimeoutId); messageTimeoutId = setTimeout(() => { messageArea.classList.remove('visible'); }, duration); }
        function handleAuthClick() { initAudioContext(); if (!tokenClient) { showMessage("Services Google non prêts. Veuillez patienter.", 3000); checkAndInitGis(); return; } if (driveStatusElement) { driveStatusElement.classList.remove('error', 'success'); driveStatusElement.classList.add('loading'); driveStatusElement.style.display = 'inline-flex'; } if(driveStatusTextElement) driveStatusTextElement.textContent = 'Connexion...'; tokenClient.requestAccessToken({ prompt: 'consent' }); }
        function handlePreviousClick() { if (currentItemIndex > 0) { currentItemIndex--; updateOverallWorkoutProgressDisplay(); const prevItem = currentWorkoutPlan[currentItemIndex]; setState(prevItem.type === 'break' ? 'break' : 'exercise'); saveInProgressState(); vibrate(); } }
        function handleItemCompletion() { if (currentState === 'finished') return; const currentItem = currentWorkoutPlan[currentItemIndex]; if(currentItem.duration) currentItem.finalDuration = totalTime - timeLeft; else currentItem.finalReps = currentItem.reps; currentItemIndex++; updateOverallWorkoutProgressDisplay(); if (currentItemIndex >= currentWorkoutPlan.length) setState('finished'); else { const nextItem = currentWorkoutPlan[currentItemIndex]; timeLeft = 0; setState(nextItem.type === 'break' ? 'break' : 'exercise'); } saveInProgressState(); }
        function forceFinishWorkout() { if (confirm("Êtes-vous sûr de vouloir terminer l'entraînement ?")) { setState('finished'); } }
        function resetCurrentWorkout() { if (currentWorkoutType) { if (confirm(`Réinitialiser l'entraînement ${currentWorkoutType} ? Toute progression non sauvegardée sera perdue.`)) loadSession(currentWorkoutType); } else { currentItemIndex = 0; currentWorkoutPlan = []; workoutStartTime = null; setState('idle'); setActiveWorkoutNav(null); showMessage("Entraînement réinitialisé.", 2000); } clearInProgressState(); updateOverallWorkoutProgressDisplay(); }
        function loadSession(sessionName) { if (!loadedFullProgram || !loadedFullProgram.sessions) { showMessage(`Programme non chargé. Vérifiez '${FULL_PROGRAM_FILENAME}' sur Drive.`, 5000, true); return; } const session = loadedFullProgram.sessions.find(s => s.nom_session === sessionName); if (!session || !session.exercices_et_pauses) { showMessage(`Session "${sessionName}" non trouvée ou invalide.`, 4000, true); currentWorkoutPlan = []; return; } currentWorkoutType = session.nom_session; currentWorkoutPlan = JSON.parse(JSON.stringify(session.exercices_et_pauses)); currentWorkoutPlan.forEach(item => { if (item.type === 'exercise' || item.type?.startsWith('exercise_')) { item.current_reps = item.reps; item.finalReps = undefined; item.finalDuration = undefined; item.finalWeightDescription = undefined; item.finalProgressionNote = undefined; if (item.type.includes("myo_reps") && item.name.toLowerCase().includes("activation")) { item.current_activation_reps = item.activation_reps_start || item.reps; item.completed_mini_sets = 0; } } }); currentItemIndex = 0; workoutStartTime = null; estimatedTotalWorkoutTime = calculateEstimatedTotalWorkoutTime(currentWorkoutPlan); updateEstimatedEndTime(estimatedTotalWorkoutTime); setState('idle'); setActiveWorkoutNav(sessionName); showMessage(`${session.nom_session || 'Session'} chargée. Prêt à commencer !`, 2500); vibrate(); updateWorkoutInfo(); updateOverallWorkoutProgressDisplay(); clearInProgressState(); }
        async function finishSummary() {
            if (!finishSummaryBtn) return; finishSummaryBtn.disabled = true; finishSummaryBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Sauvegarde...`;
            const latestWorkoutEntry = workoutHistory[workoutHistory.length - 1];
            if (!latestWorkoutEntry || !latestWorkoutEntry.exercises) { closeSummary(); showMessage("Erreur: Données d'historique invalides.", 4000, true); if(finishSummaryBtn) { finishSummaryBtn.disabled = false; finishSummaryBtn.innerHTML = `<i class="fas fa-check"></i> Fin & Sauvegarder`; } return; }
            let planExerciseIndex = 0; 
            for (let i = 0; i < latestWorkoutEntry.exercises.length; i++) { 
                 while(planExerciseIndex < originalCompletedWorkoutPlan.length && !(originalCompletedWorkoutPlan[planExerciseIndex].type === 'exercise' || originalCompletedWorkoutPlan[planExerciseIndex].type?.startsWith('exercise_'))) { planExerciseIndex++; }
                if (planExerciseIndex < originalCompletedWorkoutPlan.length) {
                    const originalExerciseInPlan = originalCompletedWorkoutPlan[planExerciseIndex];
                    const repsInput = document.getElementById(`summary-reps-${planExerciseIndex}`); 
                    const weightInput = document.getElementById(`summary-weight-${planExerciseIndex}`);
                    const progressionNoteInput = document.getElementById(`summary-progression-note-${planExerciseIndex}`);
                    if (repsInput && weightInput && progressionNoteInput) { 
                        const finalValue = parseInt(repsInput.value, 10);
                        if (!isNaN(finalValue)) {
                            if (originalExerciseInPlan.duration !== undefined) { 
                                latestWorkoutEntry.exercises[i].finalDuration = finalValue;
                                if(originalExerciseInPlan.reps_text?.toUpperCase() !== "AMRAP") originalExerciseInPlan.duration = finalValue;
                            } else { 
                                latestWorkoutEntry.exercises[i].finalReps = finalValue;
                                if(originalExerciseInPlan.reps_text?.toUpperCase() !== "AMRAP") originalExerciseInPlan.reps = finalValue; 
                            }
                        }
                        const finalWeightDesc = weightInput.value.trim();
                        latestWorkoutEntry.exercises[i].finalWeightDescription = finalWeightDesc;
                        if (originalExerciseInPlan.unit) originalExerciseInPlan.unit = finalWeightDesc; else originalExerciseInPlan.weight_text = finalWeightDesc;
                        
                        const finalProgNote = progressionNoteInput.value.trim();
                        latestWorkoutEntry.exercises[i].finalProgressionNote = finalProgNote; 
                        originalExerciseInPlan.progression_note = finalProgNote;
                    }
                    planExerciseIndex++;
                }
            }
            if (loadedFullProgram && loadedFullProgram.sessions) {
                const currentSessionInFullProgram = loadedFullProgram.sessions.find(s => s.nom_session === currentWorkoutType);
                if (currentSessionInFullProgram) currentSessionInFullProgram.exercices_et_pauses = JSON.parse(JSON.stringify(originalCompletedWorkoutPlan));
            }
            await saveHistoryToDrive(); 
            if (loadedFullProgram) await saveFullProgramToDrive(); 
            
            closeSummary(false); const previouslyActiveWorkoutType = currentWorkoutType; 
            setState('idle'); if (previouslyActiveWorkoutType && loadedFullProgram) loadSession(previouslyActiveWorkoutType); 
            showMessage("Entraînement et programme mis à jour sauvegardés !", 3500);
            if(finishSummaryBtn) { finishSummaryBtn.disabled = false; finishSummaryBtn.innerHTML = `<i class="fas fa-check"></i> Fin & Sauvegarder`; }
        }
        function closeSummary(updateUIafter = true) { if(postWorkoutSummary) postWorkoutSummary.classList.remove('visible'); if (updateUIafter) setState('idle'); }

        const GOOGLE_CLIENT_ID = "731283926358-viam3ulpgna14flfdeb9m92l8s620hoi.apps.googleusercontent.com";
        const GOOGLE_DRIVE_SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const HISTORY_FILENAME = "armorworkout_history.json";
        const FULL_PROGRAM_FILENAME = "programmeCompletHypertrophieElite_v1.json"; 
        const PREPARE_DURATION = 3; 
        const DEFAULT_EXERCISE_DURATION = 45; 
        const IN_PROGRESS_KEY = 'armorWorkoutStateInProgress';
        const GIS_CHECK_INTERVAL = 100; 
        const GIS_MAX_RETRIES = 50; 
        const TIMER_PROGRESS_CIRCLE_CIRCUMFERENCE = 2 * Math.PI * 45;

        let loadedFullProgram = null; 

        let timeDisplayDiv, currentExerciseContainer, progressTracker, startPauseBtn, skipBtn, finishBtn, resetBtn, prevBtn,
            navButtons, navHistoryBtn, signInButton, driveStatusElement, driveStatusTextElement,
            postWorkoutSummary, summaryTitle, summaryItemsList, finishSummaryBtn, historyDriveStatus,
            currentExerciseNameDisplay, driveConnectionStatusMain, driveConnectionText, timerDisplayElement,
            historyChartCanvasEl, messageArea, workoutSection, historySection, statsDisplay, statsContentWrapper, historyFilterBtns,
            reactorElement, exerciseImageContainer, exerciseImageDisplay,
            timerProgressIndicator, workoutStepTotalDisplay, workoutStepCurrentDisplay, workoutStepInfoDisplay,
            estimatedEndTimeContainer, estimatedEndTimeDisplay;

        let currentWorkoutType = null, currentWorkoutPlan = [], originalCompletedWorkoutPlan = [];
        let currentItemIndex = 0, timerInterval = null, prepareCountdownInterval = null;
        let isTimerRunning = false, isWorkoutActive = false, workoutFinished = false, wasFinishedState = false;
        let currentState = 'idle', previousState = 'idle'; 
        let workoutStartTime = null, workoutHistory = [];
        let currentHistoryPeriod = 'week';
        let historyChartInstance = null;
        let googleAccessToken = null, tokenClient = null;
        let historyFileId = null, programFileId = null; 
        let programsLoaded = false; 
        let isSavingDriveData = false; 
        let currentTheme = 'dark', messageTimeoutId = null; 
        let audioContext = null;
        let gisCheckRetries = 0; 
        let halfwayTimeoutId = null; 

        let soundLaser, sound5, sound4, sound3, sound2, sound1, soundWindows, soundET;
        let triangleSpinTimeoutId = null; 

        function normalizeExerciseName(name) { return name ? name.trim() : ""; }
        function triggerTriangleSpin() { const t = document.querySelector('.reactor .triangle'); if (!t) return; if (triangleSpinTimeoutId) clearTimeout(triangleSpinTimeoutId); t.classList.remove('spin-transition'); void t.offsetWidth; t.classList.add('spin-transition'); triangleSpinTimeoutId = setTimeout(() => { t.classList.remove('spin-transition'); triangleSpinTimeoutId = null; }, 600); }
        function initSounds() { try { const bP = "https://ironworkout.github.io/armorworkout/"; soundLaser = new Audio(bP+'laser.mp3'); sound5=new Audio(bP+'5.mp3'); sound4=new Audio(bP+'4.mp3'); sound3=new Audio(bP+'3.mp3'); sound2=new Audio(bP+'2.mp3'); sound1=new Audio(bP+'1.mp3'); soundWindows=new Audio(bP+'windows.mp3'); soundET=new Audio(bP+'e-t.mp3'); [soundLaser,sound5,sound4,sound3,sound2,sound1,soundWindows,soundET].forEach(s => { if(s)s.preload='auto';}); } catch (e) { showMessage("Erreur chargement sons.", 5000, true); } }
        function playSound(a) { if (!a || !audioContext || audioContext.state !== 'running') return; a.currentTime = 0; a.play().catch(e => {}); }
        function initAudioContext() { if (audioContext && audioContext.state === 'running') return; if (!audioContext) { try { window.AudioContext = window.AudioContext || window.webkitAudioContext; if (window.AudioContext) audioContext = new AudioContext(); else return; } catch (e) { return; } } if (audioContext.state === 'suspended') audioContext.resume().catch(e => {}); }
        const vibrate = (p = [100]) => { if ('vibrate' in navigator) { try { navigator.vibrate(p); } catch (e) {} } };

        async function gisInitInternal() { if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) { try { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: GOOGLE_CLIENT_ID, scope: GOOGLE_DRIVE_SCOPES, callback: tokenCallback, error_callback: handleTokenError }); if (tokenClient) tokenClient.requestAccessToken({ prompt: '' }); if (signInButton) signInButton.disabled = false; } catch (error) { showMessage("Erreur initialisation services Google.", 5000, true); updateAuthUI(false); if(signInButton) signInButton.disabled = true; } } else { if(signInButton) signInButton.disabled = true; } }
        function checkAndInitGis() { if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2 && typeof google.accounts.oauth2.initTokenClient === 'function') gisInitInternal(); else if (gisCheckRetries < GIS_MAX_RETRIES) { gisCheckRetries++; setTimeout(checkAndInitGis, GIS_CHECK_INTERVAL); } else { showMessage("Erreur critique: API Google non disponible.", 10000, true); if(signInButton) signInButton.disabled = true; } }
        function handleTokenError(error) { let msg = `Erreur Authentification Google: ${error.type || error.error || 'Inconnue'}`; if (error.type === 'popup_closed_by_user' || error.error === 'popup_closed_by_user') msg = "Fenêtre de connexion Google fermée."; else if (error.type === 'popup_failed_to_open') msg = "Impossible d'ouvrir la fenêtre de connexion. Vérifiez les bloqueurs de popups."; else if (error.type === 'USER_CANCELLED' || error.error === 'access_denied') msg = "Accès aux données Drive refusé par l'utilisateur."; if (driveStatusElement) { driveStatusElement.className = 'error'; driveStatusElement.style.display = 'inline-flex'; } showMessage(msg, 7000, true); if (driveStatusTextElement) driveStatusTextElement.textContent = 'Erreur Auth'; updateAuthUI(false); }
        async function tokenCallback(tokenResponse) {
            if (driveStatusElement) driveStatusElement.className = ''; 
            if (tokenResponse.error) { if (tokenResponse.error !== "popup_failed_to_open" && tokenResponse.error !== "popup_closed_by_user") handleTokenError(tokenResponse); else updateAuthUI(false); return; }
            if (tokenResponse && tokenResponse.access_token) {
                googleAccessToken = tokenResponse.access_token; showMessage("Connecté ! Chargement des données...", 2500);
                if (driveStatusElement) { driveStatusElement.classList.remove('error', 'success'); driveStatusElement.classList.add('loading'); driveStatusElement.style.display = 'inline-flex'; }
                if(driveStatusTextElement) driveStatusTextElement.textContent = 'Chargement...';
                try {
                    await loadHistoryFromDrive(); 
                    const programLoadSuccess = await loadFullProgramFromDrive(); 
                    if (programLoadSuccess) { 
                        showMessage("Programme et historique chargés.", 3000);
                        if (driveStatusElement) { driveStatusElement.classList.remove('loading', 'error'); driveStatusElement.classList.add('success'); }
                        if(driveStatusTextElement) driveStatusTextElement.textContent = 'Connecté';
                    } else { 
                        showMessage(`Erreur chargement '${FULL_PROGRAM_FILENAME}'. Vérifiez le fichier sur Drive.`, 8000, true);
                        if (driveStatusElement) { driveStatusElement.classList.remove('loading'); driveStatusElement.classList.add('error'); }
                        if(driveStatusTextElement) driveStatusTextElement.textContent = 'Erreur Prog';
                        loadedFullProgram = null; programsLoaded = false; 
                    }
                } catch (error) {
                    showMessage("Erreur majeure lors du chargement depuis Drive. Vérifiez votre connexion.", 6000, true);
                    if (driveStatusElement) { driveStatusElement.classList.remove('loading', 'success'); driveStatusElement.classList.add('error'); }
                    if(driveStatusTextElement) driveStatusTextElement.textContent = 'Erreur Données';
                    loadedFullProgram = null; programsLoaded = false; 
                } finally { updateAuthUI(true); displayHistory(currentHistoryPeriod); loadInProgressState(); }
            } else handleTokenError({ error: "Réponse de token invalide ou vide" });
        }
        function updateAuthUI(isLoggedIn) {
            const body = document.body; body.classList.toggle('logged-in', isLoggedIn); body.classList.toggle('logged-out', !isLoggedIn);
            if (driveStatusElement && driveStatusTextElement) {
                driveStatusElement.style.display = isLoggedIn ? 'inline-flex' : 'none';
                if (isLoggedIn) { 
                    const c = driveStatusElement.className; if (c.includes('loading')) driveStatusTextElement.textContent = 'Chargement...';
                    else if (!c.includes('error')) { driveStatusElement.classList.add('success'); driveStatusTextElement.textContent = 'Connecté'; }
                } else { driveStatusElement.className = ''; driveStatusTextElement.textContent = ''; }
            }
            if (driveConnectionStatusMain && driveConnectionText) {
                driveConnectionStatusMain.style.display = isLoggedIn ? 'inline-flex' : 'none'; const d = driveStatusElement?.className || ''; 
                driveConnectionStatusMain.className = d; 
                if (isLoggedIn) { if (d.includes('loading')) driveConnectionText.textContent = "Chargement..."; else if (d.includes('error')) driveConnectionText.textContent = `Erreur Drive`; else driveConnectionText.textContent = "Connecté"; }
            }
            if (historyDriveStatus && historyActionsContainer) {
                historyActionsContainer.style.display = isLoggedIn ? 'flex' : 'none';
                if (isLoggedIn) {
                    historyDriveStatus.className = ''; 
                    if (isSavingDriveData) { historyDriveStatus.textContent = 'Synchro...'; historyDriveStatus.classList.add('syncing'); }
                    else if (driveStatusElement?.classList.contains('loading')) { historyDriveStatus.textContent = 'Chargement...'; historyDriveStatus.classList.add('syncing'); }
                    else if (driveStatusElement?.classList.contains('error')) { historyDriveStatus.textContent = 'Erreur Synchro'; historyDriveStatus.classList.add('error'); }
                    else { historyDriveStatus.textContent = 'Synchro OK'; historyDriveStatus.classList.add('success'); }
                }
            }
            if(signInButton) signInButton.disabled = isLoggedIn || !tokenClient; 
            const isTimerActive = ['preparing', 'exercise', 'break', 'paused'].includes(currentState);
            navButtons.forEach(btn => { if(btn) btn.disabled = !(isLoggedIn && programsLoaded && loadedFullProgram && !isTimerActive); });
            document.querySelectorAll('nav a.nav-link').forEach(link => { link.classList.toggle('disabled-link-look', isTimerActive); });
            if(navHistoryBtn) navHistoryBtn.disabled = isTimerActive; 
            if (currentState === 'idle') {
                const canStartWorkout = isLoggedIn && programsLoaded && loadedFullProgram && !!currentWorkoutType && currentWorkoutPlan && currentWorkoutPlan.length > 0;
                if(startPauseBtn) { startPauseBtn.disabled = !canStartWorkout; startPauseBtn.innerHTML = `<i class="fas fa-play"></i> Démarrer`; startPauseBtn.className = ''; }
            } else if (startPauseBtn) startPauseBtn.disabled = ['preparing', 'finished', 'exercise'].includes(currentState);
            if(prevBtn) prevBtn.disabled = !(isTimerActive && currentItemIndex > 0);
            if(finishBtn) finishBtn.disabled = !isTimerActive;
            if(resetBtn) resetBtn.disabled = !isTimerActive && !isLoggedIn; 
            updateWorkoutInfo(); displayHistory(currentHistoryPeriod); 
        }
        async function findOrCreateFile(filename, defaultContentStr = "{}", mimeType = 'application/json', createIfNotExist = true) {
            if (!googleAccessToken) return null;
            const searchUrl = `https://www.googleapis.com/drive/v3/files?q=name='${encodeURIComponent(filename)}'+and+trashed=false&spaces=drive&fields=files(id,name)`;
            try {
                const searchRes = await fetch(searchUrl, { headers: { 'Authorization': `Bearer ${googleAccessToken}` } });
                if (!searchRes.ok) { if (searchRes.status === 401 || searchRes.status === 403) { showMessage("Session Drive expirée.", 5000, true); googleAccessToken = null; updateAuthUI(false); return null; } throw new Error(`Erreur recherche ${filename}: ${searchRes.status}`); }
                const searchData = await searchRes.json();
                if (searchData.files && searchData.files.length > 0) { console.log(`Fichier '${filename}' trouvé avec ID: ${searchData.files[0].id}`); return searchData.files[0].id; }
                if (!createIfNotExist) { console.log(`Fichier ${filename} non trouvé et création désactivée.`); return null; } 
                console.log(`Fichier '${filename}' non trouvé. Création...`);
                const createUrl = `https://www.googleapis.com/drive/v3/files`; const metadata = { name: filename, mimeType: mimeType };
                const createRes = await fetch(createUrl, { method: 'POST', headers: { 'Authorization': `Bearer ${googleAccessToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify(metadata) });
                if (!createRes.ok) throw new Error(`Erreur création ${filename}: ${createRes.status}`);
                const createData = await createRes.json(); const newFileId = createData.id;
                const writeSuccess = await updateFileContent(newFileId, defaultContentStr);
                console.log(`Fichier '${filename}' créé avec ID: ${newFileId}. Succès écriture contenu: ${writeSuccess}`);
                return writeSuccess ? newFileId : null;
            } catch (error) { console.error(`Erreur findOrCreateFile pour ${filename}:`, error); showMessage(`Erreur gestion fichier ${filename}.`, 5000, true); return null; }
        }
        async function readFileContent(fileId) {
            if (!googleAccessToken || !fileId) return null;
            const url = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`;
            try {
                const response = await fetch(url, { headers: { 'Authorization': `Bearer ${googleAccessToken}` } });
                if (!response.ok) { if (response.status === 404) return ""; if (response.status === 401 || response.status === 403) { showMessage("Session expirée.", 5000, true); googleAccessToken = null; updateAuthUI(false); return null; } throw new Error(`Erreur lecture ${fileId}: ${response.status}`); }
                return await response.text(); 
            } catch (error) { console.error(`Erreur readFileContent pour ${fileId}:`, error); showMessage(`Erreur lecture fichier Drive.`, 5000, true); return null; }
        }
        async function updateFileContent(fileId, content) {
            if (!googleAccessToken || !fileId) return false;
            if (isSavingDriveData) return false; 
            isSavingDriveData = true; if (historyDriveStatus) { historyDriveStatus.textContent = 'Synchro...'; historyDriveStatus.className = 'syncing'; }
            updateAuthUI(!!googleAccessToken); 
            const url = `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`;
            const isJson = typeof content === 'object'; const contentToSend = isJson ? JSON.stringify(content, null, 2) : content;
            const contentType = isJson ? 'application/json; charset=UTF-8' : 'text/plain; charset=UTF-8'; let success = false;
            try {
                const response = await fetch(url, { method: 'PATCH', headers: { 'Authorization': `Bearer ${googleAccessToken}`, 'Content-Type': contentType }, body: contentToSend });
                if (!response.ok) { if (response.status === 401 || response.status === 403) { showMessage("Session expirée.", 5000, true); googleAccessToken = null; updateAuthUI(false); } else throw new Error(`Erreur écriture ${fileId}: ${response.status}`); }
                else success = true; 
            } catch (error) { console.error(`Erreur updateFileContent pour ${fileId}:`, error); if (historyDriveStatus) { historyDriveStatus.textContent = 'Erreur Synchro'; historyDriveStatus.className = 'error'; } showMessage(`Erreur sauvegarde fichier Drive.`, 5000, true); }
            finally { isSavingDriveData = false; updateAuthUI(!!googleAccessToken); } return success;
        }

        async function loadHistoryFromDrive() {
            if (!googleAccessToken) return; console.log("Chargement historique Drive...");
            historyFileId = await findOrCreateFile(HISTORY_FILENAME, JSON.stringify([])); 
            if (historyFileId) {
                const content = await readFileContent(historyFileId);
                if (content !== null) { try { workoutHistory = JSON.parse(content || "[]"); workoutHistory.forEach(e => { if (!e.exercises) e.exercises = []; }); console.log("Historique chargé."); } catch (e) { console.error("Erreur parsing historique:", e); showMessage("Historique Drive corrompu.", 4000, true); workoutHistory = []; } }
                else { console.log("Aucun historique Drive."); workoutHistory = []; }
            } else { console.log("Fichier historique Drive introuvable/création échouée."); workoutHistory = []; }
            displayHistory(currentHistoryPeriod); 
        }
        async function loadFullProgramFromDrive() {
            programsLoaded = false; loadedFullProgram = null; 
            if (!googleAccessToken) { showMessage("Connectez-vous pour charger votre programme.", 5000); return false; }
            
            console.log(`Chargement programme '${FULL_PROGRAM_FILENAME}' depuis Drive...`);
            programFileId = await findOrCreateFile(FULL_PROGRAM_FILENAME, "", false); 
            
            if (programFileId) {
                const content = await readFileContent(programFileId);
                if (content && content.trim() !== "") {
                    try {
                        const parsedProgram = JSON.parse(content);
                        if (parsedProgram && parsedProgram.sessions && Array.isArray(parsedProgram.sessions) && parsedProgram.sessions.length > 0) {
                            loadedFullProgram = parsedProgram; programsLoaded = true;
                            console.log(`Programme '${FULL_PROGRAM_FILENAME}' chargé depuis Drive.`);
                            return true;
                        } else {
                            console.error(`Programme '${FULL_PROGRAM_FILENAME}' malformé.`);
                            showMessage(`Programme '${FULL_PROGRAM_FILENAME}' sur Drive malformé.`, 5000, true); return false; 
                        }
                    } catch (e) {
                        console.error(`Erreur parsing '${FULL_PROGRAM_FILENAME}' depuis Drive:`, e, "\nContenu:", content.substring(0, 200) + "...");
                        showMessage(`Programme '${FULL_PROGRAM_FILENAME}' sur Drive corrompu. Erreur: ${e.message}`, 7000, true); return false;
                    }
                } else { 
                     console.log(`'${FULL_PROGRAM_FILENAME}' vide ou non trouvé. L'application nécessite ce fichier.`); 
                     showMessage(`Fichier '${FULL_PROGRAM_FILENAME}' vide ou non trouvé sur Drive. Veuillez le créer et le remplir.`, 7000, true); return false; 
                }
            } else { 
                console.log(`'${FULL_PROGRAM_FILENAME}' non trouvé sur Drive. L'utilisateur doit le créer.`); 
                showMessage(`Fichier '${FULL_PROGRAM_FILENAME}' non trouvé sur Drive. Veuillez le créer et le remplir.`, 7000, true); return false; 
            }
        }
        
        async function saveFullProgramToDrive() {
            if (!googleAccessToken || !loadedFullProgram) { console.warn("Tentative de sauvegarde du programme global sans token ou programme."); return; }
            if (!programFileId) programFileId = await findOrCreateFile(FULL_PROGRAM_FILENAME, JSON.stringify(loadedFullProgram), true); 
            if (programFileId) {
                console.log(`Sauvegarde du programme '${FULL_PROGRAM_FILENAME}' sur Drive...`);
                const success = await updateFileContent(programFileId, loadedFullProgram);
                if (success) console.log(`Programme '${FULL_PROGRAM_FILENAME}' sauvegardé avec succès.`);
                else console.error(`Échec sauvegarde programme '${FULL_PROGRAM_FILENAME}'.`);
            } else { console.error(`ID fichier programme introuvable pour '${FULL_PROGRAM_FILENAME}'.`); showMessage("Impossible de sauvegarder le programme sur Drive.", 4000, true); }
        }

        function saveInProgressState() { if (!isWorkoutActive || currentState === 'finished') { clearInProgressState(); return; } const stateToSave = { currentWorkoutType, currentWorkoutPlan: JSON.parse(JSON.stringify(currentWorkoutPlan)), currentItemIndex, timeLeft, prepareTimeLeft, workoutStartTime, currentState, previousState }; localStorage.setItem(IN_PROGRESS_KEY, JSON.stringify(stateToSave)); }
        function loadInProgressState() {
            const savedState = localStorage.getItem(IN_PROGRESS_KEY);
            if (savedState) {
                try {
                    const parsedState = JSON.parse(savedState);
                    if (parsedState.currentWorkoutType && parsedState.currentWorkoutPlan && parsedState.currentState && loadedFullProgram) {
                        if (confirm("Un entraînement était en cours. Voulez-vous le reprendre ?")) {
                            currentWorkoutType = parsedState.currentWorkoutType; currentWorkoutPlan = parsedState.currentWorkoutPlan; 
                            currentItemIndex = parsedState.currentItemIndex; timeLeft = parsedState.timeLeft; prepareTimeLeft = parsedState.prepareTimeLeft;
                            workoutStartTime = parsedState.workoutStartTime; previousState = parsedState.previousState || 'idle'; 
                            setActiveWorkoutNav(currentWorkoutType); setState(parsedState.currentState); 
                            updateOverallWorkoutProgressDisplay(); 
                            showMessage("Entraînement repris.", 2500); return; 
                        }
                    }
                } catch (e) { console.error("Erreur parsing état en cours:", e); }
            } clearInProgressState(); 
        }
        function clearInProgressState() { localStorage.removeItem(IN_PROGRESS_KEY); }
        
        function saveWorkoutToHistory() {
            if (!currentWorkoutType || !workoutStartTime || !originalCompletedWorkoutPlan || originalCompletedWorkoutPlan.length === 0) return;
            const endTime = Date.now(); const durationSeconds = (endTime - workoutStartTime) / 1000;
            const exercisesForHistory = originalCompletedWorkoutPlan
                .filter(item => item.type === 'exercise' || item.type?.startsWith('exercise_'))
                .map(ex => {
                    const historyEx = { name: ex.name, type: ex.type, reps_target: ex.reps_text || (ex.duration !== undefined ? ex.duration : ex.reps), reps_unit: ex.reps_unit, unit_duration: ex.unit_duration, weight_description_target: getFormattedWeight(ex), finalReps: ex.finalReps, finalDuration: ex.finalDuration, finalWeightDescription: ex.finalWeightDescription, finalProgressionNote: ex.finalProgressionNote, image_url: ex.image_url, sets_info: ex.sets_info, details_original: ex.details };
                    if(ex.weight_text) historyEx.weight_text = ex.weight_text; if(ex.weight_details) historyEx.weight_details = ex.weight_details;
                    if (ex.type?.includes("myo_reps")) { historyEx.activation_reps_start = ex.activation_reps_start; historyEx.current_activation_reps = ex.current_activation_reps; historyEx.completed_mini_sets = ex.completed_mini_sets; historyEx.mini_reps_start = ex.mini_reps_start; }
                    return historyEx;
                });
            const historyEntry = { date: new Date().toISOString(), type: currentWorkoutType, durationSeconds: durationSeconds, exercises: exercisesForHistory };
            workoutHistory.push(historyEntry);
        }
        
        function updateOverallWorkoutProgressDisplay() {
            if (!timerProgressIndicator || !workoutStepTotalDisplay || !workoutStepCurrentDisplay || !workoutStepInfoDisplay) return;
            if (isWorkoutActive && currentWorkoutPlan.length > 0) {
                const totalItemsInPlan = currentWorkoutPlan.length;
                const currentStepForDisplay = Math.min(currentItemIndex + 1, totalItemsInPlan);
                const progressPercentage = totalItemsInPlan > 0 ? currentStepForDisplay / totalItemsInPlan : 0;
                const dashoffset = TIMER_PROGRESS_CIRCLE_CIRCUMFERENCE * (1 - progressPercentage);
                timerProgressIndicator.style.strokeDashoffset = Math.max(0, dashoffset);
                workoutStepCurrentDisplay.textContent = `Étape ${currentStepForDisplay}`;
                workoutStepTotalDisplay.textContent = `/ ${totalItemsInPlan}`;
                workoutStepInfoDisplay.classList.add('visible');
            } else { timerProgressIndicator.style.strokeDashoffset = TIMER_PROGRESS_CIRCLE_CIRCUMFERENCE; workoutStepInfoDisplay.classList.remove('visible'); }
        }
        
        function updateTimerDisplay() {
            if (!timeDisplayDiv) return; let timeString = "00:00"; 
            const item = currentWorkoutPlan[currentItemIndex];
            switch(currentState) {
                case 'exercise': timeString = (item && item.duration) ? formatTime(timeLeft) : "GO!"; break;
                case 'break': timeString = formatTime(timeLeft); break;
                case 'paused': timeString = (previousState === 'break' || (previousState === 'exercise' && currentWorkoutPlan[currentItemIndex]?.duration)) ? formatTime(timeLeft) : "PAUSE"; break;
                case 'preparing': timeString = formatTime(prepareTimeLeft); break;
                case 'finished': timeString = "FINI!"; break;
                default: timeString = formatTime(0); break;
            }
            timeDisplayDiv.textContent = timeString; 
            updateOverallWorkoutProgressDisplay();
        }
        
        function updateTimerVisuals(state) {
            if (!timerProgressIndicator) return; 
            let stateColorVar = '--idle-color-val', stateGlowRgbVar = '--idle-color-rgb', progressCircleColorVar = '--electric-cyan'; 
            switch(state) {
                case 'exercise': stateColorVar = '--exercise-color-val'; stateGlowRgbVar = '--exercise-color-rgb'; progressCircleColorVar = 'var(--exercise-color-val)'; break;
                case 'break':    stateColorVar = '--break-color-val';    stateGlowRgbVar = '--break-color-rgb';    progressCircleColorVar = 'var(--break-color-val)'; break;
                case 'paused':   stateColorVar = '--paused-color-val';   stateGlowRgbVar = '--paused-color-rgb';   progressCircleColorVar = 'var(--paused-color-val)'; break;
                case 'preparing':stateColorVar = '--preparing-color-val';stateGlowRgbVar = '--preparing-color-rgb';progressCircleColorVar = 'var(--preparing-color-val)'; break;
                case 'finished': stateColorVar = '--finished-color-val'; stateGlowRgbVar = '--finished-color-rgb'; progressCircleColorVar = 'var(--finished-color-val)'; break;
                default: progressCircleColorVar = 'var(--idle-color-val)'; break;
            }
            const rootStyle = getComputedStyle(document.documentElement);
            const stateColor = rootStyle.getPropertyValue(stateColorVar).trim();
            document.documentElement.style.setProperty('--current-timer-state-color', stateColor); 
            document.documentElement.style.setProperty('--current-timer-state-color-rgb', rootStyle.getPropertyValue(stateGlowRgbVar).trim()); 
            timerProgressIndicator.style.stroke = rootStyle.getPropertyValue(progressCircleColorVar.startsWith('var(') ? progressCircleColorVar.slice(4,-1) : progressCircleColorVar).trim();
            if(currentExerciseNameDisplay) {
                if (state === 'exercise') currentExerciseNameDisplay.style.color = rootStyle.getPropertyValue('--color-exercise').trim();
                else if (state === 'break') currentExerciseNameDisplay.style.color = rootStyle.getPropertyValue('--color-break').trim();
                else currentExerciseNameDisplay.style.color = rootStyle.getPropertyValue('--primary-text-color-dark').trim();
            }
        }
        
        function getFormattedReps(item) {
            if (!item) return "-";
            if (item.reps_text) return item.reps_text;
            if (item.duration !== undefined) return formatTime(item.duration) + (item.unit_duration ? ` ${item.unit_duration}` : "s");
            let repsDisplay = item.reps !== undefined ? String(item.reps) : "-";
            let repsUnit = item.reps_unit || "";
            return `${repsDisplay}${repsUnit ? ' ' + repsUnit : ''}`;
        }

        function getFormattedWeight(item) {
            if (!item) return "-";
            if (item.weight_text) return item.weight_text; 
            if (item.unit && item.unit.toLowerCase() === "pdc") return "Poids du Corps";
            if (item.unit && (item.unit.includes("kg") || item.unit.includes("Élastique") || item.unit.startsWith("Résistance"))) return item.unit;
            if (item.weight !== undefined && item.weight > 0 && item.unit) return `${item.weight} ${item.unit}`; 
            if (item.weight !== undefined && item.weight > 0) return `${item.weight} kg`;
            return "-";
        }

        function updateWorkoutInfo() {
            const body = document.body;
            if (!currentExerciseContainer || !currentExerciseNameDisplay || !progressTracker || !exerciseImageContainer || !exerciseImageDisplay) return;
            const item = currentWorkoutPlan[currentItemIndex]; let infoHtml = '', exerciseName = '';
            let showImage = false, imageUrlForDisplay = '';

            body.classList.toggle('no-scroll', !['idle', 'finished'].includes(currentState));
            estimatedEndTimeContainer.style.display = isWorkoutActive ? 'flex' : 'none';

            if (item && (item.type === 'exercise' || item.type?.startsWith('exercise_')) && (currentState === 'exercise' || (currentState === 'paused' && previousState === 'exercise'))) {
                imageUrlForDisplay = item.image_url; if (imageUrlForDisplay) showImage = true;
            } else if (currentState === 'preparing' && currentWorkoutPlan[0] && (currentWorkoutPlan[0].type === 'exercise' || currentWorkoutPlan[0].type?.startsWith('exercise_'))) {
                imageUrlForDisplay = currentWorkoutPlan[0].image_url; if (imageUrlForDisplay) showImage = true;
            }
            if (showImage && imageUrlForDisplay) { exerciseImageDisplay.src = imageUrlForDisplay; exerciseImageDisplay.alt = item?.name || "Image de l'exercice"; exerciseImageContainer.classList.add('visible'); }
            else { exerciseImageContainer.classList.remove('visible'); setTimeout(() => { if (!exerciseImageContainer.classList.contains('visible')) { exerciseImageDisplay.src = ''; exerciseImageDisplay.alt = ''; } }, 400); }
            
            switch (currentState) {
                case 'idle':
                    exerciseName = "ArmorWorkout";
                    let idleMsg = `<div class="workout-prompt"><i class="fas fa-sign-in-alt"></i><span>Connectez-vous pour charger votre programme.</span></div>`;
                    if (googleAccessToken && !programsLoaded) idleMsg = `<div class="workout-prompt"><i class="fas fa-spinner fa-spin"></i><span>Chargement...</span></div>`;
                    else if (googleAccessToken && programsLoaded && !loadedFullProgram) idleMsg = `<div class="workout-prompt"><i class="fas fa-exclamation-triangle"></i><span>'${FULL_PROGRAM_FILENAME}' invalide/non trouvé.</span></div>`;
                    else if (googleAccessToken && programsLoaded && loadedFullProgram && !currentWorkoutType) idleMsg = `<div class="workout-prompt"><i class="fas fa-hand-pointer"></i><span>Sélectionnez une session.</span></div>`;
                    else if (googleAccessToken && programsLoaded && loadedFullProgram && currentWorkoutType) idleMsg = `<div class="workout-prompt"><i class="fas fa-play-circle"></i><span>Prêt à démarrer: ${currentWorkoutType}.</span></div>`;
                    infoHtml = idleMsg; break;
                case 'finished': const durationSeconds = workoutStartTime ? (Date.now() - workoutStartTime) / 1000 : 0; exerciseName = 'Entraînement Terminé !'; infoHtml = `<div class="exercise-details" style="border-color: var(--color-finished);"><div class="main-stats"><span><i class="fas ${getIconForState('finished')}" style="color: var(--color-finished)"></i> Bravo ! ${durationSeconds > 0 ? `(${formatTime(durationSeconds)})` : ''}</span></div></div>`; break;
                case 'preparing': const nextItem = currentWorkoutPlan[0]; exerciseName = `Préparation...`; infoHtml = `<div class="break-info" style="border-color: var(--color-prepare);"><i class="fas ${getIconForState('preparing')} fa-spin" style="color: var(--color-prepare)"></i><span>Prêt pour <strong>${nextItem?.name || 'Exercice'}</strong></span></div>`; break;
                case 'exercise': case 'paused': case 'break':
                    if (!item) { exerciseName = 'Erreur'; infoHtml = '<p>Erreur chargement étape.</p>'; break; }
                    exerciseName = `${item.name || (item.type === 'break' ? 'Repos' : 'Exercice Inconnu')}`; 
                    if (item.type === 'exercise' || item.type?.startsWith('exercise_')) {
                        infoHtml = `<div class="exercise-details" style="border-color: var(--color-exercise);">`; if (item.sets_info) infoHtml += `<span class="sets-info-text"><i class="fas fa-layer-group"></i> ${item.sets_info}</span>`;
                        infoHtml += `<div class="main-stats"><span><i class="fas ${item.duration ? 'fa-clock' : 'fa-repeat'}"></i> ${getFormattedReps(item)}</span>`;
                        const weightDisplay = getFormattedWeight(item); if (weightDisplay !== "-") infoHtml += `<span><i class="fas fa-weight-hanging"></i> ${weightDisplay}</span>`;
                        infoHtml += `</div>`; if (item.details) infoHtml += `<span class="details-text"><i class="fas fa-info-circle"></i> ${item.details}</span>`; infoHtml += `</div>`;
                    } else if (item.type === 'break') {
                        infoHtml = `<div class="break-info" style="border-color: var(--color-break);"><i class="fas ${getIconForType('break')}" style="color: var(--color-break)"></i><span>${item.name || `Pause`}</span></div>`;
                        const nextExIdx = currentItemIndex + 1;
                        if (nextExIdx < currentWorkoutPlan.length && (currentWorkoutPlan[nextExIdx].type === 'exercise' || currentWorkoutPlan[nextExIdx].type?.startsWith('exercise_'))) {
                            const nextEx = currentWorkoutPlan[nextExIdx];
                            infoHtml += `<div class="next-exercise-preview"><i class="fas fa-arrow-right"></i><span><strong>${nextEx.name || '?'}</strong></span><span class="next-details">${getFormattedReps(nextEx)}${getFormattedWeight(nextEx) !== "-" ? `, ${getFormattedWeight(nextEx)}` : ''}</span></div>`;
                        }
                    } break;
                default: exerciseName = '?'; infoHtml = '<p>État inconnu.</p>'; break;
            }
            if(currentExerciseNameDisplay) currentExerciseNameDisplay.textContent = exerciseName; if(currentExerciseContainer) currentExerciseContainer.innerHTML = infoHtml; 
            updateTimerVisuals(currentState); 
        }
        
        function startPrepareCountdown() {
            totalTime = PREPARE_DURATION; timeLeft = PREPARE_DURATION; updateTimerDisplay(); if (prepareTimeLeft === 3) playSound(sound3);
            prepareCountdownInterval = setInterval(() => { prepareTimeLeft--; timeLeft = prepareTimeLeft; updateTimerDisplay(); if (prepareTimeLeft === 2) playSound(sound2); if (prepareTimeLeft === 1) playSound(sound1); if (prepareTimeLeft <= 0) { clearInterval(prepareCountdownInterval); setState('exercise'); } }, 1000);
        }
        
        function startBreakTimer() { 
            const item = currentWorkoutPlan[currentItemIndex]; if (!item || !item.duration) { handleItemCompletion(); return; }
            totalTime = item.duration; if(timeLeft === 0) timeLeft = totalTime; 
            updateTimerDisplay();
            if (timeLeft === 5) playSound(sound5); else if (timeLeft === 4) playSound(sound4); else if (timeLeft === 3) playSound(sound3); else if (timeLeft === 2) playSound(sound2); else if (timeLeft === 1) playSound(sound1);
            if (totalTime > 10) halfwayTimeoutId = setTimeout(() => { playSound(soundWindows); vibrate([50]); }, (timeLeft - (totalTime/2)) * 1000);
            timerInterval = setInterval(() => { timeLeft--; updateTimerDisplay(); if (timeLeft === 5) playSound(sound5); else if (timeLeft === 4) playSound(sound4); else if (timeLeft === 3) playSound(sound3); else if (timeLeft === 2) playSound(sound2); else if (timeLeft === 1) playSound(sound1); if (timeLeft <= 0) { clearInterval(timerInterval); clearTimeout(halfwayTimeoutId); handleItemCompletion(); } }, 1000);
        }
        
        function saveInProgressState() { if (!isWorkoutActive || currentState === 'finished') { clearInProgressState(); return; } const stateToSave = { currentWorkoutType, currentWorkoutPlan: JSON.parse(JSON.stringify(currentWorkoutPlan)), currentItemIndex, timeLeft, prepareTimeLeft, workoutStartTime, currentState, previousState }; localStorage.setItem(IN_PROGRESS_KEY, JSON.stringify(stateToSave)); }
        function loadInProgressState() {
            const savedState = localStorage.getItem(IN_PROGRESS_KEY);
            if (savedState) {
                try {
                    const parsedState = JSON.parse(savedState);
                    if (parsedState.currentWorkoutType && parsedState.currentWorkoutPlan && parsedState.currentState && loadedFullProgram) {
                        if (confirm("Un entraînement était en cours. Voulez-vous le reprendre ?")) {
                            currentWorkoutType = parsedState.currentWorkoutType; currentWorkoutPlan = parsedState.currentWorkoutPlan; 
                            currentItemIndex = parsedState.currentItemIndex; timeLeft = parsedState.timeLeft; prepareTimeLeft = parsedState.prepareTimeLeft;
                            workoutStartTime = parsedState.workoutStartTime; previousState = parsedState.previousState || 'idle'; 
                            estimatedTotalWorkoutTime = calculateEstimatedTotalWorkoutTime(currentWorkoutPlan); updateEstimatedEndTime(estimatedTotalWorkoutTime);
                            setActiveWorkoutNav(currentWorkoutType); setState(parsedState.currentState); 
                            updateOverallWorkoutProgressDisplay(); 
                            showMessage("Entraînement repris.", 2500); return; 
                        }
                    }
                } catch (e) { console.error("Erreur parsing état en cours:", e); }
            } clearInProgressState(); 
        }
        function clearInProgressState() { localStorage.removeItem(IN_PROGRESS_KEY); }
        
        function saveWorkoutToHistory() {
            if (!currentWorkoutType || !workoutStartTime || !originalCompletedWorkoutPlan || originalCompletedWorkoutPlan.length === 0) return;
            const endTime = Date.now(); const durationSeconds = (endTime - workoutStartTime) / 1000;
            const exercisesForHistory = originalCompletedWorkoutPlan
                .filter(item => item.type === 'exercise' || item.type?.startsWith('exercise_'))
                .map(ex => {
                    const historyEx = { name: ex.name, type: ex.type, reps_target: ex.reps_text || (ex.duration !== undefined ? ex.duration : ex.reps), reps_unit: ex.reps_unit, unit_duration: ex.unit_duration, weight_description_target: getFormattedWeight(ex), finalReps: ex.finalReps, finalDuration: ex.finalDuration, finalWeightDescription: ex.finalWeightDescription, finalProgressionNote: ex.finalProgressionNote, image_url: ex.image_url, sets_info: ex.sets_info, details_original: ex.details };
                    if(ex.weight_text) historyEx.weight_text = ex.weight_text; if(ex.weight_details) historyEx.weight_details = ex.weight_details;
                    if (ex.type?.includes("myo_reps")) { historyEx.activation_reps_start = ex.activation_reps_start; historyEx.current_activation_reps = ex.current_activation_reps; historyEx.completed_mini_sets = ex.completed_mini_sets; historyEx.mini_reps_start = ex.mini_reps_start; }
                    return historyEx;
                });
            const historyEntry = { date: new Date().toISOString(), type: currentWorkoutType, durationSeconds: durationSeconds, exercises: exercisesForHistory };
            workoutHistory.push(historyEntry);
        }
        
        function displayHistory(period = 'week') {
            if (!googleAccessToken) { renderHistoryList([]); calculateAndDisplayStats([]); setChartPlaceholder('history-chart-canvas', "Connectez-vous pour voir l'historique."); if(historyFilterBtns) historyFilterBtns.forEach(b => b.classList.remove('active')); return; }
            currentHistoryPeriod = period; if(historyFilterBtns) historyFilterBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.period === period));
            const filteredHistory = filterHistoryByPeriod(workoutHistory, period);
            renderHistoryList(filteredHistory); calculateAndDisplayStats(filteredHistory); renderHistoryChart(filteredHistory);
        }
        function filterHistoryByPeriod(history, period) {
            if (!history) return []; const now = new Date(); let startDate = new Date();
            switch (period) {
                case 'week': startDate.setDate(now.getDate() - now.getDay() - (now.getDay() === 0 ? 6 : -1)); startDate.setHours(0,0,0,0); break;
                case 'month': startDate = new Date(now.getFullYear(), now.getMonth(), 1); startDate.setHours(0,0,0,0); break;
                case 'year': startDate = new Date(now.getFullYear(), 0, 1); startDate.setHours(0,0,0,0); break;
                case 'all': return history; default: return history;
            } return history.filter(item => new Date(item.date) >= startDate);
        }
        function renderHistoryList(filteredHistory) {
            if (!historyList) return; historyList.innerHTML = ''; 
            if (!googleAccessToken) { historyList.innerHTML = '<li class="no-history">Connectez-vous pour voir l\'historique.</li>'; return; }
            if (!filteredHistory || filteredHistory.length === 0) { historyList.innerHTML = '<li class="no-history">Aucun entraînement enregistré pour cette période.</li>'; return; }
            filteredHistory.sort((a, b) => new Date(b.date) - new Date(a.date)); 
            filteredHistory.forEach(item => {
                const li = document.createElement('li'); const itemDate = new Date(item.date);
                const dateString = itemDate.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' }); const timeString = itemDate.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                const totalReps = item.exercises?.reduce((sum, ex) => { let repsForEx = 0; if (ex.finalReps !== undefined && !isNaN(parseInt(ex.finalReps, 10))) repsForEx = parseInt(ex.finalReps, 10); else if (ex.finalDuration !== undefined && !isNaN(parseInt(ex.finalDuration,10))) repsForEx = 1; return sum + repsForEx; }, 0) || 0;
                const durationFormatted = formatTime(item.durationSeconds || 0);
                li.innerHTML = `<span class="history-item-date">${dateString} <small>${timeString}</small></span> <span class="history-item-type">${item.type}</span> <span class="history-item-reps"><i class="fas fa-running"></i> ${totalReps > 0 ? totalReps : '-'}</span> <span class="history-item-duration"><i class="fas fa-stopwatch"></i> ${durationFormatted}</span>`;
                historyList.appendChild(li);
            });
        }
        function calculateAndDisplayStats(filteredHistory) {
            if (!statsDisplay || !statsContentWrapper) return;
            if (!googleAccessToken) { statsContentWrapper.innerHTML = '<p>Connectez-vous pour voir les statistiques.</p>'; if (statsDisplay.querySelector('.motivational-message')) statsDisplay.querySelector('.motivational-message').textContent = ''; return; }
            const totalWorkouts = filteredHistory.length; const totalDuration = filteredHistory.reduce((sum, item) => sum + (item.durationSeconds || 0), 0);
            const avgDuration = totalWorkouts > 0 ? totalDuration / totalWorkouts : 0; let totalRepsAllWorkouts = 0;
            filteredHistory.forEach(workout => { workout.exercises?.forEach(ex => { if (ex.finalReps !== undefined && !isNaN(parseInt(ex.finalReps, 10))) totalRepsAllWorkouts += parseInt(ex.finalReps, 10); else if (ex.finalDuration !== undefined && !isNaN(parseInt(ex.finalDuration,10))) totalRepsAllWorkouts +=1; }); });
            statsContentWrapper.innerHTML = `<p><i class="fas fa-dumbbell"></i> Entraînements: <strong>${totalWorkouts}</strong></p> <p><i class="fas fa-stopwatch"></i> Temps total: <strong>${formatTime(totalDuration)}</strong></p> <p><i class="fas fa-clock"></i> Durée moyenne: <strong>${formatTime(avgDuration)}</strong></p> <p><i class="fas fa-running"></i> Répétitions totales: <strong>${totalRepsAllWorkouts > 0 ? totalRepsAllWorkouts : '-'}</strong></p>`;
            const motivationalMessageEl = statsDisplay.querySelector('.motivational-message');
            if (motivationalMessageEl) { if (totalWorkouts === 0) motivationalMessageEl.textContent = "Commencez votre premier entraînement !"; else if (totalWorkouts < 5) motivationalMessageEl.textContent = "Continuez comme ça, chaque séance compte !"; else motivationalMessageEl.textContent = "Quelle régularité, impressionnant !"; }
        }
        function aggregateChartData(hist, period, metric = 'durationSeconds') {
            if (!hist || hist.length === 0) return { labels: [], data: [] }; const dataMap = new Map();
            hist.forEach(item => { const itemDate = new Date(item.date); let key;
                if (period === 'week') { const dayIndex = itemDate.getDay(); const adjustedDayIndex = (dayIndex === 0) ? 6 : dayIndex -1; const days = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim']; key = days[adjustedDayIndex]; }
                else if (period === 'month') { const dayOfMonth = itemDate.getDate(); const weekNumber = Math.ceil(dayOfMonth / 7); key = `S${weekNumber}`; }
                else if (period === 'year') { const monthIndex = itemDate.getMonth(); const months = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Août', 'Sep', 'Oct', 'Nov', 'Déc']; key = months[monthIndex]; }
                else key = `${itemDate.getFullYear()}-${String(itemDate.getMonth() + 1).padStart(2, '0')}`; 
                const value = parseFloat(item[metric]) || 0; dataMap.set(key, (dataMap.get(key) || 0) + value);
            });
            let sortedLabels;
            if (period === 'week') { const dayOrder = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim']; sortedLabels = Array.from(dataMap.keys()).sort((a,b) => dayOrder.indexOf(a) - dayOrder.indexOf(b)); }
            else if (period === 'month') sortedLabels = Array.from(dataMap.keys()).sort((a,b) => parseInt(a.substring(1)) - parseInt(b.substring(1)));
            else if (period === 'year') { const monthOrder = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Août', 'Sep', 'Oct', 'Nov', 'Déc']; sortedLabels = Array.from(dataMap.keys()).sort((a,b) => monthOrder.indexOf(a) - monthOrder.indexOf(b)); }
            else sortedLabels = Array.from(dataMap.keys()).sort();
            const data = sortedLabels.map(label => dataMap.get(label) / (metric === 'durationSeconds' ? 60 : 1)); 
            return { labels: sortedLabels, data };
        }
        function getChartXAxisTitle(period){ switch(period){ case 'week': return 'Jour de la semaine'; case 'month': return 'Semaine du mois'; case 'year': return 'Mois'; case 'all': return 'Mois (sur tout l\'historique)'; default: return 'Période'; } }
        function renderHistoryChart(filteredHistory) {
            if (!historyChartCanvasEl) return; const { labels, data } = aggregateChartData(filteredHistory, currentHistoryPeriod, 'durationSeconds');
            if (labels.length === 0 || data.length === 0) { setChartPlaceholder('history-chart-canvas', "Pas de données pour afficher le graphique."); if (historyChartInstance) { historyChartInstance.destroy(); historyChartInstance = null; } return; }
            setChartPlaceholder('history-chart-canvas', "", false); const ctx = historyChartCanvasEl.getContext('2d'); if (historyChartInstance) historyChartInstance.destroy(); 
            const rootStyle = getComputedStyle(document.documentElement);
            historyChartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Durée Entraînement (minutes)', data: data, backgroundColor: `rgba(${rootStyle.getPropertyValue('--electric-cyan-rgb').trim()}, 0.6)`, borderColor: `rgb(${rootStyle.getPropertyValue('--electric-cyan-rgb').trim()})`, borderWidth: 1, borderRadius: 4, barPercentage: 0.7, categoryPercentage: 0.8 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: 'Minutes', color: rootStyle.getPropertyValue('--secondary-text-color-dark').trim() }, ticks: { color: rootStyle.getPropertyValue('--secondary-text-color-dark').trim() }, grid: { color: `rgba(${rootStyle.getPropertyValue('--electric-blue-rgb').trim()}, 0.1)` } }, x: { title: { display: true, text: getChartXAxisTitle(currentHistoryPeriod), color: rootStyle.getPropertyValue('--secondary-text-color-dark').trim() }, ticks: { color: rootStyle.getPropertyValue('--secondary-text-color-dark').trim() }, grid: { display: false } } }, plugins: { legend: { display: false }, tooltip: { backgroundColor: `rgba(${rootStyle.getPropertyValue('--secondary-bg-color-dark-rgb').trim()}, 0.9)`, titleColor: rootStyle.getPropertyValue('--primary-text-color-dark').trim(), bodyColor: rootStyle.getPropertyValue('--primary-text-color-dark').trim(), callbacks: { label: function(context) { return `${context.dataset.label}: ${context.parsed.y.toFixed(0)} min`; } } } } } });
        }
        function updateChartColors() {
            if (historyChartInstance) {
                const rootStyle = getComputedStyle(document.documentElement);
                historyChartInstance.data.datasets[0].backgroundColor = `rgba(${rootStyle.getPropertyValue('--electric-cyan-rgb').trim()}, 0.6)`; historyChartInstance.data.datasets[0].borderColor = `rgb(${rootStyle.getPropertyValue('--electric-cyan-rgb').trim()})`;
                historyChartInstance.options.scales.y.title.color = rootStyle.getPropertyValue('--secondary-text-color-dark').trim(); historyChartInstance.options.scales.y.ticks.color = rootStyle.getPropertyValue('--secondary-text-color-dark').trim(); historyChartInstance.options.scales.y.grid.color = `rgba(${rootStyle.getPropertyValue('--electric-blue-rgb').trim()}, 0.1)`;
                historyChartInstance.options.scales.x.title.color = rootStyle.getPropertyValue('--secondary-text-color-dark').trim(); historyChartInstance.options.scales.x.ticks.color = rootStyle.getPropertyValue('--secondary-text-color-dark').trim();
                historyChartInstance.options.plugins.tooltip.backgroundColor = `rgba(${rootStyle.getPropertyValue('--secondary-bg-color-dark-rgb').trim()}, 0.9)`; historyChartInstance.options.plugins.tooltip.titleColor = rootStyle.getPropertyValue('--primary-text-color-dark').trim(); historyChartInstance.options.plugins.tooltip.bodyColor = rootStyle.getPropertyValue('--primary-text-color-dark').trim();
                historyChartInstance.update();
            }
        }
        function clearCharts() { if (historyChartInstance) { historyChartInstance.destroy(); historyChartInstance = null; } }
        function setChartPlaceholder(canvasId, message, show = true) { const placeholderId = canvasId.replace('-canvas', '-placeholder'); const placeholderEl = document.getElementById(placeholderId); const canvasEl = document.getElementById(canvasId); if (placeholderEl && canvasEl) { placeholderEl.textContent = message; placeholderEl.style.display = show ? 'block' : 'none'; canvasEl.style.opacity = show ? '0.2' : '1'; } }
        
        function initializeDOMReferences() {
            try {
                timeDisplayDiv = document.getElementById('time-left'); currentExerciseContainer = document.getElementById('current-exercise-container');
                progressTracker = document.getElementById('progress-tracker'); startPauseBtn = document.getElementById('start-pause-btn'); skipBtn = document.getElementById('skip-btn'); finishBtn = document.getElementById('finish-btn');
                resetBtn = document.getElementById('reset-btn'); prevBtn = document.getElementById('prev-btn'); messageArea = document.getElementById('message-area');
                workoutSection = document.getElementById('workout-section'); historySection = document.getElementById('history-section'); historyList = document.getElementById('history-list');
                statsDisplay = document.getElementById('stats-display'); statsContentWrapper = statsDisplay?.querySelector('.content-wrapper'); historyFilterBtns = Array.from(document.querySelectorAll('.history-filters button'));
                historyChartCanvasEl = document.getElementById('history-chart-canvas'); signInButton = document.getElementById('signin-button'); driveStatusElement = document.getElementById('drive-status');
                driveStatusTextElement = document.getElementById('drive-status-text'); postWorkoutSummary = document.getElementById('post-workout-summary'); summaryTitle = document.getElementById('summary-title');
                summaryItemsList = document.getElementById('summary-items-list'); finishSummaryBtn = document.getElementById('finish-summary-btn'); historyDriveStatus = document.getElementById('history-drive-status');
                currentExerciseNameDisplay = document.getElementById('current-exercise-name-display'); driveConnectionStatusMain = document.getElementById('drive-connection-status-main');
                driveConnectionText = document.getElementById('drive-connection-text'); timerDisplayElement = document.querySelector('.timer-display'); reactorElement = document.querySelector('.reactor');
                exerciseImageContainer = document.getElementById('exercise-image-container'); exerciseImageDisplay = document.getElementById('exercise-image-display'); progressTextArea = document.getElementById('progress-text-area');
                historyActionsContainer = document.querySelector('.history-actions'); 
                navHistoryBtn = document.getElementById('nav-history');
                navButtons = [document.getElementById('nav-push'), document.getElementById('nav-pull'), document.getElementById('nav-legs')];
                timerProgressIndicator = document.getElementById('timer-progress-indicator'); 
                workoutStepTotalDisplay = document.getElementById('workout-step-total-display');
                workoutStepCurrentDisplay = document.getElementById('workout-step-current-display');
                workoutStepInfoDisplay = document.getElementById('workout-step-info-display');
                estimatedEndTimeContainer = document.getElementById('estimated-end-time-container');
                estimatedEndTimeDisplay = document.getElementById('estimated-end-time');
            } catch (e) { document.body.innerHTML = "<p style='color:white; text-align:center; padding-top: 50px;'>Erreur critique chargement. Rafraîchissez.</p>"; }
        }
        function addEventListeners() {
            if (startPauseBtn) startPauseBtn.addEventListener('click', () => { initAudioContext(); if (currentState === 'idle') setState('preparing'); else if (currentState === 'break') setState('paused'); else if (currentState === 'paused') { const item = currentWorkoutPlan[currentItemIndex]; setState(item?.duration ? 'exercise' : 'break'); } });
            if (timerDisplayElement) timerDisplayElement.addEventListener('click', () => { initAudioContext(); if (isWorkoutActive && (currentState === 'exercise' && !currentWorkoutPlan[currentItemIndex]?.duration) && currentState !== 'preparing' && currentState !== 'finished') handleItemCompletion(); else if (currentState === 'idle' && startPauseBtn && !startPauseBtn.disabled) setState('preparing'); });
            if (skipBtn) skipBtn.addEventListener('click', () => { initAudioContext(); if (isWorkoutActive) handleItemCompletion(); });
            if (prevBtn) prevBtn.addEventListener('click', () => { initAudioContext(); handlePreviousClick(); });
            if (finishBtn) finishBtn.addEventListener('click', () => { initAudioContext(); forceFinishWorkout(); });
            if (resetBtn) resetBtn.addEventListener('click', () => { initAudioContext(); resetCurrentWorkout(); });
            navButtons.forEach(btn => { if (btn) btn.addEventListener('click', () => { initAudioContext(); loadSession(btn.dataset.sessionName); }); });
            document.querySelectorAll('nav a.nav-link').forEach(link => { link.addEventListener('click', (e) => { initAudioContext(); if (isWorkoutActive) { e.preventDefault(); showMessage("Terminez ou mettez en pause l'entraînement avant de naviguer.", 3000); } }); });
            if(navHistoryBtn) navHistoryBtn.addEventListener('click', () => { initAudioContext(); showSection('history-section'); });
            historyFilterBtns.forEach(btn => { if(btn) btn.addEventListener('click', () => { initAudioContext(); displayHistory(btn.dataset.period); }); });
            if(signInButton) signInButton.addEventListener('click', handleAuthClick);
            if(finishSummaryBtn) finishSummaryBtn.addEventListener('click', finishSummary);
            if(postWorkoutSummary) postWorkoutSummary.addEventListener('click', (e) => { if (e.target === postWorkoutSummary) finishSummary(); });
            document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'hidden' && isWorkoutActive) saveInProgressState(); });
            window.addEventListener('beforeunload', () => { if (isWorkoutActive) saveInProgressState(); });
        }
    </script>
</body>
</html>
