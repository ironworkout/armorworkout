<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArmorWorkout - Ultimate Edition</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚ö°</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color-dark: #030712; 
            --secondary-bg-color-dark: #0B132B; 
            --primary-text-color-dark: #F0F4F8; 
            --secondary-text-color-dark: #A0AEC0; 
            --border-color-dark: #1E293B; 
            --electric-blue: #00BFFF; --electric-cyan: #22D3EE; --electric-blue-light: #4D94FF; 
            --electric-blue-rgb: 0, 191, 255; --electric-cyan-rgb: 34, 211, 238;
            --neon-pink: #FF1493; --neon-purple: #9400D3; --neon-green: #39FF14; --neon-red: #FF3131; --neon-yellow: #FFF01F;
            --neon-green-rgb: 57, 255, 20; --neon-red-rgb: 255, 49, 49; --neon-yellow-rgb: 255, 240, 31;
            --font-family-main: 'Inter', sans-serif; --font-family-timer: 'Orbitron', sans-serif;
            --bg-color: var(--bg-color-dark); --input-bg: #1A202C;
            --theme-color: var(--electric-cyan);
            --reactor-speed: 12s;
            --transition-speed: 0.3s;
        }

        /* Ligues */
        body.league-1 { --theme-color: #CD7F32; } body.league-2 { --theme-color: #C0C0C0; } body.league-3 { --theme-color: #FFD700; }
        body.league-4 { --theme-color: #E5E4E2; } body.league-5 { --theme-color: #B9F2FF; } body.league-6 { --theme-color: #9400D3; }
        body.league-7 { --theme-color: #FF0000; } body.league-8 { --theme-color: #FF1493; } body.league-9 { --theme-color: #00FF00; }
        body.league-10 { --theme-color: #FFFFFF; }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family-main); background-color: var(--bg-color); color: var(--primary-text-color-dark); min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden; background-image: radial-gradient(ellipse at center, rgba(var(--electric-blue-rgb), 0.08) 0%, transparent 60%); }
        
        /* Layout */
        .container { max-width: 1200px; margin: 0 auto; padding: 30px 25px; width: 100%; flex-grow: 1; display: flex; flex-direction: column; }
        header { padding: 15px 0; background-color: rgba(11, 19, 43, 0.8); backdrop-filter: blur(8px); border-bottom: 1px solid rgba(0, 191, 255, 0.3); position: sticky; top:0; z-index: 1000; }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; padding: 0 25px; }
        header h1 { font-family: var(--font-family-timer); font-size: 1.5em; display: flex; align-items: center; gap: 10px; margin: 0;}
        header h1 i { color: var(--electric-cyan); animation: subtlePulse 3s infinite; }
        .header-actions { display: flex; gap: 10px; align-items: center;}
        #signin-button, #drive-status-text, #edit-program-btn { background: transparent; border: 1px solid var(--border-color-dark); color: var(--secondary-text-color-dark); padding: 5px 12px; border-radius: 8px; cursor: pointer; display: inline-flex; align-items: center; gap:5px; transition: all 0.3s; }
        #drive-status.success #drive-status-text { border-color: var(--neon-green); color: var(--neon-green); }
        #edit-program-btn.active { border-color: var(--neon-yellow); color: var(--neon-yellow); box-shadow: 0 0 10px rgba(255,240,31,0.2); }
        body.logged-in #signin-button { display: none; }
        body.logged-out #drive-status { display: none; }

        /* Sections & Animations */
        .app-section { animation: fadeIn 0.5s ease-out; width: 100%; }
        .section-hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes subtlePulse { 0%, 100% { opacity: 0.7; transform: scale(1); } 50% { opacity: 1; transform: scale(1.05); } }

        /* Home Grid */
        .home-grid { display: flex; flex-wrap: wrap; gap: 30px; width: 100%; }
        .home-main-content { flex: 1 1 60%; min-width: 300px; display: flex; flex-direction: column; gap: 25px; }
        .home-sidebar { flex: 1 1 35%; min-width: 280px; display: flex; flex-direction: column; gap: 25px; }
        
        .sidebar-module, .session-card-large { background-color: rgba(11, 19, 43, 0.6); border: 1px solid rgba(0, 191, 255, 0.2); border-radius: 10px; padding: 20px; backdrop-filter: blur(10px); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .session-card-large { cursor: pointer; transition: transform 0.2s, border-color 0.2s, box-shadow 0.2s; position: relative; }
        .session-card-large:hover { transform: translateY(-3px); border-color: var(--electric-cyan); box-shadow: 0 8px 25px rgba(0, 191, 255, 0.15); }
        .session-card-header h3 { font-family: var(--font-family-timer); color: var(--electric-cyan); font-size: 1.3em; margin: 0 0 5px 0; }
        
        /* Charts */
        .doughnut-chart-container { position: relative; height: 180px; width: 100%; display: flex; justify-content: center; margin-top: 10px; }
        .doughnut-chart-container.gold-pulse { animation: chart-gold-pulse 2s infinite; border-radius: 50%; }
        .chart-area-container { height: 150px; width: 100%; margin-top: 20px; border-top: 1px solid var(--border-color-dark); padding-top: 15px; }
        .global-performance-chart-container { height: 280px; position: relative; margin-top: 15px; width: 100%; }
        @keyframes chart-gold-pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4); } 70% { box-shadow: 0 0 0 20px rgba(255, 215, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); } }

        /* Calendar */
        .monthly-calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; margin-top: 15px; }
        .calendar-header { font-size: 0.8em; color: var(--secondary-text-color-dark); }
        .calendar-day { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; margin: 0 auto; position: relative; font-size: 0.9em; border-radius: 50%; transition: all 0.2s; }
        .calendar-day.today { border: 1px solid var(--electric-cyan); color: var(--electric-cyan); background: rgba(34, 211, 238, 0.1); }
        .day-dot { position: absolute; bottom: 4px; width: 4px; height: 4px; background-color: var(--electric-cyan); border-radius: 50%; box-shadow: 0 0 5px var(--electric-cyan); }
        .delete-workout-btn { position: absolute; top: -5px; right: -5px; background: var(--bg-color-dark); border: 1px solid var(--neon-red); color: var(--neon-red); border-radius: 50%; width: 18px; height: 18px; font-size: 10px; display: flex; align-items: center; justify-content: center; opacity: 0; cursor: pointer; transition: transform 0.2s; }
        .calendar-day:hover .delete-workout-btn { opacity: 1; transform: scale(1.1); }

        /* ARC REACTOR TIMER (Full CSS) */
        .timer-and-image-wrapper { display: flex; flex-direction: column; align-items: center; gap: 20px; margin-bottom: 25px; }
        .exercise-image-area { width: 100%; max-width: 220px; margin: 0 auto; padding: 5px; background: rgba(11,19,43,0.5); border: 1px solid rgba(0,191,255,0.3); border-radius: 8px; display: none; }
        .exercise-image-area.visible { display: flex; }
        .exercise-image-area img { max-width: 100%; height: auto; border-radius: 4px; }
        
        .timer-display { position: relative; width: 280px; height: 280px; margin: 0 auto; display: flex; justify-content: center; align-items: center; cursor: pointer; user-select: none; }
        .timer-progress-circle-container { position: absolute; top: 50%; left: 50%; width: 230px; height: 230px; transform: translate(-50%, -50%); pointer-events: none; }
        .timer-progress-circle { fill: none; stroke: var(--electric-cyan); stroke-width: 6; stroke-linecap: round; transform-origin: center; transform: rotate(-90deg); transition: stroke-dashoffset 0.3s linear; }
        .timer-progress-circle-bg { fill: none; stroke: rgba(0, 191, 255, 0.15); stroke-width: 6; }
        
        .reactor { width: 180px; height: 180px; border-radius: 50%; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; background: rgba(0,0,0,0.2); }
        .reactor::before { content:''; position: absolute; inset:0; box-shadow: inset 0 0 20px rgba(0,191,255,0.2); border-radius: 50%; }
        
        .triangle { position: absolute; top: 66%; left: 50%; transform: translate(-50%, -50%); width: 155px; aspect-ratio: 1; background-color: var(--electric-cyan); clip-path: polygon(50% 88%, 0 0, 100% 0); z-index: 5; transition: 0.3s; }
        .triangle::after { content: ''; position: absolute; top: 45%; left: 50%; width: 120px; height: 120px; transform: translate(-50%, -50%); background-color: var(--bg-color-dark); clip-path: polygon(50% 90%, 0 0, 100% 0); }
        
        .circle-1 { position: absolute; width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(rgba(34, 211, 238, 0.8), rgba(0, 191, 255, 0.8)); animation: rotate-right var(--reactor-speed) linear infinite; z-index: 2; }
        .circle-1::before { content: ''; position: absolute; inset: 10px; border-radius: 50%; background-color: var(--bg-color-dark); }
        
        @keyframes rotate-right { to { transform: rotate(360deg); } }
        
        #time-left { position: absolute; z-index: 20; font-family: var(--font-family-timer); font-size: 3.5em; font-weight: 700; color: #fff; text-shadow: 0 0 10px var(--electric-cyan); pointer-events: none; }

        /* Controls */
        .controls { display: flex; justify-content: center; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .controls button { background: rgba(11, 19, 43, 0.8); border: 1px solid var(--border-color-dark); color: var(--secondary-text-color-dark); padding: 10px 20px; border-radius: 8px; cursor: pointer; transition: all 0.2s; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; }
        .controls button:hover:not(:disabled) { border-color: var(--electric-cyan); color: var(--electric-cyan); background: rgba(0,191,255,0.1); transform: translateY(-2px); }
        .controls button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Workout Info */
        .workout-info { text-align: center; margin-bottom: 10px; }
        #current-exercise-name-display { font-size: 1.6em; color: #fff; text-shadow: 0 0 10px rgba(0,191,255,0.5); margin-bottom: 10px; }
        
        /* Summary Modal (New Design) */
        .post-workout-summary { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .post-workout-summary.visible { display: flex; }
        .post-workout-summary-content { background: var(--secondary-bg-color-dark); width: 95%; max-width: 650px; max-height: 90vh; border-radius: 12px; border: 1px solid var(--electric-cyan); display: flex; flex-direction: column; box-shadow: 0 0 30px rgba(0,191,255,0.2); }
        .summary-items-list { overflow-y: auto; padding: 20px; flex-grow: 1; }
        .summary-item { background: rgba(255,255,255,0.03); padding: 15px; margin-bottom: 15px; border-radius: 8px; border-left: 4px solid var(--electric-blue); }
        
        /* VIBRANIUM */
        .vibranium-mastered { border-color: var(--neon-purple); background: linear-gradient(90deg, rgba(148,0,211,0.15), rgba(0,0,0,0)); box-shadow: inset 0 0 10px rgba(148,0,211,0.1); }
        .badge-vibranium { color: #FFD700; font-weight: 900; font-family: var(--font-family-timer); font-size: 0.8em; display: inline-block; margin-bottom: 8px; text-shadow: 0 0 5px #FFD700; }
        
        /* Inputs in Summary */
        .fields-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 5px; }
        @media (max-width: 600px) { .fields-grid { grid-template-columns: 1fr; } }
        
        .input-group label { display: block; font-size: 0.75em; color: var(--secondary-text-color-dark); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        .stepper-control { display: flex; background: #1A202C; border-radius: 5px; overflow: hidden; border: 1px solid var(--border-color-dark); }
        .stepper-btn { padding: 8px 12px; background: transparent; border: none; color: var(--electric-cyan); cursor: pointer; font-size: 1.1em; transition: background 0.2s; }
        .stepper-btn:hover { background: rgba(0,191,255,0.1); }
        .stepper-value { flex-grow: 1; text-align: center; color: #fff; line-height: 32px; font-weight: bold; }
        
        .resistance-selector { margin-bottom: 8px; position: relative; }
        .selected-resistance { background: #1A202C; border: 1px solid var(--border-color-dark); color: #fff; padding: 8px; border-radius: 5px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .resistance-options { position: absolute; top: 100%; left: 0; right: 0; background: var(--secondary-bg-color-dark); border: 1px solid var(--electric-cyan); z-index: 10; display: none; max-height: 200px; overflow-y: auto; }
        .resistance-selector.open .resistance-options { display: block; }
        .resistance-options li { padding: 8px; cursor: pointer; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .resistance-options li:hover { background: rgba(0,191,255,0.2); }

        .goal-input { width: 100%; background: #1A202C; border: 1px solid var(--border-color-dark); color: #fff; padding: 8px; border-radius: 5px; font-family: var(--font-family-main); }
        .goal-input:focus { border-color: #FFD700; outline: none; }

        .tracking-type-toggle { display: flex; border: 1px solid var(--border-color-dark); border-radius: 5px; overflow: hidden; }
        .tracking-type-toggle button { flex: 1; background: transparent; border: none; padding: 6px; color: #aaa; cursor: pointer; font-size: 0.8em; }
        .tracking-type-toggle button.active { background: var(--electric-cyan); color: #000; font-weight: bold; }

        .summary-controls { padding: 20px; border-top: 1px solid var(--border-color-dark); text-align: center; background: rgba(0,0,0,0.2); border-radius: 0 0 12px 12px; }
        #finish-summary-btn { background: var(--neon-green); border: none; color: #000; font-weight: bold; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-family: var(--font-family-timer); text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 0 15px rgba(57,255,20,0.4); transition: transform 0.2s; }
        #finish-summary-btn:hover { transform: scale(1.05); }

        .message-area { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: var(--secondary-bg-color-dark); border: 1px solid var(--electric-cyan); color: #fff; padding: 12px 25px; border-radius: 8px; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 3000; box-shadow: 0 5px 20px rgba(0,0,0,0.5); text-align: center; }
        .message-area.visible { opacity: 1; }
        
        footer { margin-top: 50px; padding: 20px; text-align: center; border-top: 1px solid rgba(255,255,255,0.1); font-size: 0.9em; color: #888; }
        footer a { color: var(--electric-cyan); text-decoration: none; }
    </style>
</head>
<body class="logged-out state-idle">

    <header>
        <div class="header-content">
            <h1><i class="fas fa-bolt"></i> ArmorWorkout</h1>
            <div class="header-actions">
                <button id="edit-program-btn" disabled><i class="fas fa-edit"></i></button>
                <div id="drive-status" style="display: none;"> 
                    <span id="drive-status-text">Connect√©</span>
                </div>
                <button id="signin-button" disabled><i class="fab fa-google"></i> Se connecter</button>
            </div>
        </div>
    </header>

    <div class="container">
        <main>
            <!-- SECTION ACCUEIL -->
            <div id="home-section" class="app-section">
                <!-- Rempli par JS -->
            </div>

            <!-- SECTION WORKOUT -->
            <div id="workout-section" class="app-section section-hidden">
                <div class="timer-and-image-wrapper">
                    <div id="exercise-image-container" class="exercise-image-area">
                        <img id="exercise-image-display" src="" alt="">
                    </div>
                    <div class="timer-display" id="timer-display-clickable">
                        <div class="timer-progress-circle-container">
                            <svg viewBox="0 0 100 100">
                                <circle class="timer-progress-circle-bg" cx="50" cy="50" r="45"></circle>
                                <circle id="timer-progress-indicator" class="timer-progress-circle" cx="50" cy="50" r="45" stroke-dasharray="282.74" stroke-dashoffset="282.74"></circle>
                            </svg>
                        </div>
                        <div class="reactor">
                            <div class="circle-1"><span></span><span></span><span></span><span></span></div>
                            <div class="circle-2"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></div>
                            <div class="circle-3"></div>
                            <div class="triangle"></div>
                            <div id="time-left">00:00</div>
                        </div>
                    </div>
                </div>
                <div class="workout-info">
                    <div id="current-exercise-name-display">Pr√™t ?</div>
                    <div id="current-exercise-container"></div>
                </div>
                <div class="controls">
                    <button id="prev-btn"><i class="fas fa-backward"></i> Pr√©c√©dent</button>
                    <button id="start-pause-btn"><i class="fas fa-play"></i> D√©marrer</button>
                    <button id="skip-btn"><i class="fas fa-forward"></i> Suivant</button>
                    <button id="finish-btn" style="border-color:var(--neon-red); color:var(--neon-red);"><i class="fas fa-flag-checkered"></i> Finir</button>
                </div>
                <div class="progress-tracker">
                    <span id="workout-step-current-display">--</span> / <span id="workout-step-total-display">--</span>
                </div>
            </div>
        </main>
    </div>

    <div id="message-area" class="message-area"></div>

    <!-- MODAL RESUME -->
    <div id="post-workout-summary" class="post-workout-summary">
        <div class="post-workout-summary-content">
            <h2 id="summary-title" style="padding:15px; text-align:center; border-bottom:1px solid #333; color:var(--electric-cyan); margin:0;">R√©sum√© & Objectifs</h2>
            <div id="analysis-chart-container" style="display:none;"></div>
            <ul id="summary-items-list" class="summary-items-list"></ul>
            <div class="summary-controls">
                <button id="finish-summary-btn"><i class="fas fa-check"></i> Sauvegarder</button>
            </div>
        </div>
    </div>
    
    <footer>
        <p>ArmorWorkout ¬© 2026. <i class="fab fa-google-drive"></i> Sauvegarde Drive.</p>
    </footer>

    <!-- Google Identity Services -->
    <script async defer src="https://accounts.google.com/gsi/client"></script>
    
    <script>
        "use strict";

        // --- CONSTANTES ---
        const GOOGLE_CLIENT_ID = "731283926358-viam3ulpgna14flfdeb9m92l8s620hoi.apps.googleusercontent.com";
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const HISTORY_FILE = "armorworkout_history.json";
        const PROGRAM_FILE = "programmeCompletHypertrophieElite_v1.json";
        const IN_PROGRESS_KEY = 'armorWorkoutStateInProgress';
        const IN_PROGRESS_VERSION = 1;
        
        // Programme COMPLET "ROI V√äTU" (Utilis√© si Drive vide)
        const DEFAULT_PROGRAM_CONTENT = JSON.stringify({
          "nom_programme": "ROI V√äTU 2025 (Expert Edition)",
          "description_programme": "Plan minimaliste (Rotation A/B). Focus 100% muscles visibles habill√©. Progression chiffr√©e stricte pour le mode Vibranium.",
          "auteur_programme": "Coach Expert Mutation üß¨",
          "frequence_suggeree": "Alternance A / B en continu (2 √† 3 s√©ances par semaine).",
          "sessions": [
            {
              "nom_session": "S√âANCE A : V-FRAME & TRICEPS",
              "description_session": "Focus : Largeur d'√©paules (#1) et Remplissage des manches (#2).",
              "exercices_et_pauses": [
                { "type": "exercise", "name": "D√©velopp√© Militaire Unilat√©ral", "details": "S√©rie 1/3. Mouvement Roi. Dos √† la porte. Gainage max.", "reps": 8, "weight_text": "üü™ √âlastique 25kg", "final_target_poids": "üü™ √âlastique 25kg", "final_target_reps": "12" },
                { "type": "break", "duration": 90, "name": "Repos (90s)" },
                { "type": "exercise", "name": "D√©velopp√© Militaire Unilat√©ral", "details": "S√©rie 2/3. Attention √† ne pas cambrer.", "reps": 8, "weight_text": "üü™ √âlastique 25kg", "final_target_poids": "üü™ √âlastique 25kg", "final_target_reps": "12" },
                { "type": "break", "duration": 90, "name": "Repos (90s)" },
                { "type": "exercise", "name": "D√©velopp√© Militaire Unilat√©ral", "details": "S√©rie 3/3. Tension maximale en haut.", "reps": 8, "weight_text": "üü™ √âlastique 25kg", "final_target_poids": "üü™ √âlastique 25kg", "final_target_reps": "12" },
                { "type": "break", "duration": 90, "name": "Repos (90s)" },
                { "type": "exercise", "name": "Superset A: Tirage Vertical (Dos)", "details": "S√©rie 1/3. Ancrage HAUT. √Ä genoux.", "reps": 14, "weight_text": "üü™ √âlastique 25kg", "final_target_poids": "üü™ 40kg (25+15)", "final_target_reps": "12" },
                { "type": "break", "duration": 15, "name": "Transition" },
                { "type": "exercise", "name": "Superset B: √âl√©vations Lat√©rales (Sac)", "details": "S√©rie 1/3. Unilat√©ral. Contr√¥le la descente.", "reps": 11, "weight_text": "üéí 7.6 kg", "final_target_poids": "üéí 14 kg", "final_target_reps": "12" },
                { "type": "break", "duration": 75, "name": "Repos Superset (75s)" },
                { "type": "exercise", "name": "Superset A: Tirage Vertical (Dos)", "details": "S√©rie 2/3. Cherche l'√©tirement en haut.", "reps": 14, "weight_text": "üü™ √âlastique 25kg", "final_target_poids": "üü™ 40kg (25+15)", "final_target_reps": "12" },
                { "type": "break", "duration": 15, "name": "Transition" },
                { "type": "exercise", "name": "Superset B: √âl√©vations Lat√©rales (Sac)", "details": "S√©rie 2/3. Ne balance pas le buste.", "reps": 11, "weight_text": "üéí 7.6 kg", "final_target_poids": "üéí 14 kg", "final_target_reps": "12" },
                { "type": "break", "duration": 75, "name": "Repos Superset (75s)" },
                { "type": "exercise", "name": "Superset A: Tirage Vertical (Dos)", "details": "S√©rie 3/3. √âchec technique.", "reps": 14, "weight_text": "üü™ √âlastique 25kg", "final_target_poids": "üü™ 40kg (25+15)", "final_target_reps": "12" },
                { "type": "break", "duration": 15, "name": "Transition" },
                { "type": "exercise", "name": "Superset B: √âl√©vations Lat√©rales (Sac)", "details": "S√©rie 3/3. Br√ªlure.", "reps": 11, "weight_text": "üéí 7.6 kg", "final_target_poids": "üéí 14 kg", "final_target_reps": "12" },
                { "type": "break", "duration": 90, "name": "Repos (90s)" },
                { "type": "exercise", "name": "Superset A: Pompes Pieds Sur√©lev√©s", "details": "S√©rie 1/3. Sac sur le dos. Amplitude compl√®te.", "reps": 9, "weight_text": "üéí +5 kg", "final_target_poids": "üéí +20 kg", "final_target_reps": "10" },
                { "type": "break", "duration": 15, "name": "Transition" },
                { "type": "exercise", "name": "Superset B: Ext. Triceps Overhead", "details": "S√©rie 1/3. Dos √† la porte. Coudes serr√©s.", "reps": 15, "weight_text": "üü¶ √âlastique 15kg", "final_target_poids": "üü™ √âlastique 25kg", "final_target_reps": "15" },
                { "type": "break", "duration": 60, "name": "Repos Superset (60s)" },
                { "type": "exercise", "name": "Superset A: Pompes Pieds Sur√©lev√©s", "details": "S√©rie 2/3. Touche le sol (ou presque).", "reps": 9, "weight_text": "üéí +5 kg", "final_target_poids": "üéí +20 kg", "final_target_reps": "10" },
                { "type": "break", "duration": 15, "name": "Transition" },
                { "type": "exercise", "name": "Superset B: Ext. Triceps Overhead", "details": "S√©rie 2/3. Extension compl√®te.", "reps": 15, "weight_text": "üü¶ √âlastique 15kg", "final_target_poids": "üü™ √âlastique 25kg", "final_target_reps": "15" },
                { "type": "break", "duration": 60, "name": "Repos Superset (60s)" },
                { "type": "exercise", "name": "Superset A: Pompes Pieds Sur√©lev√©s", "details": "S√©rie 3/3. Maximum de reps.", "reps": 9, "weight_text": "üéí +5 kg", "final_target_poids": "üéí +20 kg", "final_target_reps": "10" },
                { "type": "break", "duration": 15, "name": "Transition" },
                { "type": "exercise", "name": "Superset B: Ext. Triceps Overhead", "details": "S√©rie 3/3. Br√ªlure.", "reps": 15, "weight_text": "üü¶ √âlastique 15kg", "final_target_poids": "üü™ √âlastique 25kg", "final_target_reps": "15" },
                { "type": "break", "duration": 60, "name": "Repos (60s)" },
                { "type": "exercise", "name": "FINISHER: Curl Concentr√©", "details": "Bonus Pic Biceps. Double √©lastique. Au feeling.", "reps": 12, "weight_text": "üü™üü™ Double 25kg", "final_target_poids": "üü™üü™ Double 25kg", "final_target_reps": "20" }
              ]
            },
            {
              "nom_session": "S√âANCE B : THICKNESS & BICEPS",
              "description_session": "Focus : √âpaisseur du dos (Profil), Pecs bomb√©s et Biceps Face (#3).",
              "exercices_et_pauses": [
                { "type": "exercise", "name": "Pompes Classiques Lest√©es", "details": "S√©rie 1/3. Sac sur le dos. Amplitude max.", "reps": 10, "weight_text": "üéí +8 kg", "final_target_poids": "üéí +30 kg", "final_target_reps": "10" },
                { "type": "break", "duration": 90, "name": "Repos (90s)" },
                { "type": "exercise", "name": "Pompes Classiques Lest√©es", "details": "S√©rie 2/3. Contr√¥le la descente.", "reps": 10, "weight_text": "üéí +8 kg", "final_target_poids": "üéí +30 kg", "final_target_reps": "10" },
                { "type": "break", "duration": 90, "name": "Repos (90s)" },
                { "type": "exercise", "name": "Pompes Classiques Lest√©es", "details": "S√©rie 3/3. √âchec.", "reps": 10, "weight_text": "üéí +8 kg", "final_target_poids": "üéí +30 kg", "final_target_reps": "10" },
                { "type": "break", "duration": 90, "name": "Repos (90s)" },
                { "type": "exercise", "name": "Superset A: Rowing Swiss Ball", "details": "S√©rie 1/3. Dos √©paisseur. Tire les 2 poign√©es.", "reps": 12, "weight_text": "üü™ √âlastique 25kg", "final_target_poids": "üü™ 40kg (25+15)", "final_target_reps": "12" },
                { "type": "break", "duration": 15, "name": "Transition" },
                { "type": "exercise", "name": "Superset B: Curl Marteau", "details": "S√©rie 1/3. Largeur bras. Prise neutre.", "reps": 12, "weight_text": "üü¶ √âlastique 15kg", "final_target_poids": "üü™ √âlastique 25kg", "final_target_reps": "12" },
                { "type": "break", "duration": 75, "name": "Repos Superset (75s)" },
                { "type": "exercise", "name": "Superset A: Rowing Swiss Ball", "details": "S√©rie 2/3. Sortez la poitrine.", "reps": 12, "weight_text": "üü™ √âlastique 25kg", "final_target_poids": "üü™ 40kg (25+15)", "final_target_reps": "12" },
                { "type": "break", "duration": 15, "name": "Transition" },
                { "type": "exercise", "name": "Superset B: Curl Marteau", "details": "S√©rie 2/3. Contracte fort en haut.", "reps": 12, "weight_text": "üü¶ √âlastique 15kg", "final_target_poids": "üü™ √âlastique 25kg", "final_target_reps": "12" },
                { "type": "break", "duration": 75, "name": "Repos Superset (75s)" },
                { "type": "exercise", "name": "Superset A: Rowing Swiss Ball", "details": "S√©rie 3/3. Mouvement complet.", "reps": 12, "weight_text": "üü™ √âlastique 25kg", "final_target_poids": "üü™ 40kg (25+15)", "final_target_reps": "12" },
                { "type": "break", "duration": 15, "name": "Transition" },
                { "type": "exercise", "name": "Superset B: Curl Marteau", "details": "S√©rie 3/3. Br√ªlure.", "reps": 12, "weight_text": "üü¶ √âlastique 15kg", "final_target_poids": "üü™ √âlastique 25kg", "final_target_reps": "12" },
                { "type": "break", "duration": 90, "name": "Repos (90s)" },
                { "type": "exercise", "name": "Superset A: √âl√©vations Lat√©rales (Vol.)", "details": "S√©rie 1/2. Halt√®res l√©gers. S√©ries longues.", "reps": 20, "weight_text": "üèãÔ∏è 5 kg", "final_target_poids": "üèãÔ∏è 8 kg", "final_target_reps": "20" },
                { "type": "break", "duration": 15, "name": "Transition" },
                { "type": "exercise", "name": "Superset B: Face Pulls (Posture)", "details": "S√©rie 1/2. Ancrage HAUT. Tire vers le front.", "reps": 20, "weight_text": "üü¶ √âlastique 15kg", "final_target_poids": "üü™ √âlastique 25kg", "final_target_reps": "15" },
                { "type": "break", "duration": 60, "name": "Repos Superset (60s)" },
                { "type": "exercise", "name": "Superset A: √âl√©vations Lat√©rales (Vol.)", "details": "S√©rie 2/2. Congestion maximale.", "reps": 20, "weight_text": "üèãÔ∏è 5 kg", "final_target_poids": "üèãÔ∏è 8 kg", "final_target_reps": "20" },
                { "type": "break", "duration": 15, "name": "Transition" },
                { "type": "exercise", "name": "Superset B: Face Pulls (Posture)", "details": "S√©rie 2/2. Garde les coudes hauts.", "reps": 20, "weight_text": "üü¶ √âlastique 15kg", "final_target_poids": "üü™ √âlastique 25kg", "final_target_reps": "15" }
              ]
            }
          ]
        });

        const resistanceTypes = { 'poids': { emoji: 'üèãÔ∏è', text: 'Poids' }, 'elastique': { emoji: 'üßò', text: '√âlastique' }, 'pdc': { emoji: 'üí™', text: 'Poids du Corps' }, 'poids_elastique': { emoji: '‚ö°Ô∏è', text: 'Poids + √âlastique' }};

        // --- ETAT GLOBAL ---
        let tokenClient;
        let accessToken = null;
        let loadedFullProgram = null;
        let workoutHistory = [];
        let historyFileId = null;
        let programFileId = null;
        let gisCheckRetries = 0;
        let activeCharts = {};
        let isEditMode = false;
        let currentSummaryContext = { mode: 'workout', sessionName: null };
        let audioContext;
        
        // Timer
        let currentSession = null;
        let currentPlan = [];
        let currentIndex = 0;
        let timeLeft = 0;
        let timerInterval = null;
        let isTimerRunning = false;
        let currentState = 'idle'; 
        let workoutStartTime = null;

        // DOM
        const homeSection = document.getElementById('home-section');
        const workoutSection = document.getElementById('workout-section');
        const summaryModal = document.getElementById('post-workout-summary');
        const summaryList = document.getElementById('summary-items-list');
        const messageArea = document.getElementById('message-area');
        const timerDisplayElement = document.getElementById('timer-display-clickable');
        const timeLeftDisplay = document.getElementById('time-left');
        const exerciseNameDisplay = document.getElementById('current-exercise-name-display');
        const exerciseContainer = document.getElementById('current-exercise-container');
        const progressCircle = document.getElementById('timer-progress-indicator');
        
        // Sounds
        let soundLaser, sound5, sound4, sound3, sound2, sound1, soundET;

        // --- INIT ---
        window.onload = () => {
            initSounds();
            checkAndInitGis();
            document.getElementById('edit-program-btn').onclick = toggleEditMode;
            document.getElementById('signin-button').onclick = handleAuthClick;
            setupTimerControls();
        };

        function initSounds() {
            const bP = "https://ironworkout.github.io/armorworkout/";
            soundLaser = new Audio(bP + 'laser.mp3'); sound5 = new Audio(bP + '5.mp3'); 
            sound4 = new Audio(bP + '4.mp3'); sound3 = new Audio(bP + '3.mp3');
            sound2 = new Audio(bP + '2.mp3'); sound1 = new Audio(bP + '1.mp3'); soundET = new Audio(bP + 'e-t.mp3');
        }

        function initAudioContext() {
            if (!audioContext) { 
                try { audioContext = new (window.AudioContext || window.webkitAudioContext)(); } catch(e){}
            }
            if (audioContext && audioContext.state === 'suspended') audioContext.resume();
        }

        // --- DRIVE & AUTH ---
        function checkAndInitGis() {
            if(window.google && google.accounts && google.accounts.oauth2) {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CLIENT_ID,
                    scope: SCOPES,
                    callback: tokenCallback,
                });
                document.getElementById('signin-button').disabled = false;
                // Auto-login attempt
                tokenClient.requestAccessToken({ prompt: '' });
            } else if(gisCheckRetries < 20) {
                gisCheckRetries++;
                setTimeout(checkAndInitGis, 200);
            } else {
                showMessage("Erreur chargement Google API", 5000, true);
            }
        }

        function handleAuthClick() {
            initAudioContext();
            if(tokenClient) tokenClient.requestAccessToken({ prompt: 'consent' });
        }

        async function tokenCallback(resp) {
            if (resp.error) { console.warn("Auth:", resp); return; }
            accessToken = resp.access_token;
            document.body.classList.remove('logged-out');
            document.body.classList.add('logged-in');
            document.getElementById('drive-status').style.display = 'inline-flex';
            showMessage("Connect√©. Chargement...");
            
            await loadDataFromDrive();
            loadInProgressState();
            renderHomeScreen();
            document.getElementById('edit-program-btn').disabled = false;
        }

        async function loadDataFromDrive() {
            // History
            historyFileId = await findOrCreateFile(HISTORY_FILE, '[]');
            if(historyFileId) {
                const c = await readFile(historyFileId);
                workoutHistory = c ? JSON.parse(c) : [];
            }
            // Program
            programFileId = await findOrCreateFile(PROGRAM_FILE, DEFAULT_PROGRAM_CONTENT);
            if(programFileId) {
                const c = await readFile(programFileId);
                loadedFullProgram = c ? JSON.parse(c) : JSON.parse(DEFAULT_PROGRAM_CONTENT);
            }
        }

        async function findOrCreateFile(name, content) {
            if(!accessToken) return null;
            const q = `name='${name}' and trashed=false`;
            try {
                const search = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}`, { headers: { Authorization: `Bearer ${accessToken}` } });
                const d = await search.json();
                if(d.files && d.files.length > 0) return d.files[0].id;
                
                // Create
                const meta = { name: name, mimeType: 'application/json' };
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(meta)], { type: 'application/json' }));
                form.append('file', new Blob([content], { type: 'application/json' }));
                const create = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', { method: 'POST', headers: { Authorization: `Bearer ${accessToken}` }, body: form });
                const r = await create.json();
                return r.id;
            } catch(e) { console.error(e); return null; }
        }

        async function readFile(id) {
            const res = await fetch(`https://www.googleapis.com/drive/v3/files/${id}?alt=media`, { headers: { Authorization: `Bearer ${accessToken}` } });
            return res.ok ? await res.text() : null;
        }

        async function saveToDrive(id, data) {
            if(!accessToken || !id) return;
            await fetch(`https://www.googleapis.com/upload/drive/v3/files/${id}?uploadType=media`, {
                method: 'PATCH',
                headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
        }

        // --- HELPERS ---
        function showMessage(msg, time=3000, err=false) {
            messageArea.textContent = msg;
            messageArea.classList.add('visible');
            if(err) messageArea.style.borderColor = 'red';
            setTimeout(() => { messageArea.classList.remove('visible'); messageArea.style.borderColor = ''; }, time);
        }

        function formatTime(s) { const m = Math.floor(s/60); const sc = Math.floor(s%60); return `${m}:${sc<10?'0':''}${sc}`; }
        function parseWeight(t) { if(!t) return 0; const m = t.toString().match(/-?\d+(\.\d+)?/g); return m ? m.reduce((a,b)=>a+parseFloat(b),0) : 0; }
        function parseDesc(desc) {
            if(!desc) return {type:'pdc', value:0};
            const d = desc.toLowerCase();
            const v = parseWeight(desc);
            if(d.includes('√©lastique') || desc.includes('üßò')) return {type:'elastique', value:v};
            if(desc.includes('üéí') || desc.includes('sac')) return {type:'poids', value:v};
            if(d.includes('kg') || desc.includes('üèãÔ∏è')) return {type:'poids', value:v};
            return {type:'pdc', value:0};
        }

        function calculateMastery(currW, targW, currR, targR) {
            const cw = parseWeight(currW); const tw = parseWeight(targW);
            const cr = parseFloat(currR)||0; const tr = parseFloat(targR)||1;
            
            let wScore = 0;
            if(tw === 0 && isNaN(parseFloat(targW))) {
                // Text comparison (ex: "Debout")
                const c = (currW||"").toLowerCase(); const t = (targW||"").toLowerCase();
                wScore = c.includes(t) ? 100 : 0;
            } else {
                wScore = Math.min(100, (cw/tw)*100);
            }
            const rScore = Math.min(100, (cr/tr)*100);
            return (wScore + rScore) / 2;
        }

        // --- STATE & TIMER ---
        function loadSession(name) {
            initAudioContext();
            const s = loadedFullProgram.sessions.find(x => x.nom_session === name);
            if(!s) return;
            currentSession = s.nom_session;
            currentPlan = JSON.parse(JSON.stringify(s.exercices_et_pauses));
            currentIndex = 0;
            timeLeft = 0;
            currentState = 'preparing';
            workoutStartTime = Date.now();
            renderWorkoutScreen();
            startSequence();
        }

        function renderWorkoutScreen() {
            homeSection.classList.add('section-hidden');
            workoutSection.classList.remove('section-hidden');
            updateWorkoutUI();
        }

        function updateWorkoutUI() {
            const item = currentPlan[currentIndex];
            if(!item) return finishWorkout();

            exerciseNameDisplay.textContent = item.name || item.type;
            document.body.className = `logged-in state-${currentState}`;
            
            // Progress
            const total = currentPlan.length;
            const pct = ((currentIndex+1)/total) * 100;
            const dash = TIMER_PROGRESS_CIRCLE_CIRCUMFERENCE * (1 - pct/100);
            progressCircle.style.strokeDashoffset = dash;
            document.getElementById('workout-step-current-display').textContent = currentIndex + 1;
            document.getElementById('workout-step-total-display').textContent = total;

            if(item.type === 'exercise') {
                exerciseContainer.innerHTML = `
                    <div style="font-size:1.8em; color:var(--electric-blue); font-weight:700;">${item.reps} Reps</div>
                    <div style="color:#aaa; margin-top:5px;">${item.weight_text||''}</div>
                    <div style="color:var(--neon-purple); font-size:0.8em; margin-top:5px;">Cible: ${item.final_target_reps} x ${item.final_target_poids}</div>
                    <div style="color:#666; font-size:0.8em; margin-top:10px;">${item.details||''}</div>
                `;
            } else {
                exerciseContainer.innerHTML = `<div style="font-size:1.5em; color:var(--electric-cyan);">REPOS</div><div style="color:#aaa;">Prochain: ${currentPlan[currentIndex+1]?.name || 'Fin'}</div>`;
            }
            timeLeftDisplay.textContent = formatTime(timeLeft);
        }

        function startSequence() {
            clearInterval(timerInterval);
            const item = currentPlan[currentIndex];
            if(!item) { finishWorkout(); return; }

            if(currentState === 'preparing') {
                timeLeft = 5;
                isTimerRunning = true;
            } else if(currentState === 'break') {
                timeLeft = item.duration || 60;
                isTimerRunning = true;
            } else {
                // Exercise
                timeLeft = item.duration || 0; // 0 if reps based
                isTimerRunning = !!item.duration;
            }
            
            updateWorkoutUI();
            
            if(isTimerRunning) {
                timerInterval = setInterval(() => {
                    timeLeft--;
                    timeLeftDisplay.textContent = formatTime(timeLeft);
                    if(timeLeft <= 3 && timeLeft > 0) playSound(sound1);
                    if(timeLeft <= 0) {
                        playSound(soundLaser);
                        nextStep();
                    }
                }, 1000);
            }
        }

        function nextStep() {
            clearInterval(timerInterval);
            currentIndex++;
            if(currentIndex >= currentPlan.length) {
                finishWorkout();
            } else {
                const nextItem = currentPlan[currentIndex];
                currentState = nextItem.type === 'break' ? 'break' : 'exercise';
                startSequence();
                saveInProgressState();
            }
        }

        function finishWorkout() {
            currentState = 'finished';
            document.body.className = `logged-in state-finished`;
            playSound(soundET);
            saveInProgressState();
            populateAndShowSummary({mode:'workout', sessionName: currentSession});
        }

        function setupTimerControls() {
            document.getElementById('start-pause-btn').onclick = () => {
                if(isTimerRunning) { clearInterval(timerInterval); isTimerRunning = false; }
                else { startSequence(); }
            };
            document.getElementById('skip-btn').onclick = nextStep;
            document.getElementById('prev-btn').onclick = () => { if(currentIndex>0){currentIndex--; startSequence();} };
            document.getElementById('finish-btn').onclick = finishWorkout;
        }

        // --- STORAGE & RECOVERY ---
        function saveInProgressState() {
            if(currentState === 'finished') { localStorage.removeItem(IN_PROGRESS_KEY); return; }
            const s = { currentSession, currentPlan, currentIndex, timeLeft, currentState, startTime: workoutStartTime };
            localStorage.setItem(IN_PROGRESS_KEY, JSON.stringify(s));
        }

        function loadInProgressState() {
            const j = localStorage.getItem(IN_PROGRESS_KEY);
            if(j) {
                const s = JSON.parse(j);
                if(s.currentSession && s.currentPlan) {
                    currentSession = s.currentSession;
                    currentPlan = s.currentPlan;
                    currentIndex = s.currentIndex;
                    timeLeft = s.timeLeft;
                    currentState = s.currentState;
                    workoutStartTime = s.startTime;
                    renderWorkoutScreen();
                    showMessage("S√©ance restaur√©e");
                }
            }
        }

        // --- CHARTS & HOME ---
        function renderHomeScreen() {
            homeSection.innerHTML = '';
            homeSection.classList.remove('section-hidden');
            workoutSection.classList.add('section-hidden');

            const grid = document.createElement('div'); grid.className = 'home-grid';
            
            // Sidebar
            const sidebar = document.createElement('div'); sidebar.className = 'home-sidebar';
            sidebar.appendChild(renderConsistencyCalendarModule(new Date()));
            
            // Main
            const main = document.createElement('div'); main.className = 'home-main-content';
            
            if(loadedFullProgram && loadedFullProgram.sessions) {
                loadedFullProgram.sessions.forEach(s => {
                    const card = document.createElement('div');
                    card.className = 'session-card-large';
                    card.dataset.name = s.nom_session;
                    const cid = `radar-${s.nom_session.replace(/[^a-zA-Z0-9]/g,'')}`;
                    card.innerHTML = `
                        <div class="session-card-header"><h3>${s.nom_session}</h3></div>
                        <p>${s.description_session || ''}</p>
                        <div class="global-performance-chart-container">
                            <canvas id="${cid}"></canvas>
                        </div>
                    `;
                    card.onclick = (e) => {
                        if(isEditMode) populateAndShowSummary({mode:'edit', sessionName: s.nom_session});
                        else loadSession(s.nom_session);
                    };
                    main.appendChild(card);
                    setTimeout(() => renderRadarChart(document.getElementById(cid), s), 0);
                });
            }
            
            grid.appendChild(main);
            grid.appendChild(sidebar);
            homeSection.appendChild(grid);
        }

        function renderRadarChart(canvas, session) {
            const exercises = session.exercices_et_pauses.filter(e => e.type === 'exercise');
            const labels = exercises.map(e => e.name.substring(0, 12));
            const data = exercises.map(e => calculateMastery(e.weight_text, e.final_target_poids, e.reps, e.final_target_reps));
            
            if(activeCharts[canvas.id]) activeCharts[canvas.id].destroy();
            
            activeCharts[canvas.id] = new Chart(canvas, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Actuel', data: data, backgroundColor: 'rgba(0, 191, 255, 0.5)', borderColor: '#00BFFF', pointBackgroundColor: '#fff' },
                        { label: 'Cible', data: Array(labels.length).fill(100), borderColor: '#FFD700', borderDash: [5,5], fill: false, pointRadius: 0 }
                    ]
                },
                options: {
                    scales: { r: { min: 0, max: 100, ticks: { display: false }, grid: { color: 'rgba(255,255,255,0.1)' }, pointLabels: { color: '#aaa', font:{size:10} } } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderConsistencyCalendarModule(date) {
            const div = document.createElement('div');
            div.className = 'sidebar-module';
            
            // Calculate logic
            const streak = workoutHistory.length > 1 ? 2 : (workoutHistory.length ? 1 : 0); // Mock
            const league = "Bronze"; // Mock logic
            
            // Calendar
            const year = date.getFullYear(); const month = date.getMonth();
            const daysInMonth = new Date(year, month+1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay();
            const offset = (firstDay + 6) % 7;
            
            let grid = '';
            for(let i=0; i<offset; i++) grid += `<div></div>`;
            for(let d=1; d<=daysInMonth; d++) {
                const ds = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const has = workoutHistory.some(h => h.date.startsWith(ds));
                grid += `<div class="calendar-day ${has?'today':''}">
                    ${d} ${has ? '<span class="day-dot"></span>' : ''}
                </div>`;
            }

            div.innerHTML = `
                <h3><i class="fas fa-calendar"></i> Ligue ${league}</h3>
                <div class="consistency-info">
                    <div class="streak-counter"><i class="fas fa-fire"></i> ${streak} sem. cons√©cutives</div>
                    <div class="chart-area-container"><canvas id="area-chart"></canvas></div>
                </div>
                <div class="monthly-calendar">
                    <div class="calendar-header">L</div><div class="calendar-header">M</div><div class="calendar-header">M</div><div class="calendar-header">J</div><div class="calendar-header">V</div><div class="calendar-header">S</div><div class="calendar-header">D</div>
                    ${grid}
                </div>
            `;
            
            setTimeout(() => {
                const ctx = div.querySelector('#area-chart');
                if(ctx) {
                    const labels = workoutHistory.slice(-10).map(h => h.date.substring(5));
                    const data = workoutHistory.slice(-10).map(h => 50 + Math.random()*50); // Mock data for visual if empty
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels.length ? labels : ['Start'],
                            datasets: [{ data: data.length ? data : [0], fill: true, backgroundColor: 'rgba(57, 255, 20, 0.2)', borderColor: '#39FF14', tension: 0.4, pointRadius: 0 }]
                        },
                        options: { scales: { x:{display:false}, y:{display:false} }, plugins:{legend:{display:false}} }
                    });
                }
            }, 0);
            
            return div;
        }

        // --- SUMMARY & EDIT ---
        function toggleEditMode() {
            isEditMode = !isEditMode;
            document.getElementById('edit-program-btn').classList.toggle('active', isEditMode);
            showMessage(isEditMode ? "Mode √âdition Activ√©" : "Mode √âdition D√©sactiv√©");
        }

        function populateAndShowSummary(context) {
            currentSummaryContext = context;
            summaryList.innerHTML = '';
            
            let plan = [];
            if(context.mode === 'workout') plan = originalCompletedWorkoutPlan || currentPlan;
            else {
                const s = loadedFullProgram.sessions.find(x => x.nom_session === context.sessionName);
                plan = s ? JSON.parse(JSON.stringify(s.exercices_et_pauses)) : [];
            }

            plan.forEach((item, idx) => {
                if(item.type === 'exercise') {
                    const li = document.createElement('li');
                    li.className = 'summary-item';
                    
                    const score = calculateMastery(item.weight_text, item.final_target_poids, item.reps, item.final_target_reps);
                    if(score >= 100) li.classList.add('vibranium-mastered');
                    
                    const wParsed = parseDesc(item.weight_text);

                    li.innerHTML = `
                        ${score>=100 ? '<span class="badge-vibranium">VIBRANIUM</span>' : ''}
                        <div class="exercise-name">${item.name}</div>
                        <div class="fields-grid">
                            <!-- Col 1: Performance -->
                            <div style="background:rgba(0,191,255,0.05); padding:10px; border-radius:5px;">
                                <h4 style="margin:0 0 5px 0; color:var(--electric-blue); font-size:0.7em;">S√âANCE ACTUELLE</h4>
                                <div class="input-group">
                                    <label>Reps</label>
                                    <div class="stepper-control">
                                        <button class="stepper-btn" onclick="adjVal(${idx}, 'reps', -1)">-</button>
                                        <span class="stepper-value" id="val-reps-${idx}">${item.reps}</span>
                                        <button class="stepper-btn" onclick="adjVal(${idx}, 'reps', 1)">+</button>
                                    </div>
                                </div>
                                <div class="input-group" style="margin-top:5px;">
                                    <label>Charge</label>
                                    <div class="resistance-selector">
                                        <div class="selected-resistance" onclick="this.nextElementSibling.style.display='block'">
                                            <span>${resistanceTypes[wParsed.type].emoji}</span>
                                        </div>
                                        <ul class="resistance-options">
                                            <li onclick="setResType(${idx}, 'poids', this)">üèãÔ∏è Poids</li>
                                            <li onclick="setResType(${idx}, 'elastique', this)">üßò √âlastique</li>
                                            <li onclick="setResType(${idx}, 'pdc', this)">üí™ PDC</li>
                                        </ul>
                                    </div>
                                    ${wParsed.type !== 'pdc' ? `
                                    <div class="stepper-control">
                                        <button class="stepper-btn" onclick="adjVal(${idx}, 'weight', -0.5)">-</button>
                                        <span class="stepper-value" id="val-weight-${idx}">${wParsed.value}</span>
                                        <button class="stepper-btn" onclick="adjVal(${idx}, 'weight', 0.5)">+</button>
                                    </div>` : ''}
                                </div>
                            </div>

                            <!-- Col 2: Targets -->
                            <div style="background:rgba(255,215,0,0.05); padding:10px; border-radius:5px;">
                                <h4 style="margin:0 0 5px 0; color:#FFD700; font-size:0.7em;">OBJECTIF FINAL</h4>
                                <div class="input-group">
                                    <label>Cible Reps</label>
                                    <input type="number" class="goal-input" value="${item.final_target_reps || 12}" id="targ-reps-${idx}">
                                </div>
                                <div class="input-group" style="margin-top:5px;">
                                    <label>Cible Poids/Txt</label>
                                    <input type="text" class="goal-input" value="${item.final_target_poids || ''}" id="targ-weight-${idx}">
                                </div>
                            </div>
                        </div>
                    `;
                    summaryList.appendChild(li);
                }
            });
            summaryModal.classList.add('visible');
            
            // Temporary global handlers for the generated HTML
            window.currentEditingPlan = plan;
        }

        window.adjVal = function(idx, type, delta) {
            const item = window.currentEditingPlan[idx];
            if(type === 'reps') {
                item.reps = (parseInt(item.reps)||0) + delta;
                document.getElementById(`val-reps-${idx}`).textContent = item.reps;
            } else {
                // Parse existing, add delta, update display logic would go here
                // Simplified for this view: just update the text content for now
                const el = document.getElementById(`val-weight-${idx}`);
                let v = parseFloat(el.textContent) + delta;
                el.textContent = v;
                // Update item.weight_text would need full reconstruction
            }
        }
        
        window.setResType = function(idx, type, el) {
            el.parentElement.style.display = 'none';
            // Logic to update icon and show/hide stepper would go here
        }

        document.getElementById('finish-summary-btn').onclick = async () => {
            const plan = window.currentEditingPlan;
            // Read values back from DOM inputs for Targets
            plan.forEach((item, idx) => {
                if(item.type === 'exercise') {
                    const tr = document.getElementById(`targ-reps-${idx}`).value;
                    const tw = document.getElementById(`targ-weight-${idx}`).value;
                    item.final_target_reps = tr;
                    item.final_target_poids = tw;
                    // Note: Performance values should also be read back fully in production
                }
            });

            // Save to Loaded Program
            if(currentSummaryContext.sessionName) {
                const sIdx = loadedFullProgram.sessions.findIndex(s => s.nom_session === currentSummaryContext.sessionName);
                if(sIdx >= 0) loadedFullProgram.sessions[sIdx].exercices_et_pauses = plan;
            }

            // Save History if workout mode
            if(currentSummaryContext.mode === 'workout') {
                const log = { date: new Date().toISOString(), type: currentSession, exercises: plan.filter(e=>e.type==='exercise') };
                workoutHistory.push(log);
                await saveToDrive(historyFileId, workoutHistory);
            }

            await saveToDrive(programFileId, loadedFullProgram);
            summaryModal.classList.remove('visible');
            showMessage("Sauvegard√© !");
            renderHomeScreen();
        };

    </script>
</body>
</html>
  
