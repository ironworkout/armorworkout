<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArmorWorkout - Timer d'Entraînement</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        /* --- Variables Globales & Thèmes --- */
        :root {
            /* Thème Sombre */
            --bg-color-dark: #0D1117; --secondary-bg-color-dark: #161B22; --primary-text-color-dark: #c9d1d9; --secondary-text-color-dark: #8b949e; --border-color-dark: #30363d; --accent-border-color-dark: #58a6ff33; --input-bg-dark: #0d1117;
            /* Couleurs Néon */
            --neon-blue: #58a6ff; --neon-pink: #f778ba; --neon-red: #ff7b72; --neon-yellow: #facc15; --neon-green: #3fb950; --neon-purple: #bc8cff;
            /* Glows */
            --glow-blue: 0 0 12px rgba(88, 166, 255, 0.6); --glow-pink: 0 0 12px rgba(247, 120, 186, 0.6); --glow-red: 0 0 10px rgba(255, 123, 114, 0.6); --glow-yellow: 0 0 10px rgba(250, 204, 21, 0.5); --glow-green: 0 0 10px rgba(63, 185, 80, 0.6); --glow-purple: 0 0 12px rgba(188, 140, 255, 0.6);
            /* Couleurs par état */
            --color-exercise: var(--neon-pink); --glow-exercise: var(--glow-pink);
            --color-break: var(--neon-yellow); --glow-break: var(--glow-yellow);
            --color-prepare: var(--neon-yellow); --glow-prepare: var(--glow-yellow);
            --color-finished: var(--neon-green); --glow-finished: var(--glow-green);
            --color-paused: var(--neon-purple); --glow-paused: var(--glow-purple);
            --color-idle: var(--secondary-text-color-dark); --glow-idle: none;
            /* Autres */
            --font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; --border-radius-lg: 12px; --border-radius-md: 8px; --border-radius-sm: 6px; --transition-speed: 0.25s;
            /* Thème Sombre par Défaut */
            --bg-color: var(--bg-color-dark); --secondary-bg-color: var(--secondary-bg-color-dark); --primary-text-color: var(--primary-text-color-dark); --secondary-text-color: var(--secondary-text-color-dark); --border-color: var(--border-color-dark); --accent-border-color: var(--accent-border-color-dark); --input-bg: var(--input-bg-dark);
            /* Timer */
            --current-step-color: var(--color-idle); --current-step-glow: var(--glow-idle);
            --total-progress-gradient: var(--total-progress-bg, #2a2f36); --total-progress-bg: #2a2f36;
            /* Boutons Timer */
            --button-reset-color: var(--neon-red); --button-reset-glow: var(--glow-red); --button-next-color: var(--neon-purple); --button-next-glow: var(--glow-purple); --button-end-color: var(--secondary-text-color-dark); --button-end-glow: none; --button-start-color: var(--neon-blue); --button-start-glow: var(--glow-blue); --button-pause-color: var(--color-paused); --button-pause-glow: var(--glow-paused); --button-resume-color: var(--color-paused); --button-resume-glow: var(--glow-paused); --button-done-color: var(--color-exercise); --button-done-glow: var(--glow-exercise);
            /* Boutons Connexion */
            --button-connect-color: var(--neon-green); --button-connect-glow: var(--glow-green); --button-disconnect-color: var(--neon-red); --button-disconnect-glow: var(--glow-red); --link-color: var(--neon-blue);
            /* RGBA */
            --neon-blue-rgb: 88, 166, 255; --neon-red-rgb: 255, 123, 114; --neon-green-rgb: 63, 185, 80; --neon-purple-rgb: 188, 140, 255; --secondary-text-color-dark-rgb: 139, 148, 158; --bg-color-dark-rgb: 13, 17, 23; --secondary-bg-color-dark-rgb: 22, 27, 34; --primary-text-color-dark-rgb: 201, 209, 217; --color-exercise-rgb: 247, 120, 186; --color-break-rgb: 250, 204, 21; --color-prepare-rgb: 250, 204, 21; --color-finished-rgb: 63, 185, 80; --color-paused-rgb: 188, 140, 255; --color-idle-rgb: 139, 148, 158;
        }
        body.light-theme {
            /* Thème Clair */
            --bg-color: #ffffff; --secondary-bg-color: #f6f8fa; --primary-text-color: #24292f; --secondary-text-color: #57606a; --border-color: #d0d7de; --accent-border-color: #0969da33; --input-bg: #f6f8fa;
            /* Couleurs Néon */
            --neon-blue: #0969da; --neon-pink: #bf3989; --neon-red: #d73a49; --neon-yellow: #dbab09; --neon-green: #2da44e; --neon-purple: #8250df;
            /* Glows */
            --glow-blue: 0 0 8px rgba(9, 105, 218, 0.3); --glow-pink: 0 0 8px rgba(191, 57, 137, 0.3); --glow-red: 0 0 8px rgba(215, 58, 73, 0.3); --glow-yellow: 0 0 8px rgba(219, 171, 9, 0.3); --glow-green: 0 0 8px rgba(45, 164, 78, 0.3); --glow-purple: 0 0 8px rgba(130, 80, 223, 0.3);
            --total-progress-bg: #e1e4e8; --button-end-color: #57606a; --link-color: #0969da;
            /* RGBA */
            --bg-color-dark-rgb: 255, 255, 255; --secondary-bg-color-dark-rgb: 246, 248, 250; --primary-text-color-dark-rgb: 36, 41, 47; --secondary-text-color-dark-rgb: 87, 96, 106; --color-exercise-rgb: 191, 57, 137; --color-break-rgb: 219, 171, 9; --color-prepare-rgb: 219, 171, 9; --color-finished-rgb: 45, 164, 78; --color-paused-rgb: 130, 80, 223; --color-idle-rgb: 87, 96, 106;
        }
        /* --- Styles Base & Reset --- */
        * { box-sizing: border-box; margin: 0; padding: 0; } html { scroll-behavior: smooth; font-size: 16px; }
        body { font-family: var(--font-family); background-color: var(--bg-color); color: var(--primary-text-color); line-height: 1.6; transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease; display: flex; flex-direction: column; min-height: 100vh; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; overflow-x: hidden; }
        .container { max-width: 1100px; margin: 0 auto; padding: 30px 25px; width: 100%; flex-grow: 1; display: flex; flex-direction: column; }
        /* --- Header --- */
        header { padding: 15px 0; border-bottom: 1px solid var(--border-color); transition: border-color var(--transition-speed) ease, background-color var(--transition-speed) ease; position: sticky; top: 0; z-index: 1000; background-color: rgba(var(--bg-color-dark-rgb), 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1100px; margin: 0 auto; padding: 0 25px; flex-wrap: wrap; gap: 15px 20px; }
        header h1 { font-size: 1.5em; color: var(--primary-text-color); margin: 0; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        header h1 i { color: var(--neon-blue); animation: pulse 2s infinite ease-in-out; } @keyframes pulse { 0%,100%{transform: scale(1); opacity: .8} 50%{transform: scale(1.1); opacity: 1} }
        /* --- Navigation Header --- */
        nav ul { list-style: none; display: flex; gap: 25px; flex-wrap: wrap; justify-content: center; align-items: center; }
        nav button { background: none; border: none; color: var(--secondary-text-color); font-size: 1em; font-weight: 500; padding: 5px 0; cursor: pointer; transition: color var(--transition-speed) ease, box-shadow var(--transition-speed) ease, border-color var(--transition-speed) ease; position: relative; border-bottom: 2px solid transparent; }
        nav button:disabled { color: rgba(var(--secondary-text-color-dark-rgb), 0.5); cursor: not-allowed; border-bottom-color: transparent !important; box-shadow: none !important; opacity: 0.6; }
        nav button:not(:disabled):hover { color: var(--primary-text-color); } nav button.active { color: var(--neon-blue); font-weight: 700; border-bottom-color: var(--neon-blue); box-shadow: 0 5px 15px -5px rgba(var(--neon-blue-rgb), 0.4); }
        #nav-history { color: var(--secondary-text-color); } #nav-history:hover:not(:disabled) { color: var(--neon-pink); }
        #nav-history.active { color: var(--neon-pink); border-bottom-color: var(--neon-pink); box-shadow: 0 5px 15px -5px rgba(var(--neon-pink-rgb), 0.4); } #nav-history i { margin-right: 5px; }
        /* --- Header Actions --- */
        .header-actions { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
        .auth-controls { display: flex; gap: 10px; align-items: center; }
        .auth-controls button { background: none; border: 1px solid var(--accent-border-color); color: var(--secondary-text-color); padding: 6px 14px; border-radius: var(--border-radius-md); font-size: 0.85em; font-weight: 500; cursor: pointer; transition: all var(--transition-speed) ease; display: inline-flex; align-items: center; gap: 6px; }
        .auth-controls button:disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; } .auth-controls button:not(:disabled):hover { border-color: var(--primary-text-color); color: var(--primary-text-color); }
        #signin-button { border-color: var(--button-connect-color); color: var(--button-connect-color); } #signin-button:not(:disabled):hover { background-color: rgba(var(--neon-green-rgb), 0.1); box-shadow: var(--glow-green); border-color: var(--neon-green); }
        #signout-button { border-color: var(--button-disconnect-color); color: var(--button-disconnect-color); } #signout-button:not(:disabled):hover { background-color: rgba(var(--neon-red-rgb), 0.1); box-shadow: var(--glow-red); border-color: var(--neon-red); }
        #drive-status { font-size: 0.8em; color: var(--secondary-text-color); margin-left: 5px; transition: opacity 0.3s, color 0.3s, border-color 0.3s; min-width: fit-content; text-align: right; padding: 4px 8px; background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.5); border-radius: var(--border-radius-sm); border: 1px solid var(--border-color); display: none; }
        #drive-status.loading { color: var(--neon-yellow); border-color: var(--neon-yellow); } #drive-status.error { color: var(--neon-red); border-color: var(--neon-red); } #drive-status.success { color: var(--neon-green); border-color: var(--neon-green); }
        .theme-toggle button { background: none; border: none; color: var(--secondary-text-color); font-size: 1.2em; padding: 5px; cursor: pointer; transition: color var(--transition-speed) ease; } .theme-toggle button:hover { color: var(--neon-yellow); }
        /* --- Affichage Connexion/Déconnexion --- */
        body.logged-out #signin-button { display: inline-flex; } body.logged-out #signout-button { display: none; } body.logged-out #drive-status { display: none; } body.logged-out .history-actions { display: none !important; } body.logged-out #drive-connection-status-main { display: none; }
        body.logged-in #signin-button { display: none; } body.logged-in #signout-button { display: inline-flex; } body.logged-in #drive-status { display: inline-block; } body.logged-in .history-actions { display: flex !important; } body.logged-in #drive-connection-status-main { display: inline-flex; }
        /* --- Contenu Principal --- */
        main { flex-grow: 1; display: flex; flex-direction: column; align-items: center; padding-top: 50px; position: relative; }
        .workout-section, .history-section { width: 100%; margin-bottom: 40px; transition: transform 0.4s ease, opacity 0.4s ease, max-height 0.4s ease; }
        .workout-section { max-width: 600px; text-align: center; }
        .history-section { max-width: 850px; background-color: var(--secondary-bg-color); padding: 30px; border-radius: var(--border-radius-lg); border: 1px solid var(--border-color); }
        .section-hidden { transform: scale(0.95) translateY(20px); opacity: 0; pointer-events: none; max-height: 0; padding: 0 !important; margin-bottom: 0 !important; border: none !important; overflow: hidden; }
        /* --- Timer --- */
        .timer-display { margin-bottom: 40px; position: relative; display: flex; justify-content: center; align-items: center; width: 300px; height: 300px; margin-left: auto; margin-right: auto; cursor: pointer; user-select: none; -webkit-tap-highlight-color: transparent; }
        .timer-circle-container { position: relative; width: 100%; height: 100%; pointer-events: none; }
        #total-progress-circle, .timer-circle { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; display: flex; justify-content: center; align-items: center; border: 10px solid transparent; background-clip: padding-box; background-origin: border-box; }
        #total-progress-circle { border-color: var(--total-progress-bg); background: var(--total-progress-gradient, var(--total-progress-bg)); box-shadow: 0 0 20px rgba(var(--neon-blue-rgb), 0.2), 0 0 30px rgba(var(--neon-pink-rgb), 0.15), inset 0 0 15px rgba(var(--bg-color-dark-rgb), 0.4); z-index: 1; transition: background 0.3s linear; }
        .timer-circle { width: calc(100% - 40px); height: calc(100% - 40px); top: 20px; left: 20px; border-color: var(--border-color); background-image: conic-gradient(var(--current-step-color, var(--color-idle)) 0%, transparent 0%); box-shadow: var(--current-step-glow, var(--glow-idle)), inset 0 0 12px rgba(var(--bg-color-dark-rgb), 0.5); z-index: 3; transition: background-image 0.15s linear, box-shadow var(--transition-speed) ease, border-color var(--transition-speed) ease; }
        .timer-circle::before { content: ''; position: absolute; width: calc(100% - 20px); height: calc(100% - 20px); background-color: var(--bg-color); border-radius: 50%; z-index: 4; transition: background-color var(--transition-speed) ease; }
        .time-left { font-size: 5em; font-weight: 900; color: var(--primary-text-color); z-index: 5; transition: color var(--transition-speed) ease; font-variant-numeric: tabular-nums; text-shadow: 0 0 8px rgba(var(--primary-text-color-dark-rgb), 0.2); }
        .timer-state { position: absolute; bottom: 18%; font-size: 0.9em; letter-spacing: 0.08em; color: var(--current-step-color, var(--color-idle)); font-weight: 500; text-transform: uppercase; opacity: 0; transition: opacity 0.3s ease, color var(--transition-speed) ease; z-index: 6; text-shadow: 0 0 6px rgba(var(--bg-color-dark-rgb), 0.6); }
        .timer-state.visible { opacity: 0.9; } .timer-state.preparing { animation: countdown-pulse 1s infinite; font-size: 1.05em; }
        /* --- Infos Workout --- */
        .workout-info { margin-bottom: 35px; min-height: 90px; position: relative; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        #current-exercise-name-display { display: block; font-size: 1.3em; font-weight: 700; color: var(--primary-text-color); margin-bottom: 6px; padding: 0 10px; min-height: 1.4em; transition: color 0.3s ease; }
        body.state-exercise #current-exercise-name-display { color: var(--color-exercise); } body.state-break #current-exercise-name-display { color: var(--color-break); } body.state-paused #current-exercise-name-display { color: var(--color-paused); } body.state-preparing #current-exercise-name-display { color: var(--color-prepare); } body.state-finished #current-exercise-name-display { color: var(--color-finished); }
        #current-exercise-container { display: flex; flex-direction: column; align-items: center; gap: 6px; font-size: 1.05em; color: var(--secondary-text-color); min-height: 2.5em; width: 100%; }
        #current-exercise-container .exercise-details, #current-exercise-container .break-info, #current-exercise-container .idle-message { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 8px 18px; background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.3); padding: 8px 15px; border-radius: var(--border-radius-md); border: 1px solid var(--border-color); width: fit-content; max-width: 90%; transition: background-color 0.3s ease, border-color 0.3s ease; }
        #current-exercise-container .exercise-details span, #current-exercise-container .break-info span { display: flex; align-items: center; gap: 5px; font-weight: 500; }
        #current-exercise-container .exercise-details span i { color: var(--color-exercise); } #current-exercise-container .break-info i { color: var(--color-break); }
        #current-exercise-container .exercise-details .details-text { font-size: 0.85em; opacity: 0.8; } #current-exercise-container .idle-message { border-style: dashed; opacity: 0.7; }
        /* --- Progress Tracker --- */
        .progress-tracker { font-size: 0.85em; color: var(--secondary-text-color); margin-top: 25px; opacity: 0.8; font-weight: 500; display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 5px 12px; min-height: 1.1em; }
        #drive-connection-status-main { align-items: center; gap: 5px; } #drive-connection-status-main i.fa-google-drive { color: var(--neon-green); font-size: 1em; } #drive-connection-status-main i.fa-spin { animation: fa-spin 2s linear infinite; } #progress-text-area { font-weight: 500; }
        /* --- Contrôles Timer --- */
        .controls { display: flex; justify-content: center; gap: 12px; margin-top: 30px; flex-wrap: wrap; }
        .controls button { background: transparent; border: 2px solid var(--accent-border-color); color: var(--primary-text-color); min-width: 100px; padding: 9px 18px; border-radius: var(--border-radius-lg); font-size: 1em; font-weight: 500; cursor: pointer; transition: all var(--transition-speed) ease; display: inline-flex; align-items: center; justify-content: center; gap: 7px; }
        .controls button i { font-size: 0.85em; transition: transform 0.2s ease; }
        .controls button:disabled { border-color: var(--border-color) !important; color: var(--secondary-text-color) !important; opacity: 0.5; cursor: not-allowed; box-shadow: none !important; transform: none !important; background-color: transparent !important; pointer-events: none; }
        .controls button:not(:disabled):hover { transform: translateY(-1px); box-shadow: 0 3px 6px rgba(0,0,0,0.1); } .controls button:not(:disabled):hover i { transform: scale(1.05); } .controls button:not(:disabled):active { transform: scale(0.98); }
        /* Styles spécifiques boutons */
        #start-pause-btn.start-btn { border-color: var(--button-start-color); color: var(--button-start-color); } #start-pause-btn.start-btn:not(:disabled):hover { box-shadow: var(--glow-blue), 0 3px 6px rgba(0,0,0,0.1); background-color: rgba(var(--neon-blue-rgb), 0.08); }
        #start-pause-btn.pause-btn { border-color: var(--button-pause-color); color: var(--button-pause-color); } #start-pause-btn.pause-btn:not(:disabled):hover { box-shadow: var(--glow-paused), 0 3px 6px rgba(0,0,0,0.1); background-color: rgba(var(--color-paused-rgb), 0.08); }
        #start-pause-btn.resume-btn { border-color: var(--button-resume-color); color: var(--button-resume-color); } #start-pause-btn.resume-btn:not(:disabled):hover { box-shadow: var(--glow-paused), 0 3px 6px rgba(0,0,0,0.1); background-color: rgba(var(--color-paused-rgb), 0.08); }
        #start-pause-btn.done-btn { border-color: var(--button-done-color); color: var(--button-done-color); } #start-pause-btn.done-btn:not(:disabled):hover { box-shadow: var(--glow-exercise), 0 3px 6px rgba(0,0,0,0.1); background-color: rgba(var(--color-exercise-rgb), 0.08); }
        #start-pause-btn.finished-btn { border-color: var(--color-finished); color: var(--color-finished); } #start-pause-btn.finished-btn:not(:disabled):hover { box-shadow: var(--glow-finished), 0 3px 6px rgba(0,0,0,0.1); background-color: rgba(var(--color-finished-rgb), 0.08); }
        #start-pause-btn.preparing-btn { border-color: var(--color-prepare); color: var(--color-prepare); opacity: 0.7; cursor: default; }
        #skip-btn { border-color: var(--button-next-color); color: var(--button-next-color); } #skip-btn:not(:disabled):hover { box-shadow: var(--glow-purple), 0 3px 6px rgba(0,0,0,0.1); background-color: rgba(var(--neon-purple-rgb), 0.08); }
        #finish-btn { border-color: var(--button-end-color); color: var(--button-end-color); } #finish-btn:not(:disabled):hover { background-color: rgba(var(--secondary-text-color-dark-rgb), 0.1); border-color: var(--primary-text-color); color: var(--primary-text-color); box-shadow: 0 3px 6px rgba(0,0,0,0.1); }
        #reset-btn { border-color: var(--button-reset-color); color: var(--button-reset-color); } #reset-btn:not(:disabled):hover { box-shadow: var(--glow-red), 0 3px 6px rgba(0,0,0,0.1); background-color: rgba(var(--neon-red-rgb), 0.08); }
        /* --- Section Historique --- */
        .history-section h2 { color: var(--primary-text-color); margin-bottom: 20px; text-align: center; font-size: 1.4em; }
        .history-controls { padding-bottom: 18px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; }
        .history-filters { display: flex; gap: 8px; flex-wrap: wrap; } .history-filters button { background: transparent; border: 1px solid var(--accent-border-color); color: var(--secondary-text-color); font-size: 0.8em; padding: 5px 10px; border-radius: var(--border-radius-md); cursor: pointer; transition: all var(--transition-speed) ease; display: inline-flex; align-items: center; gap: 4px; }
        .history-filters button:not(:disabled):hover { border-color: var(--primary-text-color); color: var(--primary-text-color); background-color: rgba(var(--secondary-text-color-dark-rgb), 0.1); } .history-filters button.active { border-color: var(--neon-blue); color: var(--neon-blue); background-color: rgba(var(--neon-blue-rgb), 0.1); font-weight: 500; box-shadow: var(--glow-blue); }
        .history-actions { display: flex; gap: 12px; align-items: center; color: var(--secondary-text-color); } .history-actions i.fa-google-drive { color: var(--neon-green); font-size: 1.05em; } #history-drive-status { font-size: 0.75em; padding: 3px 5px; background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.5); border-radius: var(--border-radius-sm); border: 1px solid var(--border-color); }
        .chart-container { height: 300px; margin-bottom: 25px; border: 1px solid var(--border-color); border-radius: var(--border-radius-md); padding: 12px; position: relative; } #chart-placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--secondary-text-color); font-style: italic; text-align: center; padding: 0 10px; font-size: 0.9em; }
        .stats-display { margin-bottom: 25px; padding: 18px; border: 1px solid var(--border-color); border-radius: var(--border-radius-md); } .stats-display h3 { color: var(--primary-text-color); margin-bottom: 12px; font-size: 1.1em;}
        .stats-display .content-wrapper p { margin-bottom: 6px; display: flex; align-items: center; gap: 7px; font-size: 0.95em;} .stats-display .content-wrapper p i { width: 15px; text-align: center; color: var(--neon-blue); opacity: 0.8;} .stats-display .content-wrapper p strong { color: var(--primary-text-color); font-weight: 500; } .stats-display .content-wrapper p:last-child { margin-bottom: 0; } .stats-display .motivational-message { font-style: italic; font-weight: 500; margin-top: 12px !important; background: linear-gradient(90deg, var(--neon-green), var(--neon-blue)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; font-size: 0.95em; }
        .history-list { list-style: none; border: 1px solid var(--border-color); border-radius: var(--border-radius-md); max-height: 350px; overflow-y: auto; }
        .history-list li { display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; border-bottom: 1px solid var(--border-color); transition: background-color 0.2s ease; gap: 12px; flex-wrap: wrap; } .history-list li:last-child { border-bottom: none; } .history-list li:nth-child(even) { background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.3); } .history-list li:hover { background-color: rgba(var(--neon-blue-rgb), 0.08); }
        .history-item-date { color: var(--primary-text-color); font-size: 0.85em; flex-shrink: 0; } .history-item-date small { color: var(--secondary-text-color); font-size: 0.9em;}
        .history-item-type { color: var(--neon-pink); background-color: rgba(var(--neon-pink-rgb), 0.1); border-radius: var(--border-radius-sm); padding: 3px 7px; font-size: 0.8em; font-weight: 500; text-align: center; min-width: 45px; flex-shrink: 0; margin: 4px 0; }
        .history-item-duration { color: var(--neon-blue); font-weight: 500; font-variant-numeric: tabular-nums; flex-shrink: 0; margin-left: auto; margin: 4px 0; font-size: 0.9em; }
        .history-list .no-history { color: var(--secondary-text-color); text-align: center; padding: 25px 15px; font-style: italic; border: none; background: none !important; font-size: 0.9em; }
        /* --- Résumé Post-Workout (MODAL) --- */
        .post-workout-summary { position: fixed; inset: 0; background-color: rgba(var(--bg-color-dark-rgb), 0.85); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; opacity: 0; visibility: hidden; pointer-events: none; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .post-workout-summary.visible { opacity: 1; visibility: visible; pointer-events: auto; }
        .post-workout-summary-content { background-color: var(--secondary-bg-color); border: 1px solid var(--border-color); border-radius: var(--border-radius-lg); box-shadow: 0 10px 30px rgba(0,0,0,0.3); width: 100%; max-width: 650px; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; transform: scale(0.95); transition: transform 0.3s ease; }
        .post-workout-summary.visible .post-workout-summary-content { transform: scale(1); }
        .post-workout-summary h2 { color: var(--primary-text-color); font-size: 1.4em; font-weight: 700; padding: 18px 22px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; text-align: center; background-color: rgba(var(--bg-color-dark-rgb), 0.2); }
        .summary-items-list { list-style: none; padding: 8px 22px; overflow-y: auto; flex-grow: 1; background: var(--bg-color); border-bottom: 1px solid var(--border-color); }
        .summary-item { border-bottom: 1px solid var(--border-color); padding: 15px 0; display: grid; grid-template-columns: auto 1fr auto; gap: 8px 12px; align-items: center; } .summary-item:last-child { border-bottom: none; }
        .summary-item h4 { grid-column: 1 / -1; color: var(--primary-text-color); font-size: 1.1em; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; } .summary-item h4 i { width: 18px; text-align: center; font-size: 1em; }
        .summary-item.item-type-exercise h4 i { color: var(--color-exercise); } .summary-item.item-type-break h4 i { color: var(--color-break); }
        .summary-item label { grid-column: 2 / 3; color: var(--secondary-text-color); font-size: 0.85em; font-weight: 500; white-space: nowrap; text-align: left; padding-left: 4px; }
        .summary-item .input-container { grid-column: 3 / 4; display: flex; align-items: center; gap: 6px; }
        .summary-item input[type="number"], .summary-item textarea { background-color: var(--input-bg); border: 1px solid var(--border-color); color: var(--primary-text-color); border-radius: var(--border-radius-sm); padding: 7px 10px; font-size: 0.95em; width: 100%; transition: border-color var(--transition-speed) ease, background-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease; }
        .summary-item input[type="number"] { width: 60px; text-align: center; flex-shrink: 0; -moz-appearance: textfield; } .summary-item input[type="number"]::-webkit-outer-spin-button, .summary-item input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .summary-item input:focus, .summary-item textarea:focus { border-color: var(--neon-blue); background-color: var(--bg-color); outline: none; box-shadow: 0 0 0 3px rgba(var(--neon-blue-rgb), 0.3); }
        .summary-item textarea { min-height: 40px; resize: vertical; width: 100%; } .summary-item .details-container { grid-column: 1 / -1; margin-top: 4px; } .summary-item .details-container label { display: block; text-align: left; margin-bottom: 3px; font-size: 0.8em; color: var(--secondary-text-color); padding-left: 0; } .summary-item p { grid-column: 2 / -1; color: var(--primary-text-color); font-weight: 500; padding-left: 4px; font-size: 0.95em; }
        .rep-adjust-btn { background-color: var(--secondary-bg-color); border: 1px solid var(--border-color); color: var(--primary-text-color); border-radius: 50%; width: 26px; height: 26px; font-size: 0.9em; line-height: 24px; text-align: center; cursor: pointer; transition: all var(--transition-speed) ease; flex-shrink: 0; } .rep-adjust-btn:hover { background-color: var(--accent-border-color); border-color: var(--neon-blue); color: var(--neon-blue); } .rep-adjust-btn:active { transform: scale(0.95); }
        .summary-controls { padding: 18px 22px; display: flex; justify-content: flex-end; gap: 12px; flex-shrink: 0; flex-wrap: wrap; border-top: 1px solid var(--border-color); background-color: rgba(var(--bg-color-dark-rgb), 0.2); }
        .summary-controls button { border: none; color: white; min-width: 140px; padding: 9px 20px; border-radius: var(--border-radius-md); font-size: 0.95em; font-weight: 500; cursor: pointer; transition: all var(--transition-speed) ease; display: inline-flex; align-items: center; justify-content: center; gap: 7px; box-shadow: 0 2px 4px rgba(0,0,0,0.15); }
        .summary-controls button:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; background-color: var(--secondary-text-color) !important; }
        .summary-controls button:not(:disabled):hover { filter: brightness(1.1); box-shadow: 0 3px 8px rgba(0,0,0,0.2); transform: translateY(-1px); } .summary-controls button:not(:disabled):active { filter: brightness(0.95); transform: translateY(0); box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        #confirm-summary-btn { background-color: var(--neon-green); } #discard-summary-btn { background-color: var(--neon-red); } #close-summary-btn { background-color: var(--secondary-text-color); display: none; }
        /* --- Animation Fin --- */
        .timer-display.finished-animation .timer-circle { animation: finish-circle-glow 1.2s ease-out forwards; }
        @keyframes finish-circle-glow { 0% { box-shadow: var(--current-step-glow), inset 0 0 12px rgba(var(--bg-color-dark-rgb),0.5); border-color: var(--border-color); } 50% { box-shadow: 0 0 30px 12px rgba(var(--color-finished-rgb),0.6), inset 0 0 12px rgba(var(--bg-color-dark-rgb),0.4); border-color: var(--color-finished); } 100% { box-shadow: var(--glow-finished), inset 0 0 12px rgba(var(--bg-color-dark-rgb),0.5); border-color: var(--color-finished); } }
        /* --- Messages Flottants --- */
        .message-area { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.9); color: var(--primary-text-color); border: 1px solid var(--border-color); padding: 10px 20px; border-radius: var(--border-radius-md); z-index: 3000; opacity: 0; transition: opacity 0.4s ease, transform 0.4s ease, bottom 0.4s ease; pointer-events: none; font-size: 0.9em; box-shadow: 0 3px 12px rgba(0,0,0,0.2); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); max-width: 90%; text-align: center; }
        .message-area.visible { opacity: 1; transform: translate(-50%, 0); bottom: 35px; pointer-events: auto; }
        /* --- Footer --- */
        footer { color: var(--secondary-text-color); opacity: 0.7; border-top: 1px solid var(--border-color); margin-top: 50px; padding: 20px; text-align: center; font-size: 0.9em; }
        footer a { color: var(--link-color); text-decoration: none; } footer a:hover { color: var(--primary-text-color); text-decoration: underline; } footer .fab.fa-google-drive { color: #4CAF50; }
        /* --- Responsive --- */
        @media (max-width: 768px) { .timer-display { width: 280px; height: 280px; } .timer-circle { width: calc(100% - 36px); height: calc(100% - 36px); top: 18px; left: 18px; border-width: 9px; } .timer-circle::before { width: calc(100% - 18px); height: calc(100% - 18px); } .time-left { font-size: 4.5em; } #total-progress-circle { border-width: 9px; } .history-controls { flex-direction: column; align-items: stretch; gap: 12px; } .history-actions { justify-content: center; } .chart-container { height: 280px; } .post-workout-summary-content { max-width: 95%; max-height: 85vh; } .summary-controls button { min-width: 130px; } }
        @media (max-width: 480px) { header h1 { font-size: 1.1em; } nav ul { gap: 8px; } .header-content { justify-content: center; } .header-actions { justify-content: center; } .auth-controls { flex-wrap: wrap; justify-content: center; } .timer-display { width: 220px; height: 220px; margin-bottom: 30px; } .timer-circle { width: calc(100% - 28px); height: calc(100% - 28px); top: 14px; left: 14px; border-width: 7px; } .timer-circle::before { width: calc(100% - 14px); height: calc(100% - 14px); } .time-left { font-size: 3.5em; } #total-progress-circle { border-width: 7px; } .workout-info { min-height: 70px; margin-bottom: 25px; } #current-exercise-name-display { font-size: 1.1em; } #current-exercise-container { font-size: 0.95em; } .controls { gap: 8px; margin-top: 25px; flex-direction: column; align-items: stretch; } .controls button { width: 100%; padding: 10px; } .history-section { padding: 15px; } .history-controls { padding-bottom: 12px; margin-bottom: 15px;} .history-filters button { font-size: 0.75em; padding: 4px 8px; } .chart-container { height: 250px; } .stats-display { padding: 10px; font-size: 0.85em;} .history-list li { font-size: 0.85em; flex-direction: column; align-items: flex-start; gap: 4px; } .post-workout-summary-content { max-width: 100%; max-height: 90vh; } .post-workout-summary h2 { font-size: 1.1em; padding: 10px 12px;} .summary-items-list { padding: 6px 12px; } .summary-item { grid-template-columns: auto 1fr; gap: 4px 8px; padding: 10px 0; } .summary-controls { flex-direction: column; gap: 8px; } .summary-controls button { width: 100%; } }
    </style>
</head>
<body class="logged-out dark-theme state-idle">

<header>
    <div class="header-content">
        <h1><i class="fas fa-shield-halved"></i> ArmorWorkout</h1>
        <nav>
            <ul>
                <li><button id="nav-push" data-workout="Push" disabled>Push</button></li>
                <li><button id="nav-pull" data-workout="Pull" disabled>Pull</button></li>
                <li><button id="nav-legs" data-workout="Legs" disabled>Legs</button></li>
                <li><button id="nav-history"><i class="fas fa-history"></i> Historique</button></li>
            </ul>
        </nav>
        <div class="header-actions">
            <div class="auth-controls">
                <button id="signin-button"><i class="fab fa-google"></i> Connecter Drive</button>
                <button id="signout-button"><i class="fas fa-sign-out-alt"></i> Déconnecter</button>
            </div>
            <span id="drive-status"></span>
            <div class="theme-toggle">
                <button id="theme-toggle-btn" aria-label="Basculer le thème"><i class="fas fa-sun"></i></button>
            </div>
        </div>
    </div>
</header>

<div class="container">
    <main>
        <div class="workout-section" id="workout-section">
            <div class="timer-display" id="timer-display-clickable">
                <div class="timer-circle-container">
                    <div id="total-progress-circle"></div>
                    <div class="timer-circle" id="timer-circle">
                        <span class="time-left" id="time-left">00:00</span>
                    </div>
                </div>
                <div class="timer-state" id="timer-state"></div>
            </div>
            <div class="workout-info" id="workout-info">
                <div id="current-exercise-name-display">ArmorWorkout</div>
                <div id="current-exercise-container">
                    <div class="idle-message"><i class="fas fa-info-circle"></i> Connectez-vous.</div>
                </div>
            </div>
            <div class="controls">
                <button id="start-pause-btn" disabled><i class="fas fa-play"></i> Démarrer</button>
                <button id="skip-btn" disabled><i class="fas fa-forward-step"></i> Suivant</button>
                <button id="finish-btn" disabled><i class="fas fa-flag-checkered"></i> Finir</button>
                <button id="reset-btn" disabled><i class="fas fa-redo"></i> Reset</button>
            </div>
            <div class="progress-tracker" id="progress-tracker">
                <span id="progress-text-area">Sélectionnez un entraînement</span>
                <span id="drive-connection-status-main" style="display: none;">
                    <i class="fab fa-google-drive"></i>
                    <span id="drive-connection-text">Connecté</span>
                </span>
            </div>
        </div>

        <div class="history-section section-hidden" id="history-section">
            <h2><i class="fas fa-chart-line"></i> Historique & Stats</h2>
            <div class="history-controls">
                <div class="history-filters">
                    <button data-period="week" class="active"><i class="fas fa-calendar-week"></i> Sem</button>
                    <button data-period="month"><i class="fas fa-calendar-alt"></i> Mois</button>
                    <button data-period="year"><i class="fas fa-calendar-check"></i> An</button>
                    <button data-period="all"><i class="fas fa-infinity"></i> Tout</button>
                </div>
                <div class="history-actions" style="display: none;">
                    <i class="fab fa-google-drive"></i>
                    <span id="history-drive-status">Sync</span>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="history-chart-canvas"></canvas>
                <p id="chart-placeholder" style="display: none;"></p>
            </div>
            <div class="stats-display" id="stats-display">
                <h3>Statistiques</h3>
                <div class="content-wrapper"><p>Connectez-vous.</p></div>
                <p class="motivational-message"></p>
            </div>
            <ul class="history-list" id="history-list">
                <li class="no-history">Connectez-vous.</li>
            </ul>
        </div>
    </main>
</div>

<footer>
    <p>© 2024 ArmorWorkout. Sauvegarde sur <i class="fab fa-google-drive"></i> Drive.</p>
    <p><a href="https://github.com/ironworkout/armorworkout" target="_blank" rel="noopener noreferrer"><i class="fab fa-github"></i> GitHub</a></p>
</footer>

<div id="message-area" class="message-area"></div>

<div id="post-workout-summary" class="post-workout-summary">
    <div class="post-workout-summary-content">
        <h2 id="summary-title">Résumé Séance</h2>
        <ul id="summary-items-list" class="summary-items-list"></ul>
        <div class="summary-controls">
            <button id="close-summary-btn"><i class="fas fa-times"></i> Fermer</button>
            <button id="discard-summary-btn"><i class="fas fa-trash-alt"></i> Rejeter</button>
            <button id="confirm-summary-btn"><i class="fas fa-check"></i> Valider</button>
        </div>
    </div>
</div>

<script>
    // --- CONFIG & CONSTANTES ---
    const GOOGLE_CLIENT_ID = "731283926358-viam3ulpgna14flfdeb9m92l8s620hoi.apps.googleusercontent.com";
    const GOOGLE_DRIVE_SCOPES = 'https://www.googleapis.com/auth/drive.file';
    const HISTORY_FILENAME = "armorworkout_history.csv";
    const PROGRAM_FILENAMES = { Push: "armorworkout_push_program.csv", Pull: "armorworkout_pull_program.csv", Legs: "armorworkout_legs_program.csv" };
    const PROGRAM_TYPES = ['Push', 'Pull', 'Legs'];
    const PREPARE_DURATION = 3;
    const SECONDS_PER_REP = 2.5;
    const IN_PROGRESS_KEY = 'armorWorkoutStateInProgress';

    // --- DONNÉES DÉFAUT (Minimaliste pour exemple) ---
    const defaultWorkouts = { Push: [{type:"exercise",name:"Pompes",reps:10},{type:"break",duration:60,name:"Repos"}], Pull: [{type:"exercise",name:"Tractions",reps:5},{type:"break",duration:60,name:"Repos"}], Legs: [{type:"exercise",name:"Squats",reps:15},{type:"break",duration:60,name:"Repos"}] };

    // --- VARIABLES GLOBALES ---
    let timeLeftDisplay, timerCircle, timerStateDisplay, currentExerciseContainer,
        startPauseBtn, skipBtn, finishBtn, resetBtn, navButtons, navHistoryBtn,
        themeToggleBtn, messageArea, workoutSection, historySection, historyList,
        statsDisplay, statsContentWrapper, historyFilterBtns, historyChartCanvas,
        signInButton, signOutButton, driveStatusElement, postWorkoutSummary,
        summaryTitle, summaryItemsList, confirmSummaryBtn, discardSummaryBtn, closeSummaryBtn,
        historyDriveStatus, totalProgressCircle, currentExerciseNameDisplay,
        driveConnectionStatusMain, driveConnectionText, timerDisplayElement,
        chartPlaceholder, progressTextArea, historyActionsContainer;

    let currentWorkoutType = null, currentWorkoutPlan = [], originalCompletedWorkoutPlan = [];
    let currentItemIndex = 0, timerInterval = null, prepareCountdownInterval = null;
    let totalTime = 0, timeLeft = 0, prepareTimeLeft = 0;
    let totalWorkoutEstimatedSeconds = 0, elapsedWorkoutEstimatedSeconds = 0;
    let isTimerRunning = false, isWorkoutActive = false, workoutFinished = false, wasFinishedState = false;
    let currentState = 'idle';
    let workoutStartTime = null, workoutHistory = [];
    let currentHistoryPeriod = 'week', historyChart = null;
    let googleAccessToken = null, tokenClient = null;
    let historyFileId = null, programFileIds = { Push: null, Pull: null, Legs: null };
    let programsLoaded = false, loadedWorkouts = JSON.parse(JSON.stringify(defaultWorkouts));
    let summaryChangesMade = false, isSavingDriveData = false;
    let currentTheme = 'dark', messageTimeoutId = null;
    let audioContext = null;

    // --- UTILITAIRES ---
    const formatTime = (s) => { const m=Math.floor(Math.max(0,s)/60); const sec=Math.max(0,s)%60; return `${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`; };
    const showMessage = (msg, duration = 2500) => { if (!messageArea) return; messageArea.textContent = msg; messageArea.classList.add('visible'); if (messageTimeoutId) clearTimeout(messageTimeoutId); messageTimeoutId = setTimeout(() => messageArea.classList.remove('visible'), duration); };
    const getIconForState = (s) => ({exercise:'fa-dumbbell',break:'fa-hourglass-half',preparing:'fa-spinner',paused:'fa-pause-circle',finished:'fa-check-circle',idle:'fa-play-circle'}[s]||'fa-question-circle');
    const getIconForType = (t) => t==='exercise'?'fa-dumbbell':'fa-hourglass-half';
    const vibrate = (p = [100]) => { if ('vibrate' in navigator) try { navigator.vibrate(p); } catch(e){} };

    // --- AUDIO ---
    let endSound = () => {};
    function initAudioContext() { if (audioContext || typeof window === 'undefined' || (!window.AudioContext && !window.webkitAudioContext)) return; try { audioContext = new (window.AudioContext || window.webkitAudioContext)(); const unlock = () => { if (audioContext.state === 'suspended') audioContext.resume(); document.removeEventListener('click', unlock); document.removeEventListener('touchend', unlock); }; document.addEventListener('click', unlock); document.addEventListener('touchend', unlock); endSound = () => { if (!audioContext || audioContext.state !== 'running') return; try { const o = audioContext.createOscillator(), g = audioContext.createGain(); o.connect(g); g.connect(audioContext.destination); o.type = 'triangle'; o.frequency.setValueAtTime(659.25, audioContext.currentTime); g.gain.setTargetAtTime(0, audioContext.currentTime, 0.015); g.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 0.5); o.start(audioContext.currentTime); o.stop(audioContext.currentTime + 0.5); } catch(e){} }; console.log("Audio Ready"); } catch (e) { audioContext = null; } }

    // --- DRIVE API ---
    async function findOrCreateFile(name, content = "") { if (!googleAccessToken) return null; const url = `https://www.googleapis.com/drive/v3/files?q=name='${encodeURIComponent(name)}'+and+mimeType='text/csv'+and+trashed=false&spaces=drive&fields=files(id)`; try { let res = await fetch(url, {headers:{'Authorization':`Bearer ${googleAccessToken}`}}); if (!res.ok) throw new Error(`Search ${name} (${res.status})`); let data = await res.json(); if (data.files && data.files.length > 0) return data.files[0].id; const meta = { name, mimeType: 'text/csv' }; res = await fetch(`https://www.googleapis.com/drive/v3/files`, {method:'POST', headers:{'Authorization':`Bearer ${googleAccessToken}`,'Content-Type':'application/json'}, body:JSON.stringify(meta)}); if (!res.ok) throw new Error(`Create ${name} (${res.status})`); data = await res.json(); const ok = await updateFileContent(data.id, content); return ok ? data.id : null; } catch (e) { console.error(`Drive F/C ${name}:`, e); showMessage(`Erreur Drive: ${e.message}`, 4000); return null; } }
    async function readFileContent(id) { if (!googleAccessToken || !id) return null; const url = `https://www.googleapis.com/drive/v3/files/${id}?alt=media`; try { const res = await fetch(url, {headers:{'Authorization':`Bearer ${googleAccessToken}`}}); if (!res.ok) { if (res.status === 404) return ""; throw new Error(`Read ${id} (${res.status})`); } return await res.text(); } catch (e) { console.error(`Drive Read ${id}:`, e); showMessage(`Erreur Lecture Drive: ${e.message}`, 4000); return null; } }
    async function updateFileContent(id, content) { if (!googleAccessToken || !id || isSavingDriveData) return false; isSavingDriveData = true; const url = `https://www.googleapis.com/upload/drive/v3/files/${id}?uploadType=media`; let ok = false; try { const res = await fetch(url, {method:'PATCH', headers:{'Authorization':`Bearer ${googleAccessToken}`,'Content-Type':'text/csv'}, body:content}); if (!res.ok) throw new Error(`Write ${id} (${res.status})`); ok = true; } catch (e) { console.error(`Drive Write ${id}:`, e); showMessage(`Erreur Écriture Drive: ${e.message}`, 4000); ok = false; } finally { isSavingDriveData = false; } return ok; }

    // --- AUTH & UI ---
    function handleTokenError(error) { console.error("Token Error:", error); let msg=`Erreur Auth: ${error.error||'Inconnue'}`, status='Erreur Auth'; if(error.error==='popup_closed'||error.error==='user_cancel'){msg="Connexion annulée.";status='Annulé';} else if(error.error==='popup_failed_to_open'){msg="Popup bloqué.";status='Popup Bloqué';} else if(error.error==='access_denied'){msg="Accès Drive refusé.";status='Accès Refusé';} if(driveStatusElement){driveStatusElement.textContent=status;driveStatusElement.className='error';driveStatusElement.style.display='inline-block';} showMessage(msg, 5000); updateAuthUI(false); }
    async function tokenCallback(res) { if (driveStatusElement) driveStatusElement.classList.remove('loading','error','success'); if (res && res.access_token) { googleAccessToken=res.access_token; updateAuthUI(true); showMessage("Connecté, chargement...", 2000); if(driveStatusElement){driveStatusElement.textContent='Chargement...';driveStatusElement.classList.add('loading');driveStatusElement.style.display='inline-block';} try { await Promise.all([loadHistoryFromDrive(), loadProgramsFromDrive()]); if(driveStatusElement){driveStatusElement.textContent='Connecté';driveStatusElement.classList.remove('loading');driveStatusElement.classList.add('success');} loadInProgressState(); updateAuthUI(true); } catch (e) { if(driveStatusElement){driveStatusElement.textContent='Erreur Données';driveStatusElement.classList.add('error');} } } else handleTokenError(res||{error:"invalid_response"}); }
    function handleAuthClick() { initAudioContext(); if (!tokenClient) { showMessage("Google non prêt...", 1500); return; } if(driveStatusElement){driveStatusElement.textContent='Connexion...';driveStatusElement.classList.add('loading');driveStatusElement.classList.remove('error','success');driveStatusElement.style.display='inline-block';} tokenClient.requestAccessToken({prompt:'consent'}); }
    function handleSignoutClick(showMsg = true) { if (!googleAccessToken) { updateAuthUI(false); return; } if(showMsg&&driveStatusElement){driveStatusElement.textContent='Déco...';driveStatusElement.classList.add('loading');driveStatusElement.style.display='inline-block';} google.accounts.oauth2.revoke(googleAccessToken, ()=>{ googleAccessToken=null; historyFileId=null; programFileIds={Push:null,Pull:null,Legs:null}; programsLoaded=false; workoutHistory=[]; loadedWorkouts=JSON.parse(JSON.stringify(defaultWorkouts)); if(isWorkoutActive||currentState!=='idle') resetCurrentWorkout(); else updateAuthUI(false); if(showMsg) showMessage("Déconnecté.", 1500); if(driveStatusElement) driveStatusElement.style.display='none'; }); }
    function updateAuthUI(loggedIn) { const body = document.body; body.classList.toggle('logged-in', loggedIn); body.classList.toggle('logged-out', !loggedIn); if(driveStatusElement){driveStatusElement.style.display = loggedIn ? 'inline-block' : 'none'; if(!loggedIn) driveStatusElement.textContent = '';} if(driveConnectionStatusMain && driveConnectionText){const icon=driveConnectionStatusMain.querySelector('i'); driveConnectionStatusMain.style.display=loggedIn?'inline-flex':'none'; if(loggedIn){if(driveStatusElement?.classList.contains('loading')){driveConnectionText.textContent="Chargement...";icon?.classList.add('fa-spin');} else if(driveStatusElement?.classList.contains('error')){driveConnectionText.textContent="Erreur Drive";icon?.classList.remove('fa-spin');} else {driveConnectionText.textContent="Connecté";icon?.classList.remove('fa-spin');}} else icon?.classList.remove('fa-spin');} if(historyActionsContainer){historyActionsContainer.style.display=loggedIn?'flex':'none'; if(loggedIn && historyDriveStatus){ if(driveStatusElement?.classList.contains('loading')) historyDriveStatus.textContent='Sync...'; else if(driveStatusElement?.classList.contains('error')) historyDriveStatus.textContent='Erreur Sync'; else historyDriveStatus.textContent='Synchro OK'; }} themeToggleBtn.disabled=false; navHistoryBtn.disabled=!['idle','finished'].includes(currentState); navButtons.forEach(b=>b.disabled=!(loggedIn&&programsLoaded&&['idle','finished'].includes(currentState))); if(currentState==='idle'){startPauseBtn.disabled=!(loggedIn&&programsLoaded&&!!currentWorkoutType);skipBtn.disabled=true;finishBtn.disabled=true;resetBtn.disabled=!currentWorkoutType;} else if(currentState==='finished'){startPauseBtn.disabled=true;skipBtn.disabled=true;finishBtn.disabled=true;resetBtn.disabled=!loggedIn;} updateWorkoutInfo(); displayHistory(currentHistoryPeriod); }

    // --- TIMER LOGIC ---
    function calculateTotalEstimatedTime(plan) { let t = 0; plan.forEach(i => t += (i.type === 'break' ? (i.duration||0) : (i.reps||0)*SECONDS_PER_REP)); return t; }
    function updateTotalProgressCircle() { if(!totalProgressCircle||totalWorkoutEstimatedSeconds<=0)return; let elapsed = 0; for(let i=0; i<currentItemIndex; i++) elapsed+=(currentWorkoutPlan[i]?.estimatedDuration||0); const current = currentWorkoutPlan[currentItemIndex]; if(['break','paused'].includes(currentState)&¤t?.type==='break'&&totalTime>0) elapsed += Math.min(totalTime - timeLeft, current.estimatedDuration || totalTime); else if(currentState==='finished') elapsed=totalWorkoutEstimatedSeconds; const perc = totalWorkoutEstimatedSeconds>0 ? Math.min(100,(elapsed/totalWorkoutEstimatedSeconds)*100):0; const grad = `conic-gradient(from 180deg, var(--neon-blue) ${perc}%, var(--neon-pink) ${Math.min(100, perc + 30)}%, var(--total-progress-bg) ${perc}%)`; totalProgressCircle.style.setProperty('--total-progress-gradient', grad); }
    function updateTimerDisplay() { if(!timeLeftDisplay||!timerCircle||!timerStateDisplay)return; let perc=0,timeStr="00:00",color='--color-idle',glow='--glow-idle',stateStr=''; switch(currentState){ case 'break': if(totalTime>0)perc=Math.min(100,((totalTime-timeLeft)/totalTime)*100); timeStr=formatTime(timeLeft); color='--color-break';glow='--glow-break';stateStr='Repos'; break; case 'paused': const item=currentWorkoutPlan[currentItemIndex]; if(item?.type==='break'&&totalTime>0){perc=Math.min(100,((totalTime-timeLeft)/totalTime)*100); timeStr=formatTime(timeLeft);} else timeStr="PAUSE"; color='--color-paused';glow='--glow-paused';stateStr='En Pause'; break; case 'preparing': perc=Math.min(100,((PREPARE_DURATION-prepareTimeLeft)/PREPARE_DURATION)*100); timeStr=formatTime(prepareTimeLeft); color='--color-prepare';glow='--glow-prepare';stateStr='Préparation'; break; case 'finished': perc=100;timeStr="FINI";color='--color-finished';glow='--glow-finished';stateStr='Terminé !'; break; case 'exercise': timeStr="GO!";color='--color-exercise';glow='--glow-exercise';stateStr='Exercice'; break; default: timeStr=formatTime(0);color='--color-idle';glow='--glow-idle'; break; } timeLeftDisplay.textContent=timeStr; timerCircle.style.setProperty('--current-step-color',`var(${color})`); timerCircle.style.setProperty('--current-step-glow',`var(${glow})`); timerCircle.style.backgroundImage=`conic-gradient(var(${color}) ${perc}%, transparent ${perc}%)`; timerStateDisplay.textContent=stateStr; timerStateDisplay.style.color=`var(${color})`; updateTotalProgressCircle(); }
    function updateWorkoutInfo() { if(!currentExerciseContainer||!currentExerciseNameDisplay||!progressTextArea)return; const item=currentWorkoutPlan[currentItemIndex]; let info='',name='',progress=''; const body=document.body; if(currentState==='idle'){ if(googleAccessToken){progress=programsLoaded?(currentWorkoutType?`Prêt: ${currentWorkoutType}`:"Sélectionnez..."):"Chargement...";} else {progress="Connectez-vous.";} name="ArmorWorkout"; info=`<div class="idle-message"><i class="fas fa-info-circle"></i> ${progress}</div>`; } else if(isWorkoutActive||currentState==='preparing'||currentState==='finished'){progress=`Étape ${Math.min(currentItemIndex+1,currentWorkoutPlan.length)}/${currentWorkoutPlan.length}`;} progressTextArea.textContent=progress; if(currentState==='finished'){const dur=workoutStartTime?formatTime((Date.now()-workoutStartTime)/1000):'N/A';name='Terminé !';info=`<div class="exercise-details"><h2><i class="fas ${getIconForState('finished')}"></i> Bravo !</h2><p>Temps: <strong>${dur}</strong></p></div>`;} else if(currentState==='preparing'){const next=currentWorkoutPlan[0];name=`Préparez: ${next?.name||'?'}`;info=`<div class="break-info" style="border-color: var(--color-prepare);"><i class="fas ${getIconForState('preparing')} fa-spin"></i><span> Prêt dans ${prepareTimeLeft}s...</span></div>`;} else if(item){name=`${item.name||(item.type==='break'?'Repos':'?')}`;if(item.type==='exercise'){const r=(item.reps!=null)?`${item.reps}`:'-';const d=item.details||'';info=`<div class="exercise-details"><span><i class="fas ${getIconForType('exercise')}"></i> Reps: <strong>${r}</strong></span>${d?`<span class="details-text"><i class="fas fa-info-circle"></i> ${d}</span>`:''}</div>`;} else if(item.type==='break'){info=`<div class="break-info"><i class="fas ${getIconForType('break')}"></i><span>Pause: ${formatTime(item.duration||0)}</span></div>`;}} else if(isWorkoutActive){name='Chargement...';info='<p>Patientez...</p>';} currentExerciseNameDisplay.textContent=name; currentExerciseContainer.innerHTML=info; body.className=body.className.replace(/state-\w+/g,'').trim(); body.classList.add(`state-${currentState}`); }
    function setState(newState) { if(!startPauseBtn)return; const previous=currentState; currentState=newState; console.log(`State: ${previous} -> ${newState}`); clearInterval(timerInterval); clearInterval(prepareCountdownInterval); timerStateDisplay.classList.remove('preparing'); timerStateDisplay.classList.toggle('visible',newState!=='idle'); timerDisplayElement.classList.remove('finished-animation'); document.body.className=document.body.className.replace(/state-\w+/g,'').trim(); document.body.classList.add(`state-${currentState}`); document.body.classList.toggle('workout-active',!['idle','finished'].includes(newState)); startPauseBtn.className=''; startPauseBtn.disabled=true; skipBtn.disabled=true; finishBtn.disabled=true; resetBtn.disabled=true; navButtons.forEach(b=>b.disabled=!(googleAccessToken&&programsLoaded&&['idle','finished'].includes(newState))); navHistoryBtn.disabled=!['idle','finished'].includes(newState); switch(newState){ case 'idle': isTimerRunning=false;isWorkoutActive=false;workoutFinished=false;timeLeft=0;totalTime=0; updateAuthUI(!!googleAccessToken); break; case 'preparing': isWorkoutActive=true; timerStateDisplay.classList.add('preparing'); prepareTimeLeft=PREPARE_DURATION; startPauseBtn.innerHTML=`<i class="fas fa-spinner fa-spin"></i> Prêt...`; startPauseBtn.className='preparing-btn'; if(googleAccessToken)resetBtn.disabled=false; startPrepareCountdown(); break; case 'exercise': isWorkoutActive=true; timeLeft=0; totalTime=0; if(googleAccessToken){startPauseBtn.disabled=false;startPauseBtn.innerHTML=`<i class="fas ${getIconForType('exercise')}"></i> Fait`;startPauseBtn.className='done-btn';skipBtn.disabled=false;finishBtn.disabled=false;resetBtn.disabled=false;} break; case 'break': isTimerRunning=true; isWorkoutActive=true; if(googleAccessToken){startPauseBtn.disabled=false;startPauseBtn.innerHTML=`<i class="fas ${getIconForState('paused')}"></i> Pause`;startPauseBtn.className='pause-btn';skipBtn.disabled=false;finishBtn.disabled=false;resetBtn.disabled=false;} startBreakTimer(); break; case 'paused': isTimerRunning=false; isWorkoutActive=true; if(googleAccessToken){startPauseBtn.disabled=false;startPauseBtn.innerHTML=`<i class="fas fa-play"></i> Reprendre`;startPauseBtn.className='resume-btn';skipBtn.disabled=false;finishBtn.disabled=false;resetBtn.disabled=false;} break; case 'finished': isWorkoutActive=false;workoutFinished=true;wasFinishedState=true;timeLeft=0;totalTime=0;elapsedWorkoutEstimatedSeconds=totalWorkoutEstimatedSeconds; startPauseBtn.disabled=true;startPauseBtn.innerHTML=`<i class="fas ${getIconForState('finished')}"></i> Terminé`;startPauseBtn.className='finished-btn'; if(googleAccessToken)resetBtn.disabled=false; showMessage('Terminé ! 💪', 3000);vibrate([150,50,150]);endSound(); originalCompletedWorkoutPlan=JSON.parse(JSON.stringify(currentWorkoutPlan)); saveWorkoutToHistory();clearInProgressState();timerDisplayElement.classList.add('finished-animation'); setTimeout(populateAndShowSummary, 500); break; default: currentState='idle'; updateAuthUI(!!googleAccessToken); break; } updateTimerDisplay(); updateWorkoutInfo(); }
    function startPrepareCountdown() { if (prepareCountdownInterval) clearInterval(prepareCountdownInterval); prepareTimeLeft=PREPARE_DURATION; updateTimerDisplay(); updateWorkoutInfo(); timerStateDisplay.textContent=`PRÊT DANS ${prepareTimeLeft}`; prepareCountdownInterval=setInterval(()=>{ prepareTimeLeft--; updateTimerDisplay(); updateWorkoutInfo(); timerStateDisplay.textContent=`PRÊT DANS ${prepareTimeLeft}`; if (prepareTimeLeft<=0) { clearInterval(prepareCountdownInterval); endSound(); vibrate(); const first=currentWorkoutPlan[0]; if(!first){resetCurrentWorkout();return;} setState(first.type==='exercise'?'exercise':'break'); if(first.type==='break'){totalTime=first.duration||0;timeLeft=totalTime;} saveInProgressState(); } }, 1000); }
    function startBreakTimer() { if (timerInterval) clearInterval(timerInterval); updateTimerDisplay(); timerInterval=setInterval(()=>{ if (timeLeft > 0) { timeLeft--; updateTimerDisplay(); saveInProgressState(); } else { clearInterval(timerInterval); handleItemCompletion(true); } }, 1000); }
    function handleItemCompletion(naturalEnd = false) { if(!['exercise','break','paused'].includes(currentState)) return; const idx=currentItemIndex; if(currentWorkoutPlan[idx]?.estimatedDuration) elapsedWorkoutEstimatedSeconds+=currentWorkoutPlan[idx].estimatedDuration; if(naturalEnd&¤tState==='break'){endSound();vibrate();} currentItemIndex++; saveInProgressState(); if(currentItemIndex>=currentWorkoutPlan.length) setState('finished'); else { const next=currentWorkoutPlan[currentItemIndex]; if(!next){setState('finished');return;} setState(next.type==='exercise'?'exercise':'break'); if(next.type==='break'){totalTime=next.duration||0;timeLeft=totalTime;} } }
    function forceFinishWorkout() { if (!isWorkoutActive||workoutFinished||currentState==='preparing') return; if (confirm("Terminer maintenant ?")) { clearInterval(timerInterval); clearInterval(prepareCountdownInterval); setState('finished'); showMessage("Terminé manuellement.", 2500); } }
    function loadWorkout(type) { if(!googleAccessToken){showMessage("Connectez-vous.", 2000);return;} if(!programsLoaded){showMessage("Programmes non chargés.", 2000);return;} if(isWorkoutActive&¤tWorkoutType!==type){if(!confirm(`Arrêter "${currentWorkoutType}" et charger "${type}" ?`)){setActiveWorkoutNav(currentWorkoutType);return;} resetCurrentWorkout();} else if(currentState==='finished'&¤tWorkoutType!==type) resetCurrentWorkout(); else if(currentWorkoutType===type&&(['idle','finished'].includes(currentState)||isWorkoutActive)){showMessage(`"${type}" déjà ${isWorkoutActive?'actif':(currentState==='finished'?'terminé':'sélectionné')}.`, 2000);showSection('workout');setActiveWorkoutNav(type);return;} if(!loadedWorkouts[type]){showMessage(`Erreur: Prog ${type} absent.`, 3000);return;} console.log(`Load: ${type}`); currentWorkoutType=type; currentWorkoutPlan=JSON.parse(JSON.stringify(loadedWorkouts[type])); if(!currentWorkoutPlan||currentWorkoutPlan.length===0){showMessage(`Erreur: Prog "${type}" vide.`, 3000);currentWorkoutType=null;return;} totalWorkoutEstimatedSeconds=calculateTotalEstimatedTime(currentWorkoutPlan); elapsedWorkoutEstimatedSeconds=0; currentItemIndex=0; workoutStartTime=null; isWorkoutActive=false; workoutFinished=false; setActiveWorkoutNav(type); showSection('workout'); closeSummary(false); setState('idle'); showMessage(`"${type}" chargé.`, 2000); }
    function resetCurrentWorkout() { console.log("Reset..."); clearInterval(timerInterval); clearInterval(prepareCountdownInterval); const type=currentWorkoutType; currentWorkoutType=null; currentWorkoutPlan=[]; originalCompletedWorkoutPlan=[]; currentItemIndex=0; workoutStartTime=null; isTimerRunning=false; isWorkoutActive=false; workoutFinished=false; wasFinishedState=false; timeLeft=0; totalTime=0; prepareTimeLeft=0; totalWorkoutEstimatedSeconds=0; elapsedWorkoutEstimatedSeconds=0; clearInProgressState(); closeSummary(false); timerDisplayElement.classList.remove('finished-animation'); setActiveWorkoutNav(null); showSection('workout'); setState('idle'); if(type) showMessage(`"${type}" réinitialisé.`, 1500); }
    function handleTimerClick() { initAudioContext(); if(!isWorkoutActive||workoutFinished||!googleAccessToken)return; if(currentState==='break') setState('paused'); else if(currentState==='paused'&¤tWorkoutPlan[currentItemIndex]?.type==='break') setState('break'); else if(currentState==='exercise') handleItemCompletion(false); saveInProgressState(); }

    // --- HISTORIQUE (Simplifié) ---
    function saveWorkoutToHistory() { if(!currentWorkoutType||!workoutStartTime||!googleAccessToken) return; const duration=Math.round((Date.now()-workoutStartTime)/1000); if(duration<10) return; const entry={id:Date.now().toString(), date:new Date().toISOString(), type:currentWorkoutType, duration}; workoutHistory.unshift(entry); if(!historySection?.classList.contains('section-hidden')) displayHistory(currentHistoryPeriod); saveHistoryToDrive(); }
    async function saveHistoryToDrive() { if(!googleAccessToken) return; if(!historyFileId) historyFileId=await findOrCreateFile(HISTORY_FILENAME,"DateISO,WorkoutType,DurationSeconds,EntryID\n"); if(!historyFileId) return; let csv="DateISO,WorkoutType,DurationSeconds,EntryID\n"; workoutHistory.sort((a,b)=>new Date(b.date)-new Date(a.date)).forEach(e=>csv+=`${e.date},${(e.type||'').replace(/,/g,'')},${e.duration||0},${e.id}\n`); const ok=await updateFileContent(historyFileId,csv); if(historyDriveStatus) historyDriveStatus.textContent=ok?'Synchro OK':'Erreur Sync'; }
    async function loadHistoryFromDrive() { if(!googleAccessToken){workoutHistory=[];displayHistory();return false;} if(historyDriveStatus) historyDriveStatus.textContent='Chargement...'; if(!historyFileId) historyFileId=await findOrCreateFile(HISTORY_FILENAME,"DateISO,WorkoutType,DurationSeconds,EntryID\n"); if(!historyFileId){workoutHistory=[];displayHistory();if(historyDriveStatus)historyDriveStatus.textContent='Erreur Accès';return false;} const csv=await readFileContent(historyFileId); if(csv===null){workoutHistory=[];displayHistory();if(historyDriveStatus)historyDriveStatus.textContent='Erreur Lecture';return false;} parseAndLoadHistoryCsvData(csv); displayHistory(); if(historyDriveStatus) historyDriveStatus.textContent=workoutHistory.length>0?'Synchro OK':'Hist. Vide'; return true; }
    function parseAndLoadHistoryCsvData(csv) { try { const lines=csv.trim().split(/\r?\n/); const hist=[]; const ids=new Set(); const start=(lines[0]||'').toLowerCase().includes("dateiso")?1:0; for(let i=start;i<lines.length;i++){ const vals=lines[i].split(','); if(vals.length<3)continue; const date=new Date(vals[0]?.trim()); const type=vals[1]?.trim(); const dur=parseInt(vals[2]?.trim(),10); const id=vals[3]?.trim()||`${date.getTime()}-${i}`; if(isNaN(date.getTime())||!PROGRAM_TYPES.includes(type)||isNaN(dur)||dur<0||ids.has(id)) continue; hist.push({id,date:date.toISOString(),type,duration:dur}); ids.add(id); } workoutHistory = hist.sort((a,b)=>new Date(b.date)-new Date(a.date)); } catch(e){console.error("Hist parse err:", e); workoutHistory=[];} }
    function displayHistory(period=currentHistoryPeriod) { if(!historyList||!statsDisplay||!statsContentWrapper)return; currentHistoryPeriod=period; historyFilterBtns.forEach(b=>b.classList.toggle('active',b.dataset.period===period)); const connected=!!googleAccessToken; const filtered=filterHistoryByPeriod(connected?workoutHistory:[],period); historyList.innerHTML=!connected?'<li class="no-history">Connectez-vous.</li>':filtered.length===0?'<li class="no-history">Aucun entraînement.</li>':filtered.map(e=>{const d=new Date(e.date); return `<li><span class="history-item-date">${d.toLocaleDateString('fr-FR',{year:'2-digit',month:'short',day:'numeric'})} <small>(${d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})})</small></span><span class="history-item-type">${e.type}</span><span class="history-item-duration">${formatTime(e.duration)}</span></li>`;}).join(''); displayStatsAndMotivation(filtered,period,connected); renderHistoryChart(filtered,period,connected); }
    function filterHistoryByPeriod(hist, period) { const now=new Date(), today=new Date(now.getFullYear(),now.getMonth(),now.getDate()); return hist.filter(e=>{const d=new Date(e.date); if(isNaN(d.getTime())) return false; switch(period){ case 'week': const day=today.getDay(),diff=today.getDate()-day+(day===0?-6:1),startW=new Date(now.getFullYear(),now.getMonth(),diff); startW.setHours(0,0,0,0); return d>=startW; case 'month': return d>=new Date(now.getFullYear(),now.getMonth(),1); case 'year': return d>=new Date(now.getFullYear(),0,1); default: return true; }}); }
    function displayStatsAndMotivation(hist, period, connected) { if(!statsDisplay||!statsContentWrapper)return; const {count,totalDuration,avgDuration,mostFrequentType,frequency}=calculateStats(hist); let p=''; switch(period){ case 'week':p='Semaine';break; case 'month':p='Mois';break; case 'year':p='Année';break; default:p='Total';} const title=statsDisplay.querySelector('h3'); if(title)title.textContent=`Stats (${p})`; let html=!connected?"<p>Connectez-vous.</p>":count===0?"<p>Aucune donnée.</p>":`<p><i class="fas fa-calendar-check"></i> Nb: <strong>${count}</strong></p><p><i class="fas fa-stopwatch"></i> Total: <strong>${formatTime(totalDuration)}</strong></p><p><i class="fas fa-hourglass-half"></i> Moy: <strong>${formatTime(avgDuration)}</strong></p><p><i class="fas fa-star"></i> Fréquent: <strong>${mostFrequentType||'N/A'}</strong> (${frequency[mostFrequentType]||0}x)</p>`; statsContentWrapper.innerHTML=html; let msgEl=statsDisplay.querySelector('.motivational-message'); if(!msgEl){msgEl=document.createElement('p');msgEl.className='motivational-message';statsDisplay.appendChild(msgEl);} msgEl.textContent=connected?generateMotivationalMessage({count}):""; }
    function calculateStats(hist) { let c=0,tot=0,fr={Push:0,Pull:0,Legs:0}; hist.forEach(e=>{const d=Number(e.duration);if(!isNaN(d)){c++;tot+=d;}if(fr[e.type]!=null)fr[e.type]++;}); const avg=c>0?Math.round(tot/c):0; let mf=null,max=-1; for(const t in fr){if(fr[t]>max){max=fr[t];mf=t;}} if(max<=0)mf=null; return {count:c,totalDuration:tot,avgDuration:avg,frequency:fr,mostFrequentType:mf}; }
    function generateMotivationalMessage({count}) { if(!googleAccessToken||count==null)return""; if(count===0)return"Planifiez votre prochain entraînement ! 💪"; if(count>=50)return`Impressionnant ! ${count} séances ! 🏋️‍♂️`; if(count>=20)return`${count} séances, beau parcours ! 🌟`; return `Déjà ${count} entraînement${count>1?'s':''} ! Continuez ! 🎯`; }
    function renderHistoryChart(hist, period, connected) { /* Chart rendering logic - simplified */ if (!historyChartCanvas||!chartPlaceholder)return; const ctx=historyChartCanvas.getContext('2d'); if(!ctx) return; if(historyChart) historyChart.destroy(); historyChart=null; historyChartCanvas.style.display='block'; chartPlaceholder.style.display='none'; if (!connected){historyChartCanvas.style.display='none';chartPlaceholder.textContent="Connectez-vous.";chartPlaceholder.style.display='block';return;} const{labels,data}=aggregateChartData(hist,period); if(labels.length===0||data.every(d=>d===0)){historyChartCanvas.style.display='none';chartPlaceholder.textContent="Aucune donnée.";chartPlaceholder.style.display='block';return;} const styles=getComputedStyle(document.documentElement); const prim=styles.getPropertyValue('--neon-blue').trim(); const acc=styles.getPropertyValue('--neon-pink').trim(); const grid=styles.getPropertyValue('--border-color').trim(); const text=styles.getPropertyValue('--primary-text-color').trim(); const tipBg=styles.getPropertyValue('--secondary-bg-color').trim(); try{historyChart=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Durée (min)',data:data.map(d=>d/60),backgroundColor:prim+'99',borderColor:prim,borderWidth:1,hoverBackgroundColor:acc+'CC',hoverBorderColor:acc,borderRadius:4}]},options:{responsive:true,maintainAspectRatio:false,scales:{y:{beginAtZero:true,title:{display:true,text:'Minutes',color:text},grid:{color:grid},ticks:{color:text,callback:v=>v+'m'}},x:{title:{display:true,text:getChartXAxisTitle(period),color:text},grid:{display:false},ticks:{color:text}}},plugins:{legend:{display:false},tooltip:{backgroundColor:tipBg,titleColor:text,bodyColor:text,padding:8,cornerRadius:4,displayColors:false,callbacks:{label:ctx=>`Durée: ${formatTime(data[ctx.dataIndex]||0)}`}}}}});}catch(e){console.error("Chart error:", e); chartPlaceholder.textContent="Erreur graphique.";chartPlaceholder.style.display='block';} }
    function aggregateChartData(hist, period) { /* Aggregation logic - simplified */ const agg=new Map(); const init=(ls)=>ls.forEach(l=>agg.set(l,0)); switch(period){ case 'week': const days=['Lun','Mar','Mer','Jeu','Ven','Sam','Dim']; init(days); const nowW=new Date(),todayW=new Date(nowW.getFullYear(),nowW.getMonth(),nowW.getDate()),wd=todayW.getDay(),diff=todayW.getDate()-wd+(wd===0?-6:1),startW=new Date(nowW.getFullYear(),nowW.getMonth(),diff); startW.setHours(0,0,0,0); hist.forEach(e=>{const d=new Date(e.date);if(d>=startW){let idx=d.getDay();idx=idx===0?6:idx-1;agg.set(days[idx],(agg.get(days[idx])||0)+(e.duration||0));}}); return {labels:days,data:days.map(d=>agg.get(d))}; case 'month': const weeks=['S1-7','S8-14','S15-21','S22-28','S29+']; init(weeks); const curM=new Date().getMonth(),curY=new Date().getFullYear(); hist.forEach(e=>{const d=new Date(e.date);if(d.getMonth()===curM&&d.getFullYear()===curY){const day=d.getDate(); let wi=Math.min(4,Math.floor((day-1)/7)); agg.set(weeks[wi],(agg.get(weeks[wi])||0)+(e.duration||0));}}); return {labels:weeks,data:weeks.map(w=>agg.get(w))}; case 'year': const months=['Jan','Fév','Mar','Avr','Mai','Juin','Juil','Aoû','Sep','Oct','Nov','Déc']; init(months); const curY2=new Date().getFullYear(); hist.forEach(e=>{const d=new Date(e.date);if(d.getFullYear()===curY2)agg.set(months[d.getMonth()],(agg.get(months[d.getMonth()])||0)+(e.duration||0));}); return {labels:months,data:months.map(m=>agg.get(m))}; default: const yd={}; hist.forEach(e=>{const y=new Date(e.date).getFullYear();yd[y]=(yd[y]||0)+(e.duration||0);}); const years=Object.keys(yd).map(Number).sort((a,b)=>a-b); return {labels:years.map(String),data:years.map(y=>yd[y])}; } }
    function getChartXAxisTitle(p){ switch(p){ case 'week': return 'Jour'; case 'month': return 'Semaine'; case 'year': return 'Mois'; default: return 'Année'; }}

    // --- GESTION PROGRAMMES (Simplifié) ---
    function convertProgramToCsv(prog) { const h="Type,Name,Details,Reps,Duration\n"; return h+prog.map(i=>{const esc=(f)=>{if(f==null)return'';const s=String(f);return(s.includes(',')||s.includes('"')||s.includes('\n'))?`"${s.replace(/"/g,'""')}"`:s;};if(i.type==='exercise')return`${i.type},${esc(i.name)},${esc(i.details)},${i.reps??''},\n`;if(i.type==='break')return`${i.type},${esc(i.name||'Repos')},,,${i.duration||''}\n`;return'';}).join(''); }
    function parseProgramCsvData(csv) { const prog=[]; if(!csv)return prog; const lines=csv.trim().split(/\r?\n/); const start=(lines[0]||'').toLowerCase().startsWith("type,name")?1:0; const parseLine=(l)=>{const v=[];let cur='',q=false;for(let i=0;i<l.length;i++){const c=l[i];if(c==='"'&&q&&l[i+1]==='"'){cur+='"';i++;}else if(c==='"'){q=!q;}else if(c===','&&!q){v.push(cur);cur='';}else cur+=c;}v.push(cur);return v.map(s=>s.trim());}; for(let i=start;i<lines.length;i++){const line=lines[i].trim();if(!line)continue;const vals=parseLine(line);if(vals.length<5)continue;const type=vals[0]?.toLowerCase();const name=vals[1];const details=vals[2];const repsStr=vals[3];const durStr=vals[4];if(type==='exercise'){const r=parseInt(repsStr,10);if(name)prog.push({type:'exercise',name,details,reps:(!isNaN(r)&&repsStr!=='')?r:null});}else if(type==='break'){const d=parseInt(durStr,10);if(!isNaN(d)&&d>0)prog.push({type:'break',duration:d,name:name||'Repos'});}} return prog;}
    async function loadProgramsFromDrive() { if(!googleAccessToken){loadedWorkouts=JSON.parse(JSON.stringify(defaultWorkouts));programsLoaded=false;updateAuthUI(false);return false;} programsLoaded=false; let allOk=true; if(driveStatusElement){driveStatusElement.textContent='Load Progs...';driveStatusElement.classList.add('loading');driveStatusElement.classList.remove('error','success');} const promises=PROGRAM_TYPES.map(async type=>{const fname=PROGRAM_FILENAMES[type];const defP=defaultWorkouts[type]||[];const defCsv=convertProgramToCsv(defP);const fileId=await findOrCreateFile(fname,defCsv);programFileIds[type]=fileId;if(!fileId){loadedWorkouts[type]=JSON.parse(JSON.stringify(defP));return false;}const csv=await readFileContent(fileId);if(csv===null){loadedWorkouts[type]=JSON.parse(JSON.stringify(defP));return false;}try{const parsed=parseProgramCsvData(csv);loadedWorkouts[type]=(parsed.length>0)?parsed:JSON.parse(JSON.stringify(defP));if(parsed.length===0&&csv.trim()!==""&&!csv.trim().toLowerCase().startsWith("type,name"))showMessage(`Format ${fname} invalide. Défaut.`,3000);return true;}catch(e){loadedWorkouts[type]=JSON.parse(JSON.stringify(defP));return false;}}); try{const results=await Promise.all(promises);allOk=results.every(r=>r);}catch(e){allOk=false;PROGRAM_TYPES.forEach(t=>{if(!loadedWorkouts[t])loadedWorkouts[t]=JSON.parse(JSON.stringify(defaultWorkouts[t]||[]));});} programsLoaded=true; console.log(`Progs loaded. Drive OK: ${allOk}`); if(driveStatusElement){driveStatusElement.classList.remove('loading'); if(!allOk){driveStatusElement.textContent='Erreur Progs';driveStatusElement.classList.add('error');}else{driveStatusElement.textContent='Connecté';driveStatusElement.classList.add('success');driveStatusElement.classList.remove('error');}} updateAuthUI(true); return programsLoaded; }

    // --- GESTION RÉSUMÉ (Simplifié) ---
    function populateAndShowSummary() { if(!originalCompletedWorkoutPlan||!summaryTitle||!summaryItemsList||!postWorkoutSummary) { if(currentState==='finished')resetCurrentWorkout(); return; } const type=currentWorkoutType; summaryTitle.textContent=`Résumé - ${type||'?'}`; summaryItemsList.innerHTML=''; summaryChangesMade=false; originalCompletedWorkoutPlan.forEach((item,idx)=>{const li=document.createElement('li');li.className=`summary-item item-type-${item.type}`;li.dataset.index=idx;const icon=getIconForType(item.type);if(item.type==='exercise'){const r=item.reps??'';const d=item.details||'';li.innerHTML=`<h4><i class="fas ${icon}"></i> ${item.name||'Exo'}</h4><label for="sr-${idx}">Reps:</label><div class="input-container"><button class="rep-adjust-btn minus" data-target="sr-${idx}">-</button><input type="number" id="sr-${idx}" value="${r}" min="0" step="1" placeholder="N/A"><button class="rep-adjust-btn plus" data-target="sr-${idx}">+</button></div><div class="details-container"><label for="sd-${idx}">Détails:</label><textarea id="sd-${idx}" rows="1">${d}</textarea></div>`; const rI=li.querySelector(`#sr-${idx}`);const dI=li.querySelector(`#sd-${idx}`); if(rI)rI.addEventListener('input',markSummaryChanged); if(dI)dI.addEventListener('input',markSummaryChanged); li.querySelectorAll('.rep-adjust-btn').forEach(b=>b.addEventListener('click',handleRepAdjust));} else if(item.type==='break'){li.innerHTML=`<h4><i class="fas ${icon}"></i> ${item.name||'Repos'}</h4><p>Durée: ${formatTime(item.duration||0)}</p>`;} summaryItemsList.appendChild(li);}); updateSummaryButtonsState(); postWorkoutSummary.classList.add('visible'); }
    function markSummaryChanged() { if(!summaryChangesMade){summaryChangesMade=true;updateSummaryButtonsState();} }
    function updateSummaryButtonsState() { if(!confirmSummaryBtn||!discardSummaryBtn||!closeSummaryBtn)return; const canSave=googleAccessToken&&!isSavingDriveData; if(summaryChangesMade){confirmSummaryBtn.style.display='inline-flex';confirmSummaryBtn.disabled=!canSave;discardSummaryBtn.style.display='inline-flex';discardSummaryBtn.disabled=false;closeSummaryBtn.style.display='none';}else{confirmSummaryBtn.style.display='none';discardSummaryBtn.style.display='none';closeSummaryBtn.style.display='inline-flex';closeSummaryBtn.disabled=false;} }
    function handleRepAdjust(e) { const t=document.getElementById(e.currentTarget.dataset.target); if(!t)return; let v=parseInt(t.value,10)||0; t.value=Math.max(0, v+(e.currentTarget.classList.contains('plus')?1:-1)); markSummaryChanged(); t.dispatchEvent(new Event('input',{bubbles:true})); }
    function closeSummary(reset=false) { if(!postWorkoutSummary)return; postWorkoutSummary.classList.remove('visible'); summaryChangesMade=false; if(wasFinishedState&&reset) resetCurrentWorkout(); else if(timerDisplayElement) timerDisplayElement.classList.remove('finished-animation'); wasFinishedState=false; setState(currentState); }
    async function handleConfirmSummary() { initAudioContext(); if(!summaryChangesMade){closeSummary(true);return;} if(!googleAccessToken||!currentWorkoutType||!programFileIds[currentWorkoutType]){showMessage("Erreur: Non connecté ou ID prog manquant.",3000);updateSummaryButtonsState();return;} if(isSavingDriveData){showMessage("Sauvegarde en cours...",1500);return;} console.log("Saving summary changes..."); confirmSummaryBtn.disabled=true;discardSummaryBtn.disabled=true;confirmSummaryBtn.innerHTML=`<i class="fas fa-spinner fa-spin"></i> Save...`; const type=currentWorkoutType; const updated=JSON.parse(JSON.stringify(loadedWorkouts[type])); let changes=0; summaryItemsList.querySelectorAll('.summary-item[data-index]').forEach(li=>{ const idx=parseInt(li.dataset.index,10); if(isNaN(idx)||idx<0||idx>=updated.length)return; const item=updated[idx]; if(item?.type==='exercise'){ const rI=li.querySelector(`#sr-${idx}`); const dI=li.querySelector(`#sd-${idx}`); if(!rI||!dI)return; const repsRaw=rI.value.trim(); const reps=repsRaw===''?null:parseInt(repsRaw,10); const dets=dI.value.trim(); if(reps!==null&&(isNaN(reps)||reps<0))return; const rChanged=(item.reps??'')!==(reps??''); const dChanged=(item.details??'')!==dets; if(rChanged||dChanged){item.reps=reps;item.details=dets;changes++;}} }); if(changes===0){updateSummaryButtonsState();closeSummary(true);return;} loadedWorkouts[type]=updated; try{ const csv=convertProgramToCsv(updated); const ok=await updateFileContent(programFileIds[type],csv); if(ok){showMessage(`Prog "${type}" màj!`,2000);closeSummary(true);} else {showMessage(`Échec sauvegarde Drive ${type}.`,4000);updateSummaryButtonsState();} } catch(e){showMessage(`Erreur sauvegarde ${type}: ${e.message}`,4000);updateSummaryButtonsState();} }
    function handleDiscardSummary() { initAudioContext(); showMessage("Modifications rejetées.", 1500); closeSummary(true); }

    // --- SECTION DISPLAY ---
    function showSection(name) { if (!workoutSection || !historySection) return; if (name === 'history' && isWorkoutActive && !workoutFinished) { if (confirm("Arrêter l'entraînement pour voir l'historique ?")) resetCurrentWorkout(); else return; } setTimeout(() => showSectionActual(name), isWorkoutActive ? 50 : 0); }
    function showSectionActual(name) { closeSummary(false); const isHist = name === 'history'; workoutSection.classList.toggle('section-hidden', isHist); historySection.classList.toggle('section-hidden', !isHist); navHistoryBtn.classList.toggle('active', isHist); if(isHist){setActiveWorkoutNav(null);displayHistory(currentHistoryPeriod);} else setActiveWorkoutNav(currentWorkoutType); setState(currentState); }
    function setActiveWorkoutNav(type) { if(!navButtons) return; navButtons.forEach(b=>b.classList.toggle('active', b.dataset.workout === type)); }

    // --- INITIALISATION ---
    function setupEventListeners() {
        signInButton.addEventListener('click', handleAuthClick);
        signOutButton.addEventListener('click', () => handleSignoutClick(true));
        navButtons.forEach(b => b.addEventListener('click', () => { initAudioContext(); loadWorkout(b.dataset.workout); }));
        navHistoryBtn.addEventListener('click', () => { initAudioContext(); showSection('history'); }); // Corrected call
        startPauseBtn.addEventListener('click', () => { initAudioContext(); if(currentState==='idle'&¤tWorkoutType){workoutStartTime=Date.now();elapsedWorkoutEstimatedSeconds=0;setState('preparing');} else if(currentState==='exercise') handleItemCompletion(false); else if(currentState==='break') setState('paused'); else if(currentState==='paused') setState(currentWorkoutPlan[currentItemIndex]?.type==='break'?'break':'exercise'); saveInProgressState(); });
        skipBtn.addEventListener('click', () => { initAudioContext(); if(isWorkoutActive&&!workoutFinished&¤tState!=='preparing'){showMessage("Suivant...", 1000); handleItemCompletion(false);} });
        finishBtn.addEventListener('click', () => { initAudioContext(); if(isWorkoutActive&&!workoutFinished&¤tState!=='preparing') forceFinishWorkout(); });
        resetBtn.addEventListener('click', () => { initAudioContext(); if(currentWorkoutType||isWorkoutActive||workoutFinished){if(confirm("Réinitialiser ?")) resetCurrentWorkout();} });
        themeToggleBtn.addEventListener('click', () => { initAudioContext(); applyTheme(currentTheme === 'dark' ? 'light' : 'dark'); });
        historyFilterBtns.forEach(b => b.addEventListener('click', () => { initAudioContext(); displayHistory(b.dataset.period); }));
        confirmSummaryBtn.addEventListener('click', handleConfirmSummary);
        discardSummaryBtn.addEventListener('click', handleDiscardSummary);
        closeSummaryBtn.addEventListener('click', () => closeSummary(true));
        timerDisplayElement.addEventListener('click', handleTimerClick);
    }

    function assignDOMElements() {
        // Assign all DOM elements needed by the script
        timeLeftDisplay = document.getElementById('time-left'); timerCircle = document.getElementById('timer-circle'); totalProgressCircle = document.getElementById('total-progress-circle'); timerStateDisplay = document.getElementById('timer-state'); currentExerciseContainer = document.getElementById('current-exercise-container'); progressTracker = document.getElementById('progress-tracker'); startPauseBtn = document.getElementById('start-pause-btn'); skipBtn = document.getElementById('skip-btn'); finishBtn = document.getElementById('finish-btn'); resetBtn = document.getElementById('reset-btn'); navButtons = document.querySelectorAll('nav button[data-workout]'); navHistoryBtn = document.getElementById('nav-history'); themeToggleBtn = document.getElementById('theme-toggle-btn'); messageArea = document.getElementById('message-area'); workoutSection = document.getElementById('workout-section'); historySection = document.getElementById('history-section'); historyList = document.getElementById('history-list'); statsDisplay = document.getElementById('stats-display'); statsContentWrapper = statsDisplay.querySelector('.content-wrapper'); historyFilterBtns = document.querySelectorAll('.history-filters button'); historyChartCanvas = document.getElementById('history-chart-canvas'); signInButton = document.getElementById('signin-button'); signOutButton = document.getElementById('signout-button'); driveStatusElement = document.getElementById('drive-status'); postWorkoutSummary = document.getElementById('post-workout-summary'); summaryTitle = document.getElementById('summary-title'); summaryItemsList = document.getElementById('summary-items-list'); confirmSummaryBtn = document.getElementById('confirm-summary-btn'); discardSummaryBtn = document.getElementById('discard-summary-btn'); closeSummaryBtn = document.getElementById('close-summary-btn'); historyDriveStatus = document.getElementById('history-drive-status'); currentExerciseNameDisplay = document.getElementById('current-exercise-name-display'); driveConnectionStatusMain = document.getElementById('drive-connection-status-main'); driveConnectionText = document.getElementById('drive-connection-text'); timerDisplayElement = document.getElementById('timer-display-clickable'); chartPlaceholder = document.getElementById('chart-placeholder'); progressTextArea = document.getElementById('progress-text-area'); historyActionsContainer = document.querySelector('.history-actions');
        // Basic Check
        if (!timeLeftDisplay || !startPauseBtn || !signInButton) { console.error("CRITICAL DOM INIT FAILED"); return false; }
        return true;
    }

    function initApp() {
        console.log("Initializing ArmorWorkout...");
        if (!assignDOMElements()) return; // Assign DOM and check critical elements

        // Init State & UI
        const savedTheme = localStorage.getItem('theme');
        applyTheme((savedTheme === 'light' || savedTheme === 'dark') ? savedTheme : 'dark');
        setState('idle'); // Set initial state & update UI
        setupEventListeners(); // Setup all event listeners

        console.log("App Init Complete. Waiting for GIS...");
        // GIS library loading is handled by the script tag's onload outside this function
    }

    // --- GIS CALLBACK (Must be global) ---
    async function gisLoadedCallback() {
        console.log("GIS Loaded");
        if (!GOOGLE_CLIENT_ID) { console.error("CRITICAL: GOOGLE_CLIENT_ID missing!"); showMessage("Erreur Config Google ID.", 10000); return; }
        try {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID, scope: GOOGLE_DRIVE_SCOPES,
                callback: tokenCallback, error_callback: handleTokenError, prompt: ''
            });
            console.log("Token Client Init OK");
        } catch (error) { console.error("Token Client Init Error:", error); showMessage("Erreur Init Google.", 5000); updateAuthUI(false); if(driveStatusElement){driveStatusElement.textContent='Erreur Init';driveStatusElement.classList.add('error');driveStatusElement.style.display='inline-block';} }
    }


    // --- Start the app after DOM is ready ---
    document.addEventListener('DOMContentLoaded', initApp);

</script>

<!-- Google Identity Services Script -->
<!-- onload MUST call the globally defined gisLoadedCallback -->
<script async defer src="https://accounts.google.com/gsi/client" onload="gisLoadedCallback()"></script>

</body>
</html>
