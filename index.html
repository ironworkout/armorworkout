<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArmorWorkout - Timer Réacteur Arc V1</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <!-- Google Identity Services (GIS) - chargé à la fin du body -->
    <style>
        /* --- Variables Globales & Thème --- */
        :root {
            /* Thème Sombre */
            --primary-bg: #0A0F1A; --secondary-bg: #111827; --primary-text: #E5E7EB; --secondary-text: #9CA3AF; --border-color: #374151; --input-bg: #1F2937;

            /* Couleurs Accent (Basées sur V1) */
            --accent-color: #00d0ff; /* Gardé pour cohérence */
            --accent-glow: 0 0 10px rgba(0, 208, 255, 0.7); /* Glow standard */

            /* Couleurs Réacteur Arc V1 */
            --reactor-glow: rgba(0, 200, 255, 0.8); /* Glow spécifique timer */
            --reactor-core: rgba(0, 229, 255, 1);
            --reactor-ring: rgba(0, 200, 255, 0.5);
            --reactor-segment: rgba(0, 200, 255, 0.3); /* Peut être inutilisé avec segments CSS */

            /* Couleurs par état (du cahier des charges) */
            --exercise-color: #00e5ff; /* Cyan pour exercice */
            --break-color: #ff8800;    /* Orange pour pause */
            --paused-color: #ff004c;   /* Rouge/Rose pour 'paused' */
            --finished-color: #00ff85; /* Vert pour terminé */
            --idle-color: var(--accent-color); /* Cyan pour idle */
             /* Variable pour 'preparing' (non définie dans cahier des charges, utilisons 'break') */
             --preparing-color: var(--break-color);

            /* RGB pour JS si besoin (approximatif basé sur hex) */
            --exercise-color-rgb: 0, 229, 255;
            --break-color-rgb: 255, 136, 0;
            --paused-color-rgb: 255, 0, 76;
            --finished-color-rgb: 0, 255, 133;
            --idle-color-rgb: 0, 208, 255;
             --preparing-color-rgb: 255, 136, 0;

            /* Couleurs Spécifiques boutons/infos (gardées de V3) */
            --danger-color: #ff4757; --success-color: #2ed573; --warning-color: #facc15; --info-color: #60A5FA; --action-color: #A78BFA;
            /* Boutons */
            --btn-bg: rgba(6, 20, 37, 0.3); --btn-border: 1px solid #2c3a4e; --btn-hover-bg: rgba(17, 24, 39, 0.5); --btn-hover-border: var(--secondary-text); --btn-hover-text: var(--primary-text); --btn-disabled-opacity: 0.5;

            /* Autres */
            --font-family-main: 'Inter', sans-serif; --font-family-display: 'Rajdhani', sans-serif; --border-radius-md: 6px; --transition-speed: 0.2s; --section-transition-speed: 0.3s;
            /* Progression totale */
            --total-progress-color: var(--accent-color); --total-progress-bg: rgba(17, 24, 39, 0.5);
        }
        /* --- Styles Globaux --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; font-size: 16px; }
        body { background-color: var(--primary-bg); font-family: var(--font-family-main); color: var(--primary-text); min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .container { max-width: 1280px; margin: 0 auto; width: 100%; flex-grow: 1; display: flex; flex-direction: column; padding: 0 2rem; }
        /* --- Header (Style V3 gardé) --- */
        header { padding: 10px 0; border-bottom: 1px solid var(--border-color); background-color: var(--primary-bg); width: 100%; transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out, visibility 0s linear 0.4s; }
        body.workout-active header { transform: translateY(-100%); opacity: 0; visibility: hidden; }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1280px; margin: 0 auto; padding: 0 2rem; }
        .header-actions-left, .header-actions-right { display: flex; align-items: center; gap: 12px; }
        .app-title { font-family: var(--font-family-display); text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 10px rgba(255, 255, 255, 0.5); color: var(--primary-text); font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 8px; margin: 0; }
        .app-title i { color: var(--accent-color); font-size: 1.2em;}
        nav { display: flex; align-items: baseline; gap: 25px; }
        nav button { background: none; border: none; color: var(--secondary-text); font-size: 1em; font-weight: 500; padding-bottom: 5px; cursor: pointer; transition: color 0.3s ease, border-color 0.3s ease; border-bottom: 2px solid transparent; }
        nav button:disabled { color: rgba(156, 163, 175, 0.4); cursor: not-allowed; border-bottom-color: transparent !important; }
        nav button:not(:disabled):hover { color: var(--primary-text); }
        nav button.active { color: var(--primary-text); font-weight: 600; border-bottom-color: var(--accent-color); }
        nav button i { margin-right: 5px; }
        #nav-history.active { border-bottom-color: var(--exercise-color); }
        #nav-progress.active { border-bottom-color: var(--success-color); }
        /* --- Boutons Style App (Style V3 gardé) --- */
        .app-button { background-color: var(--btn-bg); border: var(--btn-border); color: var(--accent-color); text-shadow: 0 0 5px rgba(0, 208, 255, 0.7); transition: all 0.3s ease; font-family: var(--font-family-display); letter-spacing: 1px; font-weight: 600; padding: 0.5rem 1.5rem; border-radius: 9999px; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 0.9rem; }
        .app-button:hover:not(:disabled) { box-shadow: var(--accent-glow); background-color: rgba(0, 208, 255, 0.1); }
        .app-button.danger { color: var(--danger-color); border-color: rgba(255, 71, 87, 0.5); text-shadow: 0 0 5px rgba(255, 71, 87, 0.7); }
        .app-button.danger:hover:not(:disabled) { box-shadow: 0 0 10px rgba(255, 71, 87, 0.7); background-color: rgba(255, 71, 87, 0.1); }
        .app-button.active { background-color: rgba(0, 208, 255, 0.2); box-shadow: var(--accent-glow); }
        .app-button:disabled { opacity: 0.5; cursor: not-allowed; background-color: rgba(6, 20, 37, 0.6); border-color: rgba(0, 208, 255, 0.15); color: rgba(0, 208, 255, 0.4); text-shadow: none; box-shadow: none; }
        .center-button { min-width: 120px; }
        /* Statut Drive et Settings Icon */
        #drive-status { display: inline-flex; align-items: center; gap: 10px; }
        #drive-status-text { border: 1px solid var(--success-color); color: var(--success-color); padding: 5px 12px; border-radius: 6px; font-size: 0.9em; font-weight: 500; }
        #drive-status.loading #drive-status-text { border-color: var(--warning-color); color: var(--warning-color); }
        #drive-status.error #drive-status-text { border-color: var(--danger-color); color: var(--danger-color); }
        #settings-icon { color: var(--secondary-text); font-size: 1.1em; cursor: pointer; transition: color 0.3s ease, transform 0.3s ease; padding: 5px; }
        #settings-icon:hover { color: var(--primary-text); transform: rotate(45deg); }
        body.logged-out #drive-status, body.logged-out #signout-button, body.logged-out #export-button { display: none; }
        body.logged-in #signin-button { display: none; }
        /* --- Main Content --- */
        main { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; padding-top: 2rem; padding-bottom: 2rem; }
        body.workout-active main { padding-top: 1rem; }
        /* --- Sections --- */
        .app-section { background-color: transparent; padding: 0; border: none; width: 100%; margin-bottom: 40px; transition: opacity var(--section-transition-speed) ease-in-out, visibility 0s linear var(--section-transition-speed); max-height: 5000px; opacity: 1; visibility: visible; overflow: hidden; }
        .workout-section { max-width: 600px; text-align: center; }
        .history-section, .progress-section { max-width: 850px; text-align: left; background-color: rgba(17, 24, 39, 0.5); padding: 30px; border-radius: var(--border-radius-md); border: 1px solid var(--border-color); }
        .section-hidden { opacity: 0; max-height: 0 !important; padding: 0 !important; margin-bottom: 0 !important; border-width: 0 !important; visibility: hidden; transition: opacity var(--section-transition-speed) ease-in-out, visibility 0s linear var(--section-transition-speed), max-height 0s linear var(--section-transition-speed), padding var(--section-transition-speed) ease-out, margin var(--section-transition-speed) ease-out, border-width var(--section-transition-speed) ease-out; }

        /* --- Timer Réacteur Arc V1 (Basé sur Cahier des Charges) --- */
        .timer-display { margin-bottom: 30px; position: relative; display: flex; justify-content: center; align-items: center; width: 300px; height: 300px; margin-left: auto; margin-right: auto; cursor: pointer; user-select: none; -webkit-tap-highlight-color: transparent; }
        .timer-circle-container { position: relative; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        #total-progress-circle { /* Gardé mais discret */ position: absolute; inset: 0; border-radius: 50%; z-index: -1; opacity: 0.2; border: 4px solid transparent; background-clip: padding-box; background-origin: border-box; background-image: conic-gradient(var(--accent-color) 0%, var(--accent-color) 0%, transparent 0%, transparent 100%); transition: background-image 0.3s linear; }
        .timer-circle { /* Nouveau style V1 */
          position: relative; width: 300px; height: 300px; border-radius: 50%;
          background: radial-gradient(circle at center, rgba(0, 200, 255, 0.15) 0%, rgba(0, 0, 0, 0) 70%); /* Fond radial V1 */
          box-shadow: 0 0 50px rgba(0, 200, 255, 0.5); /* Glow V1 (ajusté) */
          display: flex; justify-content: center; align-items: center;
          z-index: 1;
          transition: box-shadow 0.3s ease; /* Transition pour le glow */
        }
        .reactor-ring { /* Anneaux V1 */
          position: absolute; border-radius: 50%;
          border: 2px solid rgba(0, 200, 255, 0.4); /* Couleur V1 (ajusté) */
          box-shadow: 0 0 15px rgba(0, 200, 255, 0.6); /* Glow V1 (ajusté) */
          /* Tailles via style inline HTML */
        }
        .reactor-segments { /* Conteneur segments V1 */
          position: absolute; width: 100%; height: 100%;
          border-radius: 50%; overflow: hidden;
          animation: rotateSegments 60s linear infinite;
          z-index: 0; /* Derrière les anneaux */
        }
        /* Segments créés par JS via createArcSegments */
        .segment {
            position: absolute;
            top: 50%; left: 50%;
            width: 3px; /* Ajuster largeur */
            height: 18px; /* Hauteur base */
            background-color: rgba(0, 200, 255, 0.6); /* Couleur segment */
            transform-origin: center 135px; /* Ajuster rayon (50% de 270px approx) */
            opacity: 0.7;
            border-radius: 1px;
        }
        @keyframes rotateSegments { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .reactor-core { /* Noyau V1 (peut être un div vide ou intégré) */
            position: absolute; width: 40%; height: 40%;
            border-radius: 50%;
            background: radial-gradient(circle, var(--reactor-core) 10%, rgba(0, 200, 255, 0.3) 50%, transparent 70%);
            box-shadow: var(--accent-glow-strong);
            z-index: 2; /* Au dessus des anneaux/segments */
        }
        .time-display { /* Texte temps V1 */
            font-family: var(--font-family-display); font-size: 3.5rem; /* Ajuster */ font-weight: 700;
            z-index: 10; position: relative; /* Pour être au dessus de tout */
            /* Couleur et glow gérés par JS */
            --current-timer-color: var(--idle-color);
            --current-timer-glow: var(--accent-glow);
            color: var(--current-timer-color);
            text-shadow: var(--current-timer-glow);
            transition: color var(--transition-speed) ease, text-shadow var(--transition-speed) ease;
        }
        #timer-state { /* Texte état V1 */
            font-family: var(--font-family-display);
            position: absolute; bottom: 15%; /* Position sous le cercle */
            left: 50%; transform: translateX(-50%);
            font-size: 1rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px;
            opacity: 0; /* Géré par JS */
            transition: color 0.3s ease, opacity 0.3s ease, text-shadow 0.3s ease;
            color: var(--current-timer-color); text-shadow: var(--current-timer-glow);
            z-index: 11;
        }
        #timer-state.visible { opacity: 0.9; }
        #timer-state.preparing { animation: countdown-pulse 1s infinite; font-size: 1.1em; }
        @keyframes countdown-pulse { 0%, 100% { transform: translateX(-50%) scale(1); opacity: 1; } 50% { transform: translateX(-50%) scale(1.05); opacity: 0.85; } }
        /* --- FIN Styles Timer V1 --- */

        /* --- Infos Workout --- */
        #workout-info { text-align: center; margin-bottom: 2rem; }
        #current-exercise-name-display { font-size: 1.8rem; margin-bottom: 1rem; font-family: var(--font-family-display); color: var(--primary-text); transition: color 0.3s ease; }
        /* Coloration titre via JS ok */
        #current-exercise-container .app-button { border-style: dashed; cursor: default; font-size: 0.9rem; background: transparent; border-color: var(--border-color); color: var(--secondary-text); text-shadow: none; }
        #current-exercise-container .app-button:hover { background: transparent; box-shadow: none; border-color: var(--border-color); color: var(--secondary-text); }
        #current-exercise-container .app-button i { color: var(--accent-color); }
        #current-exercise-container .exercise-details, #current-exercise-container .break-info { font-size: 0.9rem; color: var(--secondary-text); margin-top: 0.5rem; display: inline-flex; flex-wrap: wrap; justify-content: center; gap: 0.5rem 1rem; padding: 0.5rem 1rem; background: rgba(17, 24, 39, 0.5); border-radius: var(--border-radius-md); border: 1px solid var(--border-color); }
        #current-exercise-container .exercise-details span, #current-exercise-container .break-info span { display: inline-flex; align-items: center; gap: 0.3rem; }
        #current-exercise-container .exercise-details i { color: var(--exercise-color); }
        #current-exercise-container .break-info i { color: var(--break-color-val); } /* Utilise break-color-val */
        /* --- Contrôles Principaux --- */
        .controls { width: 100%; max-width: 640px; display: flex; justify-content: center; gap: 1rem; margin-bottom: 2rem; padding: 0 1rem; }
        .controls .app-button { flex-grow: 0; }
        #start-pause-btn:not(:disabled) { background-color: var(--accent-color); color: var(--primary-bg); border-color: var(--accent-color); text-shadow: none; }
        #start-pause-btn:not(:disabled):hover { background-color: var(--accent-color); filter: brightness(1.1); box-shadow: var(--accent-glow); }
        /* --- Tracker Inférieur --- */
        #progress-tracker { color: rgba(255, 255, 255, 0.7); display: flex; align-items: center; justify-content: center; font-size: 0.9rem; gap: 1rem; }
        #drive-connection-status-main { display: inline-flex; align-items: center; gap: 6px; }
        .status-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; background-color: var(--success-color); box-shadow: 0 0 8px var(--success-color); }
        #drive-connection-status-main.error .status-indicator { background-color: var(--danger-color); box-shadow: 0 0 8px var(--danger-color); }
        #drive-connection-status-main.loading .status-indicator { background-color: var(--warning-color); box-shadow: 0 0 8px var(--warning-color); animation: pulse-yellow 1.5s infinite ease-in-out; }
        @keyframes pulse-yellow { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        #drive-connection-text { font-weight: 500; }
        /* --- Sections Historique / Progression (styles internes inchangés) --- */
        .history-section h2, .progress-section h2 { font-family: var(--font-family-display); color: var(--primary-text); }
        .history-controls, .progress-controls { padding-bottom: 20px; margin-bottom: 25px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .history-filters, .progress-filters { display: flex; gap: 10px; flex-wrap: wrap; }
        .history-filters button.active { border-color: var(--accent-color); color: var(--accent-color); background-color: var(--accent-dim); box-shadow: var(--accent-glow); }
        /* --- Le reste des styles internes Histo/Progress --- */
        /* --- ... --- */
        /* --- Modal (styles internes inchangés) --- */
        .post-workout-summary { position: fixed; inset: 0; background-color: rgba(10, 15, 26, 0.9); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; opacity: 0; visibility: hidden; pointer-events: none; transition: opacity 0.3s ease, visibility 0s linear 0.3s; }
        .post-workout-summary.visible { opacity: 1; visibility: visible; pointer-events: auto; }
        .post-workout-summary-content { background-color: var(--secondary-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius-md); box-shadow: 0 10px 30px rgba(0,0,0,0.4); width: 100%; max-width: 550px; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .post-workout-summary.visible .post-workout-summary-content { transform: scale(1); }
        .post-workout-summary h2 { color: var(--accent-color); font-family: var(--font-family-display); font-size: 1.5em; font-weight: 700; padding: 20px 25px; border-bottom: 1px solid var(--border-color); text-align: center; background-color: rgba(10, 15, 26, 0.5); text-shadow: 0 0 5px var(--accent-color); }
        .summary-items-list { list-style: none; padding: 15px 25px; overflow-y: auto; flex-grow: 1; background: var(--primary-bg); border-bottom: 1px solid var(--border-color); }
        .summary-item { display: grid; grid-template-columns: 1fr auto; gap: 10px 15px; align-items: center; padding: 12px 0; border-bottom: 1px solid var(--border-color); } .summary-item:last-child { border-bottom: none; }
        .summary-item .exercise-name { color: var(--primary-text); font-weight: 500; } .summary-item .exercise-name i { color: var(--exercise-color); margin-right: 8px; } .summary-item .exercise-name small { color: var(--secondary-text); margin-left: 8px; }
        .summary-item .input-container { display: flex; align-items: center; gap: 8px; justify-self: end; } .summary-item label { display: none; }
        .summary-item input[type="number"] { background-color: var(--input-bg); border: 1px solid var(--border-color); color: var(--primary-text); border-radius: var(--border-radius-md); padding: 6px 10px; font-size: 0.95em; width: 70px; text-align: center; transition: all var(--transition-speed) ease; }
        .summary-item input[type="number"]::-webkit-outer-spin-button, .summary-item input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .summary-item input:focus { border-color: var(--accent-color); background-color: var(--secondary-bg); outline: none; box-shadow: 0 0 0 3px var(--accent-dim); }
        .summary-controls { padding: 20px 25px; display: flex; justify-content: center; gap: 15px; border-top: 1px solid var(--border-color); background-color: rgba(10, 15, 26, 0.5); }
        #finish-summary-btn { background-color: var(--success-color) !important; border-color: var(--success-color) !important; color: var(--primary-bg) !important; text-shadow: none !important; }
        #finish-summary-btn:hover:not(:disabled) { filter: brightness(1.1); box-shadow: 0 0 10px var(--success-color); }
        /* --- Animation Fin Workout (Ajustée pour V1) --- */
        .finished-animation .timer-circle { box-shadow: 0 0 70px rgba(var(--finished-color-rgb), 0.9), 0 0 40px rgba(var(--finished-color-rgb), 0.6); }
        .finished-animation .reactor-ring, .finished-animation .reactor-core { border-color: var(--finished-color); box-shadow: 0 0 20px var(--finished-color); }
        /* --- Message Flottant --- */
        .message-area { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); background-color: rgba(17, 24, 39, 0.9); color: var(--primary-text); border: 1px solid var(--border-color); padding: 12px 25px; border-radius: var(--border-radius-md); z-index: 3000; opacity: 0; transition: all 0.5s ease; pointer-events: none; font-size: 0.95em; box-shadow: 0 4px 15px rgba(0,0,0,0.3); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); max-width: 90%; text-align: center; }
        .message-area.visible { opacity: 1; transform: translate(-50%, 0); bottom: 40px; pointer-events: auto; }
        .message-area.error-message { background-color: rgba(255, 71, 87, 0.8); color: #fff; border-color: var(--danger-color); text-shadow: 0 0 5px rgba(0,0,0,0.5); }
        /* --- Footer --- */
        footer { width: 100%; text-align: center; font-size: 0.75rem; color: rgb(107 114 128); margin-top: auto; padding-top: 1rem; border-top: 1px solid var(--border-color); }
        footer a:hover { color: var(--accent-color); }
        footer i.fa-google-drive { color: var(--success-color); }
         /* --- Responsive --- */
        @media (max-width: 768px) { /* Styles V3 responsives gardés */ .arc-reactor-container { width: 240px; height: 240px; } .arc-reactor-time { font-size: 2.5rem; } .controls { flex-wrap: wrap; justify-content: center; max-width: none; } .controls .app-button { min-width: 100px; padding: 0.4rem 1rem; font-size: 0.85rem;} .header-content { padding: 0 15px; flex-wrap: wrap; justify-content: center;} nav { gap: 10px; width: 100%; justify-content: center; order: 3; margin-top: 10px;} .header-actions-left { width: 100%; justify-content: center; order: 2; margin-top: 10px;} .app-title { order: 1; width: 100%; text-align: center; margin-bottom: 10px;} /* ... */ }
        @media (max-width: 480px) { .arc-reactor-container { width: 200px; height: 200px; } .arc-reactor-time { font-size: 2rem; } #current-exercise-name-display { font-size: 1.5rem; } .controls { gap: 8px; } .controls .app-button { min-width: 90px; padding: 0.3rem 0.8rem; font-size: 0.8rem; } /* ... */ }
        /* --- Rep Adjustment Overlay (Styles V3 gardés) --- */
        .rep-adjustment-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 20; background-color: rgba(10, 15, 26, 0.9); padding: 20px; border-radius: var(--border-radius-md); border: 1px solid var(--accent-border); box-shadow: 0 10px 30px rgba(0,0,0,0.4), 0 0 15px var(--accent-glow); display: none; flex-direction: column; align-items: center; gap: 15px; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); width: 280px; }
        .rep-adjustment-overlay.visible { display: flex; animation: fadeInScale 0.3s ease-out forwards; }
        @keyframes fadeInScale { from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); } to { opacity: 1; transform: translate(-50%, -50%) scale(1); } }
        .rep-adjustment-overlay .title { font-family: var(--font-family-display); font-size: 1.1em; font-weight: 700; color: var(--accent-color); text-shadow: 0 0 5px var(--accent-color); text-align: center; margin-bottom: 5px;}
        .rep-adjustment-controls { display: flex; align-items: center; gap: 15px; }
        .rep-adjustment-btn { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.4em; font-weight: 700; background-color: rgba(17, 24, 39, 0.9); border: 1px solid var(--border-color); color: var(--primary-text); cursor: pointer; transition: all var(--transition-speed) ease; }
        .rep-adjustment-btn.minus { border-color: var(--danger-color); color: var(--danger-color); } .rep-adjustment-btn.minus:hover { background-color: rgba(255, 71, 87, 0.15); box-shadow: 0 0 10px var(--danger-color) ; }
        .rep-adjustment-btn.plus { border-color: var(--success-color); color: var(--success-color); } .rep-adjustment-btn.plus:hover { background-color: rgba(46, 213, 115, 0.15); box-shadow: 0 0 10px var(--success-color); }
        .rep-adjustment-btn:active { transform: scale(0.95); }
        .current-reps { font-family: var(--font-family-display); font-size: 2.2em; font-weight: 900; color: var(--primary-text); font-variant-numeric: tabular-nums; min-width: 60px; text-align: center; }
        .rep-adjustment-next-exercise { font-size: 0.95em; color: var(--exercise-color); font-weight: 500; text-align: center; margin-top: 5px; }

    </style>
</head>
<body class="flex flex-col items-center justify-between py-8 px-4">

    <header>
        <div class="header-content">
            <div class="header-actions-left">
                 <button id="signout-button" class="app-button danger" disabled><i class="fas fa-sign-out-alt mr-2"></i> Déconnecter</button>
                 <button id="export-button" class="app-button" disabled><i class="fas fa-file-export mr-2"></i> Exporter</button>
                 <div id="drive-status" style="display: none;">
                    <span id="drive-status-text" class="app-button">Connecté</span>
                    <i id="settings-icon" class="fas fa-cog"></i>
                 </div>
                 <button id="signin-button" class="app-button" disabled><i class="fab fa-google mr-2"></i> Connecter Drive</button>
            </div>
            <h1 class="app-title"><i class="fas fa-shield-alt"></i>ArmorWorkout</h1>
            <nav class="header-actions-right">
                 <button id="nav-push" data-workout="Push" disabled>Push</button>
                 <button id="nav-pull" data-workout="Pull" disabled>Pull</button>
                 <button id="nav-legs" data-workout="Legs" disabled>Legs</button>
                 <button id="nav-history"><i class="fas fa-history mr-1"></i> Historique</button>
                 <button id="nav-progress" disabled><i class="fas fa-chart-line mr-1"></i> Progression</button>
             </nav>
        </div>
    </header>

    <main class="container flex-grow flex flex-col items-center justify-center relative">
        <div class="workout-section w-full" id="workout-section">
             <!-- Timer Arc Reactor V1 -->
            <div class="timer-display" id="timer-display-clickable">
                <div class="timer-circle-container">
                    <div class="total-progress-circle" id="total-progress-circle"></div>
                    <div class="timer-circle" id="timer-circle"> <!-- Style V1 via CSS -->
                        <div class="reactor-core"></div>
                        <div class="reactor-ring" style="width: 80%; height: 80%;"></div>
                        <div class="reactor-ring" style="width: 65%; height: 65%;"></div>
                        <div class="reactor-ring" style="width: 50%; height: 50%;"></div>
                        <div class="reactor-segments outer-segments" id="outerSegments"></div> <!-- Conteneur pour segments JS -->
                        <div class="reactor-segments inner-segments" id="innerSegments"></div> <!-- Conteneur pour segments JS -->
                        <div class="time-display" id="time-left">00:00</div>
                    </div>
                </div>
                <div id="timer-state" class="timer-state-display text-center mb-8 visible">Prêt</div> <!-- Utilise #timer-state pour JS -->
                <!-- Overlay Ajustement Reps -->
                <div class="rep-adjustment-overlay" id="rep-adjustment-overlay">
                   <div class="title">Ajuster Répétitions</div> <div class="rep-adjustment-next-exercise" id="rep-adjustment-exercise-name">Exercice</div> <div class="rep-adjustment-controls"> <button class="rep-adjustment-btn minus" id="rep-adjust-minus">-</button> <span class="current-reps" id="current-reps-display">12</span> <button class="rep-adjustment-btn plus" id="rep-adjust-plus">+</button> </div>
                </div>
            </div>

            <!-- Infos Exercice / Prompt -->
             <div id="workout-info" class="text-center mb-8">
                  <h2 id="current-exercise-name-display" class="app-title text-3xl font-bold text-white mb-4">ArmorWorkout</h2>
                  <div id="current-exercise-container" class="flex justify-center">
                       <div class="workout-prompt app-button rounded-full px-6 py-2 flex items-center text-sm" style="border-style: dashed; cursor: default;">
                           <i class="fas fa-hand-pointer mr-2"></i> Sélectionnez un entraînement
                       </div>
                  </div>
             </div>

             <!-- Boutons de Contrôle -->
             <div class="controls w-full max-w-xl flex justify-center gap-4 px-4 mb-8">
                 <button id="prev-btn" class="app-button" disabled><i class="fas fa-backward-step mr-2"></i> Précédent</button>
                 <button id="start-pause-btn" class="app-button center-button" disabled>Démarrer</button>
                 <button id="skip-btn" class="app-button" disabled>Suivant <i class="fas fa-forward-step ml-2"></i></button>
                 <button id="finish-btn" class="app-button" disabled><i class="fas fa-flag-checkered mr-2"></i> Finir</button>
                 <button id="reset-btn" class="app-button danger" disabled><i class="fas fa-redo mr-2"></i> Reset</button>
             </div>

             <!-- Statut Tracker Inférieur -->
             <div id="progress-tracker" class="text-white/70 flex items-center justify-center text-sm">
                <span id="progress-text-area">Sélectionnez un entraînement</span>
                 <span id="drive-connection-status-main" class="ml-4 items-center" style="display: none;">
                    <span class="status-indicator"></span>
                    <span id="drive-connection-text">Connecté</span>
                </span>
             </div>
        </div>

        <!-- Sections Historique / Progression (Structure interne identique) -->
        <div class="history-section w-full max-w-4xl mx-auto mt-8 section-hidden" id="history-section">
             <h2 class="text-2xl font-bold text-center mb-6 app-title"><i class="fas fa-history mr-2"></i> Historique & Stats</h2>
             <div class="history-controls"> <div class="history-filters" role="group"> <button data-period="week" class="active app-button"><i class="fas fa-calendar-week mr-1"></i> Sem</button> <button data-period="month" class="app-button"><i class="fas fa-calendar-alt mr-1"></i> Mois</button> <button data-period="year" class="app-button"><i class="fas fa-calendar-check mr-1"></i> Année</button> <button data-period="all" class="app-button"><i class="fas fa-infinity mr-1"></i> Tout</button> </div> <div class="history-actions" style="display: none;"> <span id="history-drive-status">Synchro OK</span> </div> </div>
             <div class="chart-container" style="height: 300px;"> <canvas id="history-chart-canvas"></canvas> <p id="history-chart-placeholder" class="chart-placeholder"></p> </div>
             <div class="stats-display"> <h3>Statistiques</h3> <div class="content-wrapper" aria-live="polite"> <p>Connectez-vous.</p> </div> <p class="motivational-message"></p> </div>
             <ul class="history-list"> <li class="no-history">Connectez-vous.</li> </ul>
        </div>
        <div class="progress-section w-full max-w-4xl mx-auto mt-8 section-hidden" id="progress-section">
            <h2 class="text-2xl font-bold text-center mb-6 app-title"><i class="fas fa-chart-line mr-2"></i> Progression</h2>
            <div class="progress-controls"> <div class="progress-filters"> <div class="filter-group"> <label for="exercise-select">Exercice</label> <select id="exercise-select"> <option value="all">Tous (Total Reps)</option> </select> </div> <div class="filter-group"> <label for="period-select">Période</label> <select id="period-select"> <option value="3months">3 mois</option> <option value="6months">6 mois</option> <option value="all">Tout</option> </select> </div> </div> </div>
            <div class="exercise-progress-container"> <h3>Progression (Répétitions)</h3> <div class="exercise-chart-container" style="height: 300px;"> <canvas id="exercise-progress-chart"></canvas> <p id="exercise-progress-placeholder" class="chart-placeholder"></p> </div> </div>
        </div>
    </main>

    <!-- Footer -->
    <footer>
        <p>© 2024 ArmorWorkout. Sauvegarde auto sur <i class="fab fa-google-drive text-green-500"></i> Drive.</p>
        <p><a href="https://github.com/ironworkout/armorworkout" target="_blank" rel="noopener noreferrer" class="hover:text-blue-400"><i class="fab fa-github"></i> GitHub</a></p>
    </footer>

    <!-- Zone Message & Modal -->
    <div id="message-area" class="message-area" role="status" aria-live="polite"></div>
    <div id="post-workout-summary" class="post-workout-summary" role="dialog" aria-modal="true" aria-labelledby="summary-title">
        <div class="post-workout-summary-content"> <h2 id="summary-title">Résumé & Objectifs</h2> <ul id="summary-items-list" class="summary-items-list"></ul> <div class="summary-controls"> <button id="finish-summary-btn" class="app-button"><i class="fas fa-check mr-2"></i>Fin & Sauvegarder</button> </div> </div>
    </div>

    <!-- Scripts -->
    <script async defer src="https://accounts.google.com/gsi/client"></script>
    <script>
        // --- CONFIGURATION & CONSTANTES ---
        const GOOGLE_CLIENT_ID = "731283926358-viam3ulpgna14flfdeb9m92l8s620hoi.apps.googleusercontent.com"; const GOOGLE_DRIVE_SCOPES = 'https://www.googleapis.com/auth/drive.file'; const HISTORY_FILENAME = "armorworkout_history.json"; const PROGRAM_FILENAMES = { Push: "armorworkout_push_program.json", Pull: "armorworkout_pull_program.json", Legs: "armorworkout_legs_program.json" }; const PROGRAM_TYPES = ['Push', 'Pull', 'Legs']; const PREPARE_DURATION = 3; const SECONDS_PER_REP = 2.5; const IN_PROGRESS_KEY = 'armorWorkoutStateInProgress'; const GIS_CHECK_INTERVAL = 100; const GIS_MAX_RETRIES = 50;
        // --- DONNÉES PAR DÉFAUT ---
        const defaultWorkouts = { Push: [{"type":"exercise","name":"Pompes (Push-ups)","reps":15, "weight":0, "details":"Poids de corps (adapter difficulté: genoux, mains/pieds surélevés)","equipment":"Bodyweight","reps_start":8,"reps_target_max":20,"progression_note":"Quand 20 reps faciles: Augmenter difficulté (pieds plus hauts, tempo lent). Ou passer aux Pompes Déclinées. Ensuite ajouter elastiques 15 kg, 25 kg ..."},{"type":"break","duration":75,"name":"Repos"} /* ... */], Pull: [{/* ... */}], Legs: [{"type":"exercise","name":"Front Squat Combo","reps":12,"weight":15,"details":"Élastique 15+25kg + 1 haltère 5kg","equipment":"Élastique 15+25kg + 1 haltère 5kg","reps_start":12,"reps_target_max":15,"progression_note":"Quand 15 reps: Pause Squat (Pause 1-2s en bas). Recommence à 12 reps."},{"type":"break","duration":90,"name":"Repos"},{"type":"exercise","name":"Leg Raises (Relevé de jambes)","reps":12,"weight":null,"details":"Poids de corps","equipment":"Poids de corps","reps_start":12,"reps_target_max":20,"progression_note":"Quand 20 reps jambes tendues: Weighted Leg Raises (Tenir haltère 5kg entre les pieds). Recommence à 12 reps."}] };
        // --- Éléments DOM ---
        let timeDisplayDiv, timerCircle, timerStateDisplay, currentExerciseContainer, progressTracker, startPauseBtn, skipBtn, finishBtn, resetBtn, navButtons = [], navHistoryBtn, navProgressBtn, signInButton, signOutButton, exportButton, driveStatusElement, driveStatusTextElement, settingsIcon, postWorkoutSummary, summaryTitle, summaryItemsList, finishSummaryBtn, historyDriveStatus, totalProgressCircle, currentExerciseNameDisplay, driveConnectionStatusMain, driveConnectionText, timerDisplayElement, chartPlaceholder, progressTextArea, historyActionsContainer, exerciseSelect, metricSelect, periodSelect, exerciseChartPlaceholder, repAdjustmentOverlay, repAdjustMinusBtn, repAdjustPlusBtn, currentRepsDisplay, repAdjustmentExerciseName, historyChartCanvasEl, exerciseProgressChartCanvasEl, prevBtn, messageArea, outerSegmentsContainer, innerSegmentsContainer; // Séparation segments
        // --- Variables d'État ---
        let currentWorkoutType = null, currentWorkoutPlan = [], originalCompletedWorkoutPlan = []; let currentItemIndex = 0, timerInterval = null, prepareCountdownInterval = null; let totalTime = 0, timeLeft = 0, prepareTimeLeft = 0; let totalWorkoutEstimatedSeconds = 0, elapsedWorkoutEstimatedSeconds = 0; let isTimerRunning = false, isWorkoutActive = false, workoutFinished = false, wasFinishedState = false; let currentState = 'idle'; let workoutStartTime = null, workoutHistory = []; let currentHistoryPeriod = 'week'; let historyChartInstance = null, exercisePerfChartInstance = null; let googleAccessToken = null, tokenClient = null; let historyFileId = null, programFileIds = { Push: null, Pull: null, Legs: null }; let programsLoaded = false, loadedWorkouts = JSON.parse(JSON.stringify(defaultWorkouts)); let isSavingDriveData = false; let currentTheme = 'dark', messageTimeoutId = null; let audioContext = null; let nextExerciseIndexForAdjustment = -1, currentRepAdjustment = 0, isRepAdjustmentVisible = false; let gisCheckRetries = 0; let halfwayTimeoutId = null; let soundLaser, sound5, sound4, sound3, sound2, sound1, soundWindows, soundET;
        // --- Audio & Vibration ---
        function initSounds() { try { const basePath = "https://ironworkout.github.io/armorworkout/"; soundLaser = new Audio(basePath + 'laser.mp3'); sound5 = new Audio(basePath + '5.mp3'); sound4 = new Audio(basePath + '4.mp3'); sound3 = new Audio(basePath + '3.mp3'); sound2 = new Audio(basePath + '2.mp3'); sound1 = new Audio(basePath + '1.mp3'); soundWindows = new Audio(basePath + 'windows.mp3'); soundET = new Audio(basePath + 'e-t.mp3'); [soundLaser, sound5, sound4, sound3, sound2, sound1, soundWindows, soundET].forEach(sound => { if (sound) sound.preload = 'auto'; }); } catch (e) { console.error("Err son:", e); } }
        function playSound(audioElement) { if (!audioElement || !audioContext || audioContext.state !== 'running') return; try { audioElement.currentTime = 0; audioElement.play().catch(e => {}); } catch(e) {} }
        function initAudioContext() { if (audioContext && audioContext.state === 'running') return; if (!audioContext) { try { window.AudioContext = window.AudioContext || window.webkitAudioContext; if (window.AudioContext) audioContext = new AudioContext(); else return; } catch (e) { return; } } if (audioContext.state === 'suspended') audioContext.resume().catch(e => {}); }
        const playTransitionSound = () => playSound(soundLaser);
        const vibrate = (pattern = [100]) => { if ('vibrate' in navigator) try { navigator.vibrate(pattern); } catch (e) {} };
        // --- Google Identity Services (GIS) & Drive API ---
        async function gisInitInternal() { if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) { try { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: GOOGLE_CLIENT_ID, scope: GOOGLE_DRIVE_SCOPES, callback: tokenCallback, error_callback: handleTokenError, prompt: '' }); if (signInButton) signInButton.disabled = false; } catch (error) { console.error("Erreur initTokenClient:", error); updateAuthUI(false); if(signInButton) signInButton.disabled = true; } } else { if(signInButton) signInButton.disabled = true; } }
        function checkAndInitGis() { if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2 && typeof google.accounts.oauth2.initTokenClient === 'function') { gisInitInternal(); } else if (gisCheckRetries < GIS_MAX_RETRIES) { gisCheckRetries++; setTimeout(checkAndInitGis, GIS_CHECK_INTERVAL); } else { console.error(`Échec détection API Google.`); if(signInButton) signInButton.disabled = true; } }
        function handleTokenError(error) { console.error("Erreur Google Token:", error); let userMessage = `Erreur Auth: ${error.type || error.error || 'Inconnue'}`; let statusText = 'Erreur Auth'; if (driveStatusElement) { driveStatusElement.className = 'items-center gap-2 error'; driveStatusElement.style.display = 'inline-flex'; } showMessage(userMessage, 6000, true); if (driveStatusTextElement) driveStatusTextElement.textContent = statusText; updateAuthUI(false); }
        async function tokenCallback(tokenResponse) { if (driveStatusElement) driveStatusElement.className = 'items-center gap-2'; if (tokenResponse.error) { handleTokenError(tokenResponse); return; } if (tokenResponse && tokenResponse.access_token) { googleAccessToken = tokenResponse.access_token; showMessage("Connecté! Chargement...", 2500); if (driveStatusElement) { driveStatusElement.classList.add('loading'); driveStatusElement.style.display = 'inline-flex';} if(driveStatusTextElement) driveStatusTextElement.textContent = 'Chargement...'; let historyLoaded = false; let programsSuccess = false; try { await loadHistoryFromDrive(); historyLoaded = true; programsSuccess = await loadProgramsFromDrive(); programsLoaded = programsSuccess; if (programsLoaded) { showMessage("Prêt.", 3000); if (driveStatusElement) { driveStatusElement.classList.remove('loading'); driveStatusElement.classList.add('success');} if(driveStatusTextElement) driveStatusTextElement.textContent = 'Connecté'; } else { showMessage("Erreur chargement programmes.", 5000, true); if (driveStatusElement) { driveStatusElement.classList.remove('loading'); driveStatusElement.classList.add('error'); } if(driveStatusTextElement) driveStatusTextElement.textContent = 'Erreur Progs'; programsLoaded = true; } } catch (error) { console.error("Erreur chargement données Drive:", error); showMessage("Erreur majeure chargement Drive.", 6000, true); if (driveStatusElement) { driveStatusElement.classList.remove('loading', 'success'); driveStatusElement.classList.add('error'); } if(driveStatusTextElement) driveStatusTextElement.textContent = 'Erreur Données'; programsLoaded = false; } finally { updateAuthUI(true); if (programsLoaded) { populateExerciseSelect(); displayHistory(currentHistoryPeriod); displayExerciseProgress(); loadInProgressState(); } } } else { handleTokenError({ error: "invalid_response" }); } }
        function handleAuthClick() { initAudioContext(); if (!tokenClient) return; if (driveStatusElement) { driveStatusElement.classList.add('loading'); driveStatusElement.classList.remove('error', 'success'); driveStatusElement.style.display = 'inline-flex'; } if(driveStatusTextElement) driveStatusTextElement.textContent = 'Connexion...'; tokenClient.requestAccessToken({ prompt: 'consent' }); }
        function handleSignoutClick(showMessages = true) { const token = googleAccessToken; if (!token) return; if (showMessages && driveStatusElement) { driveStatusElement.classList.add('loading'); driveStatusElement.style.display = 'inline-flex'; } if(showMessages && driveStatusTextElement) driveStatusTextElement.textContent = 'Déconnexion...'; google.accounts.oauth2.revoke(token, () => { googleAccessToken = null; historyFileId = null; programFileIds = { Push: null, Pull: null, Legs: null }; programsLoaded = false; workoutHistory = []; loadedWorkouts = JSON.parse(JSON.stringify(defaultWorkouts)); clearInProgressState(); if (isWorkoutActive || currentState !== 'idle') resetCurrentWorkout(); else updateAuthUI(false); if (showMessages) showMessage("Déconnecté.", 3000); if (driveStatusElement) { driveStatusElement.style.display = 'none'; driveStatusElement.className = 'items-center gap-2'; } displayHistory(currentHistoryPeriod); clearCharts(); populateExerciseSelect(); }); }
        function updateAuthUI(isLoggedIn) { const body = document.body; body.classList.toggle('logged-in', isLoggedIn); body.classList.toggle('logged-out', !isLoggedIn); if (driveStatusElement) { driveStatusElement.style.display = isLoggedIn ? 'inline-flex' : 'none'; if (isLoggedIn) { if (!driveStatusElement.classList.contains('loading') && !driveStatusElement.classList.contains('error')) driveStatusElement.classList.add('success'); } else { driveStatusElement.className = 'items-center gap-2'; } } if(driveStatusTextElement && isLoggedIn) { const statusClass = driveStatusElement?.className || ''; if (statusClass.includes('loading')) driveStatusTextElement.textContent = 'Chargement...'; else if (statusClass.includes('error')) driveStatusTextElement.textContent = 'Erreur'; else driveStatusTextElement.textContent = 'Connecté'; } if (historyDriveStatus && historyActionsContainer) { historyActionsContainer.style.display = isLoggedIn ? 'flex' : 'none'; if (isLoggedIn) { historyDriveStatus.className = ''; if (isSavingDriveData) historyDriveStatus.classList.add('syncing'); else if (driveStatusElement?.classList.contains('loading')) historyDriveStatus.classList.add('syncing'); else if (driveStatusElement?.classList.contains('error')) historyDriveStatus.classList.add('error'); else historyDriveStatus.classList.add('success'); historyDriveStatus.textContent = historyDriveStatus.className.replace(/ing|or|ess/,'').replace('sync','Synchro').replace('succ','OK');}} if(signInButton) signInButton.disabled = isLoggedIn || !tokenClient; if(signOutButton) signOutButton.disabled = !isLoggedIn; if(exportButton) exportButton.disabled = !isLoggedIn; const isTimerActive = ['preparing', 'exercise', 'break', 'paused'].includes(currentState); navButtons.forEach(btn => { if(btn) btn.disabled = !(isLoggedIn && programsLoaded && !isTimerActive); }); if(navHistoryBtn) navHistoryBtn.disabled = isTimerActive; if(navProgressBtn) navProgressBtn.disabled = !isLoggedIn || isTimerActive; if (currentState === 'idle') { const canStartWorkout = isLoggedIn && programsLoaded && !!currentWorkoutType && currentWorkoutPlan && currentWorkoutPlan.length > 0; if(startPauseBtn) { startPauseBtn.disabled = !canStartWorkout; startPauseBtn.innerHTML = `Démarrer`; startPauseBtn.classList.remove('active'); } } else if (startPauseBtn) { startPauseBtn.disabled = ['preparing', 'finished'].includes(currentState); startPauseBtn.classList.remove('active'); } if(prevBtn) prevBtn.disabled = !(isTimerActive && currentItemIndex > 0); if(finishBtn) finishBtn.disabled = !isTimerActive; if(resetBtn) resetBtn.disabled = !isTimerActive && !isLoggedIn; updateWorkoutInfo(); displayHistory(currentHistoryPeriod); }
        async function findOrCreateFile(filename, defaultContent = "", mimeType = 'application/json') { if (!googleAccessToken) return null; const searchUrl = `https://www.googleapis.com/drive/v3/files?q=name='${encodeURIComponent(filename)}'+and+trashed=false&spaces=drive&fields=files(id,name)`; try { const searchRes = await fetch(searchUrl, { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }); if (!searchRes.ok) { if (searchRes.status === 401 || searchRes.status === 403) { handleSignoutClick(false); return null; } throw new Error(`${searchRes.status}`); } const searchData = await searchRes.json(); if (searchData.files && searchData.files.length > 0) return searchData.files[0].id; const createUrl = `https://www.googleapis.com/drive/v3/files`; const metadata = { name: filename, mimeType: mimeType }; const createRes = await fetch(createUrl, { method: 'POST', headers: { 'Authorization': `Bearer ${googleAccessToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify(metadata) }); if (!createRes.ok) throw new Error(`Création ${createRes.status}`); const createData = await createRes.json(); const newFileId = createData.id; const writeSuccess = await updateFileContent(newFileId, defaultContent); return writeSuccess ? newFileId : null; } catch (error) { return null; } }
        async function readFileContent(fileId) { if (!googleAccessToken || !fileId) return null; const url = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`; try { const response = await fetch(url, { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }); if (!response.ok) { if (response.status === 404) return ""; if (response.status === 401 || response.status === 403) { handleSignoutClick(false); return null; } throw new Error(`${response.status}`); } return await response.text(); } catch (error) { return null; } }
        async function updateFileContent(fileId, content) { if (!googleAccessToken || !fileId) return false; if (isSavingDriveData) return false; isSavingDriveData = true; if (historyDriveStatus) { historyDriveStatus.className = 'syncing'; historyDriveStatus.textContent = 'Synchro...'; } updateAuthUI(true); const url = `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`; const isJson = typeof content === 'object'; const contentToSend = isJson ? JSON.stringify(content, null, 2) : content; const contentType = isJson ? 'application/json; charset=UTF-8' : 'text/plain; charset=UTF-8'; let success = false; try { const response = await fetch(url, { method: 'PATCH', headers: { 'Authorization': `Bearer ${googleAccessToken}`, 'Content-Type': contentType }, body: contentToSend }); if (!response.ok) { if (response.status === 401 || response.status === 403) { handleSignoutClick(false); } else { throw new Error(`${response.status}`); } } else { success = true; } } catch (error) { if (historyDriveStatus) { historyDriveStatus.className = 'error'; historyDriveStatus.textContent = 'Erreur Synchro'; } } finally { isSavingDriveData = false; updateAuthUI(!!googleAccessToken); } return success; }
        // --- Fonctions Cœur du Timer ---
        function formatTime(seconds) { const cleanSeconds = Math.max(0, Math.round(seconds)); const minutes = Math.floor(cleanSeconds / 60); const remainingSeconds = cleanSeconds % 60; return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`; }
        function calculateTotalEstimatedTime(plan) { let totalSeconds = 0; plan.forEach(item => { let estimatedDuration = 0; if (item.type === 'break') estimatedDuration = item.duration || 0; else if (item.type === 'exercise') estimatedDuration = item.duration || (item.reps || 0) * SECONDS_PER_REP; item.estimatedDuration = estimatedDuration; totalSeconds += estimatedDuration; }); return totalSeconds; }
        function updateTotalProgressCircle() { if (!totalProgressCircle || totalWorkoutEstimatedSeconds <= 0 || !isWorkoutActive) { totalProgressCircle.style.backgroundImage = `conic-gradient(transparent 0%, transparent 100%)`; return; } let elapsedSeconds = 0; for (let i = 0; i < currentItemIndex; i++) { elapsedSeconds += currentWorkoutPlan[i]?.estimatedDuration || 0; } const currentItem = currentWorkoutPlan[currentItemIndex]; if (currentItem) { if (currentState === 'break' && totalTime > 0) { const elapsedInBreak = Math.min(totalTime - timeLeft, currentItem.estimatedDuration || totalTime); elapsedSeconds += elapsedInBreak; } else if (currentState === 'paused' && currentItem.type === 'break' && totalTime > 0) { const elapsedInBreak = Math.min(totalTime - timeLeft, currentItem.estimatedDuration || totalTime); elapsedSeconds += elapsedInBreak; } } if (currentState === 'finished') elapsedSeconds = totalWorkoutEstimatedSeconds; const percentage = totalWorkoutEstimatedSeconds > 0 ? Math.min(100, (elapsedSeconds / totalWorkoutEstimatedSeconds) * 100) : 0; const gradient = `conic-gradient(var(--total-progress-color) ${percentage}%, transparent ${percentage}%)`; totalProgressCircle.style.backgroundImage = gradient; }
        // --- updateTimerDisplay (Simplifiée) ---
        function updateTimerDisplay() { if (!timeDisplayDiv || !timerStateDisplay) return; let timeString = "00:00"; let stateText = ''; const item = currentWorkoutPlan[currentItemIndex]; switch(currentState) { case 'exercise': timeString = "GO!"; stateText = item?.name || 'Exercice'; break; case 'break': timeString = formatTime(timeLeft); stateText = 'Repos'; break; case 'paused': timeString = (item?.type === 'break') ? formatTime(timeLeft) : "PAUSE"; stateText = 'En Pause'; break; case 'preparing': timeString = formatTime(prepareTimeLeft); stateText = 'Préparation'; break; case 'finished': timeString = "FINI!"; stateText = 'Terminé !'; break; default: timeString = formatTime(0); stateText = 'Prêt'; break; } timeDisplayDiv.textContent = timeString; timerStateDisplay.textContent = stateText; updateTotalProgressCircle(); }
        // --- MAJ Apparence Timer (V1 - Cahier des Charges) ---
        function updateTimerAppearance(state) {
            if (!timerCircle || !timeDisplayDiv) return; // timerStateDisplay n'est pas dans V1 timer
            let stateColor = 'var(--idle-color)'; // Couleur par défaut
            let glowValue = `0 0 60px rgba(${getComputedStyle(document.documentElement).getPropertyValue('--idle-color-rgb')}, 0.6)`; // Glow par défaut

            switch(state) {
                case 'exercise': stateColor = 'var(--exercise-color)'; glowValue = `0 0 60px rgba(${getComputedStyle(document.documentElement).getPropertyValue('--exercise-color-rgb')}, 0.8)`; break;
                case 'break': stateColor = 'var(--break-color)'; glowValue = `0 0 60px rgba(${getComputedStyle(document.documentElement).getPropertyValue('--break-color-rgb')}, 0.8)`; break;
                case 'paused': stateColor = 'var(--paused-color)'; glowValue = `0 0 60px rgba(${getComputedStyle(document.documentElement).getPropertyValue('--paused-color-rgb')}, 0.8)`; break;
                case 'preparing': stateColor = 'var(--preparing-color)'; glowValue = `0 0 60px rgba(${getComputedStyle(document.documentElement).getPropertyValue('--preparing-color-rgb')}, 0.8)`; break;
                 case 'finished': stateColor = 'var(--finished-color)'; glowValue = `0 0 60px rgba(${getComputedStyle(document.documentElement).getPropertyValue('--finished-color-rgb')}, 0.8)`; break;
            }
            timerCircle.style.boxShadow = glowValue;
            timeDisplayDiv.style.color = `var(${stateColor})`; // Utiliser la variable CSS pour la couleur
            timeDisplayDiv.style.textShadow = glowValue.replace('60px','10px').replace('0.8','0.7'); // Ajuster le text shadow
            // Le texte #timer-state peut aussi être mis à jour si besoin
            if(timerStateDisplay) { timerStateDisplay.style.color = `var(${stateColor})`; timerStateDisplay.style.textShadow = glowValue.replace('60px','8px').replace('0.8','0.6'); }
        }
        // --- Reste des fonctions ---
        function findPreviousPerformance(exerciseName) { if (!workoutHistory || workoutHistory.length === 0) return null; for (let i = workoutHistory.length - 1; i >= 0; i--) { const entry = workoutHistory[i]; if (!entry.exercises) continue; const foundExercise = entry.exercises.find(ex => ex.name === exerciseName); if (foundExercise) { return { reps: foundExercise.actualReps ?? foundExercise.reps, weight: foundExercise.actualWeight ?? foundExercise.weight, date: new Date(entry.date) }; } } return null; }
        function updateWorkoutInfo() { if (!currentExerciseContainer || !currentExerciseNameDisplay || !progressTracker || !progressTextArea) return; const item = currentWorkoutPlan[currentItemIndex]; let infoHtml = ''; let exerciseName = ''; let progressText = ''; const body = document.body; switch (currentState) { case 'idle': exerciseName = "ArmorWorkout"; const loginMsg = `<div class="app-button rounded-full px-6 py-2 flex items-center text-sm" style="border-style: dashed; cursor: default;"><i class="fas fa-sign-in-alt mr-2"></i><span>Connectez-vous.</span></div>`; const loadingMsg = `<div class="app-button rounded-full px-6 py-2 flex items-center text-sm" style="border-style: dashed; cursor: default;"><i class="fas fa-spinner fa-spin mr-2"></i><span>Chargement...</span></div>`; const selectMsg = `<div class="app-button rounded-full px-6 py-2 flex items-center text-sm" style="border-style: dashed; cursor: default;"><i class="fas fa-hand-pointer mr-2"></i><span>Sélectionnez P/P/L</span></div>`; const readyMsg = `<div class="app-button rounded-full px-6 py-2 flex items-center text-sm" style="border-style: dashed; cursor: default;"><i class="fas fa-play-circle mr-2"></i><span>Prêt: ${currentWorkoutType}.</span></div>`; if (!googleAccessToken) { progressText = "Connectez-vous"; infoHtml = loginMsg; } else if (!programsLoaded) { progressText = "Chargement..."; infoHtml = loadingMsg; } else if (!currentWorkoutType) { progressText = "Sélectionnez P/P/L"; infoHtml = selectMsg; } else { progressText = `Prêt: ${currentWorkoutType}`; infoHtml = readyMsg; } break; case 'finished': const durationSeconds = workoutStartTime ? (Date.now() - workoutStartTime) / 1000 : 0; exerciseName = 'Terminé !'; infoHtml = `<div class="flex items-center justify-center text-green-400"><i class="fas ${getIconForState('finished')} mr-2"></i><span>Bravo ! ${durationSeconds > 0 ? `(${formatTime(durationSeconds)})` : ''}</span></div>`; progressText = `Fini (${originalCompletedWorkoutPlan.length}/${originalCompletedWorkoutPlan.length})`; break; case 'preparing': const nextItem = currentWorkoutPlan[0]; exerciseName = `Préparation...`; infoHtml = `<div class="flex items-center justify-center text-yellow-400"><i class="fas ${getIconForState('preparing')} fa-spin mr-2"></i><span>Prêt pour <strong>${nextItem?.name || '?'}</strong> (${prepareTimeLeft}s)...</span></div>`; progressText = `Prépa... (1/${currentWorkoutPlan.length})`; break; case 'exercise': case 'paused': case 'break': if (!item) { exerciseName = 'Erreur'; infoHtml = '<p>Erreur.</p>'; progressText = `Étape ?/${currentWorkoutPlan.length}`; break; } exerciseName = `${item.name || (item.type === 'break' ? 'Repos' : '?')}`; progressText = `Étape ${currentItemIndex + 1}/${currentWorkoutPlan.length}`; if (item.type === 'exercise') { const reps = (item.actualReps !== undefined ? item.actualReps : item.reps) ?? '-'; const weight = (item.actualWeight !== undefined ? item.actualWeight : item.weight) ?? '-'; const details = item.details || ''; infoHtml = `<div class="text-sm text-gray-400 flex flex-wrap justify-center gap-x-4 gap-y-1"><span><i class="fas ${getIconForType('exercise')} text-pink-400 mr-1"></i> ${reps}r</span><span><i class="fas fa-weight-hanging mr-1"></i> ${weight}${weight !== '-' ? 'kg' : ''}</span>${details ? `<span class="w-full text-xs opacity-80"><i class="fas fa-info-circle mr-1"></i> ${details}</span>` : ''}</div>`; } else if (item.type === 'break') { infoHtml = `<div class="text-sm text-yellow-400 flex items-center justify-center"><i class="fas ${getIconForType('break')} mr-2"></i><span>Pause: ${formatTime(item.duration || 0)}</span></div>`; const nextExerciseIndex = currentItemIndex + 1; if (nextExerciseIndex < currentWorkoutPlan.length && currentWorkoutPlan[nextExerciseIndex].type === 'exercise') { const nextEx = currentWorkoutPlan[nextExerciseIndex]; const nextReps = nextEx.reps ?? '-'; const nextWeight = nextEx.weight ?? '-'; infoHtml += `<div class="text-xs text-gray-500 mt-1"><i class="fas fa-arrow-right mr-1"></i><span>Suiv: ${nextEx.name || '?'} (${nextReps}r@${nextWeight}${nextWeight !== '-' ? 'kg' : ''})</span></div>`; } } break; default: exerciseName = '?'; infoHtml = '<p>?</p>'; progressText = ''; break; } if(currentExerciseNameDisplay) currentExerciseNameDisplay.textContent = exerciseName; if(currentExerciseContainer) currentExerciseContainer.innerHTML = infoHtml; if(progressTextArea) progressTextArea.textContent = progressText; const stateClassPrefix = 'state-'; document.body.className = Array.from(document.body.classList).filter(cls => !cls.startsWith(stateClassPrefix)).join(' ') + ` ${stateClassPrefix}${currentState}`; document.body.classList.toggle('workout-active', !['idle', 'finished'].includes(currentState)); }
        function getIconForState(state){ switch(state){ case 'exercise': return 'fa-dumbbell'; case 'break': return 'fa-hourglass-half'; case 'preparing': return 'fa-spinner'; case 'paused': return 'fa-pause-circle'; case 'finished': return 'fa-check-circle'; case 'idle': return 'fa-play-circle'; default: return 'fa-question-circle'; }}
        function getIconForType(type){ return type === 'exercise' ? 'fa-dumbbell' : 'fa-hourglass-half'; }
        function setState(newState) { if (!startPauseBtn || !skipBtn || !finishBtn || !resetBtn || !timerStateDisplay || !workoutSection || !timerDisplayElement || !prevBtn || !timeDisplayDiv) return; const previousState = currentState; if (previousState === newState && newState !== 'idle') return; currentState = newState; clearInterval(timerInterval); clearInterval(prepareCountdownInterval); clearTimeout(halfwayTimeoutId); if(timerStateDisplay) { timerStateDisplay.classList.remove('preparing'); timerStateDisplay.classList.toggle('visible', newState !== 'idle'); } if(timerDisplayElement) timerDisplayElement.classList.remove('finished-animation'); const stateClassPrefix = 'state-'; document.body.className = Array.from(document.body.classList).filter(cls => !cls.startsWith(stateClassPrefix)).join(' ') + ` ${stateClassPrefix}${currentState}`; document.body.classList.toggle('workout-active', !['idle', 'finished'].includes(newState)); if(startPauseBtn) startPauseBtn.classList.remove('active'); if(startPauseBtn) startPauseBtn.disabled = true; if(skipBtn) skipBtn.disabled = true; if(prevBtn) prevBtn.disabled = true; if(finishBtn) finishBtn.disabled = true; if(resetBtn) resetBtn.disabled = true; const isTimerActive = ['preparing', 'exercise', 'break', 'paused'].includes(newState); navButtons.forEach(btn => { if(btn) btn.disabled = !(googleAccessToken && programsLoaded && !isTimerActive); }); if(navHistoryBtn) navHistoryBtn.disabled = isTimerActive; if(navProgressBtn) navProgressBtn.disabled = !googleAccessToken || isTimerActive; hideRepAdjustmentOverlay(); switch (newState) { case 'idle': isTimerRunning=false; isWorkoutActive=false; workoutFinished=false; timeLeft=0; totalTime=0; const canStartIdle = googleAccessToken && programsLoaded && !!currentWorkoutType && currentWorkoutPlan && currentWorkoutPlan.length > 0; if(startPauseBtn) { startPauseBtn.disabled = !canStartIdle; startPauseBtn.innerHTML = `Démarrer`; } if(resetBtn) resetBtn.disabled = !(googleAccessToken && !!currentWorkoutType); prevBtn.disabled = true; finishBtn.disabled = true; break; case 'preparing': isWorkoutActive=true; if(timerStateDisplay) timerStateDisplay.classList.add('preparing'); prepareTimeLeft = PREPARE_DURATION; if(startPauseBtn) { startPauseBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Prépa...`; startPauseBtn.disabled = true; } if(resetBtn) resetBtn.disabled = !googleAccessToken; prevBtn.disabled = true; finishBtn.disabled = true; startPrepareCountdown(); if (!workoutStartTime) workoutStartTime = Date.now(); break; case 'exercise': isWorkoutActive=true; isTimerRunning = false; timeLeft=0; totalTime=0; if (googleAccessToken) { if(startPauseBtn) { startPauseBtn.disabled=false; startPauseBtn.innerHTML=`<i class="fas fa-check mr-2"></i> Fait`; } if(skipBtn) skipBtn.disabled=false; if(prevBtn) prevBtn.disabled = currentItemIndex <= 0; if(finishBtn) finishBtn.disabled=false; if(resetBtn) resetBtn.disabled=false; } findNextExerciseForAdjustment(); break; case 'break': isTimerRunning=true; isWorkoutActive=true; if (googleAccessToken) { if(startPauseBtn) { startPauseBtn.disabled=false; startPauseBtn.innerHTML=`<i class="fas fa-pause mr-2"></i> Pause`; } if(skipBtn) skipBtn.disabled=false; if(prevBtn) prevBtn.disabled = currentItemIndex <= 0; if(finishBtn) finishBtn.disabled=false; if(resetBtn) resetBtn.disabled=false; } startBreakTimer(); findNextExerciseForAdjustment(); break; case 'paused': isTimerRunning=false; isWorkoutActive=true; if (googleAccessToken) { if(startPauseBtn) { startPauseBtn.disabled=false; startPauseBtn.innerHTML=`<i class="fas fa-play mr-2"></i> Reprendre`; startPauseBtn.classList.add('active'); } if(skipBtn) skipBtn.disabled=false; if(prevBtn) prevBtn.disabled = currentItemIndex <= 0; if(finishBtn) finishBtn.disabled=false; if(resetBtn) resetBtn.disabled=false; } break; case 'finished': isWorkoutActive=false; isTimerRunning = false; workoutFinished=true; wasFinishedState=true; timeLeft=0; totalTime=0; elapsedWorkoutEstimatedSeconds=totalWorkoutEstimatedSeconds; if(startPauseBtn) { startPauseBtn.disabled=true; startPauseBtn.innerHTML=`<i class="fas fa-check-circle mr-2"></i> Terminé`; } if(skipBtn) skipBtn.disabled = true; if(prevBtn) prevBtn.disabled = true; if(finishBtn) finishBtn.disabled = true; if(resetBtn) resetBtn.disabled = !googleAccessToken; showMessage('Terminé ! 💪', 3000); vibrate([150, 50, 150]); playSound(soundET); originalCompletedWorkoutPlan = JSON.parse(JSON.stringify(currentWorkoutPlan)); saveWorkoutToHistory(); clearInProgressState(); if(timerDisplayElement) timerDisplayElement.classList.add('finished-animation'); setTimeout(populateAndShowSummary, 500); break; default: currentState = 'idle'; updateAuthUI(!!googleAccessToken); break; } updateTimerDisplay(); updateWorkoutInfo(); updateTimerAppearance(newState); /* Appel fonction du cahier des charges */ }
        function startPrepareCountdown() { if (prepareCountdownInterval) clearInterval(prepareCountdownInterval); prepareTimeLeft = PREPARE_DURATION; updateTimerDisplay(); updateWorkoutInfo(); updateTimerAppearance('preparing'); if(timerStateDisplay) timerStateDisplay.textContent = `PRÉPA ${prepareTimeLeft}s`; prepareCountdownInterval = setInterval(() => { prepareTimeLeft--; updateTimerDisplay(); updateWorkoutInfo(); updateTimerAppearance('preparing'); if(timerStateDisplay) timerStateDisplay.textContent = `PRÉPA ${prepareTimeLeft}s`; if (prepareTimeLeft <= 0) { clearInterval(prepareCountdownInterval); playTransitionSound(); vibrate(); const firstItem = currentWorkoutPlan[0]; if (!firstItem) { resetCurrentWorkout(); return; } const nextState = firstItem.type === 'exercise' ? 'exercise' : 'break'; setState(nextState); if (nextState === 'break') { totalTime = firstItem.duration || 0; timeLeft = totalTime; } saveInProgressState(); } else if (prepareTimeLeft <= 3 && prepareTimeLeft > 0 && window[`sound${prepareTimeLeft}`]) playSound(window[`sound${prepareTimeLeft}`]); }, 1000); }
        function startBreakTimer() { if (timerInterval) clearInterval(timerInterval); updateTimerDisplay(); updateTimerAppearance('break'); clearTimeout(halfwayTimeoutId); const halfwayPoint = Math.floor(totalTime / 2); const halfwayTriggerTime = halfwayPoint; if (totalTime >= 10 && timeLeft >= halfwayTriggerTime && halfwayPoint > 0) { const delay = (timeLeft - halfwayTriggerTime) * 1000; if (delay >= 0) { halfwayTimeoutId = setTimeout(() => { playSound(soundWindows); console.log("Halfway sound played"); }, delay); } } timerInterval = setInterval(() => { if (timeLeft > 0) { timeLeft--; updateTimerDisplay(); updateTimerAppearance('break'); saveInProgressState(); if (timeLeft <= 5 && timeLeft > 0 && window[`sound${timeLeft}`]) playSound(window[`sound${timeLeft}`]); } else { clearInterval(timerInterval); clearTimeout(halfwayTimeoutId); handleItemCompletion(true); } }, 1000); }
        function handleItemCompletion(naturalEnd = false) { clearTimeout(halfwayTimeoutId); if (!['exercise', 'break', 'paused'].includes(currentState)) return; playTransitionSound(); const completedItemIndex = currentItemIndex; const completedItem = currentWorkoutPlan[completedItemIndex]; if (completedItem?.estimatedDuration) elapsedWorkoutEstimatedSeconds += completedItem.estimatedDuration; if (completedItem?.type === 'exercise' && currentRepAdjustment !== 0) { const baseReps = completedItem.reps || 0; completedItem.actualReps = Math.max(0, baseReps + currentRepAdjustment); currentRepAdjustment = 0; } if (naturalEnd && currentState === 'break') vibrate(); currentItemIndex++; saveInProgressState(); if (currentItemIndex >= currentWorkoutPlan.length) setState('finished'); else { const nextItem = currentWorkoutPlan[currentItemIndex]; if (!nextItem) { setState('finished'); return; } const nextState = nextItem.type === 'exercise' ? 'exercise' : 'break'; setState(nextState); if (nextState === 'break') { totalTime = nextItem.duration || 0; timeLeft = totalTime; } } }
        function handlePreviousClick() { if (!isWorkoutActive || currentItemIndex <= 0) return; clearTimeout(halfwayTimeoutId); const currentItemLeaving = currentWorkoutPlan[currentItemIndex]; if (currentItemLeaving?.estimatedDuration && elapsedWorkoutEstimatedSeconds > 0) elapsedWorkoutEstimatedSeconds = Math.max(0, elapsedWorkoutEstimatedSeconds - currentItemLeaving.estimatedDuration); currentItemIndex--; const previousItemReturningTo = currentWorkoutPlan[currentItemIndex]; if (previousItemReturningTo?.estimatedDuration && elapsedWorkoutEstimatedSeconds > 0) elapsedWorkoutEstimatedSeconds = Math.max(0, elapsedWorkoutEstimatedSeconds - previousItemReturningTo.estimatedDuration); const previousState = currentWorkoutPlan[currentItemIndex].type === 'exercise' ? 'exercise' : 'break'; if (previousState === 'break') { totalTime = currentWorkoutPlan[currentItemIndex].duration || 0; timeLeft = totalTime; } else { timeLeft = 0; totalTime = 0; } currentRepAdjustment = 0; setState(previousState); saveInProgressState(); showMessage("Retour étape précédente.", 1500); playTransitionSound(); vibrate([50,50,50]); }
        function forceFinishWorkout() { if (!isWorkoutActive || workoutFinished || currentState === 'preparing') return; if (confirm("Terminer l'entraînement ?")) { clearTimeout(halfwayTimeoutId); clearInterval(timerInterval); clearInterval(prepareCountdownInterval); setState('finished'); showMessage("Entraînement terminé.", 2500); } }
        function loadWorkout(type) { if (!googleAccessToken) { showMessage("Connectez-vous.", 3000, true); return; } if (!programsLoaded) { showMessage("Programmes non prêts...", 3000, true); return; } if (!loadedWorkouts[type] || !Array.isArray(loadedWorkouts[type])) { showMessage(`Erreur Pgm "${type}".`, 4000, true); currentWorkoutType = null; setActiveWorkoutNav(null); setState('idle'); return; } if (loadedWorkouts[type].length === 0) { showMessage(`Pgm "${type}" vide.`, 4000, true); currentWorkoutType = type; setActiveWorkoutNav(type); currentWorkoutPlan = []; setState('idle'); return; } if (isWorkoutActive && currentWorkoutType !== type) { if (!confirm(`Arrêter "${currentWorkoutType}" et charger "${type}" ?`)) { setActiveWorkoutNav(currentWorkoutType); return; } resetCurrentWorkout(); } else if (currentState === 'finished' && currentWorkoutType !== type) { resetCurrentWorkout(); } else if (currentWorkoutType === type && (isWorkoutActive || currentState === 'idle' || currentState === 'finished')) { showMessage(`"${type}" déjà ${currentState}.`, 3000); showSection('workout-section'); setActiveWorkoutNav(type); return; } currentWorkoutType = type; currentWorkoutPlan = JSON.parse(JSON.stringify(loadedWorkouts[type])); totalWorkoutEstimatedSeconds = calculateTotalEstimatedTime(currentWorkoutPlan); elapsedWorkoutEstimatedSeconds = 0; currentItemIndex = 0; workoutStartTime = null; isTimerRunning = false; isWorkoutActive = false; workoutFinished = false; currentRepAdjustment = 0; setActiveWorkoutNav(type); showSection('workout-section'); closeSummary(false); setState('idle'); showMessage(`"${type}" chargé.`, 2500); }
        function resetCurrentWorkout() { clearTimeout(halfwayTimeoutId); clearInterval(timerInterval); clearInterval(prepareCountdownInterval); const typeReset = currentWorkoutType; currentWorkoutType=null; currentWorkoutPlan=[]; originalCompletedWorkoutPlan=[]; currentItemIndex=0; workoutStartTime=null; isTimerRunning=false; isWorkoutActive=false; workoutFinished=false; wasFinishedState=false; timeLeft=0; totalTime=0; prepareTimeLeft=0; totalWorkoutEstimatedSeconds=0; elapsedWorkoutEstimatedSeconds=0; currentRepAdjustment=0; clearInProgressState(); closeSummary(false); if(timerDisplayElement) timerDisplayElement.classList.remove('finished-animation'); setActiveWorkoutNav(null); showSection('workout-section'); setState('idle'); if (typeReset) showMessage(`"${typeReset}" réinitialisé.`, 2000); }
        function showMessage(msg, duration = 3000, isError = false) { if (!messageArea) return; messageArea.textContent = msg; messageArea.classList.toggle('error-message', isError); messageArea.classList.add('visible'); if (messageTimeoutId) clearTimeout(messageTimeoutId); messageTimeoutId = setTimeout(() => { messageArea.classList.remove('visible'); messageArea.classList.remove('error-message'); }, duration); }
        function applyTheme(theme) { const body = document.body; currentTheme = theme; body.classList.remove('light-theme', 'dark-theme'); body.classList.add(theme + '-theme'); try { localStorage.setItem('theme', theme); } catch (e) {} updateChartColors(); }
        function loadSavedTheme() { let savedTheme = 'dark'; try { savedTheme = localStorage.getItem('theme') || 'dark'; } catch (e) {} applyTheme(savedTheme); }
        function showSection(sectionId) { const sections = { 'workout-section': workoutSection, 'history-section': historySection, 'progress-section': progressSection }; Object.values(sections).forEach(section => section?.classList.add('section-hidden')); document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active', 'text-white', 'border-accent-color', 'border-pink-500', 'border-green-500')); const sectionToShow = sections[sectionId]; if (sectionToShow) sectionToShow.classList.remove('section-hidden'); const navLinks = { 'workout-section': navButtons, 'history-section': [navHistoryBtn], 'progress-section': [navProgressBtn] }; const linksToActivate = navLinks[sectionId]; if (linksToActivate) { let activeColorClass = 'border-accent-color'; if (sectionId === 'history-section') activeColorClass = 'border-pink-500'; else if (sectionId === 'progress-section') activeColorClass = 'border-green-500'; else if (currentWorkoutType) { const btn = document.getElementById(`nav-${currentWorkoutType.toLowerCase()}`); btn?.classList.add('active', 'text-white', 'border-accent-color'); return; } linksToActivate.forEach(btn => btn?.classList.add('active', 'text-white', activeColorClass)); } }
        function setActiveWorkoutNav(type) { navButtons.forEach(btn => { const isActive = btn.dataset.workout === type; btn.classList.toggle('active', isActive); btn.classList.toggle('text-white', isActive); btn.classList.toggle('border-accent-color', isActive); }); if (type) showSection('workout-section'); }
        function displayHistory(period = 'week') { if (!historyList || !statsDisplay || !historyChartCanvasEl) return; if (!googleAccessToken) { historyList.innerHTML = '<li class="no-history">Connectez-vous.</li>'; if(statsContentWrapper) statsContentWrapper.innerHTML = '<p>Connectez-vous.</p>'; clearCharts(); setChartPlaceholder('history-chart-canvas', "Connectez-vous."); return; } currentHistoryPeriod = period; historyFilterBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.period === period)); const filteredHistory = filterHistoryByPeriod(workoutHistory, period); renderHistoryList(filteredHistory); calculateAndDisplayStats(filteredHistory); renderHistoryChart(filteredHistory); }
        function filterHistoryByPeriod(history, period) { const now = new Date(); let startDate = new Date(); switch (period) { case 'week': startDate.setDate(now.getDate() - 7); break; case 'month': startDate.setMonth(now.getMonth() - 1); break; case 'year': startDate.setFullYear(now.getFullYear() - 1); break; case 'all': return history; default: startDate.setDate(now.getDate() - 7); } startDate.setHours(0, 0, 0, 0); return history.filter(entry => new Date(entry.date) >= startDate); }
        function renderHistoryList(filteredHistory) { if (!historyList) return; if (filteredHistory.length === 0) { historyList.innerHTML = '<li class="no-history">Aucun entraînement.</li>'; return; } historyList.innerHTML = filteredHistory.sort((a, b) => new Date(b.date) - new Date(a.date)).map(entry => { const date = new Date(entry.date); const formattedDate = date.toLocaleDateString('fr-FR', { weekday: 'short', day: '2-digit', month: 'short' }); const formattedTime = date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }); const durationSeconds = entry.durationSeconds || 0; const formattedDuration = durationSeconds > 0 ? formatTime(durationSeconds) : 'N/A'; const type = entry.type || 'Inconnu'; const totalReps = entry.totalReps ?? '?'; return `<li><span class="history-item-date">${formattedDate} <small>(${formattedTime})</small></span><span class="history-item-type">${type}</span><span class="history-item-reps"><i class="fas fa-hashtag"></i> ${totalReps}</span><span class="history-item-duration">${formattedDuration}</span></li>`; }).join(''); }
        function calculateAndDisplayStats(filteredHistory) { if (!statsContentWrapper || !statsDisplay) return; const numWorkouts = filteredHistory.length; let totalDuration = 0; let workoutTypes = {}; let totalRepsSum = 0; filteredHistory.forEach(entry => { totalDuration += entry.durationSeconds || 0; const type = entry.type || 'Inconnu'; workoutTypes[type] = (workoutTypes[type] || 0) + 1; totalRepsSum += entry.totalReps || 0; }); const avgDuration = numWorkouts > 0 ? totalDuration / numWorkouts : 0; const avgReps = numWorkouts > 0 ? Math.round(totalRepsSum / numWorkouts) : 0; const formattedAvgDuration = formatTime(avgDuration); let statsHtml = `<p><i class="fas fa-calendar-check"></i> Séances: <strong>${numWorkouts}</strong></p>`; if (numWorkouts > 0) { statsHtml += `<p><i class="fas fa-stopwatch"></i> Durée totale: <strong>${formatTime(totalDuration)}</strong></p>`; statsHtml += `<p><i class="fas fa-clock"></i> Durée moyenne: <strong>${formattedAvgDuration}</strong></p>`; statsHtml += `<p><i class="fas fa-hashtag"></i> Reps totales: <strong>${totalRepsSum}</strong> (Moy: ${avgReps})</p>`; statsHtml += `<p><i class="fas fa-tags"></i> Répartition:</p><ul>`; for (const type in workoutTypes) { statsHtml += `<li style="margin-left: 25px; font-size: 0.95em;">- ${type}: ${workoutTypes[type]}</li>`; } statsHtml += `</ul>`; } else { statsHtml += '<p>Aucune donnée.</p>'; } statsContentWrapper.innerHTML = statsHtml; const motivationalMessage = statsDisplay.querySelector('.motivational-message'); if (motivationalMessage) { if (numWorkouts > 5) motivationalMessage.textContent = "Super régularité ! 💪"; else if (numWorkouts > 0) motivationalMessage.textContent = "Chaque séance compte !"; else motivationalMessage.textContent = "Prêt à commencer ?"; } }
        function aggregateChartData(hist, period, metric = 'durationSeconds') { const agg = new Map(); let labels = []; switch (period) { case 'week': labels = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim']; labels.forEach(l => agg.set(l, 0)); const nowW = new Date(); const todayW = new Date(nowW.getFullYear(), nowW.getMonth(), nowW.getDate()); const wd = todayW.getDay(); const diff = todayW.getDate() - wd + (wd === 0 ? -6 : 1); const startW = new Date(nowW.getFullYear(), nowW.getMonth(), diff); startW.setHours(0, 0, 0, 0); hist.forEach(e => { const d = new Date(e.date); if (d >= startW) { let dayIndex = d.getDay(); dayIndex = dayIndex === 0 ? 6 : dayIndex - 1; const value = metric === 'durationSeconds' ? (e.durationSeconds || 0) : (e.totalReps || 0); agg.set(labels[dayIndex], (agg.get(labels[dayIndex]) || 0) + value); } }); break; case 'month': labels = ['S1-7', 'S8-14', 'S15-21', 'S22-28', 'S29+']; labels.forEach(l => agg.set(l, 0)); const curM = new Date().getMonth(); const curY = new Date().getFullYear(); hist.forEach(e => { const d = new Date(e.date); if (d.getMonth() === curM && d.getFullYear() === curY) { const dayOfMonth = d.getDate(); let weekIndex = 0; if (dayOfMonth <= 7) weekIndex = 0; else if (dayOfMonth <= 14) weekIndex = 1; else if (dayOfMonth <= 21) weekIndex = 2; else if (dayOfMonth <= 28) weekIndex = 3; else weekIndex = 4; const value = metric === 'durationSeconds' ? (e.durationSeconds || 0) : (e.totalReps || 0); agg.set(labels[weekIndex], (agg.get(labels[weekIndex]) || 0) + value); } }); break; case 'year': labels = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Aoû', 'Sep', 'Oct', 'Nov', 'Déc']; labels.forEach(l => agg.set(l, 0)); const curY2 = new Date().getFullYear(); hist.forEach(e => { const d = new Date(e.date); if (d.getFullYear() === curY2) { const monthIndex = d.getMonth(); const value = metric === 'durationSeconds' ? (e.durationSeconds || 0) : (e.totalReps || 0); agg.set(labels[monthIndex], (agg.get(labels[monthIndex]) || 0) + value); } }); break; default: const yearData = {}; hist.forEach(e => { const y = new Date(e.date).getFullYear(); if (!isNaN(y)) { const value = metric === 'durationSeconds' ? (e.durationSeconds || 0) : (e.totalReps || 0); yearData[y] = (yearData[y] || 0) + value; } }); labels = Object.keys(yearData).map(Number).sort((a, b) => a - b).map(String); labels.forEach(y => agg.set(y, yearData[y])); break; } return { labels, data: labels.map(l => agg.get(l) || 0) }; }
        function getChartXAxisTitle(period){ switch(period){ case 'week': return 'Jour'; case 'month': return 'Semaine'; case 'year': return 'Mois'; default: return 'Année'; }}
        function renderHistoryChart(filteredHistory) { if (!historyChartCanvasEl) return; const ctx = historyChartCanvasEl.getContext('2d'); if (!ctx) return; const { labels, data } = aggregateChartData(filteredHistory, currentHistoryPeriod, 'durationSeconds'); if (labels.length === 0 || data.every(d => d === 0)) { setChartPlaceholder('history-chart-canvas', "Aucune donnée."); if (historyChartInstance) { historyChartInstance.destroy(); historyChartInstance = null; } return; } else { setChartPlaceholder('history-chart-canvas', "", false); } const styles = getComputedStyle(document.documentElement); const primColor = styles.getPropertyValue('--info-color').trim(); const primColorRgb = '96, 165, 250'; const gridColor = styles.getPropertyValue('--border-color').trim(); const textColor = styles.getPropertyValue('--secondary-text').trim(); const tooltipBg = `rgba(17, 24, 39, 0.8)`; const tooltipText = styles.getPropertyValue('--primary-text').trim(); const chartData = { labels, datasets: [{ label: 'Durée (min)', data: data.map(d => Math.round(d / 60)), backgroundColor: `rgba(${primColorRgb}, 0.6)`, borderColor: primColor, borderWidth: 1, borderRadius: 3, hoverBackgroundColor: `rgba(${primColorRgb}, 0.8)`, hoverBorderColor: primColor }] }; const chartOptions = { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: 'Minutes', color: textColor }, ticks: { color: textColor, callback: v => v + 'm' }, grid: { color: gridColor } }, x: { title: { display: true, text: getChartXAxisTitle(currentHistoryPeriod), color: textColor }, ticks: { color: textColor }, grid: { display: false } } }, plugins: { legend: { display: false }, tooltip: { backgroundColor: tooltipBg, titleColor: tooltipText, bodyColor: tooltipText, padding: 10, cornerRadius: 4, displayColors: false, callbacks: { label: ctx => `Durée: ${formatTime(data[ctx.dataIndex] || 0)}` } } } }; if (historyChartInstance) { historyChartInstance.data = chartData; historyChartInstance.options = chartOptions; historyChartInstance.update(); } else { historyChartInstance = new Chart(ctx, { type: 'bar', data: chartData, options: chartOptions }); } }
        function updateChartColors() { const styles = getComputedStyle(document.documentElement); const textColor = styles.getPropertyValue('--secondary-text').trim(); const gridColor = styles.getPropertyValue('--border-color').trim(); const tooltipBg = `rgba(17, 24, 39, 0.8)`; const tooltipText = styles.getPropertyValue('--primary-text').trim(); const primColor = styles.getPropertyValue('--info-color').trim(); const secColor = styles.getPropertyValue('--action-color').trim(); const terColor = styles.getPropertyValue('--exercise-color').trim(); const primColorRgb = '96, 165, 250'; const secColorRgb = '167, 139, 250'; const terColorRgb = '244, 114, 182'; [historyChartInstance, exercisePerfChartInstance].forEach(chartInstance => { if (chartInstance) { try { chartInstance.options.scales.x.ticks.color = textColor; chartInstance.options.scales.x.grid.color = gridColor; if (chartInstance.options.scales.x.title) chartInstance.options.scales.x.title.color = textColor; chartInstance.options.scales.y.ticks.color = textColor; chartInstance.options.scales.y.grid.color = gridColor; if (chartInstance.options.scales.y.title) chartInstance.options.scales.y.title.color = textColor; if(chartInstance.options.scales.yMetric) { chartInstance.options.scales.yMetric.ticks.color = textColor; chartInstance.options.scales.yMetric.grid.color = gridColor; if (chartInstance.options.scales.yMetric.title) chartInstance.options.scales.yMetric.title.color = textColor; } chartInstance.options.plugins.tooltip.backgroundColor = tooltipBg; chartInstance.options.plugins.tooltip.titleColor = tooltipText; chartInstance.options.plugins.tooltip.bodyColor = tooltipText; chartInstance.data.datasets.forEach((dataset, i) => { let mainColor = primColor; let mainColorRgb = primColorRgb; if (chartInstance === exercisePerfChartInstance) { mainColor = (dataset.label === 'Total Répétitions par Séance') ? secColor : primColor; mainColorRgb = (dataset.label === 'Total Répétitions par Séance') ? secColorRgb : primColorRgb; if(i === 1) { mainColor = terColor; mainColorRgb = terColorRgb; } } else if (chartInstance === historyChartInstance) { mainColor = primColor; mainColorRgb = primColorRgb; } dataset.borderColor = mainColor; dataset.backgroundColor = `rgba(${mainColorRgb}, ${chartInstance.config.type === 'bar' || dataset.fill ? 0.6 : 0.2})`; if(dataset.pointBackgroundColor) dataset.pointBackgroundColor = mainColor; if(dataset.pointBorderColor) dataset.pointBorderColor = mainColor; if(dataset.hoverBackgroundColor) dataset.hoverBackgroundColor = `rgba(${mainColorRgb}, 0.8)`; if(dataset.hoverBorderColor) dataset.hoverBorderColor = mainColor; }); chartInstance.update('none'); } catch(e) {} } }); }
        function clearCharts() { [historyChartInstance, exercisePerfChartInstance].forEach(chart => chart?.destroy()); historyChartInstance = null; exercisePerfChartInstance = null; setChartPlaceholder('history-chart-canvas', ''); setChartPlaceholder('exercise-progress-chart', ''); }
        function setChartPlaceholder(canvasId, message, show = true) { const placeholderId = canvasId.replace('-canvas', '-placeholder'); const placeholder = document.getElementById(placeholderId); const canvasEl = document.getElementById(canvasId); if (placeholder && canvasEl) { placeholder.textContent = message; placeholder.style.display = show ? 'block' : 'none'; canvasEl.style.opacity = show ? '0.3' : '1'; canvasEl.style.display = show ? 'none' : 'block'; } }
        function populateExerciseSelect() { if (!exerciseSelect || !workoutHistory) return; const uniqueExercises = new Set(); workoutHistory.forEach(entry => { entry.exercises?.forEach(ex => uniqueExercises.add(ex.name)); }); const sortedExercises = Array.from(uniqueExercises).sort(); exerciseSelect.innerHTML = '<option value="all">Tous (Total Reps)</option>'; sortedExercises.forEach(exName => { const option = document.createElement('option'); option.value = exName; option.textContent = exName; exerciseSelect.appendChild(option); }); displayExerciseProgress(); }
        function displayExerciseProgress() { if (!exerciseProgressChartCanvasEl) return; const ctx = exerciseProgressChartCanvasEl.getContext('2d'); if (!ctx) return; if (!googleAccessToken) { setChartPlaceholder('exercise-progress-chart', "Connectez-vous."); if (exercisePerfChartInstance) { exercisePerfChartInstance.destroy(); exercisePerfChartInstance = null; } return; } const selectedExercise = exerciseSelect.value; const selectedPeriod = periodSelect.value; const filteredHistory = filterHistoryByPeriod(workoutHistory, selectedPeriod); let chartData; let chartOptions; let chartType = 'line'; if (selectedExercise === 'all') { const { labels, data } = aggregateChartData(filteredHistory, selectedPeriod, 'totalReps'); if (labels.length === 0 || data.every(d => d === 0)) { setChartPlaceholder('exercise-progress-chart', "Aucune donnée."); if (exercisePerfChartInstance) { exercisePerfChartInstance.destroy(); exercisePerfChartInstance = null; } return; } else { setChartPlaceholder('exercise-progress-chart', "", false); } const styles = getComputedStyle(document.documentElement); const primColor = styles.getPropertyValue('--action-color').trim(); const primColorRgb = styles.getPropertyValue('--paused-color-rgb'); const gridColor = styles.getPropertyValue('--border-color').trim(); const textColor = styles.getPropertyValue('--secondary-text').trim(); const tooltipBg = `rgba(17, 24, 39, 0.8)`; const tooltipText = styles.getPropertyValue('--primary-text').trim(); chartData = { labels, datasets: [{ label: 'Total Répétitions par Séance', data: data, borderColor: primColor, backgroundColor: `rgba(${primColorRgb}, 0.5)`, tension: 0.1, fill: true, pointRadius: 2, pointBackgroundColor: primColor }] }; chartOptions = { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { color: textColor }, grid: { display: false }, title: {display: true, text: getChartXAxisTitle(selectedPeriod), color: textColor} }, y: { beginAtZero: true, title: { display: true, text: 'Total Répétitions', color: textColor }, ticks: { color: textColor }, grid: { color: gridColor } } }, plugins: { legend: { display: false }, tooltip: { backgroundColor: tooltipBg, titleColor: tooltipText, bodyColor: tooltipText, padding: 10, cornerRadius: 4, displayColors: false, callbacks: { title: (tooltipItems) => tooltipItems[0]?.label || '', label: (context) => `Total Reps: ${context.parsed.y}` } } } }; chartType = 'line'; } else { const exerciseData = []; filteredHistory.forEach(entry => { entry.exercises?.forEach(ex => { if (ex.name === selectedExercise) { exerciseData.push({ date: new Date(entry.date), reps: ex.actualReps ?? ex.reps ?? 0 }); } }); }); exerciseData.sort((a, b) => a.date - b.date); if (exerciseData.length === 0) { setChartPlaceholder('exercise-progress-chart', "Aucune donnée."); if (exercisePerfChartInstance) { exercisePerfChartInstance.destroy(); exercisePerfChartInstance = null; } return; } else { setChartPlaceholder('exercise-progress-chart', "", false); } const labels = exerciseData.map(d => d.date.toLocaleDateString('fr-CA')); const styles = getComputedStyle(document.documentElement); const primColor = styles.getPropertyValue('--info-color').trim(); const primColorRgb = '96, 165, 250'; const gridColor = styles.getPropertyValue('--border-color').trim(); const textColor = styles.getPropertyValue('--secondary-text').trim(); const tooltipBg = `rgba(17, 24, 39, 0.8)`; const tooltipText = styles.getPropertyValue('--primary-text').trim(); chartData = { labels, datasets: [{ label: 'Répétitions', data: exerciseData.map(d => d.reps), borderColor: primColor, backgroundColor: `rgba(${primColorRgb}, 0.2)`, tension: 0.3, fill: false, pointRadius: 3, pointBackgroundColor: primColor, pointBorderColor: primColor, pointHoverRadius: 5, yAxisID: 'yMetric' }] }; chartOptions = { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, scales: { x: { ticks: { color: textColor }, grid: { display: false }, title: {display: true, text: 'Date', color: textColor} }, yMetric: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Répétitions', color: textColor }, ticks: { color: textColor }, grid: { color: gridColor } } }, plugins: { legend: { display: false }, tooltip: { backgroundColor: tooltipBg, titleColor: tooltipText, bodyColor: tooltipText, padding: 10, cornerRadius: 4, displayColors: false, callbacks: { title: (tooltipItems) => tooltipItems[0] ? new Date(tooltipItems[0].label).toLocaleDateString('fr-FR') : '', label: (context) => `${context.dataset.label}: ${context.parsed.y}` } } } }; chartType = 'line'; } if (exercisePerfChartInstance) { if (exercisePerfChartInstance.config.type !== chartType) { exercisePerfChartInstance.destroy(); exercisePerfChartInstance = new Chart(ctx, { type: chartType, data: chartData, options: chartOptions }); } else { exercisePerfChartInstance.data = chartData; exercisePerfChartInstance.options = chartOptions; exercisePerfChartInstance.update(); } } else { exercisePerfChartInstance = new Chart(ctx, { type: chartType, data: chartData, options: chartOptions }); } }
        function populateAndShowSummary() { if (!postWorkoutSummary || !summaryItemsList || !finishSummaryBtn) return; const planToSummarize = originalCompletedWorkoutPlan; if(summaryTitle) summaryTitle.textContent = `Résumé & Objectifs (${currentWorkoutType || '?'})`; if(summaryItemsList) { summaryItemsList.innerHTML = ''; planToSummarize.forEach((item, index) => { if (item.type === 'exercise') { const li = document.createElement('li'); li.classList.add('summary-item'); li.dataset.originalIndex = index; const performedReps = item.actualReps ?? item.reps ?? 0; const nextTargetReps = item.reps ?? 0; let contentHtml = `<div class="exercise-name"><i class="fas ${getIconForType(item.type)}" style="color:var(--color-exercise)"></i> ${item.name || 'Exercice'} <small>(${performedReps} fait)</small></div><div class="input-container"><label for="next-reps-${index}">Obj:</label><input type="number" id="next-reps-${index}" value="${nextTargetReps}" min="0" step="1" placeholder="Reps"></div>`; li.innerHTML = contentHtml; summaryItemsList.appendChild(li); } }); } if(finishSummaryBtn) finishSummaryBtn.disabled = false; if(postWorkoutSummary) postWorkoutSummary.classList.add('visible'); }
        async function finishSummary() { if (!googleAccessToken || !currentWorkoutType || !programFileIds[currentWorkoutType]) { showMessage("Erreur sauvegarde.", 4000, true); resetCurrentWorkout(); return; } if (isSavingDriveData) { showMessage("Sauvegarde en cours...", 2000); return; } let changesMade = false; const programToUpdate = loadedWorkouts[currentWorkoutType]; summaryItemsList.querySelectorAll('.summary-item[data-original-index]').forEach(li => { const index = parseInt(li.dataset.originalIndex, 10); const input = li.querySelector(`#next-reps-${index}`); if (input && programToUpdate[index] && programToUpdate[index].type === 'exercise') { const nextRepsRaw = input.value.trim(); const nextReps = nextRepsRaw === '' ? null : parseInt(nextRepsRaw, 10); if (nextReps !== null && (!isNaN(nextReps) && nextReps >= 0)) { if (programToUpdate[index].reps !== nextReps) { programToUpdate[index].reps = nextReps; changesMade = true; } } } }); if (changesMade) { if(finishSummaryBtn) { finishSummaryBtn.disabled = true; finishSummaryBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ...`; } const success = await updateFileContent(programFileIds[currentWorkoutType], programToUpdate); if (success) showMessage(`Objectifs "${currentWorkoutType}" màj !`, 2500); else showMessage(`Échec sauvegarde objectifs.`, 5000, true); if(finishSummaryBtn) { finishSummaryBtn.disabled = false; finishSummaryBtn.innerHTML = `<i class="fas fa-check"></i> Fin`; } } resetCurrentWorkout(); }
        function closeSummary(updateUI = true) { if(postWorkoutSummary) postWorkoutSummary.classList.remove('visible'); if (updateUI) setState(currentState); }
        async function saveHistoryToDrive() { if (!googleAccessToken || isSavingDriveData) return; if (!historyFileId) historyFileId = await findOrCreateFile(HISTORY_FILENAME, JSON.stringify([])); if (historyFileId) await updateFileContent(historyFileId, workoutHistory); }
        async function loadHistoryFromDrive() { if (!googleAccessToken) return; historyFileId = await findOrCreateFile(HISTORY_FILENAME, JSON.stringify([])); if (historyFileId) { const content = await readFileContent(historyFileId); if (content !== null) { try { workoutHistory = JSON.parse(content || "[]"); } catch (e) { workoutHistory = []; } } else workoutHistory = []; } else workoutHistory = []; displayHistory(currentHistoryPeriod); }
        async function saveProgramsToDrive() { if (!googleAccessToken || isSavingDriveData) return; let allSaved = true; for (const type of PROGRAM_TYPES) { if (!programFileIds[type]) { const defaultProgContent = defaultWorkouts[type] ? JSON.stringify(defaultWorkouts[type], null, 2) : '[]'; programFileIds[type] = await findOrCreateFile(PROGRAM_FILENAMES[type], defaultProgContent); } if (programFileIds[type]) { const success = await updateFileContent(programFileIds[type], loadedWorkouts[type] || []); if (!success) allSaved = false; } else { allSaved = false; } } }
        async function loadProgramsFromDrive() { if (!googleAccessToken) return false; let allLoadedSuccessfully = true; loadedWorkouts = {}; for (const type of PROGRAM_TYPES) { programFileIds[type] = await findOrCreateFile(PROGRAM_FILENAMES[type], JSON.stringify(defaultWorkouts[type] || [], null, 2)); if (programFileIds[type]) { const content = await readFileContent(programFileIds[type]); if (content !== null) { try { loadedWorkouts[type] = JSON.parse(content || '[]'); } catch (e) { loadedWorkouts[type] = JSON.parse(JSON.stringify(defaultWorkouts[type] || [])); allLoadedSuccessfully = false; } } else { loadedWorkouts[type] = JSON.parse(JSON.stringify(defaultWorkouts[type] || [])); allLoadedSuccessfully = false; } } else { loadedWorkouts[type] = JSON.parse(JSON.stringify(defaultWorkouts[type] || [])); allLoadedSuccessfully = false; } } return allLoadedSuccessfully; }
        function saveInProgressState() { if (!isWorkoutActive || currentState === 'preparing' || typeof localStorage === 'undefined') return; const stateToSave = { currentWorkoutType, currentItemIndex, timeLeft: currentState === 'break' || currentState === 'paused' ? timeLeft : 0, currentState, workoutStartTime, currentWorkoutPlan, totalWorkoutEstimatedSeconds, elapsedWorkoutEstimatedSeconds, timestamp: Date.now() }; try { localStorage.setItem(IN_PROGRESS_KEY, JSON.stringify(stateToSave)); } catch (e) {} }
        function loadInProgressState() { if (typeof localStorage === 'undefined' || !googleAccessToken) return; try { const savedStateJSON = localStorage.getItem(IN_PROGRESS_KEY); if (!savedStateJSON) return; const savedState = JSON.parse(savedStateJSON); const maxAge = 24 * 60 * 60 * 1000; if (Date.now() - savedState.timestamp > maxAge) { clearInProgressState(); return; } if (confirm(`Reprendre "${savedState.currentWorkoutType}" ?`)) { currentWorkoutType = savedState.currentWorkoutType; currentItemIndex = savedState.currentItemIndex; currentState = savedState.currentState; workoutStartTime = savedState.workoutStartTime; currentWorkoutPlan = savedState.currentWorkoutPlan; totalWorkoutEstimatedSeconds = savedState.totalWorkoutEstimatedSeconds; elapsedWorkoutEstimatedSeconds = savedState.elapsedWorkoutEstimatedSeconds; if (currentState === 'break' || (currentState === 'paused' && currentWorkoutPlan[currentItemIndex]?.type === 'break')) { totalTime = currentWorkoutPlan[currentItemIndex]?.duration || 0; timeLeft = Math.max(0, Math.min(savedState.timeLeft, totalTime)); } else { timeLeft = 0; totalTime = 0; } setActiveWorkoutNav(currentWorkoutType); showSection('workout-section'); setState(currentState); showMessage(`"${currentWorkoutType}" repris.`, 3000); } else { clearInProgressState(); } } catch (e) { clearInProgressState(); } }
        function clearInProgressState() { if (typeof localStorage === 'undefined') return; try { localStorage.removeItem(IN_PROGRESS_KEY); } catch (e) {} }
        function saveWorkoutToHistory() { if (!googleAccessToken || !originalCompletedWorkoutPlan || originalCompletedWorkoutPlan.length === 0) return; const endTime = Date.now(); const durationSeconds = workoutStartTime ? (endTime - workoutStartTime) / 1000 : 0; let totalReps = 0; originalCompletedWorkoutPlan.forEach(item => { if (item.type === 'exercise') totalReps += item.actualReps ?? item.reps ?? 0; }); const historyEntry = { date: new Date(workoutStartTime || endTime).toISOString(), type: currentWorkoutType || 'Inconnu', durationSeconds: Math.round(durationSeconds), totalReps: totalReps, exercises: originalCompletedWorkoutPlan.map(item => ({ ...item })) }; workoutHistory.unshift(historyEntry); saveHistoryToDrive(); displayHistory(currentHistoryPeriod); populateExerciseSelect(); displayExerciseProgress(); }
        function exportHistory() { if (!googleAccessToken) { showMessage("Connectez-vous.", 3000, true); return; } if (workoutHistory.length === 0) { showMessage("Historique vide.", 3000); return; } try { const jsonData = JSON.stringify(workoutHistory, null, 2); const blob = new Blob([jsonData], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; const dateStr = new Date().toISOString().split('T')[0]; a.download = `armorworkout_history_${dateStr}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); showMessage("Historique exporté.", 2500); } catch (e) { showMessage("Erreur export.", 4000, true); } }
        function showRepAdjustmentOverlay() { if (!isWorkoutActive || currentState === 'finished' || currentState === 'preparing' || currentState === 'paused') return; const itemForAdjustment = currentWorkoutPlan[nextExerciseIndexForAdjustment]; if (!itemForAdjustment || itemForAdjustment.type !== 'exercise') { hideRepAdjustmentOverlay(); return; } if(repAdjustmentExerciseName) repAdjustmentExerciseName.textContent = itemForAdjustment.name; const baseReps = itemForAdjustment.reps || 0; if(currentRepsDisplay) currentRepsDisplay.textContent = Math.max(0, baseReps + currentRepAdjustment); if (!isRepAdjustmentVisible && repAdjustmentOverlay) { repAdjustmentOverlay.classList.add('visible'); isRepAdjustmentVisible = true; } }
        function hideRepAdjustmentOverlay() { if (isRepAdjustmentVisible && repAdjustmentOverlay) { repAdjustmentOverlay.classList.remove('visible'); isRepAdjustmentVisible = false; } }
        function handleRepAdjustClick(event) { const adjustment = event.target.id === 'rep-adjust-plus' ? 1 : -1; currentRepAdjustment += adjustment; const itemForAdjustment = currentWorkoutPlan[nextExerciseIndexForAdjustment]; if (itemForAdjustment && currentRepsDisplay) { const baseReps = itemForAdjustment.reps || 0; currentRepsDisplay.textContent = Math.max(0, baseReps + currentRepAdjustment); } }
        function findNextExerciseForAdjustment() { nextExerciseIndexForAdjustment = -1; if (!currentWorkoutPlan) return; for (let i = currentItemIndex + 1; i < currentWorkoutPlan.length; i++) { if (currentWorkoutPlan[i].type === 'exercise') { nextExerciseIndexForAdjustment = i; return; } } }
        // --- Fonction Segments Réacteur V1 ---
        function createArcSegments() { /* Adapte pour les conteneurs outer/inner */
             const createSegmentsInContainer = (container, count, radius, baseHeight, heightVariation, opacityBase, opacityVariation) => {
                 if (!container) return;
                 container.innerHTML = '';
                 for (let i = 0; i < count; i++) {
                     const segment = document.createElement('div');
                     segment.className = 'segment'; // Utilise la classe CSS de base
                     const angle = (i * 360 / count);
                     // Ajuste la translation basée sur le rayon fourni
                     segment.style.transform = `rotate(${angle}deg) translateY(-${radius}px) rotate(-${angle}deg)`; // Rotation inverse
                     // Variation hauteur/opacité (exemple simple)
                     if (i % 4 === 0) {
                         segment.style.height = `${baseHeight + heightVariation}px`;
                         segment.style.opacity = opacityBase + opacityVariation;
                     } else {
                         segment.style.height = `${baseHeight}px`;
                         segment.style.opacity = opacityBase;
                     }
                     container.appendChild(segment);
                 }
             };
            // Créer segments pour les deux conteneurs
             createSegmentsInContainer(outerSegmentsContainer, 24, 125, 12, 6, 0.4, 0.3); // Ex: Rayon 125px pour outer
             createSegmentsInContainer(innerSegmentsContainer, 18, 95, 10, 5, 0.5, 0.3);  // Ex: Rayon 95px pour inner
        }
        // --- Initialisation Générale ---
        function initializeDOMReferences() { try {
            timeDisplayDiv = document.getElementById('time-left'); timerCircle = document.querySelector('.timer-circle'); /* Utilise la classe V1 */ timerStateDisplay = document.getElementById('timer-state'); currentExerciseContainer = document.getElementById('current-exercise-container'); progressTracker = document.getElementById('progress-tracker'); startPauseBtn = document.getElementById('start-pause-btn'); skipBtn = document.getElementById('skip-btn'); finishBtn = document.getElementById('finish-btn'); resetBtn = document.getElementById('reset-btn'); prevBtn = document.getElementById('prev-btn'); messageArea = document.getElementById('message-area'); workoutSection = document.getElementById('workout-section'); historySection = document.getElementById('history-section'); progressSection = document.getElementById('progress-section'); historyList = document.getElementById('history-list'); statsDisplay = document.getElementById('stats-display'); statsContentWrapper = statsDisplay?.querySelector('.content-wrapper'); historyFilterBtns = Array.from(document.querySelectorAll('.history-filters button')); historyChartCanvasEl = document.getElementById('history-chart-canvas'); exerciseProgressChartCanvasEl = document.getElementById('exercise-progress-chart'); signInButton = document.getElementById('signin-button'); signOutButton = document.getElementById('signout-button'); exportButton = document.getElementById('export-button'); driveStatusElement = document.getElementById('drive-status'); driveStatusTextElement = document.getElementById('drive-status-text'); settingsIcon = document.getElementById('settings-icon'); postWorkoutSummary = document.getElementById('post-workout-summary'); summaryTitle = document.getElementById('summary-title'); summaryItemsList = document.getElementById('summary-items-list'); finishSummaryBtn = document.getElementById('finish-summary-btn'); historyDriveStatus = document.getElementById('history-drive-status'); totalProgressCircle = document.getElementById('total-progress-circle'); currentExerciseNameDisplay = document.getElementById('current-exercise-name-display'); driveConnectionStatusMain = document.getElementById('drive-connection-status-main'); driveConnectionText = document.getElementById('drive-connection-text'); timerDisplayElement = document.querySelector('.timer-display'); /* Le conteneur global */ progressTextArea = document.getElementById('progress-text-area'); historyActionsContainer = document.querySelector('.history-actions'); exerciseSelect = document.getElementById('exercise-select'); metricSelect = document.getElementById('metric-select'); periodSelect = document.getElementById('period-select'); exerciseChartPlaceholder = document.getElementById('exercise-progress-placeholder'); repAdjustmentOverlay = document.getElementById('rep-adjustment-overlay'); repAdjustMinusBtn = document.getElementById('rep-adjust-minus'); repAdjustPlusBtn = document.getElementById('rep-adjust-plus'); currentRepsDisplay = document.getElementById('current-reps-display'); repAdjustmentExerciseName = document.getElementById('rep-adjustment-exercise-name'); navHistoryBtn = document.getElementById('nav-history'); navProgressBtn = document.getElementById('nav-progress'); navButtons = [ document.getElementById('nav-push'), document.getElementById('nav-pull'), document.getElementById('nav-legs') ]; outerSegmentsContainer = document.getElementById('outerSegments'); innerSegmentsContainer = document.getElementById('innerSegments'); // Références pour les segments
        } catch (e) { console.error("Erreur init DOM:", e); } }
        // --- Fonction updateTimerAppearance (V1 - Cahier des Charges) ---
        function updateTimerAppearance(state) {
          if (!timerCircle || !timeDisplayDiv) return; // timerStateDisplay MAJ séparément si besoin
          let stateColor = 'var(--idle-color)'; let glowValue = `0 0 60px rgba(var(--idle-color-rgb), 0.6)`;
          switch(state) {
            case 'exercise': stateColor = 'var(--exercise-color)'; glowValue = `0 0 60px rgba(${getComputedStyle(document.documentElement).getPropertyValue('--exercise-color-rgb')}, 0.8)`; break;
            case 'break': stateColor = 'var(--break-color)'; glowValue = `0 0 60px rgba(${getComputedStyle(document.documentElement).getPropertyValue('--break-color-rgb')}, 0.8)`; break;
            case 'paused': stateColor = 'var(--paused-color)'; glowValue = `0 0 60px rgba(${getComputedStyle(document.documentElement).getPropertyValue('--paused-color-rgb')}, 0.8)`; break;
            case 'preparing': stateColor = 'var(--preparing-color)'; glowValue = `0 0 60px rgba(${getComputedStyle(document.documentElement).getPropertyValue('--preparing-color-rgb')}, 0.8)`; break;
            case 'finished': stateColor = 'var(--finished-color)'; glowValue = `0 0 60px rgba(${getComputedStyle(document.documentElement).getPropertyValue('--finished-color-rgb')}, 0.8)`; break;
          }
          timerCircle.style.boxShadow = glowValue;
          timeDisplayDiv.style.color = `var(${stateColor})`;
          timeDisplayDiv.style.textShadow = glowValue.replace('60px','10px').replace('0.8','0.7');
          // Mettre à jour aussi le texte d'état si l'élément existe
          if(timerStateDisplay) {
              timerStateDisplay.style.color = `var(${stateColor})`;
              timerStateDisplay.style.textShadow = glowValue.replace('60px','8px').replace('0.8','0.6');
          }
        }
        function addEventListeners() { /* (Adapté: gestion pause/reprise + sons) */
            if (startPauseBtn) startPauseBtn.addEventListener('click', () => { initAudioContext(); playSound(soundLaser); if (currentState === 'idle') { setState('preparing'); } else if (currentState === 'exercise') { handleItemCompletion(false); } else if (currentState === 'break') { setState('paused'); } else if (currentState === 'paused') { const item = currentWorkoutPlan[currentItemIndex]; setState(item?.type === 'exercise' ? 'exercise' : 'break'); } });
            if (timerDisplayElement) timerDisplayElement.addEventListener('click', () => { initAudioContext(); playSound(soundLaser); if (isWorkoutActive && currentState !== 'preparing' && currentState !== 'finished') { handleItemCompletion(false); } else if (currentState === 'idle' && startPauseBtn && !startPauseBtn.disabled) { setState('preparing'); } });
            if (skipBtn) skipBtn.addEventListener('click', () => { initAudioContext(); playSound(soundLaser); if (isWorkoutActive) handleItemCompletion(false); });
            if (prevBtn) prevBtn.addEventListener('click', () => { initAudioContext(); playSound(soundLaser); handlePreviousClick(); });
            if (finishBtn) finishBtn.addEventListener('click', () => { initAudioContext(); playSound(soundLaser); forceFinishWorkout(); });
            if (resetBtn) resetBtn.addEventListener('click', () => { initAudioContext(); playSound(soundLaser); resetCurrentWorkout(); });
            navButtons.forEach(btn => { if (btn) btn.addEventListener('click', () => { initAudioContext(); playSound(soundLaser); loadWorkout(btn.dataset.workout); }); });
            if(navHistoryBtn) navHistoryBtn.addEventListener('click', () => { initAudioContext(); playSound(soundLaser); showSection('history-section'); });
            if(navProgressBtn) navProgressBtn.addEventListener('click', () => { initAudioContext(); playSound(soundLaser); showSection('progress-section'); });
            historyFilterBtns.forEach(btn => { if(btn) btn.addEventListener('click', () => { initAudioContext(); playSound(soundLaser); displayHistory(btn.dataset.period); }); });
            if(exerciseSelect) exerciseSelect.addEventListener('change', displayExerciseProgress);
            if(periodSelect) periodSelect.addEventListener('change', displayExerciseProgress);
            if(settingsIcon) settingsIcon.addEventListener('click', () => { playSound(soundLaser); console.log("Settings!"); /* TODO */ });
            if(signInButton) signInButton.addEventListener('click', () => { playSound(soundLaser); handleAuthClick(); });
            if(signOutButton) signOutButton.addEventListener('click', () => { playSound(soundLaser); handleSignoutClick(); });
            if(exportButton) exportButton.addEventListener('click', () => { playSound(soundLaser); exportHistory(); });
            if(finishSummaryBtn) finishSummaryBtn.addEventListener('click', () => { playSound(soundLaser); finishSummary(); });
            if(postWorkoutSummary) postWorkoutSummary.addEventListener('click', (e) => { if (e.target === postWorkoutSummary) { playSound(soundLaser); finishSummary(); } });
            if(repAdjustMinusBtn) repAdjustMinusBtn.addEventListener('click', handleRepAdjustClick);
            if(repAdjustPlusBtn) repAdjustPlusBtn.addEventListener('click', handleRepAdjustClick);
            if(repAdjustmentOverlay) repAdjustmentOverlay.addEventListener('click', (e) => { if (e.target === repAdjustmentOverlay) hideRepAdjustmentOverlay(); });
            document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'hidden' && isWorkoutActive) saveInProgressState(); });
            window.addEventListener('beforeunload', () => { if (isWorkoutActive) saveInProgressState(); });
        }
        // --- Point d'entrée ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeDOMReferences(); initSounds(); addEventListeners(); loadSavedTheme(); setState('idle'); updateAuthUI(!!googleAccessToken); checkAndInitGis();
            setChartPlaceholder('history-chart-canvas', "Connectez-vous."); setChartPlaceholder('exercise-progress-chart', "Connectez-vous.");
            // createArcSegments(); // Appel fonction segments V1
            console.log("ArmorWorkout Initialisé.");
        });
    </script>

</body>
</html>
