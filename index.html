
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArmorWorkout - Vibranium Edition</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚡</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.0.1/chartjs-plugin-annotation.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color-dark: #030712; 
            --secondary-bg-color-dark: #0B132B; 
            --primary-text-color-dark: #F0F4F8; 
            --secondary-text-color-dark: #A0AEC0; 
            --border-color-dark: #1E293B; 
            --electric-blue: #00BFFF; 
            --electric-cyan: #22D3EE; 
            --electric-blue-light: #4D94FF; 
            --vibranium-purple: #8A2BE2;
            --vibranium-glow: #B026FF;
            --vibranium-bg: linear-gradient(135deg, rgba(20,0,30,0.95), rgba(5,5,10,0.95));
            --neon-green: #39FF14; 
            --neon-red: #FF3131; 
            --theme-color: var(--electric-cyan);
            --reactor-speed: 12s;
            --font-main: 'Inter', sans-serif;
            --font-titles: 'Orbitron', sans-serif;
        }

        @keyframes vibraniumPulse {
            0% { box-shadow: 0 0 5px var(--vibranium-purple); border-color: var(--vibranium-glow); }
            50% { box-shadow: 0 0 20px var(--vibranium-purple); border-color: #fff; transform: scale(1.01); }
            100% { box-shadow: 0 0 5px var(--vibranium-purple); border-color: var(--vibranium-glow); }
        }
        @keyframes rotateReactor { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes subtlePulse { 0%, 100% { opacity: 0.7; transform: scale(1); } 50% { opacity: 1; transform: scale(1.015); } }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--font-main); background-color: var(--bg-color-dark); color: var(--primary-text-color-dark);
            min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden;
            background-image: radial-gradient(ellipse at center, rgba(0, 191, 255, 0.08) 0%, transparent 60%);
        }

        header {
            padding: 15px 0; background-color: rgba(11, 19, 43, 0.8); backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(34, 211, 238, 0.3); position: sticky; top: 0; z-index: 1000;
        }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        h1 { font-family: var(--font-titles); color: #fff; font-size: 1.5rem; text-shadow: 0 0 10px var(--electric-cyan); display: flex; align-items: center; gap: 10px; margin: 0; }
        h1 i { color: var(--electric-cyan); animation: subtlePulse 3s infinite; }
        
        .header-actions button {
            background: transparent; border: 1px solid var(--border-color-dark); color: var(--secondary-text-color-dark);
            padding: 6px 12px; border-radius: 6px; cursor: pointer; transition: all 0.3s; font-size: 0.9rem;
            display: inline-flex; align-items: center; gap: 6px;
        }
        .header-actions button:hover:not(:disabled) { border-color: var(--electric-cyan); color: var(--electric-cyan); background: rgba(34, 211, 238, 0.1); }
        .header-actions button:disabled { opacity: 0.5; cursor: not-allowed; }
        #drive-status { font-size: 0.9rem; margin-right: 10px; display: none; align-items: center; gap: 5px; }
        #drive-status.connected { color: var(--neon-green); }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; flex-grow: 1; width: 100%; display: flex; flex-direction: column; }
        .app-section { display: none; opacity: 0; transition: opacity 0.4s ease-in-out; width: 100%; }
        .app-section.active { display: block; opacity: 1; }

        .home-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 25px; margin-top: 20px; }
        
        .session-card-large {
            background: rgba(11, 19, 43, 0.6); border: 1px solid var(--border-color-dark); border-radius: var(--border-radius-lg);
            padding: 20px; position: relative; overflow: hidden; transition: all 0.3s; cursor: pointer;
        }
        .session-card-large:hover { transform: translateY(-5px); border-color: var(--electric-cyan); box-shadow: 0 10px 20px rgba(0,255,255,0.1); }
        .session-card-large.vibranium-mode {
            background: var(--vibranium-bg); border: 1px solid var(--vibranium-purple);
            animation: vibraniumPulse 4s infinite ease-in-out;
        }
        .session-card-large.vibranium-mode h3 { color: #fff !important; text-shadow: 0 0 10px var(--vibranium-glow); }
        .vibranium-badge {
            position: absolute; top: 10px; right: 10px; background: var(--vibranium-purple); color: #fff;
            font-family: var(--font-titles); font-size: 0.7rem; padding: 4px 8px; border-radius: 4px;
            box-shadow: 0 0 10px var(--vibranium-purple); letter-spacing: 1px; z-index: 2; font-weight: bold;
        }
        .session-card-header h3 { font-family: var(--font-titles); color: var(--electric-cyan); margin: 0 0 10px 0; font-size: 1.3rem; }
        .session-card-large p { color: var(--secondary-text-color-dark); font-size: 0.9rem; margin-bottom: 20px; line-height: 1.5; }
        
        #workout-section { text-align: center; max-width: 800px; margin: 0 auto; padding-top: 20px; }
        .reactor-container {
            width: 280px; height: 280px; margin: 30px auto; position: relative;
            display: flex; justify-content: center; align-items: center;
        }
        .reactor-ring {
            position: absolute; inset: 0; border-radius: 50%;
            border: 6px solid rgba(255,255,255,0.05);
            border-top-color: var(--theme-color); border-bottom-color: var(--theme-color);
            animation: rotateReactor var(--reactor-speed) linear infinite;
            box-shadow: 0 0 20px rgba(0,0,0,0.5), inset 0 0 20px rgba(0,0,0,0.5);
        }
        .reactor-core {
            position: absolute; width: 240px; height: 240px; border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
        }
        #time-left {
            font-family: var(--font-titles); font-size: 4rem; color: #fff; z-index: 10; position: relative;
            text-shadow: 0 0 20px var(--theme-color);
        }
        
        .workout-info { margin-bottom: 30px; }
        #current-exercise-name-display { font-family: var(--font-titles); font-size: 1.6rem; color: #fff; margin-bottom: 10px; animation: subtlePulse 3s infinite; }
        .exercise-details { 
            display: inline-flex; gap: 15px; background: rgba(255,255,255,0.05); padding: 10px 20px; border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1); font-family: var(--font-titles); color: var(--theme-color);
            align-items: center; justify-content: center;
        }
        
        .controls { display: flex; justify-content: center; gap: 15px; margin-top: 20px; flex-wrap: wrap;}
        .controls button {
            width: 60px; height: 60px; border-radius: 50%; border: none; background: rgba(255,255,255,0.1);
            color: #fff; font-size: 1.2rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .controls button:hover:not(:disabled) { transform: scale(1.1); background: rgba(255,255,255,0.2); }
        .controls button:disabled { opacity: 0.3; cursor: not-allowed; }
        #start-pause-btn { background: var(--theme-color); color: #000; box-shadow: 0 0 15px var(--theme-color); width: 70px; height: 70px; font-size: 1.5rem; }

        .post-workout-summary {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); backdrop-filter: blur(5px);
            z-index: 2000; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.3s;
        }
        .post-workout-summary.visible { display: flex; opacity: 1; }
        .post-workout-summary-content {
            background: #0B132B; border: 1px solid var(--border-color-dark); width: 95%; max-width: 850px;
            max-height: 90vh; overflow-y: auto; border-radius: 12px; display: flex; flex-direction: column;
        }
        .post-workout-summary h2 { 
            padding: 20px; border-bottom: 1px solid var(--border-color-dark); text-align: center; margin: 0;
            font-family: var(--font-titles); color: var(--electric-cyan); 
        }
        
        .analysis-container { padding: 20px; border-bottom: 1px solid var(--border-color-dark); }
        .chart-wrapper { position: relative; height: 350px; width: 100%; background: rgba(0,0,0,0.3); border-radius: 8px; border: 1px solid #333; }
        
        .delta-list { margin-top: 15px; display: grid; gap: 10px; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); }
        .delta-card {
            background: rgba(255,255,255,0.03); padding: 10px; border-radius: 6px; border-left: 3px solid #555;
            font-size: 0.85rem; color: #ccc;
        }
        .delta-card.mastered { border-left-color: var(--vibranium-glow); background: linear-gradient(90deg, rgba(138,43,226,0.1), transparent); }
        .delta-card strong { display: block; color: #fff; margin-bottom: 4px; }
        .delta-missing { color: var(--neon-red); }
        .delta-ok { color: var(--neon-green); font-weight: bold; text-shadow: 0 0 5px var(--neon-green); }

        .summary-items-list { list-style: none; padding: 20px; margin: 0; }
        .summary-item { 
            background: rgba(255,255,255,0.03); padding: 15px; margin-bottom: 10px; border-radius: 8px;
            display: grid; gap: 10px; border: 1px solid transparent; transition: all 0.3s;
        }
        .summary-item.vibranium-item { 
            border-color: var(--vibranium-glow); 
            box-shadow: inset 0 0 15px rgba(138,43,226,0.2), 0 0 10px rgba(138,43,226,0.1); 
        }
        .summary-item .exercise-name { font-weight: bold; color: #fff; font-size: 1.1rem; display: flex; justify-content: space-between; }
        
        .input-group { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 4px; }
        .stepper-control { display: flex; align-items: center; gap: 5px; }
        .stepper-btn { 
            width: 30px; height: 30px; background: #1A202C; border: 1px solid #333; color: var(--electric-cyan); 
            cursor: pointer; border-radius: 4px; display: flex; align-items: center; justify-content: center;
        }
        .stepper-value { width: 40px; text-align: center; color: #fff; font-weight: bold; }
        .weight-input { 
            background: #1A202C; border: 1px solid #333; color: #fff; padding: 5px; border-radius: 4px; 
            width: 120px; text-align: center; font-family: var(--font-main);
        }

        .summary-controls { padding: 20px; text-align: center; border-top: 1px solid var(--border-color-dark); }
        #finish-summary-btn {
            width: 100%; padding: 15px; background: var(--neon-green); color: #000; font-family: var(--font-titles);
            font-weight: 900; border: none; font-size: 1.1rem; cursor: pointer; text-transform: uppercase; border-radius: 8px;
            box-shadow: 0 0 15px rgba(57, 255, 20, 0.4); transition: all 0.3s;
        }
        #finish-summary-btn:hover { box-shadow: 0 0 25px rgba(57, 255, 20, 0.8); transform: translateY(-2px); }

        .message-area {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(20, 20, 20, 0.95); border: 1px solid var(--border-color-dark);
            padding: 12px 24px; border-radius: 50px; color: #fff; pointer-events: none;
            opacity: 0; transition: opacity 0.3s; z-index: 3000; font-weight: 500;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); backdrop-filter: blur(5px);
        }
        .message-area.visible { opacity: 1; }
        
        footer { text-align: center; padding: 20px; color: #666; font-size: 0.8rem; margin-top: auto; }
        
        @media (max-width: 768px) {
            .reactor-container { width: 220px; height: 220px; }
            #time-left { font-size: 3rem; }
            .chart-wrapper { height: 250px; }
        }
    </style>
</head>
<body class="logged-out dark-theme state-idle">

    <header>
        <div class="header-content">
            <h1><i class="fas fa-bolt"></i> ArmorWorkout</h1>
            <div class="header-actions">
                <span id="drive-status"><i class="fab fa-google-drive"></i> Connecté</span>
                <button id="signin-button"><i class="fab fa-google"></i> Connexion</button>
                <button id="edit-program-btn" disabled><i class="fas fa-edit"></i> Éditer</button>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="home-section" class="app-section active">
            <div class="home-grid" id="program-container"></div>
        </div>

        <div id="workout-section" class="app-section">
            <div class="reactor-container">
                <div class="reactor-ring"></div>
                <div class="reactor-core"></div>
                <div id="time-left">00:00</div>
            </div>

            <div class="workout-info">
                <div id="current-exercise-name-display">Exercice</div>
                <div id="current-exercise-container"></div>
            </div>

            <div class="controls">
                <button id="prev-btn"><i class="fas fa-backward"></i></button>
                <button id="start-pause-btn"><i class="fas fa-play"></i></button>
                <button id="skip-btn"><i class="fas fa-forward"></i></button>
                <button id="finish-btn" style="color: var(--neon-red);"><i class="fas fa-flag-checkered"></i></button>
            </div>
        </div>
    </div>

    <div id="post-workout-summary" class="post-workout-summary">
        <div class="post-workout-summary-content">
            <h2 id="summary-title">HUD BALISTIQUE & ANALYSE</h2>
            <div class="analysis-container">
                <div class="chart-wrapper">
                    <canvas id="scatter-chart"></canvas>
                </div>
                <div id="delta-container" class="delta-list"></div>
            </div>
            <ul id="summary-items-list" class="summary-items-list"></ul>
            <div class="summary-controls">
                <button id="finish-summary-btn">VALIDER & SAUVEGARDER</button>
            </div>
        </div>
    </div>

    <div id="message-area" class="message-area">Notification</div>
    
    <footer><p>© 2025 ArmorWorkout - Vibranium Edition</p></footer>

    <script async defer src="https://accounts.google.com/gsi/client"></script>
    <script>
        "use strict";

        // --- CONFIGURATION ---
        const GOOGLE_CLIENT_ID = "731283926358-viam3ulpgna14flfdeb9m92l8s620hoi.apps.googleusercontent.com";
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const FILES = { PROG: "programmeCompletHypertrophieElite_v1.json", HIST: "armorworkout_history.json" };
        const IN_PROGRESS_KEY = 'armorWorkoutStateInProgress';

        // --- SQUELETTE PAR DÉFAUT (SI FICHIER ABSENT) ---
        const DEFAULT_SKELETON = {
            "nom_programme": "Programme Initial",
            "sessions": []
        };

        // --- ETAT GLOBAL ---
        let tokenClient, accessToken = null;
        let programData = null, historyData = [];
        let fileIds = { prog: null, hist: null };
        let currentSession = null, sessionPlan = [], currentIndex = 0;
        let timer = null, timeLeft = 0, isPaused = false;
        let scatterChart = null;
        let audioCtx;
        let isEditMode = false;
        let currentSummaryContext = { mode: 'workout', sessionName: null };
        let gisCheckRetries = 0;

        // --- DOM REFERENCES ---
        const els = {
            home: document.getElementById('home-section'),
            workout: document.getElementById('workout-section'),
            progContainer: document.getElementById('program-container'),
            summaryModal: document.getElementById('post-workout-summary'),
            summaryList: document.getElementById('summary-items-list'),
            deltaList: document.getElementById('delta-container'),
            summaryTitle: document.getElementById('summary-title'),
            finishBtn: document.getElementById('finish-summary-btn'),
            timeLeft: document.getElementById('time-left'),
            exName: document.getElementById('current-exercise-name-display'),
            exContainer: document.getElementById('current-exercise-container'),
            msgArea: document.getElementById('message-area'),
            startPauseBtn: document.getElementById('start-pause-btn'),
            driveStatus: document.getElementById('drive-status'),
            signInBtn: document.getElementById('signin-button'),
            editModeBtn: document.getElementById('edit-program-btn')
        };

        // --- INIT ---
        window.onload = () => {
            checkAndInitGis();
            initAudio();
            // On n'appelle pas renderHome ici, on attend le Drive
        };

        // --- GOOGLE DRIVE ---
        function checkAndInitGis() {
            if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CLIENT_ID, scope: SCOPES,
                    callback: tokenCallback
                });
                els.signInBtn.disabled = false;
            } else if (gisCheckRetries < 50) {
                gisCheckRetries++;
                setTimeout(checkAndInitGis, 100);
            } else {
                showMsg("Erreur chargement Google API", true);
            }
        }

        async function tokenCallback(resp) {
            if (resp.error) { showMsg("Erreur Auth Google", true); return; }
            accessToken = resp.access_token;
            els.signInBtn.style.display = 'none';
            els.driveStatus.style.display = 'flex';
            els.driveStatus.classList.add('connected');
            els.editModeBtn.disabled = false;
            
            await syncDrive();
            loadInProgressState(); // La fonction est définie plus bas, donc pas d'erreur
        }

        els.signInBtn.onclick = () => tokenClient.requestAccessToken({prompt: ''});

        async function syncDrive() {
            showMsg("Synchro Drive...");
            // Recherche ou création avec squelette vide si absent
            fileIds.prog = await findOrCreate(FILES.PROG, JSON.stringify(DEFAULT_SKELETON));
            fileIds.hist = await findOrCreate(FILES.HIST, "[]");
            
            const pContent = await readFile(fileIds.prog);
            programData = pContent ? JSON.parse(pContent) : DEFAULT_SKELETON;
            
            const hContent = await readFile(fileIds.hist);
            historyData = hContent ? JSON.parse(hContent) : [];
            
            renderHome(programData);
            showMsg("Données synchronisées !");
        }

        async function findOrCreate(name, content) {
            // Utilisation de %20 pour l'espace pour éviter l'erreur 400
            const q = `name='${encodeURIComponent(name)}'%20and%20trashed=false`;
            const search = await fetch(`https://www.googleapis.com/drive/v3/files?q=${q}&fields=files(id)`, {
                headers: { Authorization: `Bearer ${accessToken}` }
            });
            const data = await search.json();
            if (data.files && data.files.length > 0) return data.files[0].id;
            
            const meta = { name: name, mimeType: 'application/json' };
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(meta)], {type: 'application/json'}));
            form.append('file', new Blob([content], {type: 'application/json'}));
            
            const create = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST', headers: { Authorization: `Bearer ${accessToken}` }, body: form
            });
            return (await create.json()).id;
        }

        async function readFile(id) {
            const res = await fetch(`https://www.googleapis.com/drive/v3/files/${id}?alt=media`, {
                headers: { Authorization: `Bearer ${accessToken}` }
            });
            return res.ok ? await res.text() : null;
        }

        async function saveFile(id, content) {
            await fetch(`https://www.googleapis.com/upload/drive/v3/files/${id}?uploadType=media`, {
                method: 'PATCH',
                headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(content)
            });
        }

        // --- STATE MANAGEMENT (Fix ReferenceError) ---
        function saveInProgressState() {
            if (els.workout.classList.contains('section-hidden')) {
                localStorage.removeItem(IN_PROGRESS_KEY);
                return;
            }
            const state = {
                sessionName: currentSession?.nom_session,
                plan: sessionPlan,
                idx: currentIndex,
                timeLeft: timeLeft
            };
            localStorage.setItem(IN_PROGRESS_KEY, JSON.stringify(state));
        }

        function loadInProgressState() {
            const stored = localStorage.getItem(IN_PROGRESS_KEY);
            if (stored && programData) {
                const state = JSON.parse(stored);
                const session = programData.sessions.find(s => s.nom_session === state.sessionName);
                if (session) {
                    currentSession = session;
                    sessionPlan = state.plan;
                    currentIndex = state.idx;
                    timeLeft = state.timeLeft;
                    
                    els.home.classList.remove('active');
                    els.workout.classList.remove('section-hidden'); // Fix class name usage
                    els.workout.style.display = 'block'; // Ensure visibility
                    els.home.style.display = 'none';
                    
                    loadStep(false); // false = don't reset timer
                    showMsg("Séance reprise");
                }
            }
        }

        // Sauvegarde auto
        window.addEventListener('beforeunload', saveInProgressState);
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') saveInProgressState();
        });

        // --- LOGIQUE MÉTIER ---
        function parseWeight(str) {
            if (!str) return 0;
            const nums = str.match(/(\d+(?:[.,]\d+)?)/g);
            if (!nums) return 0; 
            return nums.reduce((a, b) => a + parseFloat(b.replace(',', '.')), 0);
        }

        function calculateGap(current, target) {
            const cReps = parseInt(current.reps) || 0;
            const tReps = parseInt(target.final_target_reps) || 12;
            const pctReps = Math.min(100, (cReps / tReps) * 100);
            
            const cTxt = current.weight_text || "";
            const tTxt = target.final_target_poids || "";
            const cVal = parseWeight(cTxt);
            const tVal = parseWeight(tTxt);
            
            let pctWeight = 0;
            let missingTxt = "";

            if (tVal > 0) {
                if (cVal > 0) {
                    pctWeight = Math.min(100, (cVal / tVal) * 100);
                    const diff = tVal - cVal;
                    if (diff > 0) missingTxt = `+${diff}kg`;
                } else {
                    pctWeight = 0;
                    missingTxt = "Charge non définie";
                }
            } else {
                const normC = cTxt.toLowerCase().trim();
                const normT = tTxt.toLowerCase().trim();
                if (normC === normT) {
                    pctWeight = 100;
                } else {
                    pctWeight = 0;
                    missingTxt = `Cible: "${tTxt}"`; 
                }
            }

            const isVibranium = (pctReps >= 100 && pctWeight >= 100);
            return { pctReps, pctWeight, missingReps: Math.max(0, tReps - cReps), missingWeight: missingTxt, isVibranium };
        }

        function getFormattedWeight(item) {
            return item.weight_text || "PDC";
        }

        function getDynamicSetsInfo(idx, plan) {
            const item = plan[idx];
            if(!item.type.startsWith('exercise')) return '';
            const sameEx = plan.filter(e => e.name === item.name);
            const currentSet = plan.slice(0, idx + 1).filter(e => e.name === item.name).length;
            return `Série ${currentSet}/${sameEx.length}`;
        }

        function parseRepRange(item) {
            // Simple extraction
            return { min: 8, max: 12 }; // Valeur par défaut si pas de parsing complexe
        }

        // --- RENDER UI ---
        function renderHome(data) {
            els.progContainer.innerHTML = '';
            if(!data.sessions || data.sessions.length === 0) {
                els.progContainer.innerHTML = "<p style='text-align:center; color:#888;'>Aucun programme trouvé sur Drive.</p>";
                return;
            }

            data.sessions.forEach(sess => {
                let isMastered = false;
                const lastLog = historyData.slice().reverse().find(h => h.sessionName === sess.nom_session);
                
                if (lastLog) {
                    const exos = sess.exercices_et_pauses.filter(e => e.type === 'exercise');
                    let countOk = 0;
                    exos.forEach((exTemplate) => {
                        const exLog = lastLog.exercises.find(e => e.name === exTemplate.name);
                        if (exLog) {
                            const current = { reps: exLog.finalReps || exLog.reps, weight_text: exLog.finalWeightDescription || exLog.weight_text };
                            const gap = calculateGap(current, exTemplate);
                            if (gap.isVibranium) countOk++;
                        }
                    });
                    if (countOk === exos.length && exos.length > 0) isMastered = true;
                }

                const card = document.createElement('div');
                card.className = `session-card-large ${isMastered ? 'vibranium-mode' : ''}`;
                card.dataset.sessionName = sess.nom_session;
                card.innerHTML = `
                    ${isMastered ? '<div class="vibranium-badge">VIBRANIUM MASTERED</div>' : ''}
                    <div class="session-card-header">
                        <h3>${sess.nom_session}</h3>
                    </div>
                    <p>${sess.description_session || ''}</p>
                `;
                els.progContainer.appendChild(card);
            });
        }

        els.home.addEventListener('click', (e) => {
            const card = e.target.closest('.session-card-large');
            if(card) {
                if(isEditMode) {
                    populateAndShowSummary({mode: 'edit', sessionName: card.dataset.sessionName});
                } else {
                    loadSession(card.dataset.sessionName);
                }
            }
        });

        els.editModeBtn.addEventListener('click', () => {
            isEditMode = !isEditMode;
            els.editModeBtn.classList.toggle('active');
            showMsg(isEditMode ? "Mode Édition Activé" : "Mode Édition Désactivé");
        });

        // --- WORKOUT ---
        function loadSession(name) {
            currentSession = programData.sessions.find(s => s.nom_session === name);
            sessionPlan = JSON.parse(JSON.stringify(currentSession.exercices_et_pauses));
            currentIndex = 0;
            
            els.home.classList.remove('active');
            els.home.style.display = 'none';
            els.workout.classList.remove('section-hidden');
            els.workout.style.display = 'block';
            els.workout.classList.add('active');
            
            loadStep(true);
        }

        function loadStep(resetTimer = true) {
            const step = sessionPlan[currentIndex];
            if (!step) { finishWorkout(); return; }

            if(resetTimer) {
                clearInterval(timer);
                isPaused = false;
            }
            
            els.exName.innerText = step.name;
            
            let html = '';
            if (step.type === 'break') {
                document.documentElement.style.setProperty('--theme-color', 'var(--break-color-val)');
                els.startPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                if(resetTimer) startTimer(step.duration);
                html = `<div class="exercise-details"><i class="fas fa-coffee"></i> Repos</div>`;
            } else {
                document.documentElement.style.setProperty('--theme-color', 'var(--exercise-color-val)');
                els.startPauseBtn.innerHTML = '<i class="fas fa-check"></i>';
                els.timeLeft.innerText = "GO";
                html = `<div class="exercise-details">
                            <span><i class="fas fa-repeat"></i> ${step.reps}</span>
                            <span><i class="fas fa-weight-hanging"></i> ${step.weight_text}</span>
                        </div>`;
            }
            els.exContainer.innerHTML = html;
        }

        function startTimer(sec) {
            timeLeft = sec;
            updateDisplay();
            timer = setInterval(() => {
                if(!isPaused) {
                    timeLeft--;
                    updateDisplay();
                    if (timeLeft <= 0) { clearInterval(timer); playBeep(); nextStep(); }
                }
            }, 1000);
        }

        function updateDisplay() {
            const m = Math.floor(timeLeft / 60).toString().padStart(2,'0');
            const s = (timeLeft % 60).toString().padStart(2,'0');
            els.timeLeft.innerText = `${m}:${s}`;
        }

        function nextStep() { currentIndex++; loadStep(true); }

        document.getElementById('start-pause-btn').onclick = () => {
            if(sessionPlan[currentIndex].type === 'break') {
                isPaused = !isPaused;
                els.startPauseBtn.innerHTML = isPaused ? '<i class="fas fa-play"></i>' : '<i class="fas fa-pause"></i>';
            } else {
                nextStep();
            }
        };
        document.getElementById('skip-btn').onclick = nextStep;
        document.getElementById('prev-btn').onclick = () => { if(currentIndex > 0) { currentIndex--; loadStep(true); } };
        document.getElementById('finish-btn').onclick = () => { if(confirm("Finir la séance ?")) finishWorkout(); };

        // --- SUMMARY & HUD ---
        function finishWorkout() {
            localStorage.removeItem(IN_PROGRESS_KEY);
            populateAndShowSummary({mode: 'workout', sessionName: currentSession.nom_session});
        }

        function populateAndShowSummary(context) {
            currentSummaryContext = context;
            const isWorkout = context.mode === 'workout';
            
            let plan;
            if (isWorkout) {
                plan = sessionPlan;
                els.summaryTitle.textContent = "HUD BALISTIQUE & RÉSUMÉ"; 
                els.finishBtn.textContent = "VALIDER & SAUVEGARDER";
            } else {
                currentSession = programData.sessions.find(s => s.nom_session === context.sessionName);
                plan = JSON.parse(JSON.stringify(currentSession.exercices_et_pauses)); 
                sessionPlan = plan; 
                els.summaryTitle.textContent = "ÉDITION DU PROGRAMME";
                els.finishBtn.textContent = "ENREGISTRER MODIFICATIONS";
            }

            els.workout.style.display = 'none';
            els.summaryModal.classList.add('visible');
            
            const exos = plan.filter(e => e.type === 'exercise');
            const points = [];
            
            els.deltaList.innerHTML = '';
            els.summaryList.innerHTML = '';

            exos.forEach((ex, idx) => {
                const templateEx = currentSession.exercices_et_pauses.find(e => e.name === ex.name);
                const gap = calculateGap(ex, templateEx || ex);

                const jitter = (Math.random() - 0.5) * 2; 
                points.push({ x: gap.pctReps + jitter, y: gap.pctWeight + jitter, label: ex.name });

                if (isWorkout) {
                    if (!gap.isVibranium) {
                        let txt = [];
                        if (gap.missingReps > 0) txt.push(`+${gap.missingReps} reps`);
                        if (gap.missingWeight) txt.push(gap.missingWeight);
                        if (txt.length > 0) {
                            const div = document.createElement('div');
                            div.className = 'delta-card';
                            div.innerHTML = `<strong>${ex.name}</strong><span class="delta-missing">Manque : ${txt.join(' | ')}</span>`;
                            els.deltaList.appendChild(div);
                        }
                    } else {
                        const div = document.createElement('div');
                        div.className = 'delta-card mastered';
                        div.innerHTML = `<strong>${ex.name}</strong><span class="delta-ok">★ VIBRANIUM MASTERED ★</span>`;
                        els.deltaList.appendChild(div);
                    }
                }

                const li = document.createElement('li');
                li.className = `summary-item ${gap.isVibranium && isWorkout ? 'vibranium-item' : ''}`;
                li.innerHTML = `
                    <div class="exercise-name" style="color:${gap.isVibranium && isWorkout ? '#B026FF' : '#fff'}">
                        ${ex.name} ${gap.isVibranium && isWorkout ? '★' : ''}
                    </div>
                    <div class="input-group">
                        <label>Reps</label>
                        <div class="stepper-control">
                            <div class="stepper-btn" onclick="modVal(${idx}, 'reps', -1)">-</div>
                            <span class="stepper-value" id="s-reps-${idx}">${ex.reps}</span>
                            <div class="stepper-btn" onclick="modVal(${idx}, 'reps', 1)">+</div>
                        </div>
                    </div>
                    <div class="input-group" style="margin-top:5px;">
                        <label>Poids</label>
                        <input class="weight-input" id="s-w-${idx}" type="text" value="${ex.weight_text}">
                    </div>
                `;
                els.summaryList.appendChild(li);
            });

            const chartDiv = document.getElementById('analysis-chart-container');
            if(isWorkout) {
                chartDiv.style.display = 'block';
                renderScatter(points);
            } else {
                chartDiv.style.display = 'none';
            }
        }

        window.modVal = (idx, field, amount) => {
            const exos = sessionPlan.filter(e => e.type === 'exercise');
            const ex = exos[idx];
            if(field === 'reps') {
                ex.reps = (parseInt(ex.reps)||0) + amount;
                document.getElementById(`s-reps-${idx}`).innerText = ex.reps;
            }
        };

        function renderScatter(data) {
            if(scatterChart) scatterChart.destroy();
            const ctx = document.getElementById('analysis-chart').getContext('2d');
            
            scatterChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Exercices',
                        data: data,
                        backgroundColor: (ctx) => {
                            const v = ctx.raw;
                            return (v && v.x >= 95 && v.y >= 95) ? '#8A2BE2' : '#00BFFF';
                        },
                        pointRadius: 8,
                        pointHoverRadius: 12,
                        pointBorderColor: '#fff',
                        pointBorderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { min: 0, max: 115, title: {display:true, text:'% Reps'}, grid: {color:'#333'} },
                        y: { min: 0, max: 115, title: {display:true, text:'% Poids'}, grid: {color:'#333'} }
                    },
                    plugins: {
                        tooltip: { callbacks: { label: (ctx) => ctx.raw.label } },
                        annotation: {
                            annotations: {
                                box1: {
                                    type: 'box', xMin: 95, xMax: 115, yMin: 95, yMax: 115,
                                    backgroundColor: 'rgba(138, 43, 226, 0.15)', borderWidth: 1, borderColor: '#B026FF'
                                }
                            }
                        },
                        legend: { display: false }
                    }
                }
            });
        }

        els.finishBtn.onclick = async () => {
            els.finishBtn.disabled = true; 
            els.finishBtn.innerText = "SAUVEGARDE...";

            const exos = sessionPlan.filter(e => e.type === 'exercise');
            exos.forEach((ex, i) => {
                ex.reps = parseInt(document.getElementById(`s-reps-${i}`).innerText);
                ex.weight_text = document.getElementById(`s-w-${i}`).value;
            });

            if (currentSummaryContext.mode === 'workout') {
                historyData.push({
                    date: new Date().toISOString(),
                    sessionName: currentSession.nom_session,
                    exercises: JSON.parse(JSON.stringify(exos))
                });
                if(fileIds.hist) await saveFile(fileIds.hist, historyData);
            }

            const sessIdx = programData.sessions.findIndex(s => s.nom_session === currentSession.nom_session);
            if(sessIdx > -1) {
                let exCount = 0;
                programData.sessions[sessIdx].exercices_et_pauses.forEach(item => {
                    if(item.type === 'exercise') {
                        const updated = exos[exCount++];
                        item.reps = updated.reps;
                        item.weight_text = updated.weight_text;
                    }
                });
                if(fileIds.prog) await saveFile(fileIds.prog, programData);
            }

            els.summaryModal.classList.remove('visible');
            els.home.style.display = 'block';
            els.home.classList.add('active');
            renderHome(programData);
            showMsg("Sauvegardé avec succès !");
            els.finishBtn.disabled = false;
        };

        function initAudio() {
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        function playBeep() {
            if(!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.frequency.value = 800;
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);
            osc.start(); osc.stop(audioCtx.currentTime + 0.5);
        }
        function showMsg(msg, isError) {
            els.msgArea.innerText = msg;
            els.msgArea.style.borderColor = isError ? 'red' : 'var(--electric-cyan)';
            els.msgArea.classList.add('visible');
            setTimeout(() => els.msgArea.classList.remove('visible'), 3000);
        }
    </script>
</body>
</html>
  
