
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArmorWorkout - Réacteur Centré et Corrigé</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Chart.js Date Adapter (inclut date-fns) -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <!-- date-fns locale FR (Chargée séparément pour être sûre) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.30.0/locale/fr/index.min.js" integrity="sha512-6CRkHNYSGQrcV1adkgXgGFyLq6zWQoKT559zN5zwob06P9zq/mx1LpdROcj0mN8N+yflIr+pk7r7L3/+K/ZHZQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        /* --- Variables Globales & Thème --- */
        :root {
            --primary-bg: #0A0F1A; --secondary-bg: #111827; --primary-text: #E5E7EB; --secondary-text: #9CA3AF; --border-color: #374151; --input-bg: #1F2937;
            /* Couleurs états (pour texte HORS réacteur) */
            --exercise-color: #F472B6; --exercise-color-rgb: 244, 114, 182;
            --break-color: #facc15; --break-color-rgb: 250, 204, 21;
            --paused-color: #A78BFA; --paused-color-rgb: 167, 139, 250;
            --preparing-color: #60A5FA; --preparing-color-rgb: 96, 165, 250;
            --finished-color: #2ed573; --finished-color-rgb: 46, 213, 115;
            --idle-color: #9CA3AF; --idle-color-rgb: 156, 163, 175;
            --danger-color: #ff4757; --success-color: #2ed573; --warning-color: #facc15; --info-color: #60A5FA; --action-color: #A78BFA;
            /* Couleur Accent (pour éléments HORS réacteur) */
            --accent-color: #69f1f1; --accent-glow: 0 0 10px 5px rgba(105, 241, 241, 0.2); --accent-border: 1px solid rgba(105, 241, 241, 0.5); --accent-dim: rgba(105, 241, 241, 0.1);
            /* Boutons & Autres */
            --btn-bg: rgba(6, 20, 37, 0.3); --btn-border: 1px solid #2c3a4e; --btn-hover-bg: rgba(17, 24, 39, 0.5); --btn-hover-border: var(--secondary-text); --btn-hover-text: var(--primary-text); --btn-disabled-opacity: 0.5;
            --font-family-main: 'Inter', sans-serif; --font-family-display: 'Rajdhani', sans-serif; --border-radius-md: 6px; --transition-speed: 0.2s; --section-transition-speed: 0.3s;
            --total-progress-color: var(--accent-color); --total-progress-bg: rgba(17, 24, 39, 0.5);
        }
        /* --- Styles Globaux --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; font-size: 16px; }
        body { background-color: var(--primary-bg); font-family: var(--font-family-main); color: var(--primary-text); min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden; -webkit-font-smoothing: antialiased; }
        .container { max-width: 1280px; margin: 0 auto; width: 100%; flex-grow: 1; display: flex; flex-direction: column; padding: 0 1rem; }
        /* --- Header --- */
        header { padding: 10px 0; border-bottom: 1px solid var(--border-color); background-color: var(--primary-bg); width: 100%; transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out, visibility 0s linear 0.4s; z-index: 1000; }
        body.workout-active header { transform: translateY(-100%); opacity: 0; visibility: hidden; }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1280px; margin: 0 auto; padding: 0 1rem; }
        .header-actions-left, .header-actions-right { display: flex; align-items: center; gap: 10px; }
        .app-title { font-family: var(--font-family-display); text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 8px rgba(255, 255, 255, 0.4); color: var(--primary-text); font-size: 1.4rem; font-weight: 700; display: flex; align-items: center; gap: 8px; margin: 0; }
        .app-title i { color: var(--accent-color); font-size: 1.1em;}
        nav { display: flex; align-items: baseline; gap: 15px; }
        nav button { background: none; border: none; color: var(--secondary-text); font-size: 0.95em; font-weight: 500; padding-bottom: 4px; cursor: pointer; transition: color 0.3s ease, border-color 0.3s ease; border-bottom: 2px solid transparent; }
        nav button:disabled { color: rgba(156, 163, 175, 0.4); cursor: not-allowed; border-bottom-color: transparent !important; }
        nav button:not(:disabled):hover { color: var(--primary-text); }
        nav button.active { color: var(--primary-text); font-weight: 600; border-bottom-color: var(--accent-color); }
        nav button i { margin-right: 4px; font-size: 0.9em; }
        #nav-history.active { border-bottom-color: var(--exercise-color); }
        #nav-progress.active { border-bottom-color: var(--success-color); }
        /* --- Boutons --- */
        .app-button { background-color: var(--btn-bg); border: var(--btn-border); color: var(--accent-color); text-shadow: 0 0 5px rgba(105, 241, 241, 0.7); transition: all 0.3s ease; font-family: var(--font-family-display); letter-spacing: 1px; font-weight: 600; padding: 0.4rem 1.2rem; border-radius: 9999px; display: inline-flex; align-items: center; justify-content: center; gap: 0.4rem; font-size: 0.85rem; }
        .app-button:hover:not(:disabled) { box-shadow: var(--accent-glow); background-color: rgba(105, 241, 241, 0.1); border-color: var(--accent-color); }
        .app-button.danger { color: var(--danger-color); border-color: rgba(255, 71, 87, 0.5); text-shadow: 0 0 5px rgba(255, 71, 87, 0.7); }
        .app-button.danger:hover:not(:disabled) { box-shadow: 0 0 8px rgba(255, 71, 87, 0.6); background-color: rgba(255, 71, 87, 0.1); border-color: var(--danger-color); }
        .app-button.active { background-color: rgba(105, 241, 241, 0.2); box-shadow: var(--accent-glow); border-color: var(--accent-color); }
        .app-button:disabled { opacity: 0.5; cursor: not-allowed; background-color: rgba(6, 20, 37, 0.6); border-color: rgba(105, 241, 241, 0.15); color: rgba(105, 241, 241, 0.4); text-shadow: none; box-shadow: none; }
        .center-button { min-width: 110px; }
        /* Drive Status */
        #drive-status { display: inline-flex; align-items: center; gap: 8px; }
        #drive-status-text { border: 1px solid var(--success-color); color: var(--success-color); padding: 4px 10px; border-radius: var(--border-radius-md); font-size: 0.85em; font-weight: 500; }
        #drive-status.loading #drive-status-text { border-color: var(--warning-color); color: var(--warning-color); }
        #drive-status.error #drive-status-text { border-color: var(--danger-color); color: var(--danger-color); }
        #settings-icon { color: var(--secondary-text); font-size: 1rem; cursor: pointer; transition: color 0.3s ease, transform 0.3s ease; padding: 5px; }
        #settings-icon:hover { color: var(--primary-text); transform: rotate(45deg); }
        body.logged-out #drive-status, body.logged-out #signout-button, body.logged-out #export-button { display: none; }
        body.logged-in #signin-button { display: none; }
        /* --- Main Content --- */
        main { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; padding-top: 2rem; padding-bottom: 2rem; }
        body.workout-active main { padding-top: 1rem; }
        /* --- Sections --- */
        .app-section { background-color: transparent; padding: 0; border: none; width: 100%; margin-bottom: 30px; transition: opacity var(--section-transition-speed) ease-in-out, visibility 0s linear var(--section-transition-speed); max-height: 5000px; opacity: 1; visibility: visible; overflow: hidden; }
        .workout-section { max-width: 600px; width: 100%; text-align: center; }
        .history-section, .progress-section { max-width: 850px; width: 100%; text-align: left; background-color: rgba(17, 24, 39, 0.5); padding: 25px; border-radius: var(--border-radius-md); border: 1px solid var(--border-color); }
        .section-hidden { opacity: 0; max-height: 0 !important; padding-top: 0 !important; padding-bottom: 0 !important; margin-bottom: 0 !important; border-width: 0 !important; visibility: hidden; transition: opacity var(--section-transition-speed) ease-in-out, visibility 0s linear var(--section-transition-speed), max-height 0s linear var(--section-transition-speed), padding var(--section-transition-speed) ease-out, margin var(--section-transition-speed) ease-out, border-width var(--section-transition-speed) ease-out; }

        /* --- Timer Réacteur Exact - Centrage Corrigé --- */
        /* Keyframes */
        @-webkit-keyframes rotate-left { from { transform: rotate(360deg); } to { transform: rotate(0); } }
        @keyframes rotate-left { from { transform: rotate(360deg); } to { transform: rotate(0); } }
        @-webkit-keyframes rotate-right { from { transform: rotate(0); } to { transform: rotate(360deg); } }
        @keyframes rotate-right { from { transform: rotate(0); } to { transform: rotate(360deg); } }
        @-webkit-keyframes rotate-left-right { 0%, 50% { transform: translate(-50%, -50%) rotate(0); } 30%, 100% { transform: translate(-50%, -50%) rotate(360deg); } }
        @keyframes rotate-left-right { 0%, 50% { transform: translate(-50%, -50%) rotate(0); } 30%, 100% { transform: translate(-50%, -50%) rotate(360deg); } }

        .timer-display { margin-bottom: 25px; position: relative; display: flex; justify-content: center; align-items: center; width: 200px; height: 200px; margin-left: auto; margin-right: auto; cursor: pointer; user-select: none; -webkit-tap-highlight-color: transparent; }
        .reactor { position: relative; width: 100%; height: 100%; overflow: hidden; }

        /* Styles des Éléments du Réacteur (Absolu + Centrage Unifié) */
        .triangle, .circle-1, .circle-2, .circle-3, .circle-4, .circle-5, .circle-6, .circle-7, .circle-8 {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            box-sizing: border-box; /* S'assure que padding/border sont inclus dans la taille */
        }
        .triangle {
            z-index: 99; width: 155px; aspect-ratio: 1; background-color: #69f1f1;
            -webkit-clip-path: polygon(50% 88%, 0 0, 100% 0); clip-path: polygon(50% 88%, 0 0, 100% 0);
            transform: translate(-50%, calc(-50% + 32px)); /* Ajustement Y */
            animation: rotate-right 15s linear infinite;
        }
        .triangle::after { content: ''; display: block; position: absolute; top: 45%; left: 50%; z-index: 999; width: 120px; height: 120px; transform: translate(-50%, -50%); background-color: var(--primary-bg); -webkit-clip-path: polygon(50% 90%, 0 0, 100% 0); clip-path: polygon(50% 90%, 0 0, 100% 0); }
        .circle-1 { width: 200px; height: 200px; border-radius: 50%; z-index: 1; background: linear-gradient(rgba(105, 241, 241, 0.8), rgba(99, 193, 223, 0.8)); animation: rotate-right 2s linear infinite; }
        .circle-1::before { content: ''; position: absolute; inset: 10px; z-index: 2; border-radius: 50%; background-color: var(--primary-bg); }
        .circle-1 span { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; z-index: 0; background: linear-gradient(rgba(105, 241, 241, 0.8), rgba(99, 193, 223, 0.8)); }
        .circle-1 span:nth-child(1) { filter: blur(5px); } .circle-1 span:nth-child(2) { filter: blur(10px); } .circle-1 span:nth-child(3) { filter: blur(20px); } .circle-1 span:nth-child(4) { filter: blur(60px); }
        .circle-2 { width: 140px; height: 140px; border-radius: 50%; z-index: 9; border: 10px solid #69f1f1; box-shadow: 0 0 20px 5px rgba(105, 241, 241, 0.3); animation: rotate-left 4s linear infinite; }
        .circle-2 span { position: absolute; top: 50%; left: 50%; width: calc(100% + 22px); height: 10px; background-color: var(--primary-bg); }
        .circle-2 span:nth-child(1) { transform: translate(-50%, -50%) rotate(90deg); } .circle-2 span:nth-child(2) { transform: translate(-50%, -50%) rotate(45deg); } .circle-2 span:nth-child(3) { transform: translate(-50%, -50%) rotate(-45deg); } .circle-2 span:nth-child(4) { transform: translate(-50%, -50%) rotate(30deg); } .circle-2 span:nth-child(5) { transform: translate(-50%, -50%) rotate(-30deg); } .circle-2 span:nth-child(6) { transform: translate(-50%, -50%) rotate(0deg); } .circle-2 span:nth-child(7) { transform: translate(-50%, -50%) rotate(55deg); height: 5px; width: calc(100% + 24px); } .circle-2 span:nth-child(8) { transform: translate(-50%, -50%) rotate(125deg); height: 5px; width: calc(100% + 24px); }
        .circle-3 { width: 115px; height: 115px; border-radius: 50%; z-index: 10; box-shadow: 0 0 8px 8px rgba(105, 241, 241, 0.15); }
        .circle-3::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; border: 3px dotted rgba(105, 241, 241, 0.8); animation: rotate-right 10s linear infinite; }
        .circle-4 { width: 100px; height: 100px; border-radius: 50%; z-index: 11; box-shadow: 0 0 8px 8px rgba(105, 241, 241, 0.1); animation: rotate-left-right 20s infinite ease-in; }
        .circle-4 span { position: absolute; top: 50%; left: 50%; width: 100%; height: 100%; border-radius: 50%; border: 3px solid; border-color: #69f1f1 transparent transparent; }
        .circle-4 span:nth-child(1) { transform: translate(-50%, -50%) rotate(45deg); } .circle-4 span:nth-child(2) { transform: translate(-50%, -50%) rotate(-75deg); } .circle-4 span:nth-child(3) { transform: translate(-50%, -50%) rotate(165deg); }
        .circle-5 { width: 64px; height: 64px; border-radius: 50%; z-index: 12; background-color: rgba(105, 241, 241, 0.15); box-shadow: 0 0 15px 15px rgba(105, 241, 241, 0.15); animation: rotate-left-right 10s infinite ease-in; }
        .circle-5 span { position: absolute; top: 50%; left: 50%; width: 54px; height: 54px; border-radius: 50%; border: 5px solid; border-color: #69f1f1 transparent transparent; }
        .circle-5 span:nth-child(1) { transform: translate(-50%, -50%) rotate(0deg); } .circle-5 span:nth-child(2) { transform: translate(-50%, -50%) rotate(120deg); } .circle-5 span:nth-child(3) { transform: translate(-50%, -50%) rotate(240deg); }
        .circle-6 { width: 40px; height: 40px; border-radius: 50%; z-index: 13; }
        .circle-6::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; border: 3px dashed #69f1f1; animation: rotate-left 5s infinite ease-in; }
        .circle-7 { width: 27px; height: 27px; border-radius: 50%; z-index: 14; }
        .circle-7::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; background-color: #69f1f1; box-shadow: 0 0 5px 3px rgba(105, 241, 241, 0.3); }
        .circle-8 { width: 15px; height: 15px; border-radius: 50%; z-index: 15; animation: rotate-left-right 5s infinite ease-in; }
        .circle-8 span { position: absolute; top: 50%; left: 50%; width: 13px; height: 13px; border-radius: 50%; border: 1px solid; border-color: var(--primary-bg) transparent transparent; }
        .circle-8 span:nth-child(1) { transform: translate(-50%, -50%) rotate(120deg); } .circle-8 span:nth-child(2) { transform: translate(-50%, -50%) rotate(240deg); }

        /* Temps */
        #time-left { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 100; font-family: var(--font-family-display); font-size: 2.5rem; font-weight: 700; color: white; text-shadow: 0 0 10px rgba(105, 241, 241, 0.8); transition: text-shadow var(--transition-speed) ease; pointer-events: none; }
        /* Progression Totale */
        #total-progress-circle { position: absolute; inset: -6px; border-radius: 50%; z-index: 0; opacity: 0.25; border: 4px solid transparent; background-clip: padding-box; background-origin: border-box; background-image: conic-gradient(var(--total-progress-color) 0%, var(--total-progress-color) 0%, transparent 0%, transparent 100%); transition: background-image 0.3s linear; pointer-events: none; }
        /* État texte sous le timer */
        #timer-state { font-family: var(--font-family-display); margin-top: 1.2rem; font-size: 1rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; opacity: 0; transition: color 0.3s ease, opacity 0.3s ease, text-shadow 0.3s ease; color: var(--idle-color); text-shadow: 0 0 6px var(--idle-color); }
        #timer-state.visible { opacity: 0.9; }
        #timer-state.preparing { animation: countdown-pulse 1s infinite; font-size: 1.1em; }
        @keyframes countdown-pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.85; } }

        /* --- Autres Styles (Infos Workout / Contrôles / Tracker / Histo / Progress / Modal / Footer / Responsive / Overlay Reps) --- */
        #workout-info { text-align: center; margin-bottom: 1.5rem; }
        #current-exercise-name-display { font-size: 1.7rem; margin-bottom: 0.8rem; font-family: var(--font-family-display); color: var(--primary-text); }
        #current-exercise-container .workout-prompt { border-style: dashed !important; cursor: default !important; font-size: 0.9rem; color: var(--secondary-text); background: none; border: 1px solid var(--border-color); border-radius: 999px; padding: 0.4rem 1rem; display: inline-flex; align-items: center; gap: 0.5rem; }
        #current-exercise-container .workout-prompt:hover { background: none; box-shadow: none; }
        #current-exercise-container .workout-prompt i { color: var(--secondary-text); }
        #current-exercise-container .exercise-info-static, #current-exercise-container .break-info-static { color: var(--primary-text); background: rgba(17, 24, 39, 0.6); border-radius: var(--border-radius-md); border: 1px solid var(--border-color); padding: 0.8rem 1.2rem; text-align: center; width: 100%; max-width: 450px; margin: 0 auto; }
        #current-exercise-container .exercise-info-static span:not(.details-info) { display: inline-flex; align-items: center; gap: 0.5rem; margin: 0 0.8rem; font-size: 0.95rem; }
        #current-exercise-container .exercise-info-static span i { width: 16px; text-align: center; opacity: 0.8; }
        #current-exercise-container .exercise-info-static .reps-info i { color: var(--exercise-color); }
        #current-exercise-container .exercise-info-static .weight-info i { color: var(--action-color); }
        #current-exercise-container .exercise-info-static .details-info { display: block; font-size: 0.85rem; color: var(--secondary-text); margin-top: 0.6rem; opacity: 0.9; line-height: 1.4; }
        #current-exercise-container .exercise-info-static .details-info i { color: var(--info-color); margin-right: 4px;}
        #current-exercise-container .break-info-static .duration-info { font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; margin-bottom: 0.6rem; }
        #current-exercise-container .break-info-static .duration-info i { color: var(--break-color); }
        #current-exercise-container .break-info-static .next-exercise-info { font-size: 0.85rem; color: var(--secondary-text); }
        #current-exercise-container .next-exercise-info i { color: var(--preparing-color); margin-right: 4px;}
        .controls { width: 100%; max-width: 500px; display: flex; justify-content: center; gap: 0.8rem; margin-bottom: 1.5rem; padding: 0 1rem; flex-wrap: wrap; }
        .controls .app-button { flex-grow: 0; }
        #start-pause-btn:not(:disabled) { background-color: var(--accent-color); color: var(--primary-bg); border-color: var(--accent-color); text-shadow: none; }
        #start-pause-btn:not(:disabled):hover { background-color: #87f5f5; filter: brightness(1.1); box-shadow: var(--accent-glow); }
        #progress-tracker { color: rgba(255, 255, 255, 0.7); display: flex; align-items: center; justify-content: center; font-size: 0.85rem; gap: 1rem; flex-wrap: wrap; }
        #drive-connection-status-main { display: inline-flex; align-items: center; gap: 6px; }
        .status-indicator { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; background-color: var(--success-color); box-shadow: 0 0 6px var(--success-color); }
        #drive-connection-status-main.error .status-indicator { background-color: var(--danger-color); box-shadow: 0 0 6px var(--danger-color); }
        #drive-connection-status-main.loading .status-indicator { background-color: var(--warning-color); box-shadow: 0 0 6px var(--warning-color); animation: pulse-yellow 1.5s infinite ease-in-out; }
        @keyframes pulse-yellow { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        #drive-connection-text { font-weight: 500; }
        .history-section h2, .progress-section h2 { font-family: var(--font-family-display); color: var(--primary-text); margin-bottom: 1rem; }
        .history-controls, .progress-controls { padding-bottom: 15px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .history-filters, .progress-filters { display: flex; gap: 8px; flex-wrap: wrap; }
        .history-filters button { background-color: var(--btn-bg); border: var(--btn-border); color: var(--secondary-text); padding: 0.4rem 1rem; font-size: 0.8rem; font-family: var(--font-family-display); border-radius: 999px; }
        .history-filters button:hover:not(:disabled) { box-shadow: var(--accent-glow); background-color: rgba(105, 241, 241, 0.1); color: var(--accent-color); border-color: var(--accent-color); }
        .history-filters button.active { border-color: var(--accent-color); color: var(--accent-color); background-color: var(--accent-dim); box-shadow: var(--accent-glow); }
        .history-actions { display: flex; gap: 10px; align-items: center; color: var(--secondary-text); }
        #history-drive-status { font-size: 0.75em; padding: 3px 6px; background-color: rgba(17, 24, 39, 0.5); border-radius: var(--border-radius-md); border: 1px solid var(--border-color); transition: color 0.3s ease, border-color 0.3s ease; }
        #history-drive-status.syncing { color: var(--warning-color); border-color: var(--warning-color); } #history-drive-status.error { color: var(--danger-color); border-color: var(--danger-color); } #history-drive-status.success { color: var(--success-color); border-color: var(--success-color); }
        .chart-container { height: 280px; margin-bottom: 25px; background-color: transparent; border: 1px solid var(--border-color); border-radius: var(--border-radius-md); padding: 10px; position: relative; }
        .chart-placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--secondary-text); font-style: italic; text-align: center; padding: 0 10px; font-size: 0.9em; }
        #history-chart-canvas, #exercise-progress-chart { display: block; width: 100% !important; height: 100% !important; transition: opacity 0.3s ease; }
        .stats-display { margin-bottom: 25px; padding: 15px; background-color: transparent; border: 1px solid var(--border-color); border-radius: var(--border-radius-md); }
        .stats-display h3 { color: var(--primary-text); margin-bottom: 12px; font-size: 1.1em; }
        .stats-display .content-wrapper p { margin-bottom: 6px; display: flex; align-items: center; gap: 8px; font-size: 0.9em; }
        .stats-display .content-wrapper p i { width: 14px; text-align: center; color: var(--accent-color); opacity: 0.8;}
        .stats-display .content-wrapper p strong { color: var(--primary-text); font-weight: 500; }
        .stats-display .motivational-message { font-style: italic; font-weight: 500; margin-top: 12px !important; background: linear-gradient(90deg, var(--success-color), var(--accent-color)); -webkit-background-clip: text; background-clip: text; color: transparent; font-size: 0.9em; }
        .history-list { list-style: none; border: 1px solid var(--border-color); border-radius: var(--border-radius-md); background-color: transparent; max-height: 350px; overflow-y: auto; }
        .history-list li { display: grid; grid-template-columns: auto 1fr auto auto; align-items: center; padding: 10px 12px; border-bottom: 1px solid var(--border-color); gap: 8px 12px; font-size: 0.9em; }
        .history-list li:last-child { border-bottom: none; }
        .history-list li:nth-child(even) { background-color: rgba(17, 24, 39, 0.2); }
        .history-list li:hover { background-color: rgba(105, 241, 241, 0.05); }
        .history-item-date { color: var(--primary-text); font-size: 0.9em; } .history-item-date small { color: var(--secondary-text); font-size: 0.9em;}
        .history-item-type { color: var(--exercise-color); background-color: rgba(244, 114, 182, 0.1); border-radius: var(--border-radius-md); padding: 2px 6px; font-size: 0.8em; font-weight: 500; text-align: center; justify-self: start; }
        .history-item-reps { color: var(--action-color); font-weight: 500; font-size: 0.9em; justify-self: end; } .history-item-reps i { margin-right: 3px; font-size: 0.9em; }
        .history-item-duration { color: var(--info-color); font-weight: 500; font-variant-numeric: tabular-nums; justify-self: end; font-size: 0.9em; }
        .history-list .no-history { grid-column: 1 / -1; color: var(--secondary-text); text-align: center; padding: 25px 15px; font-style: italic; border: none; background: none !important; font-size: 0.9em; }
        .progress-filters .filter-group { display: flex; flex-direction: column; gap: 6px; min-width: 160px; } .progress-filters .filter-group label { font-size: 0.8em; color: var(--secondary-text); margin-bottom: -2px; }
        .progress-filters select { background-color: var(--input-bg); border: 1px solid var(--border-color); color: var(--primary-text); border-radius: var(--border-radius-md); padding: 5px 8px; font-size: 0.85em; cursor: pointer; transition: all var(--transition-speed) ease; max-width: 100%; -webkit-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2016%2016'%20fill='%239CA3AF'%3E%3Cpath%20fill-rule='evenodd'%20d='M4.22%206.22a.75.75%200%20011.06%200L8%208.94l2.72-2.72a.75.75%200%20111.06%201.06l-3.25%203.25a.75.75%200%2001-1.06%200L4.22%207.28a.75.75%200%20010-1.06z'%20clip-rule='evenodd'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 6px center; background-size: 14px 14px; padding-right: 25px; }
        .progress-filters select:hover { border-color: var(--accent-color); } .progress-filters select:focus { border-color: var(--accent-color); box-shadow: 0 0 0 2px var(--accent-dim); outline: none; }
        .progress-filters option { background-color: var(--primary-bg); color: var(--primary-text); } .filter-group:has(#metric-select) { display: none; }
        .exercise-progress-container { margin-bottom: 25px; } .exercise-progress-container h3 { color: var(--primary-text); font-size: 1.1em; margin-bottom: 12px; }
        .exercise-chart-container { height: 280px; background-color: transparent; border: 1px solid var(--border-color); border-radius: var(--border-radius-md); padding: 10px; position: relative; }
        .post-workout-summary { position: fixed; inset: 0; background-color: rgba(10, 15, 26, 0.9); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 15px; opacity: 0; visibility: hidden; pointer-events: none; transition: opacity 0.3s ease, visibility 0s linear 0.3s; }
        .post-workout-summary.visible { opacity: 1; visibility: visible; pointer-events: auto; }
        .post-workout-summary-content { background-color: var(--secondary-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius-md); box-shadow: 0 8px 25px rgba(0,0,0,0.3); width: 100%; max-width: 500px; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .post-workout-summary.visible .post-workout-summary-content { transform: scale(1); }
        .post-workout-summary h2 { color: var(--accent-color); font-family: var(--font-family-display); font-size: 1.4em; font-weight: 700; padding: 15px 20px; border-bottom: 1px solid var(--border-color); text-align: center; background-color: rgba(10, 15, 26, 0.5); text-shadow: 0 0 5px var(--accent-color); }
        .summary-items-list { list-style: none; padding: 10px 20px; overflow-y: auto; flex-grow: 1; background: var(--primary-bg); border-bottom: 1px solid var(--border-color); }
        .summary-item { display: grid; grid-template-columns: 1fr auto; gap: 8px 12px; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-color); } .summary-item:last-child { border-bottom: none; }
        .summary-item .exercise-name { color: var(--primary-text); font-weight: 500; font-size: 0.95em;} .summary-item .exercise-name i { color: var(--exercise-color); margin-right: 6px; font-size: 0.9em; } .summary-item .exercise-name small { color: var(--secondary-text); margin-left: 6px; font-size: 0.9em;}
        .summary-item .input-container { display: flex; align-items: center; gap: 6px; justify-self: end; } .summary-item label { display: none; }
        .summary-item input[type="number"] { background-color: var(--input-bg); border: 1px solid var(--border-color); color: var(--primary-text); border-radius: var(--border-radius-md); padding: 5px 8px; font-size: 0.9em; width: 60px; text-align: center; transition: all var(--transition-speed) ease; appearance: textfield; -moz-appearance: textfield; }
        .summary-item input[type="number"]::-webkit-outer-spin-button, .summary-item input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .summary-item input:focus { border-color: var(--accent-color); background-color: var(--secondary-bg); outline: none; box-shadow: 0 0 0 2px var(--accent-dim); }
        .summary-controls { padding: 15px 20px; display: flex; justify-content: center; gap: 12px; border-top: 1px solid var(--border-color); background-color: rgba(10, 15, 26, 0.5); }
        #finish-summary-btn { background-color: var(--success-color) !important; border-color: var(--success-color) !important; color: var(--primary-bg) !important; text-shadow: none !important; }
        #finish-summary-btn:hover:not(:disabled) { filter: brightness(1.1); box-shadow: 0 0 8px var(--success-color); }
        .state-finished #time-left { text-shadow: 0 0 12px var(--finished-color); }
        .state-finished #timer-state { color: var(--finished-color); text-shadow: 0 0 6px var(--finished-color); }
        .message-area { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(17, 24, 39, 0.9); color: var(--primary-text); border: 1px solid var(--border-color); padding: 10px 20px; border-radius: var(--border-radius-md); z-index: 3000; opacity: 0; transition: all 0.4s ease; pointer-events: none; font-size: 0.9em; box-shadow: 0 3px 12px rgba(0,0,0,0.25); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); max-width: 90%; text-align: center; }
        .message-area.visible { opacity: 1; transform: translate(-50%, -10px); pointer-events: auto; }
        .message-area.error-message { background-color: rgba(255, 71, 87, 0.85); color: #fff; border-color: var(--danger-color); text-shadow: 0 0 4px rgba(0,0,0,0.4); }
        footer { width: 100%; text-align: center; font-size: 0.7rem; color: rgb(107 114 128); margin-top: auto; padding: 0.8rem 0; border-top: 1px solid var(--border-color); }
        footer p { margin-bottom: 2px;}
        footer a { color: var(--secondary-text); text-decoration: none; transition: color 0.2s; }
        footer a:hover { color: var(--accent-color); }
        footer i.fa-google-drive { color: var(--success-color); }
        .rep-adjustment-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 120; background-color: rgba(10, 15, 26, 0.92); padding: 18px; border-radius: var(--border-radius-md); border: 1px solid var(--accent-border); box-shadow: 0 8px 25px rgba(0,0,0,0.35), 0 0 12px var(--accent-glow); display: none; flex-direction: column; align-items: center; gap: 12px; backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); width: 260px; }
        .rep-adjustment-overlay.visible { display: flex; animation: fadeInScale 0.25s ease-out forwards; }
        @keyframes fadeInScale { from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); } to { opacity: 1; transform: translate(-50%, -50%) scale(1); } }
        .rep-adjustment-overlay .title { font-family: var(--font-family-display); font-size: 1em; font-weight: 700; color: var(--accent-color); text-shadow: 0 0 4px var(--accent-color); text-align: center; margin-bottom: 4px;}
        .rep-adjustment-controls { display: flex; align-items: center; gap: 12px; }
        .rep-adjustment-btn { width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.3em; font-weight: 700; background-color: rgba(17, 24, 39, 0.8); border: 1px solid var(--border-color); color: var(--primary-text); cursor: pointer; transition: all var(--transition-speed) ease; }
        .rep-adjustment-btn.minus { border-color: var(--danger-color); color: var(--danger-color); } .rep-adjustment-btn.minus:hover { background-color: rgba(255, 71, 87, 0.15); box-shadow: 0 0 8px var(--danger-color) ; }
        .rep-adjustment-btn.plus { border-color: var(--success-color); color: var(--success-color); } .rep-adjustment-btn.plus:hover { background-color: rgba(46, 213, 115, 0.15); box-shadow: 0 0 8px var(--success-color); }
        .rep-adjustment-btn:active { transform: scale(0.95); }
        .current-reps { font-family: var(--font-family-display); font-size: 2em; font-weight: 900; color: var(--primary-text); font-variant-numeric: tabular-nums; min-width: 50px; text-align: center; }
        .rep-adjustment-next-exercise { font-size: 0.9em; color: var(--exercise-color); font-weight: 500; text-align: center; margin-top: 4px; }
        @media (max-width: 768px) {
             .container { padding: 0 1rem; } .header-content { padding: 0 1rem; flex-wrap: wrap; justify-content: center; }
             nav { gap: 10px; width: 100%; justify-content: center; order: 3; margin-top: 8px;} .header-actions-left { width: 100%; justify-content: center; order: 2; margin-top: 8px; gap: 8px; }
             .app-title { order: 1; width: 100%; text-align: center; margin-bottom: 8px; font-size: 1.3rem;} .timer-display { width: 180px; height: 180px; } #time-left { font-size: 2.2rem; }
             .controls { gap: 0.6rem; } .controls .app-button { min-width: 95px; padding: 0.4rem 1rem; font-size: 0.8rem;}
             .history-list li { font-size: 0.85em; grid-template-columns: auto 1fr auto; gap: 5px 10px; padding: 8px 10px; } .history-item-reps { grid-column: 3 / 4; justify-self: start; } .history-item-duration { grid-column: 1 / -1; grid-row: 2 / 3; justify-self: end; font-size: 0.9em; }
             .summary-item { grid-template-columns: 1fr auto; gap: 6px 10px; padding: 8px 0; } .history-section, .progress-section { padding: 20px; } .chart-container { height: 250px; }
        }
        @media (max-width: 480px) {
             .timer-display { width: 160px; height: 160px; } #time-left { font-size: 1.9rem; } #current-exercise-name-display { font-size: 1.4rem; }
             .controls { gap: 6px; } .controls .app-button { min-width: 85px; padding: 0.3rem 0.8rem; font-size: 0.75rem; gap: 0.3rem;} .controls .app-button i { font-size: 0.9em; margin: 0 !important; }
             .history-list li { grid-template-columns: auto 1fr; gap: 4px 8px; padding: 6px 8px; } .history-item-type { grid-column: 2 / 3; } .history-item-reps { grid-column: 1 / 2; grid-row: 2 / 3; justify-self: start; } .history-item-duration { grid-column: 2 / 3; grid-row: 2 / 3; justify-self: end; }
             .summary-controls button { width: 100%; } .summary-item { grid-template-columns: 1fr auto; gap: 5px 8px; padding: 6px 0;} .summary-item .exercise-name { font-size: 0.9em;} .summary-item input[type="number"] { width: 50px; font-size: 0.85em;}
             .post-workout-summary-content { max-width: 95%; } .message-area { font-size: 0.85em; padding: 8px 15px; } .rep-adjustment-overlay { width: 230px; padding: 15px; gap: 10px;}
             .rep-adjustment-btn { width: 35px; height: 35px; font-size: 1.2em;} .current-reps { font-size: 1.8em; } .chart-container { height: 220px; }
        }
    </style>
</head>
<body class="logged-out"> <!-- Start logged-out -->

    <header>
        <div class="header-content">
            <div class="header-actions-left">
                 <button id="signout-button" class="app-button danger" disabled><i class="fas fa-sign-out-alt mr-2"></i> Déconnecter</button>
                 <button id="export-button" class="app-button" disabled><i class="fas fa-file-export mr-2"></i> Exporter</button>
                 <div id="drive-status" style="display: none;">
                    <span id="drive-status-text"></span><i id="settings-icon" class="fas fa-cog"></i>
                 </div>
                 <button id="signin-button" class="app-button" disabled><i class="fab fa-google mr-2"></i> Connecter Drive</button>
            </div>
            <h1 class="app-title"><i class="fas fa-shield-alt"></i>ArmorWorkout</h1>
            <nav class="header-actions-right">
                 <button id="nav-push" data-workout="Push" disabled>Push</button>
                 <button id="nav-pull" data-workout="Pull" disabled>Pull</button>
                 <button id="nav-legs" data-workout="Legs" disabled>Legs</button>
                 <button id="nav-history"><i class="fas fa-history mr-1"></i> Historique</button>
                 <button id="nav-progress" disabled><i class="fas fa-chart-line mr-1"></i> Progression</button>
             </nav>
        </div>
    </header>

    <main class="container flex-grow flex flex-col items-center justify-center relative">
        <div class="workout-section w-full app-section" id="workout-section"> {/* workout-section a maintenant app-section */}
            {/* Timer Réacteur */}
            <div class="timer-display" id="timer-display-clickable">
                <div class="reactor" id="reactor-container">
                    <div class="triangle"></div>
                    <div class="circle-1"><span></span><span></span><span></span><span></span></div>
                    <div class="circle-2"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></div>
                    <div class="circle-3"></div>
                    <div class="circle-4"><span></span><span></span><span></span></div>
                    <div class="circle-5"><span></span><span></span><span></span></div>
                    <div class="circle-6"></div>
                    <div class="circle-7"></div>
                    <div class="circle-8"><span></span><span></span><span></span></div>
                    <div id="time-left">00:00</div>
                </div>
                <div id="total-progress-circle"></div>
            </div>
            <p id="timer-state" class="visible">Prêt</p>
            {/* Infos Exercice */}
            <div id="workout-info" class="text-center mb-8">
                <h2 id="current-exercise-name-display">ArmorWorkout</h2>
                <div id="current-exercise-container">
                    <div class="workout-prompt"><i class="fas fa-sign-in-alt mr-2"></i><span>Connectez-vous...</span></div>
                </div>
            </div>
            {/* Contrôles */}
            <div class="controls w-full max-w-xl flex justify-center gap-4 px-4 mb-8">
                <button id="prev-btn" class="app-button" disabled><i class="fas fa-backward-step mr-2"></i> Précédent</button>
                <button id="start-pause-btn" class="app-button center-button" disabled>Démarrer</button>
                <button id="skip-btn" class="app-button" disabled>Suivant <i class="fas fa-forward-step ml-2"></i></button>
                <button id="finish-btn" class="app-button" disabled><i class="fas fa-flag-checkered mr-2"></i> Finir</button>
                <button id="reset-btn" class="app-button danger" disabled><i class="fas fa-redo mr-2"></i> Reset</button>
            </div>
            {/* Tracker Inférieur */}
            <div id="progress-tracker">
               <span id="progress-text-area">Connectez-vous pour commencer</span>
                <span id="drive-connection-status-main" class="ml-4 items-center" style="display: none;">
                   <span class="status-indicator"></span><span id="drive-connection-text"></span>
               </span>
            </div>
            {/* Overlay Reps */}
             <div class="rep-adjustment-overlay" id="rep-adjustment-overlay">
                 <div class="title">Ajuster Répétitions</div><div class="rep-adjustment-next-exercise" id="rep-adjustment-exercise-name">Exercice</div>
                 <div class="rep-adjustment-controls"><button class="rep-adjustment-btn minus" id="rep-adjust-minus">-</button><span class="current-reps" id="current-reps-display">12</span><button class="rep-adjustment-btn plus" id="rep-adjust-plus">+</button></div>
             </div>
        </div>
        {/* Sections Histo/Progress */}
        <div class="history-section w-full max-w-4xl mx-auto mt-8 section-hidden app-section" id="history-section">
            <h2 class="text-2xl font-bold text-center mb-6 app-title"><i class="fas fa-history mr-2"></i> Historique & Stats</h2>
             <div class="history-controls"><div class="history-filters" role="group"><button data-period="week" class="active app-button"><i class="fas fa-calendar-week mr-1"></i> Sem</button><button data-period="month" class="app-button"><i class="fas fa-calendar-alt mr-1"></i> Mois</button><button data-period="year" class="app-button"><i class="fas fa-calendar-check mr-1"></i> Année</button><button data-period="all" class="app-button"><i class="fas fa-infinity mr-1"></i> Tout</button></div><div class="history-actions" style="display: none;"><span id="history-drive-status"></span></div></div>
            <div class="chart-container"><canvas id="history-chart-canvas"></canvas><p id="history-chart-placeholder" class="chart-placeholder"></p></div>
            <div class="stats-display"><h3>Statistiques</h3><div class="content-wrapper" aria-live="polite"><p>...</p></div><p class="motivational-message"></p></div>
            <ul class="history-list"><li class="no-history">...</li></ul>
        </div>
        <div class="progress-section w-full max-w-4xl mx-auto mt-8 section-hidden app-section" id="progress-section">
            <h2 class="text-2xl font-bold text-center mb-6 app-title"><i class="fas fa-chart-line mr-2"></i> Progression</h2>
            <div class="progress-controls"><div class="progress-filters"><div class="filter-group"><label for="exercise-select">Exercice</label><select id="exercise-select"><option value="all">Tous (Total Reps)</option></select></div><div class="filter-group"><label for="period-select">Période</label><select id="period-select"><option value="week">Cette Semaine</option><option value="month">Ce Mois</option><option value="3months">3 Mois</option><option value="6months">6 Mois</option><option value="year" selected>1 An</option><option value="all">Tout</option></select></div></div></div>
            <div class="exercise-progress-container"><h3 id="progress-chart-title">Progression</h3><div class="exercise-chart-container"><canvas id="exercise-progress-chart"></canvas><p id="exercise-progress-placeholder" class="chart-placeholder"></p></div></div>
        </div>
    </main>
    {/* Footer / Modal / Message Area */}
    <footer><p>© 2024 ArmorWorkout. Sauvegarde auto sur <i class="fab fa-google-drive text-green-500"></i> Drive.</p><p><a href="https://github.com/ironworkout/armorworkout" target="_blank" rel="noopener noreferrer"><i class="fab fa-github"></i> GitHub</a></p></footer>
    <div id="message-area" class="message-area" role="status" aria-live="polite"></div>
    <div id="post-workout-summary" class="post-workout-summary" role="dialog" aria-modal="true" aria-labelledby="summary-title"><div class="post-workout-summary-content"><h2 id="summary-title">Résumé & Objectifs</h2><ul id="summary-items-list" class="summary-items-list"></ul><div class="summary-controls"><button id="finish-summary-btn" class="app-button"><i class="fas fa-check mr-2"></i>Fin & Sauvegarder</button></div></div></div>

    <!-- Scripts -->
    <script async defer src="https://accounts.google.com/gsi/client"></script>
    <script>
        // --- CONFIGURATION & CONSTANTES ---
        const GOOGLE_CLIENT_ID = "731283926358-viam3ulpgna14flfdeb9m92l8s620hoi.apps.googleusercontent.com"; const GOOGLE_DRIVE_SCOPES = 'https://www.googleapis.com/auth/drive.file'; const HISTORY_FILENAME = "armorworkout_history.json"; const PROGRAM_FILENAMES = { Push: "armorworkout_push_program.json", Pull: "armorworkout_pull_program.json", Legs: "armorworkout_legs_program.json" }; const PROGRAM_TYPES = ['Push', 'Pull', 'Legs']; const PREPARE_DURATION = 3; const SECONDS_PER_REP = 2.5; const IN_PROGRESS_KEY = 'armorWorkoutStateInProgress'; const GIS_CHECK_INTERVAL = 100; const GIS_MAX_RETRIES = 50;

        // --- DONNÉES PAR DÉFAUT ---
        // !!!!!!!!!! EXTREMEMENT IMPORTANT !!!!!!!!!!
        // VÉRIFIEZ SCRUPULEUSEMENT LA SYNTAXE JSON CI-DESSOUS.
        // L'ERREUR "missing } after property list" VIENT PRESQUE CERTAINEMENT D'ICI.
        // CHAQUE { DOIT AVOIR UN }, CHAQUE [ DOIT AVOIR UN ].
        // LES PROPRIÉTÉS ("cle": valeur) SONT SÉPARÉES PAR UNE VIRGULE (,),
        // SAUF LA DERNIÈRE PROPRIÉTÉ DANS UN OBJET {} OU LE DERNIER ÉLÉMENT DANS UN TABLEAU [].
        const defaultWorkouts = { Push: [ {"type":"exercise","name":"Pompes (Push-ups)","reps":15,"weight":0,"details":"Poids de corps (adapter difficulté: genoux, mains/pieds surélevés)","equipment":"Bodyweight","reps_start":8,"reps_target_max":20,"progression_note":"Quand 20 reps faciles: Augmenter difficulté (pieds plus hauts, tempo lent). Ou passer aux Pompes Déclinées. Ensuite ajouter elastiques 15 kg, 25 kg ..."}, {"type":"break","duration":75,"name":"Repos"}, {"type":"exercise","name":"Dips (Banc ou Chaise)","reps":12,"weight":0,"details":"Poids de corps","equipment":"Bench or Chair","reps_start":10,"reps_target_max":20,"progression_note":"Quand 20 reps faciles: Ajouter poids (haltère sur les genoux) ou passer à Dips sur barres parallèles."}, {"type":"break","duration":75,"name":"Repos"}, {"type":"exercise","name":"Élévations Latérales (Haltères)","reps":15,"weight":5,"details":"Haltères 2x5kg","equipment":"Dumbbells","reps_start":12,"reps_target_max":25,"progression_note":"Quand 25 reps: Augmenter poids (+1 ou +2kg par haltère)."}, {"type":"break","duration":60,"name":"Repos"}, {"type":"exercise","name":"Développé Épaules (Haltères Assis)","reps":12,"weight":7,"details":"Haltères 2x7kg","equipment":"Dumbbells + Bench","reps_start":10,"reps_target_max":15,"progression_note":"Quand 15 reps: Augmenter poids (+1 ou +2kg par haltère)."}, {"type":"break","duration":75,"name":"Repos"}, {"type":"exercise","name":"Extensions Triceps (Haltère au front)","reps":15,"weight":7,"details":"1 Haltère 7kg","equipment":"Dumbbell","reps_start":12,"reps_target_max":20,"progression_note":"Quand 20 reps: Augmenter poids (+1 ou +2kg)."} ], Pull: [ {"type":"exercise","name":"Rowing Haltère Unilatéral","reps":12,"weight":15,"details":"1 Haltère 15kg (chaque côté)","equipment":"Dumbbell + Bench","reps_start":10,"reps_target_max":15,"progression_note":"Quand 15 reps: Augmenter poids (+2 ou +3kg)."}, {"type":"break","duration":75,"name":"Repos"}, {"type":"exercise","name":"Tirage Vertical Élastique","reps":15,"weight":25,"details":"Élastique 25kg","equipment":"Resistance Band","reps_start":12,"reps_target_max":20,"progression_note":"Quand 20 reps: Utiliser élastique plus résistant ou ajouter un élastique fin."}, {"type":"break","duration":75,"name":"Repos"}, {"type":"exercise","name":"Face Pulls Élastique","reps":20,"weight":15,"details":"Élastique 15kg","equipment":"Resistance Band","reps_start":15,"reps_target_max":30,"progression_note":"Quand 30 reps: Utiliser élastique plus résistant ou augmenter la tension."}, {"type":"break","duration":60,"name":"Repos"}, {"type":"exercise","name":"Curl Biceps (Haltères)","reps":12,"weight":7,"details":"Haltères 2x7kg","equipment":"Dumbbells","reps_start":10,"reps_target_max":15,"progression_note":"Quand 15 reps: Augmenter poids (+1 ou +2kg par haltère)."}, {"type":"break","duration":60,"name":"Repos"}, {"type":"exercise","name":"Shrugs (Haussements d'épaules Haltères)","reps":15,"weight":15,"details":"Haltères 2x15kg","equipment":"Dumbbells","reps_start":12,"reps_target_max":20,"progression_note":"Quand 20 reps: Augmenter poids (+2 ou +3kg par haltère)."} ], Legs: [ {"type":"exercise","name":"Front Squat Combo","reps":12,"weight":15,"details":"Élastique 15+25kg + 1 haltère 5kg","equipment":"Élastique 15+25kg + 1 haltère 5kg","reps_start":12,"reps_target_max":15,"progression_note":"Quand 15 reps: Pause Squat (Pause 1-2s en bas). Recommence à 12 reps."}, {"type":"break","duration":90,"name":"Repos"}, {"type":"exercise","name":"Fentes Arrières (Haltères)","reps":10,"weight":7,"details":"Haltères 2x7kg (par jambe)","equipment":"Dumbbells","reps_start":8,"reps_target_max":12,"progression_note":"Quand 12 reps par jambe: Augmenter poids (+1 ou +2kg par haltère)."}, {"type":"break","duration":75,"name":"Repos"}, {"type":"exercise","name":"Soulevé de Terre Roumain (Haltères)","reps":15,"weight":10,"details":"Haltères 2x10kg","equipment":"Dumbbells","reps_start":12,"reps_target_max":20,"progression_note":"Quand 20 reps: Augmenter poids (+2kg par haltère)."}, {"type":"break","duration":75,"name":"Repos"}, {"type":"exercise","name":"Extensions Mollets Debout (Haltère)","reps":20,"weight":15,"details":"1 Haltère 15kg (alterner main)","equipment":"Dumbbell + Step/Support","reps_start":15,"reps_target_max":30,"progression_note":"Quand 30 reps: Augmenter poids (+2 ou +3kg)."}, {"type":"break","duration":60,"name":"Repos"}, {"type":"exercise","name":"Leg Raises (Relevé de jambes)","reps":12,"weight":0,"details":"Poids de corps","equipment":"Bodyweight","reps_start":12,"reps_target_max":20,"progression_note":"Quand 20 reps jambes tendues: Weighted Leg Raises (Tenir haltère 5kg entre les pieds). Recommence à 12 reps."} ] };
        // --- Éléments DOM (Cache) ---
        const domElements = {};
        // --- Variables d'État ---
        let currentWorkoutType = null, currentWorkoutPlan = [], originalCompletedWorkoutPlan = []; let currentItemIndex = 0, timerInterval = null, prepareCountdownInterval = null; let totalTime = 0, timeLeft = 0, prepareTimeLeft = 0; let totalWorkoutEstimatedSeconds = 0, elapsedWorkoutEstimatedSeconds = 0; let isTimerRunning = false, isWorkoutActive = false, workoutFinished = false; let currentState = 'idle'; let workoutStartTime = null, workoutHistory = []; let currentHistoryPeriod = 'week'; let historyChartInstance = null, exercisePerfChartInstance = null; let googleAccessToken = null, tokenClient = null; let historyFileId = null, programFileIds = { Push: null, Pull: null, Legs: null }; let programsLoaded = false, loadedWorkouts = JSON.parse(JSON.stringify(defaultWorkouts)); let isSavingDriveData = false; let messageTimeoutId = null; let audioContext = null; let nextExerciseIndexForAdjustment = -1, currentRepAdjustment = 0, isRepAdjustmentVisible = false; let gisCheckRetries = 0; let halfwayTimeoutId = null; const sounds = {};

        // --- Initialisation DOM ---
        function initializeDOMReferences() { const ids = [ 'time-left', 'reactor-container', 'timer-state', 'current-exercise-container', 'current-exercise-name-display', 'progress-tracker', 'progress-text-area', 'start-pause-btn', 'skip-btn', 'finish-btn', 'reset-btn', 'prev-btn', 'message-area', 'workout-section', 'history-section', 'progress-section', 'history-list', 'stats-display', 'history-chart-canvas', 'exercise-progress-chart', 'signin-button', 'signout-button', 'export-button', 'drive-status', 'drive-status-text', 'settings-icon', 'post-workout-summary', 'summary-title', 'summary-items-list', 'finish-summary-btn', 'history-drive-status', 'total-progress-circle', 'drive-connection-status-main', 'drive-connection-text', 'exercise-select', 'period-select', 'history-chart-placeholder', 'exercise-progress-placeholder', 'progress-chart-title', 'rep-adjustment-overlay', 'rep-adjust-minus', 'rep-adjust-plus', 'current-reps-display', 'rep-adjustment-exercise-name', 'nav-push', 'nav-pull', 'nav-legs', 'nav-history', 'nav-progress' ]; ids.forEach(id => domElements[id.replace(/-([a-z])/g, g => g[1].toUpperCase())] = document.getElementById(id)); domElements.timerDisplayClickable = document.getElementById('timer-display-clickable'); domElements.statsContentWrapper = domElements.statsDisplay?.querySelector('.content-wrapper'); domElements.historyFilterBtns = Array.from(document.querySelectorAll('.history-filters button')); domElements.historyActionsContainer = document.querySelector('.history-actions'); domElements.navButtons = [ domElements.navPush, domElements.navPull, domElements.navLegs ]; console.log("DOM References Initialized."); }

        // --- Audio & Vibration ---
        function initSounds() { try { const basePath = "https://ironworkout.github.io/armorworkout/"; const soundFiles = { laser: 'laser.mp3', s5: '5.mp3', s4: '4.mp3', s3: '3.mp3', s2: '2.mp3', s1: '1.mp3', windows: 'windows.mp3', et: 'e-t.mp3' }; for (const key in soundFiles) { sounds[key] = new Audio(basePath + soundFiles[key]); sounds[key].preload = 'auto'; } console.log("Sounds initialized"); } catch (e) { console.error("Error initializing sounds:", e); } }
        function playSound(soundKey) { const audioElement = sounds[soundKey]; if (!audioElement || !audioContext || audioContext.state !== 'running') return; try { audioElement.currentTime = 0; audioElement.play().catch(e => {}); } catch(e) { console.warn("Sound play error:", e); } }
        function initAudioContext() { if (audioContext && audioContext.state === 'running') return; if (!audioContext) { try { window.AudioContext = window.AudioContext || window.webkitAudioContext; if (window.AudioContext) { audioContext = new AudioContext(); console.log("AudioContext created."); } else { console.warn("AudioContext not supported."); return; } } catch (e) { console.error("Error creating AudioContext:", e); return; } } if (audioContext.state === 'suspended') { audioContext.resume().then(() => console.log("AudioContext resumed.")).catch(e => console.error("Error resuming AudioContext:", e)); } }
        const playTransitionSound = () => playSound('laser');
        const vibrate = (pattern = [100]) => { if ('vibrate' in navigator) { try { navigator.vibrate(pattern); } catch (e) {} } };

        // --- Google Identity Services (GIS) & Drive API ---
        async function gisInitInternal() { if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) { try { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: GOOGLE_CLIENT_ID, scope: GOOGLE_DRIVE_SCOPES, callback: tokenCallback, error_callback: handleTokenError, prompt: '' }); if (domElements.signInButton) domElements.signInButton.disabled = false; console.log("Google Token Client Initialized."); } catch (error) { console.error("Error initializing Google Token Client:", error); updateAuthUI(false); if (domElements.signInButton) domElements.signInButton.disabled = true; } } else { console.warn("Google Identity Services structure not found as expected."); if (domElements.signInButton) domElements.signInButton.disabled = true; } }
        function checkAndInitGis() { if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2 && typeof google.accounts.oauth2.initTokenClient === 'function') { gisInitInternal(); } else if (gisCheckRetries < GIS_MAX_RETRIES) { gisCheckRetries++; setTimeout(checkAndInitGis, GIS_CHECK_INTERVAL); } else { console.error(`Google Identity Services failed to load after ${GIS_MAX_RETRIES} retries.`); showMessage("Impossible de charger l'API Google. Vérifiez votre connexion/bloqueur.", 6000, true); if (domElements.signInButton) domElements.signInButton.disabled = true; updateAuthUI(false); } }
        function handleTokenError(error) { console.error("Google Token Error:", error); let userMessage = `Erreur Authentification Google: ${error.type || error.error || 'Inconnue'}.`; if (error.type === 'popup_closed_by_user') { userMessage = "Connexion annulée."; } else if (error.type === 'access_denied') { userMessage = "Accès refusé. Autorisation Drive nécessaire."; } else if (error.type === 'popup_failed_to_open') { userMessage = "Impossible d'ouvrir la fenêtre de connexion. Vérifiez les pop-ups."; } updateDriveStatusUI('error', 'Erreur Auth'); showMessage(userMessage, 6000, true); updateAuthUI(false); }
        async function tokenCallback(tokenResponse) { updateDriveStatusUI(null, null); if (tokenResponse.error) { handleTokenError(tokenResponse); return; } if (tokenResponse && tokenResponse.access_token) { googleAccessToken = tokenResponse.access_token; console.log("Google Access Token obtained."); showMessage("Connecté ! Chargement des données Drive...", 3500); updateDriveStatusUI('loading', 'Chargement...'); let historyLoaded = false; let programsSuccess = false; try { await loadHistoryFromDrive(); historyLoaded = true; programsSuccess = await loadProgramsFromDrive(); programsLoaded = programsSuccess; if (programsLoaded) { showMessage("Données Drive chargées. Prêt.", 3000); updateDriveStatusUI('success', 'Connecté'); } else { showMessage("Erreur chargement programmes Drive. Utilisation des programmes par défaut.", 5000, true); updateDriveStatusUI('error', 'Err Progs'); programsLoaded = true; } } catch (error) { console.error("Erreur critique chargement données Drive:", error); showMessage("Erreur majeure chargement Drive. Vérifiez la console.", 6000, true); updateDriveStatusUI('error', 'Erreur Données'); programsLoaded = false; } finally { updateAuthUI(true); if (programsLoaded) { populateExerciseSelect(); displayHistory(currentHistoryPeriod); displayExerciseProgress(); loadInProgressState(); } } } else { handleTokenError({ error: "invalid_token_response", type: "token_missing" }); } }
        function handleAuthClick() { initAudioContext(); if (!tokenClient) { console.error("Google Token Client not initialized."); showMessage("Erreur: Client d'authentification non prêt.", 4000, true); return; } updateDriveStatusUI('loading', 'Connexion...'); tokenClient.requestAccessToken({ prompt: 'consent' }); }
        function handleSignoutClick(showMessages = true) { const token = googleAccessToken; if (!token) return; if (showMessages) { updateDriveStatusUI('loading', 'Déconnexion...'); } google.accounts.oauth2.revoke(token, () => { console.log("Google Access Token revoked."); googleAccessToken = null; historyFileId = null; programFileIds = { Push: null, Pull: null, Legs: null }; programsLoaded = false; workoutHistory = []; loadedWorkouts = JSON.parse(JSON.stringify(defaultWorkouts)); clearInProgressState(); if (isWorkoutActive || currentState !== 'idle') { resetCurrentWorkout(false); } updateAuthUI(false); if (showMessages) { showMessage("Déconnecté.", 3000); } updateDriveStatusUI(null, null); displayHistory(currentHistoryPeriod); clearCharts(); populateExerciseSelect(); displayExerciseProgress(); }); }
        function updateDriveStatusUI(status = null, text = null) { const elements = [ { container: domElements.driveStatusElement, textEl: domElements.driveStatusTextElement }, { container: domElements.driveConnectionStatusMain, textEl: domElements.driveConnectionText, indicator: domElements.driveConnectionStatusMain?.querySelector('.status-indicator') } ]; elements.forEach(el => { if (!el.container || !el.textEl) return; el.container.classList.remove('loading', 'error', 'success'); if (status) { el.container.classList.add(status); el.container.style.display = 'inline-flex'; el.textEl.textContent = text || status.charAt(0).toUpperCase() + status.slice(1); } else { el.container.style.display = 'none'; } }); if(domElements.historyDriveStatus) { domElements.historyDriveStatus.className = ''; if(isSavingDriveData) { domElements.historyDriveStatus.classList.add('syncing'); domElements.historyDriveStatus.textContent = 'Synchro...'; } else { const mainStatusClass = domElements.driveStatusElement?.classList.contains('success') ? 'success' : domElements.driveStatusElement?.classList.contains('error') ? 'error' : domElements.driveStatusElement?.classList.contains('loading') ? 'syncing' : ''; if(mainStatusClass) { domElements.historyDriveStatus.classList.add(mainStatusClass); domElements.historyDriveStatus.textContent = mainStatusClass === 'success' ? 'Synchro OK' : mainStatusClass === 'error' ? 'Erreur Synchro' : mainStatusClass === 'syncing' ? 'Chargement...' : ''; } else { domElements.historyDriveStatus.textContent = ''; } } } }
        function updateAuthUI(isLoggedIn) { const body = document.body; body.classList.toggle('logged-in', isLoggedIn); body.classList.toggle('logged-out', !isLoggedIn); if (domElements.signInButton) domElements.signInButton.disabled = isLoggedIn || !tokenClient; if (domElements.signOutButton) domElements.signOutButton.disabled = !isLoggedIn; if (domElements.exportButton) domElements.exportButton.disabled = !isLoggedIn; updateDriveStatusUI( isLoggedIn ? (domElements.driveStatusElement?.classList.contains('error') ? 'error' : domElements.driveStatusElement?.classList.contains('loading') ? 'loading' : 'success') : null, isLoggedIn ? (domElements.driveStatusElement?.classList.contains('error') ? 'Erreur' : domElements.driveStatusElement?.classList.contains('loading') ? 'Chargement...' : 'Connecté') : null ); if(domElements.historyActionsContainer) domElements.historyActionsContainer.style.display = isLoggedIn ? 'flex' : 'none'; const isTimerActive = ['preparing', 'exercise', 'break', 'paused'].includes(currentState); domElements.navButtons?.forEach(btn => { if (btn) btn.disabled = !(isLoggedIn && programsLoaded && !isTimerActive); }); if (domElements.navHistoryBtn) domElements.navHistoryBtn.disabled = isTimerActive; if (domElements.navProgressBtn) domElements.navProgressBtn.disabled = !isLoggedIn || isTimerActive; if (currentState === 'idle') { const canStartWorkout = isLoggedIn && programsLoaded && !!currentWorkoutType && currentWorkoutPlan && currentWorkoutPlan.length > 0; if (domElements.startPauseBtn) { domElements.startPauseBtn.disabled = !canStartWorkout; domElements.startPauseBtn.innerHTML = `<i class="fas fa-play mr-2"></i> Démarrer`; domElements.startPauseBtn.classList.remove('active'); } if(domElements.prevBtn) domElements.prevBtn.disabled = true; if(domElements.skipBtn) domElements.skipBtn.disabled = true; if(domElements.finishBtn) domElements.finishBtn.disabled = true; if(domElements.resetBtn) domElements.resetBtn.disabled = !(isLoggedIn && !!currentWorkoutType); } else if (currentState === 'finished') { if (domElements.startPauseBtn) { domElements.startPauseBtn.disabled = true; domElements.startPauseBtn.innerHTML = `<i class="fas fa-check-circle mr-2"></i> Terminé`; } if(domElements.prevBtn) domElements.prevBtn.disabled = true; if(domElements.skipBtn) domElements.skipBtn.disabled = true; if(domElements.finishBtn) domElements.finishBtn.disabled = true; if(domElements.resetBtn) domElements.resetBtn.disabled = !isLoggedIn; } else { if(domElements.prevBtn) domElements.prevBtn.disabled = !(isTimerActive && currentItemIndex > 0); if(domElements.skipBtn) domElements.skipBtn.disabled = !isTimerActive || currentState === 'preparing'; if(domElements.finishBtn) domElements.finishBtn.disabled = !isTimerActive || currentState === 'preparing'; if(domElements.resetBtn) domElements.resetBtn.disabled = !isLoggedIn; } updateWorkoutInfo(); }
        async function findOrCreateFile(filename, defaultContent = "", mimeType = 'application/json') { if (!googleAccessToken) { console.warn("Attempting Drive access without token for", filename); return null; } const searchUrl = `https://www.googleapis.com/drive/v3/files?q=name='${encodeURIComponent(filename)}'+and+trashed=false&spaces=drive&fields=files(id,name)`; try { const searchRes = await fetch(searchUrl, { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }); if (!searchRes.ok) { if (searchRes.status === 401 || searchRes.status === 403) { console.warn("Invalid token detected (findOrCreateFile). Signing out."); handleSignoutClick(false); return null; } throw new Error(`Search failed: ${searchRes.status} for ${filename}`); } const searchData = await searchRes.json(); if (searchData.files && searchData.files.length > 0) { return searchData.files[0].id; } console.log(`File "${filename}" not found. Creating...`); const createUrl = `https://www.googleapis.com/drive/v3/files`; const metadata = { name: filename, mimeType: mimeType }; const createRes = await fetch(createUrl, { method: 'POST', headers: { 'Authorization': `Bearer ${googleAccessToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify(metadata) }); if (!createRes.ok) throw new Error(`Creation failed: ${createRes.status} for ${filename}`); const createData = await createRes.json(); const newFileId = createData.id; console.log(`File "${filename}" created with ID: ${newFileId}. Writing default content...`); const writeSuccess = await updateFileContent(newFileId, defaultContent); return writeSuccess ? newFileId : null; } catch (error) { console.error(`Drive Error (findOrCreateFile for ${filename}):`, error); showMessage(`Erreur accès Drive pour ${filename}.`, 5000, true); return null; } }
        async function readFileContent(fileId) { if (!googleAccessToken || !fileId) return null; const url = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`; try { const response = await fetch(url, { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }); if (!response.ok) { if (response.status === 404) { console.warn(`Drive file ${fileId} not found (404). Returning empty content.`); return ""; } if (response.status === 401 || response.status === 403) { console.warn("Invalid token detected (readFileContent). Signing out."); handleSignoutClick(false); return null; } throw new Error(`Read failed: ${response.status} for fileId ${fileId}`); } return await response.text(); } catch (error) { console.error(`Drive Error (readFileContent for ${fileId}):`, error); showMessage(`Erreur lecture fichier Drive (${fileId}).`, 5000, true); return null; } }
        async function updateFileContent(fileId, content) { if (!googleAccessToken || !fileId) return false; if (isSavingDriveData) { console.warn("Drive save already in progress, request ignored for fileId:", fileId); showMessage("Sauvegarde Drive en cours...", 1500); return false; } isSavingDriveData = true; updateDriveStatusUI('syncing', 'Synchro...'); const url = `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`; const isJson = typeof content === 'object'; const contentToSend = isJson ? JSON.stringify(content, null, 2) : content; const contentType = isJson ? 'application/json; charset=UTF-8' : 'text/plain; charset=UTF-8'; let success = false; try { const response = await fetch(url, { method: 'PATCH', headers: { 'Authorization': `Bearer ${googleAccessToken}`, 'Content-Type': contentType }, body: contentToSend }); if (!response.ok) { if (response.status === 401 || response.status === 403) { console.warn("Invalid token detected (updateFileContent). Signing out."); handleSignoutClick(false); } else { let errorBody = null; try { errorBody = await response.json(); } catch(e) {} console.error(`Write failed: ${response.status} for fileId ${fileId}. Response:`, errorBody); throw new Error(`Write failed: ${response.status}`); } } else { console.log("Drive content updated successfully for fileId:", fileId); success = true; } } catch (error) { console.error(`Drive Error (updateFileContent for ${fileId}):`, error); showMessage("Erreur sauvegarde Drive.", 5000, true); updateDriveStatusUI('error', 'Err Synchro'); } finally { isSavingDriveData = false; if(!domElements.driveStatusElement?.classList.contains('error')) { updateDriveStatusUI(googleAccessToken ? 'success' : null, googleAccessToken ? 'Connecté' : null); } } return success; }

        // --- Timer Core Functions ---
        function formatTime(seconds) { const cleanSeconds = Math.max(0, Math.round(seconds)); const minutes = Math.floor(cleanSeconds / 60); const remainingSeconds = cleanSeconds % 60; return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`; }
        function calculateTotalEstimatedTime(plan) { let totalSeconds = 0; plan.forEach(item => { let estimatedDuration = 0; if (item.type === 'break') { estimatedDuration = item.duration || 0; } else if (item.type === 'exercise') { estimatedDuration = item.duration || (item.reps || 0) * SECONDS_PER_REP; } item.estimatedDuration = estimatedDuration; totalSeconds += estimatedDuration; }); return totalSeconds; }
        function updateTotalProgressCircle() { if (!domElements.totalProgressCircle || totalWorkoutEstimatedSeconds <= 0 || !isWorkoutActive) { if(domElements.totalProgressCircle) domElements.totalProgressCircle.style.backgroundImage = `conic-gradient(transparent 0%, transparent 100%)`; return; } let elapsedSeconds = 0; for (let i = 0; i < currentItemIndex; i++) { elapsedSeconds += currentWorkoutPlan[i]?.estimatedDuration || 0; } const currentItem = currentWorkoutPlan[currentItemIndex]; if (currentItem) { const itemEstimatedDuration = currentItem.estimatedDuration || (currentItem.type === 'break' ? totalTime : 0); if (currentState === 'break' && totalTime > 0 && itemEstimatedDuration > 0) { const elapsedInBreak = Math.min(totalTime - timeLeft, itemEstimatedDuration); elapsedSeconds += elapsedInBreak; } else if (currentState === 'paused' && currentItem.type === 'break' && totalTime > 0 && itemEstimatedDuration > 0) { const elapsedInBreak = Math.min(totalTime - timeLeft, itemEstimatedDuration); elapsedSeconds += elapsedInBreak; } } if (currentState === 'finished') { elapsedSeconds = totalWorkoutEstimatedSeconds; } const percentage = totalWorkoutEstimatedSeconds > 0 ? Math.min(100, (elapsedSeconds / totalWorkoutEstimatedSeconds) * 100) : 0; const gradient = `conic-gradient(var(--total-progress-color) ${percentage}%, transparent ${percentage}%)`; domElements.totalProgressCircle.style.backgroundImage = gradient; }
        function updateTimerDisplay() { if (!domElements.timeDisplayDiv || !domElements.timerStateDisplay) return; let timeString = "00:00"; let stateText = ''; const item = currentWorkoutPlan[currentItemIndex]; switch(currentState) { case 'exercise': timeString = "GO!"; stateText = item?.name || 'Exercice'; break; case 'break': timeString = formatTime(timeLeft); stateText = 'Repos'; break; case 'paused': timeString = (item?.type === 'break') ? formatTime(timeLeft) : "PAUSE"; stateText = 'En Pause'; break; case 'preparing': timeString = formatTime(prepareTimeLeft); stateText = 'Préparation'; break; case 'finished': timeString = "FINI!"; stateText = 'Terminé !'; break; default: timeString = formatTime(0); stateText = 'Prêt'; break; } domElements.timeDisplayDiv.textContent = timeString; domElements.timerStateDisplay.textContent = stateText; domElements.timerStateDisplay.classList.toggle('visible', currentState !== 'idle'); domElements.timerStateDisplay.classList.toggle('preparing', currentState === 'preparing'); updateTotalProgressCircle(); }
        function updateTimerAppearance(state) { if (!domElements.timeDisplayDiv || !domElements.timerStateDisplay) return; let stateColorVar = '--idle-color'; let textGlowBaseColor = 'rgba(var(--idle-color-rgb), 0.7)'; switch(state) { case 'exercise': stateColorVar = '--exercise-color'; textGlowBaseColor = `rgba(var(--exercise-color-rgb), 0.8)`; break; case 'break': stateColorVar = '--break-color'; textGlowBaseColor = `rgba(var(--break-color-rgb), 0.8)`; break; case 'paused': stateColorVar = '--paused-color'; textGlowBaseColor = `rgba(var(--paused-color-rgb), 0.8)`; break; case 'preparing': stateColorVar = '--preparing-color'; textGlowBaseColor = `rgba(var(--preparing-color-rgb), 0.8)`; break; case 'finished': stateColorVar = '--finished-color'; textGlowBaseColor = `rgba(var(--finished-color-rgb), 0.9)`; break; } const stateColor = getComputedStyle(document.documentElement).getPropertyValue(stateColorVar).trim(); const textGlowValue = `0 0 6px ${stateColor}`; const timeGlowValue = `0 0 10px ${textGlowBaseColor}`; domElements.timeDisplayDiv.style.textShadow = timeGlowValue; domElements.timerStateDisplay.style.color = stateColor; domElements.timerStateDisplay.style.textShadow = textGlowValue; }

        // --- Workout State Logic ---
        function findPreviousPerformance(exerciseName) { if (!workoutHistory || workoutHistory.length === 0) return null; for (let i = workoutHistory.length - 1; i >= 0; i--) { const entry = workoutHistory[i]; if (!entry.exercises) continue; const foundExercise = entry.exercises.find(ex => ex.name === exerciseName); if (foundExercise) { return { reps: foundExercise.actualReps ?? foundExercise.reps, weight: foundExercise.actualWeight ?? foundExercise.weight, date: new Date(entry.date) }; } } return null; }
        function updateWorkoutInfo() { if (!domElements.currentExerciseContainer || !domElements.currentExerciseNameDisplay || !domElements.progressTracker || !domElements.progressTextArea) return; const item = currentWorkoutPlan[currentItemIndex]; let infoHtml = ''; let exerciseName = ''; let progressText = ''; switch (currentState) { case 'idle': exerciseName = "ArmorWorkout"; const loginMsg = `<div class="workout-prompt"><i class="fas fa-sign-in-alt mr-2"></i><span>Connectez-vous.</span></div>`; const loadingMsg = `<div class="workout-prompt"><i class="fas fa-spinner fa-spin mr-2"></i><span>Chargement Drive...</span></div>`; const selectMsg = `<div class="workout-prompt"><i class="fas fa-hand-pointer mr-2"></i><span>Sélectionnez Push/Pull/Legs</span></div>`; const readyMsg = `<div class="workout-prompt"><i class="fas fa-play-circle mr-2"></i><span>Prêt: ${currentWorkoutType}. Cliquez pour démarrer.</span></div>`; if (!googleAccessToken) { progressText = "Connectez-vous"; infoHtml = loginMsg; } else if (!programsLoaded) { progressText = "Chargement..."; infoHtml = loadingMsg; } else if (!currentWorkoutType) { progressText = "Sélectionnez P/P/L"; infoHtml = selectMsg; } else { progressText = `Prêt: ${currentWorkoutType}`; infoHtml = readyMsg; } break; case 'finished': const durationSeconds = workoutStartTime ? (Date.now() - workoutStartTime) / 1000 : 0; exerciseName = 'Entraînement Terminé !'; infoHtml = `<div class="flex items-center justify-center text-green-400"><i class="fas ${getIconForState('finished')} mr-2 text-xl"></i><span class="font-semibold">Bravo ! ${durationSeconds > 0 ? `(${formatTime(durationSeconds)})` : ''}</span></div>`; progressText = `Fini (${originalCompletedWorkoutPlan.length}/${originalCompletedWorkoutPlan.length})`; break; case 'preparing': const nextItem = currentWorkoutPlan[0]; exerciseName = `Préparation...`; infoHtml = `<div class="flex items-center justify-center text-yellow-400"><i class="fas ${getIconForState('preparing')} fa-spin mr-2"></i><span>Prêt pour <strong>${nextItem?.name || '?'}</strong> (${formatTime(prepareTimeLeft)})...</span></div>`; progressText = `Prépa... (1/${currentWorkoutPlan.length})`; break; case 'exercise': case 'paused': case 'break': if (!item) { exerciseName = 'Erreur - Étape Invalide'; infoHtml = '<p class="text-red-500">Erreur: Impossible de charger l\'étape actuelle.</p>'; progressText = `Étape ?/${currentWorkoutPlan.length}`; break; } exerciseName = `${item.name || (item.type === 'break' ? 'Repos' : 'Exercice Inconnu')}`; progressText = `Étape ${currentItemIndex + 1}/${currentWorkoutPlan.length}`; if (item.type === 'exercise') { const reps = (item.actualReps !== undefined ? item.actualReps : item.reps) ?? '-'; const weight = (item.actualWeight !== undefined ? item.actualWeight : item.weight); const weightDisplay = (weight === null || weight === undefined || weight === 0) ? 'PDC' : `${weight}kg`; const details = item.details || ''; const prevPerf = findPreviousPerformance(item.name); const prevPerfHtml = prevPerf ? `<span class="details-info w-full"><i class="fas fa-history mr-1"></i> Préc: ${prevPerf.reps ?? '?'}r @ ${prevPerf.weight === 0 ? 'PDC' : (prevPerf.weight ?? '?') + 'kg'} (${prevPerf.date.toLocaleDateString('fr-FR',{day:'2-digit', month:'short'})})</span>` : ''; infoHtml = `<div class="exercise-info-static"><div class="flex justify-center gap-4 mb-2"><span class="reps-info"><i class="fas ${getIconForType('exercise')}"></i> ${reps} Répétitions</span><span class="weight-info"><i class="fas fa-weight-hanging"></i> ${weightDisplay}</span></div>${details ? `<span class="details-info w-full"><i class="fas fa-info-circle"></i> ${details}</span>` : ''}${prevPerfHtml}</div>`; } else if (item.type === 'break') { const nextExerciseIndex = currentItemIndex + 1; let nextExerciseInfoHtml = ''; if (nextExerciseIndex < currentWorkoutPlan.length && currentWorkoutPlan[nextExerciseIndex].type === 'exercise') { const nextEx = currentWorkoutPlan[nextExerciseIndex]; const nextReps = nextEx.reps ?? '-'; const nextWeight = nextEx.weight; const nextWeightDisplay = (nextWeight === null || nextWeight === undefined || nextWeight === 0) ? 'PDC' : `${nextWeight}kg`; nextExerciseInfoHtml = `<div class="next-exercise-info"><i class="fas fa-arrow-right"></i><span> Suivant: ${nextEx.name || '?'} (${nextReps}r @ ${nextWeightDisplay})</span></div>`; } infoHtml = `<div class="break-info-static"><div class="duration-info"><i class="fas ${getIconForType('break')}"></i><span> Pause : ${formatTime(item.duration || 0)}</span></div>${nextExerciseInfoHtml}</div>`; } break; default: exerciseName = 'État Inconnu'; infoHtml = '<p>?</p>'; progressText = ''; break; } if (domElements.currentExerciseNameDisplay) domElements.currentExerciseNameDisplay.textContent = exerciseName; if (domElements.currentExerciseContainer) domElements.currentExerciseContainer.innerHTML = infoHtml; if (domElements.progressTextArea) domElements.progressTextArea.textContent = progressText; }
        function getIconForState(state){ switch(state){ case 'exercise': return 'fa-dumbbell'; case 'break': return 'fa-hourglass-half'; case 'preparing': return 'fa-spinner'; case 'paused': return 'fa-pause-circle'; case 'finished': return 'fa-check-circle'; case 'idle': return 'fa-play-circle'; default: return 'fa-question-circle'; }}
        function getIconForType(type){ return type === 'exercise' ? 'fa-dumbbell' : 'fa-hourglass-half'; }
        function setState(newState) { if (!domElements.startPauseBtn) { console.error("setState: DOM elements not ready."); return; } const previousState = currentState; if (previousState === newState && newState !== 'idle') return; currentState = newState; console.log("New state:", newState); clearInterval(timerInterval); timerInterval = null; clearInterval(prepareCountdownInterval); prepareCountdownInterval = null; clearTimeout(halfwayTimeoutId); halfwayTimeoutId = null; const bodyClasses = document.body.classList; bodyClasses.forEach(cls => { if(cls.startsWith('state-')) bodyClasses.remove(cls); }); document.body.classList.add(`state-${newState}`); document.body.classList.toggle('workout-active', !['idle', 'finished'].includes(newState)); if(domElements.startPauseBtn) domElements.startPauseBtn.disabled = true; if(domElements.skipBtn) domElements.skipBtn.disabled = true; if(domElements.prevBtn) domElements.prevBtn.disabled = true; if(domElements.finishBtn) domElements.finishBtn.disabled = true; if(domElements.resetBtn) domElements.resetBtn.disabled = true; if(domElements.startPauseBtn) domElements.startPauseBtn.classList.remove('active'); const isTimerActive = ['preparing', 'exercise', 'break', 'paused'].includes(newState); domElements.navButtons?.forEach(btn => { if(btn) btn.disabled = !(googleAccessToken && programsLoaded && !isTimerActive); }); if(domElements.navHistoryBtn) domElements.navHistoryBtn.disabled = isTimerActive; if(domElements.navProgressBtn) domElements.navProgressBtn.disabled = !googleAccessToken || isTimerActive; hideRepAdjustmentOverlay(); switch (newState) { case 'idle': isTimerRunning = false; isWorkoutActive = false; workoutFinished = false; timeLeft = 0; totalTime = 0; const canStartIdle = googleAccessToken && programsLoaded && !!currentWorkoutType && currentWorkoutPlan && currentWorkoutPlan.length > 0; if(domElements.startPauseBtn) { domElements.startPauseBtn.disabled = !canStartIdle; domElements.startPauseBtn.innerHTML = `<i class="fas fa-play mr-2"></i> Démarrer`; } if(domElements.resetBtn) domElements.resetBtn.disabled = !(googleAccessToken && !!currentWorkoutType); if(domElements.prevBtn) domElements.prevBtn.disabled = true; if(domElements.skipBtn) domElements.skipBtn.disabled = true; if(domElements.finishBtn) domElements.finishBtn.disabled = true; break; case 'preparing': isWorkoutActive = true; workoutFinished = false; prepareTimeLeft = PREPARE_DURATION; if(domElements.startPauseBtn) { domElements.startPauseBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> Prép...`; domElements.startPauseBtn.disabled = true; } if(domElements.resetBtn) domElements.resetBtn.disabled = !googleAccessToken; if(domElements.prevBtn) domElements.prevBtn.disabled = true; if(domElements.skipBtn) domElements.skipBtn.disabled = true; if(domElements.finishBtn) domElements.finishBtn.disabled = true; startPrepareCountdown(); if (!workoutStartTime) workoutStartTime = Date.now(); break; case 'exercise': isWorkoutActive = true; workoutFinished = false; isTimerRunning = false; timeLeft = 0; totalTime = 0; if (googleAccessToken) { if(domElements.startPauseBtn) { domElements.startPauseBtn.disabled = false; domElements.startPauseBtn.innerHTML = `<i class="fas fa-check mr-2"></i> Fait`; } if(domElements.skipBtn) domElements.skipBtn.disabled = false; if(domElements.prevBtn) domElements.prevBtn.disabled = currentItemIndex <= 0; if(domElements.finishBtn) domElements.finishBtn.disabled = false; if(domElements.resetBtn) domElements.resetBtn.disabled = false; } findNextExerciseForAdjustment(); break; case 'break': isWorkoutActive = true; workoutFinished = false; isTimerRunning = true; if (googleAccessToken) { if(domElements.startPauseBtn) { domElements.startPauseBtn.disabled = false; domElements.startPauseBtn.innerHTML = `<i class="fas fa-pause mr-2"></i> Pause`; } if(domElements.skipBtn) domElements.skipBtn.disabled = false; if(domElements.prevBtn) domElements.prevBtn.disabled = currentItemIndex <= 0; if(domElements.finishBtn) domElements.finishBtn.disabled = false; if(domElements.resetBtn) domElements.resetBtn.disabled = false; } startBreakTimer(); findNextExerciseForAdjustment(); break; case 'paused': isWorkoutActive = true; workoutFinished = false; isTimerRunning = false; if (googleAccessToken) { if(domElements.startPauseBtn) { domElements.startPauseBtn.disabled = false; domElements.startPauseBtn.innerHTML = `<i class="fas fa-play mr-2"></i> Reprendre`; domElements.startPauseBtn.classList.add('active'); } if(domElements.skipBtn) domElements.skipBtn.disabled = false; if(domElements.prevBtn) domElements.prevBtn.disabled = currentItemIndex <= 0; if(domElements.finishBtn) domElements.finishBtn.disabled = false; if(domElements.resetBtn) domElements.resetBtn.disabled = false; } break; case 'finished': isWorkoutActive = false; isTimerRunning = false; workoutFinished = true; timeLeft = 0; totalTime = 0; elapsedWorkoutEstimatedSeconds = totalWorkoutEstimatedSeconds; if(domElements.startPauseBtn) { domElements.startPauseBtn.disabled = true; domElements.startPauseBtn.innerHTML = `<i class="fas fa-check-circle mr-2"></i> Terminé`; } if(domElements.skipBtn) domElements.skipBtn.disabled = true; if(domElements.prevBtn) domElements.prevBtn.disabled = true; if(domElements.finishBtn) domElements.finishBtn.disabled = true; if(domElements.resetBtn) domElements.resetBtn.disabled = !googleAccessToken; showMessage('Entraînement terminé ! 💪', 3000); vibrate([150, 50, 150]); playSound('et'); originalCompletedWorkoutPlan = JSON.parse(JSON.stringify(currentWorkoutPlan)); saveWorkoutToHistory(); clearInProgressState(); setTimeout(populateAndShowSummary, 500); break; default: console.warn("Unknown state reached:", newState, ". Resetting to idle."); currentState = 'idle'; break; } updateTimerDisplay(); updateWorkoutInfo(); updateTimerAppearance(newState); if (newState !== 'finished') { saveInProgressState(); } }
        function startPrepareCountdown() { if (prepareCountdownInterval) clearInterval(prepareCountdownInterval); prepareTimeLeft = PREPARE_DURATION; updateTimerDisplay(); updateWorkoutInfo(); updateTimerAppearance('preparing'); prepareCountdownInterval = setInterval(() => { prepareTimeLeft--; updateTimerDisplay(); updateWorkoutInfo(); updateTimerAppearance('preparing'); if (prepareTimeLeft <= 0) { clearInterval(prepareCountdownInterval); prepareCountdownInterval = null; playTransitionSound(); vibrate(); const firstItem = currentWorkoutPlan[0]; if (!firstItem) { console.error("Workout plan empty after prepare phase?"); resetCurrentWorkout(); return; } const nextState = firstItem.type === 'exercise' ? 'exercise' : 'break'; if (nextState === 'break') { totalTime = firstItem.duration || 0; timeLeft = totalTime; } else { timeLeft = 0; totalTime = 0; } setState(nextState); } else if (prepareTimeLeft <= 5 && prepareTimeLeft > 0) { playSound(`s${prepareTimeLeft}`); } }, 1000); }
        function startBreakTimer() { if (timerInterval) clearInterval(timerInterval); updateTimerDisplay(); updateTimerAppearance('break'); clearTimeout(halfwayTimeoutId); const halfwayPoint = Math.floor(totalTime / 2); if (totalTime >= 10 && timeLeft > halfwayPoint && halfwayPoint > 0) { const delay = (timeLeft - halfwayPoint) * 1000; halfwayTimeoutId = setTimeout(() => { if(currentState === 'break') playSound('windows'); }, delay); } timerInterval = setInterval(() => { if (timeLeft > 0) { timeLeft--; updateTimerDisplay(); updateTimerAppearance('break'); saveInProgressState(); if (timeLeft <= 5 && timeLeft > 0) { playSound(`s${timeLeft}`); } } else { clearInterval(timerInterval); timerInterval = null; clearTimeout(halfwayTimeoutId); halfwayTimeoutId = null; handleItemCompletion(true); } }, 1000); }
        function handleItemCompletion(naturalEnd = false) { clearTimeout(halfwayTimeoutId); if (!['exercise', 'break', 'paused'].includes(currentState)) return; playTransitionSound(); const completedItemIndex = currentItemIndex; const completedItem = currentWorkoutPlan[completedItemIndex]; if (completedItem?.estimatedDuration) { if (naturalEnd || completedItem.type === 'exercise') { elapsedWorkoutEstimatedSeconds += completedItem.estimatedDuration; } else if (completedItem.type === 'break' && totalTime > 0) { const elapsedInSkippedBreak = Math.min(totalTime - timeLeft, completedItem.estimatedDuration); elapsedWorkoutEstimatedSeconds += elapsedInSkippedBreak; } } if (completedItem?.type === 'exercise' && currentRepAdjustment !== 0) { const baseReps = completedItem.reps || 0; completedItem.actualReps = Math.max(0, baseReps + currentRepAdjustment); console.log(`Applied rep adjustment: ${completedItem.name} - ${completedItem.actualReps} reps (Base: ${baseReps}, Adjust: ${currentRepAdjustment})`); currentRepAdjustment = 0; } if (naturalEnd && currentState === 'break') vibrate(); currentItemIndex++; if (currentItemIndex >= currentWorkoutPlan.length) { setState('finished'); } else { const nextItem = currentWorkoutPlan[currentItemIndex]; if (!nextItem) { console.error("Invalid next item at index", currentItemIndex); setState('finished'); return; } const nextState = nextItem.type === 'exercise' ? 'exercise' : 'break'; if (nextState === 'break') { totalTime = nextItem.duration || 0; timeLeft = totalTime; } else { timeLeft = 0; totalTime = 0; } setState(nextState); } }
        function handlePreviousClick() { if (!isWorkoutActive || currentItemIndex <= 0) return; clearTimeout(halfwayTimeoutId); const previousItemIndex = currentItemIndex - 1; elapsedWorkoutEstimatedSeconds = 0; for (let i = 0; i < previousItemIndex; i++) { elapsedWorkoutEstimatedSeconds += currentWorkoutPlan[i]?.estimatedDuration || 0; } currentItemIndex = previousItemIndex; const previousItemReturningTo = currentWorkoutPlan[currentItemIndex]; const previousState = previousItemReturningTo.type === 'exercise' ? 'exercise' : 'break'; if (previousState === 'break') { totalTime = previousItemReturningTo.duration || 0; timeLeft = totalTime; } else { timeLeft = 0; totalTime = 0; } currentRepAdjustment = 0; setState(previousState); showMessage("Retour à l'étape précédente.", 1500); playTransitionSound(); vibrate([50, 50, 50]); }
        function forceFinishWorkout() { if (!isWorkoutActive || workoutFinished || currentState === 'preparing') return; if (confirm("Terminer l'entraînement maintenant ? La progression sera sauvegardée.")) { clearTimeout(halfwayTimeoutId); clearInterval(timerInterval); timerInterval = null; clearInterval(prepareCountdownInterval); prepareCountdownInterval = null; setState('finished'); showMessage("Entraînement terminé manuellement.", 2500); } }
        function loadWorkout(type) { if (!googleAccessToken) { showMessage("Connectez-vous pour charger un entraînement.", 3000, true); return; } if (!programsLoaded) { showMessage("Programmes Drive non chargés. Vérifiez la connexion ou attendez.", 3000, true); return; } if (!loadedWorkouts[type] || !Array.isArray(loadedWorkouts[type])) { showMessage(`Erreur: Programme "${type}" invalide ou manquant. Vérifiez le fichier sur Drive.`, 4000, true); console.error("Invalid or missing workout plan:", type, loadedWorkouts); currentWorkoutType = null; setActiveWorkoutNav(null); setState('idle'); return; } if (loadedWorkouts[type].length === 0) { showMessage(`Programme "${type}" est vide. Ajoutez des exercices via Google Drive.`, 4000, true); currentWorkoutType = type; setActiveWorkoutNav(type); currentWorkoutPlan = []; setState('idle'); return; } if (isWorkoutActive && currentWorkoutType !== type) { if (!confirm(`Un entraînement "${currentWorkoutType}" est en cours.\nArrêter et charger "${type}" ? La progression sera perdue.`)) { setActiveWorkoutNav(currentWorkoutType); return; } resetCurrentWorkout(false); } else if (currentState === 'finished' && currentWorkoutType !== type) { resetCurrentWorkout(false); } else if (currentWorkoutType === type && (isWorkoutActive || currentState === 'idle' || currentState === 'finished')) { if(currentState === 'idle' || currentState === 'finished') { resetCurrentWorkout(false); } else { if (confirm(`"${type}" est déjà en cours. Voulez-vous le réinitialiser ?`)) { resetCurrentWorkout(false); } else { showSection('workout-section'); setActiveWorkoutNav(type); return; } } } console.log("Loading workout:", type); currentWorkoutType = type; currentWorkoutPlan = JSON.parse(JSON.stringify(loadedWorkouts[type])); totalWorkoutEstimatedSeconds = calculateTotalEstimatedTime(currentWorkoutPlan); elapsedWorkoutEstimatedSeconds = 0; currentItemIndex = 0; workoutStartTime = null; isTimerRunning = false; isWorkoutActive = false; workoutFinished = false; currentRepAdjustment = 0; setActiveWorkoutNav(type); showSection('workout-section'); closeSummary(false); setState('idle'); showMessage(`Entraînement "${type}" chargé. Prêt à démarrer.`, 2500); }
        function resetCurrentWorkout(showMessageOnReset = true) { clearTimeout(halfwayTimeoutId); halfwayTimeoutId = null; clearInterval(timerInterval); timerInterval = null; clearInterval(prepareCountdownInterval); prepareCountdownInterval = null; const typeReset = currentWorkoutType; currentWorkoutType = null; currentWorkoutPlan = []; originalCompletedWorkoutPlan = []; currentItemIndex = 0; workoutStartTime = null; isTimerRunning = false; isWorkoutActive = false; workoutFinished = false; timeLeft = 0; totalTime = 0; prepareTimeLeft = 0; totalWorkoutEstimatedSeconds = 0; elapsedWorkoutEstimatedSeconds = 0; currentRepAdjustment = 0; clearInProgressState(); closeSummary(false); setActiveWorkoutNav(null); showSection('workout-section'); setState('idle'); if (typeReset && showMessageOnReset) { showMessage(`Entraînement "${typeReset}" réinitialisé.`, 2000); } console.log("Workout reset."); }
        function showMessage(msg, duration = 3000, isError = false) { if (!domElements.messageArea) return; domElements.messageArea.textContent = msg; domElements.messageArea.classList.toggle('error-message', isError); domElements.messageArea.classList.add('visible'); if (messageTimeoutId) clearTimeout(messageTimeoutId); messageTimeoutId = setTimeout(() => { domElements.messageArea.classList.remove('visible'); setTimeout(() => domElements.messageArea.classList.remove('error-message'), 500); }, duration); }

        // --- UI Section Management ---
        function showSection(sectionId) { const sections = { 'workout-section': domElements.workoutSection, 'history-section': domElements.historySection, 'progress-section': domElements.progressSection }; Object.values(sections).forEach(section => section?.classList.add('section-hidden')); document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active')); const sectionToShow = sections[sectionId]; if (sectionToShow) { sectionToShow.classList.remove('section-hidden'); } const navLinks = { 'workout-section': domElements.navButtons, 'history-section': [domElements.navHistoryBtn], 'progress-section': [domElements.navProgressBtn] }; const linksToActivate = navLinks[sectionId]; if (linksToActivate) { if (sectionId === 'workout-section') { const workoutBtn = domElements.navButtons?.find(btn => btn && btn.dataset.workout === currentWorkoutType); if (workoutBtn) workoutBtn.classList.add('active'); } else { linksToActivate.forEach(btn => btn?.classList.add('active')); } } }
        function setActiveWorkoutNav(type) { domElements.navButtons?.forEach(btn => { const isActive = btn && btn.dataset.workout === type; if(btn) btn.classList.toggle('active', isActive); }); }

        // --- History & Stats Functions ---
        function displayHistory(period = 'week') { if (!domElements.historyList || !domElements.statsDisplay || !domElements.historyChartCanvasEl || !domElements.statsContentWrapper) return; if (!googleAccessToken) { domElements.historyList.innerHTML = '<li class="no-history">Connectez-vous pour voir l\'historique.</li>'; domElements.statsContentWrapper.innerHTML = '<p><i class="fas fa-sign-in-alt"></i> Connectez-vous.</p>'; if(domElements.statsDisplay.querySelector('.motivational-message')) domElements.statsDisplay.querySelector('.motivational-message').textContent = ''; clearCharts(); setChartPlaceholder('history-chart-canvas', "Connectez-vous."); return; } currentHistoryPeriod = period; domElements.historyFilterBtns?.forEach(btn => btn.classList.toggle('active', btn.dataset.period === period)); const filteredHistory = filterHistoryByPeriod(workoutHistory, period); renderHistoryList(filteredHistory); calculateAndDisplayStats(filteredHistory); renderHistoryChart(filteredHistory); }
        function filterHistoryByPeriod(history, period) { const now = new Date(); let startDate = new Date(); startDate.setHours(0, 0, 0, 0); switch (period) { case 'week': const dayOfWeek = now.getDay(); const diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); startDate.setDate(diff); break; case 'month': startDate = new Date(now.getFullYear(), now.getMonth(), 1); break; case 'year': startDate = new Date(now.getFullYear(), 0, 1); break; case 'all': return history; default: console.warn("Invalid history period:", period, "Defaulting to 'week'"); const dayOfWeekDef = now.getDay(); const diffDef = now.getDate() - dayOfWeekDef + (dayOfWeekDef === 0 ? -6 : 1); startDate.setDate(diffDef); break; } return history.filter(entry => new Date(entry.date) >= startDate); }
        function renderHistoryList(filteredHistory) { if (!domElements.historyList) return; if (filteredHistory.length === 0) { domElements.historyList.innerHTML = '<li class="no-history">Aucun entraînement enregistré pour cette période.</li>'; return; } domElements.historyList.innerHTML = filteredHistory .sort((a, b) => new Date(b.date) - new Date(a.date)) .map(entry => { const date = new Date(entry.date); const formattedDate = date.toLocaleDateString('fr-FR', { weekday: 'short', day: '2-digit', month: 'short' }); const formattedTime = date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }); const durationSeconds = entry.durationSeconds || 0; const formattedDuration = durationSeconds > 0 ? formatTime(durationSeconds) : 'N/A'; const type = entry.type || 'Inconnu'; const totalReps = entry.totalReps ?? '?'; return `<li><span class="history-item-date">${formattedDate} <small>(${formattedTime})</small></span><span class="history-item-type">${type}</span><span class="history-item-reps"><i class="fas fa-hashtag"></i> ${totalReps}</span><span class="history-item-duration">${formattedDuration}</span></li>`; }).join(''); }
        function calculateAndDisplayStats(filteredHistory) { if (!domElements.statsContentWrapper || !domElements.statsDisplay) return; const numWorkouts = filteredHistory.length; let totalDuration = 0; let workoutTypes = {}; let totalRepsSum = 0; filteredHistory.forEach(entry => { totalDuration += entry.durationSeconds || 0; const type = entry.type || 'Inconnu'; workoutTypes[type] = (workoutTypes[type] || 0) + 1; totalRepsSum += entry.totalReps || 0; }); const avgDuration = numWorkouts > 0 ? totalDuration / numWorkouts : 0; const avgReps = numWorkouts > 0 ? Math.round(totalRepsSum / numWorkouts) : 0; const formattedAvgDuration = formatTime(avgDuration); let periodLabel = ''; switch (currentHistoryPeriod) { case 'week': periodLabel = 'Cette Semaine'; break; case 'month': periodLabel = 'Ce Mois'; break; case 'year': periodLabel = 'Cette Année'; break; case 'all': periodLabel = 'Total'; break; default: periodLabel = currentHistoryPeriod; } let statsHtml = `<p><i class="fas fa-calendar-check"></i> Séances (${periodLabel}): <strong>${numWorkouts}</strong></p>`; if (numWorkouts > 0) { statsHtml += `<p><i class="fas fa-stopwatch"></i> Durée totale: <strong>${formatTime(totalDuration)}</strong></p>`; statsHtml += `<p><i class="fas fa-clock"></i> Durée moyenne: <strong>${formattedAvgDuration}</strong></p>`; statsHtml += `<p><i class="fas fa-hashtag"></i> Reps totales: <strong>${totalRepsSum}</strong> (Moy: ${avgReps})</p>`; const typesArray = Object.entries(workoutTypes).sort(([,a],[,b]) => b-a); if(typesArray.length > 0) { statsHtml += `<p><i class="fas fa-tags"></i> Répartition: ${typesArray.map(([type, count]) => `${type} (${count})`).join(', ')}</p>`; } } else { statsHtml += '<p>Aucune donnée pour calculer les statistiques.</p>'; } domElements.statsContentWrapper.innerHTML = statsHtml; const motivationalMessage = domElements.statsDisplay.querySelector('.motivational-message'); if (motivationalMessage) { if (numWorkouts > 5) motivationalMessage.textContent = "Super régularité ! Continuez comme ça ! 💪"; else if (numWorkouts > 1) motivationalMessage.textContent = "Chaque séance compte. Bravo !"; else if (numWorkouts === 1) motivationalMessage.textContent = "Première séance enregistrée ! Continuez !"; else motivationalMessage.textContent = "Prêt à enregistrer votre prochaine séance ?"; } }
        function aggregateChartData(hist, period, metric = 'durationSeconds') { const agg = new Map(); let labels = []; const today = new Date(); today.setHours(0,0,0,0); const getWeekNumber = (d) => { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7)); const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1)); const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7); return weekNo; }; switch (period) { case 'week': const daysOfWeek = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim']; const startOfWeek = new Date(today); startOfWeek.setDate(today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1)); const endOfWeek = new Date(startOfWeek); endOfWeek.setDate(startOfWeek.getDate() + 6); labels = daysOfWeek; labels.forEach(l => agg.set(l, 0)); hist.forEach(e => { const d = new Date(e.date); if (d >= startOfWeek && d <= endOfWeek) { let dayIndex = d.getDay(); dayIndex = dayIndex === 0 ? 6 : dayIndex - 1; const value = metric === 'durationSeconds' ? (e.durationSeconds || 0) : (e.totalReps || 0); agg.set(labels[dayIndex], (agg.get(labels[dayIndex]) || 0) + value); } }); break; case 'month': const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1); const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0); const weeksInMonth = new Map(); let minWeek = 53, maxWeek = 0; hist.forEach(e => { const d = new Date(e.date); if (d >= startOfMonth && d <= endOfMonth) { const weekNum = getWeekNumber(d); minWeek = Math.min(minWeek, weekNum); maxWeek = Math.max(maxWeek, weekNum); const value = metric === 'durationSeconds' ? (e.durationSeconds || 0) : (e.totalReps || 0); weeksInMonth.set(weekNum, (weeksInMonth.get(weekNum) || 0) + value); } }); if (weeksInMonth.size > 0) { labels = Array.from({ length: maxWeek - minWeek + 1 }, (_, i) => `S${minWeek + i}`); labels.forEach(l => { const weekNum = parseInt(l.substring(1)); agg.set(l, weeksInMonth.get(weekNum) || 0); }); } else { labels = []; } break; case 'year': labels = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Aoû', 'Sep', 'Oct', 'Nov', 'Déc']; labels.forEach(l => agg.set(l, 0)); const currentYear = today.getFullYear(); hist.forEach(e => { const d = new Date(e.date); if (d.getFullYear() === currentYear) { const monthIndex = d.getMonth(); const value = metric === 'durationSeconds' ? (e.durationSeconds || 0) : (e.totalReps || 0); agg.set(labels[monthIndex], (agg.get(labels[monthIndex]) || 0) + value); } }); break; default: const yearData = {}; hist.forEach(e => { const y = new Date(e.date).getFullYear(); if (!isNaN(y)) { const value = metric === 'durationSeconds' ? (e.durationSeconds || 0) : (e.totalReps || 0); yearData[y] = (yearData[y] || 0) + value; } }); labels = Object.keys(yearData).map(Number).sort((a, b) => a - b).map(String); labels.forEach(y => agg.set(y, yearData[y])); break; } return { labels, data: labels.map(l => agg.get(l) || 0) }; }
        function getChartXAxisTitle(period){ switch(period){ case 'week': return 'Jour de la semaine'; case 'month': return 'Semaine du mois (Numéro ISO)'; case 'year': return 'Mois'; default: return 'Année'; }}
        function renderHistoryChart(filteredHistory) { if (!domElements.historyChartCanvasEl) return; const ctx = domElements.historyChartCanvasEl.getContext('2d'); if (!ctx) return; const { labels, data } = aggregateChartData(filteredHistory, currentHistoryPeriod, 'durationSeconds'); if (labels.length === 0 || data.every(d => d === 0)) { setChartPlaceholder('history-chart-canvas', "Aucune donnée d'historique pour cette période."); if (historyChartInstance) { historyChartInstance.destroy(); historyChartInstance = null; } return; } else { setChartPlaceholder('history-chart-canvas', "", false); } const styles = getComputedStyle(document.documentElement); const primColor = styles.getPropertyValue('--info-color').trim(); const primColorRgb = '96, 165, 250'; const gridColor = styles.getPropertyValue('--border-color').trim(); const textColor = styles.getPropertyValue('--secondary-text').trim(); const tooltipBg = `rgba(17, 24, 39, 0.8)`; const tooltipText = styles.getPropertyValue('--primary-text').trim(); const chartData = { labels, datasets: [{ label: 'Durée (min)', data: data.map(d => Math.round(d / 60)), backgroundColor: `rgba(${primColorRgb}, 0.6)`, borderColor: primColor, borderWidth: 1, borderRadius: 3, hoverBackgroundColor: `rgba(${primColorRgb}, 0.8)`, hoverBorderColor: primColor }] }; const chartOptions = { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: 'Minutes', color: textColor }, ticks: { color: textColor, callback: v => v + 'm' }, grid: { color: gridColor } }, x: { title: { display: true, text: getChartXAxisTitle(currentHistoryPeriod), color: textColor }, ticks: { color: textColor }, grid: { display: false } } }, plugins: { legend: { display: false }, tooltip: { backgroundColor: tooltipBg, titleColor: tooltipText, bodyColor: tooltipText, padding: 10, cornerRadius: 4, displayColors: false, callbacks: { label: context => `Durée: ${formatTime(data[context.dataIndex] || 0)}` } } } }; try { if (historyChartInstance) { historyChartInstance.data = chartData; historyChartInstance.options = chartOptions; historyChartInstance.update(); } else { historyChartInstance = new Chart(ctx, { type: 'bar', data: chartData, options: chartOptions }); } } catch (e) { console.error("Error creating/updating history chart:", e); setChartPlaceholder('history-chart-canvas', "Erreur affichage graphique."); } }
        function updateChartColors() { const styles = getComputedStyle(document.documentElement); const textColor = styles.getPropertyValue('--secondary-text').trim(); const gridColor = styles.getPropertyValue('--border-color').trim(); const tooltipBg = `rgba(17, 24, 39, 0.8)`; const tooltipText = styles.getPropertyValue('--primary-text').trim(); const infoColor = styles.getPropertyValue('--info-color').trim(); const infoColorRgb = '96, 165, 250'; const actionColor = styles.getPropertyValue('--action-color').trim(); const actionColorRgb = '167, 139, 250'; const exerciseColor = styles.getPropertyValue('--exercise-color').trim(); const exerciseColorRgb = '244, 114, 182'; [historyChartInstance, exercisePerfChartInstance].forEach(chartInstance => { if (chartInstance) { try { chartInstance.options.scales.x.ticks.color = textColor; chartInstance.options.scales.x.grid.color = gridColor; if (chartInstance.options.scales.x.title) chartInstance.options.scales.x.title.color = textColor; chartInstance.options.scales.y.ticks.color = textColor; chartInstance.options.scales.y.grid.color = gridColor; if (chartInstance.options.scales.y.title) chartInstance.options.scales.y.title.color = textColor; if (chartInstance.options.scales.yMetric) { chartInstance.options.scales.yMetric.ticks.color = textColor; chartInstance.options.scales.yMetric.grid.color = gridColor; if (chartInstance.options.scales.yMetric.title) chartInstance.options.scales.yMetric.title.color = textColor; } chartInstance.options.plugins.tooltip.backgroundColor = tooltipBg; chartInstance.options.plugins.tooltip.titleColor = tooltipText; chartInstance.options.plugins.tooltip.bodyColor = tooltipText; chartInstance.data.datasets.forEach((dataset) => { let mainColor = infoColor; let mainColorRgb = infoColorRgb; if (chartInstance === exercisePerfChartInstance) { if (dataset.label === 'Total Répétitions par Séance') { mainColor = actionColor; mainColorRgb = actionColorRgb; } else if (dataset.yAxisID === 'yWeight') { mainColor = exerciseColor; mainColorRgb = exerciseColorRgb; } } dataset.borderColor = mainColor; dataset.backgroundColor = `rgba(${mainColorRgb}, ${chartInstance.config.type === 'bar' || dataset.fill ? 0.6 : 0.2})`; if (dataset.pointBackgroundColor) dataset.pointBackgroundColor = mainColor; if (dataset.pointBorderColor) dataset.pointBorderColor = mainColor; if (dataset.hoverBackgroundColor) dataset.hoverBackgroundColor = `rgba(${mainColorRgb}, 0.8)`; if (dataset.hoverBorderColor) dataset.hoverBorderColor = mainColor; }); chartInstance.update('none'); } catch (e) { console.warn("Error updating chart colors:", e); } } }); }
        function clearCharts() { [historyChartInstance, exercisePerfChartInstance].forEach(chart => { if (chart) { try { chart.destroy(); } catch(e){} } }); historyChartInstance = null; exercisePerfChartInstance = null; setChartPlaceholder('history-chart-canvas', ''); setChartPlaceholder('exercise-progress-chart', ''); console.log("Charts cleared."); }
        function setChartPlaceholder(canvasId, message, show = true) { const placeholderId = canvasId.replace('-canvas', '-placeholder'); const placeholder = document.getElementById(placeholderId); const canvasEl = document.getElementById(canvasId); if (placeholder && canvasEl) { placeholder.textContent = message; placeholder.style.display = show ? 'block' : 'none'; canvasEl.style.opacity = show ? '0.3' : '1'; canvasEl.style.display = show ? 'none' : 'block'; } }

        // --- Progress Section Functions ---
        function populateExerciseSelect() { if (!domElements.exerciseSelect || !workoutHistory) return; const uniqueExercises = new Set(); workoutHistory.forEach(entry => { entry.exercises?.forEach(ex => { if (ex.type === 'exercise' && ex.name) { uniqueExercises.add(ex.name); } }); }); const sortedExercises = Array.from(uniqueExercises).sort((a, b) => a.localeCompare(b)); const currentVal = domElements.exerciseSelect.value; domElements.exerciseSelect.innerHTML = '<option value="all">Tous (Total Reps)</option>'; sortedExercises.forEach(exName => { const option = document.createElement('option'); option.value = exName; option.textContent = exName; domElements.exerciseSelect.appendChild(option); }); if (sortedExercises.includes(currentVal)) { domElements.exerciseSelect.value = currentVal; } else { domElements.exerciseSelect.value = 'all'; } console.log("Exercise select populated."); }
        function displayExerciseProgress() { if (!domElements.exerciseProgressChartCanvasEl) return; const ctx = domElements.exerciseProgressChartCanvasEl.getContext('2d'); if (!ctx) return; if (!googleAccessToken) { setChartPlaceholder('exercise-progress-chart', "Connectez-vous pour voir la progression."); if (exercisePerfChartInstance) { exercisePerfChartInstance.destroy(); exercisePerfChartInstance = null; } return; } const selectedExercise = domElements.exerciseSelect.value; const selectedPeriod = domElements.periodSelect.value; if(domElements.progressChartTitle) domElements.progressChartTitle.textContent = `Progression ${selectedExercise === 'all' ? '(Total Répétitions)' : `(${selectedExercise})`}`; const filteredHistory = filterHistoryByPeriod(workoutHistory, selectedPeriod); let chartData; let chartOptions; let chartType = 'line'; if (selectedExercise === 'all') { const { labels, data } = aggregateChartData(filteredHistory, selectedPeriod, 'totalReps'); if (labels.length === 0 || data.every(d => d === 0)) { setChartPlaceholder('exercise-progress-chart', "Aucune donnée pour cette sélection."); if (exercisePerfChartInstance) { exercisePerfChartInstance.destroy(); exercisePerfChartInstance = null; } return; } else { setChartPlaceholder('exercise-progress-chart', "", false); } const styles = getComputedStyle(document.documentElement); const primColor = styles.getPropertyValue('--action-color').trim(); const primColorRgb = '167, 139, 250'; const gridColor = styles.getPropertyValue('--border-color').trim(); const textColor = styles.getPropertyValue('--secondary-text').trim(); const tooltipBg = `rgba(17, 24, 39, 0.8)`; const tooltipText = styles.getPropertyValue('--primary-text').trim(); chartData = { labels, datasets: [{ label: 'Total Répétitions par Séance', data: data, borderColor: primColor, backgroundColor: `rgba(${primColorRgb}, 0.5)`, tension: 0.1, fill: true, pointRadius: 2, pointBackgroundColor: primColor }] }; chartOptions = { responsive: true, maintainAspectRatio: false, scales: { x: { ticks: { color: textColor }, grid: { display: false }, title: { display: true, text: getChartXAxisTitle(selectedPeriod), color: textColor } }, y: { beginAtZero: true, title: { display: true, text: 'Total Répétitions', color: textColor }, ticks: { color: textColor }, grid: { color: gridColor } } }, plugins: { legend: { display: false }, tooltip: { backgroundColor: tooltipBg, titleColor: tooltipText, bodyColor: tooltipText, padding: 10, cornerRadius: 4, displayColors: false, callbacks: { title: (tooltipItems) => tooltipItems[0]?.label || '', label: (context) => `Total Reps: ${context.parsed.y}` } } } }; chartType = 'line'; } else { const exerciseData = []; filteredHistory.forEach(entry => { entry.exercises?.forEach(ex => { if (ex.name === selectedExercise) { const reps = ex.actualReps ?? ex.reps; if (reps !== undefined && reps !== null) { exerciseData.push({ date: new Date(entry.date), reps: reps }); } } }); }); exerciseData.sort((a, b) => a.date - b.date); if (exerciseData.length === 0) { setChartPlaceholder('exercise-progress-chart', `Aucune donnée pour "${selectedExercise}" sur cette période.`); if (exercisePerfChartInstance) { exercisePerfChartInstance.destroy(); exercisePerfChartInstance = null; } return; } else { setChartPlaceholder('exercise-progress-chart', "", false); } const labels = exerciseData.map(d => d.date.toISOString()); const styles = getComputedStyle(document.documentElement); const primColor = styles.getPropertyValue('--info-color').trim(); const primColorRgb = '96, 165, 250'; const gridColor = styles.getPropertyValue('--border-color').trim(); const textColor = styles.getPropertyValue('--secondary-text').trim(); const tooltipBg = `rgba(17, 24, 39, 0.8)`; const tooltipText = styles.getPropertyValue('--primary-text').trim(); chartData = { labels, datasets: [{ label: 'Répétitions', data: exerciseData.map(d => ({ x: d.date.toISOString(), y: d.reps })), borderColor: primColor, backgroundColor: `rgba(${primColorRgb}, 0.2)`, tension: 0.3, fill: false, pointRadius: 3, pointBackgroundColor: primColor, pointBorderColor: primColor, pointHoverRadius: 5, yAxisID: 'yMetric' }] }; chartOptions = { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, scales: { x: { type: 'time', time: { unit: 'day', tooltipFormat: 'dd MMM yyyy', displayFormats: { day: 'dd/MM' } }, adapters: { date: { locale: fr } }, ticks: { color: textColor, source: 'auto' }, grid: { display: false }, title: { display: true, text: 'Date', color: textColor } }, yMetric: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Répétitions', color: textColor }, ticks: { color: textColor }, grid: { color: gridColor }, beginAtZero: true } }, plugins: { legend: { display: false }, tooltip: { backgroundColor: tooltipBg, titleColor: tooltipText, bodyColor: tooltipText, padding: 10, cornerRadius: 4, displayColors: false, callbacks: { title: (tooltipItems) => tooltipItems[0] ? new Date(tooltipItems[0].parsed.x).toLocaleDateString('fr-FR', {day:'2-digit', month:'short', year:'numeric'}) : '', label: (context) => `${context.dataset.label}: ${context.parsed.y}` } } } }; chartType = 'line'; } try { if (exercisePerfChartInstance) { if (exercisePerfChartInstance.config.type !== chartType || exercisePerfChartInstance.options.scales.x.type !== chartOptions.scales.x.type) { exercisePerfChartInstance.destroy(); exercisePerfChartInstance = new Chart(ctx, { type: chartType, data: chartData, options: chartOptions }); } else { exercisePerfChartInstance.data = chartData; exercisePerfChartInstance.options = chartOptions; exercisePerfChartInstance.update(); } } else { exercisePerfChartInstance = new Chart(ctx, { type: chartType, data: chartData, options: chartOptions }); } } catch (e) { console.error("Error creating/updating progress chart:", e); setChartPlaceholder('exercise-progress-chart', "Erreur affichage graphique."); } }

        // --- Summary & Rep Adjustment Functions ---
        function populateAndShowSummary() { if (!domElements.postWorkoutSummary || !domElements.summaryItemsList || !domElements.finishSummaryBtn) return; const planToSummarize = originalCompletedWorkoutPlan; if (!planToSummarize || planToSummarize.length === 0) { console.warn("Attempting to show summary without a completed plan."); return; } if(domElements.summaryTitle) domElements.summaryTitle.textContent = `Résumé & Objectifs (${currentWorkoutType || '?'})`; if(domElements.summaryItemsList) { domElements.summaryItemsList.innerHTML = ''; planToSummarize.forEach((item, index) => { if (item.type === 'exercise') { const li = document.createElement('li'); li.classList.add('summary-item'); li.dataset.originalIndex = index; const performedReps = item.actualReps ?? item.reps ?? '?'; const nextTargetReps = item.reps ?? 0; let contentHtml = `<div class="exercise-name"><i class="fas ${getIconForType(item.type)}" style="color:var(--exercise-color)"></i> ${item.name || 'Exercice'} <small>(${performedReps} fait)</small></div><div class="input-container"><label for="next-reps-${index}">Objectif:</label><input type="number" id="next-reps-${index}" value="${nextTargetReps}" min="0" step="1" placeholder="Reps"></div>`; li.innerHTML = contentHtml; domElements.summaryItemsList.appendChild(li); } }); } if(domElements.finishSummaryBtn) domElements.finishSummaryBtn.disabled = false; if(domElements.postWorkoutSummary) domElements.postWorkoutSummary.classList.add('visible'); }
        async function finishSummary() { if (!googleAccessToken || !currentWorkoutType || !programFileIds[currentWorkoutType]) { showMessage("Erreur sauvegarde objectifs: Connexion ou programme manquant.", 4000, true); closeSummary(false); resetCurrentWorkout(); return; } if (isSavingDriveData) { showMessage("Sauvegarde Drive déjà en cours...", 2000); return; } let changesMade = false; const programToUpdate = loadedWorkouts[currentWorkoutType]; if (!programToUpdate) { showMessage(`Erreur: Programme local "${currentWorkoutType}" non trouvé.`, 4000, true); closeSummary(false); resetCurrentWorkout(); return; } domElements.summaryItemsList.querySelectorAll('.summary-item[data-original-index]').forEach(li => { const index = parseInt(li.dataset.originalIndex, 10); const input = li.querySelector(`#next-reps-${index}`); if (programToUpdate[index] && programToUpdate[index].type === 'exercise' && input) { const nextRepsRaw = input.value.trim(); const nextReps = nextRepsRaw === '' ? (programToUpdate[index].reps ?? null) : parseInt(nextRepsRaw, 10); if (nextReps !== null && !isNaN(nextReps) && nextReps >= 0) { if (programToUpdate[index].reps !== nextReps) { programToUpdate[index].reps = nextReps; changesMade = true; console.log(`Objectif màj pour ${programToUpdate[index].name}: ${nextReps} reps`); } } else if (nextRepsRaw !== '') { console.warn(`Valeur invalide pour reps de ${programToUpdate[index].name}: ${nextRepsRaw}. Objectif non modifié.`); } } }); if (changesMade) { if(domElements.finishSummaryBtn) { domElements.finishSummaryBtn.disabled = true; domElements.finishSummaryBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Sauvegarde...`; } console.log(`Sauvegarde des objectifs pour "${currentWorkoutType}" sur Drive...`); const success = await updateFileContent(programFileIds[currentWorkoutType], programToUpdate); if (success) showMessage(`Objectifs "${currentWorkoutType}" mis à jour sur Drive !`, 2500); else showMessage(`Échec sauvegarde objectifs sur Drive.`, 5000, true); resetCurrentWorkout(false); } else { showMessage("Aucun objectif modifié.", 2000); resetCurrentWorkout(false); } }
        function closeSummary(updateUI = true) { if(domElements.postWorkoutSummary) domElements.postWorkoutSummary.classList.remove('visible'); if (updateUI && currentState === 'finished') { resetCurrentWorkout(false); } }
        function showRepAdjustmentOverlay() { if (!isWorkoutActive || !['exercise', 'break', 'paused'].includes(currentState)) return; const itemForAdjustment = currentWorkoutPlan[nextExerciseIndexForAdjustment]; if (!itemForAdjustment || itemForAdjustment.type !== 'exercise' || !domElements.repAdjustmentOverlay) { hideRepAdjustmentOverlay(); return; } if(domElements.repAdjustmentExerciseName) domElements.repAdjustmentExerciseName.textContent = itemForAdjustment.name; const baseReps = itemForAdjustment.reps || 0; if(domElements.currentRepsDisplay) domElements.currentRepsDisplay.textContent = Math.max(0, baseReps + currentRepAdjustment); if (!isRepAdjustmentVisible) { domElements.repAdjustmentOverlay.classList.add('visible'); isRepAdjustmentVisible = true; } }
        function hideRepAdjustmentOverlay() { if (isRepAdjustmentVisible && domElements.repAdjustmentOverlay) { domElements.repAdjustmentOverlay.classList.remove('visible'); isRepAdjustmentVisible = false; } }
        function handleRepAdjustClick(event) { if (!domElements.repAdjustMinusBtn || !domElements.repAdjustPlusBtn) return; initAudioContext(); playSound('windows'); const adjustment = event.target.id === 'rep-adjust-plus' ? 1 : -1; const itemForAdjustment = currentWorkoutPlan[nextExerciseIndexForAdjustment]; if (itemForAdjustment && domElements.currentRepsDisplay) { const baseReps = itemForAdjustment.reps || 0; currentRepAdjustment += adjustment; const displayReps = Math.max(0, baseReps + currentRepAdjustment); domElements.currentRepsDisplay.textContent = displayReps; saveInProgressState(); } }
        function findNextExerciseForAdjustment() { nextExerciseIndexForAdjustment = -1; if (!currentWorkoutPlan) return; for (let i = currentItemIndex + 1; i < currentWorkoutPlan.length; i++) { if (currentWorkoutPlan[i].type === 'exercise') { nextExerciseIndexForAdjustment = i; return; } } }

        // --- Persistence Functions ---
        async function saveHistoryToDrive() { if (!googleAccessToken || isSavingDriveData) return; if (!historyFileId) { console.log("ID fichier historique inconnu, tentative de recherche/création..."); historyFileId = await findOrCreateFile(HISTORY_FILENAME, JSON.stringify([])); } if (historyFileId) { console.log("Sauvegarde de l'historique sur Drive..."); await updateFileContent(historyFileId, workoutHistory); } else { console.error("Impossible de trouver ou créer le fichier d'historique sur Drive."); showMessage("Erreur sauvegarde historique.", 5000, true); } }
        async function loadHistoryFromDrive() { if (!googleAccessToken) return; console.log("Chargement de l'historique depuis Drive..."); historyFileId = await findOrCreateFile(HISTORY_FILENAME, JSON.stringify([])); if (historyFileId) { const content = await readFileContent(historyFileId); if (content !== null) { try { workoutHistory = JSON.parse(content || "[]"); console.log(`Historique chargé: ${workoutHistory.length} entrées.`); } catch (e) { console.error("Erreur parsing historique JSON:", e, "Contenu:", content); workoutHistory = []; showMessage("Erreur lecture historique (format invalide).", 5000, true); } } else { workoutHistory = []; console.warn("Impossible de lire le contenu du fichier historique."); showMessage("Erreur lecture historique.", 5000, true); } } else { workoutHistory = []; console.error("Impossible de trouver ou créer le fichier historique sur Drive."); showMessage("Erreur accès fichier historique.", 5000, true); } displayHistory(currentHistoryPeriod); }
        async function saveProgramsToDrive() { if (!googleAccessToken || isSavingDriveData) return; console.log("Sauvegarde des programmes sur Drive (si modifiés)..."); let allSaved = true; for (const type of PROGRAM_TYPES) { if (!programFileIds[type]) { const defaultProgContent = defaultWorkouts[type] ? JSON.stringify(defaultWorkouts[type], null, 2) : '[]'; programFileIds[type] = await findOrCreateFile(PROGRAM_FILENAMES[type], defaultProgContent); } if (programFileIds[type] && loadedWorkouts[type]) { const success = await updateFileContent(programFileIds[type], loadedWorkouts[type]); if (!success) allSaved = false; } else { console.warn(`Programme ${type} non trouvé localement ou ID Drive manquant, non sauvegardé.`); allSaved = false; } } return allSaved; }
        async function loadProgramsFromDrive() { if (!googleAccessToken) return false; console.log("Chargement des programmes depuis Drive..."); let allLoadedSuccessfully = true; loadedWorkouts = {}; for (const type of PROGRAM_TYPES) { programFileIds[type] = await findOrCreateFile(PROGRAM_FILENAMES[type], JSON.stringify(defaultWorkouts[type] || [], null, 2)); if (programFileIds[type]) { const content = await readFileContent(programFileIds[type]); if (content !== null) { try { loadedWorkouts[type] = JSON.parse(content || '[]'); console.log(`Programme "${type}" chargé (${loadedWorkouts[type].length} items).`); if (loadedWorkouts[type].length === 0) console.warn(`Programme "${type}" est vide sur Drive.`); } catch (e) { console.error(`Erreur parsing JSON pour ${type}:`, e, "Contenu:", content); loadedWorkouts[type] = JSON.parse(JSON.stringify(defaultWorkouts[type] || [])); all
                            // (Suite du bloc catch dans loadProgramsFromDrive)
                    loadedWorkouts[type] = JSON.parse(JSON.stringify(defaultWorkouts[type] || [])); // Fallback to default on parse error
                    allLoadedSuccessfully = false;
                    showMessage(`Erreur format programme "${type}". Utilisation défaut.`, 4000, true);
                }
            } else {
                console.warn(`Impossible de lire contenu pour ${type}. Utilisation défaut.`);
                loadedWorkouts[type] = JSON.parse(JSON.stringify(defaultWorkouts[type] || [])); // Fallback to default
                allLoadedSuccessfully = false;
            }
        } else {
            console.error(`Impossible trouver/créer fichier pour ${type}. Utilisation défaut.`);
            loadedWorkouts[type] = JSON.parse(JSON.stringify(defaultWorkouts[type] || [])); // Fallback to default
            allLoadedSuccessfully = false;
        }
    }
    return allLoadedSuccessfully;
}

function saveInProgressState() {
    // Save state only if workout is active and not in preparation, and localStorage is available
    if (!isWorkoutActive || currentState === 'preparing' || typeof localStorage === 'undefined') return;
    const stateToSave = {
        currentWorkoutType,
        currentItemIndex,
        timeLeft: currentState === 'break' || currentState === 'paused' ? timeLeft : 0, // Save remaining time only for breaks/pause
        currentState,
        workoutStartTime,
        currentWorkoutPlan, // Save the potentially modified plan (with actualReps)
        totalWorkoutEstimatedSeconds,
        elapsedWorkoutEstimatedSeconds,
        timestamp: Date.now()
    };
    try {
        // Only save if a workout type is actually selected
        if(currentWorkoutType) {
            localStorage.setItem(IN_PROGRESS_KEY, JSON.stringify(stateToSave));
            console.log("Workout state saved:", currentState);
        }
    } catch (e) {
        console.warn("Error saving in-progress state to localStorage:", e);
        // Potentially inform user if storage is full?
    }
}

function loadInProgressState() {
    if (typeof localStorage === 'undefined' || !googleAccessToken || !programsLoaded) return; // Don't load if not logged in or programs aren't ready

    try {
        const savedStateJSON = localStorage.getItem(IN_PROGRESS_KEY);
        if (!savedStateJSON) return; // No saved state

        const savedState = JSON.parse(savedStateJSON);
        const maxAge = 24 * 60 * 60 * 1000; // 24 hours validity

        // Validate timestamp and basic structure
        if (!savedState.timestamp || Date.now() - savedState.timestamp > maxAge) {
            console.log("Saved state too old, discarding.");
            clearInProgressState();
            return;
        }
        if (!savedState.currentWorkoutType || !savedState.currentWorkoutPlan) {
             console.warn("Invalid saved state structure, discarding.");
             clearInProgressState();
             return;
        }
        // Basic check: does the saved plan *name* match a loaded program and has the same *length*?
        // This prevents loading state for a drastically different program.
        if (!loadedWorkouts[savedState.currentWorkoutType] || loadedWorkouts[savedState.currentWorkoutType].length !== savedState.currentWorkoutPlan.length) {
            console.warn(`Saved plan for "${savedState.currentWorkoutType}" doesn't match current Drive version (length mismatch). Discarding saved state.`);
            clearInProgressState();
            return;
        }


        if (confirm(`Un entraînement "${savedState.currentWorkoutType}" (état: ${savedState.currentState}) était en cours. Voulez-vous reprendre ?`)) {
            console.log("Resuming workout state:", savedState.currentState);

            // Restore state variables
            currentWorkoutType = savedState.currentWorkoutType;
            currentItemIndex = savedState.currentItemIndex;
            workoutStartTime = savedState.workoutStartTime;
            currentWorkoutPlan = savedState.currentWorkoutPlan; // Restore the exact plan, including any actualReps
            totalWorkoutEstimatedSeconds = savedState.totalWorkoutEstimatedSeconds;
            elapsedWorkoutEstimatedSeconds = savedState.elapsedWorkoutEstimatedSeconds;

            // Restore timer state carefully
            const itemAtSavedIndex = currentWorkoutPlan[currentItemIndex];
            if (savedState.currentState === 'break' || (savedState.currentState === 'paused' && itemAtSavedIndex?.type === 'break')) {
                totalTime = itemAtSavedIndex?.duration || 0;
                timeLeft = Math.max(0, Math.min(savedState.timeLeft, totalTime)); // Restore remaining time for break/pause
            } else {
                timeLeft = 0; // Exercise or pause during exercise has no time left
                totalTime = 0;
            }
            currentRepAdjustment = 0; // Rep adjustment is not saved across sessions

            // Update UI
            setActiveWorkoutNav(currentWorkoutType);
            showSection('workout-section');
            setState(savedState.currentState); // Trigger state change to update UI and timers correctly
            showMessage(`Entraînement "${currentWorkoutType}" repris.`, 3000);
        } else {
            console.log("User declined resuming saved state.");
            clearInProgressState(); // Clear state if user declines
        }
    } catch (e) {
        console.error("Error loading in-progress state:", e);
        clearInProgressState(); // Clear potentially corrupted state
    }
}

function clearInProgressState() {
    if (typeof localStorage === 'undefined') return;
    try {
        localStorage.removeItem(IN_PROGRESS_KEY);
        console.log("In-progress state cleared.");
    } catch (e) {
        console.warn("Error clearing in-progress state:", e);
    }
}

function saveWorkoutToHistory() {
    if (!googleAccessToken || !originalCompletedWorkoutPlan || originalCompletedWorkoutPlan.length === 0) return; // Need auth and a completed plan

    const endTime = Date.now();
    const durationSeconds = workoutStartTime ? (endTime - workoutStartTime) / 1000 : 0;
    let totalReps = 0;
    originalCompletedWorkoutPlan.forEach(item => {
        if (item.type === 'exercise') {
            totalReps += item.actualReps ?? item.reps ?? 0; // Sum actual reps if available, else target reps
        }
    });

    const historyEntry = {
        date: new Date(workoutStartTime || endTime).toISOString(), // Use start time if available
        type: currentWorkoutType || 'Inconnu',
        durationSeconds: Math.round(durationSeconds),
        totalReps: totalReps,
        exercises: originalCompletedWorkoutPlan.map(item => ({ // Map only relevant data
            name: item.name,
            type: item.type,
            ...(item.type === 'exercise' ? {
                reps: item.reps,             // Target reps
                actualReps: item.actualReps ?? item.reps, // Actual reps performed
                weight: item.weight,         // Target weight
                // actualWeight: item.actualWeight ?? item.weight // Uncomment if weight adjustment is added later
            } : {
                duration: item.duration      // Duration for breaks
            })
        }))
    };

    workoutHistory.unshift(historyEntry); // Add to the beginning of the local history array
    saveHistoryToDrive(); // Attempt to save the updated history to Drive

    // Update UI related to history/progress
    displayHistory(currentHistoryPeriod);
    populateExerciseSelect();
    displayExerciseProgress();
}

function exportHistory() {
    if (!googleAccessToken) { showMessage("Connectez-vous pour exporter.", 3000, true); return; }
    if (workoutHistory.length === 0) { showMessage("L'historique est vide, rien à exporter.", 3000); return; }

    try {
        const jsonData = JSON.stringify(workoutHistory, null, 2); // Pretty print JSON
        const blob = new Blob([jsonData], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const dateStr = new Date().toISOString().split('T')[0];
        a.download = `armorworkout_history_${dateStr}.json`; // Filename for download
        document.body.appendChild(a); // Add link to DOM
        a.click(); // Simulate click to trigger download
        document.body.removeChild(a); // Clean up link
        URL.revokeObjectURL(url); // Free up memory
        showMessage("Historique exporté avec succès.", 2500);
    } catch (e) {
        showMessage("Erreur lors de l'exportation de l'historique.", 4000, true);
        console.error("Export error:", e);
    }
}

// --- Event Listeners Setup ---
function addEventListeners() {
    // Timer Interaction (Click)
    if (domElements.timerDisplayClickable) domElements.timerDisplayClickable.addEventListener('click', () => {
        initAudioContext();
        if (isRepAdjustmentVisible) { hideRepAdjustmentOverlay(); }
        else if (currentState === 'exercise' || currentState === 'break') { showRepAdjustmentOverlay(); }
        else if (currentState === 'idle' && domElements.startPauseBtn && !domElements.startPauseBtn.disabled) { playSound('laser'); setState('preparing'); }
        else if (currentState === 'paused') { playSound('laser'); const item = currentWorkoutPlan[currentItemIndex]; setState(item?.type === 'exercise' ? 'exercise' : 'break'); }
    });
    // Control Buttons
    if (domElements.startPauseBtn) domElements.startPauseBtn.addEventListener('click', () => { initAudioContext(); playSound('laser'); if (currentState === 'idle') { setState('preparing'); } else if (currentState === 'exercise') { handleItemCompletion(false); } else if (currentState === 'break') { setState('paused'); } else if (currentState === 'paused') { const item = currentWorkoutPlan[currentItemIndex]; setState(item?.type === 'exercise' ? 'exercise' : 'break'); } });
    if (domElements.skipBtn) domElements.skipBtn.addEventListener('click', () => { initAudioContext(); playSound('laser'); if (isWorkoutActive && !['preparing', 'finished'].includes(currentState)) handleItemCompletion(false); });
    if (domElements.prevBtn) domElements.prevBtn.addEventListener('click', () => { initAudioContext(); playSound('laser'); handlePreviousClick(); });
    if (domElements.finishBtn) domElements.finishBtn.addEventListener('click', () => { initAudioContext(); playSound('laser'); forceFinishWorkout(); });
    if (domElements.resetBtn) domElements.resetBtn.addEventListener('click', () => { initAudioContext(); playSound('laser'); if (confirm("Réinitialiser l'entraînement actuel ou la sélection ?")) resetCurrentWorkout(); });
    // Navigation Buttons
    domElements.navButtons?.forEach(btn => { if (btn) btn.addEventListener('click', () => { initAudioContext(); playSound('laser'); loadWorkout(btn.dataset.workout); }); });
    if(domElements.navHistoryBtn) domElements.navHistoryBtn.addEventListener('click', () => { initAudioContext(); playSound('laser'); showSection('history-section'); displayHistory(currentHistoryPeriod); });
    if(domElements.navProgressBtn) domElements.navProgressBtn.addEventListener('click', () => { initAudioContext(); playSound('laser'); showSection('progress-section'); displayExerciseProgress(); });
    // Filter Buttons
    domElements.historyFilterBtns?.forEach(btn => { if(btn) btn.addEventListener('click', () => { initAudioContext(); playSound('laser'); displayHistory(btn.dataset.period); }); });
    if(domElements.exerciseSelect) domElements.exerciseSelect.addEventListener('change', () => { displayExerciseProgress(); });
    if(domElements.periodSelect) domElements.periodSelect.addEventListener('change', () => { displayExerciseProgress(); });
    // Auth & Settings Buttons
    if(domElements.settingsIcon) domElements.settingsIcon.addEventListener('click', () => { playSound('laser'); showMessage("Paramètres non implémentés.", 2000); });
    if(domElements.signInButton) domElements.signInButton.addEventListener('click', () => { playSound('laser'); handleAuthClick(); });
    if(domElements.signOutButton) domElements.signOutButton.addEventListener('click', () => { playSound('laser'); if (confirm("Se déconnecter de Google Drive ?")) handleSignoutClick(); });
    if(domElements.exportButton) domElements.exportButton.addEventListener('click', () => { playSound('laser'); exportHistory(); });
    // Summary Modal Buttons
    if(domElements.finishSummaryBtn) domElements.finishSummaryBtn.addEventListener('click', () => { playSound('laser'); finishSummary(); });
    if(domElements.postWorkoutSummary) domElements.postWorkoutSummary.addEventListener('click', (e) => { if (e.target === domElements.postWorkoutSummary) { playSound('laser'); closeSummary(); } });
    // Rep Adjustment Overlay Buttons
    if(domElements.repAdjustMinusBtn) domElements.repAdjustMinusBtn.addEventListener('click', handleRepAdjustClick);
    if(domElements.repAdjustPlusBtn) domElements.repAdjustPlusBtn.addEventListener('click', handleRepAdjustClick);
    if(domElements.repAdjustmentOverlay) domElements.repAdjustmentOverlay.addEventListener('click', (e) => { if (e.target === domElements.repAdjustmentOverlay) hideRepAdjustmentOverlay(); });
    // Window/Document Events
    document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'hidden' && isWorkoutActive) saveInProgressState(); });
    window.addEventListener('beforeunload', () => { if (isWorkoutActive) saveInProgressState(); });

    console.log("Event Listeners Added.");
} // --- Fin de addEventListeners ---

// --- App Initialization ---
document.addEventListener('DOMContentLoaded', () => {
    console.log("DOM Loaded. Initializing ArmorWorkout...");
    initializeDOMReferences();
    initSounds();
    addEventListeners();

    // Configure Chart.js Date Adapter Locale
    // Vérifie que l'objet `dateFns` et la locale `fr` sont disponibles
    if (typeof dateFns !== 'undefined' && dateFns.locale && dateFns.locale.fr) {
         Chart.defaults.adapters.date = {
             locale: dateFns.locale.fr,
         };
         console.log("Chart.js date adapter locale set to 'fr'.");
    } else {
         console.warn("date-fns French locale not found or date-fns not loaded correctly. Chart.js dates might use default locale.");
         // Tente de charger la locale si elle n'est pas déjà là (peut être redondant avec le script head)
         // Note: Cette approche est moins fiable que d'inclure la locale via <script>
         // if (typeof dateFns !== 'undefined' && typeof dateFns.locale.fr === 'undefined') {
         //     // Dynamically load locale - more complex, less reliable
         // }
    }

    // Initial UI State
    setState('idle');
    updateAuthUI(false);
    showSection('workout-section');

    // Initial Chart Placeholders
    setChartPlaceholder('history-chart-canvas', "Connectez-vous pour voir l'historique.");
    setChartPlaceholder('exercise-progress-chart', "Connectez-vous pour voir la progression.");

    // Initialize Google Sign-In
    checkAndInitGis();

    console.log("ArmorWorkout Initialized and Ready.");
});

</script>
</body>
</html>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
