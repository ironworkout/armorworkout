<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArmorWorkout - Unstable Core</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Orbitron:wght@400;500;700;900&family=Black+Ops+One&display=swap" rel="stylesheet">
    <style>
        :root {
            /* --- ORIGINAL VARIABLES --- */
            --bg-color-dark: #030712; 
            --secondary-bg-color-dark: #0B132B; 
            --primary-text-color-dark: #F0F4F8; 
            --secondary-text-color-dark: #A0AEC0; 
            --border-color-dark: #1E293B; 
            --electric-blue: #00BFFF; 
            --electric-cyan: #22D3EE; 
            --electric-blue-light: #4D94FF; 
            --glow-accent: #0AF; 
            --electric-blue-rgb: 0, 191, 255;
            --electric-cyan-rgb: 34, 211, 238;
            --glow-accent-rgb: 0, 170, 255;
            --secondary-bg-color-dark-rgb: 11, 19, 43;
            --bg-color-dark-rgb: 3, 7, 18;
            --neon-pink: #FF1493; 
            --neon-purple: #9400D3; 
            --neon-green: #39FF14; 
            --neon-red: #FF3131; 
            --neon-yellow: #FFF01F; 
            --neon-pink-rgb: 255, 20, 147;
            --neon-purple-rgb: 148, 0, 211;
            --neon-green-rgb: 57, 255, 20;
            --neon-red-rgb: 255, 49, 49;
            --neon-yellow-rgb: 255, 240, 31;
            --glow-red: 0 0 8px var(--neon-red), 0 0 12px rgba(var(--neon-red-rgb),0.7);
            --glow-green: 0 0 8px var(--neon-green), 0 0 12px rgba(var(--neon-green-rgb),0.7);
            --glow-yellow: 0 0 8px var(--neon-yellow), 0 0 12px rgba(var(--neon-yellow-rgb),0.7);
            --glow-pink: 0 0 8px var(--neon-pink), 0 0 12px rgba(var(--neon-pink-rgb),0.7);
            --glow-purple: 0 0 8px var(--neon-purple), 0 0 12px rgba(var(--neon-purple-rgb),0.7);
            --electric-yellow: var(--neon-yellow); 
            --electric-yellow-rgb: var(--neon-yellow-rgb);
            --exercise-color-val: var(--electric-blue-light);
            --exercise-timed-color-val: var(--electric-yellow);
            --break-color-val: var(--electric-cyan);
            --paused-color-val: #A78BFA; 
            --finished-color-val: var(--neon-green);
            --completed-color-val: var(--neon-green);
            --preparing-color-val: var(--electric-cyan);
            --get-ready-color-val: var(--neon-purple);
            --idle-color-val: var(--electric-blue);
            --exercise-color-rgb: 77, 148, 255; 
            --exercise-timed-color-rgb: var(--neon-yellow-rgb);
            --break-color-rgb: var(--electric-cyan-rgb);
            --paused-color-rgb: 167, 139, 250;
            --finished-color-rgb: var(--neon-green-rgb);
            --completed-color-rgb: var(--neon-green-rgb);
            --preparing-color-rgb: var(--electric-cyan-rgb);
            --get-ready-color-rgb: var(--neon-purple-rgb);
            --idle-color-rgb: var(--electric-blue-rgb);
            --color-exercise: var(--exercise-color-val);
            --color-exercise-timed: var(--exercise-timed-color-val);
            --color-break: var(--break-color-val);
            --color-prepare: var(--preparing-color-val);
            --color-finished: var(--finished-color-val);
            --color-paused: var(--paused-color-val);
            --color-idle: var(--secondary-text-color-dark);
            --font-family-main: 'Inter', sans-serif;
            --font-family-timer: 'Orbitron', sans-serif;
            --font-family-titles: 'Orbitron', sans-serif; 
            --border-radius-lg: 10px;
            --border-radius-md: 8px;
            --border-radius-sm: 6px;
            --transition-speed: 0.3s;
            --section-transition-speed: 0.4s;
            --bg-color: var(--bg-color-dark);
            --secondary-bg-color: var(--secondary-bg-color-dark);
            --primary-text-color: var(--primary-text-color-dark);
            --secondary-text-color: var(--secondary-text-color-dark);
            --border-color: var(--border-color-dark);
            --accent-border-color: rgba(var(--electric-blue-rgb), 0.4); 
            --input-bg: #1A202C; 
            --current-timer-state-color: var(--idle-color-val);
            --current-timer-state-color-rgb: var(--idle-color-rgb);
            --timer-text-color-main: #FFFFFF;
            --timer-text-glow-main: 0 0 5px #fff, 0 0 8px #fff, 0 0 12px rgba(var(--electric-cyan-rgb), 0.6), 0 0 18px rgba(var(--electric-cyan-rgb), 0.4);
            --timer-progress-circle-color: var(--electric-cyan);

            /* --- UNSTABLE CORE VARIABLES (NEW) --- */
            --c-t0: 80, 80, 80;       /* T0: Offline */
            --c-t1: 0, 255, 255;      /* T1: Stable (Cyan) */
            --c-t2: 50, 100, 255;     /* T2: Active (Blue) */
            --c-t3: 255, 0, 255;      /* T3: Overload (Magenta) */
            --c-t4: 255, 165, 0;      /* T4: Critical (Orange) */
            --c-t5: 255, 0, 0;        /* T5: Meltdown (Red) */
            --c-t6: 255, 255, 255;    /* T6: Singularity (White) */
            
            --core-rgb: var(--c-t0); /* Updated by JS */
            --shake-x: 0px;
            --shake-y: 0px;
            --glitch-skew: 0deg;
            --core-brightness: 1;
            --rot-speed: 20s;
            --font-display: 'Black Ops One', cursive;
        }

        /* --- UNSTABLE CORE ANIMATIONS (NEW) --- */
        @keyframes spin-core { to { transform: rotate(360deg); } }
        @keyframes spin-core-rev { to { transform: rotate(-360deg); } }
        @keyframes pulse-scale { 0% { transform: scale(0.95); } 100% { transform: scale(1.05); } }

        /* Existing Animations */
        @keyframes subtlePulse { 0%, 100% { opacity: 0.7; transform: scale(1); } 50% { opacity: 1; transform: scale(1.015); } }
        @keyframes electricBorder {
            0% { box-shadow: 0 0 6px rgba(var(--electric-cyan-rgb), 0.6), inset 0 0 4px rgba(var(--electric-cyan-rgb), 0.4); border-color: rgba(var(--electric-cyan-rgb), 0.7); }
            50% { box-shadow: 0 0 18px rgba(var(--electric-blue-rgb), 0.8), inset 0 0 10px rgba(var(--electric-blue-rgb), 0.6); border-color: rgba(var(--electric-blue-rgb), 0.9); }
            100% { box-shadow: 0 0 6px rgba(var(--electric-cyan-rgb), 0.6), inset 0 0 4px rgba(var(--electric-cyan-rgb), 0.4); border-color: rgba(var(--electric-cyan-rgb), 0.7); }
        }
        @keyframes textGlowPulseState {
            0%, 100% { text-shadow: 0 0 5px rgba(var(--current-timer-state-color-rgb), 0.7), 0 0 10px rgba(var(--current-timer-state-color-rgb), 0.5), 0 0 15px rgba(var(--current-timer-state-color-rgb), 0.3); }
            50% { text-shadow: 0 0 8px rgba(var(--current-timer-state-color-rgb), 0.9), 0 0 15px rgba(var(--current-timer-state-color-rgb), 0.7), 0 0 25px rgba(var(--current-timer-state-color-rgb), 0.5); }
        }
        @keyframes completed-pulse {
            0% { transform: scale(1); box-shadow: 0 0 10px 10px rgba(var(--completed-color-rgb), 0.2); }
            50% { transform: scale(1.05); box-shadow: 0 0 25px 25px rgba(var(--completed-color-rgb), 0.4); }
            100% { transform: scale(1); box-shadow: 0 0 10px 10px rgba(var(--completed-color-rgb), 0.2); }
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes gold-glow {
            0%, 100% { text-shadow: 0 0 4px #fff, 0 0 8px #FFD700, 0 0 12px #FFD700; }
            50% { text-shadow: 0 0 8px #fff, 0 0 16px #FFD700, 0 0 24px #FF8C00; }
        }
        @keyframes slow-rotate {
            0% { transform: rotate(-8deg); }
            50% { transform: rotate(8deg); }
            100% { transform: rotate(-8deg); }
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; font-size: 16px; }
        body {
            font-family: var(--font-family-main); background-color: var(--bg-color); color: var(--primary-text-color); line-height: 1.65;
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease; display: flex; flex-direction: column;
            min-height: 100vh; -webkit-font-smoothing: antialiased; overflow-x: hidden;
            background-image: radial-gradient(ellipse at center, rgba(var(--electric-blue-rgb), 0.08) 0%, transparent 60%), linear-gradient(0deg, rgba(var(--bg-color-dark-rgb), 0.5) 0%, rgba(var(--bg-color-dark-rgb), 0.9) 100%);
            position: relative; 
        }
        body::before { 
            content: ""; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-image: linear-gradient(rgba(var(--electric-blue-rgb), 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(var(--electric-blue-rgb), 0.05) 1px, transparent 1px);
            background-size: 30px 30px; z-index: -1; opacity: 0.7;
        }
        
        body.workout-active { overflow: hidden; }
        body.workout-active header { transform: translateY(-100%); opacity: 0; visibility: hidden; transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out, visibility 0s linear 0.4s; }
        body.workout-active footer { display: none; }
        body.workout-active main { position: fixed; inset: 0; padding: 20px 0; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow-y: auto; z-index: 100; }
        body.workout-active .app-section:not(#workout-section) { display: none; }
        body.workout-active #workout-section { margin: auto 0; border: none; background: transparent; box-shadow: none; padding: 0; max-height: 100%; }

        .container { max-width: 1200px; margin: 0 auto; padding: 30px 25px; width: 100%; flex-grow: 1; display: flex; flex-direction: column; }
        
        header {
            padding: 15px 0; background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.5); backdrop-filter: blur(8px) saturate(150%);
            border-bottom: 1px solid rgba(var(--electric-blue-rgb), 0.3); box-shadow: 0 2px 15px rgba(var(--electric-blue-rgb), 0.1);
            position: sticky; top:0; z-index: 1000; 
            transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out, visibility 0s linear 0s; 
        }

        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; padding: 0 25px; flex-wrap: wrap; gap: 15px 20px; }
        header h1 { font-size: 1.6em; color: var(--primary-text-color); margin: 0; font-weight: 700; display: flex; align-items: center; gap: 10px; font-family: var(--font-family-titles); text-shadow: 0 0 8px rgba(var(--electric-cyan-rgb), 0.7); }
        header h1 i { color: var(--electric-cyan); animation: subtlePulse 3s infinite ease-in-out; }
        nav ul { list-style: none; display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; align-items: baseline; }
        nav button, nav a.nav-link {
            background: none; border: none; color: var(--secondary-text-color); font-size: 0.9em; font-weight: 500; padding: 8px 12px;
            cursor: pointer; text-decoration: none; transition: all var(--transition-speed) ease; position: relative;
            border-radius: var(--border-radius-sm); border: 1px solid transparent; display: inline-flex; align-items: center; gap: 6px;
        }
        nav button:hover, nav a.nav-link:hover:not(.disabled-link-look) { color: var(--primary-text-color); background-color: rgba(var(--electric-blue-rgb), 0.1); border-color: rgba(var(--electric-blue-rgb), 0.4); text-shadow: 0 0 5px rgba(var(--electric-blue-rgb), 0.5); }
        nav a.nav-link.disabled-link-look { opacity: 0.5; pointer-events: none; cursor: not-allowed; }
        nav button.active { color: var(--electric-cyan); font-weight: 600; background-color: rgba(var(--electric-cyan-rgb), 0.15); border-color: var(--electric-cyan); box-shadow: 0 0 10px rgba(var(--electric-cyan-rgb), 0.3); }
        nav button:disabled { color: rgba(156, 163, 175, 0.4); cursor: not-allowed; background-color: transparent !important; border-color: transparent !important; opacity: 0.6; pointer-events: none; }
        nav a.nav-link i, #edit-program-btn i { margin-right: 5px; }
        .header-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        #drive-status-text, #signin-button {
            background-color: transparent; border: 1px solid var(--border-color-dark); color: var(--secondary-text-color-dark);
            padding: 5px 12px; border-radius: var(--border-radius-md); font-size: 0.9em; font-weight: 500; cursor: pointer;
            transition: all var(--transition-speed) ease; display: inline-flex; align-items: center; gap: 5px;
        }
        #signin-button:disabled { opacity: 0.5; cursor: not-allowed; border-color: var(--border-color-dark) !important; color: var(--secondary-text-color-dark) !important; background-color: transparent !important; box-shadow: none !important; text-shadow: none !important; pointer-events: auto; }
        #drive-status-text:hover, #signin-button:not(:disabled):hover { border-color: var(--electric-blue); color: var(--electric-blue); background-color: rgba(var(--electric-blue-rgb), 0.1); }
        #drive-status.success #drive-status-text { border-color: var(--neon-green); color: var(--neon-green); cursor: default; }
        #drive-status.loading #drive-status-text { border-color: var(--neon-yellow); color: var(--neon-yellow); }
        #drive-status.error #drive-status-text { border-color: var(--neon-red); color: var(--neon-red); }
        #signin-button { border-color: var(--neon-green); color: var(--neon-green); }
        #drive-status { display: inline-flex; align-items: center; gap: 10px; margin-left: 10px; padding: 0; background: none; border: none; font-size: 1em; color: inherit; }
        body.logged-out #signin-button { display: inline-flex; } body.logged-out #drive-status { display: none; }
        body.logged-in #signin-button { display: none; } body.logged-in #drive-status { display: inline-flex; }
        
        main { flex-grow: 1; display: flex; flex-direction: column; align-items: center; padding-top: 40px; position: relative; transition: all 0.3s ease-in-out; }
        
        .app-section {
            background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.6); backdrop-filter: blur(10px) saturate(130%);
            border: 1px solid rgba(var(--electric-blue-rgb), 0.2); width: 100%; 
            transition: opacity var(--section-transition-speed) ease-in-out, transform 0.3s ease-in-out, visibility 0s linear var(--section-transition-speed);
            opacity: 1; visibility: visible; border-radius: var(--border-radius-lg);
            box-shadow: 0 5px 25px rgba(var(--bg-color-dark-rgb), 0.5), inset 0 0 15px rgba(var(--electric-blue-rgb), 0.1);
        }
        #home-section { padding: 0; background: transparent; border: none; box-shadow: none; backdrop-filter: none; }
        .home-grid { display: flex; flex-wrap: wrap; gap: 30px; width: 100%; }
        .home-main-content { flex: 1 1 60%; min-width: 300px; display: flex; flex-direction: column; gap: 25px; }
        .home-sidebar { flex: 1 1 35%; min-width: 280px; display: flex; flex-direction: column; gap: 25px; }

        .sidebar-module {
            background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.6); backdrop-filter: blur(10px) saturate(130%);
            padding: 20px; border: 1px solid rgba(var(--electric-blue-rgb), 0.2);
            border-radius: var(--border-radius-lg);
            box-shadow: 0 5px 25px rgba(var(--bg-color-dark-rgb), 0.5), inset 0 0 15px rgba(var(--electric-blue-rgb), 0.1);
            animation: fadeIn 0.5s ease-out forwards;
        }
        .sidebar-module h3, .sidebar-module h4 { font-family: var(--font-family-titles); color: var(--primary-text-color); font-size: 1.1em; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .sidebar-module h3 i, .sidebar-module h4 i { color: var(--electric-cyan); }
        .sidebar-module h4 { font-size: 1.0em; margin-top: 25px; margin-bottom: 10px; }
        
        .recent-workouts-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 12px; }
        .recent-workouts-list li { display: flex; justify-content: space-between; align-items: center; background-color: rgba(var(--bg-color-dark-rgb), 0.3); padding: 8px 12px; border-radius: var(--border-radius-sm); font-size: 0.9em; border-left: 3px solid var(--border-color); }
        .recent-workouts-list .workout-info-text .workout-name { color: var(--primary-text-color); font-weight: 500; }
        .recent-workouts-list .workout-info-text .workout-date { color: var(--secondary-text-color); font-size: 0.9em; display: block; }
        .delete-recent-workout-btn { background: none; border: none; color: var(--secondary-text-color); cursor: pointer; font-size: 1em; padding: 5px; border-radius: var(--border-radius-sm); transition: color 0.2s, background-color 0.2s; }
        .delete-recent-workout-btn:hover { color: var(--neon-red); background-color: rgba(var(--neon-red-rgb), 0.1); }

        .consistency-info { display: flex; flex-direction: column; gap: 12px; width: 100%; margin-bottom: 15px;}
        .weekly-goal-progress-bar { width: 100%; height: 8px; background-color: var(--border-color); border-radius: 4px; overflow: hidden; }
        .weekly-goal-progress { height: 100%; width: 0%; background: linear-gradient(90deg, var(--electric-blue), var(--electric-cyan)); border-radius: 4px; transition: width 0.5s ease; }
        .consistency-text { font-size: 0.9em; color: var(--secondary-text-color); }
        .consistency-text strong { color: var(--primary-text-color); }
        
        /* UNSTABLE CORE STYLES */
        .core-housing {
            width: 200px; height: 200px; position: relative;
            display: flex; justify-content: center; align-items: center;
            margin: 20px auto;
            transform: translate(var(--shake-x), var(--shake-y)); /* DYNAMIC SHAKE */
        }
        #particle-canvas { position: absolute; top: -50px; left: -50px; width: 300px; height: 300px; z-index: 0; pointer-events: none; opacity: 0.8; }
        .ring { position: absolute; border-radius: 50%; transition: all 0.5s; }
        .r-1 { 
            width: 100%; height: 100%; border: 2px solid rgba(var(--core-rgb), 0.1);
            border-top: 4px solid rgba(var(--core-rgb), 0.8);
            animation: spin-core var(--rot-speed) linear infinite;
            box-shadow: 0 0 calc(20px * var(--core-brightness)) rgba(var(--core-rgb), 0.3);
        }
        .r-2 {
            width: 80%; height: 80%; border: 1px dashed rgba(var(--core-rgb), 0.5);
            animation: spin-core-rev calc(var(--rot-speed) * 0.7) linear infinite;
        }
        .r-3 {
            width: 60%; height: 60%; background: radial-gradient(circle, rgba(var(--core-rgb), 0.2), transparent 70%);
            border: 2px solid rgba(var(--core-rgb), 0.6);
            animation: pulse-scale 1s infinite alternate;
        }
        .core-val {
            position: absolute; z-index: 10; font-family: var(--font-display);
            font-size: 4em; color: #fff; 
            text-shadow: 2px 0 red, -2px 0 blue, 0 0 30px rgb(var(--core-rgb));
            transform: skew(var(--glitch-skew)); /* GLITCH */
        }
        .tier-display { width: 100%; text-align: left; border-left: 3px solid rgb(var(--core-rgb)); padding-left: 15px; margin-bottom: 20px; }
        .tier-name { font-size: 1.2em; font-weight: 800; color: rgb(var(--core-rgb)); text-transform: uppercase; letter-spacing: 2px; }
        .tier-desc { font-size: 0.9em; color: #aaa; font-style: italic; margin-top: 5px; }
        .wk-prog-wrap { width: 100%; background: #222; height: 6px; border-radius: 3px; overflow: hidden; margin-top: 5px; }
        .wk-prog-fill { height: 100%; width: 0%; background: rgb(var(--core-rgb)); box-shadow: 0 0 10px rgb(var(--core-rgb)); transition: width 0.8s ease; }
        
        .calendar-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calendar-nav button { background: none; border: none; color: var(--secondary-text-color); cursor: pointer; font-size: 1.2em; padding: 5px; border-radius: 50%; width: 30px; height: 30px; transition: background-color 0.2s, color 0.2s; }
        .calendar-nav button:hover { background-color: var(--border-color); color: var(--primary-text-color); }
        .calendar-title { font-weight: 500; font-family: var(--font-family-titles); }
        .monthly-calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .calendar-header { font-size: 0.8em; color: var(--secondary-text-color); padding-bottom: 5px; }
        .calendar-day { position: relative; font-size: 0.9em; padding: 5px 0; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; margin: 0 auto; transition: background-color 0.2s, border-color 0.2s, box-shadow 0.2s, color 0.2s; }
        .calendar-day.other-month { color: #4A5568; }
        /* MODIFICATION: Style du jour actuel amélioré */
        .calendar-day.today {
            font-weight: 700;
            color: var(--electric-cyan);
            border: 1px solid var(--electric-cyan);
            box-shadow: 0 0 8px rgba(var(--electric-cyan-rgb), 0.5);
            background-color: rgba(var(--electric-cyan-rgb), 0.15);
        }
        /* MODIFICATION: Style du point de séance amélioré */
        .day-dot {
            position: absolute;
            bottom: 3px;
            left: 50%;
            transform: translateX(-50%);
            width: 8px; /* Agrandissement */
            height: 8px; /* Agrandissement */
            background-color: var(--electric-cyan);
            border-radius: 50%;
            /* Lueur plus intense */
            box-shadow: 0 0 6px var(--electric-cyan), 0 0 10px rgba(var(--electric-cyan-rgb), 0.7);
            pointer-events: none;
            border: 1px solid rgba(255, 255, 255, 0.5); /* Bordure pour le contraste */
        }
        .delete-workout-btn { position: absolute; top: -5px; right: -5px; color: var(--secondary-text-color); background-color: var(--secondary-bg-color); border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 0.8em; cursor: pointer; opacity: 0; visibility: hidden; transform: scale(0.8); transition: all 0.2s ease; border: 1px solid var(--border-color); z-index: 10; }
        .calendar-day:hover .delete-workout-btn { opacity: 1; visibility: visible; transform: scale(1); }
        .delete-workout-btn:hover { color: var(--neon-red); border-color: var(--neon-red); transform: scale(1.1) rotate(5deg); }


        .session-card-large {
            background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.7); border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg); transition: all 0.3s ease; 
            animation: fadeIn 0.5s ease-out forwards;
            position: relative;
            cursor: pointer;
        }
        .session-card-large:hover, .session-card-large.edit-mode-hover { border-color: var(--electric-cyan); transform: translateY(-3px); box-shadow: 0 8px 25px rgba(var(--electric-cyan-rgb), 0.15); }
        .session-card-large.edit-mode-active { border-color: var(--neon-yellow); box-shadow: 0 8px 25px rgba(var(--neon-yellow-rgb), 0.15); cursor: pointer; }
        
        .session-card-summary { padding: 20px; }
        .session-card-header { display: flex; justify-content: space-between; align-items: center; }
        .session-card-header h3 { font-family: var(--font-family-titles); color: var(--electric-cyan); font-size: 1.4em; margin: 0; text-shadow: 0 0 8px rgba(var(--electric-cyan-rgb), 0.5); }
        .session-card-header .last-session-info { font-size: 0.8em; font-style: italic; color: var(--secondary-text-color); opacity: 0.8; text-align: right; }
        .session-card-large p { font-size: 0.9em; color: var(--secondary-text-color); margin: 10px 0 0 0; min-height: 20px; }
        
        .global-performance-chart-container { min-height: 220px; position: relative; margin-top: 15px; }
        .chart-placeholder { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 0.85em; color: var(--secondary-text-color); padding: 10px; text-align: center; }

        .workout-section { text-align: center; }
        .section-hidden {
            opacity: 0; max-height: 0 !important; padding-top: 0 !important; padding-bottom: 0 !important; margin-bottom: 0 !important;
            border-width: 0 !important; visibility: hidden; transform: translateY(20px) scale(0.98);
            transition: opacity var(--section-transition-speed) ease-in-out, visibility 0s linear var(--section-transition-speed), 
                        max-height 0s linear var(--section-transition-speed), padding var(--section-transition-speed) ease-out,
                        margin var(--section-transition-speed) ease-out, border-width var(--section-transition-speed) ease-out,
                        transform 0.3s ease-in-out;
        }
        .timer-and-image-wrapper { display: flex; flex-direction: column; align-items: center; gap: 20px; margin-bottom: 25px; }
        .exercise-image-area {
            width: 100%; max-width: 260px; margin: 0 auto; padding: 8px; background-color: rgba(var(--secondary-bg-color-dark-rgb),0.4);
            border: 1px solid rgba(var(--electric-cyan-rgb), 0.3); border-radius: var(--border-radius-md); display: none; 
            justify-content: center; align-items: center; box-shadow: 0 4px 12px rgba(var(--bg-color-dark-rgb), 0.4), inset 0 0 8px rgba(var(--electric-cyan-rgb),0.2);
            z-index: 5; transition: opacity 0.4s ease-in-out, transform 0.3s ease-in-out; opacity: 0; transform: scale(0.95) translateY(10px);
        }
        .exercise-image-area.visible { display: flex; opacity: 1; transform: scale(1) translateY(0); }
        #exercise-image-display { display: block; max-width: 100%; max-height: 200px; object-fit: contain; border-radius: var(--border-radius-sm); filter: brightness(0.8) contrast(1.1); }
        .timer-display { position: relative; display: flex; justify-content: center; align-items: center; width: 280px; height: 280px; margin: 0 auto; cursor: pointer; user-select: none; -webkit-tap-highlight-color: transparent; }
        .timer-progress-circle-container { position: absolute; top: 50%; left: 50%; width: 230px; height: 230px; transform: translate(-50%, -50%); pointer-events: none; }
        .timer-progress-circle { fill: none; stroke: var(--timer-progress-circle-color); stroke-width: 6; stroke-linecap: round; transform-origin: center; transform: rotate(-90deg); transition: stroke-dashoffset 0.3s linear, stroke 0.3s ease; }
        .timer-progress-circle-bg { fill: none; stroke: rgba(var(--electric-blue-rgb), 0.15); stroke-width: 6; }
        .timer-step-info-display { position: absolute; top: 15px; left: 0; right: 0; padding: 0 20px; display: flex; justify-content: space-between; font-family: var(--font-family-timer); font-size: 0.8em; color: var(--secondary-text-color); opacity: 0; transition: opacity var(--transition-speed) ease; pointer-events: none; z-index: 15; }
        .timer-step-info-display.visible { opacity: 0.8; }
        #workout-step-current-display, #workout-step-total-display { padding: 3px 8px; background-color: rgba(var(--bg-color-dark-rgb), 0.6); border-radius: var(--border-radius-sm); text-shadow: 0 0 4px rgba(var(--electric-cyan-rgb), 0.6); border: 1px solid rgba(var(--electric-cyan-rgb), 0.2); }
        .reactor { position: relative; width: 180px; height: 180px; display: flex; align-items: center; justify-content: center; border-radius: 50%; overflow: hidden; z-index: 10; background-color: transparent; }
        .reactor::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(var(--bg-color-dark-rgb), 0.3); z-index: 1; border-radius: 50%; }
        .triangle { z-index: 5; position: absolute; top: 66%; left: 50%; transform: translate(-50%, -50%); width: 155px; aspect-ratio: 1; background-color: var(--electric-cyan); -webkit-clip-path: polygon(50% 88%, 0 0, 100% 0); clip-path: polygon(50% 88%, 0 0, 100% 0); transition: transform 0.5s ease-out, background-color var(--transition-speed) ease; }
        .triangle::after { content: ''; display: block; position: absolute; top: 45%; left: 50%; z-index: 6; width: 120px; height: 120px; transform: translate(-50%, -50%); background-color: var(--bg-color); -webkit-clip-path: polygon(50% 90%, 0 0, 100% 0); clip-path: polygon(50% 90%, 0 0, 100% 0); transition: background-color var(--transition-speed) ease; }
        @keyframes rotate-right { to { transform: rotate(360deg); } } @keyframes rotate-left { to { transform: rotate(-360deg); } }
        @keyframes rotate-left-right { 0% { transform: translate(-50%, -50%) rotate(0deg); } 50% { transform: translate(-50%, -50%) rotate(-180deg); } 100% { transform: translate(-50%, -50%) rotate(0deg); } }
        .circle-1 { z-index: 2; position: absolute; width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(rgba(var(--electric-cyan-rgb), 0.8), rgba(var(--electric-blue-rgb), 0.8)); animation: rotate-right 2s linear infinite; }
        .circle-1::before { content: ''; position: absolute; z-index: 1; inset: 10px; border-radius: 50%; background-color: var(--bg-color); transition: background-color var(--transition-speed) ease; }
        .circle-1 span { position: absolute; width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(rgba(var(--electric-cyan-rgb), 0.8), rgba(var(--electric-blue-rgb), 0.8)); top:0; left: 0; }
        .circle-1 span:nth-child(1) { filter: blur(15px); } .circle-1 span:nth-child(2) { filter: blur(15px); } .circle-1 span:nth-child(3) { filter: blur(15px); } .circle-1 span:nth-child(4) { filter: blur(75px); }
        .circle-2 { z-index: 4; position: absolute; top: 30px; left: 30px; width: calc(100% - 60px); height: calc(100% - 60px); border-radius: 50%; border: 10px solid var(--electric-cyan); box-shadow: 0 0 30px 30px rgba(var(--electric-cyan-rgb), 0.2); animation: rotate-left 4s linear infinite; transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease; }
        .circle-2 span { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: calc(100% + 20px); height: 10px; background-color: var(--bg-color); transition: background-color var(--transition-speed) ease; }
        .circle-2 span:nth-child(1) { transform: translate(-50%, -50%) rotate(90deg); } .circle-2 span:nth-child(2) { transform: translate(-50%, -50%) rotate(45deg); } .circle-2 span:nth-child(3) { transform: translate(-50%, -50%) rotate(-45deg); }
        .circle-2 span:nth-child(4) { transform: translate(-50%, -50%) rotate(30deg); } .circle-2 span:nth-child(5) { transform: translate(-50%, -50%) rotate(-30deg); } .circle-2 span:nth-child(6) { transform: translate(-50%, -50%) rotate(0deg); }
        .circle-2 span:nth-child(7) { transform: translate(-50%, -50%) rotate(55deg); height: 5px; } .circle-2 span:nth-child(8) { transform: translate(-50%, -50%) rotate(125deg); height: 5px; }
        .circle-3 { z-index: 7; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: 50%; box-shadow: 0 0 10px 10px rgba(var(--electric-cyan-rgb), 0.2); transition: box-shadow var(--transition-speed) ease; }
        .circle-3::after { content: ''; display: block; width: 115px; height: 115px; border-radius: 50%; border: 3px dotted rgba(var(--electric-cyan-rgb), 0.8); animation: rotate-right 10s linear infinite; transition: border-color var(--transition-speed) ease; }
        .circle-4 { z-index: 8; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100px; height: 100px; border-radius: 50%; box-shadow: 0 0 10px 10px rgba(var(--electric-cyan-rgb), 0.1); animation: rotate-left-right 20s infinite ease-in; transition: box-shadow var(--transition-speed) ease; }
        .circle-4 span { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; height: 100%; border-radius: 50%; border: 3px solid; border-color: var(--electric-cyan) transparent transparent; transition: border-color var(--transition-speed) ease; }
        .circle-4 span:nth-child(1) { transform: translate(-50%, -50%) rotate(45deg); } .circle-4 span:nth-child(2) { transform: translate(-50%, -50%) rotate(-75deg); } .circle-4 span:nth-child(3) { transform: translate(-50%, -50%) rotate(165deg); }
        .circle-5 { z-index: 9; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 64px; height: 64px; border-radius: 50%; animation: rotate-left-right 10s infinite ease-in; background-color: rgba(var(--electric-cyan-rgb), 0.2); box-shadow: 0 0 20px 20px rgba(var(--electric-cyan-rgb), 0.2); transition: background-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease, opacity 0.3s ease; }
        .circle-5 span { position: absolute; inset: 0; z-index: 10; width: 54px; height: 54px; border-radius: 50%; border: 5px solid; border-color: var(--electric-cyan) transparent transparent; margin: auto; transition: border-color var(--transition-speed) ease; }
        .circle-5 span:nth-child(1) { transform: rotate(0deg); } .circle-5 span:nth-child(2) { transform: rotate(120deg); } .circle-5 span:nth-child(3) { transform: rotate(240deg); }
        .circle-6 { z-index: 11; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .circle-6::after { content: ''; display: block; width: 40px; height: 40px; border-radius: 50%; border: 3px dashed var(--electric-cyan); animation: rotate-left 5s infinite ease-in; transition: border-color var(--transition-speed) ease; }
        .circle-7 { z-index: 12; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .circle-7::after { content: ''; display: block; width: 27px; height: 27px; border-radius: 50%; background-color: var(--electric-cyan); animation: rotate-left 5s infinite ease-in; box-shadow: 0 0 5px 5px rgba(var(--electric-cyan-rgb), 0.2); transition: box-shadow var(--transition-speed) ease, transform 0.3s ease, background-color var(--transition-speed) ease; }
        .circle-8 { z-index: 13; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 15px; height: 15px; border-radius: 50%; animation: rotate-left-right 5s infinite ease-in; }
        .circle-8 span { position: absolute; inset: 0; z-index: 14; width: 13px; height: 13px; border-radius: 50%; border: 1px solid; border-color: var(--bg-color) transparent transparent; margin: auto; transition: border-color var(--transition-speed) ease; }
        .circle-8 span:nth-child(1) { transform: rotate(120deg); } .circle-8 span:nth-child(2) { transform: rotate(240deg); }
        @keyframes pulsePausedGlow { 0%, 100% { box-shadow: 0 0 5px 5px rgba(var(--paused-color-rgb), 0.2); transform: scale(1); } 50% { box-shadow: 0 0 10px 10px rgba(var(--paused-color-rgb), 0.4); transform: scale(1.1); } }
        @keyframes pulsePausedRing { 0%, 100% { box-shadow: 0 0 20px 20px rgba(var(--paused-color-rgb), 0.2); opacity: 1; } 50% { box-shadow: 0 0 25px 25px rgba(var(--paused-color-rgb), 0.3); opacity: 0.8; } }
        .state-paused .circle-7::after { background-color: var(--paused-color-val); animation: pulsePausedGlow 1.5s infinite ease-in-out; }
        .state-paused .circle-5 { animation: pulsePausedRing 1.5s infinite ease-in-out; background-color: rgba(var(--paused-color-rgb), 0.3); }
        .state-paused .circle-1, .state-paused .circle-1 span { background: linear-gradient(rgba(var(--paused-color-rgb), 0.8), rgba(var(--paused-color-rgb),0.5));}
        .state-paused .circle-2 { border-color: var(--paused-color-val); box-shadow: 0 0 30px 30px rgba(var(--paused-color-rgb), 0.2); }
        .state-paused .circle-3::after { border-color: rgba(var(--paused-color-rgb), 0.8); }
        .state-paused .circle-4 span { border-color: var(--paused-color-val) transparent transparent; } .state-paused .circle-5 span { border-color: var(--paused-color-val) transparent transparent; }
        .state-paused .circle-6::after { border-color: var(--paused-color-val); } .state-paused .triangle { background-color: var(--paused-color-val); }
        .state-paused .timer-progress-circle { stroke: var(--paused-color-val); }
        @keyframes rotateSpinOnce { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }
        .state-preparing .triangle { animation: rotateSpinOnce 5s linear infinite; background-color: var(--preparing-color-val); }
        .state-preparing .circle-1, .state-preparing .circle-1 span { background: linear-gradient(rgba(var(--preparing-color-rgb), 0.8), rgba(var(--preparing-color-rgb),0.5));}
        .state-preparing .circle-2 { border-color: var(--preparing-color-val); box-shadow: 0 0 30px 30px rgba(var(--preparing-color-rgb), 0.2); }
        .state-preparing .circle-3::after { border-color: rgba(var(--preparing-color-rgb), 0.8); }
        .state-preparing .circle-4 span { border-color: var(--preparing-color-val) transparent transparent; }
        .state-preparing .circle-5 { background-color: rgba(var(--preparing-color-rgb),0.2); box-shadow: 0 0 20px 20px rgba(var(--preparing-color-rgb),0.2);}
        .state-preparing .circle-5 span { border-color: var(--preparing-color-val) transparent transparent; }
        .state-preparing .circle-6::after { border-color: var(--preparing-color-val); }
        .state-preparing .circle-7::after { background-color: var(--preparing-color-val); box-shadow: 0 0 5px 5px rgba(var(--preparing-color-rgb),0.2); }
        .state-preparing .timer-progress-circle { stroke: var(--preparing-color-val); }
        .triangle.spin-transition { animation: rotateSpinOnce 0.6s ease-out forwards; }
        #time-left { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 20; font-family: var(--font-family-timer); font-size: 3.6em; font-weight: 700; color: var(--timer-text-color-main); text-shadow: var(--timer-text-glow-main); transition: font-size 0.2s ease; pointer-events: none; white-space: nowrap; }
        .state-exercise #time-left { font-size: 4em; letter-spacing: 0.05em; }
        .state-exercise .triangle { background-color: var(--exercise-color-val); }
        .state-exercise[data-timed="true"] .triangle { background-color: var(--exercise-timed-color-val); }
        .state-exercise .circle-1, .state-exercise .circle-1 span { background: linear-gradient(rgba(var(--exercise-color-rgb), 0.8), rgba(var(--exercise-color-rgb),0.5));}
        .state-exercise[data-timed="true"] .circle-1, .state-exercise[data-timed="true"] .circle-1 span { background: linear-gradient(rgba(var(--exercise-timed-color-rgb), 0.8), rgba(var(--exercise-timed-color-rgb),0.5));}
        .state-exercise .circle-2 { border-color: var(--exercise-color-val); box-shadow: 0 0 30px 30px rgba(var(--exercise-color-rgb), 0.2); }
        .state-exercise[data-timed="true"] .circle-2 { border-color: var(--exercise-timed-color-val); box-shadow: 0 0 30px 30px rgba(var(--exercise-timed-color-rgb), 0.2); }
        .state-exercise .circle-3::after { border-color: rgba(var(--exercise-color-rgb), 0.8); }
        .state-exercise[data-timed="true"] .circle-3::after { border-color: rgba(var(--exercise-timed-color-rgb), 0.8); }
        .state-exercise .circle-4 span { border-color: var(--exercise-color-val) transparent transparent; }
        .state-exercise[data-timed="true"] .circle-4 span { border-color: var(--exercise-timed-color-val) transparent transparent; }
        .state-exercise .circle-5 { background-color: rgba(var(--exercise-color-rgb),0.2); box-shadow: 0 0 20px 20px rgba(var(--exercise-color-rgb),0.2);}
        .state-exercise[data-timed="true"] .circle-5 { background-color: rgba(var(--exercise-timed-color-rgb),0.2); box-shadow: 0 0 20px 20px rgba(var(--exercise-timed-color-rgb),0.2);}
        .state-exercise .circle-5 span { border-color: var(--exercise-color-val) transparent transparent; }
        .state-exercise[data-timed="true"] .circle-5 span { border-color: var(--exercise-timed-color-val) transparent transparent; }
        .state-exercise .circle-6::after { border-color: var(--exercise-color-val); }
        .state-exercise[data-timed="true"] .circle-6::after { border-color: var(--exercise-timed-color-val); }
        .state-exercise .circle-7::after { background-color: var(--exercise-color-val); box-shadow: 0 0 5px 5px rgba(var(--exercise-color-rgb),0.2); }
        .state-exercise[data-timed="true"] .circle-7::after { background-color: var(--exercise-timed-color-val); box-shadow: 0 0 5px 5px rgba(var(--exercise-timed-color-rgb),0.2); }
        .state-exercise .timer-progress-circle { stroke: var(--exercise-color-val); } 
        .state-exercise[data-timed="true"] .timer-progress-circle { stroke: var(--exercise-timed-color-val); }
        .state-break .triangle { background-color: var(--break-color-val); }
        .state-break .circle-1, .state-break .circle-1 span { background: linear-gradient(rgba(var(--break-color-rgb), 0.8), rgba(var(--break-color-rgb),0.5));}
        .state-break .circle-2 { border-color: var(--break-color-val); box-shadow: 0 0 30px 30px rgba(var(--break-color-rgb), 0.2); }
        .state-break .circle-3::after { border-color: rgba(var(--break-color-rgb), 0.8); }
        .state-break .circle-4 span { border-color: var(--break-color-val) transparent transparent; }
        .state-break .circle-5 { background-color: rgba(var(--break-color-rgb),0.2); box-shadow: 0 0 20px 20px rgba(var(--break-color-rgb),0.2);}
        .state-break .circle-5 span { border-color: var(--break-color-val) transparent transparent; }
        .state-break .circle-6::after { border-color: var(--break-color-val); }
        .state-break .circle-7::after { background-color: var(--break-color-val); box-shadow: 0 0 5px 5px rgba(var(--break-color-rgb),0.2); }
        .state-break .timer-progress-circle { stroke: var(--break-color-val); }
        .state-get-ready .triangle { background-color: var(--get-ready-color-val); }
        .state-get-ready .circle-1, .state-get-ready .circle-1 span { background: linear-gradient(rgba(var(--get-ready-color-rgb), 0.8), rgba(var(--get-ready-color-rgb),0.5));}
        .state-get-ready .circle-2 { border-color: var(--get-ready-color-val); box-shadow: 0 0 30px 30px rgba(var(--get-ready-color-rgb), 0.2); }
        .state-get-ready .circle-3::after { border-color: rgba(var(--get-ready-color-rgb), 0.8); }
        .state-get-ready .circle-4 span { border-color: var(--get-ready-color-val) transparent transparent; }
        .state-get-ready .circle-5 { background-color: rgba(var(--get-ready-color-rgb),0.2); box-shadow: 0 0 20px 20px rgba(var(--get-ready-color-rgb),0.2);}
        .state-get-ready .circle-5 span { border-color: var(--get-ready-color-val) transparent transparent; }
        .state-get-ready .circle-6::after { border-color: var(--get-ready-color-val); }
        .state-get-ready .circle-7::after { background-color: var(--get-ready-color-val); box-shadow: 0 0 5px 5px rgba(var(--get-ready-color-rgb),0.2); }
        .state-get-ready .timer-progress-circle { stroke: var(--get-ready-color-val); }
        .state-finished .triangle, .state-completed .triangle { background-color: var(--finished-color-val); }
        .state-finished .circle-1, .state-finished .circle-1 span, .state-completed .circle-1, .state-completed .circle-1 span { background: linear-gradient(rgba(var(--finished-color-rgb), 0.8), rgba(var(--finished-color-rgb),0.5));}
        .state-finished .circle-2, .state-completed .circle-2 { border-color: var(--finished-color-val); box-shadow: 0 0 30px 30px rgba(var(--finished-color-rgb), 0.2); }
        .state-finished .circle-3::after, .state-completed .circle-3::after { border-color: rgba(var(--finished-color-rgb), 0.8); }
        .state-finished .circle-4 span, .state-completed .circle-4 span { border-color: var(--finished-color-val) transparent transparent; }
        .state-finished .circle-5, .state-completed .circle-5 { background-color: rgba(var(--finished-color-rgb),0.2); box-shadow: 0 0 20px 20px rgba(var(--finished-color-rgb),0.2);}
        .state-finished .circle-5 span, .state-completed .circle-5 span { border-color: var(--finished-color-val) transparent transparent; }
        .state-finished .circle-6::after, .state-completed .circle-6::after { border-color: var(--finished-color-val); }
        .state-finished .circle-7::after, .state-completed .circle-7::after { background-color: var(--finished-color-val); box-shadow: 0 0 5px 5px rgba(var(--finished-color-rgb),0.2); }
        .state-finished .timer-progress-circle, .state-completed .timer-progress-circle { stroke: var(--finished-color-val); }
        .state-completed .circle-5 { animation: completed-pulse 1s ease-out; }
        .state-completed #time-left { font-size: 5em; }
        
        .workout-info { margin-bottom: 20px; min-height: auto; position: relative; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        #current-exercise-name-display { display: block; font-size: 1.3em; font-weight: 600; color: var(--primary-text-color); margin-bottom: 8px; padding: 0 10px; line-height: 1.3; text-shadow: none; }
        body.state-exercise #current-exercise-name-display, body.state-break #current-exercise-name-display, body.state-preparing #current-exercise-name-display { animation: textGlowPulseState 2s infinite ease-in-out; }
        body.state-exercise #current-exercise-name-display { color: var(--color-exercise); }
        body.state-exercise[data-timed="true"] #current-exercise-name-display { color: var(--color-exercise-timed); }
        body.state-break #current-exercise-name-display, body.state-preparing #current-exercise-name-display, body.state-get-ready #current-exercise-name-display { color: var(--color-break); }
        
        #current-exercise-container { display: flex; flex-direction: column; align-items: center; gap: 10px; font-size: 1em; color: var(--secondary-text-color); min-height: auto; width: 100%; }
        
        .exercise-details, .break-info { display: flex; flex-direction: column; flex-wrap: nowrap; justify-content: center; align-items: center; gap: 8px; background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.5); padding: 12px 15px; border-radius: var(--border-radius-sm); border: 1px solid rgba(var(--accent-border-color), 0.5); width: fit-content; max-width: 95%; box-shadow: 0 2px 5px rgba(var(--bg-color-dark-rgb),0.2); }
        .exercise-details .main-stats { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px 20px; font-size: 1.1em; font-weight: 500; color: var(--primary-text-color); margin-bottom: 5px;}
        .exercise-details .main-stats span { display: flex; align-items: center; gap: 8px; }
        .exercise-details .main-stats i { color: var(--color-exercise); opacity: 0.9; }
        .exercise-details[data-timed="true"] .main-stats i { color: var(--color-exercise-timed); }
        .sets-info-text { font-size: 0.8em; color: var(--secondary-text-color); opacity: 0.85; text-align: center; width: 100%; letter-spacing: 0.02em; padding: 0 5px; line-height: 1.4; }
        .sets-info-text i { color: var(--electric-cyan); margin-right: 5px; } 
        
        .break-info { font-size: 1em; }
        .break-info > i { font-size: 1.2em; margin-bottom: 3px;} 
        .break-info > span { font-weight: 500; color: var(--primary-text-color); } 
        .next-exercise-preview { font-size: 0.85em; color: var(--secondary-text-color); margin-top: 10px; padding: 12px 15px; border: 1px dashed; border-radius: var(--border-radius-sm); background-color: rgba(var(--bg-color-dark-rgb), 0.2); display: flex; flex-direction: column; align-items: center; gap: 8px; text-align: center; width: fit-content; max-width: 95%; }
        .next-exercise-preview > .title { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .next-exercise-preview > .title i { opacity: 0.8; font-size: 1.1em; }
        .next-exercise-preview strong { color: var(--primary-text-color); font-weight: 600; display: block; font-size: 1.1em;}
        .next-exercise-preview .next-details-grid { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 8px 18px; font-size: 1.2em; font-weight: 700; color: var(--primary-text-color); font-family: var(--font-family-timer); }
        .next-exercise-preview .next-details-grid span { display: inline-flex; align-items: center; gap: 6px; padding: 5px 10px; background-color: rgba(var(--bg-color-dark-rgb), 0.4); border-radius: var(--border-radius-sm); }
        .next-exercise-preview .next-details-grid i { color: var(--electric-cyan); opacity: 0.8; }
        
        .controls { display: flex; justify-content: center; gap: 8px; margin-top: 20px; flex-wrap: wrap; }
        .controls button { background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.4); border: 1px solid var(--border-color); color: var(--secondary-text-color); padding: 8px 14px; border-radius: var(--border-radius-md); font-size: 0.9em; font-weight: 500; cursor: pointer; transition: all var(--transition-speed) ease; display: inline-flex; align-items: center; justify-content: center; gap: 6px; min-width: 100px; box-shadow: 0 2px 5px rgba(var(--bg-color-dark-rgb),0.3); }
        .controls button:disabled { opacity: 0.5; cursor: not-allowed; background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.2); border-color: var(--border-color-dark); color: var(--secondary-text-color-dark); box-shadow: none !important; transform: none !important; text-shadow: none !important; pointer-events: auto; }
        .controls button:not(:disabled):hover { border-color: var(--electric-blue); color: var(--electric-blue); background-color: rgba(var(--electric-blue-rgb), 0.15); box-shadow: 0 0 10px rgba(var(--electric-blue-rgb), 0.3), inset 0 0 5px rgba(var(--electric-blue-rgb),0.1); transform: translateY(-1px); }
        .controls button i { font-size: 1em; margin-right: 4px; opacity: 0.8; transition: opacity var(--transition-speed) ease; }
        .controls button:not(:disabled):hover i { opacity: 1; }
        #start-pause-btn.start-btn:not(:disabled) { animation: electricBorder 3s infinite linear; border-color: var(--electric-cyan); }
        #start-pause-btn.start-btn:not(:disabled):hover { animation-play-state: paused; }
        .progress-tracker { font-size: 0.85em; color: var(--secondary-text-color-dark); margin-top: 15px; opacity: 0.8; font-weight: 500; display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 8px 15px; min-height: 1.2em; font-family: var(--font-family-timer); }
        #drive-connection-status-main { display: inline-flex; align-items: center; gap: 6px; color: var(--neon-green); font-weight: 500; transition: color 0.3s ease; }
        #drive-connection-status-main i.fa-google-drive { display: inline-block; font-size: 1.1em; }
        #drive-connection-status-main.error { color: var(--neon-red); } #drive-connection-status-main.loading { color: var(--neon-yellow); }
        #progress-text-area { font-weight: 500; letter-spacing: 0.05em; }
        
        .post-workout-summary { position: fixed; inset: 0; background-color: rgba(var(--bg-color-dark-rgb), 0.9); backdrop-filter: blur(8px); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; opacity: 0; visibility: hidden; pointer-events: none; transition: opacity 0.3s ease, visibility 0s linear 0.3s; }
        .post-workout-summary.visible { opacity: 1; visibility: visible; pointer-events: auto; transition: opacity 0.3s ease, visibility 0s linear 0s; }
        .post-workout-summary-content { background-color: var(--secondary-bg-color); border: 1px solid var(--border-color); border-radius: var(--border-radius-lg); box-shadow: 0 10px 30px rgba(0,0,0,0.4), 0 0 20px rgba(var(--electric-cyan-rgb), 0.1); width: 100%; max-width: 680px; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .post-workout-summary.visible .post-workout-summary-content { transform: scale(1); }
        .post-workout-summary h2 { color: var(--electric-cyan); font-size: 1.5em; font-weight: 700; padding: 20px 25px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; text-align: center; background-color: rgba(var(--bg-color-dark-rgb), 0.2); text-shadow: 0 0 5px var(--electric-cyan); }
        .summary-items-list { list-style: none; padding: 15px 25px; overflow-y: auto; flex-grow: 1; background: var(--bg-color); border-bottom: 1px solid var(--border-color); }
        .summary-item {
            --item-accent-color: var(--electric-blue-light);
            background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.4); padding: 15px; border-radius: var(--border-radius-md); margin-bottom: 15px;
            border-left: 4px solid var(--item-accent-color); transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .summary-item:last-child { margin-bottom: 0; }
        .summary-item .exercise-name { display: flex; align-items: center; color: var(--primary-text-color); font-weight: 500; font-size: 1.1em; margin-bottom: 15px; }
        .summary-item .exercise-name-text { flex-grow: 1; white-space: normal; }
        .summary-item .fields-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px 20px; align-items: end; }
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        .input-group.hidden { display: none; }
        .input-group label { font-size: 0.8em; color: var(--secondary-text-color); font-weight: 500; }
        .stepper-control { display: flex; align-items: center; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); }
        .stepper-btn { background: transparent; border: none; color: var(--electric-cyan); font-size: 1.2em; padding: 8px 12px; cursor: pointer; transition: all 0.2s ease; }
        .stepper-btn:hover { background-color: rgba(var(--electric-cyan-rgb), 0.1); text-shadow: 0 0 8px var(--electric-cyan); }
        .stepper-btn:disabled { color: var(--border-color); cursor: not-allowed; background: none; text-shadow: none; }
        .stepper-value { flex-grow: 1; text-align: center; font-size: 1em; font-weight: 700; color: var(--primary-text-color); padding: 0 5px; user-select: none; }
        .resistance-controls { display: flex; gap: 10px; align-items: stretch; }
        .resistance-selector { position: relative; flex-shrink: 0; }
        .selected-resistance { display: flex; align-items: center; gap: 8px; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); padding: 8px 12px; cursor: pointer; height: 100%; transition: border-color 0.2s; }
        .selected-resistance:hover { border-color: var(--electric-cyan); }
        .selected-resistance span { font-size: 1.1em; }
        .selected-resistance i { font-size: 0.8em; color: var(--secondary-text-color); }
        .resistance-options { list-style: none; position: absolute; bottom: 100%; left: 0; background-color: var(--secondary-bg-color); border: 1px solid var(--electric-cyan); border-radius: var(--border-radius-md); z-index: 10; padding: 5px; margin-bottom: 5px; min-width: 180px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: none; }
        .resistance-selector.open .resistance-options { display: block; }
        .resistance-options li { display: flex; align-items: center; gap: 10px; padding: 8px 12px; cursor: pointer; border-radius: var(--border-radius-sm); transition: background-color 0.2s; font-size: 0.9em; }
        .resistance-options li:hover { background-color: rgba(var(--electric-cyan-rgb), 0.15); }
        .resistance-options li span { font-size: 1.2em; }
        .resistance-value-stepper .stepper-btn:hover { color: var(--electric-yellow); text-shadow: 0 0 8px var(--electric-yellow); background-color: rgba(var(--electric-yellow-rgb), 0.1); }
        .range-stepper-control { display: flex; flex-direction: column; gap: 8px; }
        .range-stepper { display: flex; align-items: center; justify-content: space-between; gap: 5px; }
        .range-stepper label { color: var(--secondary-text-color); font-size: 0.8em; min-width: 30px;}
        .range-stepper .stepper-control { flex-grow: 1; }

        .tracking-type-toggle { display: flex; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); overflow: hidden; }
        .tracking-type-toggle button { flex: 1; background: transparent; border: none; padding: 8px 10px; font-size: 0.85em; color: var(--secondary-text-color); cursor: pointer; transition: all 0.2s ease; }
        .tracking-type-toggle button.active { background-color: var(--electric-cyan); color: var(--bg-color); font-weight: 700; text-shadow: 0 0 5px rgba(0,0,0,0.3); }

        .summary-controls { padding: 20px 25px; display: flex; justify-content: center; gap: 15px; flex-shrink: 0; flex-wrap: wrap; border-top: 1px solid var(--border-color); background-color: rgba(var(--bg-color-dark-rgb), 0.2); }
        .summary-controls button { border: none; color: var(--bg-color); min-width: 180px; padding: 12px 25px; border-radius: var(--border-radius-md); font-size: 1em; font-weight: 700; cursor: pointer; transition: all var(--transition-speed) ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); text-transform: uppercase; font-family: var(--font-family-titles); letter-spacing: 0.05em; }
        .summary-controls button:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; filter: grayscale(50%); }
        #finish-summary-btn { background-color: var(--neon-green); --button-finish-glow: var(--glow-green); }
        #finish-summary-btn:not(:disabled):hover { filter: brightness(1.15); box-shadow: 0 4px 10px rgba(0,0,0,0.3), 0 0 10px var(--button-finish-glow); transform: translateY(-1px); text-shadow: 0 0 5px rgba(255,255,255,0.5); }
        
        .message-area { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.9); color: var(--primary-text-color); border: 1px solid var(--border-color); padding: 12px 25px; border-radius: var(--border-radius-md); z-index: 3000; opacity: 0; transition: all 0.5s ease; pointer-events: none; font-size: 0.95em; box-shadow: 0 4px 15px rgba(0,0,0,0.2); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); max-width: 90%; text-align: center; }
        .message-area.visible { opacity: 1; transform: translate(-50%, 0); bottom: 40px; pointer-events: auto; }
        .message-area.error-message { background-color: rgba(var(--neon-red-rgb), 0.8); color: #fff; border-color: var(--neon-red); text-shadow: 0 0 5px rgba(0,0,0,0.5); box-shadow: 0 4px 15px rgba(0,0,0,0.3), 0 0 10px var(--glow-red); }
        
        footer { padding: 25px; text-align: center; font-size: 0.9em; color: var(--secondary-text-color); border-top: 1px solid rgba(var(--electric-blue-rgb), 0.2); margin-top: 50px; background-color: rgba(var(--bg-color-dark-rgb), 0.7); backdrop-filter: blur(3px); transition: all 0.3s ease-in-out; position: relative;}
        footer p { margin-bottom: 8px; }
        footer a { color: var(--electric-cyan); text-decoration: none; transition: color var(--transition-speed) ease, text-shadow var(--transition-speed) ease; }
        footer a:hover { color: var(--primary-text-color); text-decoration: underline; text-shadow: 0 0 8px var(--electric-cyan); }
        footer .fab.fa-google-drive { color: var(--neon-green); } footer .fab.fa-github { color: var(--neon-purple); }
        

        @media (min-width: 769px) { 
            .timer-and-image-wrapper { flex-direction: row; justify-content: center; align-items: center; gap: 30px; }
            .exercise-image-area { max-width: 220px; margin: 0; } 
            .timer-display { margin: 0; width: 300px; height: 300px;} 
            .reactor { width: 190px; height: 190px; } 
            .timer-progress-circle-container { width: 250px; height: 250px; }
            #current-exercise-name-display { font-size: 1.5em; } 
            .exercise-details .main-stats { font-size: 1.2em; }
        }
        @media (max-width: 900px) {
            .home-grid { flex-direction: column; }
            .home-main-content, .home-sidebar { flex-basis: auto; width: 100%; }
        }
        @media (max-width: 768px) { 
            .timer-display { width: 260px; height: 260px; } 
            .reactor { width: 170px; height: 170px; } 
            .timer-progress-circle-container { width: 220px; height: 220px; }
            #time-left { font-size: 3.0em; } 
            .triangle { width: 125px; } .triangle::after { width: 95px; height: 95px; }
            .circle-2 { border-width: 7px; } 
            .circle-5 { width: 50px; height: 50px; } .circle-5 span { width: 40px; height: 40px; }
            header h1 { font-size: 1.3em; }
            .exercise-image-area { max-width: 200px; margin-bottom: 15px; } 
            .summary-item .fields-grid { grid-template-columns: 1fr; } 
        }
        @media (max-width: 480px) { 
            .timer-display { width: 220px; height: 220px; }
            .reactor { width: 140px; height: 140px; } 
            .timer-progress-circle-container { width: 190px; height: 190px; }
            #time-left { font-size: 2.5em; } 
            .triangle { width: 100px; } .triangle::after { width: 75px; height: 75px; }
            #current-exercise-name-display { font-size: 1.1em; } 
            .exercise-details .main-stats { font-size: 1em; }
            .controls button { flex-basis: calc(50% - 6px); }
            .header-content { justify-content: center; } 
            .header-actions { justify-content: center; width: 100%; margin-top: 10px; }
            .exercise-image-area { max-width: 160px; } 
            .post-workout-summary-content { max-width: 95%; } 
            .calendar-day { width: 28px; height: 28px; font-size: 0.8em; }
        }
    </style>
</head>
<body class="logged-out dark-theme state-idle">
    <header>
        <div class="header-content">
            <h1><i class="fas fa-bolt"></i> ArmorWorkout</h1>
            <nav>
                <ul>
                    <li><button id="edit-program-btn" disabled><i class="fas fa-edit"></i> Modifier Programme</button></li>
                </ul>
            </nav>
            <div class="header-actions">
                <div id="drive-status" style="display: none;"> 
                    <span id="drive-status-text">Connecté</span>
                </div>
                <button id="signin-button" disabled><i class="fab fa-google"></i> Se connecter à Drive</button>
            </div>
        </div>
    </header>

    <div class="container">
        <main>
            <div id="home-section" class="app-section">
                <!-- Le contenu de l'accueil sera généré dynamiquement par JavaScript -->
            </div>

            <div class="workout-section app-section section-hidden" id="workout-section">
                <div class="timer-and-image-wrapper" id="timer-view" style="display: none;">
                    <div id="exercise-image-container" class="exercise-image-area">
                        <img id="exercise-image-display" src="" alt="">
                    </div>
                    <div class="timer-display" id="timer-display-clickable" aria-label="Affichage du timer Arc Reactor">
                        <div class="timer-progress-circle-container">
                            <svg viewBox="0 0 100 100">
                                <circle class="timer-progress-circle-bg" cx="50" cy="50" r="45"></circle>
                                <circle id="timer-progress-indicator" class="timer-progress-circle" cx="50" cy="50" r="45" stroke-dasharray="282.74" stroke-dashoffset="282.74"></circle>
                            </svg>
                        </div>
                        <div class="timer-step-info-display" id="workout-step-info-display">
                            <span id="workout-step-current-display" title="Étape actuelle">--</span>
                            <span id="workout-step-total-display" title="Nombre total d'étapes">--</span>
                        </div>
                        <div class="reactor">
                            <div class="triangle"></div>
                            <div class="circle-1"><span></span><span></span><span></span><span></span></div>
                            <div class="circle-2"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></div>
                            <div class="circle-3"></div>
                            <div class="circle-4"><span></span><span></span><span></span></div>
                            <div class="circle-5"><span></span><span></span><span></span></div>
                            <div class="circle-6"></div>
                            <div class="circle-7"></div>
                            <div class="circle-8"><span></span><span></span><span></span></div>
                            <div id="time-left" aria-live="polite">00:00</div>
                        </div>
                    </div>
                </div>
    
                <div class="workout-info" id="workout-info">
                    <div id="current-exercise-name-display">ArmorWorkout</div>
                    <div id="current-exercise-container" aria-live="polite"></div>
                </div>
    
                <div class="controls" style="display: none;">
                    <button id="prev-btn" disabled><i class="fas fa-backward-step"></i> Précédent</button>
                    <button id="start-pause-btn" disabled><i class="fas fa-play"></i> Démarrer</button>
                    <button id="skip-btn" disabled><i class="fas fa-forward-step"></i> Suivant</button>
                    <button id="finish-btn" disabled><i class="fas fa-flag-checkered"></i> Finir</button>
                    <button id="reset-btn" disabled><i class="fas fa-redo"></i> Reset</button>
                </div>
    
                <div class="progress-tracker" id="progress-tracker">
                    <span id="progress-text-area"></span>
                    <span id="drive-connection-status-main" style="display: none;"> 
                        <i class="fab fa-google-drive"></i>
                        <span id="drive-connection-text">Connecté</span>
                    </span>
                </div>
            </div>
        </main>
    </div>
    
    <footer>
        <p>© <span id="current-year"></span> ArmorWorkout. Sauvegarde sur <i class="fab fa-google-drive" aria-hidden="true"></i> Google Drive.</p>
        <p><a href="https://github.com/ironworkout/armorworkout" target="_blank" rel="noopener noreferrer"><i class="fab fa-github" aria-hidden="true"></i> Voir sur GitHub</a></p>
    </footer>

    <div id="message-area" class="message-area" role="status" aria-live="polite"></div>

    <div id="post-workout-summary" class="post-workout-summary" role="dialog" aria-modal="true" aria-labelledby="summary-title">
        <div class="post-workout-summary-content">
            <h2 id="summary-title">Résumé & Objectifs</h2>
            <ul id="summary-items-list" class="summary-items-list"></ul>
            <div class="summary-controls">
                <button id="finish-summary-btn"><i class="fas fa-check"></i> Terminer & Sauvegarder</button>
            </div>
        </div>
    </div>
    
    <script async defer src="https://accounts.google.com/gsi/client"></script>
    <script>
        "use strict";

        // =================================================================================
        // SECTION 1: CONSTANTES GLOBALES ET ÉTAT
        // =================================================================================

        const GOOGLE_CLIENT_ID = "731283926358-viam3ulpgna14flfdeb9m92l8s620hoi.apps.googleusercontent.com";
        const GOOGLE_DRIVE_SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const HISTORY_FILENAME = "armorworkout_history.json";
        const FULL_PROGRAM_FILENAME = "programmeCompletHypertrophieElite_v1.json";
        const PREPARE_DURATION = 3;
        const IN_PROGRESS_KEY = 'armorWorkoutStateInProgress';
        const IN_PROGRESS_VERSION = 1;
        const GIS_CHECK_INTERVAL = 100;
        const GIS_MAX_RETRIES = 50;
        const TIMER_PROGRESS_CIRCLE_CIRCUMFERENCE = 2 * Math.PI * 45;

        // --- NEW: UNSTABLE CORE CONFIGURATION ---
        const TIERS = [
            { min: 0, name: "INERTE", color: "var(--c-t0)", speed: "0s", shake: 0, msg: "Aucune énergie détectée." },
            { min: 2, name: "STABLE", color: "var(--c-t1)", speed: "10s", shake: 1, msg: "Système nominal." },
            { min: 5, name: "ACTIF", color: "var(--c-t2)", speed: "5s", shake: 3, msg: "Augmentation de la puissance." },
            { min: 10, name: "SURCHARGE", color: "var(--c-t3)", speed: "3s", shake: 6, msg: "Fuite radioactive mineure." },
            { min: 20, name: "CRITIQUE", color: "var(--c-t4)", speed: "1s", shake: 12, msg: "Fusion du noyau imminente." },
            { min: 40, name: "SINGULARITÉ", color: "var(--c-t5)", speed: "0.2s", shake: 20, msg: "EFFONDREMENT DE LA RÉALITÉ." },
            { min: 999, name: "DIVIN", color: "var(--c-t6)", speed: "0.05s", shake: 0, msg: "TRANSCENDANCE." }
        ];

        // Variables d'état globales
        let loadedFullProgram = null; 

        let timeDisplayDiv, currentExerciseContainer, progressTracker, startPauseBtn, skipBtn, finishBtn, resetBtn, prevBtn,
            editProgramBtn, signInButton, driveStatusElement, driveStatusTextElement,
            postWorkoutSummary, summaryTitle, summaryItemsList, finishSummaryBtn, 
            currentExerciseNameDisplay, driveConnectionStatusMain, driveConnectionText, timerDisplayElement,
            progressTextArea, messageArea, homeSection,
            workoutSection, 
            reactorElement, exerciseImageContainer, exerciseImageDisplay,
            timerProgressIndicator, workoutStepTotalDisplay, workoutStepCurrentDisplay, workoutStepInfoDisplay,
            timerView, workoutInfoView, controls;

        let currentWorkoutType = null, currentWorkoutPlan = [], originalCompletedWorkoutPlan = [];
        let currentItemIndex = 0, timerInterval = null, prepareCountdownInterval = null;
        let totalTime = 0, timeLeft = 0, prepareTimeLeft = 0;
        let isTimerRunning = false, isWorkoutActive = false, workoutFinished = false, wasFinishedState = false;
        let currentState = 'idle', previousState = 'idle';
        let workoutStartTime = null, workoutHistory = [];
        let googleAccessToken = null, tokenClient = null;
        let historyFileId = null, programFileId = null;
        let programsLoaded = false; 
        let isSavingDriveData = false;
        let messageTimeoutId = null;
        let gisCheckRetries = 0;
        let audioContext;
        let isEditMode = false;
        let currentSummaryContext = { mode: 'workout', sessionName: null };
        let activeCharts = {};
        let displayedCalendarDate = new Date();
        
        // State for Unstable Core
        let coreState = { tier: 0, streak: 0 };

        let soundLaser, sound5, sound4, sound3, sound2, sound1, soundWindows, soundET;

        // =================================================================================
        // SECTION 2: FONCTIONS UTILITAIRES ET HELPERS
        // =================================================================================

        function formatTime(seconds) { 
            const cleanSeconds = Math.max(0, Math.round(seconds)); 
            const minutes = Math.floor(cleanSeconds / 60); 
            const remainingSeconds = cleanSeconds % 60; 
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`; 
        }

        // =================================================================================
        // SECTION 3: GESTION DU SON ET DES VIBRATIONS
        // =================================================================================

        function triggerTriangleSpin() { const t = document.querySelector('.reactor .triangle'); if (!t) return; t.classList.remove('spin-transition'); void t.offsetWidth; t.classList.add('spin-transition'); }
        
        function initSounds() {
            try {
                const bP = "https://ironworkout.github.io/armorworkout/";
                soundLaser = new Audio(bP + 'laser.mp3'); sound5 = new Audio(bP + '5.mp3'); sound4 = new Audio(bP + '4.mp3'); sound3 = new Audio(bP + '3.mp3');
                sound2 = new Audio(bP + '2.mp3'); sound1 = new Audio(bP + '1.mp3'); soundWindows = new Audio(bP + 'windows.mp3'); soundET = new Audio(bP + 'e-t.mp3');
                [soundLaser, sound5, sound4, sound3, sound2, sound1, soundWindows, soundET].forEach(s => { if (s) s.preload = 'auto'; });
            } catch (e) { showMessage("Erreur chargement sons.", 5000, true); console.error(`Sound init failed: ${e.message}`); }
        }

        function playSound(a) { if (!a || !audioContext || audioContext.state !== 'running') return; a.currentTime = 0; a.play().catch(e => { console.warn("Erreur lecture son:", e.message) }); }
        
        function initAudioContext() {
            if (audioContext && audioContext.state === 'running') return;
            if (!audioContext) { try { window.AudioContext = window.AudioContext || window.webkitAudioContext; if (window.AudioContext) audioContext = new AudioContext(); else return; } catch (e) { return; } }
            if (audioContext.state === 'suspended') audioContext.resume().catch(e => { });
        }
        
        const vibrate = (p = [100]) => { if ('vibrate' in navigator) { try { navigator.vibrate(p); } catch (e) { } } };
        
        // =================================================================================
        // SECTION 4: INTÉGRATION API GOOGLE DRIVE
        // =================================================================================

        async function gisInitInternal() {
            if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
                try {
                    tokenClient = google.accounts.oauth2.initTokenClient({ client_id: GOOGLE_CLIENT_ID, scope: GOOGLE_DRIVE_SCOPES, callback: tokenCallback, error_callback: handleTokenError });
                    if (tokenClient) tokenClient.requestAccessToken({ prompt: '' });
                    if (signInButton) signInButton.disabled = false;
                } catch (error) { console.error(`GIS client init failed: ${error.message}`); showMessage("Erreur initialisation services Google.", 5000, true); updateAuthUI(false); if (signInButton) signInButton.disabled = true; }
            } else { if (signInButton) signInButton.disabled = true; }
        }

        function checkAndInitGis() {
            if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2 && typeof google.accounts.oauth2.initTokenClient === 'function') gisInitInternal();
            else if (gisCheckRetries < GIS_MAX_RETRIES) { gisCheckRetries++; setTimeout(checkAndInitGis, GIS_CHECK_INTERVAL); }
            else { console.error("Critique: Librairie GIS non chargée après plusieurs tentatives."); showMessage("Erreur critique: API Google non disponible.", 10000, true); if (signInButton) signInButton.disabled = true; }
        }

        function handleTokenError(error) {
            let msg = `Erreur Authentification Google: ${error.type || error.error || 'Inconnue'}`;
            if (error.type === 'popup_closed_by_user' || error.error === 'popup_closed_by_user') msg = "Fenêtre de connexion Google fermée.";
            else if (error.type === 'popup_failed_to_open') msg = "Impossible d'ouvrir la fenêtre de connexion. Vérifiez les bloqueurs de popups.";
            else if (error.type === 'USER_CANCELLED' || error.error === 'access_denied') msg = "Accès aux données Drive refusé par l'utilisateur.";
            if (driveStatusElement) { driveStatusElement.className = 'error'; driveStatusElement.style.display = 'inline-flex'; }
            showMessage(msg, 7000, true); if (driveStatusTextElement) driveStatusTextElement.textContent = 'Erreur Auth'; updateAuthUI(false);
        }

        async function tokenCallback(tokenResponse) {
            if (driveStatusElement) driveStatusElement.className = '';
            if (tokenResponse.error) { if (tokenResponse.error !== "popup_failed_to_open" && tokenResponse.error !== "popup_closed_by_user") handleTokenError(tokenResponse); else updateAuthUI(false); return; }
            if (tokenResponse && tokenResponse.access_token) {
                googleAccessToken = tokenResponse.access_token; showMessage("Connecté ! Chargement des données...", 2500);
                if (driveStatusElement) { driveStatusElement.classList.remove('error', 'success'); driveStatusElement.classList.add('loading'); driveStatusElement.style.display = 'inline-flex'; }
                if (driveStatusTextElement) driveStatusTextElement.textContent = 'Chargement...';
                try {
                    await loadHistoryFromDrive();
                    const programLoadSuccess = await loadFullProgramFromDrive();
                    
                    if (programLoadSuccess) {
                        showMessage("Programme et données chargés depuis votre Drive.", 3000);
                        if (driveStatusElement) { driveStatusElement.classList.remove('loading', 'error'); driveStatusElement.classList.add('success'); }
                        if (driveStatusTextElement) driveStatusTextElement.textContent = 'Connecté';
                    } else {
                        showMessage(`Erreur chargement '${FULL_PROGRAM_FILENAME}' depuis Drive. Assurez-vous que le fichier existe.`, 8000, true);
                        if (driveStatusElement) { driveStatusElement.classList.remove('loading'); driveStatusElement.classList.add('error'); }
                        if (driveStatusTextElement) driveStatusTextElement.textContent = 'Prog absent';
                    }
                } catch (error) {
                    showMessage("Erreur majeure lors du chargement des données.", 6000, true);
                    if (driveStatusElement) { driveStatusElement.classList.remove('loading', 'success'); driveStatusElement.classList.add('error'); }
                    if (driveStatusTextElement) driveStatusTextElement.textContent = 'Erreur Données';
                } finally { updateAuthUI(true); loadInProgressState(); renderHomeScreen(); }
            } else handleTokenError({ error: "Réponse de token invalide ou vide" });
        }

        function handleAuthClick() {
            initAudioContext();
            if (!tokenClient) { showMessage("Services Google non prêts. Veuillez patienter.", 3000); checkAndInitGis(); return; }
            if (driveStatusElement) { driveStatusElement.classList.remove('error', 'success'); driveStatusElement.classList.add('loading'); driveStatusElement.style.display = 'inline-flex'; }
            if (driveStatusTextElement) driveStatusTextElement.textContent = 'Connexion...';
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }
        
        async function handleCorruptedFile(fileId, filename) {
            const date = new Date().toISOString().split('T')[0];
            const newName = `${filename.replace('.json', '')}_CORRUPT_${date}.json`;
            showMessage(`Fichier '${filename}' corrompu. Sauvegarde de la version corrompue...`, 6000, true);
            
            try {
                const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${googleAccessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ name: newName })
                });
                if (!response.ok) throw new Error(`Échec du renommage (${response.status})`);
                
                showMessage(`Fichier corrompu renommé en '${newName}'. Création d'un nouveau fichier.`, 8000);
                return true;
            } catch (error) {
                showMessage(`Action impossible sur le fichier corrompu. Veuillez vérifier votre Google Drive.`, 10000, true);
                console.error("Erreur lors du renommage du fichier corrompu:", error);
                return false;
            }
        }

        async function findOrCreateFile(filename, defaultContentStr = "{}", mimeType = 'application/json', createIfNotExist = false) {
            if (!googleAccessToken) { return null; }
            const searchUrl = `https://www.googleapis.com/drive/v3/files?q=name='${encodeURIComponent(filename)}'+and+trashed=false&spaces=drive&fields=files(id,name)`;
            try {
                const searchRes = await fetch(searchUrl, { headers: { 'Authorization': `Bearer ${googleAccessToken}` } });
                if (!searchRes.ok) { 
                    if (searchRes.status === 401 || searchRes.status === 403) { 
                        showMessage("Session Google expirée. Veuillez vous reconnecter.", 5000, "error"); googleAccessToken = null; updateAuthUI(false); return null; 
                    } 
                    throw new Error(`Recherche échouée (${searchRes.status})`); 
                }
                const searchData = await searchRes.json();
                if (searchData.files && searchData.files.length > 0) { 
                    return searchData.files[0].id; 
                }
                if (!createIfNotExist) { return null; }
                
                const metadata = { name: filename, mimeType: mimeType };
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', new Blob([defaultContentStr], { type: mimeType }));

                const createRes = await fetch(`https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart`, { method: 'POST', headers: { 'Authorization': `Bearer ${googleAccessToken}` }, body: form });

                if (!createRes.ok) throw new Error(`Création échouée (${createRes.status})`);
                const createData = await createRes.json();
                return createData.id;
            } catch (error) { 
                showMessage(`Erreur Drive (${filename.substring(0, 15)}...): ${error.message}`, 6000, "error"); return null; 
            }
        }

        async function readFileContent(fileId, filename) {
            if (!googleAccessToken || !fileId) return null;
            const url = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`;
            try {
                const response = await fetch(url, { headers: { 'Authorization': `Bearer ${googleAccessToken}` } });
                if (!response.ok) {
                    if (response.status === 404) { return null; }
                    if (response.status === 401 || response.status === 403) { showMessage("Session Google expirée. Veuillez vous reconnecter.", 5000, "error"); googleAccessToken = null; updateAuthUI(false); return null; }
                    throw new Error(`Lecture échouée (${response.status})`);
                }
                return await response.text();
            } catch (error) { showMessage(`Erreur Lecture Drive: ${error.message}`, 6000, "error"); return null; }
        }

        async function updateFileContent(fileId, content, filename) {
            if (!googleAccessToken || !fileId) return false;
            if (isSavingDriveData) { return false; }
            isSavingDriveData = true;
            updateAuthUI(!!googleAccessToken);
            const url = `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`;
            const contentToSend = typeof content === 'object' ? JSON.stringify(content, null, 2) : content;
            let success = false;
            try {
                const response = await fetch(url, { method: 'PATCH', headers: { 'Authorization': `Bearer ${googleAccessToken}`, 'Content-Type': 'application/json; charset=UTF-8' }, body: contentToSend });
                if (!response.ok) { 
                    if (response.status === 401 || response.status === 403) { 
                        showMessage("Session expirée. Reconnectez-vous pour sauvegarder.", 5000, true); googleAccessToken = null; updateAuthUI(false);
                    } else throw new Error(`Écriture échouée ${response.status}`); 
                }
                else { success = true; }
            } catch (error) { 
                showMessage(`Erreur sauvegarde fichier Drive.`, 5000, true); 
            }
            finally { isSavingDriveData = false; updateAuthUI(!!googleAccessToken); } return success;
        }

        async function loadHistoryFromDrive() {
            if (!googleAccessToken) return;
            historyFileId = await findOrCreateFile(HISTORY_FILENAME, JSON.stringify([]), 'application/json', true);
            if (historyFileId) {
                const content = await readFileContent(historyFileId, HISTORY_FILENAME);
                if (content !== null) { 
                    try { 
                        workoutHistory = JSON.parse(content || "[]"); 
                        workoutHistory.forEach(e => { if (!e.exercises) e.exercises = []; }); 
                    } catch (e) { 
                        const renamed = await handleCorruptedFile(historyFileId, HISTORY_FILENAME);
                        if(renamed) {
                             historyFileId = null; 
                             await loadHistoryFromDrive();
                        } else {
                            workoutHistory = [];
                        }
                    } 
                } else { workoutHistory = []; }
            } else { workoutHistory = []; }
        }
        
        async function loadFullProgramFromDrive() {
            programsLoaded = false;
            programFileId = await findOrCreateFile(FULL_PROGRAM_FILENAME, "{}", 'application/json', false); 
            if (programFileId) {
                const content = await readFileContent(programFileId, FULL_PROGRAM_FILENAME);
                if (content && content.trim() !== "") {
                    try { 
                        let parsedProgram = JSON.parse(content); 
                        if (parsedProgram && parsedProgram.sessions && Array.isArray(parsedProgram.sessions)) { 
                            loadedFullProgram = parsedProgram; 
                            programsLoaded = true; 
                            return true; 
                        } else throw new Error("Format du programme invalide");
                    } catch (e) { 
                        console.error("Fichier programme corrompu sur Drive:", e);
                        await handleCorruptedFile(programFileId, FULL_PROGRAM_FILENAME);
                        programFileId = null;
                    }
                }
            }
            loadedFullProgram = null;
            return false;
        }


        // =================================================================================
        // SECTION 5: GESTION DE L'ÉTAT DU MINUTEUR
        // =================================================================================

        function setState(newState) {
            if (!startPauseBtn || !skipBtn || !finishBtn || !resetBtn || !timerDisplayElement || !prevBtn || !timeDisplayDiv) return;
            previousState = currentState; currentState = newState; clearInterval(timerInterval); clearInterval(prepareCountdownInterval);
            
            document.body.className = Array.from(document.body.classList).filter(cls => !cls.startsWith('state-')).join(' ') + ` state-${newState}`;
            document.body.classList.toggle('workout-active', !['idle', 'finished'].includes(currentState));
            
            if(startPauseBtn) { startPauseBtn.className = ''; startPauseBtn.disabled = true; }
            if(skipBtn) skipBtn.disabled = true; if(prevBtn) prevBtn.disabled = true; if(finishBtn) finishBtn.disabled = true; if(resetBtn) resetBtn.disabled = true;
            
            const isTimerActive = ['preparing', 'exercise', 'break', 'paused', 'completed'].includes(currentState);
            if (editProgramBtn) editProgramBtn.disabled = !(googleAccessToken && programsLoaded && !isTimerActive);
            
            const item = currentWorkoutPlan[currentItemIndex]; 
            const isTimedExercise = item && item.type.startsWith('exercise') && item.duration !== undefined && item.duration !== null;

            switch (newState) {
                case 'idle':
                    isTimerRunning = false; isWorkoutActive = false; workoutFinished = false; timeLeft = 0; totalTime = 0; workoutStartTime = null; currentWorkoutType = null; currentWorkoutPlan = [];
                    if(startPauseBtn) { startPauseBtn.innerHTML = `<i class="fas fa-play"></i> Démarrer`; startPauseBtn.classList.add('start-btn'); startPauseBtn.disabled = true; }
                    if(resetBtn) resetBtn.disabled = true;
                    if (wasFinishedState) wasFinishedState = false;
                    renderHomeScreen();
                    break;
                case 'preparing':
                    isWorkoutActive = true; prepareTimeLeft = PREPARE_DURATION;
                    if(startPauseBtn) { startPauseBtn.innerHTML = `<i class="fas ${getIconForState('preparing')} fa-spin"></i> Prêt...`; }
                    if(resetBtn) resetBtn.disabled = false;
                    startPrepareCountdown();
                    if (!workoutStartTime) { workoutStartTime = Date.now(); }
                    vibrate([50,30,50]);
                    break;
                case 'exercise':
                    isWorkoutActive = true;
                    document.body.dataset.timed = isTimedExercise;
                    if (isTimedExercise) { 
                        isTimerRunning = true; 
                        if(startPauseBtn) { startPauseBtn.disabled = false; startPauseBtn.innerHTML = `<i class="fas fa-pause"></i> Pause`; }
                        startGenericTimer(); 
                    } else { 
                        isTimerRunning = false; 
                        if(startPauseBtn) { startPauseBtn.innerHTML = `<i class="fas fa-check"></i> Fait`; startPauseBtn.disabled = false; }
                    }
                    if(skipBtn) skipBtn.disabled = false;
                    if(prevBtn) prevBtn.disabled = currentItemIndex <= 0;
                    if(finishBtn) finishBtn.disabled = false;
                    if(resetBtn) resetBtn.disabled = false;
                    vibrate([150]);
                    playSound(soundLaser);
                    triggerTriangleSpin();
                    break;
                case 'completed':
                    isTimerRunning = false; isWorkoutActive = true;
                    vibrate([80]);
                    setTimeout(() => { handleItemCompletion(); }, 1000);
                    break;
                case 'break':
                    isWorkoutActive = true; isTimerRunning = true;
                    if(startPauseBtn) { startPauseBtn.disabled = false; startPauseBtn.innerHTML = `<i class="fas fa-pause"></i> Pause`; }
                    if(skipBtn) skipBtn.disabled = false;
                    if(prevBtn) prevBtn.disabled = currentItemIndex <= 0;
                    if(finishBtn) finishBtn.disabled = false;
                    if(resetBtn) resetBtn.disabled = false;
                    startGenericTimer();
                    vibrate([80, 50, 80]);
                    playSound(soundLaser);
                    triggerTriangleSpin();
                    break;
                case 'paused':
                    isTimerRunning = false; isWorkoutActive = true;
                    if(startPauseBtn) { startPauseBtn.disabled = false; startPauseBtn.innerHTML = `<i class="fas fa-play"></i> Reprendre`; }
                    if(skipBtn) skipBtn.disabled = false;
                    if(prevBtn) prevBtn.disabled = currentItemIndex <= 0;
                    if(finishBtn) finishBtn.disabled = false;
                    if(resetBtn) resetBtn.disabled = false;
                    vibrate();
                    break;
                case 'finished':
                    isWorkoutActive = false; isTimerRunning = false; workoutFinished = true; wasFinishedState = true; timeLeft = 0; totalTime = 0;
                    if(startPauseBtn) { startPauseBtn.innerHTML = `<i class="fas fa-flag-checkered"></i> Terminé`; }
                    if(resetBtn) resetBtn.disabled = false;
                    showMessage('Entraînement terminé ! 💪', 3000);
                    vibrate([150, 50, 150]); playSound(soundET);
                    originalCompletedWorkoutPlan = JSON.parse(JSON.stringify(currentWorkoutPlan));
                    saveWorkoutToHistory(); clearInProgressState(); triggerTriangleSpin();
                    setTimeout(() => populateAndShowSummary({mode: 'workout', sessionName: currentWorkoutType}), 500);
                    break;
            }

            updateWorkoutInfo(); updateTimerDisplay();
        }

        function startPrepareCountdown() {
            totalTime = PREPARE_DURATION; updateTimerDisplay(); if (prepareTimeLeft === 3) playSound(sound3);
            prepareCountdownInterval = setInterval(() => { prepareTimeLeft--; updateTimerDisplay(); if (prepareTimeLeft === 2) playSound(sound2); if (prepareTimeLeft === 1) playSound(sound1); if (prepareTimeLeft <= 0) { clearInterval(prepareCountdownInterval); setState('exercise'); } }, 1000);
        }

        function startGenericTimer() {
            const item = currentWorkoutPlan[currentItemIndex];
            if (!item || item.duration === undefined || item.duration === null) { handleItemCompletion(); return; }
            if (timeLeft <= 0) { totalTime = item.duration; timeLeft = totalTime; }
            updateTimerDisplay(); const sounds = { 5: sound5, 4: sound4, 3: sound3, 2: sound2, 1: sound1 }; if (sounds[timeLeft]) playSound(sounds[timeLeft]);
            timerInterval = setInterval(() => { timeLeft--; updateTimerDisplay(); if (sounds[timeLeft]) playSound(sounds[timeLeft]); if (timeLeft <= 0) { clearInterval(timerInterval); handleItemCompletion(); } }, 1000);
        }

        function handleItemCompletion() {
            if (currentState === 'finished') return;
            const item = currentWorkoutPlan[currentItemIndex]; 
            if (currentState === 'exercise' && item && (item.duration === undefined || item.duration === null) && currentState !== 'completed') { setState('completed'); return; }
            currentItemIndex++; timeLeft = 0; 
            if (currentItemIndex >= currentWorkoutPlan.length) { setState('finished'); }
            else { 
                const nextItem = currentWorkoutPlan[currentItemIndex]; 
                setState(nextItem.type === 'break' ? 'break' : 'exercise'); 
            }
            saveInProgressState();
        }

        function handlePreviousClick() {
             if (currentItemIndex > 0) { 
                 currentItemIndex--; timeLeft = 0; 
                 const prevItem = currentWorkoutPlan[currentItemIndex]; 
                 setState(prevItem.type === 'break' ? 'break' : 'exercise'); 
                 saveInProgressState(); vibrate(); 
            } 
        }

        function forceFinishWorkout() { if (confirm("Êtes-vous sûr de vouloir terminer l'entraînement ?")) { setState('finished'); } }

        function resetCurrentWorkout() { if (confirm(`Voulez-vous réinitialiser et quitter l'entraînement en cours ?`)) { setState('idle'); clearInProgressState(); } }

        // =================================================================================
        // SECTION 6: RENDU DE L'INTERFACE UTILISATEUR (UI)
        // =================================================================================

        function updateTimerDisplay() {
            if (!timeDisplayDiv) return;
            let timeString = "00:00"; 
            const item = currentWorkoutPlan[currentItemIndex];
            switch (currentState) {
                case 'exercise': timeString = (item && item.duration !== undefined && item.duration !== null) ? formatTime(timeLeft) : "GO!"; break;
                case 'break': timeString = formatTime(timeLeft); break;
                case 'paused': timeString = (previousState === 'break' || (previousState === 'exercise' && item && item.duration !== undefined && item.duration !== null)) ? formatTime(timeLeft) : "PAUSE"; break;
                case 'preparing': timeString = formatTime(prepareTimeLeft); break;
                case 'completed': timeString = "✓"; break;
                case 'finished': timeString = "FINI!"; break;
                default: timeString = formatTime(0); break;
            }
            timeDisplayDiv.textContent = timeString;
            updateOverallWorkoutProgressDisplay();
        }

        function updateOverallWorkoutProgressDisplay() {
            if (!timerProgressIndicator || !workoutStepTotalDisplay || !workoutStepCurrentDisplay || !workoutStepInfoDisplay) return;

            const isWorkoutView = !['idle'].includes(currentState);
            
            if (isWorkoutView && currentWorkoutPlan.length > 0) {
                const totalItemsInPlan = currentWorkoutPlan.length;
                let currentStepForDisplay = Math.min(currentItemIndex + 1, totalItemsInPlan);
                let progressPercentage = totalItemsInPlan > 0 ? currentStepForDisplay / totalItemsInPlan : 0;
                
                if (currentState === 'idle' && currentWorkoutType) {
                    currentStepForDisplay = 1;
                    progressPercentage = 0;
                }

                const dashoffset = TIMER_PROGRESS_CIRCLE_CIRCUMFERENCE * (1 - progressPercentage);
                timerProgressIndicator.style.strokeDashoffset = Math.max(0, dashoffset);
                workoutStepCurrentDisplay.textContent = `Étape ${currentStepForDisplay}`;
                workoutStepTotalDisplay.textContent = `/ ${totalItemsInPlan}`;
                workoutStepInfoDisplay.classList.add('visible');
            } else {
                timerProgressIndicator.style.strokeDashoffset = TIMER_PROGRESS_CIRCLE_CIRCUMFERENCE;
                workoutStepCurrentDisplay.textContent = `--`;
                workoutStepTotalDisplay.textContent = `--`;
                workoutStepInfoDisplay.classList.remove('visible');
            }
        }
        
        function updateWorkoutInfo() {
            if (!currentExerciseContainer || !currentExerciseNameDisplay || !progressTracker || !progressTextArea || !exerciseImageContainer || !exerciseImageDisplay || !controls) return;
            
            if (currentState === 'idle' && !currentWorkoutType) {
                showSection('home-section');
                return;
            }
            
            const item = currentWorkoutPlan[currentItemIndex];
            let infoHtml = '', exerciseName = '', progressText = '';
            
            const isWorkoutView = ['preparing', 'exercise', 'break', 'paused', 'completed', 'finished'].includes(currentState);
            timerView.style.display = isWorkoutView ? 'flex' : 'none';
            controls.style.display = isWorkoutView ? 'flex' : 'none';
            workoutInfoView.style.display = isWorkoutView ? 'block': 'none';

            let showImage = false, imageUrlForDisplay = '';
            if (item && item.type.startsWith('exercise') && (currentState === 'exercise' || (currentState === 'paused' && previousState === 'exercise'))) { 
                imageUrlForDisplay = item.image_url; 
                if (imageUrlForDisplay) showImage = true; 
            } else if (currentState === 'preparing' && currentWorkoutPlan[0] && currentWorkoutPlan[0].type.startsWith('exercise')) { 
                imageUrlForDisplay = currentWorkoutPlan[0].image_url; 
                if (imageUrlForDisplay) showImage = true; 
            }
            if (showImage && imageUrlForDisplay) { 
                exerciseImageDisplay.src = imageUrlForDisplay; 
                exerciseImageDisplay.alt = item?.name || "Image de l'exercice"; 
                exerciseImageContainer.classList.add('visible'); 
            } else { 
                exerciseImageContainer.classList.remove('visible'); 
                setTimeout(() => { if (!exerciseImageContainer.classList.contains('visible')) { exerciseImageDisplay.src = ''; exerciseImageDisplay.alt = ''; } }, 400); 
            }
            
            const isTimedExo = item && item.type.startsWith('exercise') && item.duration !== undefined && item.duration !== null;
            document.body.dataset.timed = isTimedExo;

            switch (currentState) {
                case 'idle': 
                    showSection('home-section'); 
                    return; 
                case 'finished':
                    const durationSeconds = workoutStartTime ? (Date.now() - workoutStartTime) / 1000 : 0;
                    exerciseName = 'Entraînement Terminé !';
                    infoHtml = `<div class="exercise-details" style="border-color: var(--color-finished);"><div class="main-stats"><span><i class="fas ${getIconForState('finished')}" style="color: var(--color-finished)"></i> Bravo ! ${durationSeconds > 0 ? `(${formatTime(durationSeconds)})` : ''}</span></div></div>`;
                    progressText = '';
                    break;
                case 'preparing':
                    const nextItemToPrepare = currentWorkoutPlan[0];
                    exerciseName = `Préparation...`;
                    if(nextItemToPrepare) {
                        const dynamicSetsInfo = getDynamicSetsInfo(0);
                        infoHtml = createNextExercisePreviewHtml(nextItemToPrepare, 'preparing', dynamicSetsInfo);
                    }
                    progressText = `Durée Totale: 00:00`;
                    break;
                case 'exercise': case 'paused': case 'break': case 'completed':
                    if (!item) { 
                        exerciseName = 'Erreur'; infoHtml = '<p>Erreur chargement étape.</p>'; progressText = `Durée Totale: --:--`; break; 
                    }
                    exerciseName = item.type === 'break' ? 'Repos' : (item.name || 'Exercice Inconnu');
                    const elapsed = workoutStartTime ? (Date.now() - workoutStartTime) / 1000 : 0;
                    progressText = `Durée Totale: ${formatTime(elapsed)}`;

                    if (item.type.startsWith('exercise')) {
                        const repsDisplay = getFormattedReps(item);
                        const weightDisplay = getFormattedWeight(item);
                        const dynamicSetsInfo = getDynamicSetsInfo(currentItemIndex) || item.sets_info;
                        const isTimed = item.duration !== undefined && item.duration !== null;
                        infoHtml = `<div class="exercise-details" data-timed="${isTimed}" style="border-color: ${isTimed ? 'var(--color-exercise-timed)' : 'var(--color-exercise)'};">`;
                        if (dynamicSetsInfo) { infoHtml += `<span class="sets-info-text"><i class="fas fa-layer-group"></i> ${dynamicSetsInfo}</span>`; }
                        infoHtml += `<div class="main-stats"><span><i class="fas fa-repeat"></i> ${repsDisplay}</span>`;
                        if (weightDisplay.trim() !== "💪 Poids du Corps") infoHtml += `<span><i class="fas fa-weight-hanging"></i> ${weightDisplay.replace(/🏋️|🧘|💪|⚡️/g, '').trim()}</span>`;
                        infoHtml += `</div></div>`;
                    } else if (item.type === 'break') {
                        infoHtml = '';
                        const nextExIdx = currentItemIndex + 1;
                        if (nextExIdx < currentWorkoutPlan.length && (currentWorkoutPlan[nextExIdx].type.startsWith('exercise'))) {
                            const nextEx = currentWorkoutPlan[nextExIdx];
                            const dynamicSetsInfo = getDynamicSetsInfo(nextExIdx);
                            infoHtml = createNextExercisePreviewHtml(nextEx, 'break', dynamicSetsInfo);
                        } else {
                             infoHtml = `<div class="break-info" style="border-color: var(--color-break);"><i class="fas ${getIconForType('break')}" style="color: var(--color-break)"></i><span>Détendez-vous...</span></div>`;
                        }
                    }
                    break;
            }

            if(currentExerciseNameDisplay) currentExerciseNameDisplay.textContent = exerciseName;
            if(currentExerciseContainer) currentExerciseContainer.innerHTML = infoHtml;
            if(progressTextArea) progressTextArea.textContent = progressText;
            
            if (isWorkoutView) showSection('workout-section');
            document.documentElement.style.setProperty('--current-timer-state-color-rgb', `var(--${currentState}-color-rgb)`);
        }

        function getIconForState(state){ 
            switch(state){ 
                case 'exercise': return 'fa-dumbbell'; case 'break': return 'fa-hourglass-half'; 
                case 'paused': return 'fa-pause-circle'; case 'preparing': return 'fa-spinner'; 
                case 'finished': return 'fa-flag-checkered'; case 'completed': return 'fa-check';
                default: return 'fa-clock'; 
            } 
        }

        function getIconForType(type){
            if (type === "exercise_myo_reps") return 'fa-bolt';
            if (type === "exercise_drop_set") return 'fa-angle-double-down';
            if (type === "exercise_timed") return 'fa-stopwatch';
            if (type === "exercise_cluster") return 'fa-cubes';
            if (type?.startsWith('exercise')) return 'fa-dumbbell';
            if (type === 'break') return 'fa-coffee';
            return 'fa-question-circle';
        }

        function getFormattedReps(item) {
            if (!item) return "-";
            if (item.reps_text) return item.reps_text;
            if (item.duration !== undefined && item.duration !== null) return formatTime(item.duration) + (item.unit_duration ? ` ${item.unit_duration}` : "s");
            let repsDisplay = (item.reps !== undefined && item.reps !== null) ? String(item.reps) : "-";
            let repsUnit = item.reps_unit || "";
            return `${repsDisplay}${repsUnit ? ' ' + repsUnit : ''}`;
        }
        
        function getFormattedWeight(item) {
            if (!item) return "-";
            if (item.weight_text) return item.weight_text;
            if (item.unit && item.unit.toLowerCase() === "pdc") return "💪 Poids du Corps";
            if (item.unit && (item.unit.includes("Élastique") || item.unit.startsWith("Résistance"))) return `🧘 ${item.unit}`;
            if (item.weight !== undefined && item.weight > 0 && item.unit) return `🏋️ ${item.weight} ${item.unit}`;
            if (item.weight !== undefined && item.weight > 0) return `🏋️ ${item.weight} kg`;
            return "💪 Poids du Corps";
        }

        function getDynamicSetsInfo(targetIndex, plan) {
            const contextPlan = plan || currentWorkoutPlan;
            if (!contextPlan || targetIndex < 0 || targetIndex >= contextPlan.length) return '';
            const targetItem = contextPlan[targetIndex];
            if (!targetItem || (!targetItem.type.startsWith('exercise'))) return '';
            
            const exName = targetItem.name;
            const allSetsForExercise = contextPlan.filter(i => i.name === exName && i.type.startsWith('exercise'));
            const totalSets = allSetsForExercise.length;
            if (totalSets <= 1) return targetItem.sets_info || '';
            
            let currentSet = 0;
            for (let i = 0; i <= targetIndex; i++) { if (contextPlan[i].name === exName && contextPlan[i].type.startsWith('exercise')) { currentSet++; } }
            return `Série ${currentSet}/${totalSets}`;
        }

        function createNextExercisePreviewHtml(nextExercise, state, dynamicSetsInfo) {
            if (!nextExercise) return '';
            const formattedNextReps = getFormattedReps(nextExercise); 
            const formattedNextWeight = getFormattedWeight(nextExercise);
            const iconClass = state === 'preparing' ? 'fa-hourglass-start' : 'fa-arrow-right'; 
            const borderColorVar = state === 'preparing' ? '--color-prepare' : '--color-break';
            const iconColor = (state === 'preparing' ? `var(--color-prepare)` : `var(--color-break)`);
            
            let nextDetailsHtml = '';
            if (dynamicSetsInfo) { nextDetailsHtml += `<span><i class="fas fa-layer-group"></i> ${dynamicSetsInfo}</span>`; }
            nextDetailsHtml += `<span><i class="fas fa-repeat"></i> ${formattedNextReps}</span>`;
            if (formattedNextWeight.trim() !== "💪 Poids du Corps") { nextDetailsHtml += `<span><i class="fas fa-weight-hanging"></i> ${formattedNextWeight.replace(/🏋️|🧘|💪|⚡️/g, '').trim()}</span>`; }
            
            return `<div class="next-exercise-preview" style="border-color: var(${borderColorVar});"><div class="title"><i class="fas ${iconClass}" style="color: ${iconColor};"></i><strong>À suivre : ${nextExercise.name || '?'}</strong></div><div class="next-details-grid">${nextDetailsHtml}</div></div>`;
        }

        function showSection(sectionId) {
            [homeSection, workoutSection].forEach(section => { if (section && section.id !== sectionId) section.classList.add('section-hidden'); });
            const sectionToShow = document.getElementById(sectionId); 
            if (sectionToShow) sectionToShow.classList.remove('section-hidden');
        }

        function showMessage(msg, duration = 3000, isError = false) { 
            if (!messageArea) return; 
            messageArea.textContent = msg; 
            messageArea.classList.add('visible'); 
            messageArea.classList.toggle('error-message', isError); 
            if (messageTimeoutId) clearTimeout(messageTimeoutId); 
            messageTimeoutId = setTimeout(() => { messageArea.classList.remove('visible'); }, duration); 
        }

        function updateAuthUI(isLoggedIn) {
            document.body.classList.toggle('logged-in', isLoggedIn); 
            document.body.classList.toggle('logged-out', !isLoggedIn);
            
            if (driveStatusElement && driveStatusTextElement) {
                driveStatusElement.style.display = isLoggedIn ? 'inline-flex' : 'none';
                if (isLoggedIn) {
                    const statusClass = driveStatusElement.className;
                    if (statusClass.includes('loading')) driveStatusTextElement.textContent = 'Chargement...';
                    else if (!statusClass.includes('error')) { driveStatusElement.classList.add('success'); driveStatusTextElement.textContent = 'Connecté'; }
                }
            }
            if (driveConnectionStatusMain && driveConnectionText) {
                driveConnectionStatusMain.style.display = isLoggedIn ? 'inline-flex' : 'none';
                const statusClass = driveStatusElement?.className || '';
                driveConnectionStatusMain.className = statusClass;
                if (isLoggedIn) {
                    if (statusClass.includes('loading')) driveConnectionText.textContent = "Chargement...";
                    else if (statusClass.includes('error')) driveConnectionText.textContent = `Erreur Drive`;
                    else driveConnectionText.textContent = "Connecté";
                }
            }
            
            if (signInButton) signInButton.disabled = isLoggedIn || !tokenClient;
            
            const isTimerActive = ['preparing', 'exercise', 'break', 'paused', 'completed'].includes(currentState);
            if (editProgramBtn) editProgramBtn.disabled = !(googleAccessToken && programsLoaded && !isTimerActive);
        }
        
        // --- NEW: ADVANCED STREAK CALCULATION ---
        function calculateAdvancedStreak() {
            // Logic: Consecutive weeks with >= 3 workouts
            const weeks = {};
            if(!workoutHistory) return {streak: 0, currentWeekCount: 0, tierIdx: 0};

            workoutHistory.forEach(h => {
                const d = new Date(h.date + 'T00:00:00');
                d.setHours(0,0,0,0);
                d.setDate(d.getDate() + 4 - (d.getDay() || 7));
                const yearStart = new Date(d.getFullYear(),0,1);
                const weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
                const k = `${d.getFullYear()}-${weekNo}`;
                weeks[k] = (weeks[k] || 0) + 1;
            });

            let streak = 0;
            let currentWeekCount = 0;
            let check = new Date();
            
            // Loop 52 weeks back
            for(let i=0; i<52; i++) {
                const d = new Date(check);
                d.setHours(0,0,0,0);
                d.setDate(d.getDate() + 4 - (d.getDay() || 7));
                const yearStart = new Date(d.getFullYear(),0,1);
                const weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
                const k = `${d.getFullYear()}-${weekNo}`;
                
                const c = weeks[k] || 0;
                
                if(i===0) {
                    currentWeekCount = c;
                    if(c >= 3) streak++;
                } else {
                    if(c >= 3) streak++; else break;
                }
                check.setDate(check.getDate() - 7);
            }

            let tierIdx = 0;
            TIERS.forEach((t, i) => { if(streak >= t.min) tierIdx = i; });
            
            return { streak, currentWeekCount, tierIdx };
        }

        function renderHomeScreen() {
            showSection('home-section');
            if (!homeSection) return;
            homeSection.innerHTML = ''; 
            
            if (!googleAccessToken) {
                homeSection.innerHTML = `<div class="app-section" style="text-align:center; padding: 40px 20px;"><h2>Bienvenue sur ArmorWorkout</h2><p style="margin-top:15px; max-width: 500px; margin-left: auto; margin-right: auto;">Connectez-vous à Google Drive pour synchroniser votre programme, suivre vos progrès et sauvegarder votre historique d'entraînement.</p></div>`;
                return;
            }
            if (!loadedFullProgram || !loadedFullProgram.sessions || loadedFullProgram.sessions.length === 0) {
                 homeSection.innerHTML = `<div class="app-section" style="text-align:center; padding: 40px 20px;"><h2>Programme introuvable</h2><p style="margin-top:15px; max-width: 600px; margin-left: auto; margin-right: auto;">Aucun programme n'a été chargé depuis votre Google Drive. Assurez-vous que le fichier <code>${FULL_PROGRAM_FILENAME}</code> existe à la racine de votre Drive et qu'il n'est pas vide.</p></div>`;
                 return;
            }

            const homeGrid = document.createElement('div'); homeGrid.className = 'home-grid';
            const mainContent = document.createElement('div'); mainContent.className = 'home-main-content';
            const sidebar = document.createElement('div'); sidebar.className = 'home-sidebar';

            sidebar.appendChild(renderConsistencyCalendarModule(displayedCalendarDate));
            
            loadedFullProgram.sessions.forEach(session => {
                const card = document.createElement('div');
                card.className = 'session-card-large';
                card.dataset.sessionName = session.nom_session;
                
                const lastSession = workoutHistory.slice().reverse().find(h => h.type === session.nom_session);
                let lastSessionText = "Aucun historique.";
                if (lastSession) {
                    // FIX: Strict Midnight comparison to solve "Yesterday" vs "Today" bug
                    const now = new Date();
                    now.setHours(0,0,0,0);
                    const lastDate = new Date(lastSession.date + 'T00:00:00');
                    lastDate.setHours(0,0,0,0);

                    const diffTime = now.getTime() - lastDate.getTime();
                    const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

                    if (diffDays === 0) lastSessionText = "Aujourd'hui";
                    else if (diffDays === 1) lastSessionText = "Hier";
                    else lastSessionText = `Il y a ${diffDays} j.`;
                }

                const globalChartCanvasId = `global-chart-${session.nom_session.replace(/\s+/g, '-')}`;
                
                card.innerHTML = `
                    <div class="session-card-summary">
                        <div class="session-card-header">
                            <h3>${session.nom_session}</h3>
                            <div class="last-session-info"><i class="fas fa-history"></i> ${lastSessionText}</div>
                        </div>
                        <p>${session.description_session || ''}</p>
                        <div class="global-performance-chart-container">
                            <canvas id="${globalChartCanvasId}"></canvas>
                            <div id="${globalChartCanvasId}-placeholder" class="chart-placeholder"></div>
                        </div>
                    </div>`;
                mainContent.appendChild(card);
                
                setTimeout(() => {
                    const canvasEl = document.getElementById(globalChartCanvasId);
                    if(canvasEl) renderGlobalPerformanceChart(canvasEl, session.nom_session);
                }, 0);
            });

            homeGrid.appendChild(mainContent);
            homeGrid.appendChild(sidebar);
            homeSection.appendChild(homeGrid);
        }

        // =================================================================================
        // SECTION 7: FONCTIONS DE GESTION DES DONNÉES ET GRAPHIQUES
        // =================================================================================
        
        function getExerciseBaseName(fullName) {
            if (!fullName) return '';
            return fullName.replace(/^(Superset [A-Z]:|Circuit [A-Z]:|FINISHER:)\s*/, '').trim();
        }

        function parseWeightValue(desc) {
            if (!desc) return 0;
            const valueMatch = desc.match(/(\d+([.,]\d+)?)/);
            return valueMatch ? parseFloat(valueMatch[1].replace(',', '.')) : 0;
        }

        function calculatePerformanceScore(exerciseData) {
            if (!exerciseData) return null;
            let charge = 25; // Default for Bodyweight
            const weightDesc = exerciseData.finalWeightDescription || exerciseData.weight_text || getFormattedWeight(exerciseData);
            if(weightDesc) charge = parseWeightValue(weightDesc) || 25;
            
            const repetitions = exerciseData.finalReps || exerciseData.reps || (exerciseData.finalDuration / 3) || (exerciseData.duration / 3) || 0;
            if (repetitions === 0) return 0;
            return Math.pow(charge, 1.05) * repetitions;
        }

        function destroyChart(canvasId) {
            if (activeCharts[canvasId]) {
                activeCharts[canvasId].destroy();
                delete activeCharts[canvasId];
            }
        }
        
        function renderGlobalPerformanceChart(canvasEl, sessionName) {
            const canvasId = canvasEl.id;
            destroyChart(canvasId);
            const placeholderEl = document.getElementById(`${canvasId}-placeholder`);
            const sessionTemplate = loadedFullProgram.sessions.find(s => s.nom_session === sessionName);
            if (!sessionTemplate) return;

            const relevantHistory = workoutHistory.filter(h => h.type === sessionName);
            if (relevantHistory.length === 0) {
                if (placeholderEl) { placeholderEl.textContent = 'Effectuez une séance pour voir le graphique de performance.'; placeholderEl.style.display = 'flex'; }
                return;
            }

            if (placeholderEl) placeholderEl.style.display = 'none';

            const exerciseLabels = [...new Set(sessionTemplate.exercices_et_pauses.filter(ex => ex.type.startsWith('exercise')).map(ex => ex.name))];
            
            const createScoreArrayFromHistory = (historyEntry) => {
                if (!historyEntry) return new Array(exerciseLabels.length).fill(null);
                return exerciseLabels.map(exName => {
                    const exData = historyEntry.exercises.find(ex => ex.name === exName);
                    return calculatePerformanceScore(exData);
                });
            };

            const electricBlueColor = getComputedStyle(document.documentElement).getPropertyValue('--electric-blue').trim();
            const neonYellowColor = getComputedStyle(document.documentElement).getPropertyValue('--neon-yellow').trim();
            const neonPurpleColor = getComputedStyle(document.documentElement).getPropertyValue('--neon-purple').trim();
            const textColor = getComputedStyle(document.documentElement).getPropertyValue('--secondary-text-color').trim();
            const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color-dark').trim() + '80';
            const bgColor = getComputedStyle(document.documentElement).getPropertyValue('--secondary-bg-color').trim();

            const datasets = [];
            
            // Ligne "Actuel"
            const lastHistoryEntry = relevantHistory[relevantHistory.length - 1];
            datasets.push({ label: 'Actuel', data: createScoreArrayFromHistory(lastHistoryEntry), borderColor: electricBlueColor, backgroundColor: electricBlueColor+'33', tension: 0.3, pointRadius: 4, pointHoverRadius: 6, borderWidth: 2 });
            
            // Ligne "Initial"
            const firstHistoryEntry = relevantHistory[0];
            datasets.push({ label: 'Initial', data: createScoreArrayFromHistory(firstHistoryEntry), borderColor: neonPurpleColor, backgroundColor: neonPurpleColor+'33', tension: 0.3, pointRadius: 3, pointHoverRadius: 5 });

            // Ligne "Médian"
            if (relevantHistory.length > 2) {
                const medianIndex = Math.floor((relevantHistory.length - 1) / 2);
                if (medianIndex > 0 && medianIndex < relevantHistory.length - 1) {
                    const medianHistoryEntry = relevantHistory[medianIndex];
                    datasets.push({ label: 'Médian', data: createScoreArrayFromHistory(medianHistoryEntry), borderColor: neonYellowColor, backgroundColor: neonYellowColor+'33', tension: 0.3, pointRadius: 3, pointHoverRadius: 5 });
                }
            }
            
            const ctx = canvasEl.getContext('2d');
            activeCharts[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: exerciseLabels.map(name => name.substring(0, 15) + (name.length > 15 ? '...' : '')),
                    datasets: datasets
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { title: { display: true, text: 'Indice de Performance', color: textColor }, grid: { color: gridColor }, ticks: { color: textColor } },
                        x: { grid: { display: false }, ticks: { color: textColor, autoSkip: false, maxRotation: 70, minRotation: 70 } }
                    },
                    plugins: {
                        legend: { labels: { color: textColor } },
                        tooltip: {
                            backgroundColor: bgColor + 'E6', titleColor: textColor, bodyColor: textColor,
                            callbacks: {
                                title: (tooltipItems) => exerciseLabels[tooltipItems[0].dataIndex],
                                label: (context) => `${context.dataset.label}: ${context.raw ? context.raw.toFixed(0) : 'N/A'}`,
                            }
                        }
                    }
                }
            });
        }
        
        function renderConsistencyCalendarModule(date) {
            // FIX: Define 'today' immediately to prevent ReferenceError
            const today = new Date();

            let module = document.getElementById('consistency-module');
            if (!module) {
                module = document.createElement('div');
                module.className = 'sidebar-module';
                module.id = 'consistency-module';
            }

            // --- REPLACING OLD STREAK LOGIC WITH UNSTABLE CORE UI ---
            const { streak, currentWeekCount, tierIdx } = calculateAdvancedStreak();
            coreState.tier = tierIdx;
            
            const tierData = TIERS[tierIdx];
            const progressPct = Math.min((currentWeekCount / 3) * 100, 100);
            
            // Set CSS Variables for Tier
            const root = document.documentElement;
            root.style.setProperty('--core-rgb', tierData.color.replace('var(','').replace(')',''));
            root.style.setProperty('--rot-speed', tierData.speed);

            module.innerHTML = `
                <h3><i class="fas fa-radiation"></i> Unstable Core</h3>
                
                <div class="core-housing">
                    <canvas id="particle-canvas"></canvas>
                    <div class="ring r-1"></div>
                    <div class="ring r-2"></div>
                    <div class="ring r-3"></div>
                    <div class="core-val">${streak}</div>
                </div>

                <div class="tier-display">
                    <div class="tier-name">TIER ${tierIdx}: ${tierData.name}</div>
                    <div class="tier-desc">${tierData.msg}</div>
                </div>

                <div style="margin-bottom: 20px;">
                    <div style="display:flex; justify-content:space-between; font-size:0.8em; color:#888;">
                        <span>ACTIVITÉ HEBDO</span>
                        <span>${currentWeekCount} / 3</span>
                    </div>
                    <div class="wk-prog-wrap">
                        <div class="wk-prog-fill" style="width: ${progressPct}%"></div>
                    </div>
                </div>

                <div class="calendar-nav">
                    <button class="prev-month"><i class="fas fa-chevron-left"></i></button>
                    <span class="calendar-title">${date.toLocaleString('fr-FR', { month: 'long', year: 'numeric' })}</span>
                    <button class="next-month"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="monthly-calendar"></div>
            `;

            const calendarGrid = module.querySelector('.monthly-calendar');
            // MODIFICATION : Assure la compatibilité avec les anciennes dates ISO et les nouvelles dates locales.
            const workoutDays = new Set(workoutHistory.map(h => h.date.split('T')[0]));
            
            const month = date.getMonth();
            const year = date.getFullYear();
            const firstDay = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const dateOffset = (firstDay.getDay() + 6) % 7;
            const weekDays = ['L', 'M', 'M', 'J', 'V', 'S', 'D'];

            weekDays.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-header';
                header.textContent = day;
                calendarGrid.appendChild(header);
            });
            for (let i = 0; i < dateOffset; i++) { calendarGrid.appendChild(document.createElement('div')); }
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                dayCell.textContent = day;

                // MODIFICATION : Construit une chaîne de date locale AAAA-MM-JJ pour la comparaison.
                const dayString = String(day).padStart(2, '0');
                const monthString = String(month + 1).padStart(2, '0');
                const dateString = `${year}-${monthString}-${dayString}`;
                
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) { dayCell.classList.add('today'); }
                if (workoutDays.has(dateString)) {
                    const dot = document.createElement('span');
                    dot.className = 'day-dot';
                    dayCell.appendChild(dot);
                    const deleteBtn = document.createElement('i');
                    deleteBtn.className = 'fas fa-trash-alt delete-workout-btn';
                    deleteBtn.dataset.date = dateString;
                    deleteBtn.title = `Supprimer les séances du ${new Date(year, month, day).toLocaleDateString('fr-FR')}`;
                    dayCell.appendChild(deleteBtn);
                }
                calendarGrid.appendChild(dayCell);
            }

            const recentWorkoutsEl = renderRecentWorkoutsList();
            module.appendChild(recentWorkoutsEl);
            
            // Initialize Core Animation Engine
            setTimeout(() => {
                if(document.getElementById('particle-canvas')) startUnstableEngine();
            }, 50);

            return module;
        }

        // --- NEW: PARTICLE ENGINE ---
        function startUnstableEngine() {
            const canvas = document.getElementById('particle-canvas');
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            let particles = [];
            const root = document.documentElement;

            canvas.width = 300; canvas.height = 300;

            function createParticle() {
                return {
                    x: 150, y: 150,
                    angle: Math.random() * Math.PI * 2,
                    speed: Math.random() * (coreState.tier + 1),
                    life: Math.random(),
                    size: Math.random() * 3
                };
            }

            function loop() {
                const tier = TIERS[coreState.tier];
                
                // Shake Logic
                if(tier.shake > 0) {
                    const x = (Math.random() - 0.5) * tier.shake;
                    const y = (Math.random() - 0.5) * tier.shake;
                    root.style.setProperty('--shake-x', x + 'px');
                    root.style.setProperty('--shake-y', y + 'px');
                    if(coreState.tier >= 3) root.style.setProperty('--glitch-skew', (Math.random()-0.5)*10 + 'deg');
                } else {
                    root.style.setProperty('--shake-x', '0px');
                    root.style.setProperty('--shake-y', '0px');
                }

                // Particles
                ctx.clearRect(0,0,300,300);
                const pCount = coreState.tier * 15;
                const style = getComputedStyle(root).getPropertyValue('--core-rgb').trim();

                while(particles.length < pCount) particles.push(createParticle());
                while(particles.length > pCount) particles.pop();

                particles.forEach(p => {
                    p.x += Math.cos(p.angle) * p.speed;
                    p.y += Math.sin(p.angle) * p.speed;
                    p.life -= 0.01;
                    if(p.life <= 0) Object.assign(p, createParticle());
                    
                    ctx.fillStyle = `rgba(${style}, ${p.life})`;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
                    ctx.fill();
                });

                if(document.getElementById('particle-canvas')) requestAnimationFrame(loop);
            }
            loop();
        }

        function renderRecentWorkoutsList() {
            const container = document.createElement('div');
            container.id = "recent-workouts-container";
            
            if (workoutHistory.length === 0) return container;

            container.innerHTML = `<h4><i class="fas fa-history"></i> Historique Récent</h4>`;
            const list = document.createElement('ul');
            list.className = 'recent-workouts-list';

            const recentWorkouts = workoutHistory.slice().reverse().slice(0, 5);

            recentWorkouts.forEach(workout => {
                const li = document.createElement('li');
                // MODIFICATION : Ajoute un T00:00:00 pour que le constructeur de date ne soit pas affecté par le fuseau horaire
                const date = new Date(workout.date + 'T00:00:00'); 
                const formattedDate = date.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'short' });

                li.innerHTML = `
                    <div class="workout-info-text">
                        <span class="workout-name">${workout.type}</span>
                        <span class="workout-date">${formattedDate}</span>
                    </div>
                    <button class="delete-recent-workout-btn" data-date-iso="${workout.date}" title="Supprimer cette séance">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
                list.appendChild(li);
            });

            container.appendChild(list);
            return container;
        }
        
        function calculateWeeklyStreak() {
            // Keep this for legacy support if needed, but UI uses calculateAdvancedStreak now
            if (workoutHistory.length < 3) return 0;
            const weeklyGoal = 3;
            const workoutsByWeek = {};
            workoutHistory.forEach(h => {
                const d = new Date(h.date + 'T00:00:00'); // Assure l'interprétation locale
                const firstDayOfWeek = new Date(d);
                firstDayOfWeek.setDate(d.getDate() - (d.getDay() === 0 ? 6 : d.getDay() - 1));
                firstDayOfWeek.setHours(0,0,0,0);
                const weekKey = firstDayOfWeek.toLocaleDateString('sv-SE');
                if (!workoutsByWeek[weekKey]) workoutsByWeek[weekKey] = 0;
                workoutsByWeek[weekKey]++;
            });
            
            let streak = 0;
            let currentWeek = new Date();
            currentWeek.setDate(currentWeek.getDate() - (currentWeek.getDay() === 0 ? 6 : currentWeek.getDay() - 1));
            currentWeek.setHours(0,0,0,0);

            const currentWeekKey = currentWeek.toLocaleDateString('sv-SE');
            let lastWeek = new Date(currentWeek); lastWeek.setDate(lastWeek.getDate() - 7);
            const lastWeekKey = lastWeek.toLocaleDateString('sv-SE');

            let weekToStart = null;
            if (workoutsByWeek[currentWeekKey] >= weeklyGoal) { weekToStart = currentWeek; } 
            else if (workoutsByWeek[lastWeekKey] >= weeklyGoal) { weekToStart = lastWeek; } 
            else { return 0; }
            
            streak = 1;
            let previousWeek = new Date(weekToStart);
            while (true) {
                previousWeek.setDate(previousWeek.getDate() - 7);
                const previousWeekKey = previousWeek.toLocaleDateString('sv-SE');
                if (workoutsByWeek[previousWeekKey] >= weeklyGoal) { streak++; } else { break; }
            }
            return streak;
        }
        
        function parseRepRange(item) {
            const note = item.progression_note || '';
            const match = note.match(/Reps:\s*(\d+)\s*-\s*(\d+)/i);
            if (match) { return { min: parseInt(match[1], 10), max: parseInt(match[2], 10) }; }
            const repValue = item.reps !== undefined ? parseInt(item.reps, 10) : ((item.duration !== undefined) ? item.duration : 8);
            return { min: repValue, max: repValue };
        }

        const resistanceTypes = { 'poids': { emoji: '🏋️', text: 'Poids' }, 'elastique': { emoji: '🧘', text: 'Élastique' }, 'pdc': { emoji: '💪', text: 'Poids du Corps' }, 'poids_elastique': { emoji: '⚡️', text: 'Poids + Élastique' }};
        
        function parseWeightDescription(desc) {
            if (!desc) return { type: 'pdc', value: 0 };
            const descLower = desc.toLowerCase();
            const valueMatch = desc.match(/(\d+([.,]\d+)?)/);
            const value = valueMatch ? parseFloat(valueMatch[1].replace(',', '.')) : 0;
            if (desc.includes('💪') || descLower.includes('pdc') || descLower.includes('corps')) return { type: 'pdc', value: 0 };
            if (desc.includes('⚡️')) return { type: 'poids_elastique', value: value };
            if (desc.includes('🧘') || descLower.includes('élastique')) return { type: 'elastique', value: 0 };
            if (desc.includes('🏋️') || descLower.includes('kg') || value > 0) return { type: 'poids', value: value };
            return { type: 'pdc', value: 0 };
        }
    
        // =================================================================================
        // SECTION 8: GESTION DE SESSION ET SAUVEGARDE
        // =================================================================================

        async function saveFullProgramToDrive(){ if(!googleAccessToken || !loadedFullProgram) return false; if(!programFileId) programFileId = await findOrCreateFile(FULL_PROGRAM_FILENAME, '{}', 'application/json', true); if(programFileId) return await updateFileContent(programFileId, loadedFullProgram, FULL_PROGRAM_FILENAME); else { showMessage("Sauvegarde du programme impossible.", 4000, true); return false; } }
        async function saveHistoryToDrive(){ if(!googleAccessToken || !workoutHistory) return false; if(!historyFileId) historyFileId = await findOrCreateFile(HISTORY_FILENAME, '[]', 'application/json', true); if(historyFileId) return await updateFileContent(historyFileId, workoutHistory, HISTORY_FILENAME); else { showMessage("Sauvegarde de l'historique impossible.", 4000, true); return false; } }

        function saveInProgressState() {
            if (!isWorkoutActive || currentState === 'finished') { clearInProgressState(); return; }
            const stateToSave = {
                version: IN_PROGRESS_VERSION,
                currentWorkoutType: currentWorkoutType,
                currentWorkoutPlan: JSON.parse(JSON.stringify(currentWorkoutPlan)),
                currentItemIndex: currentItemIndex, timeLeft: timeLeft, prepareTimeLeft: prepareTimeLeft,
                workoutStartTime: workoutStartTime, currentState: currentState, previousState: previousState,
            };
            try {
                localStorage.setItem(IN_PROGRESS_KEY, JSON.stringify(stateToSave));
            } catch (e) {
                if (e.name === 'QuotaExceededError') {
                    showMessage("Erreur: Espace de stockage local insuffisant pour sauvegarder la session.", 8000, true);
                }
                console.error("Erreur de sauvegarde locale:", e);
            }
        }

        function loadInProgressState() {
            const savedStateJSON = localStorage.getItem(IN_PROGRESS_KEY);
            if (savedStateJSON) {
                try {
                    const savedState = JSON.parse(savedStateJSON);
                    if (savedState.version !== IN_PROGRESS_VERSION) {
                        console.warn(`Version de l'état local (${savedState.version}) obsolète. L'état est ignoré.`);
                        clearInProgressState();
                        return;
                    }

                    if (savedState.currentWorkoutType && savedState.currentWorkoutPlan && savedState.currentState && loadedFullProgram) {
                        currentWorkoutType = savedState.currentWorkoutType;
                        currentWorkoutPlan = savedState.currentWorkoutPlan;
                        currentItemIndex = savedState.currentItemIndex;
                        timeLeft = savedState.timeLeft;
                        prepareTimeLeft = savedState.prepareTimeLeft;
                        workoutStartTime = savedState.workoutStartTime;
                        previousState = savedState.previousState || 'idle';
                        setState(savedState.currentState);
                        showMessage("Entraînement repris.", 2500);
                        return;
                    }
                } catch (e) { console.error("Erreur parsing état en cours:", e); }
            }
            clearInProgressState();
        }
        
        function clearInProgressState() { localStorage.removeItem(IN_PROGRESS_KEY); }

        function saveWorkoutToHistory() {
            if (!currentWorkoutType || !workoutStartTime || !originalCompletedWorkoutPlan || originalCompletedWorkoutPlan.length === 0) return;
            
            const exercisesSummary = originalCompletedWorkoutPlan
                .map((item, index) => ({ item, originalIndex: index })) 
                .filter(data => data.item.type.startsWith('exercise'))
                .map(data => ({
                    originalPlanIndex: data.originalIndex, 
                    name: data.item.name,
                    type: data.item.type,
                    reps_target: data.item.reps || data.item.duration,
                    weight_description_target: getFormattedWeight(data.item),
                    finalReps: data.item.reps,
                    finalDuration: data.item.duration,
                    finalWeightDescription: data.item.weight_text || getFormattedWeight(data.item),
                    finalProgressionNote: data.item.progression_note
                }));

            // FIX: Enregistre la date locale au format YYYY-MM-DD pour éviter les problèmes de timezone
            const localDateString = new Date().toLocaleDateString('sv-SE');

            workoutHistory.push({
                date: localDateString,
                type: currentWorkoutType,
                durationSeconds: (Date.now() - workoutStartTime) / 1000,
                exercises: exercisesSummary
            });
        }
        
        async function deleteWorkoutsByDay(dateString) {
            const originalLength = workoutHistory.length;
            // MODIFICATION: Assure que la comparaison se fait bien sur la partie date uniquement.
            workoutHistory = workoutHistory.filter(h => h.date.split('T')[0] !== dateString);
            if (workoutHistory.length < originalLength) {
                await saveHistoryToDrive();
                showMessage("Séance(s) supprimée(s).", 3000);
                renderHomeScreen();
            }
        }
        
        async function deleteSingleWorkoutFromHistory(isoDateString) {
            // Cette fonction est tricky si on mixe les formats. On va chercher par index.
            // On s'attend à recevoir AAAA-MM-JJ.
            const originalLength = workoutHistory.length;
            workoutHistory = workoutHistory.filter(h => h.date !== isoDateString);
            if (workoutHistory.length < originalLength) {
                 await saveHistoryToDrive();
                 showMessage("Séance supprimée.", 3000);
                 renderHomeScreen();
            }
        }

        function loadSession(sessionName) {
            if (!loadedFullProgram || !loadedFullProgram.sessions || loadedFullProgram.sessions.length === 0) { 
                showMessage(`Programme non chargé ou vide.`, 5000, true); return; 
            }
            const session = loadedFullProgram.sessions.find(s => s.nom_session === sessionName);
            if (!session || !session.exercices_et_pauses) { 
                showMessage(`Session "${sessionName}" invalide.`, 4000, true); return; 
            }

            setState('idle');

            currentWorkoutType = session.nom_session; 
            currentWorkoutPlan = JSON.parse(JSON.stringify(session.exercices_et_pauses)); 
            currentItemIndex = 0; 
            workoutStartTime = null; 
            vibrate(); 
            clearInProgressState();
            
            showMessage(`Séance '${currentWorkoutType}' lancée !`, 2000);
            setState('preparing');
        }

        // =================================================================================
        // SECTION 9: RÉSUMÉ POST-ENTRAÎNEMENT & ÉDITION
        // =================================================================================
        
        function populateAndShowSummary(context) {
            currentSummaryContext = context;
            if (!postWorkoutSummary || !summaryItemsList || !summaryTitle || !finishSummaryBtn) return;
            
            let planToShow, sessionName;
            const isWorkoutMode = context.mode === 'workout';

            if (isWorkoutMode) {
                sessionName = context.sessionName; planToShow = originalCompletedWorkoutPlan;
                summaryTitle.textContent = `Résumé: ${sessionName || 'Entraînement'}`; finishSummaryBtn.innerHTML = `<i class="fas fa-check"></i> Terminer & Sauvegarder`;
            } else { // 'edit' mode
                sessionName = context.sessionName; 
                const session = loadedFullProgram.sessions.find(s => s.nom_session === sessionName);
                planToShow = session ? JSON.parse(JSON.stringify(session.exercices_et_pauses)) : [];
                summaryTitle.textContent = `Édition : ${sessionName}`; finishSummaryBtn.innerHTML = `<i class="fas fa-save"></i> Enregistrer`;
            }
            summaryItemsList.innerHTML = '';
            
            planToShow.forEach((item, index) => {
                if (item.type.startsWith('exercise')) {
                    const li = document.createElement('li');
                    li.classList.add('summary-item'); 
                    li.dataset.planIndex = index;
                    
                    const { min, max } = parseRepRange(item);
                    const isTimed = item.duration !== undefined && item.duration !== null;
                    const initialValue = isTimed ? item.duration : (item.reps || 0); 
                    const parsedWeight = parseWeightDescription(getFormattedWeight(item));
                    const dynamicSetsInfo = getDynamicSetsInfo(index, planToShow);

                    li.innerHTML = `
                        <div class="exercise-name"><span class="exercise-name-text">${dynamicSetsInfo ? dynamicSetsInfo + ': ' : ''}${item.name}</span></div>
                        <div class="fields-grid">
                             <!-- CORRECTION: Champ unique pour la performance ET la prochaine base -->
                             <div class="input-group" data-field="performance-and-base">
                                <label>Performance / Prochaine Base (${isTimed ? 'secondes' : 'répétitions'})</label>
                                <div class="stepper-control" data-type="performance-and-base"><button class="stepper-btn stepper-minus">-</button><span class="stepper-value">${initialValue}</span><button class="stepper-btn stepper-plus">+</button></div>
                            </div>
                            <div class="input-group"><label>Résistance</label><div class="resistance-controls"><div class="resistance-selector" data-type="${parsedWeight.type}"><div class="selected-resistance"><span>${resistanceTypes[parsedWeight.type].emoji}</span><i class="fas fa-caret-down"></i></div><ul class="resistance-options">${Object.entries(resistanceTypes).map(([key, val]) => `<li data-value="${key}"><span>${val.emoji}</span> ${val.text}</li>`).join('')}</ul></div><div class="stepper-control resistance-value-stepper" data-type="weight" style="display: ${['poids', 'poids_elastique'].includes(parsedWeight.type) ? 'flex' : 'none'}"><button class="stepper-btn stepper-minus">-</button><span class="stepper-value">${parsedWeight.value}</span><button class="stepper-btn stepper-plus">+</button></div></div></div>
                            <div class="input-group"><label>Prochain Objectif (Min-Max)</label><div class="range-stepper-control" data-type="rep-range"><div class="range-stepper"><label>Min</label><div class="stepper-control" data-type="rep-range-min"><button class="stepper-btn stepper-minus">-</button><span class="stepper-value" data-range-type="min">${min}</span><button class="stepper-btn stepper-plus">+</button></div></div><div class="range-stepper"><label>Max</label><div class="stepper-control" data-type="rep-range-max"><button class="stepper-btn stepper-minus">-</button><span class="stepper-value" data-range-type="max">${max}</span><button class="stepper-btn stepper-plus">+</button></div></div></div></div>
                            <div class="input-group"><label>Type de Suivi</label><div class="tracking-type-toggle" data-type="tracking-type"><button class="tracking-reps ${!isTimed ? 'active' : ''}" data-value="reps"><i class="fas fa-repeat"></i> Répétitions</button><button class="tracking-time ${isTimed ? 'active' : ''}" data-value="time"><i class="fas fa-stopwatch"></i> Temps</button></div></div>
                        </div>`;
                    summaryItemsList.appendChild(li);
                }
            });
            postWorkoutSummary.classList.add('visible');
        }

        async function finishSummary() {
            if (!finishSummaryBtn) return;
            finishSummaryBtn.disabled = true;
            finishSummaryBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sauvegarde...';

            const isWorkoutMode = currentSummaryContext.mode === 'workout';
            const sessionName = currentSummaryContext.sessionName;
            const sessionIndex = loadedFullProgram.sessions.findIndex(s => s.nom_session === sessionName);
            
            if (sessionIndex === -1) {
                closeSummary(); showMessage("Erreur Critique: Session introuvable dans le programme.", 4000, true); return;
            }

            const latestWorkoutEntry = isWorkoutMode ? workoutHistory[workoutHistory.length - 1] : null;
            const summaryItems = summaryItemsList.querySelectorAll('.summary-item');
            
            summaryItems.forEach(item => {
                const planIndex = parseInt(item.dataset.planIndex, 10);
                if (isNaN(planIndex)) return; 

                const planItemToUpdate = loadedFullProgram.sessions[sessionIndex].exercices_et_pauses[planIndex];
                if (!planItemToUpdate) return;

                // 1. Lire TOUTES les valeurs de l'UI de manière indépendante
                const newPerformanceAndBaseValue = parseInt(item.querySelector('[data-type="performance-and-base"] .stepper-value').textContent, 10);
                const newMinReps = parseInt(item.querySelector('.stepper-value[data-range-type="min"]').textContent, 10);
                const newMaxReps = parseInt(item.querySelector('.stepper-value[data-range-type="max"]').textContent, 10);
                const resistanceType = item.querySelector('.resistance-selector').dataset.type;
                const weightValue = parseFloat(item.querySelector('.stepper-control[data-type="weight"] .stepper-value').textContent);
                const trackingType = item.querySelector('.tracking-type-toggle .active').dataset.value;
                
                // 2. Préparer les textes pour la sauvegarde
                let newWeightText = resistanceTypes[resistanceType].emoji;
                if (['poids', 'poids_elastique'].includes(resistanceType)) { newWeightText += ` ${weightValue} kg`; }

                // 3. Appliquer les modifications à l'exercice dans le programme principal
                planItemToUpdate.progression_note = `Reps: ${newMinReps}-${newMaxReps}`;
                planItemToUpdate.weight_text = newWeightText;
                
                delete planItemToUpdate.unit;
                delete planItemToUpdate.weight;

                if (trackingType === 'time') {
                    planItemToUpdate.duration = newPerformanceAndBaseValue;
                    delete planItemToUpdate.reps;
                    delete planItemToUpdate.reps_text;
                    delete planItemToUpdate.reps_unit;
                } else {
                    planItemToUpdate.reps = newPerformanceAndBaseValue;
                    delete planItemToUpdate.duration;
                    delete planItemToUpdate.unit_duration;
                    delete planItemToUpdate.reps_text;
                }
                
                // 4. Mettre à jour l'historique de la session si applicable
                if (isWorkoutMode && latestWorkoutEntry?.exercises) {
                    const exerciseLog = latestWorkoutEntry.exercises.find(ex => ex.originalPlanIndex === planIndex);
                    if(exerciseLog) {
                        exerciseLog.finalWeightDescription = newWeightText;
                        if (trackingType === 'time') {
                            exerciseLog.finalDuration = newPerformanceAndBaseValue;
                            delete exerciseLog.finalReps;
                        } else {
                            exerciseLog.finalReps = newPerformanceAndBaseValue;
                            delete exerciseLog.finalDuration;
                        }
                    }
                }
            });

            // 5. Sauvegarder les fichiers sur le Drive
            if (isWorkoutMode) {
                await saveHistoryToDrive();
            }
            await saveFullProgramToDrive();
            
            closeSummary(false);
            setState('idle');
            showMessage("Modifications sauvegardées avec succès !", 3500);
            if (finishSummaryBtn) {
                finishSummaryBtn.disabled = false;
                finishSummaryBtn.innerHTML = isWorkoutMode ? '<i class="fas fa-check"></i> Terminer & Sauvegarder' : '<i class="fas fa-save"></i> Enregistrer';
            }
        }
        
        function closeSummary(shouldReset = true) {
            if(postWorkoutSummary) postWorkoutSummary.classList.remove('visible');
            if (shouldReset) setState('idle');
        }

        // =================================================================================
        // SECTION 10: INITIALISATION ET ÉCOUTEURS D'ÉVÉNEMENTS
        // =================================================================================

        document.addEventListener('DOMContentLoaded', () => {
            initializeDOMReferences();
            addEventListeners();
            initSounds();
            checkAndInitGis();
            document.getElementById('current-year').textContent = new Date().getFullYear();
            setState('idle');
        });

        function initializeDOMReferences() {
            try {
                timeDisplayDiv = document.getElementById("time-left"); currentExerciseContainer = document.getElementById("current-exercise-container");
                progressTracker = document.getElementById("progress-tracker"); startPauseBtn = document.getElementById("start-pause-btn");
                skipBtn = document.getElementById("skip-btn"); finishBtn = document.getElementById("finish-btn");
                resetBtn = document.getElementById("reset-btn"); prevBtn = document.getElementById("prev-btn");
                messageArea = document.getElementById("message-area"); homeSection = document.getElementById("home-section");
                workoutSection = document.getElementById("workout-section"); signInButton = document.getElementById("signin-button");
                driveStatusElement = document.getElementById("drive-status"); driveStatusTextElement = document.getElementById("drive-status-text");
                postWorkoutSummary = document.getElementById("post-workout-summary"); summaryTitle = document.getElementById("summary-title");
                summaryItemsList = document.getElementById("summary-items-list"); finishSummaryBtn = document.getElementById("finish-summary-btn");
                currentExerciseNameDisplay = document.getElementById("current-exercise-name-display");
                driveConnectionStatusMain = document.getElementById("drive-connection-status-main"); driveConnectionText = document.getElementById("drive-connection-text");
                timerDisplayElement = document.querySelector(".timer-display"); reactorElement = document.querySelector(".reactor");
                exerciseImageContainer = document.getElementById("exercise-image-container"); exerciseImageDisplay = document.getElementById("exercise-image-display");
                progressTextArea = document.getElementById("progress-text-area"); editProgramBtn = document.getElementById("edit-program-btn");
                timerProgressIndicator = document.getElementById("timer-progress-indicator"); workoutStepTotalDisplay = document.getElementById("workout-step-total-display");
                workoutStepCurrentDisplay = document.getElementById("workout-step-current-display"); workoutStepInfoDisplay = document.getElementById("workout-step-info-display");
                timerView = document.getElementById("timer-view"); workoutInfoView = document.getElementById("workout-info");
                controls = document.querySelector(".controls");
            } catch(e) {
                document.body.innerHTML = "<p style='color:white; text-align:center; padding-top: 50px;'>Erreur critique au chargement de l'application. Veuillez rafraîchir la page.</p>";
            }
        }
        
        function addEventListeners() {
            startPauseBtn?.addEventListener('click', () => {
                initAudioContext();
                const item = currentWorkoutPlan[currentItemIndex];
                if (isTimerRunning) {
                    setState('paused');
                } else if (currentState === 'paused') {
                    if (item && item.type.startsWith('exercise')) setState('exercise');
                    else if (item && item.type === 'break') setState('break');
                } else if (currentState === 'exercise') {
                    if (item && (item.duration === undefined || item.duration === null)) {
                        handleItemCompletion();
                    }
                }
            });
            timerDisplayElement?.addEventListener('click', () => {
                initAudioContext();
                const item = currentWorkoutPlan[currentItemIndex];
                if (isWorkoutActive && currentState === 'exercise' && item && (item.duration === undefined || item.duration === null)) {
                    handleItemCompletion();
                }
            });
            skipBtn?.addEventListener('click', () => { initAudioContext(); if (isWorkoutActive) handleItemCompletion(); });
            prevBtn?.addEventListener('click', () => { initAudioContext(); handlePreviousClick(); });
            finishBtn?.addEventListener('click', () => { initAudioContext(); forceFinishWorkout(); });
            resetBtn?.addEventListener('click', () => { initAudioContext(); resetCurrentWorkout(); });
            editProgramBtn?.addEventListener('click', toggleEditMode);
            homeSection?.addEventListener('click', handleHomeInteraction);
            signInButton?.addEventListener('click', handleAuthClick);
            finishSummaryBtn?.addEventListener('click', finishSummary);
            summaryItemsList?.addEventListener('click', handleSummaryControls);
            document.addEventListener('click', (e) => { if (!e.target.closest('.resistance-selector')) { document.querySelectorAll('.resistance-selector.open').forEach(el => el.classList.remove('open')); }});
            document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'hidden' && isWorkoutActive) saveInProgressState(); });
            window.addEventListener('beforeunload', () => { if (isWorkoutActive) saveInProgressState(); });
        }

        function handleHomeInteraction(e) {
            const card = e.target.closest('.session-card-large');
            const prevMonthBtn = e.target.closest('.prev-month');
            const nextMonthBtn = e.target.closest('.next-month');
            const deleteCalendarBtn = e.target.closest('.delete-workout-btn');
            const deleteRecentBtn = e.target.closest('.delete-recent-workout-btn');

            if (deleteCalendarBtn) {
                e.stopPropagation();
                const date = deleteCalendarBtn.dataset.date;
                const formattedDate = new Date(date + 'T00:00:00').toLocaleDateString('fr-FR', {day: '2-digit', month: 'long'});
                if (confirm(`Voulez-vous vraiment supprimer TOUTES les séances du ${formattedDate} ?`)) {
                    deleteWorkoutsByDay(date);
                }
            } else if (deleteRecentBtn) {
                e.stopPropagation();
                const isoDate = deleteRecentBtn.dataset.dateIso;
                const workoutToDelete = workoutHistory.find(h => h.date === isoDate);
                if (workoutToDelete && confirm(`Voulez-vous vraiment supprimer la séance "${workoutToDelete.type}" du ${new Date(isoDate+'T00:00:00').toLocaleDateString('fr-FR')} ?`)) {
                    deleteSingleWorkoutFromHistory(isoDate);
                }
            } else if (card) {
                initAudioContext();
                if (isEditMode) {
                    populateAndShowSummary({mode: 'edit', sessionName: card.dataset.sessionName});
                } else {
                    loadSession(card.dataset.sessionName);
                }
            } else if (prevMonthBtn) {
                displayedCalendarDate.setMonth(displayedCalendarDate.getMonth() - 1);
                document.getElementById('consistency-module')?.replaceWith(renderConsistencyCalendarModule(displayedCalendarDate));
            } else if (nextMonthBtn) {
                displayedCalendarDate.setMonth(displayedCalendarDate.getMonth() + 1);
                document.getElementById('consistency-module')?.replaceWith(renderConsistencyCalendarModule(displayedCalendarDate));
            }
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            editProgramBtn.classList.toggle('active', isEditMode);
            showMessage(isEditMode ? "Mode édition activé. Cliquez sur une séance pour la modifier." : "Mode édition désactivé.", 3000);
            document.querySelectorAll('.session-card-large').forEach(card => {
                card.classList.toggle('edit-mode-active', isEditMode);
            });
        }
        
        function handleSummaryControls(e) {
            const stepperBtn = e.target.closest('.stepper-btn');
            const resistanceSelect = e.target.closest('.selected-resistance');
            const resistanceOption = e.target.closest('.resistance-options li');
            const trackingToggle = e.target.closest('.tracking-type-toggle button');

            if (stepperBtn) {
                const stepperControl = stepperBtn.closest('.stepper-control');
                const valueEl = stepperControl.querySelector('.stepper-value');
                if (!valueEl) return;
                
                let value = parseFloat(valueEl.textContent);
                const type = stepperControl.dataset.type;
                const isPlus = stepperBtn.classList.contains('stepper-plus');
                
                // MODIFICATION: Step de 0.1 pour le poids, 1 pour le reste
                const step = (type === 'weight') ? 0.1 : 1;
                
                value = isPlus ? value + step : Math.max(0, value - step);
                
                // MODIFICATION: Arrondi pour éviter les erreurs de virgule flottante
                if (type === 'weight') {
                    value = Math.round(value * 10) / 10;
                    valueEl.textContent = value.toFixed(1).replace(/\.0$/, '');
                } else {
                    valueEl.textContent = value;
                }

            } else if (resistanceSelect) {
                const selector = resistanceSelect.closest('.resistance-selector');
                document.querySelectorAll('.resistance-selector.open').forEach(el => { if(el !== selector) el.classList.remove('open'); });
                selector.classList.toggle('open');
            } else if (resistanceOption) {
                const selector = resistanceOption.closest('.resistance-selector');
                const value = resistanceOption.dataset.value;
                selector.dataset.type = value;
                selector.querySelector('.selected-resistance span').textContent = resistanceTypes[value].emoji;
                selector.classList.remove('open');
                const weightStepper = selector.closest('.resistance-controls').querySelector('.resistance-value-stepper');
                weightStepper.style.display = ['poids', 'poids_elastique'].includes(value) ? 'flex' : 'none';
            } else if (trackingToggle) {
                const parent = trackingToggle.parentElement;
                parent.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                trackingToggle.classList.add('active');

                const summaryItem = trackingToggle.closest('.summary-item');
                const newType = trackingToggle.dataset.value;
                const isTimed = newType === 'time';
                
                summaryItem.querySelector('[data-field="performance-and-base"] label').textContent = `Performance / Prochaine Base (${isTimed ? 'secondes' : 'répétitions'})`;
            }
        }

    </script>
</body>
</html>
