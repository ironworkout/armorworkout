<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArmorWorkout - Ultimate Fixed</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚡</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color-dark: #030712; 
            --secondary-bg-color-dark: #0B132B; 
            --primary-text-color-dark: #F0F4F8; 
            --secondary-text-color-dark: #A0AEC0; 
            --border-color-dark: #1E293B; 
            --electric-blue: #00BFFF; --electric-cyan: #22D3EE; --electric-blue-light: #4D94FF; 
            --electric-blue-rgb: 0, 191, 255; --electric-cyan-rgb: 34, 211, 238;
            --neon-pink: #FF1493; --neon-purple: #9400D3; --neon-green: #39FF14; --neon-red: #FF3131; --neon-yellow: #FFF01F;
            --neon-green-rgb: 57, 255, 20; --neon-red-rgb: 255, 49, 49; --neon-yellow-rgb: 255, 240, 31;
            --font-family-main: 'Inter', sans-serif; --font-family-timer: 'Orbitron', sans-serif;
            --bg-color: var(--bg-color-dark); --input-bg: #1A202C;
            --theme-color: var(--electric-cyan);
            --reactor-speed: 12s;
        }
        /* Ligues */
        body.league-1 { --theme-color: #CD7F32; } body.league-2 { --theme-color: #C0C0C0; } body.league-3 { --theme-color: #FFD700; }
        body.league-4 { --theme-color: #E5E4E2; } body.league-5 { --theme-color: #B9F2FF; } body.league-6 { --theme-color: #9400D3; }
        body.league-7 { --theme-color: #FF0000; } body.league-8 { --theme-color: #FF1493; } body.league-9 { --theme-color: #00FF00; }
        body.league-10 { --theme-color: #FFFFFF; }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-family-main); background-color: var(--bg-color); color: var(--primary-text-color-dark); min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden; background-image: radial-gradient(ellipse at center, rgba(var(--electric-blue-rgb), 0.08) 0%, transparent 60%); }
        
        /* Layout */
        .container { max-width: 1200px; margin: 0 auto; padding: 30px 25px; width: 100%; flex-grow: 1; display: flex; flex-direction: column; }
        header { padding: 15px 0; background-color: rgba(11, 19, 43, 0.8); backdrop-filter: blur(8px); border-bottom: 1px solid rgba(0, 191, 255, 0.3); position: sticky; top:0; z-index: 1000; }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; padding: 0 25px; }
        header h1 { font-family: var(--font-family-timer); font-size: 1.5em; display: flex; align-items: center; gap: 10px; }
        header h1 i { color: var(--electric-cyan); }
        .header-actions { display: flex; gap: 10px; }
        #signin-button, #drive-status-text { background: transparent; border: 1px solid var(--border-color-dark); color: var(--secondary-text-color-dark); padding: 5px 12px; border-radius: 8px; cursor: pointer; display: inline-flex; align-items: center; gap:5px; }
        #drive-status.success #drive-status-text { border-color: var(--neon-green); color: var(--neon-green); }
        body.logged-in #signin-button { display: none; }
        body.logged-out #drive-status { display: none; }

        /* Sections */
        .app-section { animation: fadeIn 0.5s ease-out; width: 100%; }
        .section-hidden { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Home Grid */
        .home-grid { display: flex; flex-wrap: wrap; gap: 30px; }
        .home-main-content { flex: 1 1 60%; min-width: 300px; display: flex; flex-direction: column; gap: 25px; }
        .home-sidebar { flex: 1 1 35%; min-width: 280px; display: flex; flex-direction: column; gap: 25px; }
        
        .sidebar-module, .session-card-large { background-color: rgba(11, 19, 43, 0.6); border: 1px solid rgba(0, 191, 255, 0.2); border-radius: 10px; padding: 20px; backdrop-filter: blur(10px); }
        .session-card-large { cursor: pointer; transition: transform 0.2s, border-color 0.2s; }
        .session-card-large:hover { transform: translateY(-3px); border-color: var(--electric-cyan); }
        .session-card-header h3 { font-family: var(--font-family-timer); color: var(--electric-cyan); font-size: 1.3em; margin-bottom: 5px; }
        
        /* Charts */
        .doughnut-chart-container { position: relative; height: 180px; width: 100%; display: flex; justify-content: center; margin-top: 10px; }
        .chart-area-container { height: 120px; width: 100%; margin-top: 20px; border-top: 1px solid var(--border-color-dark); padding-top: 15px; }
        .global-performance-chart-container { height: 250px; position: relative; margin-top: 15px; }

        /* Calendar */
        .monthly-calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; margin-top: 15px; }
        .calendar-header { font-size: 0.8em; color: var(--secondary-text-color-dark); }
        .calendar-day { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; margin: 0 auto; position: relative; font-size: 0.9em; border-radius: 50%; }
        .calendar-day.today { border: 1px solid var(--electric-cyan); color: var(--electric-cyan); }
        .day-dot { position: absolute; bottom: 4px; width: 4px; height: 4px; background-color: var(--electric-cyan); border-radius: 50%; }
        .delete-workout-btn { position: absolute; top: -5px; right: -5px; background: #000; color: var(--neon-red); border-radius: 50%; width: 16px; height: 16px; font-size: 10px; display: flex; align-items: center; justify-content: center; opacity: 0; cursor: pointer; }
        .calendar-day:hover .delete-workout-btn { opacity: 1; }

        /* Timer & Workout */
        .workout-section { text-align: center; }
        .timer-display { position: relative; width: 280px; height: 280px; margin: 0 auto; display: flex; justify-content: center; align-items: center; }
        .reactor { width: 180px; height: 180px; border-radius: 50%; position: relative; display: flex; align-items: center; justify-content: center; }
        /* Simplified Reactor Visuals for brevity but keeping structure */
        .reactor::before { content:''; position: absolute; inset: 0; border-radius: 50%; background: rgba(0,0,0,0.3); }
        .circle-1 { position: absolute; inset: 0; border-radius: 50%; border: 2px dashed var(--electric-cyan); animation: spin 10s linear infinite; }
        .triangle { position: absolute; width: 0; height: 0; border-left: 60px solid transparent; border-right: 60px solid transparent; border-top: 100px solid rgba(0, 191, 255, 0.3); top: 50px; }
        #time-left { position: absolute; z-index: 10; font-family: var(--font-family-timer); font-size: 3.5em; font-weight: 700; color: #fff; text-shadow: 0 0 10px var(--electric-cyan); }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .controls { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
        .controls button { background: rgba(11, 19, 43, 0.8); border: 1px solid var(--border-color-dark); color: #fff; padding: 10px 20px; border-radius: 8px; cursor: pointer; }
        .controls button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Summary Modal */
        .post-workout-summary { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 2000; display: none; align-items: center; justify-content: center; }
        .post-workout-summary.visible { display: flex; }
        .post-workout-summary-content { background: var(--secondary-bg-color-dark); width: 90%; max-width: 600px; max-height: 90vh; border-radius: 10px; border: 1px solid var(--border-color-dark); display: flex; flex-direction: column; }
        .summary-items-list { overflow-y: auto; padding: 20px; }
        .summary-item { background: rgba(0,0,0,0.2); padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 4px solid var(--electric-blue); }
        .vibranium-mastered { border-color: var(--neon-purple); background: linear-gradient(90deg, rgba(148,0,211,0.1), transparent); }
        .badge-vibranium { color: #FFD700; font-weight: bold; font-size: 0.8em; display: block; margin-bottom: 5px; }
        
        .fields-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .input-group label { display: block; font-size: 0.8em; color: var(--secondary-text-color-dark); margin-bottom: 4px; }
        .stepper-control { display: flex; background: #1A202C; border-radius: 5px; overflow: hidden; border: 1px solid var(--border-color-dark); }
        .stepper-btn { padding: 5px 10px; background: transparent; border: none; color: var(--electric-cyan); cursor: pointer; }
        .stepper-value { flex-grow: 1; text-align: center; color: #fff; line-height: 28px; }
        .goal-input { width: 100%; background: #1A202C; border: 1px solid var(--border-color-dark); color: #fff; padding: 5px; border-radius: 5px; }
        
        .summary-controls { padding: 20px; border-top: 1px solid var(--border-color-dark); text-align: center; }
        #finish-summary-btn { background: var(--neon-green); border: none; color: #000; font-weight: bold; padding: 12px 30px; border-radius: 8px; cursor: pointer; }

        /* Message */
        .message-area { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #1A202C; border: 1px solid var(--border-color-dark); padding: 10px 20px; border-radius: 8px; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 3000; }
        .message-area.visible { opacity: 1; }
    </style>
</head>
<body class="logged-out">

    <header>
        <div class="header-content">
            <h1><i class="fas fa-bolt"></i> ArmorWorkout</h1>
            <div class="header-actions">
                <div id="drive-status" style="display: none;"> 
                    <span id="drive-status-text">Connecté</span>
                </div>
                <button id="signin-button" disabled><i class="fab fa-google"></i> Se connecter</button>
            </div>
        </div>
    </header>

    <div class="container">
        <main>
            <!-- SECTION ACCUEIL -->
            <div id="home-section" class="app-section">
                <!-- Rempli par JS -->
            </div>

            <!-- SECTION WORKOUT -->
            <div id="workout-section" class="app-section section-hidden">
                <div class="timer-and-image-wrapper">
                    <div class="timer-display">
                        <div class="reactor">
                            <div class="circle-1"></div>
                            <div class="triangle"></div>
                            <div id="time-left">00:00</div>
                        </div>
                    </div>
                </div>
                <div class="workout-info">
                    <div id="current-exercise-name-display" style="font-size:1.5em; margin-bottom:10px;">Prêt ?</div>
                    <div id="current-exercise-container"></div>
                </div>
                <div class="controls">
                    <button id="prev-btn">Précédent</button>
                    <button id="start-pause-btn">Démarrer</button>
                    <button id="skip-btn">Suivant</button>
                    <button id="finish-btn" style="border-color:var(--neon-red); color:var(--neon-red);">Finir</button>
                </div>
            </div>
        </main>
    </div>

    <div id="message-area" class="message-area"></div>

    <!-- MODAL RESUME -->
    <div id="post-workout-summary" class="post-workout-summary">
        <div class="post-workout-summary-content">
            <h2 style="padding:15px; text-align:center; border-bottom:1px solid #333; color:var(--electric-cyan);">Résumé & Objectifs</h2>
            <ul id="summary-items-list" class="summary-items-list"></ul>
            <div class="summary-controls">
                <button id="finish-summary-btn">Sauvegarder</button>
            </div>
        </div>
    </div>

    <!-- Google Identity Services -->
    <script async defer src="https://accounts.google.com/gsi/client"></script>
    
    <script>
        "use strict";

        // --- CONFIGURATION ---
        const GOOGLE_CLIENT_ID = "731283926358-viam3ulpgna14flfdeb9m92l8s620hoi.apps.googleusercontent.com";
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const HISTORY_FILE = "armorworkout_history.json";
        const PROGRAM_FILE = "programmeCompletHypertrophieElite_v1.json";
        
        // Programme par défaut VIDE pour éviter les conflits si Drive est vide au début
        const DEFAULT_PROGRAM = JSON.stringify({ "nom_programme": "Mon Programme", "sessions": [] });

        // --- ETAT GLOBAL ---
        let tokenClient;
        let accessToken = null;
        let loadedFullProgram = null;
        let workoutHistory = [];
        let historyFileId = null;
        let programFileId = null;
        
        // Timer State
        let currentSession = null;
        let currentPlan = [];
        let currentIndex = 0;
        let timeLeft = 0;
        let timerInterval = null;
        let isRunning = false;
        let currentState = 'idle'; // idle, preparing, exercise, break, finished

        // DOM Elements
        const homeSection = document.getElementById('home-section');
        const workoutSection = document.getElementById('workout-section');
        const timeLeftDisplay = document.getElementById('time-left');
        const exNameDisplay = document.getElementById('current-exercise-name-display');
        const exContainer = document.getElementById('current-exercise-container');
        const summaryModal = document.getElementById('post-workout-summary');
        const summaryList = document.getElementById('summary-items-list');
        const messageArea = document.getElementById('message-area');

        // --- 1. GOOGLE DRIVE & AUTH ---

        function gisInitInternal() {
            if(window.google && google.accounts.oauth2) {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: GOOGLE_CLIENT_ID,
                    scope: SCOPES,
                    callback: tokenCallback,
                });
                document.getElementById('signin-button').disabled = false;
                // Tentative connexion auto silencieuse
                try {
                    tokenClient.requestAccessToken({ prompt: 'none' });
                } catch(e) { console.log("Auto-login skipped"); }
            }
        }

        async function tokenCallback(resp) {
            if (resp.error) {
                if(resp.error !== 'interaction_required') console.error("Auth Error:", resp);
                return;
            }
            accessToken = resp.access_token;
            document.body.classList.add('logged-in');
            document.getElementById('drive-status').style.display = 'inline-flex';
            showMessage("Connecté à Drive ! Chargement...");
            
            await loadDataFromDrive();
            // Important: loadInProgressState est défini plus bas, donc accessible ici
            loadInProgressState();
            renderHomeScreen();
        }

        function handleAuthClick() {
            if(tokenClient) tokenClient.requestAccessToken({ prompt: 'consent' });
        }

        async function loadDataFromDrive() {
            // 1. History
            historyFileId = await findOrCreateFile(HISTORY_FILE, '[]');
            if(historyFileId) {
                const content = await readFile(historyFileId);
                workoutHistory = content ? JSON.parse(content) : [];
            }
            // 2. Program
            programFileId = await findOrCreateFile(PROGRAM_FILE, DEFAULT_PROGRAM);
            if(programFileId) {
                const content = await readFile(programFileId);
                loadedFullProgram = content ? JSON.parse(content) : { sessions: [] };
            }
        }

        async function findOrCreateFile(name, defaultContent) {
            if(!accessToken) return null;
            const q = `name='${name}' and trashed=false`;
            try {
                const search = await fetch(`https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}`, {
                    headers: { Authorization: `Bearer ${accessToken}` }
                });
                const data = await search.json();
                if(data.files && data.files.length > 0) return data.files[0].id;
                
                // Create
                const meta = { name: name, mimeType: 'application/json' };
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(meta)], { type: 'application/json' }));
                form.append('file', new Blob([defaultContent], { type: 'application/json' }));
                
                const create = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST', headers: { Authorization: `Bearer ${accessToken}` }, body: form
                });
                const res = await create.json();
                return res.id;
            } catch(e) { console.error(e); return null; }
        }

        async function readFile(fileId) {
            const res = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`, {
                headers: { Authorization: `Bearer ${accessToken}` }
            });
            if(!res.ok) return null;
            return await res.text();
        }

        async function saveToDrive(fileId, content) {
            if(!accessToken || !fileId) return;
            await fetch(`https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`, {
                method: 'PATCH',
                headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(content)
            });
        }

        // --- 2. LOGIC HELPERS (ELITE ENGINE) ---

        function parseEliteWeight(text) {
            if (!text || typeof text !== 'string') return 0;
            const numbers = text.match(/-?\d+(\.\d+)?/g);
            if (!numbers) return 0;
            return numbers.reduce((acc, curr) => acc + parseFloat(curr), 0);
        }

        function calculateScore(currW, targW, currR, targR) {
            // Textual target handling (e.g. "Debout")
            let wScore = 0;
            if(targW && isNaN(parseFloat(targW)) && targW.length > 2) {
                // Textual comparison
                const c = (currW||"").toLowerCase(); const t = (targW||"").toLowerCase();
                wScore = c.includes(t) ? 100 : 0;
            } else {
                // Numeric
                const c = parseEliteWeight(currW); const t = parseEliteWeight(targW) || 1; // avoid /0
                wScore = Math.min(100, (c/t)*100);
            }
            
            const cReps = parseFloat(currR)||0; const tReps = parseFloat(targR)||1;
            const rScore = Math.min(100, (cReps/tReps)*100);
            
            return (wScore + rScore) / 2;
        }

        // --- 3. STATE MANAGEMENT ---

        function saveInProgressState() {
            if(currentState === 'idle' || currentState === 'finished') {
                localStorage.removeItem('armorState'); return;
            }
            const state = { currentSession, currentPlan, currentIndex, timeLeft, currentState, startTime: Date.now() };
            localStorage.setItem('armorState', JSON.stringify(state));
        }

        function loadInProgressState() {
            const s = localStorage.getItem('armorState');
            if(s) {
                const state = JSON.parse(s);
                // Check if valid
                if(state.currentSession && state.currentPlan) {
                    currentSession = state.currentSession;
                    currentPlan = state.currentPlan;
                    currentIndex = state.currentIndex;
                    timeLeft = state.timeLeft;
                    currentState = state.currentState;
                    showMessage("Séance reprise");
                    renderWorkoutScreen();
                    if(currentState === 'exercise' || currentState === 'break' || currentState === 'preparing') startTimer();
                }
            }
        }

        // --- 4. UI RENDERERS (Defined BEFORE use) ---

        function showMessage(msg) {
            messageArea.textContent = msg;
            messageArea.classList.add('visible');
            setTimeout(() => messageArea.classList.remove('visible'), 3000);
        }

        // The specific missing function from your error log
        function renderConsistencyCalendarModule(date) {
            const div = document.createElement('div');
            div.className = 'sidebar-module';
            
            const streak = calculateStreak();
            const league = getLeague(streak);
            
            // Calendar Grid generation
            const year = date.getFullYear(); const month = date.getMonth();
            const daysInMonth = new Date(year, month+1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay(); // 0=Sun
            const offset = (firstDay + 6) % 7; // Mon start
            
            let gridHTML = '';
            for(let i=0; i<offset; i++) gridHTML += `<div></div>`;
            for(let d=1; d<=daysInMonth; d++) {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const hasWorkout = workoutHistory.some(h => h.date.startsWith(dateStr));
                const isToday = (new Date().toDateString() === new Date(year, month, d).toDateString());
                gridHTML += `<div class="calendar-day ${isToday?'today':''}">
                    ${d} ${hasWorkout ? '<span class="day-dot"></span><i class="delete-workout-btn fas fa-times" data-date="'+dateStr+'"></i>' : ''}
                </div>`;
            }

            div.innerHTML = `
                <h3><i class="fas fa-calendar"></i> Ligue ${league}</h3>
                <div class="consistency-info">
                    <div class="streak-counter"><i class="fas fa-fire"></i> ${streak} sem. consécutives</div>
                    <div id="doughnut-container" class="doughnut-chart-container">
                        <canvas id="consistency-chart"></canvas>
                    </div>
                    <div class="chart-area-container"><canvas id="area-chart"></canvas></div>
                </div>
                <div class="monthly-calendar">
                    <div class="calendar-header">L</div><div class="calendar-header">M</div><div class="calendar-header">M</div><div class="calendar-header">J</div><div class="calendar-header">V</div><div class="calendar-header">S</div><div class="calendar-header">D</div>
                    ${gridHTML}
                </div>
            `;
            
            // Render Charts after DOM insertion
            setTimeout(() => {
                // Doughnut
                new Chart(div.querySelector('#consistency-chart'), {
                    type: 'doughnut',
                    data: { labels: ['Fait', 'Reste'], datasets: [{ data: [1, 1], backgroundColor: ['#22D3EE', '#1A202C'], borderWidth:0 }] },
                    options: { cutout: '70%', plugins: { legend: {display:false} } }
                });
                // Area Chart
                renderAreaChart(div.querySelector('#area-chart'));
            }, 0);

            return div;
        }

        function renderAreaChart(canvas) {
            // Mock data or real history data
            const labels = workoutHistory.slice(-5).map(h => h.date.substring(5));
            const data = workoutHistory.slice(-5).map(h => 50 + Math.random()*50); // Mock power index for now
            new Chart(canvas, {
                type: 'line',
                data: {
                    labels: labels.length ? labels : ['Start'],
                    datasets: [{
                        data: data.length ? data : [0],
                        fill: true,
                        backgroundColor: 'rgba(57, 255, 20, 0.2)',
                        borderColor: '#39FF14',
                        tension: 0.4, pointRadius: 0
                    }]
                },
                options: { scales: { x:{display:false}, y:{display:false} }, plugins:{legend:{display:false}} }
            });
        }

        function renderRecentWorkoutsList() {
            const ul = document.createElement('ul');
            ul.className = 'recent-workouts-list';
            workoutHistory.slice(-3).reverse().forEach(h => {
                const li = document.createElement('li');
                li.innerHTML = `<div class="workout-info-text"><span class="workout-name">${h.type}</span><span class="workout-date">${h.date}</span></div>`;
                ul.appendChild(li);
            });
            return ul;
        }

        function renderRadarChart(canvas, sessionName) {
            const session = loadedFullProgram.sessions.find(s => s.nom_session === sessionName);
            if(!session) return;
            const exercises = session.exercices_et_pauses.filter(e => e.type === 'exercise');
            
            const labels = exercises.map(e => e.name.substring(0, 10));
            // Calculer score basé sur weight_text vs final_target_poids
            const data = exercises.map(e => calculateScore(e.weight_text, e.final_target_poids, e.reps, e.final_target_reps));

            new Chart(canvas, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Niveau',
                        data: data,
                        backgroundColor: 'rgba(0, 191, 255, 0.5)',
                        borderColor: '#00BFFF',
                        pointBackgroundColor: '#fff'
                    }, {
                        label: 'Cible',
                        data: Array(labels.length).fill(100),
                        borderColor: '#FFD700',
                        borderDash: [5,5],
                        fill: false, pointRadius: 0
                    }]
                },
                options: {
                    scales: { r: { min: 0, max: 100, ticks: {display:false}, grid: {color:'rgba(255,255,255,0.1)'} } },
                    plugins: { legend: {display:false} }
                }
            });
        }

        function renderHomeScreen() {
            homeSection.innerHTML = '';
            homeSection.classList.remove('section-hidden');
            workoutSection.classList.add('section-hidden');

            const grid = document.createElement('div'); grid.className = 'home-grid';
            
            // Sidebar
            const sidebar = document.createElement('div'); sidebar.className = 'home-sidebar';
            sidebar.appendChild(renderConsistencyCalendarModule(new Date()));
            const recent = document.createElement('div'); recent.className = 'sidebar-module';
            recent.innerHTML = '<h3><i class="fas fa-history"></i> Récent</h3>';
            recent.appendChild(renderRecentWorkoutsList());
            sidebar.appendChild(recent);

            // Main Content
            const main = document.createElement('div'); main.className = 'home-main-content';
            
            if(loadedFullProgram && loadedFullProgram.sessions) {
                loadedFullProgram.sessions.forEach(s => {
                    const card = document.createElement('div');
                    card.className = 'session-card-large';
                    card.innerHTML = `
                        <div class="session-card-header"><h3>${s.nom_session}</h3></div>
                        <p>${s.description_session || '...'}</p>
                        <div class="global-performance-chart-container">
                            <canvas id="radar-${s.nom_session.replace(/\s/g,'')}"></canvas>
                        </div>
                    `;
                    card.onclick = () => loadSession(s.nom_session);
                    main.appendChild(card);
                    
                    setTimeout(() => renderRadarChart(document.getElementById(`radar-${s.nom_session.replace(/\s/g,'')}`), s.nom_session), 0);
                });
            } else {
                main.innerHTML = '<div class="sidebar-module">Aucun programme trouvé.</div>';
            }

            grid.appendChild(main);
            grid.appendChild(sidebar);
            homeSection.appendChild(grid);
        }

        // --- 5. WORKOUT LOGIC ---

        function loadSession(name) {
            const s = loadedFullProgram.sessions.find(x => x.nom_session === name);
            if(!s) return;
            currentSession = s.nom_session;
            currentPlan = JSON.parse(JSON.stringify(s.exercices_et_pauses));
            currentIndex = 0;
            timeLeft = 0;
            currentState = 'preparing';
            renderWorkoutScreen();
            startTimer();
        }

        function renderWorkoutScreen() {
            homeSection.classList.add('section-hidden');
            workoutSection.classList.remove('section-hidden');
            updateUI();
        }

        function updateUI() {
            const item = currentPlan[currentIndex];
            if(!item) return finishWorkout();

            exNameDisplay.textContent = item.name || item.type;
            
            // Info display
            if(item.type === 'exercise') {
                exContainer.innerHTML = `
                    <div style="font-size:2em; color:var(--electric-blue); font-weight:bold;">${item.reps} Reps</div>
                    <div style="color:#aaa;">${item.weight_text || ''}</div>
                    <div style="font-size:0.8em; margin-top:5px; color:var(--neon-purple);">Cible: ${item.final_target_reps} x ${item.final_target_poids}</div>
                `;
            } else {
                exContainer.innerHTML = `<div style="font-size:1.5em; color:var(--electric-cyan);">Repos</div>`;
            }

            // Time
            timeLeftDisplay.textContent = formatTime(timeLeft);
        }

        function startTimer() {
            clearInterval(timerInterval);
            const item = currentPlan[currentIndex];
            if(currentState === 'preparing') timeLeft = 5;
            else if(item.duration) timeLeft = item.duration;
            else timeLeft = 0; // Untimed exercise

            isRunning = true;
            updateUI();

            if(timeLeft > 0) {
                timerInterval = setInterval(() => {
                    timeLeft--;
                    timeLeftDisplay.textContent = formatTime(timeLeft);
                    if(timeLeft <= 0) nextStep();
                }, 1000);
            }
        }

        function nextStep() {
            clearInterval(timerInterval);
            currentIndex++;
            if(currentIndex >= currentPlan.length) {
                finishWorkout();
            } else {
                const item = currentPlan[currentIndex];
                currentState = item.type === 'break' ? 'break' : 'exercise';
                startTimer();
            }
            saveInProgressState();
        }

        function finishWorkout() {
            currentState = 'finished';
            saveInProgressState(); // Will clear it
            showSummary();
        }

        // --- 6. SUMMARY & EDITING ---

        function showSummary() {
            summaryList.innerHTML = '';
            currentPlan.forEach((item, idx) => {
                if(item.type === 'exercise') {
                    const li = document.createElement('li');
                    li.className = 'summary-item';
                    
                    // Check Vibranium
                    const score = calculateScore(item.weight_text, item.final_target_poids, item.reps, item.final_target_reps);
                    const badge = score >= 100 ? '<span class="badge-vibranium"><i class="fas fa-star"></i> VIBRANIUM</span>' : '';
                    if(score >= 100) li.classList.add('vibranium-mastered');

                    li.innerHTML = `
                        ${badge}
                        <div class="exercise-name">${item.name}</div>
                        <div class="fields-grid">
                            <div class="input-group">
                                <label>Fait (Reps)</label>
                                <div class="stepper-control">
                                    <button class="stepper-btn" onclick="adjVal(${idx}, 'reps', -1)">-</button>
                                    <span class="stepper-value" id="val-reps-${idx}">${item.reps}</span>
                                    <button class="stepper-btn" onclick="adjVal(${idx}, 'reps', 1)">+</button>
                                </div>
                            </div>
                            <div class="input-group">
                                <label>Cible Future (Poids/Txt)</label>
                                <input class="goal-input" id="goal-w-${idx}" value="${item.final_target_poids||''}" onchange="updateGoal(${idx}, 'weight', this.value)">
                            </div>
                        </div>
                    `;
                    summaryList.appendChild(li);
                }
            });
            summaryModal.classList.add('visible');
        }

        // Global exposing for inline onclicks (simple pattern)
        window.adjVal = function(idx, field, delta) {
            const item = currentPlan[idx];
            if(field === 'reps') item.reps = (parseInt(item.reps)||0) + delta;
            document.getElementById(`val-reps-${idx}`).textContent = item.reps;
        };
        window.updateGoal = function(idx, type, val) {
            if(type === 'weight') currentPlan[idx].final_target_poids = val;
        };

        document.getElementById('finish-summary-btn').onclick = async () => {
            // Save logic
            const date = new Date().toISOString().split('T')[0];
            const log = { date: date, type: currentSession, exercises: currentPlan.filter(e=>e.type==='exercise') };
            workoutHistory.push(log);
            
            // Update Program File (save new targets)
            const sessionIdx = loadedFullProgram.sessions.findIndex(s => s.nom_session === currentSession);
            if(sessionIdx > -1) {
                loadedFullProgram.sessions[sessionIdx].exercices_et_pauses = currentPlan; // Save updated structure
            }

            showMessage("Sauvegarde...");
            await saveToDrive(historyFileId, workoutHistory);
            await saveToDrive(programFileId, loadedFullProgram);
            
            summaryModal.classList.remove('visible');
            currentState = 'idle';
            renderHomeScreen();
        };

        // --- UTILS ---
        function calculateStreak() { return workoutHistory.length ? 1 : 0; } // Simplified
        function getLeague(s) { return "Bronze"; }
        function formatTime(s) {
            const m = Math.floor(s/60); const sec = s%60;
            return `${m}:${sec<10?'0':''}${sec}`;
        }

        // Event Listeners
        document.getElementById('signin-button').onclick = handleAuthClick;
        document.getElementById('start-pause-btn').onclick = () => {
            if(isRunning) { clearInterval(timerInterval); isRunning=false; }
            else startTimer();
        };
        document.getElementById('skip-btn').onclick = nextStep;
        document.getElementById('prev-btn').onclick = () => {
            if(currentIndex>0) { currentIndex--; startTimer(); }
        };
        document.getElementById('finish-btn').onclick = finishWorkout;

        // Init
        window.onload = () => {
            checkAndInitGis();
            // Try to restore state if reload
            loadInProgressState();
        };

    </script>
</body>
</html>
  
