  <!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArmorWorkout - Intelligence Athl√©tique</title>
    <!-- Favicon vide pour √©viter l'erreur 404 -->
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* --- COULEURS DYNAMIQUES (LIGUES) --- */
            /* Sera modifi√© par JS selon la ligue (Bois -> Vibranium) */
            --theme-color: #22D3EE; 
            --theme-rgb: 34, 211, 238;
            --reactor-speed: 10s; 
            --glow-intensity: 0.5;

            /* --- BASE --- */
            --bg-dark: #030712; 
            --bg-panel: #0B132B; 
            --text-main: #F0F4F8; 
            --text-muted: #A0AEC0; 
            --border: #1E293B; 
            
            /* --- STATUS --- */
            --neon-green: #39FF14; 
            --neon-red: #FF3131; 
            --neon-yellow: #FFF01F; 
            
            /* --- CONFIG --- */
            --font-main: 'Inter', sans-serif;
            --font-tech: 'Orbitron', sans-serif;
            --radius: 12px;
        }

        /* --- ANIMATIONS GLOBALES --- */
        @keyframes pulse-theme { 0%, 100% { box-shadow: 0 0 10px rgba(var(--theme-rgb), 0.2); } 50% { box-shadow: 0 0 25px rgba(var(--theme-rgb), 0.6); } }
        @keyframes rotate-right { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }
        @keyframes rotate-left { from { transform: translate(-50%, -50%) rotate(360deg); } to { transform: translate(-50%, -50%) rotate(0deg); } }
        @keyframes rotate-slow { 0% { transform: rotate(-5deg); } 50% { transform: rotate(5deg); } 100% { transform: rotate(-5deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- RESET & LAYOUT --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--font-main); background-color: var(--bg-dark); color: var(--text-main);
            min-height: 100vh; overflow-x: hidden; display: flex; flex-direction: column;
            background-image: radial-gradient(circle at 50% 0%, rgba(var(--theme-rgb), 0.15) 0%, transparent 70%), linear-gradient(0deg, #020617 0%, #0f172a 100%);
            transition: background-image 1s ease;
        }
        
        /* Grille de fond */
        body::before { 
            content: ""; position: fixed; inset: 0; pointer-events: none; z-index: -1;
            background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 40px 40px; 
        }

        /* Mode Workout : Immersion totale */
        body.workout-active header, body.workout-active footer { transform: translateY(-100%); opacity: 0; visibility: hidden; transition: 0.5s; position: absolute; }
        body.workout-active .app-section:not(#workout-section) { display: none; }
        body.workout-active #workout-section { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; width: 100%; flex-grow: 1; }

        /* --- HEADER --- */
        header {
            padding: 15px 0; background: rgba(11, 19, 43, 0.8); backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(var(--theme-rgb), 0.3); position: sticky; top: 0; z-index: 100;
            transition: border-color 1s ease;
        }
        .header-content { display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        header h1 { font-family: var(--font-tech); font-size: 1.5em; letter-spacing: 2px; text-shadow: 0 0 10px rgba(var(--theme-rgb), 0.5); display: flex; gap: 10px; align-items: center; }
        header h1 i { color: var(--theme-color); }

        #signin-button { 
            background: transparent; border: 1px solid var(--theme-color); color: var(--theme-color);
            padding: 8px 18px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s;
            font-family: var(--font-tech); display: flex; align-items: center; gap: 8px;
        }
        #signin-button:hover { background: rgba(var(--theme-rgb), 0.15); box-shadow: 0 0 15px var(--theme-color); }
        #signin-button:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }
        
        #drive-status { display: none; align-items: center; gap: 8px; color: var(--neon-green); font-family: var(--font-tech); font-size: 0.9em; }
        body.logged-in #drive-status { display: flex; }
        body.logged-in #signin-button { display: none; }

        /* --- HOME GRID --- */
        .home-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-top: 20px; animation: fadeIn 0.8s ease-out; }
        @media (max-width: 900px) { .home-grid { grid-template-columns: 1fr; } }

        /* Cards */
        .session-card {
            background: rgba(30, 41, 59, 0.5); border: 1px solid var(--border);
            padding: 25px; border-radius: var(--radius); cursor: pointer; transition: 0.3s;
            position: relative; overflow: hidden; margin-bottom: 20px;
        }
        .session-card:hover { 
            border-color: var(--theme-color); transform: translateY(-4px); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5), inset 0 0 20px rgba(var(--theme-rgb), 0.1); 
        }
        .session-card h3 { font-family: var(--font-tech); color: var(--theme-color); font-size: 1.4em; margin-bottom: 8px; }
        .session-card p { color: var(--text-muted); font-size: 0.95em; line-height: 1.5; }
        .session-card .meta { margin-top: 15px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; opacity: 0.8; }

        /* Sidebar Modules */
        .sidebar-module {
            background: rgba(15, 23, 42, 0.7); border: 1px solid var(--border);
            padding: 20px; border-radius: var(--radius); margin-bottom: 20px;
        }
        .sidebar-module h3 { font-family: var(--font-tech); font-size: 1em; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 15px; color: #fff; }

        /* League Badge */
        .league-badge { text-align: center; padding: 10px; }
        .league-icon { font-size: 4em; color: var(--theme-color); margin-bottom: 10px; filter: drop-shadow(0 0 15px rgba(var(--theme-rgb), 0.8)); animation: rotate-slow 4s infinite ease-in-out; }
        .league-name { font-family: var(--font-tech); font-weight: 900; font-size: 1.4em; text-transform: uppercase; color: var(--theme-color); letter-spacing: 1px; }
        
        /* Calendrier (Restored Rich UI) */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; font-size: 0.8em; margin-top: 10px; }
        .cal-day { padding: 5px 0; border-radius: 4px; color: var(--text-muted); position: relative; }
        .cal-day.today { border: 1px solid var(--theme-color); color: #fff; font-weight: bold; }
        .cal-day.active { background: rgba(var(--theme-rgb), 0.2); color: #fff; box-shadow: 0 0 5px rgba(var(--theme-rgb), 0.3); }
        .cal-day.active::after { content: ''; position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); width: 4px; height: 4px; background: var(--theme-color); border-radius: 50%; box-shadow: 0 0 5px var(--theme-color); }

        /* --- ARC REACTOR (THE 2K LINES CORE RESTORED) --- */
        .timer-display { position: relative; width: 300px; height: 300px; margin: 0 auto 40px; display: flex; align-items: center; justify-content: center; }
        
        .reactor { position: relative; width: 200px; height: 200px; display: flex; align-items: center; justify-content: center; border-radius: 50%; z-index: 10; }
        
        /* Couches multiples pour l'effet de profondeur */
        .circle-1 { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 1px solid rgba(var(--theme-rgb), 0.3); animation: rotate-right var(--reactor-speed) linear infinite; }
        .circle-2 { position: absolute; width: 90%; height: 90%; border-radius: 50%; border: 5px solid var(--theme-color); border-top-color: transparent; border-bottom-color: transparent; animation: rotate-left 5s linear infinite; box-shadow: 0 0 15px rgba(var(--theme-rgb), 0.5); }
        .circle-3 { position: absolute; width: 80%; height: 80%; border-radius: 50%; border: 2px dashed rgba(var(--theme-rgb), 0.6); animation: rotate-right 12s linear infinite; }
        .circle-4 { position: absolute; width: 60%; height: 60%; border-radius: 50%; background: radial-gradient(circle, rgba(var(--theme-rgb), 0.2) 0%, transparent 70%); animation: pulse-theme 2s infinite; }
        
        .triangle { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 160px; height: 160px; 
            background: var(--theme-color); clip-path: polygon(50% 0%, 0% 100%, 100% 100%); 
            opacity: 0.15; animation: rotate-right var(--reactor-speed) linear infinite; z-index: 1;
        }

        #time-left { 
            position: relative; z-index: 20; font-family: var(--font-tech); font-size: 3.8em; font-weight: 700; color: #fff;
            text-shadow: 0 0 15px rgba(var(--theme-rgb), 0.8); 
        }

        /* Barre de progression circulaire (SVG) */
        .timer-svg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-90deg); width: 280px; height: 280px; pointer-events: none; }
        .timer-track { fill: none; stroke: rgba(255,255,255,0.05); stroke-width: 4; }
        .timer-fill { fill: none; stroke: var(--theme-color); stroke-width: 4; stroke-linecap: round; transition: stroke-dashoffset 1s linear; filter: drop-shadow(0 0 5px var(--theme-color)); }

        /* --- WORKOUT INFO --- */
        .workout-info { text-align: center; margin-bottom: 30px; width: 100%; }
        #ex-name { font-family: var(--font-tech); font-size: 1.6em; color: var(--theme-color); margin-bottom: 10px; text-shadow: 0 0 10px rgba(var(--theme-rgb), 0.3); }
        
        .ex-stats { 
            background: rgba(15, 23, 42, 0.8); border: 1px solid var(--border); border-left: 4px solid var(--theme-color);
            padding: 15px 30px; border-radius: 8px; display: inline-flex; gap: 30px; align-items: center; 
            font-family: var(--font-tech); font-size: 1.3em; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .ex-stats span i { color: var(--theme-color); margin-right: 8px; font-size: 0.8em; }

        /* --- CONTROLS --- */
        .controls { display: flex; justify-content: center; gap: 15px; width: 100%; flex-wrap: wrap; }
        .btn-ctrl {
            background: rgba(30, 41, 59, 0.6); border: 1px solid var(--border); color: var(--text-muted);
            padding: 15px 25px; border-radius: 8px; font-family: var(--font-tech); cursor: pointer; transition: 0.2s;
            display: flex; align-items: center; gap: 8px; min-width: 120px; justify-content: center;
        }
        .btn-ctrl:hover:not(:disabled) { border-color: var(--theme-color); color: #fff; background: rgba(var(--theme-rgb), 0.1); transform: translateY(-2px); }
        .btn-ctrl:disabled { opacity: 0.5; cursor: not-allowed; }
        
        #btn-main { 
            background: var(--theme-color); color: #000; border: none; font-weight: 900; 
            box-shadow: 0 0 20px rgba(var(--theme-rgb), 0.4); min-width: 160px;
        }
        #btn-main:hover { box-shadow: 0 0 30px rgba(var(--theme-rgb), 0.7); transform: scale(1.05); }

        /* --- SUMMARY & MODALS --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000;
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px);
        }
        .modal-overlay.visible { display: flex; animation: fadeIn 0.3s ease-out; }
        
        .modal-content {
            background: var(--bg-panel); width: 95%; max-width: 600px; max-height: 90vh; overflow-y: auto;
            border: 1px solid var(--theme-color); border-radius: var(--radius); padding: 25px;
            box-shadow: 0 0 40px rgba(var(--theme-rgb), 0.2);
        }
        
        .summary-item {
            background: rgba(255,255,255,0.03); margin-bottom: 12px; padding: 15px; border-radius: 8px;
            border-left: 3px solid var(--theme-color);
        }
        .summary-row { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; gap: 10px; }
        
        .stepper { display: flex; align-items: center; background: #020617; border: 1px solid var(--border); border-radius: 6px; padding: 2px; }
        .stepper button { background: none; border: none; color: var(--theme-color); width: 30px; height: 30px; cursor: pointer; font-size: 1.2em; }
        .stepper span { font-family: var(--font-tech); font-weight: bold; width: 45px; text-align: center; font-size: 0.9em; }
        
        .btn-finish { width: 100%; padding: 15px; margin-top: 20px; background: var(--neon-green); color: #000; border: none; border-radius: 8px; font-weight: 900; font-family: var(--font-tech); cursor: pointer; }

        /* --- NOTIFICATIONS --- */
        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: #fff; padding: 12px 24px; border-radius: 50px;
            border: 1px solid var(--theme-color); box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            font-weight: 500; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 9999;
            display: flex; align-items: center; gap: 10px;
        }
        .toast.visible { opacity: 1; bottom: 40px; }

        footer { padding: 30px; text-align: center; color: var(--text-muted); font-size: 0.8em; border-top: 1px solid var(--border); margin-top: 40px; }
        
        @media (max-width: 480px) {
            .timer-display { width: 260px; height: 260px; } 
            .reactor { width: 170px; height: 170px; }
            .timer-svg { width: 240px; height: 240px; }
            #time-left { font-size: 3em; }
        }
    </style>
</head>
<body class="logged-out state-idle">

    <header>
        <div class="header-content">
            <h1><i class="fas fa-shield-alt"></i> ARMOR<span>WORKOUT</span></h1>
            <div style="display:flex; gap:15px; align-items:center;">
                <button id="edit-mode-btn" style="background:none; border:none; color:var(--text-muted); cursor:pointer;"><i class="fas fa-pen"></i></button>
                <div id="drive-status"><i class="fas fa-check-circle"></i> SYNC</div>
                <button id="signin-button"><i class="fab fa-google"></i> CONNEXION</button>
            </div>
        </div>
    </header>

    <div class="container">
        <main>
            <!-- SECTION ACCUEIL -->
            <div id="home-section" class="app-section">
                <div class="home-grid">
                    <!-- Colonne Principale: S√©ances -->
                    <div id="session-cards-container">
                        <div style="text-align:center; padding:40px; opacity:0.5;">
                            <i class="fas fa-circle-notch fa-spin" style="font-size:2em; margin-bottom:10px;"></i><br>
                            Initialisation du syst√®me...
                        </div>
                    </div>

                    <!-- Colonne Lat√©rale: Stats & Ligue -->
                    <div class="home-sidebar">
                        <!-- Badge Ligue -->
                        <div class="sidebar-module" style="text-align:center; border-color:var(--theme-color); box-shadow:0 0 20px rgba(var(--theme-rgb), 0.1);">
                            <div class="league-badge" id="league-display">
                                <!-- G√©n√©r√© par JS -->
                            </div>
                        </div>

                        <!-- Calendrier Assiduit√© -->
                        <div class="sidebar-module">
                            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                                <h3><i class="far fa-calendar-alt"></i> CIBLE</h3>
                                <span id="weekly-goal-txt" style="font-family:var(--font-tech); color:var(--theme-color)">0 / 2</span>
                            </div>
                            <div style="height:6px; background:var(--bg-dark); border-radius:3px; overflow:hidden; margin-bottom:15px;">
                                <div id="weekly-progress" style="height:100%; width:0%; background:var(--theme-color); transition:1s;"></div>
                            </div>
                            <div class="calendar-grid" id="calendar-grid">
                                <!-- G√©n√©r√© par JS -->
                            </div>
                        </div>

                        <!-- Historique -->
                        <div class="sidebar-module">
                            <h3><i class="fas fa-history"></i> LOGS R√âCENTS</h3>
                            <ul id="history-list" style="list-style:none; font-size:0.9em; opacity:0.8; padding:0;"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SECTION WORKOUT (ARC REACTOR) -->
            <div id="workout-section" class="app-section section-hidden">
                <div class="timer-display">
                    <!-- SVG Progress Ring -->
                    <svg class="timer-svg" viewBox="0 0 100 100">
                        <circle class="timer-track" cx="50" cy="50" r="45"></circle>
                        <circle id="timer-progress" class="timer-fill" cx="50" cy="50" r="45" stroke-dasharray="283" stroke-dashoffset="0"></circle>
                    </svg>
                    
                    <!-- HTML/CSS Reactor -->
                    <div class="reactor">
                        <div class="circle-1"></div>
                        <div class="circle-2"></div>
                        <div class="circle-3"></div>
                        <div class="circle-4"></div>
                        <div class="triangle"></div>
                        <div id="time-left">00:00</div>
                    </div>
                </div>

                <div class="workout-info">
                    <h2 id="ex-name" style="text-transform: uppercase;">-</h2>
                    <div id="ex-stats-container">
                        <!-- Rempli par JS -->
                    </div>
                    <p id="ex-details" style="margin-top:15px; opacity:0.7; font-size:0.9em; max-width:500px; margin-left:auto; margin-right:auto;">-</p>
                </div>

                <div class="controls">
                    <button class="btn-ctrl" id="prev-btn"><i class="fas fa-backward"></i></button>
                    <button class="btn-ctrl" id="btn-main">D√âMARRER</button>
                    <button class="btn-ctrl" id="skip-btn"><i class="fas fa-forward"></i></button>
                    <button class="btn-ctrl" id="quit-btn" style="color:var(--neon-red); border-color:rgba(255,49,49,0.3)"><i class="fas fa-times"></i></button>
                </div>
            </div>
        </main>
    </div>

    <!-- MODALE R√âSUM√â -->
    <div id="summary-modal" class="modal-overlay">
        <div class="modal-content">
            <div style="text-align:center; margin-bottom:20px; border-bottom:1px solid var(--border); padding-bottom:15px;">
                <h2 style="font-family:var(--font-tech); color:var(--theme-color)">RAPPORT DE MISSION</h2>
                <p style="font-size:0.9em; color:var(--text-muted)">Ajustez vos performances pour la prochaine fois.</p>
            </div>
            <div id="summary-list">
                <!-- Items g√©n√©r√©s par JS -->
            </div>
            <button id="save-btn" class="btn-finish">SYNCHRONISER & TERMINER</button>
        </div>
    </div>

    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="toast"><i class="fas fa-info-circle"></i> <span>Message info</span></div>

    <footer>
        <p>&copy; 2026 ARMORWORKOUT | Protocol Arc Reactor v5.0</p>
    </footer>

    <!-- GOOGLE IDENTITY SERVICES -->
    <script async defer src="https://accounts.google.com/gsi/client"></script>
    
    <script>
        "use strict";

        // =================================================================================
        // 1. CONSTANTES & CONFIGURATION
        // =================================================================================
        const CLIENT_ID = "731283926358-viam3ulpgna14flfdeb9m92l8s620hoi.apps.googleusercontent.com"; // TON ID
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        
        // Cibles Fichiers
        const FILE_PROG = "programme.json";
        const FILE_HIST = "armorworkout_history.json";
        
        // Param√®tres Gamification
        const WEEKLY_TARGET = 2;
        const LEAGUES = [
            { name: "Bois", min: 0, color: "#A0522D", speed: "12s" },
            { name: "Pierre", min: 2, color: "#78909C", speed: "10s" },
            { name: "Bronze", min: 4, color: "#CD7F32", speed: "9s" },
            { name: "Argent", min: 6, color: "#C0C0C0", speed: "8s" },
            { name: "Or", min: 8, color: "#FFD700", speed: "7s" },
            { name: "Platine", min: 12, color: "#E5E4E2", speed: "6s" },
            { name: "√âmeraude", min: 16, color: "#50C878", speed: "5s" },
            { name: "Rubis", min: 20, color: "#E0115F", speed: "4s" },
            { name: "Diamant", min: 26, color: "#B9F2FF", speed: "3s" },
            { name: "Vibranium", min: 32, color: "#FFFFFF", speed: "1s" }
        ];

        // Programme par d√©faut si fichier manquant (S√âCURIT√â)
        const DEFAULT_PROGRAM = {
            "nom_programme": "ROI V√äTU 2025 (Expert Edition)",
            "sessions": [
                {
                    "nom_session": "S√âANCE A : V-FRAME & TRICEPS",
                    "description_session": "Focus : Largeur d'√©paules et Remplissage des manches.",
                    "exercices_et_pauses": [
                        { "type": "exercise", "name": "D√©velopp√© Militaire Unilat√©ral (Band)", "reps": 10, "weight_text": "üü™ √âlastique 25kg", "details": "S√©rie 1/3. Mouvement Roi #1." },
                        { "type": "break", "duration": 90, "name": "Repos" },
                        { "type": "exercise", "name": "Superset A: Tirage Vertical", "reps": 14, "weight_text": "üü™ √âlastique 25kg", "details": "Largeur Dos (#5). Ancrage HAUT." }
                    ]
                },
                {
                    "nom_session": "S√âANCE B : THICKNESS & BICEPS",
                    "description_session": "Focus : √âpaisseur du dos, Pecs bomb√©s et Biceps.",
                    "exercices_et_pauses": [
                        { "type": "exercise", "name": "Pompes Classiques Lest√©es", "reps": 10, "weight_text": "üéí +8 kg", "details": "S√©rie 1/3. Pecs Global." },
                        { "type": "break", "duration": 90, "name": "Repos" }
                    ]
                }
            ]
        };

        // √âtat Global
        let accessToken = null;
        let tokenClient = null;
        let programData = null;
        let historyData = [];
        let programFileId = null;
        let historyFileId = null;
        
        // √âtat S√©ance
        let activePlan = [];
        let activeIdx = 0;
        let timer = null;
        let timeLeft = 0;
        let totalTime = 0;
        let isRunning = false;
        let currentSessionName = "";
        let isEditMode = false;

        // =================================================================================
        // 2. INITIALISATION ROBUSTE
        // =================================================================================
        document.addEventListener('DOMContentLoaded', () => {
            // Attendre que la lib Google soit charg√©e
            const checkGoogle = setInterval(() => {
                if (typeof google !== 'undefined' && google.accounts) {
                    clearInterval(checkGoogle);
                    initGis();
                }
            }, 200);

            // Interface par d√©faut
            updateTheme(LEAGUES[0]);
            renderHome(); 
            addEventListeners();
        });

        function addEventListeners() {
            document.getElementById('signin-button').onclick = () => tokenClient.requestAccessToken();
            document.getElementById('btn-main').onclick = toggleTimer;
            document.getElementById('skip-btn').onclick = () => navigate(1);
            document.getElementById('prev-btn').onclick = () => navigate(-1);
            document.getElementById('quit-btn').onclick = quitWorkout;
            document.getElementById('save-btn').onclick = finishWorkout;
            document.getElementById('edit-mode-btn').onclick = toggleEditMode;
            
            // D√©l√©gation Steppers
            document.getElementById('summary-list').addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
                const stepDiv = btn.closest('.stepper');
                const span = stepDiv.querySelector('span');
                let val = parseFloat(span.textContent);
                const isWeight = stepDiv.dataset.type === 'weight';
                const step = isWeight ? 0.5 : 1;
                
                if (btn.classList.contains('minus')) val = Math.max(0, val - step);
                else val += step;
                
                span.textContent = Number.isInteger(val) ? val : val.toFixed(1);
            });
        }

        function initGis() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: SCOPES,
                callback: async (resp) => {
                    if (resp.access_token) {
                        accessToken = resp.access_token;
                        document.body.classList.replace('logged-out', 'logged-in');
                        showToast("Connexion r√©ussie. Synchronisation...");
                        await syncDrive();
                    }
                }
            });
        }

        // =================================================================================
        // 3. LOGIQUE DRIVE (CORRECTIF 400)
        // =================================================================================
        async function syncDrive() {
            try {
                // Programme
                programFileId = await findFile(FILE_PROG);
                if (programFileId) {
                    const txt = await downloadFile(programFileId);
                    programData = JSON.parse(txt);
                } else {
                    // Cr√©ation si manquant
                    programData = DEFAULT_PROGRAM;
                    programFileId = await createFile(FILE_PROG, JSON.stringify(DEFAULT_PROGRAM));
                    showToast("Programme par d√©faut cr√©√© sur Drive.");
                }

                // Historique
                historyFileId = await findFile(FILE_HIST);
                if (historyFileId) {
                    const txt = await downloadFile(historyFileId);
                    historyData = JSON.parse(txt);
                } else {
                    historyData = [];
                    historyFileId = await createFile(FILE_HIST, "[]");
                }

                calculateLeague();
                renderHome();
                showToast("Synchronisation termin√©e.");
            } catch (e) {
                console.error(e);
                showToast("Erreur synchronisation Drive.");
            }
        }

        async function findFile(name) {
            // FIX : Utilisation d'espaces et encodeURIComponent pour √©viter erreur 400
            const q = `name = '${name}' and trashed = false`;
            const url = `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}&fields=files(id,name)`;
            const res = await fetch(url, { headers: { Authorization: `Bearer ${accessToken}` } });
            const data = await res.json();
            return data.files && data.files.length > 0 ? data.files[0].id : null;
        }

        async function downloadFile(id) {
            const res = await fetch(`https://www.googleapis.com/drive/v3/files/${id}?alt=media`, { headers: { Authorization: `Bearer ${accessToken}` } });
            return await res.text();
        }

        async function createFile(name, content) {
            const meta = { name, mimeType: 'application/json' };
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(meta)], { type: 'application/json' }));
            form.append('file', new Blob([content], { type: 'application/json' }));
            const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST', headers: { Authorization: `Bearer ${accessToken}` }, body: form
            });
            const data = await res.json();
            return data.id;
        }

        async function updateFile(id, content) {
            await fetch(`https://www.googleapis.com/upload/drive/v3/files/${id}?uploadType=media`, {
                method: 'PATCH', headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(content, null, 2)
            });
        }

        // =================================================================================
        // 4. MOTEUR LIGUES (GAMIFICATION)
        // =================================================================================
        function calculateLeague() {
            if (!historyData.length) return;

            // Grouper par semaine
            const weeks = {};
            historyData.forEach(h => {
                const d = new Date(h.date);
                const k = `${d.getFullYear()}-${getWeekNumber(d)}`;
                weeks[k] = (weeks[k] || 0) + 1;
            });

            // Calcul Streak
            let streak = 0;
            let d = new Date();
            const currentK = `${d.getFullYear()}-${getWeekNumber(d)}`;
            
            // Stats semaine courante
            const countThisWeek = weeks[currentK] || 0;
            document.getElementById('weekly-goal-txt').textContent = `${countThisWeek} / ${WEEKLY_TARGET}`;
            document.getElementById('weekly-progress').style.width = Math.min((countThisWeek/WEEKLY_TARGET)*100, 100) + "%";

            // Remonter le temps pour streak
            while (true) {
                const k = `${d.getFullYear()}-${getWeekNumber(d)}`;
                if (weeks[k] >= WEEKLY_TARGET) {
                    streak++;
                    d.setDate(d.getDate() - 7);
                } else {
                    if (k === currentK && streak === 0) { // Tol√©rance semaine en cours
                        d.setDate(d.getDate() - 7);
                        continue;
                    }
                    break;
                }
            }

            // Trouver Ligue
            let league = LEAGUES[0];
            for (let l of LEAGUES) { if (streak >= l.min) league = l; }
            
            // Mise √† jour UI
            updateTheme(league);
            document.getElementById('league-display').innerHTML = `
                <i class="fas ${league.icon || 'fa-trophy'} league-icon"></i>
                <div class="league-name">${league.name}</div>
                <div style="font-size:0.8em; opacity:0.7">S√©rie : ${streak} semaines</div>
            `;
        }

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function updateTheme(l) {
            const r = document.documentElement;
            // Conversion Hex -> RGB pour les effets de transparence
            const hex = l.color.replace('#','');
            const rgb = `${parseInt(hex.substring(0,2),16)}, ${parseInt(hex.substring(2,4),16)}, ${parseInt(hex.substring(4,6),16)}`;
            
            r.style.setProperty('--theme-color', l.color);
            r.style.setProperty('--theme-rgb', rgb);
            r.style.setProperty('--reactor-speed', l.speed);
        }

        // =================================================================================
        // 5. INTERFACE & WORKOUT
        // =================================================================================
        function renderHome() {
            const container = document.getElementById('session-cards-container');
            container.innerHTML = '';

            if (!programData) return;

            programData.sessions.forEach(session => {
                const card = document.createElement('div');
                card.className = 'session-card';
                const count = session.exercices_et_pauses.filter(e => e.type === 'exercise').length;
                card.innerHTML = `
                    <h3>${session.nom_session}</h3>
                    <p>${session.description_session || 'Pas de description'}</p>
                    <div class="meta">
                        <span><i class="fas fa-dumbbell"></i> ${count} Exos</span>
                        <span><i class="fas fa-play"></i> GO</span>
                    </div>
                `;
                card.onclick = () => {
                    if (isEditMode) showSummaryModal(session.nom_session, 'edit');
                    else startSession(session);
                };
                container.appendChild(card);
            });

            // Historique
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            historyData.slice(-5).reverse().forEach(h => {
                const li = document.createElement('li');
                li.style.marginBottom = "5px";
                li.innerHTML = `‚Ä¢ <span style="color:var(--theme-color)">${h.date}</span> : ${h.type}`;
                list.appendChild(li);
            });

            // Calendrier Simple
            renderCalendar();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            // Afficher les 14 derniers jours
            const now = new Date();
            for (let i=13; i>=0; i--) {
                const d = new Date();
                d.setDate(now.getDate() - i);
                const iso = d.toISOString().split('T')[0];
                const dayDiv = document.createElement('div');
                dayDiv.className = 'cal-day';
                if (i === 0) dayDiv.classList.add('today');
                
                // Check if workout exists
                if (historyData.some(h => h.date === iso)) dayDiv.classList.add('active');
                
                dayDiv.textContent = d.getDate();
                grid.appendChild(dayDiv);
            }
        }

        function startSession(session) {
            currentSessionName = session.nom_session;
            activePlan = JSON.parse(JSON.stringify(session.exercices_et_pauses));
            activeIdx = 0;
            
            document.body.classList.add('workout-active');
            document.getElementById('home-section').classList.add('section-hidden');
            document.getElementById('workout-section').classList.remove('section-hidden');
            
            loadStep();
        }

        function loadStep() {
            const step = activePlan[activeIdx];
            const isRest = step.type === 'break';
            const btn = document.getElementById('btn-main');
            
            document.getElementById('ex-name').textContent = step.name || (isRest ? "R√âCUP√âRATION" : "Exercice");
            
            if (isRest) {
                totalTime = step.duration || 60;
                document.getElementById('ex-details').textContent = "Respirez calmement. Hydratez-vous.";
                document.getElementById('ex-stats-container').innerHTML = `<span style="color:var(--text-muted)">Pause</span>`;
                btn.innerHTML = `<i class="fas fa-play"></i> CHRONO`;
            } else {
                // Parsing Poids & Matos
                const wTxt = step.weight_text || "";
                let displayW = wTxt;
                if (wTxt.includes('Sac')) displayW = wTxt.replace('Sac', 'üéí');
                else if (wTxt.includes('√âlastique')) displayW = wTxt.replace('√âlastique', 'üßò');
                else if (!wTxt || wTxt.includes('PDC')) displayW = "üí™ PDC";
                else displayW = `üèãÔ∏è ${parseFloat(wTxt) || 0} kg`;

                const reps = step.reps || (step.duration ? step.duration + "s" : "-");
                
                document.getElementById('ex-stats-container').innerHTML = `
                    <div class="ex-stats">
                        <span><i class="fas fa-repeat"></i> ${reps}</span>
                        <span>${displayW}</span>
                    </div>
                `;
                document.getElementById('ex-details').textContent = step.details || "";
                
                if (step.duration) {
                    totalTime = step.duration;
                    btn.innerHTML = `<i class="fas fa-play"></i> GO`;
                } else {
                    totalTime = 0;
                    btn.innerHTML = `<i class="fas fa-check"></i> VALID√â`;
                }
            }

            timeLeft = totalTime;
            isRunning = false;
            updateTimerDisplay();
        }

        function toggleTimer() {
            // Si pas de chrono, on passe
            if (totalTime === 0) { navigate(1); return; }

            const btn = document.getElementById('btn-main');
            if (isRunning) {
                clearInterval(timer);
                isRunning = false;
                btn.innerHTML = `<i class="fas fa-play"></i> REPRENDRE`;
            } else {
                isRunning = true;
                btn.innerHTML = `<i class="fas fa-pause"></i> PAUSE`;
                timer = setInterval(() => {
                    timeLeft--;
                    updateTimerDisplay();
                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        isRunning = false;
                        navigate(1);
                    }
                }, 1000);
            }
        }

        function updateTimerDisplay() {
            const el = document.getElementById('time-left');
            const ring = document.getElementById('timer-progress');
            
            if (totalTime > 0) {
                const m = Math.floor(timeLeft / 60).toString().padStart(2,'0');
                const s = (timeLeft % 60).toString().padStart(2,'0');
                el.textContent = `${m}:${s}`;
                
                const offset = 283 * (1 - timeLeft/totalTime);
                ring.style.strokeDashoffset = offset;
            } else {
                el.textContent = "PR√äT";
                ring.style.strokeDashoffset = 0;
            }
        }

        function navigate(dir) {
            clearInterval(timer);
            activeIdx += dir;
            if (activeIdx >= activePlan.length) showSummaryModal(currentSessionName, 'workout');
            else if (activeIdx < 0) { activeIdx = 0; loadStep(); }
            else loadStep();
        }

        function quitWorkout() {
            if (confirm("Annuler la s√©ance ?")) {
                clearInterval(timer);
                document.body.classList.remove('workout-active');
                document.getElementById('workout-section').classList.add('section-hidden');
                document.getElementById('home-section').classList.remove('section-hidden');
            }
        }

        // =================================================================================
        // 6. R√âSUM√â & SAUVEGARDE
        // =================================================================================
        function showSummaryModal(sessionName, mode) {
            currentSessionName = sessionName;
            const session = programData.sessions.find(s => s.nom_session === sessionName);
            // Mode workout = plan modifi√©, Mode edit = plan original
            const plan = (mode === 'workout') ? activePlan : JSON.parse(JSON.stringify(session.exercices_et_pauses));
            
            const list = document.getElementById('summary-list');
            list.innerHTML = '';

            plan.forEach((item, i) => {
                if (item.type === 'exercise') {
                    // Extraction intelligente du poids et type
                    let wVal = 0;
                    let emoji = "üèãÔ∏è";
                    const wTxt = item.weight_text || "";
                    
                    if (wTxt.includes('Sac')) emoji = "üéí";
                    else if (wTxt.includes('√âlastique') || wTxt.includes('Band')) emoji = "üßò";
                    else if (wTxt.includes('PDC')) emoji = "üí™";
                    
                    wVal = parseFloat(wTxt.replace(/[^0-9.]/g, '')) || 0;

                    const row = document.createElement('div');
                    row.className = 'summary-item';
                    row.innerHTML = `
                        <div style="font-weight:bold; margin-bottom:5px;">${item.name}</div>
                        <div class="summary-row">
                            <div class="stepper" data-idx="${i}" data-type="reps">
                                <button class="minus">-</button>
                                <span>${item.reps || item.duration || 0}</span>
                                <button class="plus">+</button>
                            </div>
                            <div class="stepper" data-idx="${i}" data-type="weight" data-emoji="${emoji}">
                                <button class="minus">-</button>
                                <span>${wVal}</span>
                                <button class="plus">+</button>
                                <span style="font-size:1.2em; border:none;">${emoji}</span>
                            </div>
                        </div>
                    `;
                    list.appendChild(row);
                }
            });

            const btn = document.getElementById('save-btn');
            btn.textContent = (mode === 'workout') ? "VALIDER LA S√âANCE" : "ENREGISTRER LES MODIFS";
            btn.onclick = () => finishWorkout(mode);
            
            document.getElementById('summary-modal').classList.add('visible');
        }

        async function finishWorkout(mode) {
            const btn = document.getElementById('save-btn');
            btn.disabled = true; btn.textContent = "Synchronisation...";

            const sessionIdx = programData.sessions.findIndex(s => s.nom_session === currentSessionName);
            const items = document.querySelectorAll('.summary-item');
            
            // Reconstitution du plan mis √† jour
            const newPlan = (mode === 'workout') ? activePlan : JSON.parse(JSON.stringify(programData.sessions[sessionIdx].exercices_et_pauses));

            items.forEach(div => {
                const repEl = div.querySelector('.stepper[data-type="reps"]');
                const wEl = div.querySelector('.stepper[data-type="weight"]');
                const idx = parseInt(repEl.dataset.idx);
                
                const rVal = parseFloat(repEl.querySelector('span').textContent);
                const wVal = parseFloat(wEl.querySelector('span').textContent);
                const emoji = wEl.dataset.emoji;

                const ex = newPlan[idx];
                if (ex.reps) ex.reps = rVal;
                else if (ex.duration) ex.duration = rVal;

                // Reconstruction string poids
                if (emoji === "üéí") ex.weight_text = `üéí Sac ${wVal} kg`;
                else if (emoji === "üßò") ex.weight_text = `üßò √âlastique ${wVal} kg`;
                else if (emoji === "üí™") ex.weight_text = `üí™ PDC`;
                else ex.weight_text = `üèãÔ∏è ${wVal} kg`;
            });

            // Sauvegarde Local + Drive
            programData.sessions[sessionIdx].exercices_et_pauses = newPlan;
            
            if (mode === 'workout') {
                historyData.push({
                    date: new Date().toISOString().split('T')[0],
                    type: currentSessionName,
                    exercises: newPlan.filter(e => e.type === 'exercise')
                });
                if (accessToken) await updateFile(historyFileId, historyData);
            }

            if (accessToken) await updateFile(programFileId, programData);

            // Cleanup
            document.getElementById('summary-modal').classList.remove('visible');
            btn.disabled = false;
            
            if (mode === 'workout') {
                document.body.classList.remove('workout-active');
                document.getElementById('workout-section').classList.add('section-hidden');
                document.getElementById('home-section').classList.remove('section-hidden');
            } else {
                isEditMode = false;
                document.getElementById('edit-mode-btn').style.color = "var(--text-muted)";
            }
            
            calculateLeague();
            renderHome();
            showToast("Donn√©es mises √† jour !");
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            const btn = document.getElementById('edit-mode-btn');
            btn.style.color = isEditMode ? "var(--theme-color)" : "var(--text-muted)";
            showToast(isEditMode ? "Mode √âdition Activ√©" : "Mode √âdition D√©sactiv√©");
            renderHome(); // Rafra√Æchir les cartes
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.querySelector('span').textContent = msg;
            t.classList.add('visible');
            setTimeout(() => t.classList.remove('visible'), 3000);
        }

    </script>
</body>
</html>
  
