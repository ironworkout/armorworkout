

C'est re√ßu. Je vais r√©√©crire l'int√©gralit√© du code en suivant scrupuleusement le cahier des charges "Elite" que tu as fourni.
Corrections et Int√©grations majeures :
Architecture "Anti-Crash" : Toutes les fonctions utilitaires (initSounds, parseEliteWeight, etc.) sont remont√©es tout en haut pour √©liminer d√©finitivement l'erreur ReferenceError.
Moteur Elite & Vibranium : Impl√©mentation du parsing hybride (chiffres + texte) et de la logique de d√©tection de ma√Ætrise (100% Force + 100% Volume = Vibranium).
Data Viz "HUD Balistique" : Le graphique central est maintenant un Scatter Plot (nuage de points) avec l'effet "Jitter" pour √©viter les superpositions et la "Cible" √† 100/100.
Interface de R√©sum√© Compl√®te : Ajout des champs pour modifier les Objectifs Finaux ind√©pendamment de la performance du jour.
Programme "ROI V√äTU 2025" : Int√©gr√© par d√©faut.
Voici le code complet, pr√™t √† l'emploi.
 code Html
play_circledownloadcontent_copy
expand_less    <!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArmorWorkout - Elite Edition</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚ö°</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color-dark: #030712; 
            --secondary-bg-color-dark: #0B132B; 
            --primary-text-color-dark: #F0F4F8; 
            --secondary-text-color-dark: #A0AEC0; 
            --border-color-dark: #1E293B; 
            --electric-blue: #00BFFF; 
            --electric-cyan: #22D3EE; 
            --electric-purple: #9400D3;
            --neon-green: #39FF14;
            --neon-gold: #FFD700;
            --font-family-main: 'Inter', sans-serif;
            --font-family-timer: 'Orbitron', sans-serif;
            --input-bg: #1A202C;
        }

        /* --- VIBRANIUM STYLES --- */
        .vibranium-mastered {
            background: linear-gradient(135deg, rgba(11, 19, 43, 0.95) 0%, rgba(20, 0, 30, 0.95) 100%) !important;
            border: 1px solid var(--electric-purple) !important;
            box-shadow: 0 0 15px rgba(148, 0, 211, 0.4), inset 0 0 20px rgba(148, 0, 211, 0.1) !important;
            position: relative;
            overflow: hidden;
            animation: pulse-border 3s infinite alternate;
        }
        @keyframes pulse-border {
            0% { border-color: var(--electric-purple); box-shadow: 0 0 15px rgba(148,0,211,0.4); }
            100% { border-color: var(--neon-gold); box-shadow: 0 0 25px rgba(255,215,0,0.4); }
        }
        .badge-vibranium {
            background: linear-gradient(45deg, #FFD700, #FDB931);
            color: #000; font-family: var(--font-family-timer); font-weight: 900; font-size: 0.75em;
            padding: 4px 10px; border-radius: 4px; box-shadow: 0 0 10px #FFD700;
            text-transform: uppercase; display: inline-block; margin-bottom: 8px;
            animation: shine 2s infinite;
        }
        @keyframes shine { 0% { filter: brightness(1); } 50% { filter: brightness(1.3); } 100% { filter: brightness(1); } }

        /* --- BASE STYLES --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--font-family-main); background-color: var(--bg-color-dark); color: var(--primary-text-color-dark);
            min-height: 100vh; display: flex; flex-direction: column; overflow-x: hidden;
            background-image: radial-gradient(circle at 50% 50%, rgba(0, 191, 255, 0.05) 0%, transparent 70%);
        }
        
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; width: 100%; flex-grow: 1; display: flex; flex-direction: column; }
        
        header {
            padding: 15px 0; background: rgba(11, 19, 43, 0.8); backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(34, 211, 238, 0.2); position: sticky; top: 0; z-index: 100;
        }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        h1 { font-family: var(--font-family-timer); font-size: 1.4rem; display: flex; align-items: center; gap: 10px; color: var(--electric-cyan); }
        
        /* Buttons */
        .btn-auth { background: transparent; border: 1px solid var(--secondary-text-color-dark); color: var(--secondary-text-color-dark); padding: 5px 12px; border-radius: 6px; cursor: pointer; transition: 0.3s; }
        .btn-auth:hover:not(:disabled) { border-color: var(--electric-cyan); color: var(--electric-cyan); }
        .btn-auth:disabled { opacity: 0.5; cursor: not-allowed; }
        
        /* Sections */
        .app-section { display: none; animation: fadeIn 0.4s ease-out; }
        .app-section.visible { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Home Grid */
        .home-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .card { background: rgba(11, 19, 43, 0.6); border: 1px solid var(--border-color-dark); border-radius: 12px; padding: 20px; transition: transform 0.2s, border-color 0.2s; cursor: pointer; }
        .card:hover { transform: translateY(-3px); border-color: var(--electric-cyan); box-shadow: 0 5px 15px rgba(0,191,255,0.1); }
        .card h3 { font-family: var(--font-family-timer); color: var(--electric-cyan); margin-bottom: 10px; }
        
        /* Charts */
        .chart-container { position: relative; height: 250px; width: 100%; margin-top: 15px; }
        
        /* Workout Mode */
        .timer-display { position: relative; width: 280px; height: 280px; margin: 0 auto 30px; display: flex; justify-content: center; align-items: center; }
        .reactor-ring { position: absolute; width: 100%; height: 100%; border-radius: 50%; border: 4px solid rgba(34, 211, 238, 0.2); animation: spin 10s linear infinite; }
        .reactor-core { position: absolute; width: 70%; height: 70%; border-radius: 50%; background: radial-gradient(circle, rgba(0,191,255,0.2) 0%, transparent 70%); box-shadow: 0 0 20px var(--electric-blue); display: flex; justify-content: center; align-items: center; }
        #time-left { font-family: var(--font-family-timer); font-size: 3.5rem; font-weight: 700; color: #fff; text-shadow: 0 0 10px var(--electric-cyan); z-index: 10; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* Summary Modal */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 1000; display: none; justify-content: center; align-items: center; padding: 20px; }
        .modal.visible { display: flex; }
        .modal-content { background: var(--secondary-bg-color-dark); width: 100%; max-width: 700px; max-height: 90vh; border-radius: 12px; border: 1px solid var(--border-color-dark); display: flex; flex-direction: column; }
        .modal-header { padding: 20px; border-bottom: 1px solid var(--border-color-dark); text-align: center; }
        .modal-body { padding: 20px; overflow-y: auto; }
        
        .summary-item { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 3px solid var(--secondary-text-color-dark); }
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px; }
        .input-group label { display: block; font-size: 0.75rem; color: var(--secondary-text-color-dark); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        
        .stepper { display: flex; background: var(--input-bg); border: 1px solid var(--border-color-dark); border-radius: 6px; }
        .stepper button { width: 40px; background: transparent; border: none; color: var(--electric-cyan); font-size: 1.2rem; cursor: pointer; }
        .stepper span { flex: 1; text-align: center; line-height: 36px; font-weight: bold; }
        .text-input { width: 100%; background: var(--input-bg); border: 1px solid var(--border-color-dark); color: #fff; padding: 8px; border-radius: 6px; font-family: var(--font-family-main); }
        
        .modal-footer { padding: 20px; border-top: 1px solid var(--border-color-dark); text-align: center; }
        .btn-primary { background: var(--neon-green); color: #000; border: none; padding: 12px 30px; border-radius: 8px; font-weight: 700; cursor: pointer; font-family: var(--font-family-timer); text-transform: uppercase; letter-spacing: 1px; transition: 0.2s; }
        .btn-primary:hover { box-shadow: 0 0 15px var(--neon-green); transform: translateY(-2px); }

        /* Message Toast */
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #1A202C; border: 1px solid var(--electric-cyan); padding: 10px 25px; border-radius: 30px; z-index: 2000; opacity: 0; pointer-events: none; transition: 0.3s; box-shadow: 0 5px 20px rgba(0,0,0,0.5); }
        .toast.visible { opacity: 1; bottom: 40px; }
    </style>
</head>
<body class="logged-out">

    <header>
        <div class="header-content">
            <h1><i class="fas fa-bolt"></i> ArmorWorkout</h1>
            <div class="header-actions">
                <span id="drive-status" style="display:none; color:var(--neon-green); font-size:0.9rem; margin-right:10px;"><i class="fab fa-google-drive"></i> Connect√©</span>
                <button id="btn-login" class="btn-auth" onclick="handleAuthClick()"><i class="fab fa-google"></i> Connexion Drive</button>
            </div>
        </div>
    </header>

    <div class="container">
        
        <!-- HOME SECTION -->
        <div id="home-section" class="app-section visible">
            <!-- Rempli dynamiquement -->
        </div>

        <!-- WORKOUT SECTION -->
        <div id="workout-section" class="app-section">
            <div class="timer-display">
                <div class="reactor-ring"></div>
                <div class="reactor-core">
                    <div id="time-left">00:00</div>
                </div>
            </div>
            <div style="text-align: center; margin-bottom: 30px;">
                <h2 id="ex-name" style="font-family: var(--font-family-timer); color: var(--electric-cyan); font-size: 1.5rem; margin-bottom: 10px;">--</h2>
                <div id="ex-details" style="color: var(--secondary-text-color-dark);">--</div>
            </div>
            <div style="display: flex; justify-content: center; gap: 15px;">
                <button class="btn-auth" onclick="prevStep()"><i class="fas fa-backward"></i></button>
                <button class="btn-auth" onclick="toggleTimer()"><i class="fas fa-play"></i> / <i class="fas fa-pause"></i></button>
                <button class="btn-auth" onclick="nextStep()"><i class="fas fa-forward"></i></button>
                <button class="btn-auth" style="border-color: var(--neon-red); color: var(--neon-red);" onclick="finishWorkout()">FINIR</button>
            </div>
        </div>

    </div>

    <!-- SUMMARY MODAL -->
    <div id="summary-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="color: var(--electric-cyan); font-family: var(--font-family-timer);">Rapport de Mission</h2>
            </div>
            <!-- HUD Balistique Chart Container -->
            <div id="ballistic-chart-wrapper" style="height: 250px; width: 100%; background: #080c18; border-bottom: 1px solid var(--border-color-dark);">
                <canvas id="ballistic-chart"></canvas>
            </div>
            <div class="modal-body" id="summary-list">
                <!-- Items list -->
            </div>
            <div class="modal-footer">
                <button class="btn-primary" onclick="saveAndClose()">ENREGISTRER & FERMER</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">Message</div>

    <!-- SCRIPTS -->
    <script async defer src="https://accounts.google.com/gsi/client"></script>
    <script>
        "use strict";

        // ============================================================================
        // 1. UTILITY FUNCTIONS (D√©clar√©es en premier pour √©viter ReferenceError)
        // ============================================================================

        // Moteur Elite : Parsing Hybride
        function parseEliteWeight(text) {
            if (!text || typeof text !== 'string') return 0;
            // Extrait tous les nombres (entiers ou d√©cimaux) et les additionne
            // Ex: "25kg + 15kg" -> 40
            const numbers = text.match(/-?\d+(\.\d+)?/g);
            if (!numbers) return 0;
            return numbers.reduce((acc, curr) => acc + parseFloat(curr), 0);
        }

        // Moteur Elite : Calcul du Gap (Score)
        function calculateEliteGap(current, target, type = 'number') {
            if (type === 'qualitative') {
                if (!target || target.length < 2) return 100; // Pas de cible = 100%
                const cleanCurrent = (current || "").toString().toLowerCase();
                const cleanTarget = (target || "").toString().toLowerCase();
                // Comparaison souple : si "Debout" est dans "Tirage Debout", c'est bon
                return cleanCurrent.includes(cleanTarget) ? 100 : 0;
            } else {
                // Comparaison num√©rique
                const currentVal = parseFloat(current) || 0;
                const targetVal = parseFloat(target) || 0;
                if (targetVal === 0) return 100;
                let pct = (currentVal / targetVal) * 100;
                return Math.min(100, Math.max(0, pct)); // Borner entre 0 et 100
            }
        }

        function formatTime(seconds) {
            const m = Math.floor(seconds / 60);
            const s = Math.round(seconds % 60);
            return `${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('visible');
            setTimeout(() => t.classList.remove('visible'), 3000);
        }

        let audioCtx;
        function initSounds() {
            if(!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if(audioCtx.state === 'suspended') audioCtx.resume();
        }

        function beep(freq = 440, duration = 100) {
            if(!audioCtx) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.frequency.value = freq;
            osc.start();
            gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + duration/1000);
            osc.stop(audioCtx.currentTime + duration/1000);
        }

        // ============================================================================
        // 2. CONFIGURATION & DATA
        // ============================================================================

        const CLIENT_ID = "731283926358-viam3ulpgna14flfdeb9m92l8s620hoi.apps.googleusercontent.com";
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const FILES = {
            PROGRAM: "programmeCompletHypertrophieElite_v1.json",
            HISTORY: "armorworkout_history.json"
        };

        const DEFAULT_PROGRAM = JSON.stringify({
          "nom_programme": "ROI V√äTU 2025 (Expert Edition)",
          "description_programme": "Focus 100% muscles visibles habill√©.",
          "sessions": [
            {
              "nom_session": "S√âANCE A : V-FRAME & TRICEPS",
              "description_session": "Largeur d'√©paules et Remplissage manches.",
              "exercices_et_pauses": [
                { "type": "exercise", "name": "D√©velopp√© Militaire Unilat√©ral", "reps": 10, "weight_text": "üü™ √âlastique 25kg", "final_target_poids": "Debout", "final_target_reps": "12" },
                { "type": "break", "duration": 90, "name": "Repos" },
                { "type": "exercise", "name": "Tirage Vertical", "reps": 14, "weight_text": "üü™ 25kg", "final_target_poids": "40kg", "final_target_reps": "12" }
              ]
            },
            {
                "nom_session": "S√âANCE B : THICKNESS & BICEPS",
                "description_session": "√âpaisseur dos et Biceps.",
                "exercices_et_pauses": [
                    { "type": "exercise", "name": "Pompes Lest√©es", "reps": 10, "weight_text": "üéí +8 kg", "final_target_poids": "üéí +30 kg", "final_target_reps": "10" }
                ]
            }
          ]
        });

        // STATE
        let tokenClient;
        let accessToken = null;
        let programData = null;
        let historyData = [];
        let programFileId = null;
        let historyFileId = null;

        let currentSession = null;
        let sessionPlan = [];
        let currentIndex = 0;
        let timer = null;
        let timeLeft = 0;
        let isRunning = false;
        let activeChart = null;

        // ============================================================================
        // 3. DRIVE API
        // ============================================================================

        function initGis() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID, scope: SCOPES,
                callback: async (resp) => {
                    if (resp.error) return console.error(resp);
                    accessToken = resp.access_token;
                    document.getElementById('btn-login').style.display = 'none';
                    document.getElementById('drive-status').style.display = 'inline-block';
                    await loadDriveData();
                    renderHome();
                }
            });
            // Auto-login attempt
            try { tokenClient.requestAccessToken({ prompt: 'none' }); } catch(e) {}
        }

        function handleAuthClick() {
            initSounds();
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }

        async function loadDriveData() {
            showToast("Sync Drive...");
            programFileId = await getFileId(FILES.PROGRAM, DEFAULT_PROGRAM);
            if(programFileId) {
                let content = await readFile(programFileId);
                programData = JSON.parse(content);
            }
            
            historyFileId = await getFileId(FILES.HISTORY, "[]");
            if(historyFileId) {
                let content = await readFile(historyFileId);
                historyData = JSON.parse(content);
            }
            showToast("Donn√©es charg√©es !");
        }

        async function getFileId(name, defaultContent) {
            // Utilisation de %20 au lieu de + pour √©viter l'erreur 400
            const q = `name='${encodeURIComponent(name)}'%20and%20trashed=false`;
            const res = await fetch(`https://www.googleapis.com/drive/v3/files?q=${q}`, {
                headers: { Authorization: `Bearer ${accessToken}` }
            });
            const data = await res.json();
            if (data.files && data.files.length > 0) return data.files[0].id;
            
            // Create
            const meta = { name: name, mimeType: 'application/json' };
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(meta)], { type: 'application/json' }));
            form.append('file', new Blob([defaultContent], { type: 'application/json' }));
            
            const createRes = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST', headers: { Authorization: `Bearer ${accessToken}` }, body: form
            });
            const file = await createRes.json();
            return file.id;
        }

        async function readFile(id) {
            const res = await fetch(`https://www.googleapis.com/drive/v3/files/${id}?alt=media`, {
                headers: { Authorization: `Bearer ${accessToken}` }
            });
            return await res.text();
        }

        async function saveFile(id, content) {
            await fetch(`https://www.googleapis.com/upload/drive/v3/files/${id}?uploadType=media`, {
                method: 'PATCH',
                headers: { Authorization: `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(content)
            });
        }

        // ============================================================================
        // 4. UI & RENDERING
        // ============================================================================

        function renderHome() {
            const container = document.getElementById('home-section');
            container.innerHTML = '';
            
            if (!programData) {
                container.innerHTML = '<div style="text-align:center;">Connectez-vous pour charger le programme.</div>';
                return;
            }

            const grid = document.createElement('div');
            grid.className = 'home-grid';

            programData.sessions.forEach(session => {
                const div = document.createElement('div');
                div.className = 'card';
                
                // Get last date
                const lastLog = historyData.filter(h => h.type === session.nom_session).pop();
                const lastDate = lastLog ? new Date(lastLog.date).toLocaleDateString() : 'Jamais';

                div.innerHTML = `
                    <h3>${session.nom_session}</h3>
                    <p style="font-size:0.9rem; color:#A0AEC0;">${session.description_session}</p>
                    <div style="margin-top:15px; font-size:0.8rem; color:var(--electric-cyan);">
                        <i class="fas fa-history"></i> Derni√®re: ${lastDate}
                    </div>
                    <div class="chart-container">
                        <canvas id="chart-${session.nom_session.replace(/\s/g,'')}"></canvas>
                    </div>
                `;
                div.onclick = (e) => {
                    if(e.target.tagName !== 'CANVAS') startSession(session.nom_session);
                }
                grid.appendChild(div);
                
                // Render Mini Scatter Chart for Home
                setTimeout(() => renderScatterPreview(session, `chart-${session.nom_session.replace(/\s/g,'')}`), 0);
            });

            container.appendChild(grid);
        }

        function renderScatterPreview(session, canvasId) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            
            const exercises = session.exercices_et_pauses.filter(e => e.type === 'exercise');
            const dataPoints = exercises.map(ex => {
                const wScore = calculateEliteGap(parseEliteWeight(ex.weight_text), parseEliteWeight(ex.final_target_poids));
                const rScore = calculateEliteGap(ex.reps, ex.final_target_reps);
                
                // Jitter
                return {
                    x: Math.min(100, rScore) + (Math.random()-0.5)*5,
                    y: Math.min(100, wScore) + (Math.random()-0.5)*5
                };
            });

            new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Perf.',
                        data: dataPoints,
                        backgroundColor: '#00BFFF',
                        pointRadius: 4
                    }, {
                        label: 'Cible',
                        data: [{x:100, y:100}],
                        backgroundColor: '#FFD700',
                        pointStyle: 'star',
                        pointRadius: 8
                    }]
                },
                options: {
                    scales: { x: { display: false, min:0, max:110 }, y: { display: false, min:0, max:110 } },
                    plugins: { legend: { display: false } },
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // ============================================================================
        // 5. WORKOUT LOGIC
        // ============================================================================

        function startSession(name) {
            initSounds();
            const session = programData.sessions.find(s => s.nom_session === name);
            if(!session) return;

            currentSession = session;
            sessionPlan = JSON.parse(JSON.stringify(session.exercices_et_pauses)); // Deep copy
            currentIndex = 0;
            
            document.getElementById('home-section').classList.remove('visible');
            document.getElementById('workout-section').classList.add('visible');
            
            loadStep();
        }

        function loadStep() {
            const item = sessionPlan[currentIndex];
            const nameEl = document.getElementById('ex-name');
            const detailEl = document.getElementById('ex-details');
            const timeEl = document.getElementById('time-left');

            clearInterval(timer);
            isRunning = false;

            if (item.type === 'exercise') {
                nameEl.textContent = item.name;
                detailEl.innerHTML = `
                    <div style="font-size:1.2rem; color:#fff; margin-bottom:5px;">${item.reps} Reps &bull; ${item.weight_text}</div>
                    <div style="font-size:0.8rem;">${item.details || ''}</div>
                `;
                timeLeft = item.duration || 0;
                timeEl.textContent = timeLeft > 0 ? formatTime(timeLeft) : "GO";
                if(timeLeft === 0) timeEl.style.color = "var(--electric-blue)";
            } else {
                nameEl.textContent = item.name || "Repos";
                detailEl.textContent = "R√©cup√©ration...";
                timeLeft = item.duration;
                timeEl.textContent = formatTime(timeLeft);
                timeEl.style.color = "var(--electric-cyan)";
                toggleTimer(); // Auto start break
            }
        }

        function toggleTimer() {
            if (timeLeft <= 0) return;
            if (isRunning) {
                clearInterval(timer);
                isRunning = false;
            } else {
                isRunning = true;
                timer = setInterval(() => {
                    timeLeft--;
                    document.getElementById('time-left').textContent = formatTime(timeLeft);
                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        beep(800, 300);
                    } else if (timeLeft <= 3) {
                        beep(440, 100);
                    }
                }, 1000);
            }
        }

        function nextStep() {
            if (currentIndex < sessionPlan.length - 1) {
                currentIndex++;
                loadStep();
            } else {
                finishWorkout();
            }
        }

        function prevStep() {
            if (currentIndex > 0) {
                currentIndex--;
                loadStep();
            }
        }

        function finishWorkout() {
            document.getElementById('summary-modal').classList.add('visible');
            renderSummary();
        }

        // ============================================================================
        // 6. SUMMARY & VISUALISATION (HUD BALISTIQUE)
        // ============================================================================

        function renderSummary() {
            const list = document.getElementById('summary-list');
            list.innerHTML = '';

            const exercises = sessionPlan.filter(i => i.type === 'exercise');
            
            // Pr√©parer les donn√©es pour le Graphique
            const scatterData = [];

            exercises.forEach((item, idx) => {
                // Calcul Ma√Ætrise Vibranium
                const wScore = calculateEliteGap(parseEliteWeight(item.weight_text), parseEliteWeight(item.final_target_poids));
                const rScore = calculateEliteGap(item.reps, item.final_target_reps);
                const isMastered = (wScore >= 100 && rScore >= 100);

                // Ajout point pour le graph
                scatterData.push({
                    x: rScore + (Math.random()-0.5)*3, // Jitter
                    y: wScore + (Math.random()-0.5)*3,
                    label: item.name
                });

                const div = document.createElement('div');
                div.className = `summary-item ${isMastered ? 'vibranium-mastered' : ''}`;
                
                let badge = isMastered ? `<span class="badge-vibranium"><i class="fas fa-gem"></i> Vibranium Mastered</span>` : '';

                div.innerHTML = `
                    ${badge}
                    <div style="font-weight:bold; color:#fff; margin-bottom:5px;">${item.name}</div>
                    
                    <!-- Colonne 1 : Performance du jour -->
                    <div class="input-row" style="background:rgba(0,191,255,0.1); padding:10px; border-radius:5px;">
                        <div class="input-group">
                            <label>Reps / Temps</label>
                            <div class="stepper">
                                <button onclick="adjustVal(${idx}, 'reps', -1)">-</button>
                                <span id="val-reps-${idx}">${item.reps || item.duration}</span>
                                <button onclick="adjustVal(${idx}, 'reps', 1)">+</button>
                            </div>
                        </div>
                        <div class="input-group">
                            <label>Charge (Texte)</label>
                            <input type="text" class="text-input" id="val-weight-${idx}" value="${item.weight_text}">
                        </div>
                    </div>

                    <!-- Colonne 2 : Objectif Final (Modifiable) -->
                    <div class="input-row" style="background:rgba(255,215,0,0.05); padding:10px; border-radius:5px; border:1px dashed #FFD700;">
                        <div class="input-group">
                            <label style="color:#FFD700;">Cible Reps</label>
                            <input type="number" class="text-input" id="target-reps-${idx}" value="${item.final_target_reps || 12}">
                        </div>
                        <div class="input-group">
                            <label style="color:#FFD700;">Cible Charge</label>
                            <input type="text" class="text-input" id="target-weight-${idx}" value="${item.final_target_poids || ''}">
                        </div>
                    </div>
                `;
                list.appendChild(div);
            });

            // Render HUD Balistique Chart
            renderBallisticChart(scatterData);
        }

        // Helpers pour modification inline
        window.adjustVal = (idx, field, delta) => {
            // Note: idx r√©f√®re ici √† l'index dans le tableau filtr√© 'exercises', pas sessionPlan complet
            // Pour simplifier, on reconstruit sessionPlan √† la sauvegarde.
            const span = document.getElementById(`val-reps-${idx}`);
            let val = parseInt(span.innerText);
            span.innerText = Math.max(0, val + delta);
        }

        function renderBallisticChart(dataPoints) {
            if(activeChart) activeChart.destroy();
            const ctx = document.getElementById('ballistic-chart').getContext('2d');
            
            activeChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Exercices',
                        data: dataPoints,
                        backgroundColor: (ctx) => {
                            const v = ctx.raw;
                            return (v && v.x >= 100 && v.y >= 100) ? '#39FF14' : '#00BFFF';
                        },
                        pointRadius: 6,
                        pointHoverRadius: 8
                    },
                    {
                        label: 'Cible Vibranium',
                        data: [{x:100, y:100}],
                        pointStyle: 'star',
                        pointRadius: 15,
                        backgroundColor: '#FFD700',
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { min: 0, max: 120, grid: {color: '#1E293B'}, title: {display:true, text:'Volume (%)', color:'#A0AEC0'} },
                        y: { min: 0, max: 120, grid: {color: '#1E293B'}, title: {display:true, text:'Charge (%)', color:'#A0AEC0'} }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.raw.label || 'Cible'}: ${Math.round(ctx.raw.x)}% / ${Math.round(ctx.raw.y)}%`
                            }
                        },
                        annotation: {
                            // Si tu voulais dessiner la "Zone" ici (n√©cessite plugin annotation, on fait sans pour l'instant)
                        }
                    }
                }
            });
        }

        async function saveAndClose() {
            showToast("Sauvegarde...");
            const exercises = sessionPlan.filter(i => i.type === 'exercise');
            
            // 1. R√©cup√©rer les valeurs de l'UI
            exercises.forEach((ex, idx) => {
                ex.reps = parseInt(document.getElementById(`val-reps-${idx}`).innerText);
                ex.weight_text = document.getElementById(`val-weight-${idx}`).value;
                ex.final_target_reps = document.getElementById(`target-reps-${idx}`).value;
                ex.final_target_poids = document.getElementById(`target-weight-${idx}`).value;
            });

            // 2. Sauvegarder dans l'historique
            const log = {
                date: new Date().toISOString(),
                type: currentSession.nom_session,
                exercises: exercises
            };
            historyData.push(log);
            await saveFile(historyFileId, historyData);

            // 3. Mettre √† jour le programme (pour conserver les nouveaux objectifs)
            // On retrouve la session dans programData via le nom
            const sessionIndex = programData.sessions.findIndex(s => s.nom_session === currentSession.nom_session);
            if(sessionIndex >= 0) {
                // On remplace les exos par la version mise √† jour (avec les pauses qui n'ont pas chang√©)
                // Attention: sessionPlan contient tout. Mais on a modifi√© que les exos.
                // Comme sessionPlan est une deep copy, on peut juste √©craser
                programData.sessions[sessionIndex].exercices_et_pauses = sessionPlan;
                await saveFile(programFileId, programData);
            }

            document.getElementById('summary-modal').classList.remove('visible');
            document.getElementById('workout-section').classList.remove('visible');
            document.getElementById('home-section').classList.add('visible');
            
            renderHome();
            showToast("Sauvegard√© avec succ√®s !");
        }

        // Init
        window.onload = initGis;

    </script>
</body>
</html>
  
