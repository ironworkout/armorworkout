
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArmorWorkout - Ã‰lectrique</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color-dark: #030712; 
            --secondary-bg-color-dark: #0B132B; 
            --primary-text-color-dark: #F0F4F8; 
            --secondary-text-color-dark: #A0AEC0; 
            --border-color-dark: #1E293B; 
            --electric-blue: #00BFFF; 
            --electric-cyan: #22D3EE; 
            --electric-blue-light: #4D94FF; 
            --glow-accent: #0AF; 
            --electric-blue-rgb: 0, 191, 255;
            --electric-cyan-rgb: 34, 211, 238;
            --glow-accent-rgb: 0, 170, 255;
            --secondary-bg-color-dark-rgb: 11, 19, 43;
            --bg-color-dark-rgb: 3, 7, 18;
            --neon-pink: #FF1493; 
            --neon-purple: #9400D3; 
            --neon-green: #39FF14; 
            --neon-red: #FF3131; 
            --neon-yellow: #FFF01F; 
            --neon-pink-rgb: 255, 20, 147;
            --neon-purple-rgb: 148, 0, 211;
            --neon-green-rgb: 57, 255, 20;
            --neon-red-rgb: 255, 49, 49;
            --neon-yellow-rgb: 255, 240, 31;
            --glow-red: 0 0 8px var(--neon-red), 0 0 12px rgba(var(--neon-red-rgb),0.7);
            --glow-green: 0 0 8px var(--neon-green), 0 0 12px rgba(var(--neon-green-rgb),0.7);
            --glow-yellow: 0 0 8px var(--neon-yellow), 0 0 12px rgba(var(--neon-yellow-rgb),0.7);
            --glow-pink: 0 0 8px var(--neon-pink), 0 0 12px rgba(var(--neon-pink-rgb),0.7);
            --glow-purple: 0 0 8px var(--neon-purple), 0 0 12px rgba(var(--neon-purple-rgb),0.7);
            --electric-yellow: var(--neon-yellow); 
            --electric-yellow-rgb: var(--neon-yellow-rgb);
            --exercise-color-val: var(--electric-blue-light);
            --exercise-timed-color-val: var(--electric-yellow);
            --break-color-val: var(--electric-cyan);
            --paused-color-val: #A78BFA; 
            --finished-color-val: var(--neon-green);
            --completed-color-val: var(--neon-green);
            --preparing-color-val: var(--electric-cyan);
            --get-ready-color-val: var(--neon-purple);
            --idle-color-val: var(--electric-blue);
            --exercise-color-rgb: 77, 148, 255; 
            --exercise-timed-color-rgb: var(--neon-yellow-rgb);
            --break-color-rgb: var(--electric-cyan-rgb);
            --paused-color-rgb: 167, 139, 250;
            --finished-color-rgb: var(--neon-green-rgb);
            --completed-color-rgb: var(--neon-green-rgb);
            --preparing-color-rgb: var(--electric-cyan-rgb);
            --get-ready-color-rgb: var(--neon-purple-rgb);
            --idle-color-rgb: var(--electric-blue-rgb);
            --color-exercise: var(--exercise-color-val);
            --color-exercise-timed: var(--exercise-timed-color-val);
            --color-break: var(--break-color-val);
            --color-prepare: var(--preparing-color-val);
            --color-finished: var(--finished-color-val);
            --color-paused: var(--paused-color-val);
            --color-idle: var(--secondary-text-color-dark);
            --font-family-main: 'Inter', sans-serif;
            --font-family-timer: 'Orbitron', sans-serif;
            --font-family-titles: 'Orbitron', sans-serif; 
            --border-radius-lg: 10px;
            --border-radius-md: 8px;
            --border-radius-sm: 6px;
            --transition-speed: 0.3s;
            --section-transition-speed: 0.4s;
            --bg-color: var(--bg-color-dark);
            --secondary-bg-color: var(--secondary-bg-color-dark);
            --primary-text-color: var(--primary-text-color-dark);
            --secondary-text-color: var(--secondary-text-color-dark);
            --border-color: var(--border-color-dark);
            --accent-border-color: rgba(var(--electric-blue-rgb), 0.4); 
            --input-bg: #1A202C; 
            --current-timer-state-color: var(--idle-color-val);
            --current-timer-state-color-rgb: var(--idle-color-rgb);
            --timer-text-color-main: #FFFFFF;
            --timer-text-glow-main: 0 0 5px #fff, 
                                    0 0 8px #fff, 
                                    0 0 12px rgba(var(--electric-cyan-rgb), 0.6), 
                                    0 0 18px rgba(var(--electric-cyan-rgb), 0.4);
            --timer-progress-circle-color: var(--electric-cyan);
        }

        @keyframes subtlePulse { 0%, 100% { opacity: 0.7; transform: scale(1); } 50% { opacity: 1; transform: scale(1.015); } }
        @keyframes electricBorder {
            0% { box-shadow: 0 0 6px rgba(var(--electric-cyan-rgb), 0.6), inset 0 0 4px rgba(var(--electric-cyan-rgb), 0.4); border-color: rgba(var(--electric-cyan-rgb), 0.7); }
            50% { box-shadow: 0 0 18px rgba(var(--electric-blue-rgb), 0.8), inset 0 0 10px rgba(var(--electric-blue-rgb), 0.6); border-color: rgba(var(--electric-blue-rgb), 0.9); }
            100% { box-shadow: 0 0 6px rgba(var(--electric-cyan-rgb), 0.6), inset 0 0 4px rgba(var(--electric-cyan-rgb), 0.4); border-color: rgba(var(--electric-cyan-rgb), 0.7); }
        }
        @keyframes textGlowPulseState {
            0%, 100% { text-shadow: 0 0 5px rgba(var(--current-timer-state-color-rgb), 0.7), 0 0 10px rgba(var(--current-timer-state-color-rgb), 0.5), 0 0 15px rgba(var(--current-timer-state-color-rgb), 0.3); }
            50% { text-shadow: 0 0 8px rgba(var(--current-timer-state-color-rgb), 0.9), 0 0 15px rgba(var(--current-timer-state-color-rgb), 0.7), 0 0 25px rgba(var(--current-timer-state-color-rgb), 0.5); }
        }
        @keyframes completed-pulse {
            0% { transform: scale(1); box-shadow: 0 0 10px 10px rgba(var(--completed-color-rgb), 0.2); }
            50% { transform: scale(1.05); box-shadow: 0 0 25px 25px rgba(var(--completed-color-rgb), 0.4); }
            100% { transform: scale(1); box-shadow: 0 0 10px 10px rgba(var(--completed-color-rgb), 0.2); }
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes gold-glow {
            0%, 100% { text-shadow: 0 0 4px #fff, 0 0 8px #FFD700, 0 0 12px #FFD700; }
            50% { text-shadow: 0 0 8px #fff, 0 0 16px #FFD700, 0 0 24px #FF8C00; }
        }
        @keyframes slow-rotate {
            0% { transform: rotate(-8deg); }
            50% { transform: rotate(8deg); }
            100% { transform: rotate(-8deg); }
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; font-size: 16px; }
        body {
            font-family: var(--font-family-main); background-color: var(--bg-color); color: var(--primary-text-color); line-height: 1.65;
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease; display: flex; flex-direction: column;
            min-height: 100vh; -webkit-font-smoothing: antialiased; overflow-x: hidden;
            background-image: radial-gradient(ellipse at center, rgba(var(--electric-blue-rgb), 0.08) 0%, transparent 60%), linear-gradient(0deg, rgba(var(--bg-color-dark-rgb), 0.5) 0%, rgba(var(--bg-color-dark-rgb), 0.9) 100%);
            position: relative; 
        }
        body::before { 
            content: ""; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-image: linear-gradient(rgba(var(--electric-blue-rgb), 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(var(--electric-blue-rgb), 0.05) 1px, transparent 1px);
            background-size: 30px 30px; z-index: -1; opacity: 0.7;
        }
        
        body.workout-active { overflow: hidden; }
        body.workout-active header { transform: translateY(-100%); opacity: 0; visibility: hidden; transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out, visibility 0s linear 0.4s; }
        body.workout-active footer { display: none; }
        body.workout-active main { position: fixed; inset: 0; padding: 20px 0; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow-y: auto; z-index: 100; }
        body.workout-active .app-section:not(#workout-section) { display: none; }
        body.workout-active #workout-section { margin: auto 0; border: none; background: transparent; box-shadow: none; padding: 0; max-height: 100%; }

        .container { max-width: 1200px; margin: 0 auto; padding: 30px 25px; width: 100%; flex-grow: 1; display: flex; flex-direction: column; }
        
        header {
            padding: 15px 0; background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.5); backdrop-filter: blur(8px) saturate(150%);
            border-bottom: 1px solid rgba(var(--electric-blue-rgb), 0.3); box-shadow: 0 2px 15px rgba(var(--electric-blue-rgb), 0.1);
            position: sticky; top:0; z-index: 1000; 
            transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out, visibility 0s linear 0s; 
        }

        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; padding: 0 25px; flex-wrap: wrap; gap: 15px 20px; }
        header h1 { font-size: 1.6em; color: var(--primary-text-color); margin: 0; font-weight: 700; display: flex; align-items: center; gap: 10px; font-family: var(--font-family-titles); text-shadow: 0 0 8px rgba(var(--electric-cyan-rgb), 0.7); }
        header h1 i { color: var(--electric-cyan); animation: subtlePulse 3s infinite ease-in-out; }
        nav ul { list-style: none; display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; align-items: baseline; }
        nav button, nav a.nav-link {
            background: none; border: none; color: var(--secondary-text-color); font-size: 0.9em; font-weight: 500; padding: 8px 12px;
            cursor: pointer; text-decoration: none; transition: all var(--transition-speed) ease; position: relative;
            border-radius: var(--border-radius-sm); border: 1px solid transparent; display: inline-flex; align-items: center; gap: 6px;
        }
        nav button:hover, nav a.nav-link:hover:not(.disabled-link-look) { color: var(--primary-text-color); background-color: rgba(var(--electric-blue-rgb), 0.1); border-color: rgba(var(--electric-blue-rgb), 0.4); text-shadow: 0 0 5px rgba(var(--electric-blue-rgb), 0.5); }
        nav a.nav-link.disabled-link-look { opacity: 0.5; pointer-events: none; cursor: not-allowed; }
        nav button.active { color: var(--electric-cyan); font-weight: 600; background-color: rgba(var(--electric-cyan-rgb), 0.15); border-color: var(--electric-cyan); box-shadow: 0 0 10px rgba(var(--electric-cyan-rgb), 0.3); }
        nav button:disabled { color: rgba(156, 163, 175, 0.4); cursor: not-allowed; background-color: transparent !important; border-color: transparent !important; opacity: 0.6; pointer-events: none; }
        nav a.nav-link i, #edit-program-btn i { margin-right: 5px; }
        .header-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        #drive-status-text, #signin-button {
            background-color: transparent; border: 1px solid var(--border-color-dark); color: var(--secondary-text-color-dark);
            padding: 5px 12px; border-radius: var(--border-radius-md); font-size: 0.9em; font-weight: 500; cursor: pointer;
            transition: all var(--transition-speed) ease; display: inline-flex; align-items: center; gap: 5px;
        }
        #signin-button:disabled { opacity: 0.5; cursor: not-allowed; border-color: var(--border-color-dark) !important; color: var(--secondary-text-color-dark) !important; background-color: transparent !important; box-shadow: none !important; text-shadow: none !important; pointer-events: auto; }
        #drive-status-text:hover, #signin-button:not(:disabled):hover { border-color: var(--electric-blue); color: var(--electric-blue); background-color: rgba(var(--electric-blue-rgb), 0.1); }
        #drive-status.success #drive-status-text { border-color: var(--neon-green); color: var(--neon-green); cursor: default; }
        #drive-status.loading #drive-status-text { border-color: var(--neon-yellow); color: var(--neon-yellow); }
        #drive-status.error #drive-status-text { border-color: var(--neon-red); color: var(--neon-red); }
        #signin-button { border-color: var(--neon-green); color: var(--neon-green); }
        #drive-status { display: inline-flex; align-items: center; gap: 10px; margin-left: 10px; padding: 0; background: none; border: none; font-size: 1em; color: inherit; }
        body.logged-out #signin-button { display: inline-flex; } body.logged-out #drive-status { display: none; }
        body.logged-in #signin-button { display: none; } body.logged-in #drive-status { display: inline-flex; }
        
        main { flex-grow: 1; display: flex; flex-direction: column; align-items: center; padding-top: 40px; position: relative; transition: all 0.3s ease-in-out; }
        
        .app-section {
            background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.6); backdrop-filter: blur(10px) saturate(130%);
            border: 1px solid rgba(var(--electric-blue-rgb), 0.2); width: 100%; 
            transition: opacity var(--section-transition-speed) ease-in-out, transform 0.3s ease-in-out, visibility 0s linear var(--section-transition-speed);
            opacity: 1; visibility: visible; border-radius: var(--border-radius-lg);
            box-shadow: 0 5px 25px rgba(var(--bg-color-dark-rgb), 0.5), inset 0 0 15px rgba(var(--electric-blue-rgb), 0.1);
        }
        #home-section { padding: 0; background: transparent; border: none; box-shadow: none; backdrop-filter: none; }
        .home-grid { display: flex; flex-wrap: wrap; gap: 30px; width: 100%; }
        .home-main-content { flex: 1 1 60%; min-width: 300px; display: flex; flex-direction: column; gap: 25px; }
        .home-sidebar { flex: 1 1 35%; min-width: 280px; display: flex; flex-direction: column; gap: 25px; }

        .sidebar-module {
            background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.6); backdrop-filter: blur(10px) saturate(130%);
            padding: 20px; border: 1px solid rgba(var(--electric-blue-rgb), 0.2);
            border-radius: var(--border-radius-lg);
            box-shadow: 0 5px 25px rgba(var(--bg-color-dark-rgb), 0.5), inset 0 0 15px rgba(var(--electric-blue-rgb), 0.1);
            animation: fadeIn 0.5s ease-out forwards;
        }
        .sidebar-module h3 { font-family: var(--font-family-titles); color: var(--primary-text-color); font-size: 1.1em; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .sidebar-module h3 i { color: var(--electric-cyan); }
        
        .consistency-info { display: flex; flex-direction: column; gap: 12px; width: 100%; margin-bottom: 15px;}
        .weekly-goal-progress-bar { width: 100%; height: 8px; background-color: var(--border-color); border-radius: 4px; overflow: hidden; }
        .weekly-goal-progress { height: 100%; width: 0%; background: linear-gradient(90deg, var(--electric-blue), var(--electric-cyan)); border-radius: 4px; transition: width 0.5s ease; }
        .consistency-text { font-size: 0.9em; color: var(--secondary-text-color); }
        .consistency-text strong { color: var(--primary-text-color); }
        .streak-counter { font-size: 1.1em; font-weight: 700; transition: color 0.5s ease; }
        .streak-counter i { margin-right: 5px; }
        .streak-bronze { color: #CD7F32; }
        .streak-silver { color: #C0C0C0; }
        .streak-gold { color: #FFD700; animation: gold-glow 2s infinite ease-in-out; }
        .streak-gold i { animation: slow-rotate 4s infinite ease-in-out; }

        .calendar-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calendar-nav button { background: none; border: none; color: var(--secondary-text-color); cursor: pointer; font-size: 1.2em; padding: 5px; border-radius: 50%; width: 30px; height: 30px; transition: background-color 0.2s, color 0.2s; }
        .calendar-nav button:hover { background-color: var(--border-color); color: var(--primary-text-color); }
        .calendar-title { font-weight: 500; font-family: var(--font-family-titles); }
        .monthly-calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .calendar-header { font-size: 0.8em; color: var(--secondary-text-color); padding-bottom: 5px; }
        .calendar-day { position: relative; font-size: 0.9em; padding: 5px 0; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; margin: 0 auto; }
        .calendar-day.other-month { color: #4A5568; }
        .calendar-day.today { background-color: rgba(var(--electric-blue-rgb), 0.2); font-weight: bold; }
        .day-dot { position: absolute; bottom: 4px; left: 50%; transform: translateX(-50%); width: 6px; height: 6px; background-color: var(--electric-cyan); border-radius: 50%; box-shadow: 0 0 5px var(--electric-cyan); }

        .session-card-large {
            background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.7); border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg); transition: all 0.3s ease; 
            animation: fadeIn 0.5s ease-out forwards;
            position: relative;
            cursor: pointer;
        }
        .session-card-large:hover, .session-card-large.edit-mode-hover { border-color: var(--electric-cyan); transform: translateY(-3px); box-shadow: 0 8px 25px rgba(var(--electric-cyan-rgb), 0.15); }
        .session-card-large.edit-mode-active { border-color: var(--neon-yellow); box-shadow: 0 8px 25px rgba(var(--neon-yellow-rgb), 0.15); cursor: pointer; }
        
        .toggle-details-btn {
            position: absolute; bottom: 15px; right: 15px; z-index: 2;
            color: var(--secondary-text-color); font-size: 1.2em;
            padding: 8px; border-radius: 50%; cursor: pointer;
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            transition: color 0.2s, background-color 0.2s;
        }
        .toggle-details-btn:hover { color: var(--electric-cyan); background-color: rgba(var(--electric-cyan-rgb), 0.1); }
        
        .session-card-summary { padding: 20px; }
        .session-card-header { display: flex; justify-content: space-between; align-items: center; }
        .session-card-header h3 { font-family: var(--font-family-titles); color: var(--electric-cyan); font-size: 1.4em; margin: 0; text-shadow: 0 0 8px rgba(var(--electric-cyan-rgb), 0.5); }
        .session-card-header .last-session-info { font-size: 0.8em; font-style: italic; color: var(--secondary-text-color); opacity: 0.8; text-align: right; }
        .session-card-large p { font-size: 0.9em; color: var(--secondary-text-color); margin: 10px 0 0 0; min-height: 20px; }
        .sparkline-chart-container { min-height: 80px; position: relative; margin-top: 15px; }
        .chart-placeholder { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 0.85em; color: var(--secondary-text-color); }
        
        .session-card-details { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out, padding 0.5s ease-out; padding: 0 20px; }
        .session-card-large.expanded .session-card-details { max-height: 2000px; padding: 10px 20px 20px; }
        .exercise-detail-item { padding: 15px 0; border-top: 1px solid var(--border-color); }
        .exercise-detail-item:first-child { border-top: none; }
        .exercise-detail-header { font-weight: 500; color: var(--primary-text-color); margin-bottom: 10px; }
        .detailed-chart-container { min-height: 180px; }

        .workout-section { text-align: center; }
        .section-hidden {
            opacity: 0; max-height: 0 !important; padding-top: 0 !important; padding-bottom: 0 !important; margin-bottom: 0 !important;
            border-width: 0 !important; visibility: hidden; transform: translateY(20px) scale(0.98);
            transition: opacity var(--section-transition-speed) ease-in-out, visibility 0s linear var(--section-transition-speed), 
                        max-height 0s linear var(--section-transition-speed), padding var(--section-transition-speed) ease-out,
                        margin var(--section-transition-speed) ease-out, border-width var(--section-transition-speed) ease-out,
                        transform 0.3s ease-in-out;
        }
        .timer-and-image-wrapper { display: flex; flex-direction: column; align-items: center; gap: 20px; margin-bottom: 25px; }
        .exercise-image-area {
            width: 100%; max-width: 260px; margin: 0 auto; padding: 8px; background-color: rgba(var(--secondary-bg-color-dark-rgb),0.4);
            border: 1px solid rgba(var(--electric-cyan-rgb), 0.3); border-radius: var(--border-radius-md); display: none; 
            justify-content: center; align-items: center; box-shadow: 0 4px 12px rgba(var(--bg-color-dark-rgb), 0.4), inset 0 0 8px rgba(var(--electric-cyan-rgb),0.2);
            z-index: 5; transition: opacity 0.4s ease-in-out, transform 0.3s ease-in-out; opacity: 0; transform: scale(0.95) translateY(10px);
        }
        .exercise-image-area.visible { display: flex; opacity: 1; transform: scale(1) translateY(0); }
        #exercise-image-display { display: block; max-width: 100%; max-height: 200px; object-fit: contain; border-radius: var(--border-radius-sm); filter: brightness(0.8) contrast(1.1); }
        .timer-display { position: relative; display: flex; justify-content: center; align-items: center; width: 280px; height: 280px; margin: 0 auto; cursor: pointer; user-select: none; -webkit-tap-highlight-color: transparent; }
        .timer-progress-circle-container { position: absolute; top: 50%; left: 50%; width: 230px; height: 230px; transform: translate(-50%, -50%); pointer-events: none; }
        .timer-progress-circle { fill: none; stroke: var(--timer-progress-circle-color); stroke-width: 6; stroke-linecap: round; transform-origin: center; transform: rotate(-90deg); transition: stroke-dashoffset 0.3s linear, stroke 0.3s ease; }
        .timer-progress-circle-bg { fill: none; stroke: rgba(var(--electric-blue-rgb), 0.15); stroke-width: 6; }
        .timer-step-info-display { position: absolute; top: 15px; left: 0; right: 0; padding: 0 20px; display: flex; justify-content: space-between; font-family: var(--font-family-timer); font-size: 0.8em; color: var(--secondary-text-color); opacity: 0; transition: opacity var(--transition-speed) ease; pointer-events: none; z-index: 15; }
        .timer-step-info-display.visible { opacity: 0.8; }
        #workout-step-current-display, #workout-step-total-display { padding: 3px 8px; background-color: rgba(var(--bg-color-dark-rgb), 0.6); border-radius: var(--border-radius-sm); text-shadow: 0 0 4px rgba(var(--electric-cyan-rgb), 0.6); border: 1px solid rgba(var(--electric-cyan-rgb), 0.2); }
        .reactor { position: relative; width: 180px; height: 180px; display: flex; align-items: center; justify-content: center; border-radius: 50%; overflow: hidden; z-index: 10; background-color: transparent; }
        .reactor::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(var(--bg-color-dark-rgb), 0.3); z-index: 1; border-radius: 50%; }
        .triangle { z-index: 5; position: absolute; top: 66%; left: 50%; transform: translate(-50%, -50%); width: 155px; aspect-ratio: 1; background-color: var(--electric-cyan); -webkit-clip-path: polygon(50% 88%, 0 0, 100% 0); clip-path: polygon(50% 88%, 0 0, 100% 0); transition: transform 0.5s ease-out, background-color var(--transition-speed) ease; }
        .triangle::after { content: ''; display: block; position: absolute; top: 45%; left: 50%; z-index: 6; width: 120px; height: 120px; transform: translate(-50%, -50%); background-color: var(--bg-color); -webkit-clip-path: polygon(50% 90%, 0 0, 100% 0); clip-path: polygon(50% 90%, 0 0, 100% 0); transition: background-color var(--transition-speed) ease; }
        @keyframes rotate-right { to { transform: rotate(360deg); } } @keyframes rotate-left { to { transform: rotate(-360deg); } }
        @keyframes rotate-left-right { 0% { transform: translate(-50%, -50%) rotate(0deg); } 50% { transform: translate(-50%, -50%) rotate(-180deg); } 100% { transform: translate(-50%, -50%) rotate(0deg); } }
        .circle-1 { z-index: 2; position: absolute; width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(rgba(var(--electric-cyan-rgb), 0.8), rgba(var(--electric-blue-rgb), 0.8)); animation: rotate-right 2s linear infinite; }
        .circle-1::before { content: ''; position: absolute; z-index: 1; inset: 10px; border-radius: 50%; background-color: var(--bg-color); transition: background-color var(--transition-speed) ease; }
        .circle-1 span { position: absolute; width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(rgba(var(--electric-cyan-rgb), 0.8), rgba(var(--electric-blue-rgb), 0.8)); top:0; left: 0; }
        .circle-1 span:nth-child(1) { filter: blur(15px); } .circle-1 span:nth-child(2) { filter: blur(15px); } .circle-1 span:nth-child(3) { filter: blur(15px); } .circle-1 span:nth-child(4) { filter: blur(75px); }
        .circle-2 { z-index: 4; position: absolute; top: 30px; left: 30px; width: calc(100% - 60px); height: calc(100% - 60px); border-radius: 50%; border: 10px solid var(--electric-cyan); box-shadow: 0 0 30px 30px rgba(var(--electric-cyan-rgb), 0.2); animation: rotate-left 4s linear infinite; transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease; }
        .circle-2 span { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: calc(100% + 20px); height: 10px; background-color: var(--bg-color); transition: background-color var(--transition-speed) ease; }
        .circle-2 span:nth-child(1) { transform: translate(-50%, -50%) rotate(90deg); } .circle-2 span:nth-child(2) { transform: translate(-50%, -50%) rotate(45deg); } .circle-2 span:nth-child(3) { transform: translate(-50%, -50%) rotate(-45deg); }
        .circle-2 span:nth-child(4) { transform: translate(-50%, -50%) rotate(30deg); } .circle-2 span:nth-child(5) { transform: translate(-50%, -50%) rotate(-30deg); } .circle-2 span:nth-child(6) { transform: translate(-50%, -50%) rotate(0deg); }
        .circle-2 span:nth-child(7) { transform: translate(-50%, -50%) rotate(55deg); height: 5px; } .circle-2 span:nth-child(8) { transform: translate(-50%, -50%) rotate(125deg); height: 5px; }
        .circle-3 { z-index: 7; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: 50%; box-shadow: 0 0 10px 10px rgba(var(--electric-cyan-rgb), 0.2); transition: box-shadow var(--transition-speed) ease; }
        .circle-3::after { content: ''; display: block; width: 115px; height: 115px; border-radius: 50%; border: 3px dotted rgba(var(--electric-cyan-rgb), 0.8); animation: rotate-right 10s linear infinite; transition: border-color var(--transition-speed) ease; }
        .circle-4 { z-index: 8; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100px; height: 100px; border-radius: 50%; box-shadow: 0 0 10px 10px rgba(var(--electric-cyan-rgb), 0.1); animation: rotate-left-right 20s infinite ease-in; transition: box-shadow var(--transition-speed) ease; }
        .circle-4 span { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; height: 100%; border-radius: 50%; border: 3px solid; border-color: var(--electric-cyan) transparent transparent; transition: border-color var(--transition-speed) ease; }
        .circle-4 span:nth-child(1) { transform: translate(-50%, -50%) rotate(45deg); } .circle-4 span:nth-child(2) { transform: translate(-50%, -50%) rotate(-75deg); } .circle-4 span:nth-child(3) { transform: translate(-50%, -50%) rotate(165deg); }
        .circle-5 { z-index: 9; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 64px; height: 64px; border-radius: 50%; animation: rotate-left-right 10s infinite ease-in; background-color: rgba(var(--electric-cyan-rgb), 0.2); box-shadow: 0 0 20px 20px rgba(var(--electric-cyan-rgb), 0.2); transition: background-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease, opacity 0.3s ease; }
        .circle-5 span { position: absolute; inset: 0; z-index: 10; width: 54px; height: 54px; border-radius: 50%; border: 5px solid; border-color: var(--electric-cyan) transparent transparent; margin: auto; transition: border-color var(--transition-speed) ease; }
        .circle-5 span:nth-child(1) { transform: rotate(0deg); } .circle-5 span:nth-child(2) { transform: rotate(120deg); } .circle-5 span:nth-child(3) { transform: rotate(240deg); }
        .circle-6 { z-index: 11; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .circle-6::after { content: ''; display: block; width: 40px; height: 40px; border-radius: 50%; border: 3px dashed var(--electric-cyan); animation: rotate-left 5s infinite ease-in; transition: border-color var(--transition-speed) ease; }
        .circle-7 { z-index: 12; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .circle-7::after { content: ''; display: block; width: 27px; height: 27px; border-radius: 50%; background-color: var(--electric-cyan); animation: rotate-left 5s infinite ease-in; box-shadow: 0 0 5px 5px rgba(var(--electric-cyan-rgb), 0.2); transition: box-shadow var(--transition-speed) ease, transform 0.3s ease, background-color var(--transition-speed) ease; }
        .circle-8 { z-index: 13; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 15px; height: 15px; border-radius: 50%; animation: rotate-left-right 5s infinite ease-in; }
        .circle-8 span { position: absolute; inset: 0; z-index: 14; width: 13px; height: 13px; border-radius: 50%; border: 1px solid; border-color: var(--bg-color) transparent transparent; margin: auto; transition: border-color var(--transition-speed) ease; }
        .circle-8 span:nth-child(1) { transform: rotate(120deg); } .circle-8 span:nth-child(2) { transform: rotate(240deg); }
        @keyframes pulsePausedGlow { 0%, 100% { box-shadow: 0 0 5px 5px rgba(var(--paused-color-rgb), 0.2); transform: scale(1); } 50% { box-shadow: 0 0 10px 10px rgba(var(--paused-color-rgb), 0.4); transform: scale(1.1); } }
        @keyframes pulsePausedRing { 0%, 100% { box-shadow: 0 0 20px 20px rgba(var(--paused-color-rgb), 0.2); opacity: 1; } 50% { box-shadow: 0 0 25px 25px rgba(var(--paused-color-rgb), 0.3); opacity: 0.8; } }
        .state-paused .circle-7::after { background-color: var(--paused-color-val); animation: pulsePausedGlow 1.5s infinite ease-in-out; }
        .state-paused .circle-5 { animation: pulsePausedRing 1.5s infinite ease-in-out; background-color: rgba(var(--paused-color-rgb), 0.3); }
        .state-paused .circle-1, .state-paused .circle-1 span { background: linear-gradient(rgba(var(--paused-color-rgb), 0.8), rgba(var(--paused-color-rgb),0.5));}
        .state-paused .circle-2 { border-color: var(--paused-color-val); box-shadow: 0 0 30px 30px rgba(var(--paused-color-rgb), 0.2); }
        .state-paused .circle-3::after { border-color: rgba(var(--paused-color-rgb), 0.8); }
        .state-paused .circle-4 span { border-color: var(--paused-color-val) transparent transparent; } .state-paused .circle-5 span { border-color: var(--paused-color-val) transparent transparent; }
        .state-paused .circle-6::after { border-color: var(--paused-color-val); } .state-paused .triangle { background-color: var(--paused-color-val); }
        .state-paused .timer-progress-circle { stroke: var(--paused-color-val); }
        @keyframes rotateSpinOnce { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }
        .state-preparing .triangle { animation: rotateSpinOnce 5s linear infinite; background-color: var(--preparing-color-val); }
        .state-preparing .circle-1, .state-preparing .circle-1 span { background: linear-gradient(rgba(var(--preparing-color-rgb), 0.8), rgba(var(--preparing-color-rgb),0.5));}
        .state-preparing .circle-2 { border-color: var(--preparing-color-val); box-shadow: 0 0 30px 30px rgba(var(--preparing-color-rgb), 0.2); }
        .state-preparing .circle-3::after { border-color: rgba(var(--preparing-color-rgb), 0.8); }
        .state-preparing .circle-4 span { border-color: var(--preparing-color-val) transparent transparent; }
        .state-preparing .circle-5 { background-color: rgba(var(--preparing-color-rgb),0.2); box-shadow: 0 0 20px 20px rgba(var(--preparing-color-rgb),0.2);}
        .state-preparing .circle-5 span { border-color: var(--preparing-color-val) transparent transparent; }
        .state-preparing .circle-6::after { border-color: var(--preparing-color-val); }
        .state-preparing .circle-7::after { background-color: var(--preparing-color-val); box-shadow: 0 0 5px 5px rgba(var(--preparing-color-rgb),0.2); }
        .state-preparing .timer-progress-circle { stroke: var(--preparing-color-val); }
        .triangle.spin-transition { animation: rotateSpinOnce 0.6s ease-out forwards; }
        #time-left { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 20; font-family: var(--font-family-timer); font-size: 3.6em; font-weight: 700; color: var(--timer-text-color-main); text-shadow: var(--timer-text-glow-main); transition: font-size 0.2s ease; pointer-events: none; white-space: nowrap; }
        .state-exercise #time-left { font-size: 4em; letter-spacing: 0.05em; }
        .state-exercise .triangle { background-color: var(--exercise-color-val); }
        .state-exercise[data-timed="true"] .triangle { background-color: var(--exercise-timed-color-val); }
        .state-exercise .circle-1, .state-exercise .circle-1 span { background: linear-gradient(rgba(var(--exercise-color-rgb), 0.8), rgba(var(--exercise-color-rgb),0.5));}
        .state-exercise[data-timed="true"] .circle-1, .state-exercise[data-timed="true"] .circle-1 span { background: linear-gradient(rgba(var(--exercise-timed-color-rgb), 0.8), rgba(var(--exercise-timed-color-rgb),0.5));}
        .state-exercise .circle-2 { border-color: var(--exercise-color-val); box-shadow: 0 0 30px 30px rgba(var(--exercise-color-rgb), 0.2); }
        .state-exercise[data-timed="true"] .circle-2 { border-color: var(--exercise-timed-color-val); box-shadow: 0 0 30px 30px rgba(var(--exercise-timed-color-rgb), 0.2); }
        .state-exercise .circle-3::after { border-color: rgba(var(--exercise-color-rgb), 0.8); }
        .state-exercise[data-timed="true"] .circle-3::after { border-color: rgba(var(--exercise-timed-color-rgb), 0.8); }
        .state-exercise .circle-4 span { border-color: var(--exercise-color-val) transparent transparent; }
        .state-exercise[data-timed="true"] .circle-4 span { border-color: var(--exercise-timed-color-val) transparent transparent; }
        .state-exercise .circle-5 { background-color: rgba(var(--exercise-color-rgb),0.2); box-shadow: 0 0 20px 20px rgba(var(--exercise-color-rgb),0.2);}
        .state-exercise[data-timed="true"] .circle-5 { background-color: rgba(var(--exercise-timed-color-rgb),0.2); box-shadow: 0 0 20px 20px rgba(var(--exercise-timed-color-rgb),0.2);}
        .state-exercise .circle-5 span { border-color: var(--exercise-color-val) transparent transparent; }
        .state-exercise[data-timed="true"] .circle-5 span { border-color: var(--exercise-timed-color-val) transparent transparent; }
        .state-exercise .circle-6::after { border-color: var(--exercise-color-val); }
        .state-exercise[data-timed="true"] .circle-6::after { border-color: var(--exercise-timed-color-val); }
        .state-exercise .circle-7::after { background-color: var(--exercise-color-val); box-shadow: 0 0 5px 5px rgba(var(--exercise-color-rgb),0.2); }
        .state-exercise[data-timed="true"] .circle-7::after { background-color: var(--exercise-timed-color-val); box-shadow: 0 0 5px 5px rgba(var(--exercise-timed-color-rgb),0.2); }
        .state-exercise .timer-progress-circle { stroke: var(--exercise-color-val); } 
        .state-exercise[data-timed="true"] .timer-progress-circle { stroke: var(--exercise-timed-color-val); }
        .state-break .triangle { background-color: var(--break-color-val); }
        .state-break .circle-1, .state-break .circle-1 span { background: linear-gradient(rgba(var(--break-color-rgb), 0.8), rgba(var(--break-color-rgb),0.5));}
        .state-break .circle-2 { border-color: var(--break-color-val); box-shadow: 0 0 30px 30px rgba(var(--break-color-rgb), 0.2); }
        .state-break .circle-3::after { border-color: rgba(var(--break-color-rgb), 0.8); }
        .state-break .circle-4 span { border-color: var(--break-color-val) transparent transparent; }
        .state-break .circle-5 { background-color: rgba(var(--break-color-rgb),0.2); box-shadow: 0 0 20px 20px rgba(var(--break-color-rgb),0.2);}
        .state-break .circle-5 span { border-color: var(--break-color-val) transparent transparent; }
        .state-break .circle-6::after { border-color: var(--break-color-val); }
        .state-break .circle-7::after { background-color: var(--break-color-val); box-shadow: 0 0 5px 5px rgba(var(--break-color-rgb),0.2); }
        .state-break .timer-progress-circle { stroke: var(--break-color-val); }
        .state-get-ready .triangle { background-color: var(--get-ready-color-val); }
        .state-get-ready .circle-1, .state-get-ready .circle-1 span { background: linear-gradient(rgba(var(--get-ready-color-rgb), 0.8), rgba(var(--get-ready-color-rgb),0.5));}
        .state-get-ready .circle-2 { border-color: var(--get-ready-color-val); box-shadow: 0 0 30px 30px rgba(var(--get-ready-color-rgb), 0.2); }
        .state-get-ready .circle-3::after { border-color: rgba(var(--get-ready-color-rgb), 0.8); }
        .state-get-ready .circle-4 span { border-color: var(--get-ready-color-val) transparent transparent; }
        .state-get-ready .circle-5 { background-color: rgba(var(--get-ready-color-rgb),0.2); box-shadow: 0 0 20px 20px rgba(var(--get-ready-color-rgb),0.2);}
        .state-get-ready .circle-5 span { border-color: var(--get-ready-color-val) transparent transparent; }
        .state-get-ready .circle-6::after { border-color: var(--get-ready-color-val); }
        .state-get-ready .circle-7::after { background-color: var(--get-ready-color-val); box-shadow: 0 0 5px 5px rgba(var(--get-ready-color-rgb),0.2); }
        .state-get-ready .timer-progress-circle { stroke: var(--get-ready-color-val); }
        .state-finished .triangle, .state-completed .triangle { background-color: var(--finished-color-val); }
        .state-finished .circle-1, .state-finished .circle-1 span, .state-completed .circle-1, .state-completed .circle-1 span { background: linear-gradient(rgba(var(--finished-color-rgb), 0.8), rgba(var(--finished-color-rgb),0.5));}
        .state-finished .circle-2, .state-completed .circle-2 { border-color: var(--finished-color-val); box-shadow: 0 0 30px 30px rgba(var(--finished-color-rgb), 0.2); }
        .state-finished .circle-3::after, .state-completed .circle-3::after { border-color: rgba(var(--finished-color-rgb), 0.8); }
        .state-finished .circle-4 span, .state-completed .circle-4 span { border-color: var(--finished-color-val) transparent transparent; }
        .state-finished .circle-5, .state-completed .circle-5 { background-color: rgba(var(--finished-color-rgb),0.2); box-shadow: 0 0 20px 20px rgba(var(--finished-color-rgb),0.2);}
        .state-finished .circle-5 span, .state-completed .circle-5 span { border-color: var(--finished-color-val) transparent transparent; }
        .state-finished .circle-6::after, .state-completed .circle-6::after { border-color: var(--finished-color-val); }
        .state-finished .circle-7::after, .state-completed .circle-7::after { background-color: var(--finished-color-val); box-shadow: 0 0 5px 5px rgba(var(--finished-color-rgb),0.2); }
        .state-finished .timer-progress-circle, .state-completed .timer-progress-circle { stroke: var(--finished-color-val); }
        .state-completed .circle-5 { animation: completed-pulse 1s ease-out; }
        .state-completed #time-left { font-size: 5em; }
        
        .workout-info { margin-bottom: 20px; min-height: auto; position: relative; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        #current-exercise-name-display { display: block; font-size: 1.3em; font-weight: 600; color: var(--primary-text-color); margin-bottom: 8px; padding: 0 10px; line-height: 1.3; text-shadow: none; }
        body.state-exercise #current-exercise-name-display, body.state-break #current-exercise-name-display, body.state-preparing #current-exercise-name-display { animation: textGlowPulseState 2s infinite ease-in-out; }
        body.state-exercise #current-exercise-name-display { color: var(--color-exercise); }
        body.state-exercise[data-timed="true"] #current-exercise-name-display { color: var(--color-exercise-timed); }
        body.state-break #current-exercise-name-display, body.state-preparing #current-exercise-name-display, body.state-get-ready #current-exercise-name-display { color: var(--color-break); }
        
        #current-exercise-container { display: flex; flex-direction: column; align-items: center; gap: 10px; font-size: 1em; color: var(--secondary-text-color); min-height: auto; width: 100%; }
        
        .exercise-details, .break-info { display: flex; flex-direction: column; flex-wrap: nowrap; justify-content: center; align-items: center; gap: 8px; background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.5); padding: 12px 15px; border-radius: var(--border-radius-sm); border: 1px solid rgba(var(--accent-border-color), 0.5); width: fit-content; max-width: 95%; box-shadow: 0 2px 5px rgba(var(--bg-color-dark-rgb),0.2); }
        .exercise-details .main-stats { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px 20px; font-size: 1.1em; font-weight: 500; color: var(--primary-text-color); margin-bottom: 5px;}
        .exercise-details .main-stats span { display: flex; align-items: center; gap: 8px; }
        .exercise-details .main-stats i { color: var(--color-exercise); opacity: 0.9; }
        .exercise-details[data-timed="true"] .main-stats i { color: var(--color-exercise-timed); }
        .sets-info-text { font-size: 0.8em; color: var(--secondary-text-color); opacity: 0.85; text-align: center; width: 100%; letter-spacing: 0.02em; padding: 0 5px; line-height: 1.4; }
        .sets-info-text i { color: var(--electric-cyan); margin-right: 5px; } 
        
        .break-info { font-size: 1em; }
        .break-info > i { font-size: 1.2em; margin-bottom: 3px;} 
        .break-info > span { font-weight: 500; color: var(--primary-text-color); } 
        .next-exercise-preview { font-size: 0.85em; color: var(--secondary-text-color); margin-top: 10px; padding: 12px 15px; border: 1px dashed; border-radius: var(--border-radius-sm); background-color: rgba(var(--bg-color-dark-rgb), 0.2); display: flex; flex-direction: column; align-items: center; gap: 8px; text-align: center; width: fit-content; max-width: 95%; }
        .next-exercise-preview > .title { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .next-exercise-preview > .title i { opacity: 0.8; font-size: 1.1em; }
        .next-exercise-preview strong { color: var(--primary-text-color); font-weight: 600; display: block; font-size: 1.1em;}
        .next-exercise-preview .next-details-grid { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 8px 18px; font-size: 1.2em; font-weight: 700; color: var(--primary-text-color); font-family: var(--font-family-timer); }
        .next-exercise-preview .next-details-grid span { display: inline-flex; align-items: center; gap: 6px; padding: 5px 10px; background-color: rgba(var(--bg-color-dark-rgb), 0.4); border-radius: var(--border-radius-sm); }
        .next-exercise-preview .next-details-grid i { color: var(--electric-cyan); opacity: 0.8; }
        
        .controls { display: flex; justify-content: center; gap: 8px; margin-top: 20px; flex-wrap: wrap; }
        .controls button { background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.4); border: 1px solid var(--border-color); color: var(--secondary-text-color); padding: 8px 14px; border-radius: var(--border-radius-md); font-size: 0.9em; font-weight: 500; cursor: pointer; transition: all var(--transition-speed) ease; display: inline-flex; align-items: center; justify-content: center; gap: 6px; min-width: 100px; box-shadow: 0 2px 5px rgba(var(--bg-color-dark-rgb),0.3); }
        .controls button:disabled { opacity: 0.5; cursor: not-allowed; background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.2); border-color: var(--border-color-dark); color: var(--secondary-text-color-dark); box-shadow: none !important; transform: none !important; text-shadow: none !important; pointer-events: auto; }
        .controls button:not(:disabled):hover { border-color: var(--electric-blue); color: var(--electric-blue); background-color: rgba(var(--electric-blue-rgb), 0.15); box-shadow: 0 0 10px rgba(var(--electric-blue-rgb), 0.3), inset 0 0 5px rgba(var(--electric-blue-rgb),0.1); transform: translateY(-1px); }
        .controls button i { font-size: 1em; margin-right: 4px; opacity: 0.8; transition: opacity var(--transition-speed) ease; }
        .controls button:not(:disabled):hover i { opacity: 1; }
        #start-pause-btn.start-btn:not(:disabled) { animation: electricBorder 3s infinite linear; border-color: var(--electric-cyan); }
        #start-pause-btn.start-btn:not(:disabled):hover { animation-play-state: paused; }
        .progress-tracker { font-size: 0.85em; color: var(--secondary-text-color-dark); margin-top: 15px; opacity: 0.8; font-weight: 500; display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 8px 15px; min-height: 1.2em; font-family: var(--font-family-timer); }
        #drive-connection-status-main { display: inline-flex; align-items: center; gap: 6px; color: var(--neon-green); font-weight: 500; transition: color 0.3s ease; }
        #drive-connection-status-main i.fa-google-drive { display: inline-block; font-size: 1.1em; }
        #drive-connection-status-main.error { color: var(--neon-red); } #drive-connection-status-main.loading { color: var(--neon-yellow); }
        #progress-text-area { font-weight: 500; letter-spacing: 0.05em; }
        
        .post-workout-summary { position: fixed; inset: 0; background-color: rgba(var(--bg-color-dark-rgb), 0.9); backdrop-filter: blur(8px); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; opacity: 0; visibility: hidden; pointer-events: none; transition: opacity 0.3s ease, visibility 0s linear 0.3s; }
        .post-workout-summary.visible { opacity: 1; visibility: visible; pointer-events: auto; transition: opacity 0.3s ease, visibility 0s linear 0s; }
        .post-workout-summary-content { background-color: var(--secondary-bg-color); border: 1px solid var(--border-color); border-radius: var(--border-radius-lg); box-shadow: 0 10px 30px rgba(0,0,0,0.4), 0 0 20px rgba(var(--electric-cyan-rgb), 0.1); width: 100%; max-width: 680px; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .post-workout-summary.visible .post-workout-summary-content { transform: scale(1); }
        .post-workout-summary h2 { color: var(--electric-cyan); font-size: 1.5em; font-weight: 700; padding: 20px 25px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; text-align: center; background-color: rgba(var(--bg-color-dark-rgb), 0.2); text-shadow: 0 0 5px var(--electric-cyan); }
        .summary-items-list { list-style: none; padding: 15px 25px; overflow-y: auto; flex-grow: 1; background: var(--bg-color); border-bottom: 1px solid var(--border-color); }
        .summary-item {
            --item-accent-color: var(--electric-blue-light);
            background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.4); padding: 15px; border-radius: var(--border-radius-md); margin-bottom: 15px;
            border-left: 4px solid var(--item-accent-color); transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .summary-item:last-child { margin-bottom: 0; }
        .summary-item .exercise-name { display: flex; align-items: center; color: var(--primary-text-color); font-weight: 500; font-size: 1.1em; margin-bottom: 15px; }
        .summary-item .exercise-name i { color: var(--item-accent-color); margin-right: 10px; font-size: 1.1em; }
        .summary-item .exercise-name-text { flex-grow: 1; white-space: normal; }
        .summary-item .fields-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px 20px; align-items: end; }
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        .input-group label { font-size: 0.8em; color: var(--secondary-text-color); font-weight: 500; }
        .stepper-control { display: flex; align-items: center; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); }
        .stepper-btn { background: transparent; border: none; color: var(--electric-cyan); font-size: 1.2em; padding: 8px 12px; cursor: pointer; transition: all 0.2s ease; }
        .stepper-btn:hover { background-color: rgba(var(--electric-cyan-rgb), 0.1); text-shadow: 0 0 8px var(--electric-cyan); }
        .stepper-btn:disabled { color: var(--border-color); cursor: not-allowed; background: none; text-shadow: none; }
        .stepper-value { flex-grow: 1; text-align: center; font-size: 1em; font-weight: 700; color: var(--primary-text-color); padding: 0 5px; user-select: none; }
        .resistance-controls { display: flex; gap: 10px; align-items: stretch; }
        .resistance-selector { position: relative; flex-shrink: 0; }
        .selected-resistance { display: flex; align-items: center; gap: 8px; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); padding: 8px 12px; cursor: pointer; height: 100%; transition: border-color 0.2s; }
        .selected-resistance:hover { border-color: var(--electric-cyan); }
        .selected-resistance span { font-size: 1.1em; }
        .selected-resistance i { font-size: 0.8em; color: var(--secondary-text-color); }
        .resistance-options { list-style: none; position: absolute; bottom: 100%; left: 0; background-color: var(--secondary-bg-color); border: 1px solid var(--electric-cyan); border-radius: var(--border-radius-md); z-index: 10; padding: 5px; margin-bottom: 5px; min-width: 180px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: none; }
        .resistance-selector.open .resistance-options { display: block; }
        .resistance-options li { display: flex; align-items: center; gap: 10px; padding: 8px 12px; cursor: pointer; border-radius: var(--border-radius-sm); transition: background-color 0.2s; font-size: 0.9em; }
        .resistance-options li:hover { background-color: rgba(var(--electric-cyan-rgb), 0.15); }
        .resistance-options li span { font-size: 1.2em; }
        .resistance-value-stepper .stepper-btn:hover { color: var(--electric-yellow); text-shadow: 0 0 8px var(--electric-yellow); background-color: rgba(var(--electric-yellow-rgb), 0.1); }
        .range-stepper-control { display: flex; flex-direction: column; gap: 8px; }
        .range-stepper { display: flex; align-items: center; justify-content: space-between; gap: 5px; }
        .range-stepper label { color: var(--secondary-text-color); font-size: 0.8em; min-width: 30px;}
        .range-stepper .stepper-control { flex-grow: 1; }

        .tracking-type-toggle { display: flex; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); overflow: hidden; }
        .tracking-type-toggle button { flex: 1; background: transparent; border: none; padding: 8px 10px; font-size: 0.85em; color: var(--secondary-text-color); cursor: pointer; transition: all 0.2s ease; }
        .tracking-type-toggle button.active { background-color: var(--electric-cyan); color: var(--bg-color); font-weight: 700; text-shadow: 0 0 5px rgba(0,0,0,0.3); }

        .summary-controls { padding: 20px 25px; display: flex; justify-content: center; gap: 15px; flex-shrink: 0; flex-wrap: wrap; border-top: 1px solid var(--border-color); background-color: rgba(var(--bg-color-dark-rgb), 0.2); }
        .summary-controls button { border: none; color: var(--bg-color); min-width: 180px; padding: 12px 25px; border-radius: var(--border-radius-md); font-size: 1em; font-weight: 700; cursor: pointer; transition: all var(--transition-speed) ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); text-transform: uppercase; font-family: var(--font-family-titles); letter-spacing: 0.05em; }
        .summary-controls button:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; filter: grayscale(50%); }
        #finish-summary-btn { background-color: var(--neon-green); --button-finish-glow: var(--glow-green); }
        #finish-summary-btn:not(:disabled):hover { filter: brightness(1.15); box-shadow: 0 4px 10px rgba(0,0,0,0.3), 0 0 10px var(--button-finish-glow); transform: translateY(-1px); text-shadow: 0 0 5px rgba(255,255,255,0.5); }
        
        .message-area { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.9); color: var(--primary-text-color); border: 1px solid var(--border-color); padding: 12px 25px; border-radius: var(--border-radius-md); z-index: 3000; opacity: 0; transition: all 0.5s ease; pointer-events: none; font-size: 0.95em; box-shadow: 0 4px 15px rgba(0,0,0,0.2); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); max-width: 90%; text-align: center; }
        .message-area.visible { opacity: 1; transform: translate(-50%, 0); bottom: 40px; pointer-events: auto; }
        .message-area.error-message { background-color: rgba(var(--neon-red-rgb), 0.8); color: #fff; border-color: var(--neon-red); text-shadow: 0 0 5px rgba(0,0,0,0.5); box-shadow: 0 4px 15px rgba(0,0,0,0.3), 0 0 10px var(--glow-red); }
        
        footer { padding: 25px; text-align: center; font-size: 0.9em; color: var(--secondary-text-color); border-top: 1px solid rgba(var(--electric-blue-rgb), 0.2); margin-top: 50px; background-color: rgba(var(--bg-color-dark-rgb), 0.7); backdrop-filter: blur(3px); transition: all 0.3s ease-in-out; }
        footer p { margin-bottom: 8px; }
        footer a { color: var(--electric-cyan); text-decoration: none; transition: color var(--transition-speed) ease, text-shadow var(--transition-speed) ease; }
        footer a:hover { color: var(--primary-text-color); text-decoration: underline; text-shadow: 0 0 8px var(--electric-cyan); }
        footer .fab.fa-google-drive { color: var(--neon-green); } footer .fab.fa-github { color: var(--neon-purple); }
        
        @media (min-width: 769px) { 
            .timer-and-image-wrapper { flex-direction: row; justify-content: center; align-items: center; gap: 30px; }
            .exercise-image-area { max-width: 220px; margin: 0; } 
            .timer-display { margin: 0; width: 300px; height: 300px;} 
            .reactor { width: 190px; height: 190px; } 
            .timer-progress-circle-container { width: 250px; height: 250px; }
            #current-exercise-name-display { font-size: 1.5em; } 
            .exercise-details .main-stats { font-size: 1.2em; }
        }
        @media (max-width: 900px) {
            .home-grid { flex-direction: column; }
            .home-main-content, .home-sidebar { flex-basis: auto; width: 100%; }
        }
        @media (max-width: 768px) { 
            .timer-display { width: 260px; height: 260px; } 
            .reactor { width: 170px; height: 170px; } 
            .timer-progress-circle-container { width: 220px; height: 220px; }
            #time-left { font-size: 3.0em; } 
            .triangle { width: 125px; } .triangle::after { width: 95px; height: 95px; }
            .circle-2 { border-width: 7px; } 
            .circle-5 { width: 50px; height: 50px; } .circle-5 span { width: 40px; height: 40px; }
            header h1 { font-size: 1.3em; }
            .exercise-image-area { max-width: 200px; margin-bottom: 15px; } 
            .summary-item .fields-grid { grid-template-columns: 1fr; } 
        }
        @media (max-width: 480px) { 
            .timer-display { width: 220px; height: 220px; }
            .reactor { width: 140px; height: 140px; } 
            .timer-progress-circle-container { width: 190px; height: 190px; }
            #time-left { font-size: 2.5em; } 
            .triangle { width: 100px; } .triangle::after { width: 75px; height: 75px; }
            #current-exercise-name-display { font-size: 1.1em; } 
            .exercise-details .main-stats { font-size: 1em; }
            .controls button { flex-basis: calc(50% - 6px); }
            .header-content { justify-content: center; } 
            .header-actions { justify-content: center; width: 100%; margin-top: 10px; }
            .exercise-image-area { max-width: 160px; } 
            .post-workout-summary-content { max-width: 95%; } 
            .calendar-day { width: 28px; height: 28px; font-size: 0.8em; }
        }
    </style>
</head>
<body class="logged-out dark-theme state-idle">
    <header>
        <div class="header-content">
            <h1><i class="fas fa-bolt"></i> ArmorWorkout</h1>
            <nav>
                <ul>
                    <li><button id="edit-program-btn"><i class="fas fa-edit"></i> Modifier Programme</button></li>
                </ul>
            </nav>
            <div class="header-actions">
                <div id="drive-status" style="display: none;"> 
                    <span id="drive-status-text">ConnectÃ©</span>
                </div>
                <button id="signin-button" disabled><i class="fab fa-google"></i> Connecter Drive</button>
            </div>
        </div>
    </header>

    <div class="container">
        <main>
            <div id="home-section" class="app-section">
                <!-- Le contenu de l'accueil sera gÃ©nÃ©rÃ© dynamiquement par JavaScript -->
            </div>

            <div class="workout-section app-section section-hidden" id="workout-section">
                <div class="timer-and-image-wrapper" id="timer-view" style="display: none;">
                    <div id="exercise-image-container" class="exercise-image-area">
                        <img id="exercise-image-display" src="" alt="">
                    </div>
                    <div class="timer-display" id="timer-display-clickable" aria-label="Affichage du timer Arc Reactor">
                        <div class="timer-progress-circle-container">
                            <svg viewBox="0 0 100 100">
                                <circle class="timer-progress-circle-bg" cx="50" cy="50" r="45"></circle>
                                <circle id="timer-progress-indicator" class="timer-progress-circle" cx="50" cy="50" r="45" stroke-dasharray="282.74" stroke-dashoffset="282.74"></circle>
                            </svg>
                        </div>
                        <div class="timer-step-info-display" id="workout-step-info-display">
                            <span id="workout-step-current-display" title="Ã‰tape actuelle">--</span>
                            <span id="workout-step-total-display" title="Nombre total d'Ã©tapes">--</span>
                        </div>
                        <div class="reactor">
                            <div class="triangle"></div>
                            <div class="circle-1"><span></span><span></span><span></span><span></span></div>
                            <div class="circle-2"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></div>
                            <div class="circle-3"></div>
                            <div class="circle-4"><span></span><span></span><span></span></div>
                            <div class="circle-5"><span></span><span></span><span></span></div>
                            <div class="circle-6"></div>
                            <div class="circle-7"></div>
                            <div class="circle-8"><span></span><span></span><span></span></div>
                            <div id="time-left" aria-live="polite">00:00</div>
                        </div>
                    </div>
                </div>
    
                <div class="workout-info" id="workout-info">
                    <div id="current-exercise-name-display">ArmorWorkout</div>
                    <div id="current-exercise-container" aria-live="polite"></div>
                </div>
    
                <div class="controls" style="display: none;">
                    <button id="prev-btn" disabled><i class="fas fa-backward-step"></i> PrÃ©cÃ©dent</button>
                    <button id="start-pause-btn" disabled><i class="fas fa-play"></i> DÃ©marrer</button>
                    <button id="skip-btn" disabled><i class="fas fa-forward-step"></i> Suivant</button>
                    <button id="finish-btn" disabled><i class="fas fa-flag-checkered"></i> Finir</button>
                    <button id="reset-btn" disabled><i class="fas fa-redo"></i> Reset</button>
                </div>
    
                <div class="progress-tracker" id="progress-tracker">
                    <span id="progress-text-area"></span>
                    <span id="drive-connection-status-main" style="display: none;"> 
                        <i class="fab fa-google-drive"></i>
                        <span id="drive-connection-text">ConnectÃ©</span>
                    </span>
                </div>
            </div>
        </main>
    </div>
    
    <footer>
        <p>Â© <span id="current-year"></span> ArmorWorkout. Sauvegarde sur <i class="fab fa-google-drive" aria-hidden="true"></i> Google Drive.</p>
        <p><a href="https://github.com/ironworkout/armorworkout" target="_blank" rel="noopener noreferrer"><i class="fab fa-github" aria-hidden="true"></i> Voir sur GitHub</a></p>
    </footer>

    <div id="message-area" class="message-area" role="status" aria-live="polite"></div>

    <div id="post-workout-summary" class="post-workout-summary" role="dialog" aria-modal="true" aria-labelledby="summary-title">
        <div class="post-workout-summary-content">
            <h2 id="summary-title">RÃ©sumÃ© & Objectifs</h2>
            <ul id="summary-items-list" class="summary-items-list"></ul>
            <div class="summary-controls">
                <button id="finish-summary-btn"><i class="fas fa-check"></i> Fin & Sauvegarder</button>
            </div>
        </div>
    </div>
    
    <script async defer src="https://accounts.google.com/gsi/client"></script>
    <script>
        const GOOGLE_CLIENT_ID = "731283926358-viam3ulpgna14flfdeb9m92l8s620hoi.apps.googleusercontent.com";
        const GOOGLE_DRIVE_SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const HISTORY_FILENAME = "armorworkout_history.json";
        const FULL_PROGRAM_FILENAME = "programmeCompletHypertrophieElite_v1.json";
        const PREPARE_DURATION = 3;
        const GET_READY_DURATION = 5;
        const IN_PROGRESS_KEY = 'armorWorkoutStateInProgress';
        const GIS_CHECK_INTERVAL = 100;
        const GIS_MAX_RETRIES = 50;
        const TIMER_PROGRESS_CIRCLE_CIRCUMFERENCE = 2 * Math.PI * 45;

        const defaultFullProgram = {
          "nom_programme": "Programme PPL OptimisÃ© (Final)",
          "description_programme": "Nouveau format 'ATHLETIC BODY 30'. Programme Full Body 3x/semaine, conÃ§u pour des sÃ©ances courtes (30-40min), une motivation maximale et un dÃ©veloppement esthÃ©tique basÃ© sur la loi de Pareto.",
          "auteur_programme": "Coach Hypertrophie Ã‰lite ðŸ§¬",
          "frequence_suggeree": "3x par semaine (ex: Lun/Mer/Ven) pour une frÃ©quence de stimulus optimale. La 4Ã¨me sÃ©ance est un bonus.",
          "notes_generales": "LA LOI DE LA PROGRESSION : Quand tu atteins la borne HAUTE de la fourchette de reps sur ta PREMIÃˆRE sÃ©rie avec une forme parfaite, augmente la charge de +1kg Ã  la sÃ©ance suivante. L'objectif est l'Ã©chec musculaire propre dans la fourchette de reps donnÃ©e.",
          "sessions": [
            {
              "nom_session": "PUSH",
              "description_session": "SÃ©ance Full Body A, avec un focus sur la construction de la largeur (Ã©paules/dos) et des bras pour un impact visuel maximal.",
              "exercices_et_pauses": [
                {
                  "type": "exercise",
                  "name": "Superset A: Tirage Vertical",
                  "details": "Superset 1/4. Fourchette : 10-15 reps.",
                  "reps": 14,
                  "weight_text": "ðŸ‹ï¸ 25 kg",
                  "current_reps": 12,
                  "progression_note": "Reps: 14-14 | Test"
                },
                { "type": "break", "duration": 15, "name": "Transition" },
                {
                  "type": "exercise",
                  "name": "Superset B: Ã‰lÃ©vations LatÃ©rales",
                  "details": "Superset 1/4. Fourchette : 10-12 reps. (+1kg quand 12 reps OK).",
                  "reps": 10,
                  "weight_text": "ðŸ‹ï¸ 7.8 kg",
                  "current_reps": 10,
                  "progression_note": "Reps: 10-10"
                },
                { "type": "break", "duration": 75, "name": "Repos Superset (75s)" },
                {
                  "type": "exercise",
                  "name": "Superset A: Tirage Vertical",
                  "details": "Superset 2/4. Fourchette : 10-15 reps.",
                  "reps": 12,
                  "weight_text": "ðŸ‹ï¸ 25 kg",
                  "current_reps": 12,
                  "progression_note": "Reps: 12-12"
                },
                { "type": "break", "duration": 15, "name": "Transition" },
                {
                  "type": "exercise",
                  "name": "Superset B: Ã‰lÃ©vations LatÃ©rales",
                  "details": "Superset 2/4. Fourchette : 10-12 reps.",
                  "reps": 10,
                  "weight_text": "ðŸ‹ï¸ 7.8 kg",
                  "current_reps": 10,
                  "progression_note": "Reps: 10-10"
                },
                { "type": "break", "duration": 75, "name": "Repos Superset (75s)" },
                {
                  "type": "exercise",
                  "name": "Superset A: Tirage Vertical",
                  "details": "Superset 3/4. Fourchette : 10-15 reps.",
                  "reps": 12,
                  "weight_text": "ðŸ‹ï¸ 25 kg",
                  "current_reps": 12,
                  "progression_note": "Reps: 12-12"
                },
                { "type": "break", "duration": 15, "name": "Transition" },
                {
                  "type": "exercise",
                  "name": "Superset B: Ã‰lÃ©vations LatÃ©rales",
                  "details": "Superset 3/4. Fourchette : 10-12 reps.",
                  "reps": 10,
                  "weight_text": "ðŸ‹ï¸ 7.8 kg",
                  "current_reps": 10,
                  "progression_note": "Reps: 10-10"
                },
                { "type": "break", "duration": 75, "name": "Repos Superset (75s)" },
                {
                  "type": "exercise",
                  "name": "Superset A: Tirage Vertical",
                  "details": "Superset 4/4. Fourchette : 10-15 reps.",
                  "reps": 12,
                  "weight_text": "ðŸ‹ï¸ 25 kg",
                  "current_reps": 12,
                  "progression_note": "Reps: 12-12"
                },
                { "type": "break", "duration": 15, "name": "Transition" },
                {
                  "type": "exercise",
                  "name": "Superset B: Ã‰lÃ©vations LatÃ©rales",
                  "details": "Superset 4/4. Fourchette : 10-12 reps.",
                  "reps": 10,
                  "weight_text": "ðŸ‹ï¸ 7.8 kg",
                  "current_reps": 10,
                  "progression_note": "Reps: 10-10"
                },
                { "type": "break", "duration": 75, "name": "Repos Superset (75s)" },
                {
                  "type": "exercise",
                  "name": "Superset A: Curl Marteau UnilatÃ©ral",
                  "details": "Superset 1/3 par bras. Fourchette : 8-12 reps. (+1kg quand 12 reps OK).",
                  "reps": 10,
                  "tempo": "2-0-2-0",
                  "weight_text": "ðŸ‹ï¸ 7.8 kg",
                  "current_reps": 10,
                  "progression_note": "Reps: 10-10"
                },
                { "type": "break", "duration": 15, "name": "Transition" },
                {
                  "type": "exercise",
                  "name": "Superset B: Extensions Triceps Overhead",
                  "details": "Superset 1/3. Fourchette : 12-15 reps.",
                  "reps": 13,
                  "weight_text": "ðŸ‹ï¸ 25 kg",
                  "current_reps": 13,
                  "progression_note": "Reps: 13-13"
                },
                { "type": "break", "duration": 75, "name": "Repos Superset (75s)" },
                {
                  "type": "exercise",
                  "name": "Superset A: Curl Marteau UnilatÃ©ral",
                  "details": "Superset 2/3 par bras. Fourchette : 8-12 reps.",
                  "reps": 10,
                  "tempo": "2-0-2-0",
                  "weight_text": "ðŸ‹ï¸ 7.8 kg",
                  "current_reps": 10,
                  "progression_note": "Reps: 10-10"
                },
                { "type": "break", "duration": 15, "name": "Transition" },
                {
                  "type": "exercise",
                  "name": "Superset B: Extensions Triceps Overhead",
                  "details": "Superset 2/3. Fourchette : 12-15 reps.",
                  "reps": 13,
                  "weight_text": "ðŸ‹ï¸ 25 kg",
                  "current_reps": 13,
                  "progression_note": "Reps: 13-13"
                },
                { "type": "break", "duration": 75, "name": "Repos Superset (75s)" },
                {
                  "type": "exercise",
                  "name": "Superset A: Curl Marteau UnilatÃ©ral",
                  "details": "Superset 3/3 par bras. Fourchette : 8-12 reps.",
                  "reps": 10,
                  "tempo": "2-0-2-0",
                  "weight_text": "ðŸ‹ï¸ 7.8 kg",
                  "current_reps": 10,
                  "progression_note": "Reps: 10-10"
                },
                { "type": "break", "duration": 15, "name": "Transition" },
                {
                  "type": "exercise",
                  "name": "Superset B: Extensions Triceps Overhead",
                  "details": "Superset 3/3. Fourchette : 12-15 reps.",
                  "reps": 13,
                  "weight_text": "ðŸ‹ï¸ 25 kg",
                  "current_reps": 13,
                  "progression_note": "Reps: 13-13"
                },
                { "type": "break", "duration": 75, "name": "Repos Superset (75s)" },
                {
                  "type": "exercise",
                  "name": "Push-ups (LestÃ©es)",
                  "details": "SÃ©rie 1/3. Objectif : Max Reps.",
                  "reps": 10,
                  "technique": "Maximum de rÃ©pÃ©titions propres.",
                  "weight_text": "ðŸ‹ï¸ 5 kg",
                  "current_reps": 10,
                  "progression_note": "Reps: 10-10"
                },
                { "type": "break", "duration": 75, "name": "Repos (75s)" },
                {
                  "type": "exercise",
                  "name": "Push-ups (LestÃ©es)",
                  "details": "SÃ©rie 2/3. Objectif : Max Reps.",
                  "reps": 10,
                  "technique": "Maximum de rÃ©pÃ©titions propres.",
                  "weight_text": "ðŸ‹ï¸ 5 kg",
                  "current_reps": 10,
                  "progression_note": "Reps: 10-10"
                },
                { "type": "break", "duration": 75, "name": "Repos (75s)" },
                {
                  "type": "exercise",
                  "name": "Push-ups (LestÃ©es)",
                  "details": "SÃ©rie 3/3. Objectif : Max Reps.",
                  "reps": 10,
                  "technique": "Maximum de rÃ©pÃ©titions propres.",
                  "weight_text": "ðŸ‹ï¸ 5 kg",
                  "current_reps": 10,
                  "progression_note": "Reps: 10-10"
                },
                { "type": "break", "duration": 60, "name": "Repos (60s)" },
                {
                  "type": "exercise",
                  "name": "FINISHER: Dead Hang",
                  "details": "Accumuler 90s. Focus Poigne.",
                  "duration": 40,
                  "reps": 40,
                  "unit_duration": "secondes",
                  "weight_text": "ðŸ’ª Poids du Corps",
                  "current_reps": 40,
                  "progression_note": "Reps: 40-40"
                }
              ]
            },
            {
              "nom_session": "PULL",
              "description_session": "SÃ©ance Full Body B, avec un travail prioritaire sur les pectoraux et les abdominaux, tout en maintenant le stimulus sur le reste du corps.",
              "exercices_et_pauses": [
                {
                  "type": "exercise",
                  "name": "Ã‰cartÃ©-DÃ©veloppÃ© Hybride",
                  "details": "SÃ©rie 1/4. Fourchette : 10-15 reps.",
                  "reps": 12,
                  "weight_text": "HaltÃ¨res 2x5kg + Ã‰las. 25kg",
                  "progression_note": "Test"
                },
                { "type": "break", "duration": 75, "name": "Repos (75s)" },
                {
                  "type": "exercise",
                  "name": "Ã‰cartÃ©-DÃ©veloppÃ© Hybride",
                  "details": "SÃ©rie 2/4.",
                  "reps": 12,
                  "weight_text": "HaltÃ¨res 2x5kg + Ã‰las. 25kg",
                  "progression_note": ""
                },
                { "type": "break", "duration": 75, "name": "Repos (75s)" },
                {
                  "type": "exercise",
                  "name": "Ã‰cartÃ©-DÃ©veloppÃ© Hybride",
                  "details": "SÃ©rie 3/4.",
                  "reps": 13,
                  "weight_text": "HaltÃ¨res 2x5kg + Ã‰las. 25kg",
                  "progression_note": ""
                },
                { "type": "break", "duration": 75, "name": "Repos (75s)" },
                {
                  "type": "exercise",
                  "name": "Ã‰cartÃ©-DÃ©veloppÃ© Hybride",
                  "details": "SÃ©rie 4/4.",
                  "reps": 13,
                  "weight_text": "HaltÃ¨res 2x5kg + Ã‰las. 25kg",
                  "progression_note": ""
                },
                { "type": "break", "duration": 75, "name": "Repos (75s)" },
                {
                  "type": "exercise",
                  "name": "Superset A: Pike Push-ups",
                  "details": "Superset 1/3. Objectif : Max Reps.",
                  "reps": 13,
                  "technique": "Maximum de rÃ©pÃ©titions propres.",
                  "weight_text": "Sac 6.5kg",
                  "progression_note": ""
                },
                { "type": "break", "duration": 15, "name": "Transition" },
                {
                  "type": "exercise",
                  "name": "Superset B: Ã‰lÃ©vations LatÃ©rales",
                  "details": "Superset 1/3. Fourchette : 10-12 reps. (+1kg quand 12 reps OK).",
                  "reps": 12,
                  "weight_text": "Sac 6.5kg",
                  "progression_note": ""
                },
                { "type": "break", "duration": 75, "name": "Repos Superset (75s)" },
                {
                  "type": "exercise",
                  "name": "Superset A: Pike Push-ups",
                  "details": "Superset 2/3. Objectif : Max Reps.",
                  "reps": 13,
                  "technique": "Maximum de rÃ©pÃ©titions propres.",
                  "weight_text": "Sac 6.5g",
                  "progression_note": ""
                },
                { "type": "break", "duration": 15, "name": "Transition" },
                {
                  "type": "exercise",
                  "name": "Superset B: Ã‰lÃ©vations LatÃ©rales",
                  "details": "Superset 2/3. Fourchette : 10-12 reps.",
                  "reps": 12,
                  "weight_text": "Sac 6.5kg",
                  "progression_note": ""
                },
                { "type": "break", "duration": 75, "name": "Repos Superset (75s)" },
                {
                  "type": "exercise",
                  "name": "Superset A: Pike Push-ups",
                  "details": "Superset 3/3. Objectif : Max Reps.",
                  "reps": 13,
                  "technique": "Maximum de rÃ©pÃ©titions propres.",
                  "weight_text": "Sac 6.5g",
                  "progression_note": ""
                },
                { "type": "break", "duration": 15, "name": "Transition" },
                {
                  "type": "exercise",
                  "name": "Superset B: Ã‰lÃ©vations LatÃ©rales",
                  "details": "Superset 3/3. Fourchette : 10-12 reps.",
                  "reps": 12,
                  "weight_text": "Sac 6.5kg",
                  "progression_note": ""
                },
                { "type": "break", "duration": 75, "name": "Repos Superset (75s)" },
                {
                  "type": "exercise",
                  "name": "Superset A: Rowing UnilatÃ©ral",
                  "details": "Superset 1/3 par bras. Fourchette : 12-15 reps.",
                  "reps": 12,
                  "weight_text": "Sac 10kg",
                  "progression_note": ""
                },
                { "type": "break", "duration": 15, "name": "Transition" },
                {
                  "type": "exercise",
                  "name": "Superset B: Curl sur Swiss Ball",
                  "details": "Superset 1/3. Fourchette : 12-15 reps.",
                  "reps": 12,
                  "weight_text": "Ã‰las. 25kg",
                  "progression_note": ""
                },
                { "type": "break", "duration": 75, "name": "Repos Superset (75s)" },
                {
                  "type": "exercise",
                  "name": "Superset A: Rowing UnilatÃ©ral",
                  "details": "Superset 2/3 par bras.",
                  "reps": 12,
                  "weight_text": "Sac 10kg",
                  "progression_note": ""
                },
                { "type": "break", "duration": 15, "name": "Transition" },
                {
                  "type": "exercise",
                  "name": "Superset B: Curl sur Swiss Ball",
                  "details": "Superset 2/3.",
                  "reps": 12,
                  "weight_text": "Ã‰las. 25kg",
                  "progression_note": ""
                },
                { "type": "break", "duration": 75, "name": "Repos Superset (75s)" },
                {
                  "type": "exercise",
                  "name": "Superset A: Rowing UnilatÃ©ral",
                  "details": "Superset 3/3 par bras.",
                  "reps": 13,
                  "weight_text": "Sac 10kg",
                  "progression_note": ""
                },
                { "type": "break", "duration": 15, "name": "Transition" },
                {
                  "type": "exercise",
                  "name": "Superset B: Curl sur Swiss Ball",
                  "details": "Superset 3/3.",
                  "reps": 12,
                  "weight_text": "Ã‰las. 25kg",
                  "progression_note": ""
                },
                { "type": "break", "duration": 75, "name": "Repos Superset (75s)" },
                {
                  "type": "exercise",
                  "name": "Crunch LestÃ© sur Swiss Ball",
                  "details": "SÃ©rie 1/3. Fourchette : 15-20 reps.",
                  "reps": 13,
                  "weight_text": "E25",
                  "progression_note": ""
                },
                { "type": "break", "duration": 60, "name": "Repos (60s)" },
                {
                  "type": "exercise",
                  "name": "Crunch LestÃ© sur Swiss Ball",
                  "details": "SÃ©rie 2/3.",
                  "reps": 13,
                  "weight_text": "E24",
                  "progression_note": ""
                },
                { "type": "break", "duration": 60, "name": "Repos (60s)" },
                {
                  "type": "exercise",
                  "name": "Crunch LestÃ© sur Swiss Ball",
                  "details": "SÃ©rie 3/3.",
                  "reps": 13,
                  "weight_text": "E25",
                  "progression_note": ""
                }
              ]
            },
            {
              "nom_session": "LEGS",
              "description_session": "SÃ©ance Full Body C, qui attaque les jambes en prioritÃ© avant de finir avec un circuit 'pump' pour un rappel de frÃ©quence sur tout le haut du corps.",
              "exercices_et_pauses": [
                {
                  "type": "exercise",
                  "name": "Bulgarian Split Squats",
                  "details": "SÃ©rie 1/3 par jambe. Reps: 10-13. Tempo 5-1-X-1.",
                  "reps": 9,
                  "reps_unit": "par jambe",
                  "weight_text": "ðŸ‹ï¸ 10 kg",
                  "progression_note": "Reps: 8-12 | Reps: 10-12 | Reps: 10-12 | Reps: 10-12 | Reps: 9-18 | Reps: 8-14 | Reps: 9-12 | Reps: 9-12 | Reps: 10-11 | Reps: 9-12"
                },
                { "type": "break", "duration": 75, "name": "Repos (75s)" },
                {
                  "type": "exercise",
                  "name": "Bulgarian Split Squats",
                  "details": "SÃ©rie 2/3 par jambe.",
                  "reps": 12,
                  "reps_unit": "par jambe",
                  "weight_text": "ðŸ‹ï¸ 10 kg",
                  "progression_note": "Reps: 12-12 | Reps: 12-12 | Reps: 12-12 | Reps: 12-12 | Reps: 12-12 | Reps: 12-12 | Reps: 12-12 | Reps: 12-12 | Reps: 11-12 | Reps: 12-12 | Reps: 12-12"
                },
                { "type": "break", "duration": 75, "name": "Repos (75s)" },
                {
                  "type": "exercise",
                  "name": "Bulgarian Split Squats",
                  "details": "SÃ©rie 3/3 par jambe.",
                  "reps": 12,
                  "reps_unit": "par jambe",
                  "weight_text": "ðŸ‹ï¸ 10 kg",
                  "progression_note": "Reps: 12-12 | Reps: 12-12 | Reps: 12-12 | Reps: 12-12 | Reps: 12-12 | Reps: 12-12 | Reps: 12-12 | Reps: 12-12 | Reps: 12-12 | Reps: 12-12 | Reps: 12-12"
                },
                { "type": "break", "duration": 90, "name": "Repos (90s)" },
                {
                  "type": "exercise",
                  "name": "Circuit A: Tirage Vertical",
                  "details": "Circuit 1/3. Focus QualitÃ©, pas Ã©chec.",
                  "reps": 14,
                  "weight_text": "ðŸ‹ï¸ 25 kg",
                  "progression_note": "Reps: 14-14 | Reps: 14-14 | Reps: 14-14 | Reps: 14-14 | Reps: 14-14 | Reps: 14-14 | Reps: 14-14 | Reps: 14-14 | Reps: 14-14 | Reps: 14-14 | Reps: 14-14"
                },
                { "type": "break", "duration": 15, "name": "Transition" },
                {
                  "type": "exercise",
                  "name": "Circuit B: Ã‰lÃ©vations LatÃ©rales",
                  "details": "Circuit 1/3.",
                  "reps": 11,
                  "weight_text": "ðŸ‹ï¸ 6.5 kg",
                  "progression_note": "Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11"
                },
                { "type": "break", "duration": 15, "name": "Transition" },
                {
                  "type": "exercise",
                  "name": "Circuit C: Curl Marteau UnilatÃ©ral",
                  "details": "Circuit 1/3.",
                  "reps": 10,
                  "reps_unit": "par bras",
                  "weight_text": "ðŸ‹ï¸ 6.5 kg",
                  "progression_note": "Reps: 10-10 | Reps: 10-10 | Reps: 10-10 | Reps: 10-10 | Reps: 10-10 | Reps: 10-10 | Reps: 10-10 | Reps: 10-10 | Reps: 10-10 | Reps: 10-10 | Reps: 10-10"
                },
                { "type": "break", "duration": 90, "name": "Repos Circuit (90s)" },
                {
                  "type": "exercise",
                  "name": "Circuit A: Tirage Vertical",
                  "details": "Circuit 2/3.",
                  "reps": 14,
                  "weight_text": "ðŸ‹ï¸ 25 kg",
                  "progression_note": "Reps: 14-14 | Reps: 14-14 | Reps: 14-14 | Reps: 14-14 | Reps: 14-14 | Reps: 14-14 | Reps: 14-14 | Reps: 14-14 | Reps: 14-14 | Reps: 14-14 | Reps: 14-14"
                },
                { "type": "break", "duration": 15, "name": "Transition" },
                {
                  "type": "exercise",
                  "name": "Circuit B: Ã‰lÃ©vations LatÃ©rales",
                  "details": "Circuit 2/3.",
                  "reps": 11,
                  "weight_text": "ðŸ‹ï¸ 6.5 kg",
                  "progression_note": "Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11"
                },
                { "type": "break", "duration": 15, "name": "Transition" },
                {
                  "type": "exercise",
                  "name": "Circuit C: Curl Marteau UnilatÃ©ral",
                  "details": "Circuit 2/3.",
                  "reps": 11,
                  "reps_unit": "par bras",
                  "weight_text": "ðŸ‹ï¸ 6.5 kg",
                  "progression_note": "Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11"
                },
                { "type": "break", "duration": 90, "name": "Repos Circuit (90s)" },
                {
                  "type": "exercise",
                  "name": "Circuit A: Tirage Vertical",
                  "details": "Circuit 3/3.",
                  "reps": 14,
                  "weight_text": "ðŸ‹ï¸ 25 kg",
                  "progression_note": "Reps: 14-14 | Reps: 14-14 | Reps: 14-14 | Reps: 14-14 | Reps: 14-14 | Reps: 14-14 | Reps: 14-14 | Reps: 14-14 | Reps: 14-14 | Reps: 14-14 | Reps: 14-14"
                },
                { "type": "break", "duration": 15, "name": "Transition" },
                {
                  "type": "exercise",
                  "name": "Circuit B: Ã‰lÃ©vations LatÃ©rales",
                  "details": "Circuit 3/3.",
                  "reps": 11,
                  "weight_text": "ðŸ‹ï¸ 6.5 kg",
                  "progression_note": "Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11"
                },
                { "type": "break", "duration": 15, "name": "Transition" },
                {
                  "type": "exercise",
                  "name": "Circuit C: Curl Marteau UnilatÃ©ral",
                  "details": "Circuit 3/3.",
                  "reps": 11,
                  "reps_unit": "par bras",
                  "weight_text": "ðŸ‹ï¸ 6.5 kg",
                  "progression_note": "Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11 | Reps: 11-11"
                },
                { "type": "break", "duration": 90, "name": "Repos Circuit (90s)" },
                {
                  "type": "exercise",
                  "name": "Superset A: Reverse Crunches",
                  "details": "Superset 1/3. Objectif : Max Reps.",
                  "reps": 13,
                  "technique": "Maximum de rÃ©pÃ©titions propres.",
                  "weight_text": "ðŸ’ª Poids du Corps",
                  "progression_note": "Reps: 13-13 | Reps: 13-13 | Reps: 13-13 | Reps: 13-13 | Reps: 13-13 | Reps: 13-13 | Reps: 13-13 | Reps: 13-13 | Reps: 13-13 | Reps: 13-13 | Reps: 13-13"
                },
                { "type": "break", "duration": 10, "name": "Transition" },
                {
                  "type": "exercise",
                  "name": "Superset B: Swiss Ball Leg Curls",
                  "details": "Superset 1/3. Objectif : Max Reps.",
                  "reps": 20,
                  "technique": "Maximum de rÃ©pÃ©titions propres.",
                  "weight_text": "ðŸ’ª Poids du Corps",
                  "progression_note": "Reps: 20-20 | Reps: 20-20 | Reps: 20-20 | Reps: 20-20 | Reps: 20-20 | Reps: 20-20 | Reps: 20-20 | Reps: 20-20 | Reps: 20-20 | Reps: 20-20 | Reps: 20-20"
                },
                { "type": "break", "duration": 75, "name": "Repos Superset (75s)" },
                {
                  "type": "exercise",
                  "name": "Superset A: Reverse Crunches",
                  "details": "Superset 2/3.",
                  "reps": 13,
                  "technique": "Maximum de rÃ©pÃ©titions propres.",
                  "weight_text": "ðŸ’ª Poids du Corps",
                  "progression_note": "Reps: 13-13 | Reps: 13-13 | Reps: 13-13 | Reps: 13-13 | Reps: 13-13 | Reps: 13-13 | Reps: 13-13 | Reps: 13-13 | Reps: 13-13 | Reps: 13-13 | Reps: 13-13"
                },
                { "type": "break", "duration": 10, "name": "Transition" },
                {
                  "type": "exercise",
                  "name": "Superset B: Swiss Ball Leg Curls",
                  "details": "Superset 2/3.",
                  "reps": 20,
                  "technique": "Maximum de rÃ©pÃ©titions propres.",
                  "weight_text": "ðŸ’ª Poids du Corps",
                  "progression_note": "Reps: 20-20 | Reps: 20-20 | Reps: 20-20 | Reps: 20-20 | Reps: 20-20 | Reps: 20-20 | Reps: 20-20 | Reps: 20-20 | Reps: 20-20 | Reps: 20-20 | Reps: 20-20"
                },
                { "type": "break", "duration": 75, "name": "Repos Superset (75s)" },
                {
                  "type": "exercise",
                  "name": "Superset A: Reverse Crunches",
                  "details": "Superset 3/3.",
                  "reps": 14,
                  "technique": "Maximum de rÃ©pÃ©titions propres.",
                  "weight_text": "ðŸ’ª Poids du Corps",
                  "progression_note": "Reps: 14-14 | Reps: 14-14 | Reps: 14-14 | Reps: 14-14 | Reps: 14-14 | Reps: 14-14 | Reps: 14-14 | Reps: 14-14 | Reps: 14-14 | Reps: 14-14 | Reps: 14-14"
                },
                { "type": "break", "duration": 10, "name": "Transition" },
                {
                  "type": "exercise",
                  "name": "Superset B: Swiss Ball Leg Curls",
                  "details": "Superset 3/3.",
                  "reps": 20,
                  "technique": "Maximum de rÃ©pÃ©titions propres.",
                  "weight_text": "ðŸ’ª Poids du Corps",
                  "progression_note": "Reps: 20-20 | Reps: 20-20 | Reps: 20-20 | Reps: 20-20 | Reps: 20-20 | Reps: 20-20 | Reps: 20-20 | Reps: 20-20 | Reps: 20-20 | Reps: 20-20 | Reps: 20-20"
                },
                { "type": "break", "duration": 60, "name": "Repos (60s)" },
                {
                  "type": "exercise",
                  "name": "FINISHER: RÃ©traction Scapulaire Iso",
                  "details": "Accumuler 90s. Focus Dos.",
                  "duration": 40,
                  "reps": 40,
                  "unit_duration": "secondes",
                  "weight_text": "ðŸ’ª Poids du Corps",
                  "progression_note": "Reps: 40-40 | Reps: 40-40 | Reps: 40-40 | Reps: 40-40 | Reps: 40-40 | Reps: 40-40 | Reps: 40-40 | Reps: 40-40 | Reps: 40-40 | Reps: 40-40 | Reps: 40-40"
                }
              ]
            }
          ]
        };
        
        let loadedFullProgram = JSON.parse(JSON.stringify(defaultFullProgram));

        let timeDisplayDiv, currentExerciseContainer, progressTracker, startPauseBtn, skipBtn, finishBtn, resetBtn, prevBtn,
            editProgramBtn, signInButton, driveStatusElement, driveStatusTextElement,
            postWorkoutSummary, summaryTitle, summaryItemsList, finishSummaryBtn, 
            currentExerciseNameDisplay, driveConnectionStatusMain, driveConnectionText, timerDisplayElement,
            progressTextArea, messageArea, homeSection,
            workoutSection, 
            reactorElement, exerciseImageContainer, exerciseImageDisplay,
            timerProgressIndicator, workoutStepTotalDisplay, workoutStepCurrentDisplay, workoutStepInfoDisplay,
            timerView, workoutInfoView, controls;

        let currentWorkoutType = null, currentWorkoutPlan = [], originalCompletedWorkoutPlan = [];
        let currentItemIndex = 0, timerInterval = null, prepareCountdownInterval = null, getReadyInterval = null;
        let totalTime = 0, timeLeft = 0, prepareTimeLeft = 0;
        let isTimerRunning = false, isWorkoutActive = false, workoutFinished = false, wasFinishedState = false;
        let currentState = 'idle', previousState = 'idle';
        let workoutStartTime = null, workoutHistory = [];
        let googleAccessToken = null, tokenClient = null;
        let historyFileId = null, programFileId = null;
        let programsLoaded = false;
        let isSavingDriveData = false;
        let messageTimeoutId = null;
        let gisCheckRetries = 0;
        let audioContext;
        let isEditMode = false;
        let currentSummaryContext = { mode: 'workout', sessionName: null };
        let activeCharts = {};
        let displayedCalendarDate = new Date();

        let soundLaser, sound5, sound4, sound3, sound2, sound1, soundWindows, soundET, soundComplete, soundScan;

        function triggerTriangleSpin() { const t = document.querySelector('.reactor .triangle'); if (!t) return; t.classList.remove('spin-transition'); void t.offsetWidth; t.classList.add('spin-transition'); }
        function initSounds() {
            try {
                const bP = "https://ironworkout.github.io/armorworkout/";
                soundLaser = new Audio(bP + 'laser.mp3'); sound5 = new Audio(bP + '5.mp3'); sound4 = new Audio(bP + '4.mp3'); sound3 = new Audio(bP + '3.mp3');
                sound2 = new Audio(bP + '2.mp3'); sound1 = new Audio(bP + '1.mp3'); soundWindows = new Audio(bP + 'windows.mp3'); soundET = new Audio(bP + 'e-t.mp3');
                soundComplete = new Audio(bP + 'complete.mp3'); 
                soundScan = new Audio(bP + 'scan.mp3');
                
                [soundLaser, sound5, sound4, sound3, sound2, sound1, soundWindows, soundET, soundComplete, soundScan].forEach(s => { if (s) s.preload = 'auto'; });
            } catch (e) { showMessage("Erreur chargement sons.", 5000, true); }
        }
        function playSound(a) { if (!a || !audioContext || audioContext.state !== 'running') return; a.currentTime = 0; a.play().catch(e => { console.warn("Erreur lecture son:", e.message) }); }
        function initAudioContext() {
            if (audioContext && audioContext.state === 'running') return;
            if (!audioContext) { try { window.AudioContext = window.AudioContext || window.webkitAudioContext; if (window.AudioContext) audioContext = new AudioContext(); else return; } catch (e) { return; } }
            if (audioContext.state === 'suspended') audioContext.resume().catch(e => { });
        }
        const vibrate = (p = [100]) => { if ('vibrate' in navigator) { try { navigator.vibrate(p); } catch (e) { } } };

        async function gisInitInternal() {
            if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
                try {
                    tokenClient = google.accounts.oauth2.initTokenClient({ client_id: GOOGLE_CLIENT_ID, scope: GOOGLE_DRIVE_SCOPES, callback: tokenCallback, error_callback: handleTokenError });
                    if (tokenClient) tokenClient.requestAccessToken({ prompt: '' });
                    if (signInButton) signInButton.disabled = false;
                } catch (error) { showMessage("Erreur initialisation services Google.", 5000, true); updateAuthUI(false); if (signInButton) signInButton.disabled = true; }
            } else { if (signInButton) signInButton.disabled = true; }
        }
        function checkAndInitGis() {
            if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2 && typeof google.accounts.oauth2.initTokenClient === 'function') gisInitInternal();
            else if (gisCheckRetries < GIS_MAX_RETRIES) { gisCheckRetries++; setTimeout(checkAndInitGis, GIS_CHECK_INTERVAL); }
            else { showMessage("Erreur critique: API Google non disponible.", 10000, true); if (signInButton) signInButton.disabled = true; }
        }
        function handleTokenError(error) {
            let msg = `Erreur Authentification Google: ${error.type || error.error || 'Inconnue'}`;
            if (error.type === 'popup_closed_by_user' || error.error === 'popup_closed_by_user') msg = "FenÃªtre de connexion Google fermÃ©e.";
            else if (error.type === 'popup_failed_to_open') msg = "Impossible d'ouvrir la fenÃªtre de connexion. VÃ©rifiez les bloqueurs de popups.";
            else if (error.type === 'USER_CANCELLED' || error.error === 'access_denied') msg = "AccÃ¨s aux donnÃ©es Drive refusÃ© par l'utilisateur.";
            if (driveStatusElement) { driveStatusElement.className = 'error'; driveStatusElement.style.display = 'inline-flex'; }
            showMessage(msg, 7000, true); if (driveStatusTextElement) driveStatusTextElement.textContent = 'Erreur Auth'; updateAuthUI(false);
        }
        async function tokenCallback(tokenResponse) {
            if (driveStatusElement) driveStatusElement.className = '';
            if (tokenResponse.error) { if (tokenResponse.error !== "popup_failed_to_open" && tokenResponse.error !== "popup_closed_by_user") handleTokenError(tokenResponse); else updateAuthUI(false); return; }
            if (tokenResponse && tokenResponse.access_token) {
                googleAccessToken = tokenResponse.access_token; showMessage("ConnectÃ© ! Chargement des donnÃ©es...", 2500);
                if (driveStatusElement) { driveStatusElement.classList.remove('error', 'success'); driveStatusElement.classList.add('loading'); driveStatusElement.style.display = 'inline-flex'; }
                if (driveStatusTextElement) driveStatusTextElement.textContent = 'Chargement...';
                try {
                    await loadHistoryFromDrive();
                    const programLoadSuccess = await loadFullProgramFromDrive();
                    if (programLoadSuccess && loadedFullProgram && loadedFullProgram.sessions) {
                        showMessage("Programme et historique chargÃ©s.", 3000);
                        if (driveStatusElement) { driveStatusElement.classList.remove('loading', 'error'); driveStatusElement.classList.add('success'); }
                        if (driveStatusTextElement) driveStatusTextElement.textContent = 'ConnectÃ©';
                    } else {
                        showMessage(`Erreur chargement '${FULL_PROGRAM_FILENAME}' depuis Drive ou programme invalide. Utilisation du programme par dÃ©faut.`, 8000, true);
                        if (driveStatusElement) { driveStatusElement.classList.remove('loading'); driveStatusElement.classList.add('error'); }
                        if (driveStatusTextElement) driveStatusTextElement.textContent = 'Prog DÃ©faut';
                        loadedFullProgram = JSON.parse(JSON.stringify(defaultFullProgram)); programsLoaded = true;
                    }
                } catch (error) {
                    showMessage("Erreur majeure lors du chargement. Programme par dÃ©faut utilisÃ©.", 6000, true);
                    if (driveStatusElement) { driveStatusElement.classList.remove('loading', 'success'); driveStatusElement.classList.add('error'); }
                    if (driveStatusTextElement) driveStatusTextElement.textContent = 'Erreur DonnÃ©es';
                    loadedFullProgram = JSON.parse(JSON.stringify(defaultFullProgram)); programsLoaded = true;
                } finally { updateAuthUI(true); loadInProgressState(); }
            } else handleTokenError({ error: "RÃ©ponse de token invalide ou vide" });
        }
        function handleAuthClick() {
            initAudioContext();
            if (!tokenClient) { showMessage("Services Google non prÃªts. Veuillez patienter.", 3000); checkAndInitGis(); return; }
            if (driveStatusElement) { driveStatusElement.classList.remove('error', 'success'); driveStatusElement.classList.add('loading'); driveStatusElement.style.display = 'inline-flex'; }
            if (driveStatusTextElement) driveStatusTextElement.textContent = 'Connexion...';
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }
        function updateAuthUI(isLoggedIn) {
            const body = document.body; body.classList.toggle('logged-in', isLoggedIn); body.classList.toggle('logged-out', !isLoggedIn);
            if (driveStatusElement && driveStatusTextElement) {
                driveStatusElement.style.display = isLoggedIn ? 'inline-flex' : 'none';
                if (isLoggedIn) {
                    const c = driveStatusElement.className; if (c.includes('loading')) driveStatusTextElement.textContent = 'Chargement...';
                    else if (!c.includes('error')) { driveStatusElement.classList.add('success'); driveStatusTextElement.textContent = 'ConnectÃ©'; }
                } else { driveStatusElement.className = ''; driveStatusTextElement.textContent = ''; }
            }
            if (driveConnectionStatusMain && driveConnectionText) {
                driveConnectionStatusMain.style.display = isLoggedIn ? 'inline-flex' : 'none'; const d = driveStatusElement?.className || '';
                driveConnectionStatusMain.className = d;
                if (isLoggedIn) { if (d.includes('loading')) driveConnectionText.textContent = "Chargement..."; else if (d.includes('error')) driveConnectionText.textContent = `Erreur Drive`; else driveConnectionText.textContent = "ConnectÃ©"; }
            }
            if (signInButton) signInButton.disabled = isLoggedIn || !tokenClient;
            const isTimerActive = ['preparing', 'exercise', 'break', 'paused', 'completed', 'get-ready'].includes(currentState);
            if (editProgramBtn) editProgramBtn.disabled = !(isLoggedIn && programsLoaded && loadedFullProgram && !isTimerActive);
            document.querySelectorAll('nav a.nav-link').forEach(link => { link.classList.toggle('disabled-link-look', isTimerActive); });
            
            if (currentState === 'idle') {
                if (startPauseBtn) { startPauseBtn.disabled = true; startPauseBtn.innerHTML = `<i class="fas fa-play"></i> DÃ©marrer`; startPauseBtn.className = 'start-btn'; }
                renderHomeScreen(); 
            } else if (startPauseBtn) startPauseBtn.disabled = ['preparing', 'get-ready', 'finished', 'completed'].includes(currentState);
            if (prevBtn) prevBtn.disabled = !(isTimerActive && currentItemIndex > 0);
            if (finishBtn) finishBtn.disabled = !isTimerActive;
            if (resetBtn) resetBtn.disabled = !isTimerActive && !isLoggedIn;
            
            updateWorkoutInfo();
        }
        async function findOrCreateFile(filename, defaultContentStr = "{}", mimeType = 'application/json', createIfNotExist = false) {
            if (!googleAccessToken) return null;
            const searchUrl = `https://www.googleapis.com/drive/v3/files?q=name='${encodeURIComponent(filename)}'+and+trashed=false&spaces=drive&fields=files(id,name)`;
            try {
                const searchRes = await fetch(searchUrl, { headers: { 'Authorization': `Bearer ${googleAccessToken}` } });
                if (!searchRes.ok) { if (searchRes.status === 401 || searchRes.status === 403) { showMessage("Session Google expirÃ©e.", 5000, "error"); googleAccessToken = null; updateAuthUI(false); return null; } throw new Error(`Recherche Ã©chouÃ©e (${searchRes.status})`); }
                const searchData = await searchRes.json();
                if (searchData.files && searchData.files.length > 0) { return searchData.files[0].id; }
                if (!createIfNotExist) { return null; }
                const createUrl = `https://www.googleapis.com/drive/v3/files`;
                const metadata = { name: filename, mimeType: mimeType };
                const createRes = await fetch(createUrl, { method: 'POST', headers: { 'Authorization': `Bearer ${googleAccessToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify(metadata) });
                if (!createRes.ok) throw new Error(`CrÃ©ation Ã©chouÃ©e (${createRes.status})`);
                const createData = await createRes.json(); const newFileId = createData.id;
                const writeSuccess = await updateFileContent(newFileId, defaultContentStr);
                return writeSuccess ? newFileId : null;
            } catch (error) { console.error(`Erreur Drive (findOrCreate ${filename}):`, error); showMessage(`Erreur Drive (${filename.substring(0, 15)}...): ${error.message}`, 6000, "error"); return null; }
        }

        async function readFileContent(fileId) {
            if (!googleAccessToken || !fileId) return null;
            const url = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`;
            try {
                const response = await fetch(url, { headers: { 'Authorization': `Bearer ${googleAccessToken}` } });
                if (!response.ok) {
                    if (response.status === 404) { return null; }
                    if (response.status === 401 || response.status === 403) { showMessage("Session Google expirÃ©e.", 5000, "error"); googleAccessToken = null; updateAuthUI(false); return null; }
                    throw new Error(`Lecture Ã©chouÃ©e (${response.status})`);
                }
                return await response.text();
            } catch (error) { console.error(`Erreur Drive (readFile ${fileId}):`, error); showMessage(`Erreur Lecture Drive: ${error.message}`, 6000, "error"); return null; }
        }

        async function updateFileContent(fileId, content) {
            if (!googleAccessToken || !fileId) return false;
            if (isSavingDriveData) return false;
            isSavingDriveData = true;
            updateAuthUI(!!googleAccessToken);
            const url = `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`;
            const isJson = typeof content === 'object'; const contentToSend = isJson ? JSON.stringify(content, null, 2) : content;
            const contentType = isJson ? 'application/json; charset=UTF-8' : 'text/plain; charset=UTF-8'; let success = false;
            try {
                const response = await fetch(url, { method: 'PATCH', headers: { 'Authorization': `Bearer ${googleAccessToken}`, 'Content-Type': contentType }, body: contentToSend });
                if (!response.ok) { if (response.status === 401 || response.status === 403) { showMessage("Session expirÃ©e.", 5000, true); googleAccessToken = null; updateAuthUI(false); } else throw new Error(`Ã‰criture Ã©chouÃ©e ${response.status}`); }
                else success = true;
            } catch (error) { console.error(`Erreur updateFileContent pour ${fileId}:`, error); showMessage(`Erreur sauvegarde fichier Drive.`, 5000, true); }
            finally { isSavingDriveData = false; updateAuthUI(!!googleAccessToken); } return success;
        }

        function formatTime(seconds) { const cleanSeconds = Math.max(0, Math.round(seconds)); const minutes = Math.floor(cleanSeconds / 60); const remainingSeconds = cleanSeconds % 60; return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`; }

        function updateOverallWorkoutProgressDisplay() {
            if (!timerProgressIndicator || !workoutStepTotalDisplay || !workoutStepCurrentDisplay || !workoutStepInfoDisplay) return;
            if (isWorkoutActive && currentWorkoutPlan.length > 0) {
                const totalItemsInPlan = currentWorkoutPlan.length;
                const currentStepForDisplay = Math.min(currentItemIndex + 1, totalItemsInPlan);
                const progressPercentage = totalItemsInPlan > 0 ? currentStepForDisplay / totalItemsInPlan : 0;
                const dashoffset = TIMER_PROGRESS_CIRCLE_CIRCUMFERENCE * (1 - progressPercentage);
                timerProgressIndicator.style.strokeDashoffset = Math.max(0, dashoffset);
                workoutStepCurrentDisplay.textContent = `Ã‰tape ${currentStepForDisplay}`;
                workoutStepTotalDisplay.textContent = `/ ${totalItemsInPlan}`;
                workoutStepInfoDisplay.classList.add('visible');
            } else {
                timerProgressIndicator.style.strokeDashoffset = TIMER_PROGRESS_CIRCLE_CIRCUMFERENCE;
                workoutStepCurrentDisplay.textContent = `--`;
                workoutStepTotalDisplay.textContent = `--`;
                workoutStepInfoDisplay.classList.remove('visible');
            }
        }

        function updateTimerDisplay() {
            if (!timeDisplayDiv) return;
            let timeString = "00:00"; const item = currentWorkoutPlan[currentItemIndex];
            switch (currentState) {
                case 'exercise': timeString = (item && item.duration !== undefined && item.duration !== null) ? formatTime(timeLeft) : "GO!"; break;
                case 'break': timeString = formatTime(timeLeft); break;
                case 'paused': timeString = (previousState === 'break' || (previousState === 'exercise' && item && item.duration !== undefined && item.duration !== null)) ? formatTime(timeLeft) : "PAUSE"; break;
                case 'preparing': timeString = formatTime(prepareTimeLeft); break;
                case 'get-ready': timeString = "PRÃŠT ?"; break;
                case 'completed': timeString = "âœ“"; break;
                case 'finished': timeString = "FINI!"; break;
                default: timeString = formatTime(0); break;
            }
            timeDisplayDiv.textContent = timeString;
            updateOverallWorkoutProgressDisplay();
        }

        function updateTimerVisuals(state) {
            if (!timerProgressIndicator) return;
            let stateColorVar = '--idle-color-val', stateGlowRgbVar = '--idle-color-rgb', progressCircleColorVar = '--electric-cyan';
            const item = currentWorkoutPlan[currentItemIndex];
            const isTimedExercise = state === 'exercise' && item && item.duration !== undefined && item.duration !== null;
            switch (state) {
                case 'exercise': stateColorVar = isTimedExercise ? '--exercise-timed-color-val' : '--exercise-color-val'; stateGlowRgbVar = isTimedExercise ? '--exercise-timed-color-rgb' : '--exercise-color-rgb'; progressCircleColorVar = isTimedExercise ? 'var(--exercise-timed-color-val)' : 'var(--exercise-color-val)'; break;
                case 'break': stateColorVar = '--break-color-val'; stateGlowRgbVar = '--break-color-rgb'; progressCircleColorVar = 'var(--break-color-val)'; break;
                case 'paused': stateColorVar = '--paused-color-val'; stateGlowRgbVar = '--paused-color-rgb'; progressCircleColorVar = 'var(--paused-color-val)'; break;
                case 'preparing': stateColorVar = '--preparing-color-val'; stateGlowRgbVar = '--preparing-color-rgb'; progressCircleColorVar = 'var(--preparing-color-val)'; break;
                case 'get-ready': stateColorVar = '--get-ready-color-val'; stateGlowRgbVar = '--get-ready-color-rgb'; progressCircleColorVar = 'var(--get-ready-color-val)'; break;
                case 'finished': case 'completed': stateColorVar = '--finished-color-val'; stateGlowRgbVar = '--finished-color-rgb'; progressCircleColorVar = 'var(--finished-color-val)'; break;
                default: progressCircleColorVar = 'var(--idle-color-val)'; break;
            }
            const rootStyle = getComputedStyle(document.documentElement);
            document.documentElement.style.setProperty('--current-timer-state-color', rootStyle.getPropertyValue(stateColorVar).trim());
            document.documentElement.style.setProperty('--current-timer-state-color-rgb', rootStyle.getPropertyValue(stateGlowRgbVar).trim());
            timerProgressIndicator.style.stroke = rootStyle.getPropertyValue(progressCircleColorVar.startsWith('var(') ? progressCircleColorVar.slice(4, -1) : progressCircleColorVar).trim();
            if (currentExerciseNameDisplay) {
                if (state === 'exercise') { currentExerciseNameDisplay.style.color = rootStyle.getPropertyValue(isTimedExercise ? '--color-exercise-timed' : '--color-exercise').trim(); }
                else if (['break', 'preparing', 'get-ready'].includes(state)) { currentExerciseNameDisplay.style.color = rootStyle.getPropertyValue('--color-break').trim(); }
                else { currentExerciseNameDisplay.style.color = rootStyle.getPropertyValue('--primary-text-color-dark').trim(); }
            }
        }

        function getFormattedReps(item) {
            if (!item) return "-";
            if (item.reps_text) return item.reps_text;
            if (item.duration !== undefined && item.duration !== null) return formatTime(item.duration) + (item.unit_duration ? ` ${item.unit_duration}` : "s");
            let repsDisplay = (item.reps !== undefined && item.reps !== null) ? String(item.reps) : "-";
            let repsUnit = item.reps_unit || "";
            return `${repsDisplay}${repsUnit ? ' ' + repsUnit : ''}`;
        }

        function getFormattedWeight(item) {
            if (!item) return "-";
            if (item.weight_text) return item.weight_text;
            if (item.unit && item.unit.toLowerCase() === "pdc") return "ðŸ’ª Poids du Corps";
            if (item.unit && (item.unit.includes("Ã‰lastique") || item.unit.startsWith("RÃ©sistance"))) return `ðŸ§˜ ${item.unit}`;
            if (item.weight !== undefined && item.weight > 0 && item.unit) return `ðŸ‹ï¸ ${item.weight} ${item.unit}`;
            if (item.weight !== undefined && item.weight > 0) return `ðŸ‹ï¸ ${item.weight} kg`;
            return "ðŸ’ª Poids du Corps";
        }

        function getDynamicSetsInfo(targetIndex, plan) {
            const contextPlan = plan || currentWorkoutPlan;
            if (!contextPlan || targetIndex < 0 || targetIndex >= contextPlan.length) return '';
            const targetItem = contextPlan[targetIndex];
            if (!targetItem || (!targetItem.type.startsWith('exercise'))) return '';
            const exName = targetItem.name;
            const allSetsForExercise = contextPlan.filter(i => i.name === exName && i.type.startsWith('exercise'));
            const totalSets = allSetsForExercise.length;
            if (totalSets <= 1) return targetItem.sets_info || '';
            let currentSet = 0;
            for (let i = 0; i <= targetIndex; i++) { if (contextPlan[i].name === exName && contextPlan[i].type.startsWith('exercise')) { currentSet++; } }
            return `SÃ©rie ${currentSet}/${totalSets}`;
        }
        
        function createNextExercisePreviewHtml(nextExercise, state, dynamicSetsInfo) {
            if (!nextExercise) return '';
            const formattedNextReps = getFormattedReps(nextExercise); const formattedNextWeight = getFormattedWeight(nextExercise);
            const iconClass = state === 'preparing' ? 'fa-hourglass-start' : 'fa-arrow-right'; const borderColorVar = state === 'preparing' ? '--color-prepare' : '--color-break';
            const iconColor = (state === 'preparing' ? `var(--color-prepare)` : `var(--color-break)`);
            let nextDetailsHtml = '';
            if (dynamicSetsInfo) { nextDetailsHtml += `<span><i class="fas fa-layer-group"></i> ${dynamicSetsInfo}</span>`; }
            nextDetailsHtml += `<span><i class="fas fa-repeat"></i> ${formattedNextReps}</span>`;
            if (formattedNextWeight.trim() !== "ðŸ’ª Poids du Corps") { nextDetailsHtml += `<span><i class="fas fa-weight-hanging"></i> ${formattedNextWeight.replace(/ðŸ‹ï¸|ðŸ§˜|ðŸ’ª|âš¡ï¸/g, '').trim()}</span>`; }
            return `<div class="next-exercise-preview" style="border-color: var(${borderColorVar});"><div class="title"><i class="fas ${iconClass}" style="color: ${iconColor};"></i><strong>Ã€ suivre : ${nextExercise.name || '?'}</strong></div><div class="next-details-grid">${nextDetailsHtml}</div></div>`;
        }

        function updateWorkoutInfo() {
            if (!currentExerciseContainer || !currentExerciseNameDisplay || !progressTracker || !progressTextArea || !exerciseImageContainer || !exerciseImageDisplay || !controls) return;
            const item = currentWorkoutPlan[currentItemIndex]; let infoHtml = '', exerciseName = '', progressText = '';
            const body = document.body; let showImage = false, imageUrlForDisplay = '';
            const isWorkoutView = ['preparing', 'get-ready', 'exercise', 'break', 'paused', 'completed', 'finished'].includes(currentState);
            timerView.style.display = isWorkoutView ? 'flex' : 'none'; controls.style.display = isWorkoutView ? 'flex' : 'none'; workoutInfoView.style.display = isWorkoutView ? 'block': 'none';
            if (item && item.type.startsWith('exercise') && (currentState === 'exercise' || currentState === 'get-ready' || (currentState === 'paused' && previousState === 'exercise'))) { imageUrlForDisplay = item.image_url; if (imageUrlForDisplay) showImage = true; }
            else if (currentState === 'preparing' && currentWorkoutPlan[0] && currentWorkoutPlan[0].type.startsWith('exercise')) { imageUrlForDisplay = currentWorkoutPlan[0].image_url; if (imageUrlForDisplay) showImage = true; }
            if (showImage && imageUrlForDisplay) { exerciseImageDisplay.src = imageUrlForDisplay; exerciseImageDisplay.alt = item?.name || "Image de l'exercice"; exerciseImageContainer.classList.add('visible'); }
            else { exerciseImageContainer.classList.remove('visible'); setTimeout(() => { if (!exerciseImageContainer.classList.contains('visible')) { exerciseImageDisplay.src = ''; exerciseImageDisplay.alt = ''; } }, 400); }
            const isTimedExo = item && item.type.startsWith('exercise') && item.duration !== undefined && item.duration !== null;
            document.body.dataset.timed = isTimedExo;
            switch (currentState) {
                case 'idle':
                    showSection('home-section');
                    return; 
                case 'finished': const durationSeconds = workoutStartTime ? (Date.now() - workoutStartTime) / 1000 : 0; exerciseName = 'EntraÃ®nement TerminÃ© !'; infoHtml = `<div class="exercise-details" style="border-color: var(--color-finished);"><div class="main-stats"><span><i class="fas ${getIconForState('finished')}" style="color: var(--color-finished)"></i> Bravo ! ${durationSeconds > 0 ? `(${formatTime(durationSeconds)})` : ''}</span></div></div>`; progressText = ''; break;
                case 'preparing': const nextItemToPrepare = currentWorkoutPlan[0]; exerciseName = `PrÃ©paration...`; if(nextItemToPrepare) { const dynamicSetsInfo = getDynamicSetsInfo(0); infoHtml = createNextExercisePreviewHtml(nextItemToPrepare, 'preparing', dynamicSetsInfo); } progressText = `DurÃ©e Totale: 00:00`; break;
                case 'get-ready': exerciseName = "Get Ready!"; if(item) { infoHtml = `<div class="break-info" style="border-color: var(--get-ready-color-val);"><i class="fas fa-stopwatch fa-spin" style="color: var(--get-ready-color-val)"></i><span>PrÃ©parez-vous pour <strong>${item.name}</strong></span></div>`; } progressText = `DurÃ©e Totale: ${formatTime(workoutStartTime ? (Date.now() - workoutStartTime) / 1000 : 0)}`; break;
                case 'exercise': case 'paused': case 'break': case 'completed':
                    if (!item) { exerciseName = 'Erreur'; infoHtml = '<p>Erreur chargement Ã©tape.</p>'; progressText = `DurÃ©e Totale: --:--`; break; }
                    exerciseName = item.type === 'break' ? 'Repos' : (item.name || 'Exercice Inconnu');
                    const elapsed = workoutStartTime ? (Date.now() - workoutStartTime) / 1000 : 0; progressText = `DurÃ©e Totale: ${formatTime(elapsed)}`;
                    if (item.type.startsWith('exercise')) {
                        const repsDisplay = getFormattedReps(item); const weightDisplay = getFormattedWeight(item); const dynamicSetsInfo = getDynamicSetsInfo(currentItemIndex) || item.sets_info; const isTimed = item.duration !== undefined && item.duration !== null;
                        infoHtml = `<div class="exercise-details" data-timed="${isTimed}" style="border-color: ${isTimed ? 'var(--color-exercise-timed)' : 'var(--color-exercise)'};">`;
                        if (dynamicSetsInfo) { infoHtml += `<span class="sets-info-text"><i class="fas fa-layer-group"></i> ${dynamicSetsInfo}</span>`; }
                        infoHtml += `<div class="main-stats"><span><i class="fas fa-repeat"></i> ${repsDisplay}</span>`;
                        if (weightDisplay.trim() !== "ðŸ’ª Poids du Corps") infoHtml += `<span><i class="fas fa-weight-hanging"></i> ${weightDisplay.replace(/ðŸ‹ï¸|ðŸ§˜|ðŸ’ª|âš¡ï¸/g, '').trim()}</span>`;
                        infoHtml += `</div></div>`;
                    } else if (item.type === 'break') {
                        infoHtml = ''; const nextExIdx = currentItemIndex + 1;
                        if (nextExIdx < currentWorkoutPlan.length && (currentWorkoutPlan[nextExIdx].type.startsWith('exercise'))) { const nextEx = currentWorkoutPlan[nextExIdx]; const dynamicSetsInfo = getDynamicSetsInfo(nextExIdx); infoHtml = createNextExercisePreviewHtml(nextEx, 'break', dynamicSetsInfo); }
                        else { infoHtml = `<div class="break-info" style="border-color: var(--color-break);"><i class="fas ${getIconForType('break')}" style="color: var(--color-break)"></i><span>DÃ©tendez-vous...</span></div>`; }
                    } break;
                default: exerciseName = '?'; infoHtml = '<p>Ã‰tat inconnu.</p>'; progressText = ''; break;
            }
            if(currentExerciseNameDisplay) currentExerciseNameDisplay.textContent = exerciseName; if(currentExerciseContainer) currentExerciseContainer.innerHTML = infoHtml; if(progressTextArea) progressTextArea.textContent = progressText;
            body.className = Array.from(body.classList).filter(cls => !cls.startsWith('state-')).join(' ') + ` state-${currentState}`; body.classList.toggle('workout-active', !['idle', 'finished'].includes(currentState));
            if (isWorkoutView) showSection('workout-section');
            updateTimerVisuals(currentState);
        }

        function getIconForState(state){ switch(state){ case 'exercise': return 'fa-dumbbell'; case 'break': return 'fa-hourglass-half'; case 'paused': return 'fa-pause-circle'; case 'preparing': return 'fa-spinner'; case 'finished': return 'fa-flag-checkered'; case 'completed': return 'fa-check'; default: return 'fa-clock'; } }
        function getIconForType(type){ if(type === "exercise_myo_reps") return 'fa-bolt'; if (type === "exercise_drop_set") return 'fa-angle-double-down'; if (type === "exercise_timed") return 'fa-stopwatch'; if(type === "exercise_cluster") return 'fa-cubes'; if (type?.startsWith('exercise')) return 'fa-dumbbell'; if (type === 'break') return 'fa-coffee'; return 'fa-question-circle'; }
        
        function startGenericTimer() {
            const item = currentWorkoutPlan[currentItemIndex];
            if (!item || item.duration === undefined || item.duration === null) { handleItemCompletion(); return; }
            if (timeLeft <= 0) { totalTime = item.duration; timeLeft = totalTime; }
            updateTimerDisplay(); const sounds = { 5: sound5, 4: sound4, 3: sound3, 2: sound2, 1: sound1 }; if (sounds[timeLeft]) playSound(sounds[timeLeft]);
            timerInterval = setInterval(() => { timeLeft--; updateTimerDisplay(); if (sounds[timeLeft]) playSound(sounds[timeLeft]); if (timeLeft <= 0) { clearInterval(timerInterval); handleItemCompletion(); } }, 1000);
        }

        function setState(newState) {
            if (!startPauseBtn || !skipBtn || !finishBtn || !resetBtn || !timerDisplayElement || !prevBtn || !timeDisplayDiv) return;
            previousState = currentState; currentState = newState; clearInterval(timerInterval); clearInterval(prepareCountdownInterval); clearInterval(getReadyInterval);
            const body = document.body;
            body.className = Array.from(body.classList).filter(cls => !cls.startsWith('state-')).join(' ') + ` state-${newState}`; body.classList.toggle('workout-active', !['idle', 'finished'].includes(currentState));
            if(startPauseBtn) { startPauseBtn.className = ''; startPauseBtn.disabled = true; }
            if(skipBtn) skipBtn.disabled = true; if(prevBtn) prevBtn.disabled = true; if(finishBtn) finishBtn.disabled = true; if(resetBtn) resetBtn.disabled = true;
            const isTimerActive = ['preparing', 'get-ready', 'exercise', 'break', 'paused', 'completed'].includes(currentState);
            if (editProgramBtn) editProgramBtn.disabled = !(googleAccessToken && programsLoaded && loadedFullProgram && !isTimerActive);
            document.querySelectorAll('nav a.nav-link').forEach(link => { link.classList.toggle('disabled-link-look', isTimerActive); });
            const item = currentWorkoutPlan[currentItemIndex]; const isTimedExercise = item && item.type.startsWith('exercise') && item.duration !== undefined && item.duration !== null;
            switch (newState) {
                case 'idle': isTimerRunning = false; isWorkoutActive = false; workoutFinished = false; timeLeft = 0; totalTime = 0; workoutStartTime = null; if(startPauseBtn) { startPauseBtn.disabled = true; startPauseBtn.innerHTML = `<i class="fas fa-play"></i> DÃ©marrer`; startPauseBtn.classList.add('start-btn'); } if(resetBtn) resetBtn.disabled = true; if (wasFinishedState) wasFinishedState = false; break;
                case 'preparing': isWorkoutActive = true; prepareTimeLeft = PREPARE_DURATION; if(startPauseBtn) { startPauseBtn.innerHTML = `<i class="fas ${getIconForState('preparing')} fa-spin"></i> PrÃªt...`; } if(resetBtn) resetBtn.disabled = !googleAccessToken; startPrepareCountdown(); if (!workoutStartTime) { workoutStartTime = Date.now(); } vibrate([50,30,50]); break;
                case 'get-ready': isWorkoutActive = true; prepareTimeLeft = GET_READY_DURATION; startGetReadyCountdown(); playSound(soundScan); vibrate([50,30,50]); break;
                case 'exercise': isWorkoutActive = true; body.dataset.timed = isTimedExercise; if (isTimedExercise) { isTimerRunning = true; if(startPauseBtn) { startPauseBtn.disabled = false; startPauseBtn.innerHTML = `<i class="fas fa-pause"></i> Pause`; } startGenericTimer(); } else { isTimerRunning = false; if(startPauseBtn) { startPauseBtn.innerHTML = `<i class="fas fa-check"></i> Fait`; startPauseBtn.disabled = false; } } if(skipBtn) skipBtn.disabled = false; if(prevBtn) prevBtn.disabled = currentItemIndex <= 0; if(finishBtn) finishBtn.disabled = false; if(resetBtn) resetBtn.disabled = false; vibrate([150]); playSound(soundLaser); triggerTriangleSpin(); break;
                case 'completed': isTimerRunning = false; isWorkoutActive = true; vibrate([80]); playSound(soundComplete); setTimeout(() => { handleItemCompletion(); }, 1000); break;
                case 'break': isWorkoutActive = true; isTimerRunning = true; if(startPauseBtn) { startPauseBtn.disabled = false; startPauseBtn.innerHTML = `<i class="fas fa-pause"></i> Pause`; } if(skipBtn) skipBtn.disabled = false; if(prevBtn) prevBtn.disabled = currentItemIndex <= 0; if(finishBtn) finishBtn.disabled = false; if(resetBtn) resetBtn.disabled = false; startGenericTimer(); vibrate([80, 50, 80]); playSound(soundLaser); triggerTriangleSpin(); break;
                case 'paused': isTimerRunning = false; isWorkoutActive = true; if(startPauseBtn) { startPauseBtn.disabled = false; startPauseBtn.innerHTML = `<i class="fas fa-play"></i> Reprendre`; } if(skipBtn) skipBtn.disabled = false; if(prevBtn) prevBtn.disabled = currentItemIndex <= 0; if(finishBtn) finishBtn.disabled = false; if(resetBtn) resetBtn.disabled = false; vibrate(); break;
                case 'finished': isWorkoutActive = false; isTimerRunning = false; workoutFinished = true; wasFinishedState = true; timeLeft = 0; totalTime = 0; if(startPauseBtn) { startPauseBtn.innerHTML = `<i class="fas fa-flag-checkered"></i> TerminÃ©`; } if(resetBtn) resetBtn.disabled = !googleAccessToken; showMessage('EntraÃ®nement terminÃ© ! ðŸ’ª', 3000); vibrate([150, 50, 150]); playSound(soundET); originalCompletedWorkoutPlan = JSON.parse(JSON.stringify(currentWorkoutPlan)); saveWorkoutToHistory(); clearInProgressState(); triggerTriangleSpin(); setTimeout(() => populateAndShowSummary({mode: 'workout', sessionName: currentWorkoutType}), 500); break;
                default: currentState = 'idle'; updateAuthUI(!!googleAccessToken); break;
            }
            updateWorkoutInfo(); updateTimerVisuals(newState); updateTimerDisplay();
        }

        function startPrepareCountdown() {
            totalTime = PREPARE_DURATION; updateTimerDisplay(); if (prepareTimeLeft === 3) playSound(sound3);
            prepareCountdownInterval = setInterval(() => { prepareTimeLeft--; updateTimerDisplay(); if (prepareTimeLeft === 2) playSound(sound2); if (prepareTimeLeft === 1) playSound(sound1); if (prepareTimeLeft <= 0) { clearInterval(prepareCountdownInterval); const firstItem = currentWorkoutPlan[0]; if(firstItem && firstItem.type.startsWith('exercise') && firstItem.duration !== undefined && firstItem.duration !== null){ setState('get-ready'); } else { setState('exercise'); } } }, 1000);
        }
        function startGetReadyCountdown() { timeLeft = GET_READY_DURATION; getReadyInterval = setInterval(() => { timeLeft--; if (timeLeft <= 0) { clearInterval(getReadyInterval); setState('exercise'); } }, 1000); }
        function handleItemCompletion() {
            if (currentState === 'finished') return;
            const item = currentWorkoutPlan[currentItemIndex]; if (currentState === 'exercise' && item && (item.duration === undefined || item.duration === null) && currentState !== 'completed') { setState('completed'); return; }
            currentItemIndex++; timeLeft = 0; updateOverallWorkoutProgressDisplay();
            if (currentItemIndex >= currentWorkoutPlan.length) { setState('finished'); }
            else { const nextItem = currentWorkoutPlan[currentItemIndex]; if(nextItem.type.startsWith('exercise') && nextItem.duration !== undefined && nextItem.duration !== null) { setState('get-ready'); } else { setState(nextItem.type === 'break' ? 'break' : 'exercise'); } }
            saveInProgressState();
        }
        function handlePreviousClick() { if (currentItemIndex > 0) { currentItemIndex--; timeLeft = 0; updateOverallWorkoutProgressDisplay(); const prevItem = currentWorkoutPlan[currentItemIndex]; setState(prevItem.type === 'break' ? 'break' : 'exercise'); saveInProgressState(); vibrate(); } }
        function forceFinishWorkout() { if (confirm("ÃŠtes-vous sÃ»r de vouloir terminer l'entraÃ®nement ?")) { setState('finished'); } }
        function loadSession(sessionName) {
            if (!loadedFullProgram || !loadedFullProgram.sessions) { showMessage(`Programme non chargÃ©.`, 5000, true); return; }
            const session = loadedFullProgram.sessions.find(s => s.nom_session.startsWith(sessionName));
            if (!session || !session.exercices_et_pauses) { showMessage(`Session "${sessionName}" invalide.`, 4000, true); return; }
            currentWorkoutType = session.nom_session; currentWorkoutPlan = JSON.parse(JSON.stringify(session.exercices_et_pauses)); currentItemIndex = 0; workoutStartTime = null; vibrate(); clearInProgressState();
        }
        function resetCurrentWorkout() { if (currentWorkoutType && confirm(`RÃ©initialiser l'entraÃ®nement ${currentWorkoutType} ?`)) { setState('idle'); } }
        function showMessage(msg, duration = 3000, isError = false) { if (!messageArea) return; messageArea.textContent = msg; messageArea.classList.add('visible'); messageArea.classList.toggle('error-message', isError); if (messageTimeoutId) clearTimeout(messageTimeoutId); messageTimeoutId = setTimeout(() => { messageArea.classList.remove('visible'); }, duration); }
        
        function showSection(sectionId) {
            [homeSection, workoutSection].forEach(section => { if (section && section.id !== sectionId) section.classList.add('section-hidden'); });
            const sectionToShow = document.getElementById(sectionId); if (sectionToShow) sectionToShow.classList.remove('section-hidden');
        }
        
        function renderHomeScreen() {
            if (!homeSection) return;
            homeSection.innerHTML = '';
            
            if (!googleAccessToken) {
                homeSection.innerHTML = `<div class="app-section" style="text-align:center; padding: 20px;"><p>Veuillez vous connecter Ã  Google Drive pour charger votre programme et voir votre historique.</p></div>`;
                return;
            }

            const homeGrid = document.createElement('div');
            homeGrid.className = 'home-grid';

            const mainContent = document.createElement('div');
            mainContent.className = 'home-main-content';

            const sidebar = document.createElement('div');
            sidebar.className = 'home-sidebar';

            sidebar.appendChild(renderConsistencyCalendarModule(displayedCalendarDate));
            
            if (loadedFullProgram && loadedFullProgram.sessions) {
                loadedFullProgram.sessions.forEach(session => {
                    const card = document.createElement('div');
                    card.className = 'session-card-large';
                    card.dataset.sessionName = session.nom_session;
                    
                    const lastSession = workoutHistory.slice().reverse().find(h => h.type === session.nom_session);
                    let lastSessionText = "Aucun historique.";
                    if (lastSession) {
                        const lastDate = new Date(lastSession.date);
                        const now = new Date();
                        const diffDays = Math.round((now - lastDate) / (1000 * 60 * 60 * 24));
                        if (diffDays === 0) lastSessionText = "Aujourd'hui";
                        else if (diffDays === 1) lastSessionText = "Hier";
                        else lastSessionText = `Il y a ${diffDays} j.`;
                    }

                    const sparklineCanvasId = `sparkline-chart-${session.nom_session.replace(/\s+/g, '-')}`;
                    let exerciseDetailsHtml = '<div class="session-card-details">';
                    const uniqueExercises = [...new Map(session.exercices_et_pauses.filter(ex => ex.type.startsWith('exercise')).map(item => [item['name'], item])).values()];
                    uniqueExercises.forEach((ex, idx) => {
                         const detailCanvasId = `detail-chart-${session.nom_session.replace(/\s+/g, '-')}-${idx}`;
                         exerciseDetailsHtml += `
                            <div class="exercise-detail-item">
                                <div class="exercise-detail-header">${ex.name}</div>
                                <div class="detailed-chart-container">
                                    <canvas id="${detailCanvasId}"></canvas>
                                    <div id="${detailCanvasId}-placeholder" class="chart-placeholder" style="display: none;"></div>
                                </div>
                            </div>
                         `;
                    });
                    exerciseDetailsHtml += '</div>';

                    card.innerHTML = `
                        <div class="toggle-details-btn" title="Afficher/Masquer les graphiques dÃ©taillÃ©s"><i class="fas fa-chart-line"></i></div>
                        <div class="session-card-summary">
                            <div class="session-card-header">
                                <h3>${session.nom_session}</h3>
                                <div class="last-session-info"><i class="fas fa-history"></i> ${lastSessionText}</div>
                            </div>
                            <p>${session.description_session || ''}</p>
                            <div class="sparkline-chart-container">
                                <canvas id="${sparklineCanvasId}"></canvas>
                                <div id="${sparklineCanvasId}-placeholder" class="chart-placeholder" style="display: none;"></div>
                            </div>
                        </div>
                        ${exerciseDetailsHtml}
                    `;
                    mainContent.appendChild(card);
                    
                    setTimeout(() => {
                        const canvasEl = document.getElementById(sparklineCanvasId);
                        if(canvasEl) renderSparklineChart(canvasEl, session.nom_session);
                    }, 0);
                });
            }

            homeGrid.appendChild(mainContent);
            homeGrid.appendChild(sidebar);
            homeSection.appendChild(homeGrid);
        }

        function renderConsistencyCalendarModule(date) {
            let module = document.getElementById('consistency-module');
            if (!module) {
                module = document.createElement('div');
                module.className = 'sidebar-module';
                module.id = 'consistency-module';
            }
            
            const weeklyStreak = calculateWeeklyStreak();
            let streakClass = '';
            if (weeklyStreak >= 2 && weeklyStreak <=3) streakClass = 'streak-bronze';
            else if (weeklyStreak >= 4 && weeklyStreak <= 7) streakClass = 'streak-silver';
            else if (weeklyStreak >= 8) streakClass = 'streak-gold';

            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - (today.getDay() === 0 ? 6 : today.getDay() - 1));
            startOfWeek.setHours(0, 0, 0, 0);
            const workoutsThisWeek = workoutHistory.filter(h => new Date(h.date) >= startOfWeek).length;
            const weeklyGoal = 3;
            const weeklyProgress = Math.min((workoutsThisWeek / weeklyGoal) * 100, 100);

            module.innerHTML = `
                <h3><i class="fas fa-calendar-check"></i> RÃ©gularitÃ©</h3>
                <div class="consistency-info">
                    <div class="consistency-text">Objectif semaine : <strong>${workoutsThisWeek} / ${weeklyGoal}</strong></div>
                    <div class="weekly-goal-progress-bar"><div class="weekly-goal-progress" style="width: ${weeklyProgress}%;"></div></div>
                    ${weeklyStreak > 0 ? `<div class="streak-counter ${streakClass}"><i class="fas fa-fire-alt"></i> ${weeklyStreak} sem. de suite !</div>` : ''}
                </div>
                <div class="calendar-nav">
                    <button class="prev-month"><i class="fas fa-chevron-left"></i></button>
                    <span class="calendar-title">${date.toLocaleString('fr-FR', { month: 'long', year: 'numeric' })}</span>
                    <button class="next-month"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="monthly-calendar"></div>
            `;

            const calendarGrid = module.querySelector('.monthly-calendar');
            const workoutDates = new Set(workoutHistory.map(h => new Date(h.date).toISOString().split('T')[0]));
            const month = date.getMonth();
            const year = date.getFullYear();

            const firstDayOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const startingDay = (firstDayOfMonth.getDay() + 6) % 7; // 0 = Lundi

            const dayHeaders = ['L', 'M', 'M', 'J', 'V', 'S', 'D'];
            dayHeaders.forEach(day => {
                const headerEl = document.createElement('div');
                headerEl.className = 'calendar-header';
                headerEl.textContent = day;
                calendarGrid.appendChild(headerEl);
            });

            for (let i = 0; i < startingDay; i++) {
                calendarGrid.appendChild(document.createElement('div'));
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                dayEl.textContent = day;
                
                const currentDate = new Date(year, month, day);
                const dateString = currentDate.toISOString().split('T')[0];
                
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                    dayEl.classList.add('today');
                }

                if (workoutDates.has(dateString)) {
                    const dot = document.createElement('span');
                    dot.className = 'day-dot';
                    dayEl.appendChild(dot);
                }
                calendarGrid.appendChild(dayEl);
            }
            return module;
        }

        function calculateWeeklyStreak() {
            if (workoutHistory.length < 3) return 0;
        
            const weeklyGoal = 3;
            const workoutsByWeek = {};
            workoutHistory.forEach(h => {
                const d = new Date(h.date);
                const firstDayOfWeek = new Date(d);
                firstDayOfWeek.setDate(d.getDate() - (d.getDay() === 0 ? 6 : d.getDay() - 1));
                firstDayOfWeek.setHours(0,0,0,0);
                const weekKey = firstDayOfWeek.toISOString().split('T')[0];
        
                if (!workoutsByWeek[weekKey]) workoutsByWeek[weekKey] = 0;
                workoutsByWeek[weekKey]++;
            });
        
            const sortedWeeks = Object.keys(workoutsByWeek).sort().reverse();
            let streak = 0;
            let currentWeek = new Date();
            currentWeek.setDate(currentWeek.getDate() - (currentWeek.getDay() === 0 ? 6 : currentWeek.getDay() - 1));
            currentWeek.setHours(0,0,0,0);
        
            const currentWeekKey = currentWeek.toISOString().split('T')[0];
            let lastWeek = new Date(currentWeek);
            lastWeek.setDate(lastWeek.getDate() - 7);
            const lastWeekKey = lastWeek.toISOString().split('T')[0];

            let weekToStart = null;
            if (workoutsByWeek[currentWeekKey] >= weeklyGoal) {
                weekToStart = currentWeek;
            } else if (workoutsByWeek[lastWeekKey] >= weeklyGoal) {
                weekToStart = lastWeek;
            } else {
                return 0; // Streak is broken
            }
            
            streak = 1;
            let previousWeek = new Date(weekToStart);
            while (true) {
                previousWeek.setDate(previousWeek.getDate() - 7);
                const previousWeekKey = previousWeek.toISOString().split('T')[0];
                if (workoutsByWeek[previousWeekKey] >= weeklyGoal) {
                    streak++;
                } else {
                    break;
                }
            }
            return streak;
        }

        function calculateSessionVolume(sessionHistoryEntry) {
            if (!sessionHistoryEntry || !sessionHistoryEntry.exercises) return 0;
            return sessionHistoryEntry.exercises.reduce((totalVolume, ex) => {
                const reps = parseInt(ex.finalReps, 10) || (ex.finalDuration ? ex.finalDuration / 3 : 0) || 0; 
                const weight = parseWeightDescription(ex.finalWeightDescription).value || 20;
                return totalVolume + (reps * weight);
            }, 0);
        }

        function getExerciseHistory(sessionType, exerciseName) {
            const exerciseHistory = { weights: [], reps: [], dates: [] };
            workoutHistory.forEach(session => {
                if (session.type === sessionType && session.exercises) {
                    const exercisesInSession = session.exercises.filter(ex => ex.name === exerciseName);
                    if (exercisesInSession.length > 0) {
                        const avgWeight = exercisesInSession.reduce((sum, ex) => sum + (parseWeightDescription(ex.finalWeightDescription).value || 0), 0) / exercisesInSession.length;
                        const totalReps = exercisesInSession.reduce((sum, ex) => sum + (parseInt(ex.finalReps, 10) || 0), 0);
                        exerciseHistory.weights.push(avgWeight);
                        exerciseHistory.reps.push(totalReps);
                        exerciseHistory.dates.push(new Date(session.date).toLocaleDateString('fr-FR', {day:'2-digit', month:'2-digit'}));
                    }
                }
            });
            return exerciseHistory;
        }

        function destroyChart(canvasId) {
            if (activeCharts[canvasId]) {
                activeCharts[canvasId].destroy();
                delete activeCharts[canvasId];
            }
        }

        function renderSparklineChart(canvasEl, sessionName) {
            const canvasId = canvasEl.id;
            destroyChart(canvasId);
            const placeholderEl = document.getElementById(`${canvasId}-placeholder`);
            const sessionHistory = workoutHistory.filter(h => h.type === sessionName).slice(-10);
            
            if (sessionHistory.length < 2) {
                if(placeholderEl) { placeholderEl.textContent = 'DonnÃ©es insuffisantes pour la tendance.'; placeholderEl.style.display = 'flex'; }
                return;
            }
            if(placeholderEl) placeholderEl.style.display = 'none';

            const labels = sessionHistory.map((_, i) => i + 1);
            const data = sessionHistory.map(h => calculateSessionVolume(h));

            const ctx = canvasEl.getContext('2d');
            activeCharts[canvasId] = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{ data, borderColor: 'rgba(var(--electric-cyan-rgb), 0.8)', borderWidth: 2, tension: 0.4, pointRadius: 0, fill: true, backgroundColor: 'rgba(var(--electric-cyan-rgb), 0.1)' }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { display: false }, x: { display: false } }, plugins: { legend: { display: false }, tooltip: { enabled: false } } }
            });
        }
        
        function renderDetailedExerciseChart(canvasEl, sessionName, exerciseName) {
            const canvasId = canvasEl.id;
            destroyChart(canvasId);
            const placeholderEl = document.getElementById(`${canvasId}-placeholder`);
            const history = getExerciseHistory(sessionName, exerciseName);

            if (history.weights.length < 1) {
                if(placeholderEl) { placeholderEl.textContent = 'Aucune donnÃ©e pour cet exercice.'; placeholderEl.style.display = 'flex'; }
                return;
            }
            if(placeholderEl) placeholderEl.style.display = 'none';

            const ctx = canvasEl.getContext('2d');
            activeCharts[canvasId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: history.dates.slice(-10),
                    datasets: [
                        { type: 'bar', label: 'Charge (kg)', data: history.weights.slice(-10), backgroundColor: 'rgba(var(--electric-blue-rgb), 0.6)', borderColor: 'rgba(var(--electric-blue-rgb), 1)', yAxisID: 'y' },
                        { type: 'line', label: 'Reps Totales', data: history.reps.slice(-10), borderColor: 'rgba(var(--neon-yellow-rgb), 0.8)', tension: 0.3, yAxisID: 'y1', pointBackgroundColor: 'rgba(var(--neon-yellow-rgb), 1)', borderWidth: 2 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        y: { position: 'left', title: { display: true, text: 'Charge (kg)', color: 'var(--secondary-text-color)'}, beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: 'var(--secondary-text-color)' } },
                        y1: { position: 'right', title: { display: true, text: 'Reps', color: 'var(--secondary-text-color)'}, beginAtZero: true, grid: { drawOnChartArea: false }, ticks: { color: 'var(--secondary-text-color)' } },
                        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: 'var(--secondary-text-color)', maxRotation: 0, minRotation: 0, autoSkip: true, maxTicksLimit: 5 } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }
        
        function parseRepRange(item) {
            const sources = [item.progression_note || '', item.details || ''];
            for (const source of sources) {
                const match = source.match(/RÃ©p(s|Ã©titions)?:\s*(\d+)\s*-\s*(\d+)/i);
                if (match) {
                    return { min: parseInt(match[2], 10), max: parseInt(match[3], 10) };
                }
            }
            const repValue = item.reps !== undefined ? parseInt(item.reps, 10) : ((item.duration !== undefined) ? item.duration : 8);
            return { min: repValue, max: repValue };
        }

        function parseWeightDescription(desc) {
            if (!desc) return { type: 'pdc', value: 0 };
            const descLower = desc.toLowerCase();
            const valueMatch = desc.match(/(\d+([.,]\d+)?)/);
            const value = valueMatch ? parseFloat(valueMatch[1].replace(',', '.')) : 0;
            if (desc.includes('ðŸ’ª') || descLower.includes('pdc') || descLower.includes('corps')) return { type: 'pdc', value: 0 };
            if (desc.includes('âš¡ï¸')) return { type: 'poids_elastique', value: value };
            if (desc.includes('ðŸ§˜') || descLower.includes('Ã©lastique')) return { type: 'elastique', value: 0 };
            if (desc.includes('ðŸ‹ï¸') || descLower.includes('kg') || value > 0) return { type: 'poids', value: value };
            return { type: 'pdc', value: 0 };
        }
        const resistanceTypes = {
            'poids': { emoji: 'ðŸ‹ï¸', text: 'Poids' },
            'elastique': { emoji: 'ðŸ§˜', text: 'Ã‰lastique' },
            'pdc': { emoji: 'ðŸ’ª', text: 'Poids du Corps' },
            'poids_elastique': { emoji: 'âš¡ï¸', text: 'Poids + Ã‰lastique' }
        };
        
        function getColorForExercise(exerciseName) {
            let hash = 0;
            for (let i = 0; i < exerciseName.length; i++) { hash = exerciseName.charCodeAt(i) + ((hash << 5) - hash); }
            const hue = hash % 360;
            return `hsl(${hue}, 70%, 60%)`;
        }

        function populateAndShowSummary(context) {
            currentSummaryContext = context;
            if (!postWorkoutSummary || !summaryItemsList || !summaryTitle || !finishSummaryBtn) return;
            
            let planToShow, sessionName;
            if (context.mode === 'edit') {
                sessionName = context.sessionName;
                const session = loadedFullProgram.sessions.find(s => s.nom_session === sessionName);
                planToShow = session ? session.exercices_et_pauses : [];
                summaryTitle.textContent = `Ã‰dition : ${sessionName}`;
                finishSummaryBtn.innerHTML = `<i class="fas fa-save"></i> Enregistrer`;
            } else { // 'workout' mode
                sessionName = context.sessionName;
                planToShow = originalCompletedWorkoutPlan;
                summaryTitle.textContent = `RÃ©sumÃ©: ${sessionName || 'EntraÃ®nement'}`;
                finishSummaryBtn.innerHTML = `<i class="fas fa-check"></i> Fin & Sauvegarder`;
            }
            
            summaryItemsList.innerHTML = '';
            
            planToShow.forEach((item, index) => {
                if (item.type.startsWith('exercise')) {
                    const li = document.createElement('li');
                    li.classList.add('summary-item');
                    li.dataset.planIndex = index; 
                    li.dataset.exerciseName = item.name;
                    li.style.setProperty('--item-accent-color', getColorForExercise(item.name));
                    
                    const { min, max } = parseRepRange(item);
                    const isTimed = item.duration !== undefined && item.duration !== null;
                    const initialValue = isTimed ? item.duration : (item.reps || min);
                    const initialWeightDesc = getFormattedWeight(item);
                    const parsedWeight = parseWeightDescription(initialWeightDesc);
                    const dynamicSetsInfo = getDynamicSetsInfo(index, planToShow);
                    const isWorkoutMode = context.mode === 'workout';
                    
                    const performanceFieldHtml = isWorkoutMode ? `
                        <div class="input-group">
                            <label>Performance RÃ©alisÃ©e (${isTimed ? 'secondes' : 'rÃ©pÃ©titions'})</label>
                            <div class="stepper-control" data-type="performance">
                                <button class="stepper-btn stepper-minus">-</button>
                                <span class="stepper-value">${initialValue}</span>
                                <button class="stepper-btn stepper-plus">+</button>
                            </div>
                        </div>
                    ` : '';

                    li.innerHTML = `
                        <div class="exercise-name">
                            <i class="fas ${getIconForType(item.type)}"></i>
                            <span class="exercise-name-text">${dynamicSetsInfo ? dynamicSetsInfo + ': ' : ''}${item.name}</span>
                        </div>
                        <div class="fields-grid">
                            ${performanceFieldHtml}
                             <div class="input-group">
                                <label>RÃ©sistance</label>
                                <div class="resistance-controls">
                                    <div class="resistance-selector" data-type="${parsedWeight.type}">
                                        <div class="selected-resistance">
                                            <span>${resistanceTypes[parsedWeight.type].emoji}</span>
                                            <i class="fas fa-caret-down"></i>
                                        </div>
                                        <ul class="resistance-options">
                                            ${Object.entries(resistanceTypes).map(([key, val]) => `<li data-value="${key}"><span>${val.emoji}</span> ${val.text}</li>`).join('')}
                                        </ul>
                                    </div>
                                    <div class="stepper-control resistance-value-stepper" data-type="weight" style="display: ${['poids', 'poids_elastique'].includes(parsedWeight.type) ? 'flex' : 'none'}">
                                        <button class="stepper-btn stepper-minus">-</button>
                                        <span class="stepper-value">${parsedWeight.value}</span>
                                        <button class="stepper-btn stepper-plus">+</button>
                                    </div>
                                </div>
                            </div>
                            <div class="input-group">
                                <label>Objectif Prochaine SÃ©ance</label>
                                <div class="range-stepper-control" data-type="rep-range">
                                    <div class="range-stepper">
                                        <label>Min</label>
                                        <div class="stepper-control" data-type="rep-range-min">
                                            <button class="stepper-btn stepper-minus">-</button>
                                            <span class="stepper-value" data-range-type="min">${min}</span>
                                            <button class="stepper-btn stepper-plus">+</button>
                                        </div>
                                    </div>
                                    <div class="range-stepper">
                                        <label>Max</label>
                                        <div class="stepper-control" data-type="rep-range-max">
                                            <button class="stepper-btn stepper-minus">-</button>
                                            <span class="stepper-value" data-range-type="max">${max}</span>
                                            <button class="stepper-btn stepper-plus">+</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="input-group">
                                <label>Type de Suivi</label>
                                <div class="tracking-type-toggle" data-type="tracking-type">
                                    <button class="tracking-reps ${!isTimed ? 'active' : ''}" data-value="reps"><i class="fas fa-repeat"></i> RÃ©pÃ©titions</button>
                                    <button class="tracking-time ${isTimed ? 'active' : ''}" data-value="time"><i class="fas fa-stopwatch"></i> Temps</button>
                                </div>
                            </div>
                        </div>`;
                    summaryItemsList.appendChild(li);
                }
            });
            postWorkoutSummary.classList.add('visible');
        }

        async function finishSummary() {
            if (!finishSummaryBtn) return;
            finishSummaryBtn.disabled = true; finishSummaryBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Sauvegarde...`;
            
            const isWorkoutMode = currentSummaryContext.mode === 'workout';
            const sessionName = currentSummaryContext.sessionName;
            
            const sessionIndex = loadedFullProgram.sessions.findIndex(s => s.nom_session === sessionName);
            if (sessionIndex === -1) {
                closeSummary(); showMessage("Erreur: Session introuvable.", 4000, true);
                return;
            }

            const latestWorkoutEntry = isWorkoutMode ? workoutHistory[workoutHistory.length - 1] : null;
            const summaryItems = summaryItemsList.querySelectorAll('.summary-item');
            
            let updatedPlan = JSON.parse(JSON.stringify(loadedFullProgram.sessions[sessionIndex].exercices_et_pauses));

            summaryItems.forEach(li => {
                const exerciseName = li.dataset.exerciseName;

                const resistanceSelector = li.querySelector('.resistance-selector');
                const resistanceType = resistanceSelector.dataset.type;
                const weightValue = parseFloat(li.querySelector('.stepper-control[data-type="weight"] .stepper-value').textContent);
                
                const nextMinReps = li.querySelector('.stepper-value[data-range-type="min"]').textContent;
                const nextMaxReps = li.querySelector('.stepper-value[data-range-type="max"]').textContent;

                const trackingType = li.querySelector('.tracking-type-toggle .active').dataset.value;
                const perfValueEl = li.querySelector('.stepper-control[data-type="performance"] .stepper-value');
                
                let finalWeightDescription = resistanceTypes[resistanceType].emoji;
                if (resistanceType === 'poids' || resistanceType === 'poids_elastique') {
                    finalWeightDescription += ` ${weightValue} kg`;
                }

                updatedPlan.forEach(itemInPlan => {
                    if (itemInPlan.name === exerciseName) {
                        itemInPlan.weight_text = finalWeightDescription;
                        delete itemInPlan.unit; delete itemInPlan.weight;
                        itemInPlan.progression_note = `Reps: ${nextMinReps}-${nextMaxReps}`;

                        const perfValue = perfValueEl ? parseInt(perfValueEl.textContent, 10) : (trackingType === 'time' ? itemInPlan.duration : itemInPlan.reps);

                        if (trackingType === 'time') {
                            itemInPlan.duration = perfValue;
                            delete itemInPlan.reps;
                            delete itemInPlan.reps_unit;
                        } else { // 'reps'
                            itemInPlan.reps = perfValue;
                            delete itemInPlan.duration;
                            delete itemInPlan.unit_duration;
                        }
                    }
                });

                if (isWorkoutMode && latestWorkoutEntry) {
                    latestWorkoutEntry.exercises.forEach(historyExercise => {
                        if (historyExercise.name === exerciseName) {
                            historyExercise.finalWeightDescription = finalWeightDescription;
                            historyExercise.finalProgressionNote = `Reps: ${nextMinReps}-${nextMaxReps}`;
                            if(perfValueEl) {
                                const perfValue = parseInt(perfValueEl.textContent, 10);
                                if (trackingType === 'time') {
                                    historyExercise.finalDuration = perfValue;
                                } else {
                                    historyExercise.finalReps = perfValue;
                                }
                            }
                        }
                    });
                }
            });
            
            loadedFullProgram.sessions[sessionIndex].exercices_et_pauses = updatedPlan;

            if (isWorkoutMode) {
                await saveHistoryToDrive();
            }
            await saveFullProgramToDrive(); 
            
            closeSummary(false); 
            setState('idle');
            showMessage("Modifications sauvegardÃ©es avec succÃ¨s !", 3500);

            if(finishSummaryBtn) { 
                finishSummaryBtn.disabled = false; 
                finishSummaryBtn.innerHTML = isWorkoutMode ? `<i class="fas fa-check"></i> Fin & Sauvegarder` : `<i class="fas fa-save"></i> Enregistrer`;
            }
        }


        function closeSummary(updateUIAfter = true) { if(postWorkoutSummary) postWorkoutSummary.classList.remove('visible'); if (updateUIAfter) setState('idle'); }
        async function saveHistoryToDrive() {
            if (!googleAccessToken || !workoutHistory) return; if (!historyFileId) historyFileId = await findOrCreateFile(HISTORY_FILENAME, JSON.stringify([]), 'application/json', true);
            if (historyFileId) { await updateFileContent(historyFileId, workoutHistory); }
            else { showMessage("Impossible de sauvegarder l'historique sur Drive.", 4000, true); }
        }
        async function saveFullProgramToDrive() {
            if (!googleAccessToken || !loadedFullProgram) { return; }
            if (!programFileId) programFileId = await findOrCreateFile(FULL_PROGRAM_FILENAME, JSON.stringify(loadedFullProgram), 'application/json', true); 
            if (programFileId) { await updateFileContent(programFileId, loadedFullProgram); }
            else { showMessage("Impossible de sauvegarder le programme sur Drive.", 4000, true); }
        }
        async function loadHistoryFromDrive() {
            if (!googleAccessToken) return; historyFileId = await findOrCreateFile(HISTORY_FILENAME, JSON.stringify([]), 'application/json', true);
            if (historyFileId) {
                const content = await readFileContent(historyFileId);
                if (content !== null) { try { workoutHistory = JSON.parse(content || "[]"); workoutHistory.forEach(e => { if (!e.exercises) e.exercises = []; }); } catch (e) { showMessage("Historique Drive corrompu.", 4000, true); workoutHistory = []; } }
                else { workoutHistory = []; }
            } else { workoutHistory = []; }
        }
        async function loadFullProgramFromDrive() {
            programsLoaded = false; loadedFullProgram = null; programFileId = await findOrCreateFile(FULL_PROGRAM_FILENAME, "{}", 'application/json', false); 
            if (programFileId) {
                const content = await readFileContent(programFileId);
                if (content && content.trim() !== "") {
                    try { let parsedProgram = JSON.parse(content); if (parsedProgram && parsedProgram.sessions && Array.isArray(parsedProgram.sessions)) { loadedFullProgram = parsedProgram; programsLoaded = true; return true; } } catch (e) { }
                }
            } return false;
        }
        function saveInProgressState() {
            if (!isWorkoutActive || currentState === 'finished') { clearInProgressState(); return; }
            const stateToSave = { currentWorkoutType, currentWorkoutPlan: JSON.parse(JSON.stringify(currentWorkoutPlan)), currentItemIndex, timeLeft, prepareTimeLeft, workoutStartTime, currentState, previousState };
            localStorage.setItem(IN_PROGRESS_KEY, JSON.stringify(stateToSave));
        }
        function loadInProgressState() {
            const savedState = localStorage.getItem(IN_PROGRESS_KEY);
            if (savedState) {
                try {
                    const parsedState = JSON.parse(savedState);
                    if (parsedState.currentWorkoutType && parsedState.currentWorkoutPlan && parsedState.currentState && loadedFullProgram) {
                        if (confirm("Un entraÃ®nement Ã©tait en cours. Voulez-vous le reprendre ?")) {
                            currentWorkoutType = parsedState.currentWorkoutType; currentWorkoutPlan = parsedState.currentWorkoutPlan; currentItemIndex = parsedState.currentItemIndex; timeLeft = parsedState.timeLeft; prepareTimeLeft = parsedState.prepareTimeLeft; workoutStartTime = parsedState.workoutStartTime; previousState = parsedState.previousState || 'idle'; 
                            setState(parsedState.currentState); updateOverallWorkoutProgressDisplay(); showMessage("EntraÃ®nement repris.", 2500); return; 
                        }
                    }
                } catch (e) { console.error("Erreur parsing Ã©tat en cours:", e); }
            } clearInProgressState(); 
        }
        function clearInProgressState() { localStorage.removeItem(IN_PROGRESS_KEY); }
        
        function saveWorkoutToHistory() {
            if (!currentWorkoutType || !workoutStartTime || !originalCompletedWorkoutPlan || originalCompletedWorkoutPlan.length === 0) return;
            const endTime = Date.now(); const durationSeconds = (endTime - workoutStartTime) / 1000;
            const exercisesForHistory = originalCompletedWorkoutPlan.filter(item => item.type.startsWith('exercise')).map(ex => ({ 
                name: ex.name, type: ex.type, 
                reps_target: ex.reps_text || ((ex.duration !== undefined && ex.duration !== null) ? ex.duration : ex.reps), 
                weight_description_target: getFormattedWeight(ex), 
                finalReps: ex.reps, 
                finalDuration: ex.duration, 
                finalWeightDescription: ex.weight_text || getFormattedWeight(ex),
                finalProgressionNote: ex.progression_note, 
            }));
            const historyEntry = { date: new Date().toISOString(), type: currentWorkoutType, durationSeconds: durationSeconds, exercises: exercisesForHistory };
            workoutHistory.push(historyEntry);
        }
        
        function initializeDOMReferences() {
            try {
                timeDisplayDiv = document.getElementById('time-left'); currentExerciseContainer = document.getElementById('current-exercise-container'); progressTracker = document.getElementById('progress-tracker'); startPauseBtn = document.getElementById('start-pause-btn'); skipBtn = document.getElementById('skip-btn'); finishBtn = document.getElementById('finish-btn'); resetBtn = document.getElementById('reset-btn'); prevBtn = document.getElementById('prev-btn'); messageArea = document.getElementById('message-area'); homeSection = document.getElementById('home-section'); workoutSection = document.getElementById('workout-section'); signInButton = document.getElementById('signin-button'); driveStatusElement = document.getElementById('drive-status'); driveStatusTextElement = document.getElementById('drive-status-text'); postWorkoutSummary = document.getElementById('post-workout-summary'); summaryTitle = document.getElementById('summary-title'); summaryItemsList = document.getElementById('summary-items-list'); finishSummaryBtn = document.getElementById('finish-summary-btn'); currentExerciseNameDisplay = document.getElementById('current-exercise-name-display'); driveConnectionStatusMain = document.getElementById('drive-connection-status-main'); driveConnectionText = document.getElementById('drive-connection-text'); timerDisplayElement = document.querySelector('.timer-display'); reactorElement = document.querySelector('.reactor'); exerciseImageContainer = document.getElementById('exercise-image-container'); exerciseImageDisplay = document.getElementById('exercise-image-display'); progressTextArea = document.getElementById('progress-text-area'); editProgramBtn = document.getElementById('edit-program-btn'); timerProgressIndicator = document.getElementById('timer-progress-indicator'); workoutStepTotalDisplay = document.getElementById('workout-step-total-display'); workoutStepCurrentDisplay = document.getElementById('workout-step-current-display'); workoutStepInfoDisplay = document.getElementById('workout-step-info-display'); timerView = document.getElementById('timer-view'); workoutInfoView = document.getElementById('workout-info'); controls = document.querySelector('.controls');
            } catch (e) { document.body.innerHTML = "<p style='color:white; text-align:center; padding-top: 50px;'>Erreur critique chargement. RafraÃ®chissez.</p>"; }
        }

        function addEventListeners() {
            if (startPauseBtn) startPauseBtn.addEventListener('click', () => { initAudioContext(); const item = currentWorkoutPlan[currentItemIndex]; if (currentState === 'idle') { setState('preparing'); } else if (currentState === 'paused') { setState(previousState); } else if (isTimerRunning) { setState('paused'); } else if (currentState === 'exercise' && (item && (item.duration === undefined || item.duration === null))) { handleItemCompletion(); } });
            if (timerDisplayElement) timerDisplayElement.addEventListener('click', () => { initAudioContext(); const item = currentWorkoutPlan[currentItemIndex]; if (isWorkoutActive && currentState === 'exercise' && (item && (item.duration === undefined || item.duration === null))) { handleItemCompletion(); } });
            if (skipBtn) skipBtn.addEventListener('click', () => { initAudioContext(); if (isWorkoutActive) handleItemCompletion(); });
            if (prevBtn) prevBtn.addEventListener('click', () => { initAudioContext(); handlePreviousClick(); });
            if (finishBtn) finishBtn.addEventListener('click', () => { initAudioContext(); forceFinishWorkout(); });
            if (resetBtn) resetBtn.addEventListener('click', () => { initAudioContext(); resetCurrentWorkout(); });
            if (editProgramBtn) editProgramBtn.addEventListener('click', toggleEditMode);
            if (homeSection) homeSection.addEventListener('click', handleHomeInteraction);
            document.querySelectorAll('nav a.nav-link').forEach(link => { link.addEventListener('click', (e) => { initAudioContext(); if (isWorkoutActive) { e.preventDefault(); showMessage("Terminez ou mettez en pause l'entraÃ®nement avant de naviguer.", 3000); } }); });
            if(signInButton) signInButton.addEventListener('click', handleAuthClick);
            if(finishSummaryBtn) finishSummaryBtn.addEventListener('click', finishSummary);
            if(summaryItemsList) summaryItemsList.addEventListener('click', handleSummaryControls);
            document.addEventListener('click', (e) => { if (!e.target.closest('.resistance-selector')) { document.querySelectorAll('.resistance-selector.open').forEach(sel => sel.classList.remove('open')); } });
            document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'hidden' && isWorkoutActive) saveInProgressState(); });
            window.addEventListener('beforeunload', () => { if (isWorkoutActive) saveInProgressState(); });
        }
        
        function handleHomeInteraction(e) {
            const sessionCard = e.target.closest('.session-card-large');
            const detailsBtn = e.target.closest('.toggle-details-btn');
            const calPrevBtn = e.target.closest('.prev-month');
            const calNextBtn = e.target.closest('.next-month');

            if (detailsBtn && sessionCard) {
                e.stopPropagation();
                initAudioContext();
                const isExpanded = sessionCard.classList.toggle('expanded');
                if (isExpanded) {
                    const sessionName = sessionCard.dataset.sessionName;
                    const uniqueExercises = [...new Map(loadedFullProgram.sessions.find(s=>s.nom_session === sessionName).exercices_et_pauses.filter(ex => ex.type.startsWith('exercise')).map(item => [item['name'], item])).values()];
                    uniqueExercises.forEach((ex, idx) => {
                         const detailCanvasId = `detail-chart-${sessionName.replace(/\s+/g, '-')}-${idx}`;
                         const canvasEl = document.getElementById(detailCanvasId);
                         if (canvasEl) renderDetailedExerciseChart(canvasEl, sessionName, ex.name);
                    });
                }
            } else if (sessionCard) {
                initAudioContext();
                const sessionName = sessionCard.dataset.sessionName;
                if (isEditMode) {
                    populateAndShowSummary({ mode: 'edit', sessionName: sessionName });
                } else {
                    loadSession(sessionName);
                    setState('preparing');
                }
            } else if(calPrevBtn) {
                displayedCalendarDate.setMonth(displayedCalendarDate.getMonth() - 1);
                const newModule = renderConsistencyCalendarModule(displayedCalendarDate);
                document.getElementById('consistency-module')?.replaceWith(newModule);
            } else if(calNextBtn) {
                displayedCalendarDate.setMonth(displayedCalendarDate.getMonth() + 1);
                const newModule = renderConsistencyCalendarModule(displayedCalendarDate);
                document.getElementById('consistency-module')?.replaceWith(newModule);
            }
        }
        
        function toggleEditMode() {
            isEditMode = !isEditMode;
            editProgramBtn.classList.toggle('active', isEditMode);
            showMessage(isEditMode ? "Mode Ã©dition activÃ©. Cliquez sur une sÃ©ance pour la modifier." : "Mode Ã©dition dÃ©sactivÃ©.", 3000);
            document.querySelectorAll('.session-card-large').forEach(card => {
                card.classList.toggle('edit-mode-active', isEditMode);
            });
        }

        function handleSummaryControls(e) {
            const stepperBtn = e.target.closest('.stepper-btn');
            const resistanceSelector = e.target.closest('.selected-resistance');
            const resistanceOption = e.target.closest('.resistance-options li');
            const trackingToggleBtn = e.target.closest('.tracking-type-toggle button');

            if (stepperBtn) {
                const control = stepperBtn.closest('.stepper-control');
                const valueEl = control.querySelector('.stepper-value');
                if (!valueEl) return;
                let value = parseFloat(valueEl.textContent);
                const type = control.dataset.type;
                const isPlus = stepperBtn.classList.contains('stepper-plus');
                let step = (type === 'weight') ? 0.5 : 1;

                value = isPlus ? value + step : Math.max(0, value - step);
                valueEl.textContent = (type === 'weight') ? value.toFixed(1).replace(/\.0$/, '') : value;
            } else if (resistanceSelector) {
                const selector = resistanceSelector.closest('.resistance-selector');
                document.querySelectorAll('.resistance-selector.open').forEach(sel => { if(sel !== selector) sel.classList.remove('open'); });
                selector.classList.toggle('open');
            } else if (resistanceOption) {
                const selector = resistanceOption.closest('.resistance-selector');
                const value = resistanceOption.dataset.value;
                selector.dataset.type = value;
                selector.querySelector('.selected-resistance span').textContent = resistanceTypes[value].emoji;
                selector.classList.remove('open');
                const weightStepper = selector.closest('.resistance-controls').querySelector('.resistance-value-stepper');
                weightStepper.style.display = ['poids', 'poids_elastique'].includes(value) ? 'flex' : 'none';
            } else if(trackingToggleBtn) {
                const parent = trackingToggleBtn.parentElement;
                parent.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                trackingToggleBtn.classList.add('active');
                
                const summaryItem = trackingToggleBtn.closest('.summary-item');
                const perfInput = summaryItem.querySelector('.stepper-control[data-type="performance"]');
                if (perfInput) {
                    const label = perfInput.closest('.input-group').querySelector('label');
                    const type = trackingToggleBtn.dataset.value;
                    if(label) label.textContent = `Performance RÃ©alisÃ©e (${type === 'time' ? 'secondes' : 'rÃ©pÃ©titions'})`;
                }
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeDOMReferences(); initSounds(); addEventListeners();
            document.getElementById('current-year').textContent = new Date().getFullYear(); 
            setState('idle'); 
            updateAuthUI(!!googleAccessToken); 
            checkAndInitGis(); 
            console.log("ArmorWorkout InitialisÃ©.");
        });
    </script>
</body>
</html>
