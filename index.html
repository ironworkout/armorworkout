
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArmorWorkout - Électrique</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color-dark: #030712; 
            --secondary-bg-color-dark: #0B132B; 
            --primary-text-color-dark: #F0F4F8; 
            --secondary-text-color-dark: #A0AEC0; 
            --border-color-dark: #1E293B; 
            --electric-blue: #00BFFF; 
            --electric-cyan: #22D3EE; 
            --electric-blue-light: #4D94FF; 
            --glow-accent: #0AF; 
            --electric-blue-rgb: 0, 191, 255;
            --electric-cyan-rgb: 34, 211, 238;
            --glow-accent-rgb: 0, 170, 255;
            --secondary-bg-color-dark-rgb: 11, 19, 43;
            --bg-color-dark-rgb: 3, 7, 18;
            --neon-pink: #FF1493; 
            --neon-purple: #9400D3; 
            --neon-green: #39FF14; 
            --neon-red: #FF3131; 
            --neon-yellow: #FFF01F; 
            --neon-orange: #FFAC1C;
            --neon-pink-rgb: 255, 20, 147;
            --neon-purple-rgb: 148, 0, 211;
            --neon-green-rgb: 57, 255, 20;
            --neon-red-rgb: 255, 49, 49;
            --neon-yellow-rgb: 255, 240, 31;
            --glow-red: 0 0 8px var(--neon-red), 0 0 12px rgba(var(--neon-red-rgb),0.7);
            --glow-green: 0 0 8px var(--neon-green), 0 0 12px rgba(var(--neon-green-rgb),0.7);
            --glow-yellow: 0 0 8px var(--neon-yellow), 0 0 12px rgba(var(--neon-yellow-rgb),0.7);
            --glow-pink: 0 0 8px var(--neon-pink), 0 0 12px rgba(var(--neon-pink-rgb),0.7);
            --glow-purple: 0 0 8px var(--neon-purple), 0 0 12px rgba(var(--neon-purple-rgb),0.7);
            --electric-yellow: var(--neon-yellow); 
            --electric-yellow-rgb: var(--neon-yellow-rgb);
            --exercise-color-val: var(--electric-blue-light);
            --break-color-val: var(--electric-cyan);
            --paused-color-val: #A78BFA; 
            --finished-color-val: var(--neon-green); 
            --preparing-color-val: var(--electric-cyan);
            --idle-color-val: var(--electric-blue);
            --exercise-color-rgb: 77, 148, 255; 
            --break-color-rgb: var(--electric-cyan-rgb);
            --paused-color-rgb: 167, 139, 250;
            --finished-color-rgb: var(--neon-green-rgb); 
            --preparing-color-rgb: var(--electric-cyan-rgb);
            --idle-color-rgb: var(--electric-blue-rgb);
            --color-exercise: var(--exercise-color-val);
            --color-break: var(--break-color-val);
            --color-prepare: var(--preparing-color-val);
            --color-finished: var(--finished-color-val);
            --color-paused: var(--paused-color-val);
            --color-idle: var(--secondary-text-color-dark);
            --font-family-main: 'Inter', sans-serif;
            --font-family-timer: 'Orbitron', sans-serif;
            --font-family-titles: 'Orbitron', sans-serif; 
            --border-radius-lg: 10px;
            --border-radius-md: 8px;
            --border-radius-sm: 6px;
            --transition-speed: 0.3s;
            --section-transition-speed: 0.4s;
            --bg-color: var(--bg-color-dark);
            --secondary-bg-color: var(--secondary-bg-color-dark);
            --primary-text-color: var(--primary-text-color-dark);
            --secondary-text-color: var(--secondary-text-color-dark);
            --border-color: var(--border-color-dark);
            --accent-border-color: rgba(var(--electric-blue-rgb), 0.4); 
            --input-bg: #1A202C; 
            --current-timer-state-color: var(--idle-color-val);
            --current-timer-state-color-rgb: var(--idle-color-rgb);
            --timer-text-color-main: #FFFFFF;
            --timer-text-glow-main: 0 0 5px #fff, 
                                    0 0 8px #fff, 
                                    0 0 12px rgba(var(--electric-cyan-rgb), 0.6), 
                                    0 0 18px rgba(var(--electric-cyan-rgb), 0.4);
            --timer-progress-circle-color: var(--electric-cyan);
        }

        @keyframes subtlePulse { 0%, 100% { opacity: 0.7; transform: scale(1); } 50% { opacity: 1; transform: scale(1.015); } }
        @keyframes electricBorder {
            0% { box-shadow: 0 0 6px rgba(var(--electric-cyan-rgb), 0.6), inset 0 0 4px rgba(var(--electric-cyan-rgb), 0.4); border-color: rgba(var(--electric-cyan-rgb), 0.7); }
            50% { box-shadow: 0 0 18px rgba(var(--electric-blue-rgb), 0.8), inset 0 0 10px rgba(var(--electric-blue-rgb), 0.6); border-color: rgba(var(--electric-blue-rgb), 0.9); }
            100% { box-shadow: 0 0 6px rgba(var(--electric-cyan-rgb), 0.6), inset 0 0 4px rgba(var(--electric-cyan-rgb), 0.4); border-color: rgba(var(--electric-cyan-rgb), 0.7); }
        }
        @keyframes textGlowPulseState {
            0%, 100% { text-shadow: 0 0 5px rgba(var(--current-timer-state-color-rgb), 0.7), 0 0 10px rgba(var(--current-timer-state-color-rgb), 0.5), 0 0 15px rgba(var(--current-timer-state-color-rgb), 0.3); }
            50% { text-shadow: 0 0 8px rgba(var(--current-timer-state-color-rgb), 0.9), 0 0 15px rgba(var(--current-timer-state-color-rgb), 0.7), 0 0 25px rgba(var(--current-timer-state-color-rgb), 0.5); }
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; font-size: 16px; }
        body {
            font-family: var(--font-family-main); background-color: var(--bg-color); color: var(--primary-text-color); line-height: 1.65;
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease; display: flex; flex-direction: column;
            min-height: 100vh; -webkit-font-smoothing: antialiased; overflow-x: hidden;
            background-image: radial-gradient(ellipse at center, rgba(var(--electric-blue-rgb), 0.08) 0%, transparent 60%), linear-gradient(0deg, rgba(var(--bg-color-dark-rgb), 0.5) 0%, rgba(var(--bg-color-dark-rgb), 0.9) 100%);
            position: relative; 
        }
        body::before { 
            content: ""; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-image: linear-gradient(rgba(var(--electric-blue-rgb), 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(var(--electric-blue-rgb), 0.05) 1px, transparent 1px);
            background-size: 30px 30px; z-index: -1; opacity: 0.7;
        }
        
        body.workout-active { overflow: hidden; }
        body.workout-active header { transform: translateY(-100%); opacity: 0; visibility: hidden; transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out, visibility 0s linear 0.4s; }
        body.workout-active footer { display: none; }
        body.workout-active main { position: fixed; inset: 0; padding: 20px 0; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow-y: auto; z-index: 100; }
        body.workout-active .app-section:not(#workout-section) { display: none; }
        body.workout-active #workout-section { margin: auto 0; border: none; background: transparent; box-shadow: none; padding: 0; max-height: 100%; }

        .container { max-width: 1100px; margin: 0 auto; padding: 30px 25px; width: 100%; flex-grow: 1; display: flex; flex-direction: column; }
        
        header {
            padding: 15px 0; background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.5); backdrop-filter: blur(8px) saturate(150%);
            border-bottom: 1px solid rgba(var(--electric-blue-rgb), 0.3); box-shadow: 0 2px 15px rgba(var(--electric-blue-rgb), 0.1);
            position: sticky; top:0; z-index: 1000; 
            transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out, visibility 0s linear 0s; 
        }

        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1100px; margin: 0 auto; padding: 0 25px; flex-wrap: wrap; gap: 15px 20px; }
        header h1 { font-size: 1.6em; color: var(--primary-text-color); margin: 0; font-weight: 700; display: flex; align-items: center; gap: 10px; font-family: var(--font-family-titles); text-shadow: 0 0 8px rgba(var(--electric-cyan-rgb), 0.7); }
        header h1 i { color: var(--electric-cyan); animation: subtlePulse 3s infinite ease-in-out; }
        nav ul { list-style: none; display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; align-items: baseline; }
        nav button {
            background: none; border: none; color: var(--secondary-text-color); font-size: 0.9em; font-weight: 500; padding: 8px 12px;
            cursor: pointer; text-decoration: none; transition: all var(--transition-speed) ease; position: relative;
            border-radius: var(--border-radius-sm); border: 1px solid transparent; display: inline-flex; align-items: center; gap: 6px;
        }
        nav button:hover { color: var(--primary-text-color); background-color: rgba(var(--electric-blue-rgb), 0.1); border-color: rgba(var(--electric-blue-rgb), 0.4); text-shadow: 0 0 5px rgba(var(--electric-blue-rgb), 0.5); }
        nav button.active { color: var(--electric-cyan); font-weight: 600; background-color: rgba(var(--electric-cyan-rgb), 0.15); border-color: var(--electric-cyan); box-shadow: 0 0 10px rgba(var(--electric-cyan-rgb), 0.3); }
        #nav-history.active, #nav-editor.active { border-color: var(--neon-pink); background-color: rgba(var(--neon-pink-rgb),0.15); color: var(--neon-pink); }
        nav button:disabled { color: rgba(156, 163, 175, 0.4); cursor: not-allowed; background-color: transparent !important; border-color: transparent !important; opacity: 0.6; pointer-events: none; }
        nav button i { margin-right: 5px; }

        .header-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        #drive-status-text, #signin-button {
            background-color: transparent; border: 1px solid var(--border-color-dark); color: var(--secondary-text-color-dark);
            padding: 5px 12px; border-radius: var(--border-radius-md); font-size: 0.9em; font-weight: 500; cursor: pointer;
            transition: all var(--transition-speed) ease; display: inline-flex; align-items: center; gap: 5px;
        }
        #signin-button:disabled { opacity: 0.5; cursor: not-allowed; border-color: var(--border-color-dark) !important; color: var(--secondary-text-color-dark) !important; background-color: transparent !important; box-shadow: none !important; text-shadow: none !important; pointer-events: auto; }
        #drive-status-text:hover, #signin-button:not(:disabled):hover { border-color: var(--electric-blue); color: var(--electric-blue); background-color: rgba(var(--electric-blue-rgb), 0.1); }
        #drive-status.success #drive-status-text { border-color: var(--neon-green); color: var(--neon-green); cursor: default; }
        #drive-status.loading #drive-status-text { border-color: var(--neon-yellow); color: var(--neon-yellow); }
        #drive-status.error #drive-status-text { border-color: var(--neon-red); color: var(--neon-red); }
        #signin-button { border-color: var(--neon-green); color: var(--neon-green); }
        #drive-status { display: inline-flex; align-items: center; gap: 10px; margin-left: 10px; padding: 0; background: none; border: none; font-size: 1em; color: inherit; }
        body.logged-out #signin-button { display: inline-flex; } body.logged-out #drive-status { display: none; }
        body.logged-in #signin-button { display: none; } body.logged-in #drive-status { display: inline-flex; }
        
        main { flex-grow: 1; display: flex; flex-direction: column; align-items: center; padding-top: 40px; }
        
        .app-section {
            background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.6); backdrop-filter: blur(10px) saturate(130%); padding: 25px;
            border: 1px solid rgba(var(--electric-blue-rgb), 0.2); width: 100%; margin-bottom: 40px;
            transition: opacity var(--section-transition-speed) ease-in-out, transform 0.3s ease-in-out;
            border-radius: var(--border-radius-lg);
            box-shadow: 0 5px 25px rgba(var(--bg-color-dark-rgb), 0.5), inset 0 0 15px rgba(var(--electric-blue-rgb), 0.1);
        }
        .workout-section { max-width: 650px; text-align: center; }
        .history-section, .editor-section { max-width: 900px; text-align: left; }
        .section-hidden { display: none !important; }
        .app-section h2 { font-size: 1.8em; font-weight: 700; margin-bottom: 25px; text-align: center; color: var(--primary-text-color); display: flex; align-items: center; gap: 12px; justify-content: center; font-family: var(--font-family-titles); text-shadow: 0 0 8px rgba(var(--electric-cyan-rgb), 0.7); }
        .app-section h2 i { color: var(--electric-cyan); animation: subtlePulse 3s infinite ease-in-out; }
        
        /* == STYLES DU TIMER == */
        .timer-and-image-wrapper { display: flex; flex-direction: column; align-items: center; gap: 20px; margin-bottom: 25px; }
        .exercise-image-area { width: 100%; max-width: 260px; margin: 0 auto; padding: 8px; background-color: rgba(var(--secondary-bg-color-dark-rgb),0.4); border: 1px solid rgba(var(--electric-cyan-rgb), 0.3); border-radius: var(--border-radius-md); display: none; justify-content: center; align-items: center; box-shadow: 0 4px 12px rgba(var(--bg-color-dark-rgb), 0.4), inset 0 0 8px rgba(var(--electric-cyan-rgb),0.2); z-index: 5; transition: opacity 0.4s ease-in-out, transform 0.3s ease-in-out; opacity: 0; transform: scale(0.95) translateY(10px); }
        .exercise-image-area.visible { display: flex; opacity: 1; transform: scale(1) translateY(0); }
        #exercise-image-display { display: block; max-width: 100%; max-height: 200px; object-fit: contain; border-radius: var(--border-radius-sm); filter: brightness(0.8) contrast(1.1); }
        .timer-display { position: relative; display: flex; justify-content: center; align-items: center; width: 280px; height: 280px; margin: 0 auto; cursor: pointer; user-select: none; -webkit-tap-highlight-color: transparent; }
        .timer-progress-circle-container { position: absolute; top: 50%; left: 50%; width: 230px; height: 230px; transform: translate(-50%, -50%); pointer-events: none; }
        .timer-progress-circle { fill: none; stroke: var(--timer-progress-circle-color); stroke-width: 6; stroke-linecap: round; transform-origin: center; transform: rotate(-90deg); transition: stroke-dashoffset 0.3s linear, stroke 0.3s ease; }
        .timer-progress-circle-bg { fill: none; stroke: rgba(var(--electric-blue-rgb), 0.15); stroke-width: 6; }
        .timer-step-info-display { position: absolute; top: 15px; left: 0; right: 0; padding: 0 20px; display: flex; justify-content: space-between; font-family: var(--font-family-timer); font-size: 0.8em; color: var(--secondary-text-color); opacity: 0; transition: opacity var(--transition-speed) ease; pointer-events: none; z-index: 15; }
        .timer-step-info-display.visible { opacity: 0.8; }
        #workout-step-current-display, #workout-step-total-display { padding: 3px 8px; background-color: rgba(var(--bg-color-dark-rgb), 0.6); border-radius: var(--border-radius-sm); text-shadow: 0 0 4px rgba(var(--electric-cyan-rgb), 0.6); border: 1px solid rgba(var(--electric-cyan-rgb), 0.2); }
        .reactor { position: relative; width: 180px; height: 180px; display: flex; align-items: center; justify-content: center; border-radius: 50%; overflow: hidden; z-index: 10; background-color: transparent; }
        .reactor::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(var(--bg-color-dark-rgb), 0.3); z-index: 1; border-radius: 50%; }
        .triangle { z-index: 5; position: absolute; top: 66%; left: 50%; transform: translate(-50%, -50%); width: 155px; aspect-ratio: 1; background-color: var(--electric-cyan); -webkit-clip-path: polygon(50% 88%, 0 0, 100% 0); clip-path: polygon(50% 88%, 0 0, 100% 0); transition: transform 0.5s ease-out, background-color var(--transition-speed) ease; }
        .triangle::after { content: ''; display: block; position: absolute; top: 45%; left: 50%; z-index: 6; width: 120px; height: 120px; transform: translate(-50%, -50%); background-color: var(--bg-color); -webkit-clip-path: polygon(50% 90%, 0 0, 100% 0); clip-path: polygon(50% 90%, 0 0, 100% 0); transition: background-color var(--transition-speed) ease; }
        @keyframes rotate-right { to { transform: rotate(360deg); } } @keyframes rotate-left { to { transform: rotate(-360deg); } }
        @keyframes rotate-left-right { 0% { transform: translate(-50%, -50%) rotate(0deg); } 50% { transform: translate(-50%, -50%) rotate(-180deg); } 100% { transform: translate(-50%, -50%) rotate(0deg); } }
        .circle-1 { z-index: 2; position: absolute; width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(rgba(var(--electric-cyan-rgb), 0.8), rgba(var(--electric-blue-rgb), 0.8)); animation: rotate-right 2s linear infinite; }
        .circle-1::before { content: ''; position: absolute; z-index: 1; inset: 10px; border-radius: 50%; background-color: var(--bg-color); transition: background-color var(--transition-speed) ease; }
        .circle-1 span { position: absolute; width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(rgba(var(--electric-cyan-rgb), 0.8), rgba(var(--electric-blue-rgb), 0.8)); top:0; left: 0; }
        .circle-1 span:nth-child(1) { filter: blur(15px); } .circle-1 span:nth-child(2) { filter: blur(15px); } .circle-1 span:nth-child(3) { filter: blur(15px); } .circle-1 span:nth-child(4) { filter: blur(75px); }
        .circle-2 { z-index: 4; position: absolute; top: 30px; left: 30px; width: calc(100% - 60px); height: calc(100% - 60px); border-radius: 50%; border: 10px solid var(--electric-cyan); box-shadow: 0 0 30px 30px rgba(var(--electric-cyan-rgb), 0.2); animation: rotate-left 4s linear infinite; transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease; }
        .circle-2 span { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: calc(100% + 20px); height: 10px; background-color: var(--bg-color); transition: background-color var(--transition-speed) ease; }
        .circle-2 span:nth-child(1) { transform: translate(-50%, -50%) rotate(90deg); } .circle-2 span:nth-child(2) { transform: translate(-50%, -50%) rotate(45deg); } .circle-2 span:nth-child(3) { transform: translate(-50%, -50%) rotate(-45deg); }
        .circle-2 span:nth-child(4) { transform: translate(-50%, -50%) rotate(30deg); } .circle-2 span:nth-child(5) { transform: translate(-50%, -50%) rotate(-30deg); } .circle-2 span:nth-child(6) { transform: translate(-50%, -50%) rotate(0deg); }
        .circle-2 span:nth-child(7) { transform: translate(-50%, -50%) rotate(55deg); height: 5px; } .circle-2 span:nth-child(8) { transform: translate(-50%, -50%) rotate(125deg); height: 5px; }
        .circle-3 { z-index: 7; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: 50%; box-shadow: 0 0 10px 10px rgba(var(--electric-cyan-rgb), 0.2); transition: box-shadow var(--transition-speed) ease; }
        .circle-3::after { content: ''; display: block; width: 115px; height: 115px; border-radius: 50%; border: 3px dotted rgba(var(--electric-cyan-rgb), 0.8); animation: rotate-right 10s linear infinite; transition: border-color var(--transition-speed) ease; }
        .circle-4 { z-index: 8; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100px; height: 100px; border-radius: 50%; box-shadow: 0 0 10px 10px rgba(var(--electric-cyan-rgb), 0.1); animation: rotate-left-right 20s infinite ease-in; transition: box-shadow var(--transition-speed) ease; }
        .circle-4 span { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; height: 100%; border-radius: 50%; border: 3px solid; border-color: var(--electric-cyan) transparent transparent; transition: border-color var(--transition-speed) ease; }
        .circle-4 span:nth-child(1) { transform: translate(-50%, -50%) rotate(45deg); } .circle-4 span:nth-child(2) { transform: translate(-50%, -50%) rotate(-75deg); } .circle-4 span:nth-child(3) { transform: translate(-50%, -50%) rotate(165deg); }
        .circle-5 { z-index: 9; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 64px; height: 64px; border-radius: 50%; animation: rotate-left-right 10s infinite ease-in; background-color: rgba(var(--electric-cyan-rgb), 0.2); box-shadow: 0 0 20px 20px rgba(var(--electric-cyan-rgb), 0.2); transition: background-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease, opacity 0.3s ease; }
        .circle-5 span { position: absolute; inset: 0; z-index: 10; width: 54px; height: 54px; border-radius: 50%; border: 5px solid; border-color: var(--electric-cyan) transparent transparent; margin: auto; transition: border-color var(--transition-speed) ease; }
        .circle-5 span:nth-child(1) { transform: rotate(0deg); } .circle-5 span:nth-child(2) { transform: rotate(120deg); } .circle-5 span:nth-child(3) { transform: rotate(240deg); }
        .circle-6 { z-index: 11; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .circle-6::after { content: ''; display: block; width: 40px; height: 40px; border-radius: 50%; border: 3px dashed var(--electric-cyan); animation: rotate-left 5s infinite ease-in; transition: border-color var(--transition-speed) ease; }
        .circle-7 { z-index: 12; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .circle-7::after { content: ''; display: block; width: 27px; height: 27px; border-radius: 50%; background-color: var(--electric-cyan); animation: rotate-left 5s infinite ease-in; box-shadow: 0 0 5px 5px rgba(var(--electric-cyan-rgb), 0.2); transition: box-shadow var(--transition-speed) ease, transform 0.3s ease, background-color var(--transition-speed) ease; }
        .circle-8 { z-index: 13; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 15px; height: 15px; border-radius: 50%; animation: rotate-left-right 5s infinite ease-in; }
        .circle-8 span { position: absolute; inset: 0; z-index: 14; width: 13px; height: 13px; border-radius: 50%; border: 1px solid; border-color: var(--bg-color) transparent transparent; margin: auto; transition: border-color var(--transition-speed) ease; }
        .circle-8 span:nth-child(1) { transform: rotate(120deg); } .circle-8 span:nth-child(2) { transform: rotate(240deg); }
        @keyframes pulsePausedGlow { 0%, 100% { box-shadow: 0 0 5px 5px rgba(var(--paused-color-rgb), 0.2); transform: scale(1); } 50% { box-shadow: 0 0 10px 10px rgba(var(--paused-color-rgb), 0.4); transform: scale(1.1); } }
        @keyframes pulsePausedRing { 0%, 100% { box-shadow: 0 0 20px 20px rgba(var(--paused-color-rgb), 0.2); opacity: 1; } 50% { box-shadow: 0 0 25px 25px rgba(var(--paused-color-rgb), 0.3); opacity: 0.8; } }
        .state-paused .circle-7::after { background-color: var(--paused-color-val); animation: pulsePausedGlow 1.5s infinite ease-in-out; }
        .state-paused .circle-5 { animation: pulsePausedRing 1.5s infinite ease-in-out; background-color: rgba(var(--paused-color-rgb), 0.3); }
        .state-paused .circle-1, .state-paused .circle-1 span { background: linear-gradient(rgba(var(--paused-color-rgb), 0.8), rgba(var(--paused-color-rgb),0.5));}
        .state-paused .circle-2 { border-color: var(--paused-color-val); box-shadow: 0 0 30px 30px rgba(var(--paused-color-rgb), 0.2); }
        .state-paused .circle-3::after { border-color: rgba(var(--paused-color-rgb), 0.8); }
        .state-paused .circle-4 span { border-color: var(--paused-color-val) transparent transparent; } .state-paused .circle-5 span { border-color: var(--paused-color-val) transparent transparent; }
        .state-paused .circle-6::after { border-color: var(--paused-color-val); } .state-paused .triangle { background-color: var(--paused-color-val); }
        .state-paused .timer-progress-circle { stroke: var(--paused-color-val); }
        @keyframes rotateSpinOnce { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }
        .state-preparing .triangle { animation: rotateSpinOnce 5s linear infinite; background-color: var(--preparing-color-val); }
        .state-preparing .circle-1, .state-preparing .circle-1 span { background: linear-gradient(rgba(var(--preparing-color-rgb), 0.8), rgba(var(--preparing-color-rgb),0.5));}
        .state-preparing .circle-2 { border-color: var(--preparing-color-val); box-shadow: 0 0 30px 30px rgba(var(--preparing-color-rgb), 0.2); }
        .state-preparing .circle-3::after { border-color: rgba(var(--preparing-color-rgb), 0.8); }
        .state-preparing .circle-4 span { border-color: var(--preparing-color-val) transparent transparent; }
        .state-preparing .circle-5 { background-color: rgba(var(--preparing-color-rgb),0.2); box-shadow: 0 0 20px 20px rgba(var(--preparing-color-rgb),0.2);}
        .state-preparing .circle-5 span { border-color: var(--preparing-color-val) transparent transparent; }
        .state-preparing .circle-6::after { border-color: var(--preparing-color-val); }
        .state-preparing .circle-7::after { background-color: var(--preparing-color-val); box-shadow: 0 0 5px 5px rgba(var(--preparing-color-rgb),0.2); }
        .state-preparing .timer-progress-circle { stroke: var(--preparing-color-val); }
        .triangle.spin-transition { animation: rotateSpinOnce 0.6s ease-out forwards; }
        #time-left {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 20; 
            font-family: var(--font-family-timer); font-size: 3.6em; font-weight: 700;
            color: var(--timer-text-color-main); text-shadow: var(--timer-text-glow-main); 
            transition: font-size 0.2s ease; pointer-events: none; white-space: nowrap; 
        }
        #timer-state { display: none !important; } 

        @keyframes countdown-pulse { 0%, 100% { opacity: 0.7; transform: scale(1) translateX(-50%); } 50% { opacity: 1; transform: scale(1.05) translateX(-50%); } }
        .state-exercise #time-left { font-size: 4em; letter-spacing: 0.05em; }
        .state-exercise .triangle { background-color: var(--exercise-color-val); }
        .state-exercise .circle-1, .state-exercise .circle-1 span { background: linear-gradient(rgba(var(--exercise-color-rgb), 0.8), rgba(var(--exercise-color-rgb),0.5));}
        .state-exercise .circle-2 { border-color: var(--exercise-color-val); box-shadow: 0 0 30px 30px rgba(var(--exercise-color-rgb), 0.2); }
        .state-exercise .circle-3::after { border-color: rgba(var(--exercise-color-rgb), 0.8); }
        .state-exercise .circle-4 span { border-color: var(--exercise-color-val) transparent transparent; }
        .state-exercise .circle-5 { background-color: rgba(var(--exercise-color-rgb),0.2); box-shadow: 0 0 20px 20px rgba(var(--exercise-color-rgb),0.2);}
        .state-exercise .circle-5 span { border-color: var(--exercise-color-val) transparent transparent; }
        .state-exercise .circle-6::after { border-color: var(--exercise-color-val); }
        .state-exercise .circle-7::after { background-color: var(--exercise-color-val); box-shadow: 0 0 5px 5px rgba(var(--exercise-color-rgb),0.2); }
        .state-exercise .timer-progress-circle { stroke: var(--exercise-color-val); } 
        .state-break .triangle { background-color: var(--break-color-val); }
        .state-break .circle-1, .state-break .circle-1 span { background: linear-gradient(rgba(var(--break-color-rgb), 0.8), rgba(var(--break-color-rgb),0.5));}
        .state-break .circle-2 { border-color: var(--break-color-val); box-shadow: 0 0 30px 30px rgba(var(--break-color-rgb), 0.2); }
        .state-break .circle-3::after { border-color: rgba(var(--break-color-rgb), 0.8); }
        .state-break .circle-4 span { border-color: var(--break-color-val) transparent transparent; }
        .state-break .circle-5 { background-color: rgba(var(--break-color-rgb),0.2); box-shadow: 0 0 20px 20px rgba(var(--break-color-rgb),0.2);}
        .state-break .circle-5 span { border-color: var(--break-color-val) transparent transparent; }
        .state-break .circle-6::after { border-color: var(--break-color-val); }
        .state-break .circle-7::after { background-color: var(--break-color-val); box-shadow: 0 0 5px 5px rgba(var(--break-color-rgb),0.2); }
        .state-break .timer-progress-circle { stroke: var(--break-color-val); }
        .state-finished .triangle { background-color: var(--finished-color-val); }
        .state-finished .circle-1, .state-finished .circle-1 span { background: linear-gradient(rgba(var(--finished-color-rgb), 0.8), rgba(var(--finished-color-rgb),0.5));}
        .state-finished .circle-2 { border-color: var(--finished-color-val); box-shadow: 0 0 30px 30px rgba(var(--finished-color-rgb), 0.2); }
        .state-finished .circle-3::after { border-color: rgba(var(--finished-color-rgb), 0.8); }
        .state-finished .circle-4 span { border-color: var(--finished-color-val) transparent transparent; }
        .state-finished .circle-5 { background-color: rgba(var(--finished-color-rgb),0.2); box-shadow: 0 0 20px 20px rgba(var(--finished-color-rgb),0.2);}
        .state-finished .circle-5 span { border-color: var(--finished-color-val) transparent transparent; }
        .state-finished .circle-6::after { border-color: var(--finished-color-val); }
        .state-finished .circle-7::after { background-color: var(--finished-color-val); box-shadow: 0 0 5px 5px rgba(var(--finished-color-rgb),0.2); }
        .state-finished .timer-progress-circle { stroke: var(--finished-color-val); }
        
        .workout-info { margin-bottom: 20px; min-height: auto; position: relative; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        #current-exercise-name-display { display: block; font-size: 1.3em; font-weight: 600; color: var(--primary-text-color); margin-bottom: 8px; padding: 0 10px; line-height: 1.3; text-shadow: none; }
        body.state-exercise #current-exercise-name-display, body.state-break #current-exercise-name-display { animation: textGlowPulseState 2s infinite ease-in-out; }
        body.state-exercise #current-exercise-name-display { color: var(--color-exercise); } 
        body.state-break #current-exercise-name-display, body.state-preparing #current-exercise-name-display { color: var(--color-break); }
        
        #current-exercise-container { display: flex; flex-direction: column; align-items: center; gap: 10px; font-size: 1em; color: var(--secondary-text-color); min-height: auto; width: 100%; }
        .workout-prompt { display: inline-flex; align-items: center; gap: 10px; border: 1px dashed rgba(var(--electric-blue-rgb), 0.3); padding: 12px 22px; border-radius: var(--border-radius-md); color: var(--secondary-text-color-dark); font-size: 0.95em; margin-top: 0; cursor: default; background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.2); box-shadow: inset 0 0 8px rgba(var(--electric-blue-rgb),0.1); }
        .workout-prompt i { color: var(--electric-blue); font-size: 1.1em; }
        
        .exercise-details, .break-info {
            display: flex; flex-direction: column; flex-wrap: nowrap; justify-content: center; align-items: center; gap: 8px; 
            background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.5); padding: 12px 15px; border-radius: var(--border-radius-sm);
            border: 1px solid rgba(var(--accent-border-color), 0.5); width: fit-content; max-width: 95%; 
            box-shadow: 0 2px 5px rgba(var(--bg-color-dark-rgb),0.2);
        }
        .exercise-details .main-stats { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px 20px; font-size: 1.1em; font-weight: 500; color: var(--primary-text-color); margin-bottom: 5px;}
        .exercise-details .main-stats span { display: flex; align-items: center; gap: 8px; }
        .exercise-details .main-stats i { color: var(--color-exercise); opacity: 0.9; }
        .sets-info-text, .details-text { font-size: 0.8em; color: var(--secondary-text-color); opacity: 0.85; text-align: center; width: 100%; letter-spacing: 0.02em; padding: 0 5px; line-height: 1.4; }
        .sets-info-text i { color: var(--electric-cyan); margin-right: 5px; } 
        .details-text i { color: var(--electric-yellow); margin-right: 5px; } 
        
        .break-info { font-size: 1em; }
        .break-info > i { font-size: 1.2em; margin-bottom: 3px;} 
        .break-info > span { font-weight: 500; color: var(--primary-text-color); } 
        
        .next-exercise-preview {
            font-size: 0.85em; color: var(--secondary-text-color); margin-top: 10px; padding: 12px 15px;
            border: 1px dashed; border-radius: var(--border-radius-sm);
            background-color: rgba(var(--bg-color-dark-rgb), 0.2);
            display: flex; flex-direction: column; align-items: center; gap: 8px; text-align: center;
            width: fit-content; max-width: 95%;
        }
        .next-exercise-preview > i { opacity: 0.8; margin-bottom: 2px; font-size: 1.1em; }
        .next-exercise-preview strong { color: var(--primary-text-color); font-weight: 600; display: block; font-size: 1.1em;}
        .next-exercise-preview .next-details-grid {
            display: flex; flex-wrap: wrap; justify-content: center; align-items: center;
            gap: 8px 18px;
            font-size: 0.95em; color: var(--primary-text-color);
        }
        .next-exercise-preview .next-details-grid span {
            display: inline-flex; align-items: center; gap: 6px; font-weight: 500;
        }
        .next-exercise-preview .next-details-grid i {
            color: var(--electric-cyan); opacity: 0.8;
        }
        
        .controls { display: flex; justify-content: center; gap: 8px; margin-top: 20px; flex-wrap: wrap; }
        .controls button {
            background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.4); border: 1px solid var(--border-color); color: var(--secondary-text-color);
            padding: 8px 14px; border-radius: var(--border-radius-md); font-size: 0.9em; font-weight: 500; cursor: pointer;
            transition: all var(--transition-speed) ease; display: inline-flex; align-items: center; justify-content: center;
            gap: 6px; min-width: 100px; box-shadow: 0 2px 5px rgba(var(--bg-color-dark-rgb),0.3);
        }
        .controls button:disabled {
            opacity: 0.5; cursor: not-allowed; background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.2); border-color: var(--border-color-dark);
            color: var(--secondary-text-color-dark); box-shadow: none !important; transform: none !important; text-shadow: none !important; pointer-events: auto; 
        }
        .controls button:not(:disabled):hover {
            border-color: var(--electric-blue); color: var(--electric-blue); background-color: rgba(var(--electric-blue-rgb), 0.15);
            box-shadow: 0 0 10px rgba(var(--electric-blue-rgb), 0.3), inset 0 0 5px rgba(var(--electric-blue-rgb),0.1); transform: translateY(-1px);
        }
        .controls button i { font-size: 1em; margin-right: 4px; opacity: 0.8; transition: opacity var(--transition-speed) ease; }
        .controls button:not(:disabled):hover i { opacity: 1; }
        #start-pause-btn:not(:disabled) { animation: electricBorder 3s infinite linear; border-color: var(--electric-cyan); }
        #start-pause-btn:not(:disabled):hover { animation-play-state: paused; }
        .progress-tracker {
            font-size: 0.85em; color: var(--secondary-text-color-dark); margin-top: 15px; opacity: 0.7; font-weight: 500;
            display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 8px 15px; min-height: 1.2em; 
        }
        #drive-connection-status-main { display: inline-flex; align-items: center; gap: 6px; color: var(--neon-green); font-weight: 500; transition: color 0.3s ease; }
        #drive-connection-status-main i.fa-google-drive { display: inline-block; font-size: 1.1em; }
        #drive-connection-status-main.error { color: var(--neon-red); } #drive-connection-status-main.loading { color: var(--neon-yellow); }
        #progress-text-area { font-weight: 500; letter-spacing: 0.05em; }
        .nav-buttons-timer { display: flex; justify-content: center; gap: 10px; margin: 20px 0; }
        .nav-buttons-timer button { padding: 8px 12px; font-size: 0.9em; }
        
        /* == STYLES DE L'HISTORIQUE == */
        .history-controls { padding-bottom: 20px; margin-bottom: 25px; border-bottom: 1px solid var(--border-color-dark); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .history-filters { display: flex; gap: 10px; flex-wrap: wrap; }
        .history-filters button.active { border-color: var(--electric-cyan); color: var(--electric-cyan); background-color: rgba(var(--electric-cyan-rgb), 0.1); box-shadow: 0 0 8px rgba(var(--electric-cyan-rgb),0.4); text-shadow: 0 0 5px var(--electric-cyan); }
        .history-actions { display: flex; gap: 15px; align-items: center; color: var(--secondary-text-color-dark); }
        #history-drive-status { font-size: 0.8em; padding: 3px 6px; background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.5); border-radius: var(--border-radius-sm); border: 1px solid var(--border-color-dark); transition: color 0.3s ease, border-color 0.3s ease; }
        #history-drive-status.syncing { color: var(--neon-yellow); border-color: var(--neon-yellow); }
        #history-drive-status.error { color: var(--neon-red); border-color: var(--neon-red); }
        #history-drive-status.success { color: var(--neon-green); border-color: var(--neon-green); }
        .chart-container { position: relative; width: 100%; height: 300px; margin-bottom: 25px; background-color: rgba(var(--bg-color-dark-rgb), 0.3); border: 1px solid var(--border-color-dark); border-radius: var(--border-radius-md); padding: 15px; }
        .chart-placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--secondary-text-color-dark); font-style: italic; text-align: center; padding: 0 10px; transition: opacity 0.3s ease; }
        #history-chart-canvas { display: block; width: 100% !important; height: 100% !important; transition: opacity 0.3s ease; }
        .stats-display { margin-bottom: 25px; padding: 20px; background-color: rgba(var(--bg-color-dark-rgb), 0.3); border: 1px solid var(--border-color-dark); border-radius: var(--border-radius-md); }
        .stats-display h3 { color: var(--primary-text-color); font-size: 1.15em; margin-bottom: 15px; }
        .stats-display .content-wrapper p { margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .stats-display .content-wrapper p i { width: 16px; text-align: center; color: var(--electric-cyan); opacity: 0.8; }
        .stats-display .content-wrapper p strong { color: var(--primary-text-color); font-weight: 500; }
        .stats-display .motivational-message { background: linear-gradient(90deg, var(--neon-green), var(--electric-cyan)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; color: transparent; font-weight: 500; }
        .history-list { list-style: none; border: 1px solid var(--border-color-dark); border-radius: var(--border-radius-md); background-color: transparent; box-shadow: none; max-height: 400px; overflow-y: auto; transition: border-color var(--transition-speed) ease; }
        .history-list li { display: grid; grid-template-columns: auto 1fr auto auto; align-items: center; padding: 12px 15px; border-bottom: 1px solid var(--border-color-dark); transition: background-color 0.2s ease, border-color var(--transition-speed) ease; gap: 10px 15px; }
        .history-list li:last-child { border-bottom: none; } .history-list li:nth-child(even) { background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.2); }
        .history-list li:hover { background-color: rgba(var(--electric-cyan-rgb), 0.05); }
        .history-item-date { color: var(--primary-text-color); font-size: 0.9em; grid-column: 1 / 2; }
        .history-item-date small { color: var(--secondary-text-color); font-size: 0.9em;}
        .history-item-type { color: var(--neon-pink); background-color: rgba(var(--neon-pink-rgb), 0.1); border-radius: var(--border-radius-sm); padding: 3px 8px; font-size: 0.85em; font-weight: 500; text-align: center; grid-column: 2 / 3; justify-self: start; }
        .history-item-reps { color: var(--neon-purple); font-weight: 500; font-size: 0.9em; grid-column: 3 / 4; justify-self: end; }
        .history-item-reps i { margin-right: 4px; }
        .history-item-duration { color: var(--electric-blue); font-weight: 500; font-variant-numeric: tabular-nums; grid-column: 4 / 5; justify-self: end; }
        .history-list .no-history { grid-column: 1 / -1; color: var(--secondary-text-color); text-align: center; padding: 30px 15px; font-style: italic; border: none; background: none !important; }
        
        /* == STYLES DE L'ÉDITEUR == */
        .editor-section { padding-top: 0; }
        #connection-prompt { text-align: center; padding: 40px 20px; background-color: var(--secondary-bg-color); border-radius: var(--border-radius-lg); border: 1px dashed var(--border-color); margin: 20px auto; max-width: 600px; }
        #connection-prompt p { margin-bottom: 15px; color: var(--secondary-text-color); }
        #connection-prompt button { padding: 8px 18px; border: 1px solid var(--neon-green); font-size: 0.9em; }
        
        .program-tabs { display: flex; gap: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; flex-wrap: wrap; margin-bottom: 20px;}
        .program-tabs button.is-dirty::after { content: '●'; position: absolute; top: 5px; right: 8px; font-size: 0.7em; color: var(--neon-orange); animation: blink-dot 1.5s infinite ease-in-out; }
        @keyframes blink-dot { 50% { opacity: 0.3; } }

        #program-display { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 15px; min-height: 200px; background-color: rgba(var(--bg-color-dark-rgb), 0.15); border: 1px dashed var(--border-color); border-radius: var(--border-radius-md); padding: 15px; }
        #program-display:empty::before { content: "Sélectionnez une session (Push/Pull/Legs) pour voir ou modifier ses étapes."; display: block; text-align: center; padding: 50px 20px; color: var(--secondary-text-color); font-style: italic; }

        .program-step { background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: var(--border-radius-md); padding: 15px; display: grid; grid-template-columns: auto 1fr auto; gap: 10px 15px; align-items: start; position: relative; transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease; cursor: grab; }
        .program-step:hover { border-color: var(--accent-border-color); box-shadow: 0 2px 8px rgba(var(--bg-color-dark-rgb),0.3); }
        .step-icon { font-size: 1.3em; padding-top: 5px; grid-column: 1 / 2; align-self: center; transition: color var(--transition-speed) ease; }
        .break-step .step-icon { color: var(--neon-yellow); }
        
        .step-content { grid-column: 2 / 3; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; }
        .step-field { display: flex; flex-direction: column; gap: 4px; }
        .step-field label { font-size: 0.8em; font-weight: 500; color: var(--secondary-text-color); }
        .step-field input, .step-field textarea, .step-field select { width: 100%; padding: 8px 10px; font-size: 0.9em; border-radius: var(--border-radius-sm); border: 1px solid var(--border-color); background-color: var(--input-bg); color: var(--primary-text-color); transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease; }
        .step-field input:focus, .step-field textarea:focus, .step-field select:focus { border-color: var(--electric-cyan); outline: none; box-shadow: 0 0 0 2px rgba(var(--electric-cyan-rgb), 0.3); }
        .step-field textarea { min-height: 60px; resize: vertical; font-family: inherit;}
        .step-field input[type="number"] { -moz-appearance: textfield; width: 80px; }
        .step-field input[type="number"]::-webkit-outer-spin-button, .step-field input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .step-field select { appearance: none; -webkit-appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23A0AEC0'%3E%3Cpath fill-rule='evenodd' d='M4.22 6.22a.75.75 0 011.06 0L8 8.94l2.72-2.72a.75.75 0 111.06 1.06l-3.25 3.25a.75.75 0 01-1.06 0L4.22 7.28a.75.75 0 010-1.06z' clip-rule='evenodd'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 8px center; background-size: 16px 16px; padding-right: 30px; }
        .step-field option { background-color: var(--secondary-bg-color); color: var(--primary-text-color); }
        
        .color-palette { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; grid-column: 1 / -1; }
        .color-swatch { width: 22px; height: 22px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s ease, border-color 0.2s ease; }
        .color-swatch:hover { transform: scale(1.1); }
        .color-swatch.active { border-color: var(--primary-text-color); box-shadow: 0 0 0 2px var(--accent-border-color); transform: scale(1.15); }

        .step-actions { grid-column: 3 / 4; display: flex; flex-direction: column; gap: 8px; align-items: center; padding-top: 5px; }
        .step-actions button { background: none; border: none; color: var(--secondary-text-color); font-size: 1.1em; cursor: pointer; padding: 5px; transition: color var(--transition-speed) ease; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .step-actions button:hover { color: var(--primary-text-color); background-color: rgba(var(--secondary-text-color), 0.1); }
        .step-actions .delete-step-btn:hover { color: var(--neon-red); background-color: rgba(var(--neon-red-rgb), 0.1); }

        .program-step.sortable-ghost { opacity: 0.4; background-color: rgba(var(--electric-blue-rgb), 0.1); border-style: dashed; }
        .program-step.sortable-chosen { cursor: grabbing; border-color: var(--electric-cyan); box-shadow: 0 4px 12px rgba(var(--electric-cyan-rgb), 0.3); }

        .editor-actions { display: flex; justify-content: space-between; align-items: center; gap: 15px; flex-wrap: wrap; }
        .add-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .editor-actions button { padding: 9px 20px; font-size: 0.95em; font-weight: 500; border-radius: var(--border-radius-md); cursor: pointer; transition: all var(--transition-speed) ease; display: inline-flex; align-items: center; gap: 8px; border: 1px solid transparent; }
        .editor-actions button:disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; }
        #add-exercise-btn { border-color: var(--neon-pink); color: var(--neon-pink); background: transparent; }
        #add-exercise-btn:not(:disabled):hover { background-color: rgba(var(--neon-pink-rgb), 0.1); box-shadow: var(--glow-pink); }
        #add-break-btn { border-color: var(--neon-yellow); color: var(--neon-yellow); background: transparent; }
        #add-break-btn:not(:disabled):hover { background-color: rgba(var(--neon-yellow-rgb), 0.1); box-shadow: var(--glow-yellow); }
        #save-program-btn { border: none; background-color: var(--neon-green); color: #030712; box-shadow: 0 2px 5px rgba(0,0,0,0.2); } 
        #save-program-btn:not(:disabled):hover { filter: brightness(1.1); box-shadow: 0 4px 10px rgba(0,0,0,0.25), var(--glow-green); }
        #save-program-btn:disabled { background-color: var(--secondary-text-color); color: rgba(var(--bg-color-dark-rgb),0.7); box-shadow: none; border-color: var(--secondary-text-color); }
        
        /* == STYLES DU POPUP POST-WORKOUT == */
        .post-workout-summary {
            position: fixed; inset: 0; background-color: rgba(var(--bg-color-dark-rgb), 0.9); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; 
            opacity: 0; visibility: hidden; pointer-events: none; transition: opacity 0.3s ease, visibility 0s linear 0.3s;
        }
        .post-workout-summary.visible { opacity: 1; visibility: visible; pointer-events: auto; transition: opacity 0.3s ease, visibility 0s linear 0s; }
        .post-workout-summary-content {
            background-color: var(--secondary-bg-color); border: 1px solid var(--border-color); border-radius: var(--border-radius-lg);
            box-shadow: 0 10px 30px rgba(0,0,0,0.4), 0 0 20px rgba(var(--electric-cyan-rgb), 0.1); 
            width: 100%; max-width: 600px; 
            max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; 
            transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .post-workout-summary.visible .post-workout-summary-content { transform: scale(1); }
        .post-workout-summary h2 {
            color: var(--electric-cyan); font-size: 1.5em; font-weight: 700; padding: 20px 25px; border-bottom: 1px solid var(--border-color);
            flex-shrink: 0; text-align: center; background-color: rgba(var(--bg-color-dark-rgb), 0.2); 
            text-shadow: 0 0 5px var(--electric-cyan);
        }
        .summary-items-list { list-style: none; padding: 15px 25px; overflow-y: auto; flex-grow: 1; background: var(--bg-color); border-bottom: 1px solid var(--border-color); }
        .summary-item { display: grid; grid-template-columns: 1fr; gap: 12px; align-items: start; padding: 15px 0; border-bottom: 1px solid var(--border-color); }
        .summary-item:last-child { border-bottom: none; }
        .summary-item .exercise-name { grid-column: 1 / -1; color: var(--primary-text-color); font-weight: 500; font-size: 1.05em; text-align: left; white-space: normal; margin-bottom: 5px; }
        .summary-item .exercise-name i { color: var(--color-exercise); margin-right: 8px; opacity: 0.9; }
        .summary-item .fields-grid { grid-column: 1 / -1; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px 15px; align-items: end; }
        .summary-item .input-group { display: flex; flex-direction: column; gap: 4px; }
        .summary-item label { font-size: 0.8em; color: var(--secondary-text-color); margin-bottom: 2px; display: block; text-align: left; }
        .summary-item input[type="number"], .summary-item input[type="text"], .summary-item textarea {
            background-color: var(--input-bg); border: 1px solid var(--border-color); color: var(--primary-text-color);
            border-radius: var(--border-radius-sm); padding: 8px 10px; font-size: 0.95em; width: 100%;
        }
        .summary-item input[type="number"] { text-align: center; -moz-appearance: textfield; }
        .summary-item input[type="number"]::-webkit-outer-spin-button, .summary-item input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .summary-item textarea { min-height: 60px; resize: vertical; font-family: inherit;}
        .summary-item input:focus, .summary-item textarea:focus { border-color: var(--electric-cyan); background-color: var(--secondary-bg-color); outline: none; box-shadow: 0 0 0 3px rgba(var(--electric-cyan-rgb), 0.3); }
        .summary-item .input-group.notes-group { grid-column: 1 / -1; } 
        .summary-controls {
            padding: 20px 25px; display: flex; justify-content: center; gap: 15px; flex-shrink: 0; flex-wrap: wrap; 
            border-top: 1px solid var(--border-color); background-color: rgba(var(--bg-color-dark-rgb), 0.2); 
        }
        .summary-controls button {
            border: none; color: #fff; min-width: 160px; padding: 10px 22px; border-radius: var(--border-radius-md);
            font-size: 1em; font-weight: 500; cursor: pointer; transition: all var(--transition-speed) ease;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); text-transform: uppercase; letter-spacing: 0.05em;
        }
        .summary-controls button:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; background-color: var(--secondary-text-color) !important; filter: grayscale(50%); }
        #finish-summary-btn { background-color: var(--neon-green); --button-finish-glow: var(--glow-green); }
        #finish-summary-btn:not(:disabled):hover { filter: brightness(1.15); box-shadow: 0 4px 10px rgba(0,0,0,0.3), 0 0 10px var(--button-finish-glow); transform: translateY(-1px); text-shadow: 0 0 5px rgba(255,255,255,0.5); }
        #finish-summary-btn:not(:disabled):active { filter: brightness(0.95); transform: translateY(0); box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        
        /* == STYLES GÉNÉRAUX & FOOTER == */
        .message-area { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.9); color: var(--primary-text-color); border: 1px solid var(--border-color); padding: 12px 25px; border-radius: var(--border-radius-md); z-index: 3000; opacity: 0; transition: all 0.5s ease; pointer-events: none; font-size: 0.95em; box-shadow: 0 4px 15px rgba(0,0,0,0.3), 0 0 10px rgba(var(--electric-cyan-rgb), 0.1); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); max-width: 90%; text-align: center; }
        .message-area.visible { opacity: 1; transform: translate(-50%, 0); bottom: 40px; pointer-events: auto; }
        .message-area.error { background-color: rgba(var(--neon-red-rgb), 0.8); color: #fff; border-color: var(--neon-red); text-shadow: 0 0 5px rgba(0,0,0,0.5); box-shadow: 0 4px 15px rgba(0,0,0,0.3), 0 0 10px var(--glow-red); }
        .message-area.success { background-color: rgba(var(--neon-green-rgb), 0.8); color: #030712; border-color: var(--neon-green); text-shadow: none; box-shadow: 0 4px 15px rgba(0,0,0,0.3), 0 0 10px var(--glow-green); }
        .message-area.info { background-color: rgba(var(--electric-blue-rgb), 0.8); color: #fff; border-color: var(--electric-blue); box-shadow: 0 4px 15px rgba(0,0,0,0.3), 0 0 10px var(--glow-blue); }

        footer { padding: 25px; text-align: center; font-size: 0.9em; color: var(--secondary-text-color); border-top: 1px solid rgba(var(--electric-blue-rgb), 0.2); margin-top: 50px; background-color: rgba(var(--bg-color-dark-rgb), 0.7); backdrop-filter: blur(3px); transition: all 0.3s ease-in-out; }
        footer p { margin-bottom: 8px; }
        footer a { color: var(--electric-cyan); text-decoration: none; transition: color var(--transition-speed) ease, text-shadow var(--transition-speed) ease; }
        footer a:hover { color: var(--primary-text-color); text-decoration: underline; text-shadow: 0 0 8px var(--electric-cyan); }
        footer .fab.fa-google-drive { color: var(--neon-green); } footer .fab.fa-github { color: var(--neon-purple); }
        
        @media (max-width: 768px) { .container { padding: 20px 15px; } .app-section h2 { font-size: 1.4em; } .program-step { grid-template-columns: auto 1fr; } .step-actions { grid-column: 2 / 3; flex-direction: row; justify-content: flex-end; padding-top: 0; align-items: center; } .step-content { grid-template-columns: 1fr; } .timer-display { width: 260px; height: 260px; } .reactor { width: 170px; height: 170px; } .timer-progress-circle-container { width: 220px; height: 220px; } #time-left { font-size: 3.0em; } .triangle { width: 125px; } .triangle::after { width: 95px; height: 95px; } .circle-2 { border-width: 7px; box-shadow: 0 0 20px 20px rgba(var(--electric-cyan-rgb), 0.2); } .circle-3::after { width: 90px; height: 90px; } .circle-5 { width: 50px; height: 50px; } .circle-5 span { width: 40px; height: 40px; } .controls button { font-size: 0.85em; padding: 8px 10px; min-width: 90px; } header h1 { font-size: 1.3em; } nav ul { gap: 12px; } nav button { font-size: 0.85em; padding: 6px 10px;} .history-list li { font-size: 0.9em; grid-template-columns: auto 1fr auto; gap: 5px 10px; } .history-item-reps { grid-column: 3 / 4; justify-self: start; } .history-item-duration { grid-column: 1 / -1; grid-row: 2 / 3; justify-self: end; } .exercise-image-area { max-width: 200px; margin-bottom: 15px; } #exercise-image-display { max-height: 160px; } .summary-item .fields-grid { grid-template-columns: 1fr; } }
        @media (max-width: 480px) { .header-content { justify-content: center; text-align: center; } nav ul { justify-content: center; } .header-actions { justify-content: center; width: 100%; margin-top: 10px; } .timer-display { width: 220px; height: 220px; } .reactor { width: 140px; height: 140px; } .timer-progress-circle-container { width: 190px; height: 190px; } #time-left { font-size: 2.5em; } .triangle { width: 100px; } .triangle::after { width: 75px; height: 75px; } .circle-1::before { inset: 6px; } .circle-2 { top: 20px; left: 20px; width: calc(100% - 40px); height: calc(100% - 40px); border-width: 5px; } .circle-3::after { width: 70px; height: 70px; } .circle-5 { width: 40px; height: 40px; } .circle-5 span { width: 32px; height: 32px; border-width: 4px;} .circle-7::after { width: 18px; height: 18px;} #current-exercise-name-display { font-size: 1.1em; } .exercise-details .main-stats { font-size: 1em; gap: 8px 15px; } .sets-info-text, .details-text { font-size: 0.75em; } .break-info { font-size: 0.9em; } .next-exercise-preview { font-size: 0.8em; } .controls button { flex-basis: calc(50% - 6px); padding: 8px; font-size: 0.8em; min-width: 80px; } .exercise-image-area { max-width: 160px; } #exercise-image-display { max-height: 120px; } .post-workout-summary-content { max-width: 95%; } .editor-actions { flex-direction: column; align-items: stretch; } .editor-actions button { width: 100%; justify-content: center; } .program-tabs { gap: 5px; } .program-tabs button { padding: 6px 12px; font-size: 0.9em; } .step-content { grid-template-columns: 1fr; } }
    </style>
</head>
<body class="logged-out dark-theme state-idle"> 

    <header>
        <div class="header-content">
            <h1><i class="fas fa-shield-halved"></i> ArmorWorkout</h1>
            <nav>
                <ul>
                    <li><button id="nav-workout" class="active"><i class="fas fa-stopwatch-20"></i> Timer</button></li>
                    <li><button id="nav-history"><i class="fas fa-history"></i> Historique</button></li>
                    <li><button id="nav-editor"><i class="fas fa-edit"></i> Modifications</button></li>
                </ul>
            </nav>
            <div class="header-actions">
                <div id="drive-status" style="display: none;"> 
                    <span id="drive-status-text">Connecté</span>
                </div>
                <button id="signin-button" disabled><i class="fab fa-google"></i> Connecter Drive</button>
            </div>
        </div>
    </header>

    <div class="container">
        <main>
            <!-- SECTION TIMER -->
            <div class="workout-section app-section" id="workout-section">
                 <div class="timer-and-image-wrapper">
                    <div id="exercise-image-container" class="exercise-image-area">
                        <img id="exercise-image-display" src="" alt="">
                    </div>

                    <div class="timer-display" id="timer-display-clickable" aria-label="Affichage du timer Arc Reactor">
                        <div class="timer-progress-circle-container">
                            <svg viewBox="0 0 100 100">
                                <circle class="timer-progress-circle-bg" cx="50" cy="50" r="45"></circle>
                                <circle id="timer-progress-indicator" class="timer-progress-circle" cx="50" cy="50" r="45"
                                        stroke-dasharray="282.74" stroke-dashoffset="282.74"> 
                                </circle>
                            </svg>
                        </div>
                        <div class="timer-step-info-display" id="workout-step-info-display">
                            <span id="workout-step-current-display" title="Étape actuelle">--</span>
                            <span id="workout-step-total-display" title="Nombre total d'étapes">--</span>
                        </div>

                        <div class="reactor">
                            <div class="triangle"></div>
                            <div class="circle-1"><span></span><span></span><span></span><span></span></div>
                            <div class="circle-2"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></div>
                            <div class="circle-3"></div>
                            <div class="circle-4"><span></span><span></span><span></span></div>
                            <div class="circle-5"><span></span><span></span><span></span></div>
                            <div class="circle-6"></div>
                            <div class="circle-7"></div>
                            <div class="circle-8"><span></span><span></span><span></span></div>

                            <div id="time-left" aria-live="polite">00:00</div>
                            <div id="timer-state" aria-live="polite">Prêt</div>
                        </div>
                    </div>
                </div>

                <div class="workout-info" id="workout-info">
                    <div id="current-exercise-name-display">ArmorWorkout</div>
                    <div id="current-exercise-container" aria-live="polite">
                        <div class="workout-prompt">
                            <i class="fas fa-sign-in-alt"></i>
                            <span>Connectez-vous et assurez-vous que '${FULL_PROGRAM_FILENAME}' est sur votre Drive.</span>
                        </div>
                    </div>
                </div>
                
                <div class="nav-buttons-timer">
                    <button id="nav-push" class="nav-button" data-session-name="PUSH" disabled>Push</button>
                    <button id="nav-pull" class="nav-button" data-session-name="PULL" disabled>Pull</button>
                    <button id="nav-legs" class="nav-button" data-session-name="LEGS" disabled>Legs</button>
                </div>
                
                <div class="controls">
                    <button id="prev-btn" disabled><i class="fas fa-backward-step"></i> Précédent</button>
                    <button id="start-pause-btn" disabled><i class="fas fa-play"></i> Démarrer</button>
                    <button id="skip-btn" disabled><i class="fas fa-forward-step"></i> Suivant</button>
                    <button id="finish-btn" disabled><i class="fas fa-flag-checkered"></i> Finir</button>
                    <button id="reset-btn" disabled><i class="fas fa-redo"></i> Reset</button>
                </div>

                <div class="progress-tracker" id="progress-tracker">
                    <span id="progress-text-area">Sélectionnez un entraînement</span>
                    <span id="drive-connection-status-main" style="display: none;"> 
                        <i class="fab fa-google-drive"></i>
                        <span id="drive-connection-text"></span>
                    </span>
                </div>
            </div>

            <!-- SECTION HISTORIQUE -->
            <div class="history-section app-section section-hidden" id="history-section">
                <h2><i class="fas fa-history"></i> Historique & Statistiques</h2>
                <div class="history-controls">
                    <div class="history-filters" role="group">
                        <button data-period="week" class="active"><i class="fas fa-calendar-week"></i> Semaine</button>
                        <button data-period="month"><i class="fas fa-calendar-alt"></i> Mois</button>
                        <button data-period="year"><i class="fas fa-calendar-check"></i> Année</button>
                        <button data-period="all"><i class="fas fa-infinity"></i> Tout</button>
                    </div>
                    <div class="history-actions" style="display: none;"> 
                        <span id="history-drive-status"></span>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="history-chart-canvas" role="img"></canvas>
                    <p id="history-chart-placeholder" class="chart-placeholder"></p> 
                </div>
                <div class="stats-display" id="stats-display">
                    <h3>Statistiques</h3>
                    <div class="content-wrapper" aria-live="polite"></div>
                    <p class="motivational-message"></p> 
                </div>
                <ul class="history-list" id="history-list"></ul>
            </div>

            <!-- SECTION EDITEUR -->
            <div class="editor-section app-section section-hidden" id="editor-section">
                <h2><i class="fas fa-edit"></i> Modifications Programme</h2>
                <div id="connection-prompt">
                    <p>Veuillez vous connecter à votre compte Google Drive pour charger et modifier votre programme d'entraînement.</p>
                    <button id="signin-button-prompt" disabled><i class="fab fa-google"></i> Connecter Drive</button>
                </div>
                <div id="program-editor-area" style="display:none;">
                    <div class="program-tabs" id="program-tabs">
                        <!-- Les onglets PUSH/PULL/LEGS seront insérés ici par JS -->
                    </div>
                    <ul id="program-display"></ul>
                    <div class="editor-actions">
                        <div class="add-buttons">
                            <button id="add-exercise-btn" disabled><i class="fas fa-plus-circle"></i> Ajouter Exercice</button>
                            <button id="add-break-btn" disabled><i class="fas fa-plus-circle"></i> Ajouter Pause</button>
                        </div>
                        <button id="save-program-btn" disabled><i class="fas fa-save"></i> Sauvegarder Programme</button>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <footer>
        <p>© <span id="current-year">2024</span> ArmorWorkout. Sauvegarde sur <i class="fab fa-google-drive" aria-hidden="true"></i> Google Drive.</p>
        <p><a href="https://github.com/ironworkout/armorworkout" target="_blank" rel="noopener noreferrer"><i class="fab fa-github" aria-hidden="true"></i> Voir sur GitHub</a></p>
    </footer>

    <div id="message-area" class="message-area" role="status" aria-live="polite"></div>

    <div id="post-workout-summary" class="post-workout-summary" role="dialog" aria-modal="true" aria-labelledby="summary-title">
        <div class="post-workout-summary-content">
            <h2 id="summary-title">Résumé & Objectifs</h2>
            <ul id="summary-items-list" class="summary-items-list"></ul>
            <div class="summary-controls">
                <button id="finish-summary-btn"><i class="fas fa-check"></i> Fin & Sauvegarder</button>
            </div>
        </div>
    </div>

    <script async defer src="https://accounts.google.com/gsi/client"></script>
    <script>
        const GOOGLE_CLIENT_ID = "731283926358-viam3ulpgna14flfdeb9m92l8s620hoi.apps.googleusercontent.com";
        const GOOGLE_DRIVE_SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const HISTORY_FILENAME = "armorworkout_history.json";
        const FULL_PROGRAM_FILENAME = "programmeCompletHypertrophieElite_v1.json"; 
        const PREPARE_DURATION = 3; 
        const IN_PROGRESS_KEY = 'armorWorkoutStateInProgress';
        const GIS_CHECK_INTERVAL = 100; 
        const GIS_MAX_RETRIES = 50; 
        const TIMER_PROGRESS_CIRCLE_CIRCUMFERENCE = 2 * Math.PI * 45;

        const defaultFullProgram = { 
            "nom_programme": "Programme de Secours ArmorWorkout",
            "description_programme": "Programme de base chargé car le programme principal n'a pu être récupéré.",
            "sessions": [
                { "nom_session": "PUSH", "exercices_et_pauses": [{ "type": "exercise", "name": "Pompes", "reps": 10, "unit":"PDC", "details": "Programme PUSH non chargé."},{ "type": "break", "duration": 60}]},
                { "nom_session": "PULL", "exercices_et_pauses": [{ "type": "exercise", "name": "Tractions (ou alternatives)", "reps": 8, "unit":"PDC", "details": "Programme PULL non chargé."},{ "type": "break", "duration": 60}]},
                { "nom_session": "LEGS", "exercices_et_pauses": [{ "type": "exercise", "name": "Squats", "reps": 15, "unit":"PDC", "details": "Programme LEGS non chargé."},{ "type": "break", "duration": 60}]}
            ]
        };
        const stepColorPalette = ['#22D3EE', '#00BFFF', '#4D94FF', '#FF1493', '#9400D3', '#39FF14', '#A78BFA', '#FF7B72', '#FACC15', '#F0F4F8'];

        let loadedFullProgram = null; 

        let timeDisplayDiv, timerStateDisplay, currentExerciseContainer, progressTracker, startPauseBtn, skipBtn, finishBtn,
            resetBtn, prevBtn, navWorkoutBtn, navHistoryBtn, navEditorBtn, navPushBtn, navPullBtn, navLegsBtn,
            signInButton, driveStatusElement, driveStatusTextElement, postWorkoutSummary, summaryTitle, summaryItemsList, finishSummaryBtn, 
            historyDriveStatus, currentExerciseNameDisplay, driveConnectionStatusMain, driveConnectionText, timerDisplayElement,
            progressTextArea, historyActionsContainer, historyChartCanvasEl, messageArea, workoutSection, historySection,
            historyList, statsDisplay, statsContentWrapper, historyFilterBtns, reactorElement, exerciseImageContainer,
            exerciseImageDisplay, timerProgressIndicator, workoutStepTotalDisplay, workoutStepCurrentDisplay,
            workoutStepInfoDisplay, editorSection, connectionPrompt, programEditorArea, programTabsContainer, programDisplay,
            addExerciseBtn, addBreakBtn, saveProgramBtn, signInButtonPrompt;

        let currentWorkoutType = null, currentWorkoutPlan = [], originalCompletedWorkoutPlan = [];
        let currentItemIndex = 0, timerInterval = null, prepareCountdownInterval = null;
        let totalTime = 0, timeLeft = 0, prepareTimeLeft = 0;
        let isTimerRunning = false, isWorkoutActive = false, workoutFinished = false, wasFinishedState = false;
        let currentState = 'idle', previousState = 'idle'; 
        let workoutStartTime = null, workoutHistory = [];
        let currentHistoryPeriod = 'week';
        let historyChartInstance = null;
        let googleAccessToken = null, tokenClient = null;
        let historyFileId = null, programFileId = null; 
        let programsLoaded = false; 
        let isSavingDriveData = false; 
        let currentTheme = 'dark', messageTimeoutId = null; 
        let audioContext = null;
        let gisCheckRetries = 0; 
        let halfwayTimeoutId = null; 
        let triangleSpinTimeoutId = null;
        let sortableInstance = null;
        let currentEditingSessionName = null; 
        let isDirty = false;
        
        let soundLaser, sound5, sound4, sound3, sound2, sound1, soundWindows, soundET;

        // == INITIALISATION ET SETUP == //

        function normalizeExerciseName(name) { return name ? name.trim() : ""; }
        function triggerTriangleSpin() {
            const t = document.querySelector('.reactor .triangle'); if (!t) return; if (triangleSpinTimeoutId) clearTimeout(triangleSpinTimeoutId);
            t.classList.remove('spin-transition'); void t.offsetWidth; t.classList.add('spin-transition');
            triangleSpinTimeoutId = setTimeout(() => { t.classList.remove('spin-transition'); triangleSpinTimeoutId = null; }, 600); 
        }
        function initSounds() {
            try {
                const bP = "https://ironworkout.github.io/armorworkout/"; 
                soundLaser = new Audio(bP+'laser.mp3'); sound5=new Audio(bP+'5.mp3'); sound4=new Audio(bP+'4.mp3'); sound3=new Audio(bP+'3.mp3');
                sound2=new Audio(bP+'2.mp3'); sound1=new Audio(bP+'1.mp3'); soundWindows=new Audio(bP+'windows.mp3'); soundET=new Audio(bP+'e-t.mp3');
                [soundLaser,sound5,sound4,sound3,sound2,sound1,soundWindows,soundET].forEach(s => { if(s)s.preload='auto';});
            } catch (e) { showMessage("Erreur chargement sons.", 5000, "error"); }
        }
        function playSound(a) { if (!a || !audioContext || audioContext.state !== 'running') return; a.currentTime = 0; a.play().catch(e => {}); }
        function initAudioContext() {
            if (audioContext && audioContext.state === 'running') return; 
            if (!audioContext) { try { window.AudioContext = window.AudioContext || window.webkitAudioContext; if (window.AudioContext) audioContext = new AudioContext(); else return; } catch (e) { return; } }
            if (audioContext.state === 'suspended') audioContext.resume().catch(e => {});
        }
        const vibrate = (p = [100]) => { if ('vibrate' in navigator) { try { navigator.vibrate(p); } catch (e) {} } };

        // == LOGIQUE D'AUTHENTIFICATION GOOGLE UNIFIÉE == //

        async function gisInitInternal() {
            if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
                try {
                    tokenClient = google.accounts.oauth2.initTokenClient({ client_id: GOOGLE_CLIENT_ID, scope: GOOGLE_DRIVE_SCOPES, callback: tokenCallback, error_callback: handleTokenError });
                    if (tokenClient) tokenClient.requestAccessToken({ prompt: '' }); 
                    if (signInButton) signInButton.disabled = false;
                    if(signInButtonPrompt) signInButtonPrompt.disabled = false; 
                } catch (error) { showMessage("Erreur initialisation services Google.", 5000, "error"); updateAuthUI(false); if(signInButton) signInButton.disabled = true; if(signInButtonPrompt) signInButtonPrompt.disabled = true; }
            } else { if(signInButton) signInButton.disabled = true; if(signInButtonPrompt) signInButtonPrompt.disabled = true; }
        }
        function checkAndInitGis() {
            if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2 && typeof google.accounts.oauth2.initTokenClient === 'function') gisInitInternal();
            else if (gisCheckRetries < GIS_MAX_RETRIES) { gisCheckRetries++; setTimeout(checkAndInitGis, GIS_CHECK_INTERVAL); }
            else { showMessage("Erreur critique: API Google non disponible.", 10000, "error"); if(signInButton) signInButton.disabled = true; if(signInButtonPrompt) signInButtonPrompt.disabled = true; }
        }
        function handleTokenError(error) {
            let msg = `Erreur Authentification Google: ${error.type || error.error || 'Inconnue'}`;
            if (error.type === 'popup_closed_by_user' || error.error === 'popup_closed_by_user') msg = "Fenêtre de connexion Google fermée.";
            else if (error.type === 'popup_failed_to_open') msg = "Impossible d'ouvrir la fenêtre de connexion. Vérifiez les bloqueurs de popups.";
            else if (error.type === 'USER_CANCELLED' || error.error === 'access_denied') msg = "Accès aux données Drive refusé par l'utilisateur.";
            if (driveStatusElement) { driveStatusElement.classList.add('error'); }
            showMessage(msg, 7000, "error"); if (driveStatusTextElement) driveStatusTextElement.textContent = 'Erreur Auth'; updateAuthUI(false); 
        }
        async function tokenCallback(tokenResponse) {
            if (driveStatusElement) driveStatusElement.className = ''; 
            if (tokenResponse.error) { if (tokenResponse.error !== "popup_failed_to_open" && tokenResponse.error !== "popup_closed_by_user") handleTokenError(tokenResponse); else updateAuthUI(false); return; }
            if (tokenResponse && tokenResponse.access_token) {
                googleAccessToken = tokenResponse.access_token; showMessage("Connecté ! Chargement des données...", 2500, "info");
                if (driveStatusElement) { driveStatusElement.classList.add('loading'); }
                if(driveStatusTextElement) driveStatusTextElement.textContent = 'Chargement...';
                try {
                    await loadHistoryFromDrive(); 
                    const programLoadSuccess = await loadFullProgramFromDrive(); 
                    if (programLoadSuccess && loadedFullProgram && loadedFullProgram.sessions) { 
                        programsLoaded = true;
                        showMessage("Programme et historique chargés.", 3000, "success");
                        if (driveStatusElement) { driveStatusElement.classList.add('success'); }
                        if(driveStatusTextElement) driveStatusTextElement.textContent = 'Connecté';
                        populateEditorTabs();
                        if(editorSection && !editorSection.classList.contains('section-hidden') && loadedFullProgram.sessions.length > 0){
                           handleEditorTabClick(loadedFullProgram.sessions[0]?.nom_session); // Afficher la première session par défaut si l'éditeur est visible
                        }
                    } else { 
                        showMessage(`'${FULL_PROGRAM_FILENAME}' non trouvé, vide, ou invalide sur Drive. Assurez-vous qu'il existe et contient des sessions.`, 8000, "error");
                        if (driveStatusElement) { driveStatusElement.classList.add('error'); }
                        if(driveStatusTextElement) driveStatusTextElement.textContent = 'Prog Défaut';
                        programsLoaded = false; loadedFullProgram = null; 
                    }
                } catch (error) {
                    showMessage("Erreur majeure lors du chargement des données Drive.", 6000, "error");
                    if (driveStatusElement) { driveStatusElement.classList.add('error'); }
                    if(driveStatusTextElement) driveStatusTextElement.textContent = 'Erreur Données';
                    programsLoaded = false; loadedFullProgram = null; 
                } finally { 
                    updateAuthUI(true); 
                    displayHistory(currentHistoryPeriod); 
                    loadInProgressState(); 
                }
            } else handleTokenError({ error: "Réponse de token invalide ou vide" });
        }
        function handleAuthClick() {
            initAudioContext(); 
            if (!tokenClient) { showMessage("Services Google non prêts. Veuillez patienter.", 3000, "info"); checkAndInitGis(); return; }
            if (driveStatusElement) { driveStatusElement.classList.add('loading'); }
            if(driveStatusTextElement) driveStatusTextElement.textContent = 'Connexion...';
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }

        // == GESTION DES FICHIERS DRIVE UNIFIÉE == //
        
        async function findOrCreateFile(filename, defaultContentStr = "{}", mimeType = 'application/json', createIfNotExist = false) { 
            if (!googleAccessToken) return null; 
            const searchUrl = `https://www.googleapis.com/drive/v3/files?q=name='${encodeURIComponent(filename)}'+and+trashed=false&spaces=drive&fields=files(id,name)`;
            try {
                const searchRes = await fetch(searchUrl, { headers: { 'Authorization': `Bearer ${googleAccessToken}` } });
                if (!searchRes.ok) { if (searchRes.status === 401 || searchRes.status === 403) { showMessage("Session Google expirée.", 5000, "error"); googleAccessToken = null; updateAuthUI(false); return null; } throw new Error(`Recherche échouée (${searchRes.status})`); }
                const searchData = await searchRes.json();
                if (searchData.files && searchData.files.length > 0) { console.log(`Drive: Fichier ${filename} trouvé (ID: ${searchData.files[0].id}).`); return searchData.files[0].id; }
                if (!createIfNotExist) { console.log(`Drive: Fichier ${filename} non trouvé et création désactivée.`); return null; } 
                console.log(`Drive: Fichier ${filename} non trouvé. Tentative de création...`);
                const createUrl = `https://www.googleapis.com/drive/v3/files`;
                const metadata = { name: filename, mimeType: mimeType };
                const createRes = await fetch(createUrl, { method: 'POST', headers: { 'Authorization': `Bearer ${googleAccessToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify(metadata) });
                if (!createRes.ok) throw new Error(`Création échouée (${createRes.status})`);
                const createData = await createRes.json(); const newFileId = createData.id;
                const writeSuccess = await updateFileContent(newFileId, defaultContentStr);
                console.log(`Drive: Fichier ${filename} créé (ID: ${newFileId}). Succès écriture contenu par défaut: ${writeSuccess}`);
                return writeSuccess ? newFileId : null;
            } catch (error) { console.error(`Erreur Drive (findOrCreate ${filename}):`, error); showMessage(`Erreur Drive (${filename.substring(0, 15)}...): ${error.message}`, 6000, "error"); return null; }
        }
        async function readFileContent(fileId) { if (!googleAccessToken || !fileId) return null; console.log(`Drive: Lecture du fichier ${fileId}`); const url = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`; try { const response = await fetch(url, { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }); if (!response.ok) { if (response.status === 404) { console.warn(`readFileContent(${fileId}): Fichier non trouvé (404).`); return null; } if (response.status === 401 || response.status === 403) { showMessage("Session Google expirée.", 5000, "error"); googleAccessToken = null; updateAuthUI(false); return null; } throw new Error(`Lecture échouée (${response.status})`); } const content = await response.text(); console.log(`Drive: Contenu du fichier ${fileId} lu.`); return content; } catch (error) { console.error(`Erreur Drive (readFile ${fileId}):`, error); showMessage(`Erreur Lecture Drive (${fileId}): ${error.message}`, 6000, "error"); return null; } }
        async function updateFileContent(fileId, content) { if (!googleAccessToken || !fileId) return false; console.log(`Drive: Écriture dans le fichier ${fileId}...`); if(saveProgramBtn) saveProgramBtn.disabled = true; const url = `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`; const isJson = typeof content === 'object'; const contentToSend = isJson ? JSON.stringify(content, null, 2) : content; const contentType = isJson ? 'application/json; charset=UTF-8' : 'text/plain; charset=UTF-8'; let success = false; try { const response = await fetch(url, { method: 'PATCH', headers: { 'Authorization': `Bearer ${googleAccessToken}`, 'Content-Type': contentType }, body: contentToSend }); if (!response.ok) { if (response.status === 401 || response.status === 403) { showMessage("Session expirée. Sauvegarde échouée.", 6000, "error"); googleAccessToken = null; updateAuthUI(false); } else { throw new Error(`Écriture échouée (${response.status})`); } } else { console.log(`Drive: Fichier ${fileId} mis à jour.`); success = true; } } catch (error) { console.error(`Erreur Drive (updateFile ${fileId}):`, error); showMessage(`Erreur Écriture Drive: ${error.message}`, 6000, "error"); success = false; } finally { if(saveProgramBtn) saveProgramBtn.disabled = !success && isDirty; console.log(`Drive: Écriture ${fileId} terminée. Succès: ${success}`); } return success; }

        async function loadHistoryFromDrive() {
            if (!googleAccessToken) return; console.log("Chargement historique Drive...");
            historyFileId = await findOrCreateFile(HISTORY_FILENAME, JSON.stringify([]), 'application/json', true); 
            if (historyFileId) {
                const content = await readFileContent(historyFileId);
                if (content !== null) { try { workoutHistory = JSON.parse(content || "[]"); workoutHistory.forEach(e => { if (!e.exercises) e.exercises = []; }); console.log("Historique chargé."); } catch (e) { console.error("Erreur parsing historique:", e); showMessage("Historique Drive corrompu.", 4000, "error"); workoutHistory = []; } }
                else { console.log("Aucun historique Drive."); workoutHistory = []; }
            } else { console.log("Fichier historique Drive introuvable/création échouée."); workoutHistory = []; }
        }
        async function loadFullProgramFromDrive() {
            programsLoaded = false; loadedFullProgram = null; 
            if (!googleAccessToken) { showMessage("Connectez-vous à Drive pour charger votre programme.", 5000, "info"); return false; }
            console.log(`Chargement du programme '${FULL_PROGRAM_FILENAME}' depuis Drive...`);
            programFileId = await findOrCreateFile(FULL_PROGRAM_FILENAME, JSON.stringify(defaultFullProgram), 'application/json', true); 
            
            if (programFileId) {
                const content = await readFileContent(programFileId);
                if (content && content.trim() !== "") {
                    try {
                        const parsedProgram = JSON.parse(content);
                        if (parsedProgram && parsedProgram.sessions && Array.isArray(parsedProgram.sessions)) {
                            loadedFullProgram = parsedProgram; 
                            console.log(`Programme '${FULL_PROGRAM_FILENAME}' chargé avec succès.`);
                            return true;
                        } else {
                            console.error(`'${FULL_PROGRAM_FILENAME}' malformé. Structure attendue : { "sessions": [...] }. Rétablissement du programme par défaut.`);
                            loadedFullProgram = JSON.parse(JSON.stringify(defaultFullProgram)); // Utiliser le programme par défaut en cas d'erreur
                            await updateFileContent(programFileId, loadedFullProgram); // Tenter de sauvegarder le programme par défaut
                            showMessage(`'${FULL_PROGRAM_FILENAME}' sur Drive est malformé. Programme par défaut restauré.`, 7000, "error"); 
                            return true; // Retourner true car on a un programme (celui par défaut)
                        }
                    } catch (e) {
                        console.error(`Erreur parsing '${FULL_PROGRAM_FILENAME}':`, e, "Contenu:", content.substring(0,200));
                        loadedFullProgram = JSON.parse(JSON.stringify(defaultFullProgram));
                        await updateFileContent(programFileId, loadedFullProgram);
                        showMessage(`Programme '${FULL_PROGRAM_FILENAME}' corrompu. Programme par défaut restauré. Erreur: ${e.message}`, 7000, "error"); 
                        return true;
                    }
                } else { 
                     console.log(`Fichier '${FULL_PROGRAM_FILENAME}' vide. Rétablissement du programme par défaut.`);
                     loadedFullProgram = JSON.parse(JSON.stringify(defaultFullProgram));
                     await updateFileContent(programFileId, loadedFullProgram);
                     showMessage(`Fichier '${FULL_PROGRAM_FILENAME}' vide sur Drive. Programme par défaut restauré.`, 7000, "info"); 
                     return true;
                }
            } else { 
                showMessage(`Impossible de trouver ou créer '${FULL_PROGRAM_FILENAME}' sur Drive. Vérifiez les autorisations.`, 7000, "error"); 
                return false; 
            }
        }

        // == LOGIQUE DU TIMER == //
        function getDynamicSetsInfo(targetIndex) {
            if (!currentWorkoutPlan || targetIndex < 0 || targetIndex >= currentWorkoutPlan.length) return '';
            const targetItem = currentWorkoutPlan[targetIndex];
            if (!targetItem || (targetItem.type !== 'exercise' && !targetItem.type?.startsWith('exercise_'))) return '';

            const exName = targetItem.name;
            const allSetsForExercise = currentWorkoutPlan.filter(i => i.name === exName && (i.type === 'exercise' || i.type.startsWith('exercise_')));
            const totalSets = allSetsForExercise.length;

            if (totalSets <= 1 && targetItem.sets_info) return targetItem.sets_info;
            if (totalSets <= 1 && !targetItem.sets_info) return '';


            let currentSet = 0;
            for (let i = 0; i <= targetIndex; i++) {
                if (currentWorkoutPlan[i].name === exName && (currentWorkoutPlan[i].type === 'exercise' || currentWorkoutPlan[i].type.startsWith('exercise_'))) {
                    currentSet++;
                }
            }
            return `Série ${currentSet}/${totalSets}`;
        }
        
        function createNextExercisePreviewHtml(nextExercise, state, dynamicSetsInfo) {
            if (!nextExercise) return '';

            const formattedNextReps = getFormattedReps(nextExercise);
            const formattedNextWeight = getFormattedWeight(nextExercise);
            const iconClass = state === 'preparing' ? 'fa-hourglass-start' : 'fa-arrow-right';
            const borderColorVar = state === 'preparing' ? '--color-prepare' : '--color-break';
            const iconColor = (state === 'preparing' ? `var(--color-prepare)`: `var(--color-break)`);

            let nextDetailsHtml = '';
            if (dynamicSetsInfo) {
                nextDetailsHtml += `<span><i class="fas fa-layer-group"></i> ${dynamicSetsInfo}</span>`;
            }
            nextDetailsHtml += `<span><i class="fas fa-repeat"></i> ${formattedNextReps}</span>`;
            if (formattedNextWeight !== "-") {
                nextDetailsHtml += `<span><i class="fas fa-weight-hanging"></i> ${formattedNextWeight}</span>`;
            }

            return `<div class="next-exercise-preview" style="border-color: var(${borderColorVar});">
                        <i class="fas ${iconClass}" style="color: ${iconColor};"></i>
                        <strong>À suivre : ${nextExercise.name || '?'}</strong>
                        <div class="next-details-grid">${nextDetailsHtml}</div>
                    </div>`;
        }

        function updateWorkoutInfo() {
            if (!currentExerciseContainer || !currentExerciseNameDisplay) return;
            const item = currentWorkoutPlan[currentItemIndex]; let infoHtml = '', exerciseName = '', progressText = '';
            
            if (item && (item.type === 'exercise' || item.type?.startsWith('exercise_')) && (currentState === 'exercise' || (currentState === 'paused' && previousState === 'exercise'))) {
                imageUrlForDisplay = item.image_url; if (imageUrlForDisplay && exerciseImageContainer) showImage = true;
            } else if (currentState === 'preparing' && currentWorkoutPlan[0] && (currentWorkoutPlan[0].type === 'exercise' || currentWorkoutPlan[0].type?.startsWith('exercise_'))) {
                imageUrlForDisplay = currentWorkoutPlan[0].image_url; if (imageUrlForDisplay && exerciseImageContainer) showImage = true;
            }
            if (exerciseImageContainer && exerciseImageDisplay) {
                if (showImage && imageUrlForDisplay) { exerciseImageDisplay.src = imageUrlForDisplay; exerciseImageDisplay.alt = item?.name || "Image de l'exercice"; exerciseImageContainer.classList.add('visible'); }
                else { exerciseImageContainer.classList.remove('visible'); setTimeout(() => { if (exerciseImageContainer && !exerciseImageContainer.classList.contains('visible')) { exerciseImageDisplay.src = ''; exerciseImageDisplay.alt = ''; } }, 400); }
            }

            switch (currentState) {
                case 'idle':
                    exerciseName = "ArmorWorkout";
                    let idleMsg = `<div class="workout-prompt"><i class="fas fa-sign-in-alt"></i><span>Connectez-vous et assurez-vous que '${FULL_PROGRAM_FILENAME}' est sur votre Drive.</span></div>`;
                    if (googleAccessToken && !programsLoaded) idleMsg = `<div class="workout-prompt"><i class="fas fa-spinner fa-spin"></i><span>Chargement du programme...</span></div>`;
                    else if (googleAccessToken && programsLoaded && !loadedFullProgram) idleMsg = `<div class="workout-prompt"><i class="fas fa-exclamation-triangle"></i><span>'${FULL_PROGRAM_FILENAME}' invalide/non trouvé.</span></div>`;
                    else if (googleAccessToken && programsLoaded && loadedFullProgram && !currentWorkoutType) idleMsg = `<div class="workout-prompt"><i class="fas fa-hand-pointer"></i><span>Sélectionnez une session (Push/Pull/Legs).</span></div>`;
                    else if (googleAccessToken && programsLoaded && loadedFullProgram && currentWorkoutType) idleMsg = `<div class="workout-prompt"><i class="fas fa-play-circle"></i><span>Prêt à démarrer: ${currentWorkoutType}.</span></div>`;
                    progressText = googleAccessToken ? (programsLoaded && loadedFullProgram ? (currentWorkoutType ? `Prêt: ${currentWorkoutType}`: "Sélectionnez une session") : "Chargement...") : "Connectez-vous";
                    infoHtml = idleMsg; break;
                case 'finished': 
                    const durationSeconds = workoutStartTime ? (Date.now() - workoutStartTime) / 1000 : 0; 
                    exerciseName = 'Entraînement Terminé !'; 
                    infoHtml = `<div class="exercise-details" style="border-color: var(--color-finished);"><div class="main-stats"><span><i class="fas ${getIconForState('finished')}" style="color: var(--color-finished)"></i> Bravo ! ${durationSeconds > 0 ? `(${formatTime(durationSeconds)})` : ''}</span></div></div>`; 
                    progressText = `Fini (${originalCompletedWorkoutPlan.length}/${originalCompletedWorkoutPlan.length} étapes)`; 
                    break;
                case 'preparing': 
                    const nextItemToPrepare = currentWorkoutPlan[0]; 
                    exerciseName = `Préparation...`; 
                    if(nextItemToPrepare) {
                        const dynamicSetsInfo = getDynamicSetsInfo(0);
                        infoHtml = createNextExercisePreviewHtml(nextItemToPrepare, 'preparing', dynamicSetsInfo);
                    }
                    progressText = `Prépa... (1/${currentWorkoutPlan.length} étapes)`; 
                    break;
                case 'exercise': case 'paused': case 'break':
                    if (!item) { exerciseName = 'Erreur'; infoHtml = '<p>Erreur chargement étape.</p>'; progressText = `Étape ?/${currentWorkoutPlan.length}`; break; }
                    
                    exerciseName = item.type === 'break' ? 'Repos' : (item.name || 'Exercice Inconnu');
                    progressText = `Étape ${currentItemIndex + 1}/${currentWorkoutPlan.length}`;

                    if (item.type === 'exercise' || item.type?.startsWith('exercise_')) {
                        const repsDisplay = getFormattedReps(item);
                        const weightDisplay = getFormattedWeight(item);
                        const details = item.details || '';
                        const dynamicSetsInfo = getDynamicSetsInfo(currentItemIndex) || item.sets_info;
                        
                        infoHtml = `<div class="exercise-details" style="border-color: var(--color-exercise);">`;
                        if (dynamicSetsInfo) {
                           infoHtml += `<span class="sets-info-text"><i class="fas fa-layer-group"></i> ${dynamicSetsInfo}</span>`;
                        }
                        infoHtml += `<div class="main-stats">
                                        <span><i class="fas fa-repeat"></i> ${repsDisplay}</span>`;
                        if (weightDisplay !== "-") infoHtml += `<span><i class="fas fa-weight-hanging"></i> ${weightDisplay}</span>`;
                        infoHtml += `</div>`;
                        
                        const setInfoRegex = /^Série \d+\s*\/\s*\d+\.?\s*$/i;
                        if (details && !setInfoRegex.test(details.trim())) {
                            infoHtml += `<span class="details-text"><i class="fas fa-info-circle"></i> ${details}</span>`;
                        }
                        infoHtml += `</div>`;
                    } else if (item.type === 'break') {
                        infoHtml = ''; 
                        const nextExIdx = currentItemIndex + 1;
                        if (nextExIdx < currentWorkoutPlan.length && (currentWorkoutPlan[nextExIdx].type === 'exercise' || currentWorkoutPlan[nextExIdx].type?.startsWith('exercise_'))) {
                            const nextEx = currentWorkoutPlan[nextExIdx];
                            const dynamicSetsInfo = getDynamicSetsInfo(nextExIdx);
                            infoHtml = createNextExercisePreviewHtml(nextEx, 'break', dynamicSetsInfo);
                        } else {
                             infoHtml = `<div class="break-info" style="border-color: var(--color-break);">
                                            <i class="fas ${getIconForType('break')}" style="color: var(--color-break)"></i>
                                            <span>Détendez-vous...</span>
                                        </div>`;
                        }
                    } 
                    break;
                default: exerciseName = '?'; infoHtml = '<p>État inconnu.</p>'; progressText = ''; break;
            }
            if(currentExerciseNameDisplay) currentExerciseNameDisplay.textContent = exerciseName; 
            if(currentExerciseContainer) currentExerciseContainer.innerHTML = infoHtml; 
            if(progressTextArea) progressTextArea.textContent = progressText;
            document.body.className = Array.from(document.body.classList).filter(cls => !cls.startsWith('state-')).join(' ') + ` state-${currentState}`; 
            document.body.classList.toggle('workout-active', !['idle', 'finished'].includes(currentState)); 
            updateTimerVisuals(currentState); 
        }

        function getIconForState(state){ switch(state){ case 'exercise': return 'fa-dumbbell'; case 'break': return 'fa-hourglass-half'; case 'paused': return 'fa-pause-circle'; case 'preparing': return 'fa-spinner'; case 'finished': return 'fa-flag-checkered'; default: return 'fa-clock'; } }
        function getIconForType(type){ if (type?.includes("myo_reps")) return 'fa-bolt'; if (type?.startsWith('exercise_')) return 'fa-dumbbell'; if (type === 'break') return 'fa-coffee'; return 'fa-question-circle'; }
        
        function setState(newState) {
            if (!startPauseBtn || !skipBtn || !finishBtn || !resetBtn || !timerDisplayElement || !prevBtn || !timeDisplayDiv) {console.warn("setState: Un ou plusieurs éléments DOM du timer sont manquants."); return;}
            previousState = currentState; currentState = newState; clearInterval(timerInterval); clearInterval(prepareCountdownInterval); clearTimeout(halfwayTimeoutId); 
            
            const body = document.body;
            body.className = Array.from(body.classList).filter(cls => !cls.startsWith('state-')).join(' ') + ` state-${newState}`;
            body.classList.toggle('workout-active', !['idle', 'finished'].includes(newState));

            updateWorkoutInfo();
            
            if(startPauseBtn) { startPauseBtn.className = ''; startPauseBtn.disabled = true; }
            if(skipBtn) skipBtn.disabled = true; if(prevBtn) prevBtn.disabled = true; if(finishBtn) finishBtn.disabled = true; if(resetBtn) resetBtn.disabled = true;
            
            const isTimerUiActive = ['preparing', 'exercise', 'break', 'paused'].includes(newState);
            // Mettre à jour l'état des boutons de navigation principaux (Timer, Historique, Modifications)
            [navWorkoutBtn, navHistoryBtn, navEditorBtn].forEach(btn => {
                if(btn) btn.disabled = isTimerUiActive && btn.id !== 'nav-workout';
            });
            // Mettre à jour l'état des boutons de sélection de session PUSH/PULL/LEGS
            if(navPushBtn) navPushBtn.disabled = !(googleAccessToken && programsLoaded && loadedFullProgram && !isTimerUiActive);
            if(navPullBtn) navPullBtn.disabled = !(googleAccessToken && programsLoaded && loadedFullProgram && !isTimerUiActive);
            if(navLegsBtn) navLegsBtn.disabled = !(googleAccessToken && programsLoaded && loadedFullProgram && !isTimerUiActive);


            switch (newState) {
                case 'idle': isTimerRunning = false; isWorkoutActive = false; workoutFinished = false; timeLeft = 0; totalTime = 0; workoutStartTime = null; const canStartIdle = googleAccessToken && programsLoaded && loadedFullProgram && !!currentWorkoutType && currentWorkoutPlan && currentWorkoutPlan.length > 0; if(startPauseBtn) { startPauseBtn.disabled = !canStartIdle; startPauseBtn.innerHTML = `<i class="fas fa-play"></i> Démarrer`; } if(resetBtn) resetBtn.disabled = !(googleAccessToken && !!currentWorkoutType); prevBtn.disabled = true; finishBtn.disabled = true; if (wasFinishedState) wasFinishedState = false; break;
                case 'preparing': isWorkoutActive = true; prepareTimeLeft = PREPARE_DURATION; if(startPauseBtn) { startPauseBtn.innerHTML = `<i class="fas ${getIconForState('preparing')} fa-spin"></i> Prêt...`; startPauseBtn.disabled = true; } if(resetBtn) resetBtn.disabled = !googleAccessToken; prevBtn.disabled = true; finishBtn.disabled = true; startPrepareCountdown(); if (!workoutStartTime) { workoutStartTime = Date.now(); } vibrate([50,30,50]); break;
                case 'exercise': isWorkoutActive = true; isTimerRunning = false; timeLeft = 0; totalTime = 0; if (googleAccessToken) { if(startPauseBtn) { startPauseBtn.disabled = true; startPauseBtn.innerHTML = `<i class="fas ${getIconForState('exercise')}"></i> En Cours`; } if(skipBtn) skipBtn.disabled = false; if(prevBtn) prevBtn.disabled = currentItemIndex <= 0; if(finishBtn) finishBtn.disabled = false; if(resetBtn) resetBtn.disabled = false; } vibrate([150]); playSound(soundLaser); triggerTriangleSpin(); break;
                case 'break': isTimerRunning = true; isWorkoutActive = true; if (googleAccessToken) { if(startPauseBtn) { startPauseBtn.disabled = false; startPauseBtn.innerHTML = `<i class="fas ${getIconForState('paused')}"></i> Pause`; } if(skipBtn) skipBtn.disabled = false; if(prevBtn) prevBtn.disabled = currentItemIndex <= 0; if(finishBtn) finishBtn.disabled = false; if(resetBtn) resetBtn.disabled = false; } startBreakTimer(); vibrate([80, 50, 80]); playSound(soundLaser); triggerTriangleSpin(); break;
                case 'paused': isTimerRunning = false; isWorkoutActive = true; if (googleAccessToken) { if(startPauseBtn) { startPauseBtn.disabled = false; startPauseBtn.innerHTML = `<i class="fas fa-play"></i> Reprendre`; } if(skipBtn) skipBtn.disabled = false; if(prevBtn) prevBtn.disabled = currentItemIndex <= 0; if(finishBtn) finishBtn.disabled = false; if(resetBtn) resetBtn.disabled = false; } vibrate(); break;
                case 'finished': isWorkoutActive = false; isTimerRunning = false; workoutFinished = true; wasFinishedState = true; timeLeft = 0; totalTime = 0; if(startPauseBtn) { startPauseBtn.disabled = true; startPauseBtn.innerHTML = `<i class="fas ${getIconForState('finished')}"></i> Terminé`; } if(skipBtn) skipBtn.disabled = true; if(prevBtn) prevBtn.disabled = true; if(finishBtn) finishBtn.disabled = true; if(resetBtn) resetBtn.disabled = !googleAccessToken; showMessage('Entraînement terminé ! 💪', 3000, "success"); vibrate([150, 50, 150]); playSound(soundET); originalCompletedWorkoutPlan = JSON.parse(JSON.stringify(currentWorkoutPlan)); saveWorkoutToHistory(); clearInProgressState(); triggerTriangleSpin(); setTimeout(populateAndShowSummary, 500); break;
                default: currentState = 'idle'; updateAuthUI(!!googleAccessToken); break;
            }
            updateTimerVisuals(newState); updateTimerDisplay(); 
        }
        function startPrepareCountdown() {
            totalTime = PREPARE_DURATION; updateTimerDisplay(); if (prepareTimeLeft === 3) playSound(sound3);
            prepareCountdownInterval = setInterval(() => { prepareTimeLeft--; updateTimerDisplay(); if (prepareTimeLeft === 2) playSound(sound2); if (prepareTimeLeft === 1) playSound(sound1); if (prepareTimeLeft <= 0) { clearInterval(prepareCountdownInterval); setState('exercise'); } }, 1000);
        }
        function startBreakTimer() {
            const item = currentWorkoutPlan[currentItemIndex]; if (!item || item.type !== 'break' || !item.duration) { handleItemCompletion(); return; }
            totalTime = item.duration; timeLeft = totalTime; updateTimerDisplay();
            if (totalTime > 10) halfwayTimeoutId = setTimeout(() => { playSound(soundWindows); vibrate([50]); }, (totalTime / 2) * 1000);
            if (timeLeft === 5) playSound(sound5); else if (timeLeft === 4) playSound(sound4); else if (timeLeft === 3) playSound(sound3); else if (timeLeft === 2) playSound(sound2); else if (timeLeft === 1) playSound(sound1);
            timerInterval = setInterval(() => { timeLeft--; updateTimerDisplay(); if (timeLeft === 5) playSound(sound5); else if (timeLeft === 4) playSound(sound4); else if (timeLeft === 3) playSound(sound3); else if (timeLeft === 2) playSound(sound2); else if (timeLeft === 1) playSound(sound1); if (timeLeft <= 0) { clearInterval(timerInterval); clearTimeout(halfwayTimeoutId); handleItemCompletion(); } }, 1000);
        }
        function handleItemCompletion() {
            if (currentState === 'finished') return; 
            currentItemIndex++;
            updateOverallWorkoutProgressDisplay(); 
            if (currentItemIndex >= currentWorkoutPlan.length) setState('finished'); 
            else { const nextItem = currentWorkoutPlan[currentItemIndex]; setState(nextItem.type === 'break' ? 'break' : 'exercise'); }
            saveInProgressState(); 
        }
        function handlePreviousClick() {
            if (currentItemIndex > 0) {
                currentItemIndex--; 
                updateOverallWorkoutProgressDisplay(); 
                const prevItem = currentWorkoutPlan[currentItemIndex];
                if (prevItem.type?.includes("myo_reps") && prevItem.completed_mini_sets) prevItem.completed_mini_sets = 0;
                setState(prevItem.type === 'break' ? 'break' : 'exercise'); saveInProgressState(); vibrate();
            }
        }
        function forceFinishWorkout() { if (confirm("Êtes-vous sûr de vouloir terminer l'entraînement ?")) { setState('finished'); } }
        
        function loadSession(sessionName) {
            if (!loadedFullProgram || !loadedFullProgram.sessions) { showMessage(`Programme non chargé. Vérifiez '${FULL_PROGRAM_FILENAME}' sur Drive.`, 5000, "error"); return; }
            const session = loadedFullProgram.sessions.find(s => s.nom_session.startsWith(sessionName));
            if (!session || !session.exercices_et_pauses) { showMessage(`Session "${sessionName}" non trouvée ou invalide.`, 4000, "error"); currentWorkoutPlan = []; return; }
            currentWorkoutType = session.nom_session; currentWorkoutPlan = JSON.parse(JSON.stringify(session.exercices_et_pauses)); 
            currentWorkoutPlan.forEach(item => { 
                if (item.type === 'exercise' || item.type?.startsWith('exercise_')) {
                    item.current_reps = item.reps; 
                    item.finalReps = undefined;
                    item.finalWeightDescription = undefined;
                    item.finalProgressionNote = undefined; 
                    if (item.type.includes("myo_reps") && item.name.toLowerCase().includes("activation")) {
                        item.current_activation_reps = item.activation_reps_start || item.reps; 
                        item.completed_mini_sets = 0; 
                    }
                }
            });
            currentItemIndex = 0; workoutStartTime = null; 
            setState('idle'); 
            // Mise à jour des boutons de session PUSH/PULL/LEGS
            [navPushBtn, navPullBtn, navLegsBtn].forEach(btn => { if(btn) btn.classList.toggle('active', btn.dataset.sessionName === sessionName); });
            showMessage(`${session.nom_session || 'Session'} chargée. Prêt à commencer !`, 2500, "success");
            vibrate(); updateWorkoutInfo(); updateOverallWorkoutProgressDisplay(); clearInProgressState(); 
        }
        function resetCurrentWorkout() {
            if (currentWorkoutType) { if (confirm(`Réinitialiser l'entraînement ${currentWorkoutType} ? Toute progression non sauvegardée sera perdue.`)) {
                const sessionBaseName = [navPushBtn, navPullBtn, navLegsBtn].find(b => currentWorkoutType.startsWith(b.dataset.sessionName))?.dataset.sessionName;
                if (sessionBaseName) loadSession(sessionBaseName);
            } }
            else { currentItemIndex = 0; currentWorkoutPlan = []; workoutStartTime = null; setState('idle'); [navPushBtn, navPullBtn, navLegsBtn].forEach(btn => { if(btn)btn.classList.remove('active');}); showMessage("Entraînement réinitialisé.", 2000, "info"); }
            clearInProgressState(); updateOverallWorkoutProgressDisplay();
        }
        function saveInProgressState() {
            if (!isWorkoutActive || currentState === 'finished') { clearInProgressState(); return; }
            const stateToSave = { currentWorkoutType, currentWorkoutPlan: JSON.parse(JSON.stringify(currentWorkoutPlan)), currentItemIndex, timeLeft, prepareTimeLeft, workoutStartTime, currentState, previousState };
            localStorage.setItem(IN_PROGRESS_KEY, JSON.stringify(stateToSave));
        }
        function loadInProgressState() {
            const savedState = localStorage.getItem(IN_PROGRESS_KEY);
            if (savedState) {
                try {
                    const parsedState = JSON.parse(savedState);
                    if (parsedState.currentWorkoutType && parsedState.currentWorkoutPlan && parsedState.currentState && loadedFullProgram) {
                        if (confirm("Un entraînement était en cours. Voulez-vous le reprendre ?")) {
                            currentWorkoutType = parsedState.currentWorkoutType; currentWorkoutPlan = parsedState.currentWorkoutPlan; 
                            currentItemIndex = parsedState.currentItemIndex; timeLeft = parsedState.timeLeft; prepareTimeLeft = parsedState.prepareTimeLeft;
                            workoutStartTime = parsedState.workoutStartTime; previousState = parsedState.previousState || 'idle'; 
                            [navPushBtn, navPullBtn, navLegsBtn].forEach(btn => { if(btn) btn.classList.toggle('active', btn.dataset.sessionName === currentWorkoutType.split(" ")[0]); }); // Assumer que le nom de base est le premier mot
                            setState(parsedState.currentState); 
                            updateOverallWorkoutProgressDisplay(); 
                            showMessage("Entraînement repris.", 2500, "info"); return; 
                        }
                    }
                } catch (e) { console.error("Erreur parsing état en cours:", e); }
            } clearInProgressState(); 
        }
        function clearInProgressState() { localStorage.removeItem(IN_PROGRESS_KEY); }
        
        // == LOGIQUE DE L'HISTORIQUE == //
        // ... (fonctions renderHistoryList, calculateAndDisplayStats, renderHistoryChart, etc.)
        function displayHistory(period = 'week') {
            if (!googleAccessToken) { renderHistoryList([]); calculateAndDisplayStats([]); setChartPlaceholder('history-chart-canvas', "Connectez-vous pour voir l'historique."); if(historyFilterBtns) historyFilterBtns.forEach(b => b.classList.remove('active')); return; }
            currentHistoryPeriod = period; if(historyFilterBtns) historyFilterBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.period === period));
            const filteredHistory = filterHistoryByPeriod(workoutHistory, period);
            renderHistoryList(filteredHistory); calculateAndDisplayStats(filteredHistory); renderHistoryChart(filteredHistory);
        }
        function filterHistoryByPeriod(history, period) {
            if (!history) return []; const now = new Date(); let startDate = new Date();
            switch (period) {
                case 'week': startDate.setDate(now.getDate() - now.getDay() - (now.getDay() === 0 ? 6 : -1)); startDate.setHours(0,0,0,0); break;
                case 'month': startDate = new Date(now.getFullYear(), now.getMonth(), 1); startDate.setHours(0,0,0,0); break;
                case 'year': startDate = new Date(now.getFullYear(), 0, 1); startDate.setHours(0,0,0,0); break;
                case 'all': return history; default: return history;
            } return history.filter(item => new Date(item.date) >= startDate);
        }
        function renderHistoryList(filteredHistory) {
            if (!historyList) return; historyList.innerHTML = ''; 
            if (!googleAccessToken) { historyList.innerHTML = '<li class="no-history">Connectez-vous pour voir l\'historique.</li>'; return; }
            if (!filteredHistory || filteredHistory.length === 0) { historyList.innerHTML = '<li class="no-history">Aucun entraînement enregistré pour cette période.</li>'; return; }
            filteredHistory.sort((a, b) => new Date(b.date) - new Date(a.date)); 
            filteredHistory.forEach(item => {
                const li = document.createElement('li'); const itemDate = new Date(item.date);
                const dateString = itemDate.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' }); const timeString = itemDate.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                const totalReps = item.exercises?.reduce((sum, ex) => { let repsForEx = 0; if (ex.finalReps !== undefined && !isNaN(parseInt(ex.finalReps, 10))) repsForEx = parseInt(ex.finalReps, 10); else if (ex.finalDuration !== undefined && !isNaN(parseInt(ex.finalDuration,10))) repsForEx = 1; return sum + repsForEx; }, 0) || 0;
                const durationFormatted = formatTime(item.durationSeconds || 0);
                li.innerHTML = `<span class="history-item-date">${dateString} <small>${timeString}</small></span> <span class="history-item-type">${item.type}</span> <span class="history-item-reps"><i class="fas fa-running"></i> ${totalReps > 0 ? totalReps : '-'}</span> <span class="history-item-duration"><i class="fas fa-stopwatch"></i> ${durationFormatted}</span>`;
                historyList.appendChild(li);
            });
        }
        function calculateAndDisplayStats(filteredHistory) {
            if (!statsDisplay || !statsContentWrapper) return;
            if (!googleAccessToken) { statsContentWrapper.innerHTML = '<p>Connectez-vous pour voir les statistiques.</p>'; if (statsDisplay.querySelector('.motivational-message')) statsDisplay.querySelector('.motivational-message').textContent = ''; return; }
            const totalWorkouts = filteredHistory.length; const totalDuration = filteredHistory.reduce((sum, item) => sum + (item.durationSeconds || 0), 0);
            const avgDuration = totalWorkouts > 0 ? totalDuration / totalWorkouts : 0; let totalRepsAllWorkouts = 0;
            filteredHistory.forEach(workout => { workout.exercises?.forEach(ex => { if (ex.finalReps !== undefined && !isNaN(parseInt(ex.finalReps, 10))) totalRepsAllWorkouts += parseInt(ex.finalReps, 10); else if (ex.finalDuration !== undefined && !isNaN(parseInt(ex.finalDuration,10))) totalRepsAllWorkouts +=1; }); });
            statsContentWrapper.innerHTML = `<p><i class="fas fa-dumbbell"></i> Entraînements: <strong>${totalWorkouts}</strong></p> <p><i class="fas fa-stopwatch"></i> Temps total: <strong>${formatTime(totalDuration)}</strong></p> <p><i class="fas fa-clock"></i> Durée moyenne: <strong>${formatTime(avgDuration)}</strong></p> <p><i class="fas fa-running"></i> Répétitions totales: <strong>${totalRepsAllWorkouts > 0 ? totalRepsAllWorkouts : '-'}</strong></p>`;
            const motivationalMessageEl = statsDisplay.querySelector('.motivational-message');
            if (motivationalMessageEl) { if (totalWorkouts === 0) motivationalMessageEl.textContent = "Commencez votre premier entraînement !"; else if (totalWorkouts < 5) motivationalMessageEl.textContent = "Continuez comme ça, chaque séance compte !"; else motivationalMessageEl.textContent = "Quelle régularité, impressionnant !"; }
        }
        function aggregateChartData(hist, period, metric = 'durationSeconds') {
            if (!hist || hist.length === 0) return { labels: [], data: [] }; const dataMap = new Map();
            hist.forEach(item => { const itemDate = new Date(item.date); let key;
                if (period === 'week') { const dayIndex = itemDate.getDay(); const adjustedDayIndex = (dayIndex === 0) ? 6 : dayIndex -1; const days = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim']; key = days[adjustedDayIndex]; }
                else if (period === 'month') { const dayOfMonth = itemDate.getDate(); const weekNumber = Math.ceil(dayOfMonth / 7); key = `S${weekNumber}`; }
                else if (period === 'year') { const monthIndex = itemDate.getMonth(); const months = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Août', 'Sep', 'Oct', 'Nov', 'Déc']; key = months[monthIndex]; }
                else key = `${itemDate.getFullYear()}-${String(itemDate.getMonth() + 1).padStart(2, '0')}`; 
                const value = parseFloat(item[metric]) || 0; dataMap.set(key, (dataMap.get(key) || 0) + value);
            });
            let sortedLabels;
            if (period === 'week') { const dayOrder = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim']; sortedLabels = Array.from(dataMap.keys()).sort((a,b) => dayOrder.indexOf(a) - dayOrder.indexOf(b)); }
            else if (period === 'month') sortedLabels = Array.from(dataMap.keys()).sort((a,b) => parseInt(a.substring(1)) - parseInt(b.substring(1)));
            else if (period === 'year') { const monthOrder = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Août', 'Sep', 'Oct', 'Nov', 'Déc']; sortedLabels = Array.from(dataMap.keys()).sort((a,b) => monthOrder.indexOf(a) - monthOrder.indexOf(b)); }
            else sortedLabels = Array.from(dataMap.keys()).sort();
            const data = sortedLabels.map(label => dataMap.get(label) / (metric === 'durationSeconds' ? 60 : 1)); 
            return { labels: sortedLabels, data };
        }
        function getChartXAxisTitle(period){ switch(period){ case 'week': return 'Jour de la semaine'; case 'month': return 'Semaine du mois'; case 'year': return 'Mois'; case 'all': return 'Mois (sur tout l\'historique)'; default: return 'Période'; } }
        function renderHistoryChart(filteredHistory) {
            if (!historyChartCanvasEl) return; const { labels, data } = aggregateChartData(filteredHistory, currentHistoryPeriod, 'durationSeconds');
            if (labels.length === 0 || data.length === 0) { setChartPlaceholder('history-chart-canvas', "Pas de données pour afficher le graphique."); if (historyChartInstance) { historyChartInstance.destroy(); historyChartInstance = null; } return; }
            setChartPlaceholder('history-chart-canvas', "", false); const ctx = historyChartCanvasEl.getContext('2d'); if (historyChartInstance) historyChartInstance.destroy(); 
            const rootStyle = getComputedStyle(document.documentElement);
            historyChartInstance = new Chart(ctx, { type: 'bar', data: { labels: labels, datasets: [{ label: 'Durée Entraînement (minutes)', data: data, backgroundColor: `rgba(${rootStyle.getPropertyValue('--electric-cyan-rgb').trim()}, 0.6)`, borderColor: `rgb(${rootStyle.getPropertyValue('--electric-cyan-rgb').trim()})`, borderWidth: 1, borderRadius: 4, barPercentage: 0.7, categoryPercentage: 0.8 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: 'Minutes', color: rootStyle.getPropertyValue('--secondary-text-color-dark').trim() }, ticks: { color: rootStyle.getPropertyValue('--secondary-text-color-dark').trim() }, grid: { color: `rgba(${rootStyle.getPropertyValue('--electric-blue-rgb').trim()}, 0.1)` } }, x: { title: { display: true, text: getChartXAxisTitle(currentHistoryPeriod), color: rootStyle.getPropertyValue('--secondary-text-color-dark').trim() }, ticks: { color: rootStyle.getPropertyValue('--secondary-text-color-dark').trim() }, grid: { display: false } } }, plugins: { legend: { display: false }, tooltip: { backgroundColor: `rgba(${rootStyle.getPropertyValue('--secondary-bg-color-dark-rgb').trim()}, 0.9)`, titleColor: rootStyle.getPropertyValue('--primary-text-color-dark').trim(), bodyColor: rootStyle.getPropertyValue('--primary-text-color-dark').trim(), callbacks: { label: function(context) { return `${context.dataset.label}: ${context.parsed.y.toFixed(0)} min`; } } } } } });
        }
        function updateChartColors() {
            if (historyChartInstance) {
                const rootStyle = getComputedStyle(document.documentElement);
                historyChartInstance.data.datasets[0].backgroundColor = `rgba(${rootStyle.getPropertyValue('--electric-cyan-rgb').trim()}, 0.6)`; historyChartInstance.data.datasets[0].borderColor = `rgb(${rootStyle.getPropertyValue('--electric-cyan-rgb').trim()})`;
                historyChartInstance.options.scales.y.title.color = rootStyle.getPropertyValue('--secondary-text-color-dark').trim(); historyChartInstance.options.scales.y.ticks.color = rootStyle.getPropertyValue('--secondary-text-color-dark').trim(); historyChartInstance.options.scales.y.grid.color = `rgba(${rootStyle.getPropertyValue('--electric-blue-rgb').trim()}, 0.1)`;
                historyChartInstance.options.scales.x.title.color = rootStyle.getPropertyValue('--secondary-text-color-dark').trim(); historyChartInstance.options.scales.x.ticks.color = rootStyle.getPropertyValue('--secondary-text-color-dark').trim();
                historyChartInstance.options.plugins.tooltip.backgroundColor = `rgba(${rootStyle.getPropertyValue('--secondary-bg-color-dark-rgb').trim()}, 0.9)`; historyChartInstance.options.plugins.tooltip.titleColor = rootStyle.getPropertyValue('--primary-text-color-dark').trim(); historyChartInstance.options.plugins.tooltip.bodyColor = rootStyle.getPropertyValue('--primary-text-color-dark').trim();
                historyChartInstance.update();
            }
        }
        function clearCharts() { if (historyChartInstance) { historyChartInstance.destroy(); historyChartInstance = null; } }
        function setChartPlaceholder(canvasId, message, show = true) { const placeholderId = canvasId.replace('-canvas', '-placeholder'); const placeholderEl = document.getElementById(placeholderId); const canvasEl = document.getElementById(canvasId); if (placeholderEl && canvasEl) { placeholderEl.textContent = message; placeholderEl.style.display = show ? 'block' : 'none'; canvasEl.style.opacity = show ? '0.2' : '1'; } }
        
        function saveWorkoutToHistory() {
            if (!currentWorkoutType || !workoutStartTime || !originalCompletedWorkoutPlan || originalCompletedWorkoutPlan.length === 0) return;
            const endTime = Date.now(); const durationSeconds = (endTime - workoutStartTime) / 1000;
            const exercisesForHistory = originalCompletedWorkoutPlan
                .filter(item => item.type === 'exercise' || item.type?.startsWith('exercise_'))
                .map(ex => {
                    return { 
                        name: ex.name, 
                        type: ex.type, 
                        reps_target: ex.reps_text || (ex.duration !== undefined ? ex.duration : ex.reps),
                        reps_unit: ex.reps_unit,
                        unit_duration: ex.unit_duration,
                        weight_description_target: getFormattedWeight(ex),
                        
                        finalReps: ex.duration !== undefined ? undefined : (ex.finalReps !== undefined ? ex.finalReps : ex.reps),
                        finalDuration: ex.duration !== undefined ? (ex.finalDuration !== undefined ? ex.finalDuration : ex.duration) : undefined,
                        finalWeightDescription: ex.finalWeightDescription !== undefined ? ex.finalWeightDescription : getFormattedWeight(ex),
                        finalProgressionNote: ex.finalProgressionNote !== undefined ? ex.finalProgressionNote : (ex.progression_note || ""),
                        
                        image_url: ex.image_url,
                        sets_info: ex.sets_info,
                        details_original: ex.details 
                    };
                });
            const historyEntry = { date: new Date().toISOString(), type: currentWorkoutType, durationSeconds: durationSeconds, exercises: exercisesForHistory };
            workoutHistory.push(historyEntry);
        }

        // == LOGIQUE DE L'ÉDITEUR == //
        function populateEditorTabs() {
            if (!programTabsContainer || !loadedFullProgram || !loadedFullProgram.sessions) return;
            programTabsContainer.innerHTML = ''; // Vider les onglets existants
            loadedFullProgram.sessions.forEach(session => {
                const tabButton = document.createElement('button');
                tabButton.dataset.sessionName = session.nom_session;
                tabButton.textContent = session.nom_session.split(" ")[0]; // Utiliser seulement PUSH/PULL/LEGS
                tabButton.disabled = !programsLoaded;
                tabButton.addEventListener('click', () => handleEditorTabClick(session.nom_session));
                programTabsContainer.appendChild(tabButton);
            });
        }

        function handleEditorTabClick(sessionName) { 
            initAudioContext(); 
            if (!programsLoaded || !loadedFullProgram) return; 
            if (!sessionName && loadedFullProgram.sessions && loadedFullProgram.sessions.length > 0) { sessionName = loadedFullProgram.sessions[0].nom_session; } 
            else if (!sessionName) { return; } 
            if (sessionName === currentEditingSessionName) return; 
            if (isDirty) { if (!confirm(`Vous avez des modifications non sauvegardées pour la session "${currentEditingSessionName}". Voulez-vous continuer sans sauvegarder ?`)) { programTabsContainer.querySelectorAll('button').forEach(btn => { btn.classList.toggle('active', btn.dataset.sessionName === currentEditingSessionName); }); return; } } 
            displayProgramForEditor(sessionName); 
        }

        function displayProgramForEditor(sessionName) { 
            if (!programDisplay) { console.error("Élément #program-display non trouvé."); return; }
            if (!loadedFullProgram || !loadedFullProgram.sessions) { 
                programDisplay.innerHTML = `<li style="text-align:center; padding:20px; color:var(--secondary-text-color);">Aucun programme chargé.</li>`; 
                currentEditingSessionName = null; markAsDirty(false); updateEditorActionButtonsState(); return;
            }
            const sessionToDisplay = loadedFullProgram.sessions.find(s => s.nom_session === sessionName);
            if (!sessionToDisplay) { 
                programDisplay.innerHTML = `<li style="text-align:center; padding:20px; color:var(--secondary-text-color);">Session '${sessionName}' non trouvée.</li>`; 
                currentEditingSessionName = null; markAsDirty(false); updateEditorActionButtonsState(); return;
            }
            currentEditingSessionName = sessionName; programDisplay.innerHTML = ''; 
            programTabsContainer.querySelectorAll('button').forEach(btn => { btn.classList.toggle('active', btn.dataset.sessionName === sessionName); btn.disabled = !programsLoaded; }); 
            if (sessionToDisplay.exercices_et_pauses && sessionToDisplay.exercices_et_pauses.length > 0) {
                sessionToDisplay.exercices_et_pauses.forEach((step, index) => { const stepElement = renderStepForEditor(step, index, sessionName); programDisplay.appendChild(stepElement); });
            } else { programDisplay.innerHTML = `<li style="text-align:center; padding:20px; color:var(--secondary-text-color);">Cette session est vide. Ajoutez des étapes !</li>`; }
            markAsDirty(false); updateEditorActionButtonsState(); 
            if (sortableInstance) sortableInstance.destroy(); 
            if(programDisplay) sortableInstance = new Sortable(programDisplay, { animation: 150, ghostClass: 'sortable-ghost', chosenClass: 'sortable-chosen', handle: '.program-step', onEnd: handleDragEndEditor }); 
        }

        function renderStepForEditor(step, index, sessionNameForDataset) { 
            const li = document.createElement('li'); li.classList.add('program-step', `${step.type}-step`); li.dataset.index = index; li.dataset.session = sessionNameForDataset;
            const isExercise = step.type === 'exercise' || step.type?.startsWith('exercise_'); 
            const defaultColorForNewExercise = stepColorPalette[0];
            const currentStepColor = step.step_color || defaultColorForNewExercise;
            li.style.borderLeftColor = isExercise ? currentStepColor : 'var(--neon-yellow)';
            
            const iconClass = isExercise ? 'fa-dumbbell' : 'fa-hourglass-half'; 
            let iconHtml = `<i class="fas ${iconClass} step-icon" style="color: ${isExercise ? currentStepColor : 'var(--neon-yellow)'};" aria-hidden="true"></i>`;

            const commonFields = ` <div class="step-field"> <label for="name-${index}">Nom</label> <input type="text" id="name-${index}" data-field="name" value="${step.name ?? ''}" ${!isExercise && step.name === 'Repos' ? 'readonly' : ''}> </div> <div class="step-field" style="grid-column: 1 / -1;"> <label for="details-${index}">Détails</label> <textarea id="details-${index}" data-field="details" placeholder="Infos supplémentaires...">${step.details || ''}</textarea> </div>`;
            let exerciseSpecificFields = '';
            let colorPaletteHtml = '';

            if (isExercise) {
                exerciseSpecificFields = `
                    <div class="step-field"> <label for="reps-${index}">Reps</label> <input type="text" id="reps-${index}" data-field="reps_text" value="${step.reps_text || step.reps || ''}" placeholder="Ex: 10-12 ou 30s"> </div>
                    <div class="step-field"> <label for="unit-${index}">Unité/Poids</label> <input type="text" id="unit-${index}" data-field="unit" value="${step.unit || ''}" placeholder="kg, PDC, Élastique Rouge"> </div>
                    <div class="step-field"> <label for="sets_info-${index}">Info Séries (optionnel)</label> <input type="text" id="sets_info-${index}" data-field="sets_info" value="${step.sets_info || ''}" placeholder="Ex: 3ème série sur 4"> </div>
                    <div class="step-field"> <label for="image_url-${index}">URL Image</label> <input type="text" id="image_url-${index}" data-field="image_url" value="${step.image_url || ''}" placeholder="https://..."> </div>
                    <div class="step-field" style="grid-column: 1 / -1;"> <label for="progression_note-${index}">Note Progression</label> <textarea id="progression_note-${index}" data-field="progression_note" placeholder="Comment progresser...">${step.progression_note || ''}</textarea> </div>
                `;
                colorPaletteHtml = `<div class="step-field color-palette-container" style="grid-column: 1 / -1;"><label>Couleur de l'étape</label><div class="color-palette">`;
                stepColorPalette.forEach(color => {
                    colorPaletteHtml += `<span class="color-swatch ${color === currentStepColor ? 'active' : ''}" style="background-color: ${color};" data-color="${color}" title="${color}"></span>`;
                });
                colorPaletteHtml += `</div></div>`;
            } else { 
                exerciseSpecificFields = ` <div class="step-field"> <label for="duration-${index}">Durée (secs)</label> <input type="number" id="duration-${index}" data-field="duration" value="${step.duration ?? ''}" min="1" step="1" placeholder="Ex: 75"> </div> `; 
            }
            li.innerHTML = ` ${iconHtml} <div class="step-content"> ${commonFields} ${exerciseSpecificFields} ${colorPaletteHtml} </div> <div class="step-actions"> <button class="delete-step-btn" title="Supprimer l'étape" aria-label="Supprimer l'étape ${index + 1}"><i class="fas fa-trash-alt"></i></button> </div> `; 
            li.querySelector('.delete-step-btn').addEventListener('click', () => handleDeleteStepEditor(index)); 
            li.querySelectorAll('input, textarea, select').forEach(input => { input.addEventListener('input', () => markAsDirty(true)); input.addEventListener('change', (event) => handleEditStepEditor(parseInt(li.dataset.index, 10), event.target.dataset.field, event.target.value)); }); 
            li.querySelectorAll('.color-swatch').forEach(swatch => { swatch.addEventListener('click', (event) => handleColorChangeEditor(index, event.target.dataset.color)); });
            return li; 
        }

        function handleColorChangeEditor(stepIndex, newColor) {
            if (!currentEditingSessionName || !loadedFullProgram || !loadedFullProgram.sessions) return;
            const currentSession = loadedFullProgram.sessions.find(s => s.nom_session === currentEditingSessionName);
            if (!currentSession || !currentSession.exercices_et_pauses || stepIndex < 0 || stepIndex >= currentSession.exercices_et_pauses.length) return;
            const step = currentSession.exercices_et_pauses[stepIndex];
            if (step.type === 'exercise' || step.type?.startsWith('exercise_')) {
                step.step_color = newColor;
                markAsDirty(true);
                displayProgramForEditor(currentEditingSessionName); 
            }
        }

        function handleAddStep(stepType) { 
            initAudioContext(); if (!currentEditingSessionName || !loadedFullProgram || !loadedFullProgram.sessions) return; 
            const currentSession = loadedFullProgram.sessions.find(s => s.nom_session === currentEditingSessionName); if (!currentSession) return; 
            let newStep = {}; 
            if (stepType === 'exercise') newStep = { type: "exercise", name: "Nouvel Exercice", reps_text: "10", unit: "kg", details: "", image_url: "", progression_note: "", step_color: stepColorPalette[0] }; 
            else newStep = { type: "break", duration: 60, name: "Repos", details: "" }; 
            if (!currentSession.exercices_et_pauses) currentSession.exercices_et_pauses = []; 
            currentSession.exercices_et_pauses.push(newStep); 
            displayProgramForEditor(currentEditingSessionName); markAsDirty(true); 
            if(programDisplay) programDisplay.scrollTop = programDisplay.scrollHeight; 
            showMessage(`${stepType === 'exercise' ? 'Exercice' : 'Pause'} ajouté(e).`, 1500, "success"); 
        }

        function handleDeleteStepEditor(index) { 
            initAudioContext(); if (!currentEditingSessionName || !loadedFullProgram || !loadedFullProgram.sessions) return; 
            const currentSession = loadedFullProgram.sessions.find(s => s.nom_session === currentEditingSessionName); 
            if (!currentSession || !currentSession.exercices_et_pauses || index < 0 || index >= currentSession.exercices_et_pauses.length) return; 
            const stepToDelete = currentSession.exercices_et_pauses[index]; 
            if (confirm(`Êtes-vous sûr de vouloir supprimer l'étape "${stepToDelete.name || 'Pause'}" ?`)) { currentSession.exercices_et_pauses.splice(index, 1); displayProgramForEditor(currentEditingSessionName); markAsDirty(true); showMessage("Étape supprimée.", 1500, "info"); } 
        }
        function handleEditStepEditor(index, field, value) { 
            if (!currentEditingSessionName || !loadedFullProgram || !loadedFullProgram.sessions) return; 
            const currentSession = loadedFullProgram.sessions.find(s => s.nom_session === currentEditingSessionName); 
            if (!currentSession || !currentSession.exercices_et_pauses || index < 0 || index >= currentSession.exercices_et_pauses.length) return; 
            const step = currentSession.exercices_et_pauses[index]; 
            const numericFields = ['reps', 'weight', 'duration']; let processedValue = value; 
            if (numericFields.includes(field)) processedValue = value.trim() === '' ? null : (isNaN(Number(value)) ? value : Number(value)); 
            if(step.type === 'break' && field === 'name' && value.trim() === '') { processedValue = "Repos"; const inputElement = programDisplay.querySelector(`li[data-index="${index}"] #name-${index}`); if (inputElement) inputElement.value = "Repos"; } 
            step[field] = processedValue; markAsDirty(true); 
        }
        function handleDragEndEditor(event) { 
            if (!currentEditingSessionName || !loadedFullProgram || !loadedFullProgram.sessions) return; 
            const { oldIndex, newIndex } = event; if (oldIndex === newIndex) return; 
            const currentSession = loadedFullProgram.sessions.find(s => s.nom_session === currentEditingSessionName); 
            if (!currentSession || !currentSession.exercices_et_pauses) return; 
            const itemToMove = currentSession.exercices_et_pauses.splice(oldIndex, 1)[0]; 
            currentSession.exercices_et_pauses.splice(newIndex, 0, itemToMove); 
            displayProgramForEditor(currentEditingSessionName); markAsDirty(true); 
        }
        async function handleSaveProgram() { 
            initAudioContext(); if (!googleAccessToken || !programFileId) { showMessage("Connexion Drive ou ID de fichier programme manquant.", 4000, "error"); return; } 
            if (!isDirty) { showMessage("Aucune modification à sauvegarder.", 2000, "info"); return; } 
            if (!loadedFullProgram) { showMessage("Aucun programme chargé à sauvegarder.", 3000, "error"); return; } 
            console.log(`Sauvegarde du programme global sur Drive...`); showMessage(`Sauvegarde du programme en cours...`, 2000, "info"); 
            if(saveProgramBtn) { saveProgramBtn.disabled = true; saveProgramBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Sauvegarde...`; } 
            const success = await updateFileContent(programFileId, loadedFullProgram); 
            if(saveProgramBtn) { saveProgramBtn.innerHTML = `<i class="fas fa-save"></i> Sauvegarder Programme`; } 
            if (success) { markAsDirty(false); showMessage(`Programme sauvegardé sur Drive !`, 3000, "success"); } 
            else { showMessage(`Échec de la sauvegarde. Veuillez réessayer.`, 5000, "error"); if(saveProgramBtn) saveProgramBtn.disabled = false; } 
        }
        function markAsDirty(dirtyState) { 
            isDirty = dirtyState; updateSaveButtonState(); 
            const currentTab = programTabsContainer?.querySelector(`button[data-session-name="${currentEditingSessionName}"]`); 
            if (currentTab) currentTab.classList.toggle('is-dirty', dirtyState); 
        }
        function updateSaveButtonState() { if (!saveProgramBtn) return; saveProgramBtn.disabled = !isDirty || !googleAccessToken || !programFileId ; if(saveProgramBtn.disabled && isDirty) { saveProgramBtn.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Sauvegarde Bloquée`; } else if (isDirty) { saveProgramBtn.innerHTML = `<i class="fas fa-save"></i> Sauvegarder Programme`; } else { saveProgramBtn.innerHTML = `<i class="fas fa-check"></i> À Jour`; } }
        function updateEditorActionButtonsState() { const enable = googleAccessToken && programsLoaded && !!currentEditingSessionName && loadedFullProgram && loadedFullProgram.sessions && loadedFullProgram.sessions.length > 0; if(addExerciseBtn) addExerciseBtn.disabled = !enable; if(addBreakBtn) addBreakBtn.disabled = !enable; updateSaveButtonState(); }

        // == POPUP POST-WORKOUT == //
        // ... (fonctions populateAndShowSummary, finishSummary, closeSummary)
        // Les fonctions du popup sont nécessaires pour la partie Timer

        function populateAndShowSummary() {
            if (!postWorkoutSummary || !summaryItemsList || !summaryTitle) return;
            summaryTitle.textContent = `Résumé: ${currentWorkoutType || 'Entraînement'}`; summaryItemsList.innerHTML = ''; 
            
            originalCompletedWorkoutPlan.forEach((item, index) => {
                if (item.type === 'exercise' || item.type?.startsWith('exercise_')) {
                    const li = document.createElement('li'); li.classList.add('summary-item');
                    
                    let initialRepsForInput;
                    if (item.duration !== undefined) { 
                        initialRepsForInput = item.duration; 
                    } else { 
                        initialRepsForInput = item.current_reps !== undefined ? item.current_reps : (item.reps !== undefined ? item.reps : 0);
                        if (item.type.includes("myo_reps") && item.name.toLowerCase().includes("activation")) {
                            initialRepsForInput = item.current_activation_reps !== undefined ? item.current_activation_reps : (item.activation_reps_start || item.reps);
                        }
                    }
                    
                    let initialWeightDesc = getFormattedWeight(item);
                    if (initialWeightDesc === "-") initialWeightDesc = item.unit || "PDC";

                    const progressionNoteText = item.progression_note || "";

                    const repsInputId = `summary-reps-${index}`;
                    const weightInputId = `summary-weight-${index}`;
                    const progressionNoteInputId = `summary-progression-note-${index}`;
                    
                    let repsLabel = "Reps";
                    if (item.reps_unit) repsLabel += ` (${item.reps_unit})`;
                    else if (item.duration !== undefined && item.unit_duration) repsLabel = `Durée (${item.unit_duration})`;
                    else if (item.duration !== undefined) repsLabel = `Durée (s)`;

                    li.innerHTML = `
                        <div class="exercise-name"><i class="fas ${getIconForType(item.type)}"></i> ${item.name}</div>
                        <div class="fields-grid">
                            <div class="input-group">
                                <label for="${repsInputId}">${repsLabel}</label>
                                <input type="number" id="${repsInputId}" value="${initialRepsForInput}" min="0" step="1">
                            </div>
                            <div class="input-group">
                                <label for="${weightInputId}">Poids/Résistance</label>
                                <input type="text" id="${weightInputId}" value="${initialWeightDesc}">
                            </div>
                            <div class="input-group notes-group">
                                <label for="${progressionNoteInputId}">Note de Progression (Programme)</label>
                                <textarea id="${progressionNoteInputId}" placeholder="Sera mis à jour dans le programme...">${progressionNoteText}</textarea>
                            </div>
                        </div>`;
                    summaryItemsList.appendChild(li);
                }
            });
            postWorkoutSummary.classList.add('visible');
        }

        async function finishSummary() {
            if (!finishSummaryBtn) return; 
            finishSummaryBtn.disabled = true; finishSummaryBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Sauvegarde...`;
            
            const latestWorkoutEntry = workoutHistory[workoutHistory.length - 1];
            if (!latestWorkoutEntry || !latestWorkoutEntry.exercises) { 
                closeSummary(); showMessage("Erreur: Données d'historique invalides.", 4000, "error"); 
                if(finishSummaryBtn) { finishSummaryBtn.disabled = false; finishSummaryBtn.innerHTML = `<i class="fas fa-check"></i> Fin & Sauvegarder`; } return; 
            }
            
            let originalPlanExerciseActualIndex = 0; 
            
            for (let i = 0; i < latestWorkoutEntry.exercises.length; i++) { 
                let correspondingOriginalExercise = null;
                let exerciseCountInOriginalPlan = 0; 

                for(let k=0; k < originalCompletedWorkoutPlan.length; k++) {
                    if (originalCompletedWorkoutPlan[k].type === 'exercise' || originalCompletedWorkoutPlan[k].type?.startsWith('exercise_')) {
                        if (exerciseCountInOriginalPlan === i) { 
                            correspondingOriginalExercise = originalCompletedWorkoutPlan[k];
                            originalPlanExerciseActualIndex = k; 
                            break;
                        }
                        exerciseCountInOriginalPlan++;
                    }
                }

                if (correspondingOriginalExercise) {
                    const repsInput = document.getElementById(`summary-reps-${originalPlanExerciseActualIndex}`); 
                    const weightInput = document.getElementById(`summary-weight-${originalPlanExerciseActualIndex}`);
                    const progressionNoteInput = document.getElementById(`summary-progression-note-${originalPlanExerciseActualIndex}`);

                    if (repsInput) {
                        const finalRepsOrDuration = parseInt(repsInput.value, 10);
                        if (!isNaN(finalRepsOrDuration)) {
                            if (correspondingOriginalExercise.duration !== undefined) { 
                                latestWorkoutEntry.exercises[i].finalDuration = finalRepsOrDuration;
                                correspondingOriginalExercise.duration = finalRepsOrDuration;
                                if (correspondingOriginalExercise.duration_start !== undefined) correspondingOriginalExercise.duration_start = finalRepsOrDuration;
                            } else { 
                                latestWorkoutEntry.exercises[i].finalReps = finalRepsOrDuration;
                                correspondingOriginalExercise.reps = finalRepsOrDuration; 
                                if (correspondingOriginalExercise.reps_start !== undefined) correspondingOriginalExercise.reps_start = finalRepsOrDuration;
                                if (correspondingOriginalExercise.type.includes("myo_reps") && correspondingOriginalExercise.name.toLowerCase().includes("activation")) {
                                    correspondingOriginalExercise.activation_reps_start = finalRepsOrDuration;
                                }
                            }
                        }
                    }
                    if (weightInput) {
                        const finalWeightDesc = weightInput.value.trim();
                        latestWorkoutEntry.exercises[i].finalWeightDescription = finalWeightDesc;
                        if (correspondingOriginalExercise.unit && (correspondingOriginalExercise.unit.includes("kg") || correspondingOriginalExercise.unit.includes("Élastique") || correspondingOriginalExercise.unit.toLowerCase() === "pdc" || correspondingOriginalExercise.unit.startsWith("Résistance"))) {
                             correspondingOriginalExercise.unit = finalWeightDesc;
                        } else if (correspondingOriginalExercise.weight_text !== undefined) {
                            correspondingOriginalExercise.weight_text = finalWeightDesc;
                        } else { 
                            correspondingOriginalExercise.unit = finalWeightDesc; 
                        }
                    }
                    if (progressionNoteInput) {
                        const finalProgNote = progressionNoteInput.value.trim();
                        latestWorkoutEntry.exercises[i].finalProgressionNote = finalProgNote;
                        correspondingOriginalExercise.progression_note = finalProgNote;
                    }
                }
            }
            
            if (loadedFullProgram && loadedFullProgram.sessions) {
                const currentSessionInFullProgram = loadedFullProgram.sessions.find(s => s.nom_session === currentWorkoutType);
                if (currentSessionInFullProgram && currentSessionInFullProgram.exercices_et_pauses) {
                    currentSessionInFullProgram.exercices_et_pauses = JSON.parse(JSON.stringify(originalCompletedWorkoutPlan));
                     console.log(`Programme mis à jour localement: ${currentWorkoutType} avec nouvelles notes de progression.`);
                }
            }

            await saveHistoryToDrive(); 
            if (loadedFullProgram) await saveFullProgramToDrive(); 
            
            closeSummary(false); 
            const previouslyActiveWorkoutType = currentWorkoutType; 
            const sessionBaseNameToReload = [navPushBtn, navPullBtn, navLegsBtn].find(b => previouslyActiveWorkoutType.startsWith(b.dataset.sessionName))?.dataset.sessionName;
            setState('idle'); 
            if (sessionBaseNameToReload && loadedFullProgram) loadSession(sessionBaseNameToReload); 
            showMessage("Entraînement et programme (avec notes de progression) mis à jour sauvegardés !", 3500, "success");
            if(finishSummaryBtn) { finishSummaryBtn.disabled = false; finishSummaryBtn.innerHTML = `<i class="fas fa-check"></i> Fin & Sauvegarder`; }
        }
        function closeSummary(updateUIafter = true) { if(postWorkoutSummary) postWorkoutSummary.classList.remove('visible'); if (updateUIafter) setState('idle'); }


        // == GESTION DE L'APPLICATION (DOM, ÉVÉNEMENTS, NAVIGATION) == //

        function updateAuthUI(isLoggedIn) { 
            const body = document.body; body.classList.toggle('logged-in', isLoggedIn); body.classList.toggle('logged-out', !isLoggedIn); 
            if (connectionPrompt) connectionPrompt.style.display = isLoggedIn && programsLoaded && loadedFullProgram ? 'none' : 'block'; 
            if (programEditorArea) programEditorArea.style.display = isLoggedIn && programsLoaded && loadedFullProgram ? 'flex' : 'none'; 
            if(signInButton) signInButton.disabled = isLoggedIn || !tokenClient; 
            if(signInButtonPrompt) signInButtonPrompt.disabled = isLoggedIn || !tokenClient; 
            if(driveStatusElement && driveStatusTextElement) { 
                driveStatusElement.style.display = isLoggedIn ? 'inline-flex' : 'none'; 
                if (!isLoggedIn) driveStatusTextElement.textContent = 'Déconnecté';
                else if (driveStatusElement.classList.contains('loading')) driveStatusTextElement.textContent = 'Chargement...';
                else if (driveStatusElement.classList.contains('error')) driveStatusTextElement.textContent = 'Erreur Drive';
                else {driveStatusTextElement.textContent = 'Connecté'; driveStatusElement.classList.remove('loading', 'error'); driveStatusElement.classList.add('success'); }
            } 
            if (programTabsContainer) programTabsContainer.querySelectorAll('button').forEach(btn => { btn.disabled = !isLoggedIn || !programsLoaded || !loadedFullProgram; btn.classList.remove('is-dirty'); }); 
            if (!isLoggedIn || !programsLoaded || !loadedFullProgram) { 
                if(programDisplay) programDisplay.innerHTML = `<li style="text-align:center; padding:20px; color:var(--secondary-text-color);">Connectez-vous et chargez un programme pour commencer l'édition.</li>`; 
                currentEditingSessionName = null; isDirty = false; 
            } 
            updateEditorActionButtonsState(); 

            const isTimerUiActive = ['preparing', 'exercise', 'break', 'paused'].includes(currentState);
            if(navWorkoutBtn) navWorkoutBtn.disabled = false; // L'onglet Timer est toujours accessible
            if(navHistoryBtn) navHistoryBtn.disabled = isTimerUiActive;
            if(navEditorBtn) navEditorBtn.disabled = isTimerUiActive;
            
            [navPushBtn, navPullBtn, navLegsBtn].forEach(btn => {
                if(btn) btn.disabled = !(isLoggedIn && programsLoaded && loadedFullProgram && !isTimerUiActive);
            });
            
            if (currentState === 'idle') {
                const canStartWorkout = isLoggedIn && programsLoaded && loadedFullProgram && !!currentWorkoutType && currentWorkoutPlan && currentWorkoutPlan.length > 0;
                if(startPauseBtn) { startPauseBtn.disabled = !canStartWorkout; startPauseBtn.innerHTML = `<i class="fas fa-play"></i> Démarrer`; startPauseBtn.className = ''; }
            } else if (startPauseBtn) startPauseBtn.disabled = ['preparing', 'finished', 'exercise'].includes(currentState);
            if(prevBtn) prevBtn.disabled = !(isTimerUiActive && currentItemIndex > 0);
            if(finishBtn) finishBtn.disabled = !isTimerUiActive;
            if(resetBtn) resetBtn.disabled = !isTimerUiActive && !isLoggedIn; 

            updateEditorActionButtonsState();
            if (!historySection.classList.contains('section-hidden')) {
                displayHistory(currentHistoryPeriod); // Rafraîchir l'historique si la section est visible
            }
        }

        function initializeAllDOMReferences() {
            // Global
            messageArea = document.getElementById('message-area');
            signInButton = document.getElementById('signin-button'); 
            driveStatusElement = document.getElementById('drive-status');
            driveStatusTextElement = document.getElementById('drive-status-text');
            navWorkoutBtn = document.getElementById('nav-workout');
            navHistoryBtn = document.getElementById('nav-history');
            navEditorBtn = document.getElementById('nav-editor');

            // Timer
            workoutSection = document.getElementById('workout-section');
            timeDisplayDiv = document.getElementById('time-left'); 
            currentExerciseContainer = document.getElementById('current-exercise-container');
            progressTracker = document.getElementById('progress-tracker'); 
            startPauseBtn = document.getElementById('start-pause-btn'); 
            skipBtn = document.getElementById('skip-btn'); 
            finishBtn = document.getElementById('finish-btn');
            resetBtn = document.getElementById('reset-btn'); 
            prevBtn = document.getElementById('prev-btn'); 
            postWorkoutSummary = document.getElementById('post-workout-summary'); 
            summaryTitle = document.getElementById('summary-title');
            summaryItemsList = document.getElementById('summary-items-list'); 
            finishSummaryBtn = document.getElementById('finish-summary-btn'); 
            currentExerciseNameDisplay = document.getElementById('current-exercise-name-display'); 
            driveConnectionStatusMain = document.getElementById('drive-connection-status-main');
            driveConnectionText = document.getElementById('drive-connection-text'); 
            timerDisplayElement = document.querySelector('.timer-display'); 
            reactorElement = document.querySelector('.reactor');
            exerciseImageContainer = document.getElementById('exercise-image-container'); 
            exerciseImageDisplay = document.getElementById('exercise-image-display'); 
            progressTextArea = document.getElementById('progress-text-area');
            timerProgressIndicator = document.getElementById('timer-progress-indicator'); 
            workoutStepTotalDisplay = document.getElementById('workout-step-total-display');
            workoutStepCurrentDisplay = document.getElementById('workout-step-current-display');
            workoutStepInfoDisplay = document.getElementById('workout-step-info-display');
            navPushBtn = document.getElementById('nav-push');
            navPullBtn = document.getElementById('nav-pull');
            navLegsBtn = document.getElementById('nav-legs');

            // Historique
            historySection = document.getElementById('history-section');
            historyList = document.getElementById('history-list');
            statsDisplay = document.getElementById('stats-display');
            statsContentWrapper = statsDisplay?.querySelector('.content-wrapper');
            historyFilterBtns = Array.from(document.querySelectorAll('.history-filters button'));
            historyChartCanvasEl = document.getElementById('history-chart-canvas');
            historyDriveStatus = document.getElementById('history-drive-status');
            historyActionsContainer = document.querySelector('.history-actions');

            // Éditeur
            editorSection = document.getElementById('editor-section');
            signInButtonPrompt = document.getElementById('signin-button-prompt');
            connectionPrompt = document.getElementById('connection-prompt'); 
            programEditorArea = document.getElementById('program-editor-area');
            programTabsContainer = document.getElementById('program-tabs'); 
            programDisplay = document.getElementById('program-display');
            addExerciseBtn = document.getElementById('add-exercise-btn'); 
            addBreakBtn = document.getElementById('add-break-btn');
            saveProgramBtn = document.getElementById('save-program-btn');
        }
        function addAllEventListeners() {
            navWorkoutBtn.addEventListener('click', () => showSection('workout-section'));
            navHistoryBtn.addEventListener('click', () => showSection('history-section'));
            navEditorBtn.addEventListener('click', () => showSection('editor-section'));
            
            signInButton.addEventListener('click', handleAuthClick);
            signInButtonPrompt.addEventListener('click', handleAuthClick);

            startPauseBtn.addEventListener('click', () => { initAudioContext(); if (currentState === 'idle') setState('preparing'); else if (currentState === 'break') setState('paused'); else if (currentState === 'paused') { const currentPausedItem = currentWorkoutPlan[currentItemIndex]; setState((currentPausedItem?.type === 'exercise' || currentPausedItem?.type?.startsWith('exercise_')) ? 'exercise' : 'break'); } });
            timerDisplayElement.addEventListener('click', () => { initAudioContext(); if (isWorkoutActive && currentState === 'exercise' && currentState !== 'preparing' && currentState !== 'finished') handleItemCompletion(); else if (currentState === 'idle' && startPauseBtn && !startPauseBtn.disabled) setState('preparing'); });
            skipBtn.addEventListener('click', () => { initAudioContext(); if (isWorkoutActive) handleItemCompletion(); });
            prevBtn.addEventListener('click', () => { initAudioContext(); handlePreviousClick(); });
            finishBtn.addEventListener('click', () => { initAudioContext(); forceFinishWorkout(); });
            resetBtn.addEventListener('click', () => { initAudioContext(); resetCurrentWorkout(); });
            [navPushBtn, navPullBtn, navLegsBtn].forEach(btn => { if (btn) btn.addEventListener('click', () => { initAudioContext(); loadSession(btn.dataset.sessionName); }); });
            finishSummaryBtn.addEventListener('click', finishSummary);
            postWorkoutSummary.addEventListener('click', (e) => { if (e.target === postWorkoutSummary) finishSummary(); });

            historyFilterBtns.forEach(btn => { if(btn) btn.addEventListener('click', () => { initAudioContext(); displayHistory(btn.dataset.period); }); });
            
            addExerciseBtn.addEventListener('click', () => handleAddStep('exercise'));
            addBreakBtn.addEventListener('click', () => handleAddStep('break'));
            saveProgramBtn.addEventListener('click', handleSaveProgram);
            window.addEventListener('beforeunload', (event) => { if (isDirty) { event.preventDefault(); event.returnValue = ''; } });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            initializeAllDOMReferences(); 
            initSounds(); 
            addAllEventListeners(); 
            // loadSavedTheme(); // Si un système de thème local est nécessaire
            showSection('workout-section'); // Afficher la section Timer par défaut
            updateAuthUI(false); 
            checkAndInitGis(); 
            console.log("ArmorWorkout App Unifiée Initialisée (v.Finale Corrective).");
        });

    </script>
</body>
</html>
