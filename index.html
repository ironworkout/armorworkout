<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArmorWorkout - Ultimate Edition</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚡</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color-dark: #030712; 
            --secondary-bg-color-dark: #0B132B; 
            --primary-text-color-dark: #F0F4F8; 
            --secondary-text-color-dark: #A0AEC0; 
            --border-color-dark: #1E293B; 
            --electric-blue: #00BFFF; 
            --electric-cyan: #22D3EE; 
            --electric-blue-light: #4D94FF; 
            --glow-accent: #0AF; 
            --electric-blue-rgb: 0, 191, 255;
            --electric-cyan-rgb: 34, 211, 238;
            --glow-accent-rgb: 0, 170, 255;
            --secondary-bg-color-dark-rgb: 11, 19, 43;
            --bg-color-dark-rgb: 3, 7, 18;
            --neon-pink: #FF1493; 
            --neon-purple: #9400D3; 
            --neon-green: #39FF14; 
            --neon-red: #FF3131; 
            --neon-yellow: #FFF01F; 
            --neon-pink-rgb: 255, 20, 147;
            --neon-purple-rgb: 148, 0, 211;
            --neon-green-rgb: 57, 255, 20;
            --neon-red-rgb: 255, 49, 49;
            --neon-yellow-rgb: 255, 240, 31;
            --glow-red: 0 0 8px var(--neon-red), 0 0 12px rgba(var(--neon-red-rgb),0.7);
            --glow-green: 0 0 8px var(--neon-green), 0 0 12px rgba(var(--neon-green-rgb),0.7);
            --glow-yellow: 0 0 8px var(--neon-yellow), 0 0 12px rgba(var(--neon-yellow-rgb),0.7);
            --glow-pink: 0 0 8px var(--neon-pink), 0 0 12px rgba(var(--neon-pink-rgb),0.7);
            --glow-purple: 0 0 8px var(--neon-purple), 0 0 12px rgba(var(--neon-purple-rgb),0.7);
            --electric-yellow: var(--neon-yellow); 
            --electric-yellow-rgb: var(--neon-yellow-rgb);
            --exercise-color-val: var(--electric-blue-light);
            --exercise-timed-color-val: var(--electric-yellow);
            --break-color-val: var(--electric-cyan);
            --paused-color-val: #A78BFA; 
            --finished-color-val: var(--neon-green);
            --completed-color-val: var(--neon-green);
            --preparing-color-val: var(--electric-cyan);
            --get-ready-color-val: var(--neon-purple);
            --idle-color-val: var(--electric-blue);
            --exercise-color-rgb: 77, 148, 255; 
            --exercise-timed-color-rgb: var(--neon-yellow-rgb);
            --break-color-rgb: var(--electric-cyan-rgb);
            --paused-color-rgb: 167, 139, 250;
            --finished-color-rgb: var(--neon-green-rgb);
            --completed-color-rgb: var(--neon-green-rgb);
            --preparing-color-rgb: var(--electric-cyan-rgb);
            --get-ready-color-rgb: var(--neon-purple-rgb);
            --idle-color-rgb: var(--electric-blue-rgb);
            --color-exercise: var(--exercise-color-val);
            --color-exercise-timed: var(--exercise-timed-color-val);
            --color-break: var(--break-color-val);
            --color-prepare: var(--preparing-color-val);
            --color-finished: var(--finished-color-val);
            --color-paused: var(--paused-color-val);
            --color-idle: var(--secondary-text-color-dark);
            --font-family-main: 'Inter', sans-serif;
            --font-family-timer: 'Orbitron', sans-serif;
            --font-family-titles: 'Orbitron', sans-serif; 
            --border-radius-lg: 10px;
            --border-radius-md: 8px;
            --border-radius-sm: 6px;
            --transition-speed: 0.3s;
            --section-transition-speed: 0.4s;
            --bg-color: var(--bg-color-dark);
            --secondary-bg-color: var(--secondary-bg-color-dark);
            --primary-text-color: var(--primary-text-color-dark);
            --secondary-text-color: var(--secondary-text-color-dark);
            --border-color: var(--border-color-dark);
            --accent-border-color: rgba(var(--electric-blue-rgb), 0.4); 
            --input-bg: #1A202C; 
            --current-timer-state-color: var(--idle-color-val);
            --current-timer-state-color-rgb: var(--idle-color-rgb);
            --timer-text-color-main: #FFFFFF;
            --timer-text-glow-main: 0 0 5px #fff, 
                                    0 0 8px #fff, 
                                    0 0 12px rgba(var(--electric-cyan-rgb), 0.6), 
                                    0 0 18px rgba(var(--electric-cyan-rgb), 0.4);
            --timer-progress-circle-color: var(--electric-cyan);
            --theme-color: var(--electric-cyan);
            --reactor-speed: 12s;
        }

        /* Styles spécifiques aux Ligues */
        body.league-1 { --theme-color: #CD7F32; --reactor-speed: 12s; }
        body.league-2 { --theme-color: #C0C0C0; --reactor-speed: 10s; }
        body.league-3 { --theme-color: #FFD700; --reactor-speed: 9s; }
        body.league-4 { --theme-color: #E5E4E2; --reactor-speed: 8s; }
        body.league-5 { --theme-color: #B9F2FF; --reactor-speed: 7s; }
        body.league-6 { --theme-color: #9400D3; --reactor-speed: 6s; }
        body.league-7 { --theme-color: #FF0000; --reactor-speed: 5s; }
        body.league-8 { --theme-color: #FF1493; --reactor-speed: 4s; }
        body.league-9 { --theme-color: #00FF00; --reactor-speed: 2s; }
        body.league-10 { --theme-color: #FFFFFF; --reactor-speed: 1s; }

        /* --- VIBRANIUM DESIGN SYSTEM --- */
        .vibranium-mastered {
            background: linear-gradient(135deg, rgba(11, 19, 43, 0.9) 0%, rgba(20, 0, 30, 0.95) 100%) !important;
            border: 1px solid var(--neon-purple) !important;
            box-shadow: 0 0 15px rgba(148, 0, 211, 0.3), inset 0 0 10px rgba(148, 0, 211, 0.1) !important;
            animation: vibraniumPulse 3s infinite ease-in-out;
            position: relative;
            overflow: hidden;
        }
        
        @keyframes vibraniumPulse {
            0% { box-shadow: 0 0 10px rgba(148, 0, 211, 0.3), inset 0 0 5px rgba(148, 0, 211, 0.1); border-color: var(--neon-purple); }
            50% { box-shadow: 0 0 25px rgba(148, 0, 211, 0.6), inset 0 0 15px rgba(148, 0, 211, 0.2); border-color: #D4AF37; } /* Gold Flash */
            100% { box-shadow: 0 0 10px rgba(148, 0, 211, 0.3), inset 0 0 5px rgba(148, 0, 211, 0.1); border-color: var(--neon-purple); }
        }

        .badge-vibranium {
            position: absolute; top: 10px; right: 10px;
            background: linear-gradient(45deg, #FFD700, #FDB931);
            color: #000; font-family: var(--font-family-titles); font-weight: 900; font-size: 0.7em;
            padding: 3px 8px; border-radius: 4px; box-shadow: 0 0 10px #FFD700;
            text-transform: uppercase; letter-spacing: 1px; z-index: 10; animation: shine 2s infinite;
        }
        @keyframes shine { 0% { filter: brightness(1); transform: scale(1); } 50% { filter: brightness(1.3); transform: scale(1.05); } 100% { filter: brightness(1); transform: scale(1); } }

        /* --- ANIMATIONS & BASE --- */
        @keyframes subtlePulse { 0%, 100% { opacity: 0.7; transform: scale(1); } 50% { opacity: 1; transform: scale(1.015); } }
        @keyframes electricBorder {
            0% { box-shadow: 0 0 6px rgba(var(--electric-cyan-rgb), 0.6), inset 0 0 4px rgba(var(--electric-cyan-rgb), 0.4); border-color: rgba(var(--electric-cyan-rgb), 0.7); }
            50% { box-shadow: 0 0 18px rgba(var(--electric-blue-rgb), 0.8), inset 0 0 10px rgba(var(--electric-blue-rgb), 0.6); border-color: rgba(var(--electric-blue-rgb), 0.9); }
            100% { box-shadow: 0 0 6px rgba(var(--electric-cyan-rgb), 0.6), inset 0 0 4px rgba(var(--electric-cyan-rgb), 0.4); border-color: rgba(var(--electric-cyan-rgb), 0.7); }
        }
        @keyframes textGlowPulseState {
            0%, 100% { text-shadow: 0 0 5px rgba(var(--current-timer-state-color-rgb), 0.7), 0 0 10px rgba(var(--current-timer-state-color-rgb), 0.5), 0 0 15px rgba(var(--current-timer-state-color-rgb), 0.3); }
            50% { text-shadow: 0 0 8px rgba(var(--current-timer-state-color-rgb), 0.9), 0 0 15px rgba(var(--current-timer-state-color-rgb), 0.7), 0 0 25px rgba(var(--current-timer-state-color-rgb), 0.5); }
        }
        @keyframes completed-pulse {
            0% { transform: scale(1); box-shadow: 0 0 10px 10px rgba(var(--completed-color-rgb), 0.2); }
            50% { transform: scale(1.05); box-shadow: 0 0 25px 25px rgba(var(--completed-color-rgb), 0.4); }
            100% { transform: scale(1); box-shadow: 0 0 10px 10px rgba(var(--completed-color-rgb), 0.2); }
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes chart-gold-pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4); } 70% { box-shadow: 0 0 0 20px rgba(255, 215, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); } }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; font-size: 16px; }
        body {
            font-family: var(--font-family-main); background-color: var(--bg-color); color: var(--primary-text-color); line-height: 1.65;
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease; display: flex; flex-direction: column;
            min-height: 100vh; -webkit-font-smoothing: antialiased; overflow-x: hidden;
            background-image: radial-gradient(ellipse at center, rgba(var(--electric-blue-rgb), 0.08) 0%, transparent 60%), linear-gradient(0deg, rgba(var(--bg-color-dark-rgb), 0.5) 0%, rgba(var(--bg-color-dark-rgb), 0.9) 100%);
            position: relative; 
        }
        body::before { 
            content: ""; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-image: linear-gradient(rgba(var(--electric-blue-rgb), 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(var(--electric-blue-rgb), 0.05) 1px, transparent 1px);
            background-size: 30px 30px; z-index: -1; opacity: 0.7;
        }
        
        body.workout-active { overflow: hidden; }
        body.workout-active header { transform: translateY(-100%); opacity: 0; visibility: hidden; transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out, visibility 0s linear 0.4s; }
        body.workout-active footer { display: none; }
        body.workout-active main { position: fixed; inset: 0; padding: 20px 0; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow-y: auto; z-index: 100; }
        body.workout-active .app-section:not(#workout-section) { display: none; }
        body.workout-active #workout-section { margin: auto 0; border: none; background: transparent; box-shadow: none; padding: 0; max-height: 100%; }

        .container { max-width: 1200px; margin: 0 auto; padding: 30px 25px; width: 100%; flex-grow: 1; display: flex; flex-direction: column; }
        
        header {
            padding: 15px 0; background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.5); backdrop-filter: blur(8px) saturate(150%);
            border-bottom: 1px solid rgba(var(--electric-blue-rgb), 0.3); box-shadow: 0 2px 15px rgba(var(--electric-blue-rgb), 0.1);
            position: sticky; top:0; z-index: 1000; 
            transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out, visibility 0s linear 0s; 
        }

        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; padding: 0 25px; flex-wrap: wrap; gap: 15px 20px; }
        header h1 { font-size: 1.6em; color: var(--primary-text-color); margin: 0; font-weight: 700; display: flex; align-items: center; gap: 10px; font-family: var(--font-family-titles); text-shadow: 0 0 8px rgba(var(--electric-cyan-rgb), 0.7); }
        header h1 i { color: var(--electric-cyan); animation: subtlePulse 3s infinite ease-in-out; }
        nav ul { list-style: none; display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; align-items: baseline; }
        nav button, nav a.nav-link {
            background: none; border: none; color: var(--secondary-text-color); font-size: 0.9em; font-weight: 500; padding: 8px 12px;
            cursor: pointer; text-decoration: none; transition: all var(--transition-speed) ease; position: relative;
            border-radius: var(--border-radius-sm); border: 1px solid transparent; display: inline-flex; align-items: center; gap: 6px;
        }
        nav button:hover, nav a.nav-link:hover:not(.disabled-link-look) { color: var(--primary-text-color); background-color: rgba(var(--electric-blue-rgb), 0.1); border-color: rgba(var(--electric-blue-rgb), 0.4); text-shadow: 0 0 5px rgba(var(--electric-blue-rgb), 0.5); }
        nav a.nav-link.disabled-link-look { opacity: 0.5; pointer-events: none; cursor: not-allowed; }
        nav button.active { color: var(--electric-cyan); font-weight: 600; background-color: rgba(var(--electric-cyan-rgb), 0.15); border-color: var(--electric-cyan); box-shadow: 0 0 10px rgba(var(--electric-cyan-rgb), 0.3); }
        nav button:disabled { color: rgba(156, 163, 175, 0.4); cursor: not-allowed; background-color: transparent !important; border-color: transparent !important; opacity: 0.6; pointer-events: none; }
        nav a.nav-link i, #edit-program-btn i { margin-right: 5px; }
        .header-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        #drive-status-text, #signin-button {
            background-color: transparent; border: 1px solid var(--border-color-dark); color: var(--secondary-text-color-dark);
            padding: 5px 12px; border-radius: var(--border-radius-md); font-size: 0.9em; font-weight: 500; cursor: pointer;
            transition: all var(--transition-speed) ease; display: inline-flex; align-items: center; gap: 5px;
        }
        #signin-button:disabled { opacity: 0.5; cursor: not-allowed; border-color: var(--border-color-dark) !important; color: var(--secondary-text-color-dark) !important; background-color: transparent !important; box-shadow: none !important; text-shadow: none !important; pointer-events: auto; }
        #drive-status-text:hover, #signin-button:not(:disabled):hover { border-color: var(--electric-blue); color: var(--electric-blue); background-color: rgba(var(--electric-blue-rgb), 0.1); }
        #drive-status.success #drive-status-text { border-color: var(--neon-green); color: var(--neon-green); cursor: default; }
        #drive-status.loading #drive-status-text { border-color: var(--neon-yellow); color: var(--neon-yellow); }
        #drive-status.error #drive-status-text { border-color: var(--neon-red); color: var(--neon-red); }
        #signin-button { border-color: var(--neon-green); color: var(--neon-green); }
        #drive-status { display: inline-flex; align-items: center; gap: 10px; margin-left: 10px; padding: 0; background: none; border: none; font-size: 1em; color: inherit; }
        body.logged-out #signin-button { display: inline-flex; } body.logged-out #drive-status { display: none; }
        body.logged-in #signin-button { display: none; } body.logged-in #drive-status { display: inline-flex; }
        
        main { flex-grow: 1; display: flex; flex-direction: column; align-items: center; padding-top: 40px; position: relative; transition: all 0.3s ease-in-out; }
        
        .app-section {
            background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.6); backdrop-filter: blur(10px) saturate(130%);
            border: 1px solid rgba(var(--electric-blue-rgb), 0.2); width: 100%; 
            transition: opacity var(--section-transition-speed) ease-in-out, transform 0.3s ease-in-out, visibility 0s linear var(--section-transition-speed);
            opacity: 1; visibility: visible; border-radius: var(--border-radius-lg);
            box-shadow: 0 5px 25px rgba(var(--bg-color-dark-rgb), 0.5), inset 0 0 15px rgba(var(--electric-blue-rgb), 0.1);
        }
        #home-section { padding: 0; background: transparent; border: none; box-shadow: none; backdrop-filter: none; }
        .home-grid { display: flex; flex-wrap: wrap; gap: 30px; width: 100%; }
        .home-main-content { flex: 1 1 60%; min-width: 300px; display: flex; flex-direction: column; gap: 25px; }
        .home-sidebar { flex: 1 1 35%; min-width: 280px; display: flex; flex-direction: column; gap: 25px; }

        .sidebar-module {
            background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.6); backdrop-filter: blur(10px) saturate(130%);
            padding: 20px; border: 1px solid rgba(var(--electric-blue-rgb), 0.2);
            border-radius: var(--border-radius-lg);
            box-shadow: 0 5px 25px rgba(var(--bg-color-dark-rgb), 0.5), inset 0 0 15px rgba(var(--electric-blue-rgb), 0.1);
            animation: fadeIn 0.5s ease-out forwards;
        }
        .sidebar-module h3, .sidebar-module h4 { font-family: var(--font-family-titles); color: var(--primary-text-color); font-size: 1.1em; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .sidebar-module h3 i, .sidebar-module h4 i { color: var(--theme-color); }
        .sidebar-module h4 { font-size: 1.0em; margin-top: 25px; margin-bottom: 10px; }
        
        .recent-workouts-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 12px; }
        .recent-workouts-list li { display: flex; justify-content: space-between; align-items: center; background-color: rgba(var(--bg-color-dark-rgb), 0.3); padding: 8px 12px; border-radius: var(--border-radius-sm); font-size: 0.9em; border-left: 3px solid var(--border-color); }
        .recent-workouts-list .workout-info-text .workout-name { color: var(--primary-text-color); font-weight: 500; }
        .recent-workouts-list .workout-info-text .workout-date { color: var(--secondary-text-color); font-size: 0.9em; display: block; }
        .delete-recent-workout-btn { background: none; border: none; color: var(--secondary-text-color); cursor: pointer; font-size: 1em; padding: 5px; border-radius: var(--border-radius-sm); transition: color 0.2s, background-color 0.2s; }
        .delete-recent-workout-btn:hover { color: var(--neon-red); background-color: rgba(var(--neon-red-rgb), 0.1); }

        .consistency-info { display: flex; flex-direction: column; gap: 12px; width: 100%; margin-bottom: 15px;}
        .consistency-text { font-size: 0.9em; color: var(--secondary-text-color); }
        .consistency-text strong { color: var(--primary-text-color); }
        .streak-counter { font-size: 1.1em; font-weight: 700; transition: color 0.5s ease; color: var(--theme-color); text-shadow: 0 0 10px var(--theme-color); }
        .streak-counter i { margin-right: 5px; }

        .calendar-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .calendar-nav button { background: none; border: none; color: var(--secondary-text-color); cursor: pointer; font-size: 1.2em; padding: 5px; border-radius: 50%; width: 30px; height: 30px; transition: background-color 0.2s, color 0.2s; }
        .calendar-nav button:hover { background-color: var(--border-color); color: var(--primary-text-color); }
        .calendar-title { font-weight: 500; font-family: var(--font-family-titles); }
        .monthly-calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .calendar-header { font-size: 0.8em; color: var(--secondary-text-color); padding-bottom: 5px; }
        .calendar-day { position: relative; font-size: 0.9em; padding: 5px 0; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; margin: 0 auto; transition: background-color 0.2s, border-color 0.2s, box-shadow 0.2s, color 0.2s; }
        .calendar-day.other-month { color: #4A5568; }
        .calendar-day.today { font-weight: 700; color: var(--electric-cyan); border: 1px solid var(--electric-cyan); box-shadow: 0 0 8px rgba(var(--electric-cyan-rgb), 0.5); background-color: rgba(var(--electric-cyan-rgb), 0.15); }
        .day-dot { position: absolute; bottom: 3px; left: 50%; transform: translateX(-50%); width: 8px; height: 8px; background-color: var(--electric-cyan); border-radius: 50%; box-shadow: 0 0 6px var(--electric-cyan), 0 0 10px rgba(var(--electric-cyan-rgb), 0.7); pointer-events: none; border: 1px solid rgba(255, 255, 255, 0.5); }
        .delete-workout-btn { position: absolute; top: -5px; right: -5px; color: var(--secondary-text-color); background-color: var(--secondary-bg-color); border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 0.8em; cursor: pointer; opacity: 0; visibility: hidden; transform: scale(0.8); transition: all 0.2s ease; border: 1px solid var(--border-color); z-index: 10; }
        .calendar-day:hover .delete-workout-btn { opacity: 1; visibility: visible; transform: scale(1); }
        .delete-workout-btn:hover { color: var(--neon-red); border-color: var(--neon-red); transform: scale(1.1) rotate(5deg); }

        .session-card-large {
            background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.7); border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg); transition: all 0.3s ease; 
            animation: fadeIn 0.5s ease-out forwards;
            position: relative;
            cursor: pointer;
        }
        .session-card-large:hover, .session-card-large.edit-mode-hover { border-color: var(--electric-cyan); transform: translateY(-3px); box-shadow: 0 8px 25px rgba(var(--electric-cyan-rgb), 0.15); }
        .session-card-large.edit-mode-active { border-color: var(--neon-yellow); box-shadow: 0 8px 25px rgba(var(--neon-yellow-rgb), 0.15); cursor: pointer; }
        .session-card-summary { padding: 20px; }
        .session-card-header { display: flex; justify-content: space-between; align-items: center; }
        .session-card-header h3 { font-family: var(--font-family-titles); color: var(--electric-cyan); font-size: 1.4em; margin: 0; text-shadow: 0 0 8px rgba(var(--electric-cyan-rgb), 0.5); }
        .session-card-header .last-session-info { font-size: 0.8em; font-style: italic; color: var(--secondary-text-color); opacity: 0.8; text-align: right; }
        .session-card-large p { font-size: 0.9em; color: var(--secondary-text-color); margin: 10px 0 0 0; min-height: 20px; }
        
        .global-performance-chart-container { min-height: 220px; position: relative; margin-top: 15px; }
        .chart-placeholder { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 0.85em; color: var(--secondary-text-color); padding: 10px; text-align: center; }
        
        .doughnut-chart-container { position: relative; height: 180px; width: 100%; display: flex; justify-content: center; align-items: center; margin-top: 10px; }
        .doughnut-chart-container.gold-pulse { animation: chart-gold-pulse 2s infinite; border-radius: 50%; }
        .chart-area-container { position: relative; height: 120px; width: 100%; margin-top: 20px; border-top: 1px solid var(--border-color); padding-top: 15px; }

        .workout-section { text-align: center; }
        .section-hidden {
            opacity: 0; max-height: 0 !important; padding-top: 0 !important; padding-bottom: 0 !important; margin-bottom: 0 !important;
            border-width: 0 !important; visibility: hidden; transform: translateY(20px) scale(0.98);
            transition: opacity var(--section-transition-speed) ease-in-out, visibility 0s linear var(--section-transition-speed), 
                        max-height 0s linear var(--section-transition-speed), padding var(--section-transition-speed) ease-out,
                        margin var(--section-transition-speed) ease-out, border-width var(--section-transition-speed) ease-out,
                        transform 0.3s ease-in-out;
        }
        .timer-and-image-wrapper { display: flex; flex-direction: column; align-items: center; gap: 20px; margin-bottom: 25px; }
        .exercise-image-area {
            width: 100%; max-width: 260px; margin: 0 auto; padding: 8px; background-color: rgba(var(--secondary-bg-color-dark-rgb),0.4);
            border: 1px solid rgba(var(--electric-cyan-rgb), 0.3); border-radius: var(--border-radius-md); display: none; 
            justify-content: center; align-items: center; box-shadow: 0 4px 12px rgba(var(--bg-color-dark-rgb), 0.4), inset 0 0 8px rgba(var(--electric-cyan-rgb),0.2);
            z-index: 5; transition: opacity 0.4s ease-in-out, transform 0.3s ease-in-out; opacity: 0; transform: scale(0.95) translateY(10px);
        }
        .exercise-image-area.visible { display: flex; opacity: 1; transform: scale(1) translateY(0); }
        #exercise-image-display { display: block; max-width: 100%; max-height: 200px; object-fit: contain; border-radius: var(--border-radius-sm); filter: brightness(0.8) contrast(1.1); }
        .timer-display { position: relative; display: flex; justify-content: center; align-items: center; width: 280px; height: 280px; margin: 0 auto; cursor: pointer; user-select: none; -webkit-tap-highlight-color: transparent; }
        .timer-progress-circle-container { position: absolute; top: 50%; left: 50%; width: 230px; height: 230px; transform: translate(-50%, -50%); pointer-events: none; }
        .timer-progress-circle { fill: none; stroke: var(--timer-progress-circle-color); stroke-width: 6; stroke-linecap: round; transform-origin: center; transform: rotate(-90deg); transition: stroke-dashoffset 0.3s linear, stroke 0.3s ease; }
        .timer-progress-circle-bg { fill: none; stroke: rgba(var(--electric-blue-rgb), 0.15); stroke-width: 6; }
        .timer-step-info-display { position: absolute; top: 15px; left: 0; right: 0; padding: 0 20px; display: flex; justify-content: space-between; font-family: var(--font-family-timer); font-size: 0.8em; color: var(--secondary-text-color); opacity: 0; transition: opacity var(--transition-speed) ease; pointer-events: none; z-index: 15; }
        .timer-step-info-display.visible { opacity: 0.8; }
        #workout-step-current-display, #workout-step-total-display { padding: 3px 8px; background-color: rgba(var(--bg-color-dark-rgb), 0.6); border-radius: var(--border-radius-sm); text-shadow: 0 0 4px rgba(var(--electric-cyan-rgb), 0.6); border: 1px solid rgba(var(--electric-cyan-rgb), 0.2); }
        .reactor { position: relative; width: 180px; height: 180px; display: flex; align-items: center; justify-content: center; border-radius: 50%; overflow: hidden; z-index: 10; background-color: transparent; }
        .reactor::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(var(--bg-color-dark-rgb), 0.3); z-index: 1; border-radius: 50%; }
        .triangle { z-index: 5; position: absolute; top: 66%; left: 50%; transform: translate(-50%, -50%); width: 155px; aspect-ratio: 1; background-color: var(--electric-cyan); -webkit-clip-path: polygon(50% 88%, 0 0, 100% 0); clip-path: polygon(50% 88%, 0 0, 100% 0); transition: transform 0.5s ease-out, background-color var(--transition-speed) ease; }
        .triangle::after { content: ''; display: block; position: absolute; top: 45%; left: 50%; z-index: 6; width: 120px; height: 120px; transform: translate(-50%, -50%); background-color: var(--bg-color); -webkit-clip-path: polygon(50% 90%, 0 0, 100% 0); clip-path: polygon(50% 90%, 0 0, 100% 0); transition: background-color var(--transition-speed) ease; }
        @keyframes rotate-right { to { transform: rotate(360deg); } } @keyframes rotate-left { to { transform: rotate(-360deg); } }
        @keyframes rotate-left-right { 0% { transform: translate(-50%, -50%) rotate(0deg); } 50% { transform: translate(-50%, -50%) rotate(-180deg); } 100% { transform: translate(-50%, -50%) rotate(0deg); } }
        /* Modification Vitesse Réacteur */
        .circle-1 { z-index: 2; position: absolute; width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(rgba(var(--electric-cyan-rgb), 0.8), rgba(var(--electric-blue-rgb), 0.8)); animation: rotate-right var(--reactor-speed) linear infinite; }
        .circle-1::before { content: ''; position: absolute; z-index: 1; inset: 10px; border-radius: 50%; background-color: var(--bg-color); transition: background-color var(--transition-speed) ease; }
        .circle-1 span { position: absolute; width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(rgba(var(--electric-cyan-rgb), 0.8), rgba(var(--electric-blue-rgb), 0.8)); top:0; left: 0; }
        .circle-1 span:nth-child(1) { filter: blur(15px); } .circle-1 span:nth-child(2) { filter: blur(15px); } .circle-1 span:nth-child(3) { filter: blur(15px); } .circle-1 span:nth-child(4) { filter: blur(75px); }
        .circle-2 { z-index: 4; position: absolute; top: 30px; left: 30px; width: calc(100% - 60px); height: calc(100% - 60px); border-radius: 50%; border: 10px solid var(--electric-cyan); box-shadow: 0 0 30px 30px rgba(var(--electric-cyan-rgb), 0.2); animation: rotate-left 4s linear infinite; transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease; }
        .circle-2 span { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: calc(100% + 20px); height: 10px; background-color: var(--bg-color); transition: background-color var(--transition-speed) ease; }
        .circle-2 span:nth-child(1) { transform: translate(-50%, -50%) rotate(90deg); } .circle-2 span:nth-child(2) { transform: translate(-50%, -50%) rotate(45deg); } .circle-2 span:nth-child(3) { transform: translate(-50%, -50%) rotate(-45deg); }
        .circle-2 span:nth-child(4) { transform: translate(-50%, -50%) rotate(30deg); } .circle-2 span:nth-child(5) { transform: translate(-50%, -50%) rotate(-30deg); } .circle-2 span:nth-child(6) { transform: translate(-50%, -50%) rotate(0deg); }
        .circle-2 span:nth-child(7) { transform: translate(-50%, -50%) rotate(55deg); height: 5px; } .circle-2 span:nth-child(8) { transform: translate(-50%, -50%) rotate(125deg); height: 5px; }
        .circle-3 { z-index: 7; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: 50%; box-shadow: 0 0 10px 10px rgba(var(--electric-cyan-rgb), 0.2); transition: box-shadow var(--transition-speed) ease; }
        .circle-3::after { content: ''; display: block; width: 115px; height: 115px; border-radius: 50%; border: 3px dotted rgba(var(--electric-cyan-rgb), 0.8); animation: rotate-right 10s linear infinite; transition: border-color var(--transition-speed) ease; }
        .circle-4 { z-index: 8; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100px; height: 100px; border-radius: 50%; box-shadow: 0 0 10px 10px rgba(var(--electric-cyan-rgb), 0.1); animation: rotate-left-right 20s infinite ease-in; transition: box-shadow var(--transition-speed) ease; }
        .circle-4 span { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100%; height: 100%; border-radius: 50%; border: 3px solid; border-color: var(--electric-cyan) transparent transparent; transition: border-color var(--transition-speed) ease; }
        .circle-4 span:nth-child(1) { transform: translate(-50%, -50%) rotate(45deg); } .circle-4 span:nth-child(2) { transform: translate(-50%, -50%) rotate(-75deg); } .circle-4 span:nth-child(3) { transform: translate(-50%, -50%) rotate(165deg); }
        .circle-5 { z-index: 9; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 64px; height: 64px; border-radius: 50%; animation: rotate-left-right 10s infinite ease-in; background-color: rgba(var(--electric-cyan-rgb), 0.2); box-shadow: 0 0 20px 20px rgba(var(--electric-cyan-rgb), 0.2); transition: background-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease, opacity 0.3s ease; }
        .circle-5 span { position: absolute; inset: 0; z-index: 10; width: 54px; height: 54px; border-radius: 50%; border: 5px solid; border-color: var(--electric-cyan) transparent transparent; margin: auto; transition: border-color var(--transition-speed) ease; }
        .circle-5 span:nth-child(1) { transform: rotate(0deg); } .circle-5 span:nth-child(2) { transform: rotate(120deg); } .circle-5 span:nth-child(3) { transform: rotate(240deg); }
        .circle-6 { z-index: 11; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .circle-6::after { content: ''; display: block; width: 40px; height: 40px; border-radius: 50%; border: 3px dashed var(--electric-cyan); animation: rotate-left 5s infinite ease-in; transition: border-color var(--transition-speed) ease; }
        .circle-7 { z-index: 12; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .circle-7::after { content: ''; display: block; width: 27px; height: 27px; border-radius: 50%; background-color: var(--electric-cyan); animation: rotate-left 5s infinite ease-in; box-shadow: 0 0 5px 5px rgba(var(--electric-cyan-rgb), 0.2); transition: box-shadow var(--transition-speed) ease, transform 0.3s ease, background-color var(--transition-speed) ease; }
        .circle-8 { z-index: 13; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 15px; height: 15px; border-radius: 50%; animation: rotate-left-right 5s infinite ease-in; }
        .circle-8 span { position: absolute; inset: 0; z-index: 14; width: 13px; height: 13px; border-radius: 50%; border: 1px solid; border-color: var(--bg-color) transparent transparent; margin: auto; transition: border-color var(--transition-speed) ease; }
        .circle-8 span:nth-child(1) { transform: rotate(120deg); } .circle-8 span:nth-child(2) { transform: rotate(240deg); }
        @keyframes pulsePausedGlow { 0%, 100% { box-shadow: 0 0 5px 5px rgba(var(--paused-color-rgb), 0.2); transform: scale(1); } 50% { box-shadow: 0 0 10px 10px rgba(var(--paused-color-rgb), 0.4); transform: scale(1.1); } }
        @keyframes pulsePausedRing { 0%, 100% { box-shadow: 0 0 20px 20px rgba(var(--paused-color-rgb), 0.2); opacity: 1; } 50% { box-shadow: 0 0 25px 25px rgba(var(--paused-color-rgb), 0.3); opacity: 0.8; } }
        .state-paused .circle-7::after { background-color: var(--paused-color-val); animation: pulsePausedGlow 1.5s infinite ease-in-out; }
        .state-paused .circle-5 { animation: pulsePausedRing 1.5s infinite ease-in-out; background-color: rgba(var(--paused-color-rgb), 0.3); }
        .state-paused .circle-1, .state-paused .circle-1 span { background: linear-gradient(rgba(var(--paused-color-rgb), 0.8), rgba(var(--paused-color-rgb),0.5));}
        .state-paused .circle-2 { border-color: var(--paused-color-val); box-shadow: 0 0 30px 30px rgba(var(--paused-color-rgb), 0.2); }
        .state-paused .circle-3::after { border-color: rgba(var(--paused-color-rgb), 0.8); }
        .state-paused .circle-4 span { border-color: var(--paused-color-val) transparent transparent; } .state-paused .circle-5 span { border-color: var(--paused-color-val) transparent transparent; }
        .state-paused .circle-6::after { border-color: var(--paused-color-val); } .state-paused .triangle { background-color: var(--paused-color-val); }
        .state-paused .timer-progress-circle { stroke: var(--paused-color-val); }
        @keyframes rotateSpinOnce { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }
        .state-preparing .triangle { animation: rotateSpinOnce 5s linear infinite; background-color: var(--preparing-color-val); }
        .state-preparing .circle-1, .state-preparing .circle-1 span { background: linear-gradient(rgba(var(--preparing-color-rgb), 0.8), rgba(var(--preparing-color-rgb),0.5));}
        .state-preparing .circle-2 { border-color: var(--preparing-color-val); box-shadow: 0 0 30px 30px rgba(var(--preparing-color-rgb), 0.2); }
        .state-preparing .circle-3::after { border-color: rgba(var(--preparing-color-rgb), 0.8); }
        .state-preparing .circle-4 span { border-color: var(--preparing-color-val) transparent transparent; }
        .state-preparing .circle-5 { background-color: rgba(var(--preparing-color-rgb),0.2); box-shadow: 0 0 20px 20px rgba(var(--preparing-color-rgb),0.2);}
        .state-preparing .circle-5 span { border-color: var(--preparing-color-val) transparent transparent; }
        .state-preparing .circle-6::after { border-color: var(--preparing-color-val); }
        .state-preparing .circle-7::after { background-color: var(--preparing-color-val); box-shadow: 0 0 5px 5px rgba(var(--preparing-color-rgb),0.2); }
        .state-preparing .timer-progress-circle { stroke: var(--preparing-color-val); }
        .triangle.spin-transition { animation: rotateSpinOnce 0.6s ease-out forwards; }
        #time-left { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 20; font-family: var(--font-family-timer); font-size: 3.6em; font-weight: 700; color: var(--timer-text-color-main); text-shadow: var(--timer-text-glow-main); transition: font-size 0.2s ease; pointer-events: none; white-space: nowrap; }
        .state-exercise #time-left { font-size: 4em; letter-spacing: 0.05em; }
        .state-exercise .triangle { background-color: var(--exercise-color-val); }
        .state-exercise[data-timed="true"] .triangle { background-color: var(--exercise-timed-color-val); }
        .state-exercise .circle-1, .state-exercise .circle-1 span { background: linear-gradient(rgba(var(--exercise-color-rgb), 0.8), rgba(var(--exercise-color-rgb),0.5));}
        .state-exercise[data-timed="true"] .circle-1, .state-exercise[data-timed="true"] .circle-1 span { background: linear-gradient(rgba(var(--exercise-timed-color-rgb), 0.8), rgba(var(--exercise-timed-color-rgb),0.5));}
        .state-exercise .circle-2 { border-color: var(--exercise-color-val); box-shadow: 0 0 30px 30px rgba(var(--exercise-color-rgb), 0.2); }
        .state-exercise[data-timed="true"] .circle-2 { border-color: var(--exercise-timed-color-val); box-shadow: 0 0 30px 30px rgba(var(--exercise-timed-color-rgb), 0.2); }
        .state-exercise .circle-3::after { border-color: rgba(var(--exercise-color-rgb), 0.8); }
        .state-exercise[data-timed="true"] .circle-3::after { border-color: rgba(var(--exercise-timed-color-rgb), 0.8); }
        .state-exercise .circle-4 span { border-color: var(--exercise-color-val) transparent transparent; }
        .state-exercise[data-timed="true"] .circle-4 span { border-color: var(--exercise-timed-color-val) transparent transparent; }
        .state-exercise .circle-5 { background-color: rgba(var(--exercise-color-rgb),0.2); box-shadow: 0 0 20px 20px rgba(var(--exercise-color-rgb),0.2);}
        .state-exercise[data-timed="true"] .circle-5 { background-color: rgba(var(--exercise-timed-color-rgb),0.2); box-shadow: 0 0 20px 20px rgba(var(--exercise-timed-color-rgb),0.2);}
        .state-exercise .circle-5 span { border-color: var(--exercise-color-val) transparent transparent; }
        .state-exercise[data-timed="true"] .circle-5 span { border-color: var(--exercise-timed-color-val) transparent transparent; }
        .state-exercise .circle-6::after { border-color: var(--exercise-color-val); }
        .state-exercise[data-timed="true"] .circle-6::after { border-color: var(--exercise-timed-color-val); }
        .state-exercise .circle-7::after { background-color: var(--exercise-color-val); box-shadow: 0 0 5px 5px rgba(var(--exercise-color-rgb),0.2); }
        .state-exercise[data-timed="true"] .circle-7::after { background-color: var(--exercise-timed-color-val); box-shadow: 0 0 5px 5px rgba(var(--exercise-timed-color-rgb),0.2); }
        .state-exercise .timer-progress-circle { stroke: var(--exercise-color-val); } 
        .state-exercise[data-timed="true"] .timer-progress-circle { stroke: var(--exercise-timed-color-val); }
        .state-break .triangle { background-color: var(--break-color-val); }
        .state-break .circle-1, .state-break .circle-1 span { background: linear-gradient(rgba(var(--break-color-rgb), 0.8), rgba(var(--break-color-rgb),0.5));}
        .state-break .circle-2 { border-color: var(--break-color-val); box-shadow: 0 0 30px 30px rgba(var(--break-color-rgb), 0.2); }
        .state-break .circle-3::after { border-color: rgba(var(--break-color-rgb), 0.8); }
        .state-break .circle-4 span { border-color: var(--break-color-val) transparent transparent; }
        .state-break .circle-5 { background-color: rgba(var(--break-color-rgb),0.2); box-shadow: 0 0 20px 20px rgba(var(--break-color-rgb),0.2);}
        .state-break .circle-5 span { border-color: var(--break-color-val) transparent transparent; }
        .state-break .circle-6::after { border-color: var(--break-color-val); }
        .state-break .circle-7::after { background-color: var(--break-color-val); box-shadow: 0 0 5px 5px rgba(var(--break-color-rgb),0.2); }
        .state-break .timer-progress-circle { stroke: var(--break-color-val); }
        .state-get-ready .triangle { background-color: var(--get-ready-color-val); }
        .state-get-ready .circle-1, .state-get-ready .circle-1 span { background: linear-gradient(rgba(var(--get-ready-color-rgb), 0.8), rgba(var(--get-ready-color-rgb),0.5));}
        .state-get-ready .circle-2 { border-color: var(--get-ready-color-val); box-shadow: 0 0 30px 30px rgba(var(--get-ready-color-rgb), 0.2); }
        .state-get-ready .circle-3::after { border-color: rgba(var(--get-ready-color-rgb), 0.8); }
        .state-get-ready .circle-4 span { border-color: var(--get-ready-color-val) transparent transparent; }
        .state-get-ready .circle-5 { background-color: rgba(var(--get-ready-color-rgb),0.2); box-shadow: 0 0 20px 20px rgba(var(--get-ready-color-rgb),0.2);}
        .state-get-ready .circle-5 span { border-color: var(--get-ready-color-val) transparent transparent; }
        .state-get-ready .circle-6::after { border-color: var(--get-ready-color-val); }
        .state-get-ready .circle-7::after { background-color: var(--get-ready-color-val); box-shadow: 0 0 5px 5px rgba(var(--get-ready-color-rgb),0.2); }
        .state-get-ready .timer-progress-circle { stroke: var(--get-ready-color-val); }
        .state-finished .triangle, .state-completed .triangle { background-color: var(--finished-color-val); }
        .state-finished .circle-1, .state-finished .circle-1 span, .state-completed .circle-1, .state-completed .circle-1 span { background: linear-gradient(rgba(var(--finished-color-rgb), 0.8), rgba(var(--finished-color-rgb),0.5));}
        .state-finished .circle-2, .state-completed .circle-2 { border-color: var(--finished-color-val); box-shadow: 0 0 30px 30px rgba(var(--finished-color-rgb), 0.2); }
        .state-finished .circle-3::after, .state-completed .circle-3::after { border-color: rgba(var(--finished-color-rgb), 0.8); }
        .state-finished .circle-4 span, .state-completed .circle-4 span { border-color: var(--finished-color-val) transparent transparent; }
        .state-finished .circle-5, .state-completed .circle-5 { background-color: rgba(var(--finished-color-rgb),0.2); box-shadow: 0 0 20px 20px rgba(var(--finished-color-rgb),0.2);}
        .state-finished .circle-5 span, .state-completed .circle-5 span { border-color: var(--finished-color-val) transparent transparent; }
        .state-finished .circle-6::after, .state-completed .circle-6::after { border-color: var(--finished-color-val); }
        .state-finished .circle-7::after, .state-completed .circle-7::after { background-color: var(--finished-color-val); box-shadow: 0 0 5px 5px rgba(var(--finished-color-rgb),0.2); }
        .state-finished .timer-progress-circle, .state-completed .timer-progress-circle { stroke: var(--finished-color-val); }
        .state-completed .circle-5 { animation: completed-pulse 1s ease-out; }
        .state-completed #time-left { font-size: 5em; }
        
        .workout-info { margin-bottom: 20px; min-height: auto; position: relative; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        #current-exercise-name-display { display: block; font-size: 1.3em; font-weight: 600; color: var(--primary-text-color); margin-bottom: 8px; padding: 0 10px; line-height: 1.3; text-shadow: none; }
        body.state-exercise #current-exercise-name-display, body.state-break #current-exercise-name-display, body.state-preparing #current-exercise-name-display { animation: textGlowPulseState 2s infinite ease-in-out; }
        body.state-exercise #current-exercise-name-display { color: var(--color-exercise); }
        body.state-exercise[data-timed="true"] #current-exercise-name-display { color: var(--color-exercise-timed); }
        body.state-break #current-exercise-name-display, body.state-preparing #current-exercise-name-display, body.state-get-ready #current-exercise-name-display { color: var(--color-break); }
        
        #current-exercise-container { display: flex; flex-direction: column; align-items: center; gap: 10px; font-size: 1em; color: var(--secondary-text-color); min-height: auto; width: 100%; }
        
        .exercise-details, .break-info { display: flex; flex-direction: column; flex-wrap: nowrap; justify-content: center; align-items: center; gap: 8px; background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.5); padding: 12px 15px; border-radius: var(--border-radius-sm); border: 1px solid rgba(var(--accent-border-color), 0.5); width: fit-content; max-width: 95%; box-shadow: 0 2px 5px rgba(var(--bg-color-dark-rgb),0.2); }
        .exercise-details .main-stats { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px 20px; font-size: 1.1em; font-weight: 500; color: var(--primary-text-color); margin-bottom: 5px;}
        .exercise-details .main-stats span { display: flex; align-items: center; gap: 8px; }
        .exercise-details .main-stats i { color: var(--color-exercise); opacity: 0.9; }
        .exercise-details[data-timed="true"] .main-stats i { color: var(--color-exercise-timed); }
        .sets-info-text { font-size: 0.8em; color: var(--secondary-text-color); opacity: 0.85; text-align: center; width: 100%; letter-spacing: 0.02em; padding: 0 5px; line-height: 1.4; }
        .sets-info-text i { color: var(--electric-cyan); margin-right: 5px; } 
        
        .break-info { font-size: 1em; }
        .break-info > i { font-size: 1.2em; margin-bottom: 3px;} 
        .break-info > span { font-weight: 500; color: var(--primary-text-color); } 
        .next-exercise-preview { font-size: 0.85em; color: var(--secondary-text-color); margin-top: 10px; padding: 12px 15px; border: 1px dashed; border-radius: var(--border-radius-sm); background-color: rgba(var(--bg-color-dark-rgb), 0.2); display: flex; flex-direction: column; align-items: center; gap: 8px; text-align: center; width: fit-content; max-width: 95%; }
        .next-exercise-preview > .title { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
        .next-exercise-preview > .title i { opacity: 0.8; font-size: 1.1em; }
        .next-exercise-preview strong { color: var(--primary-text-color); font-weight: 600; display: block; font-size: 1.1em;}
        .next-exercise-preview .next-details-grid { display: flex; flex-wrap: wrap; justify-content: center; align-items: center; gap: 8px 18px; font-size: 1.2em; font-weight: 700; color: var(--primary-text-color); font-family: var(--font-family-timer); }
        .next-exercise-preview .next-details-grid span { display: inline-flex; align-items: center; gap: 6px; padding: 5px 10px; background-color: rgba(var(--bg-color-dark-rgb), 0.4); border-radius: var(--border-radius-sm); }
        .next-exercise-preview .next-details-grid i { color: var(--electric-cyan); opacity: 0.8; }
        
        .controls { display: flex; justify-content: center; gap: 8px; margin-top: 20px; flex-wrap: wrap; }
        .controls button { background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.4); border: 1px solid var(--border-color); color: var(--secondary-text-color); padding: 8px 14px; border-radius: var(--border-radius-md); font-size: 0.9em; font-weight: 500; cursor: pointer; transition: all var(--transition-speed) ease; display: inline-flex; align-items: center; justify-content: center; gap: 6px; min-width: 100px; box-shadow: 0 2px 5px rgba(var(--bg-color-dark-rgb),0.3); }
        .controls button:disabled { opacity: 0.5; cursor: not-allowed; background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.2); border-color: var(--border-color-dark); color: var(--secondary-text-color-dark); box-shadow: none !important; transform: none !important; text-shadow: none !important; pointer-events: auto; }
        .controls button:not(:disabled):hover { border-color: var(--electric-blue); color: var(--electric-blue); background-color: rgba(var(--electric-blue-rgb), 0.15); box-shadow: 0 0 10px rgba(var(--electric-blue-rgb), 0.3), inset 0 0 5px rgba(var(--electric-blue-rgb),0.1); transform: translateY(-1px); }
        .controls button i { font-size: 1em; margin-right: 4px; opacity: 0.8; transition: opacity var(--transition-speed) ease; }
        .controls button:not(:disabled):hover i { opacity: 1; }
        #start-pause-btn.start-btn:not(:disabled) { animation: electricBorder 3s infinite linear; border-color: var(--electric-cyan); }
        #start-pause-btn.start-btn:not(:disabled):hover { animation-play-state: paused; }
        .progress-tracker { font-size: 0.85em; color: var(--secondary-text-color-dark); margin-top: 15px; opacity: 0.8; font-weight: 500; display: flex; flex-wrap: wrap; align-items: center; justify-content: center; gap: 8px 15px; min-height: 1.2em; font-family: var(--font-family-timer); }
        #drive-connection-status-main { display: inline-flex; align-items: center; gap: 6px; color: var(--neon-green); font-weight: 500; transition: color 0.3s ease; }
        #drive-connection-status-main i.fa-google-drive { display: inline-block; font-size: 1.1em; }
        #drive-connection-status-main.error { color: var(--neon-red); } #drive-connection-status-main.loading { color: var(--neon-yellow); }
        #progress-text-area { font-weight: 500; letter-spacing: 0.05em; }
        
        .post-workout-summary { position: fixed; inset: 0; background-color: rgba(var(--bg-color-dark-rgb), 0.9); backdrop-filter: blur(8px); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; opacity: 0; visibility: hidden; pointer-events: none; transition: opacity 0.3s ease, visibility 0s linear 0.3s; }
        .post-workout-summary.visible { opacity: 1; visibility: visible; pointer-events: auto; transition: opacity 0.3s ease, visibility 0s linear 0s; }
        .post-workout-summary-content { background-color: var(--secondary-bg-color); border: 1px solid var(--border-color); border-radius: var(--border-radius-lg); box-shadow: 0 10px 30px rgba(0,0,0,0.4), 0 0 20px rgba(var(--electric-cyan-rgb), 0.1); width: 100%; max-width: 680px; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .post-workout-summary.visible .post-workout-summary-content { transform: scale(1); }
        .post-workout-summary h2 { color: var(--electric-cyan); font-size: 1.5em; font-weight: 700; padding: 20px 25px; border-bottom: 1px solid var(--border-color); flex-shrink: 0; text-align: center; background-color: rgba(var(--bg-color-dark-rgb), 0.2); text-shadow: 0 0 5px var(--electric-cyan); }
        .summary-items-list { list-style: none; padding: 15px 25px; overflow-y: auto; flex-grow: 1; background: var(--bg-color); border-bottom: 1px solid var(--border-color); }
        .summary-item {
            --item-accent-color: var(--electric-blue-light);
            background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.4); padding: 15px; border-radius: var(--border-radius-md); margin-bottom: 15px;
            border-left: 4px solid var(--item-accent-color); transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .summary-item:last-child { margin-bottom: 0; }
        .summary-item .exercise-name { display: flex; align-items: center; color: var(--primary-text-color); font-weight: 500; font-size: 1.1em; margin-bottom: 15px; }
        .summary-item .exercise-name-text { flex-grow: 1; white-space: normal; }
        .summary-item .fields-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px 20px; align-items: end; }
        .input-group { display: flex; flex-direction: column; gap: 5px; }
        .input-group label { font-size: 0.8em; color: var(--secondary-text-color); font-weight: 500; }
        .stepper-control { display: flex; align-items: center; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); }
        .stepper-btn { background: transparent; border: none; color: var(--electric-cyan); font-size: 1.2em; padding: 8px 12px; cursor: pointer; transition: all 0.2s ease; }
        .stepper-btn:hover { background-color: rgba(var(--electric-cyan-rgb), 0.1); text-shadow: 0 0 8px var(--electric-cyan); }
        .stepper-btn:disabled { color: var(--border-color); cursor: not-allowed; background: none; text-shadow: none; }
        .stepper-value { flex-grow: 1; text-align: center; font-size: 1em; font-weight: 700; color: var(--primary-text-color); padding: 0 5px; user-select: none; }
        .resistance-controls { display: flex; gap: 10px; align-items: stretch; }
        .resistance-selector { position: relative; flex-shrink: 0; }
        .selected-resistance { display: flex; align-items: center; gap: 8px; background-color: var(--input-bg); border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); padding: 8px 12px; cursor: pointer; height: 100%; transition: border-color 0.2s; }
        .selected-resistance:hover { border-color: var(--electric-cyan); }
        .selected-resistance span { font-size: 1.1em; }
        .selected-resistance i { font-size: 0.8em; color: var(--secondary-text-color); }
        .resistance-options { list-style: none; position: absolute; bottom: 100%; left: 0; background-color: var(--secondary-bg-color); border: 1px solid var(--electric-cyan); border-radius: var(--border-radius-md); z-index: 10; padding: 5px; margin-bottom: 5px; min-width: 180px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: none; }
        .resistance-selector.open .resistance-options { display: block; }
        .resistance-options li { display: flex; align-items: center; gap: 10px; padding: 8px 12px; cursor: pointer; border-radius: var(--border-radius-sm); transition: background-color 0.2s; font-size: 0.9em; }
        .resistance-options li:hover { background-color: rgba(var(--electric-cyan-rgb), 0.15); }
        .resistance-options li span { font-size: 1.2em; }
        .resistance-value-stepper .stepper-btn:hover { color: var(--electric-yellow); text-shadow: 0 0 8px var(--electric-yellow); background-color: rgba(var(--electric-yellow-rgb), 0.1); }
        
        .tracking-type-toggle { display: flex; border: 1px solid var(--border-color); border-radius: var(--border-radius-sm); overflow: hidden; }
        .tracking-type-toggle button { flex: 1; background: transparent; border: none; padding: 8px 10px; font-size: 0.85em; color: var(--secondary-text-color); cursor: pointer; transition: all 0.2s ease; }
        .tracking-type-toggle button.active { background-color: var(--electric-cyan); color: var(--bg-color); font-weight: 700; text-shadow: 0 0 5px rgba(0,0,0,0.3); }

        .summary-controls { padding: 20px 25px; display: flex; justify-content: center; gap: 15px; flex-shrink: 0; flex-wrap: wrap; border-top: 1px solid var(--border-color); background-color: rgba(var(--bg-color-dark-rgb), 0.2); }
        .summary-controls button { border: none; color: var(--bg-color); min-width: 180px; padding: 12px 25px; border-radius: var(--border-radius-md); font-size: 1em; font-weight: 700; cursor: pointer; transition: all var(--transition-speed) ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); text-transform: uppercase; font-family: var(--font-family-titles); letter-spacing: 0.05em; }
        .summary-controls button:disabled { opacity: 0.6; cursor: not-allowed; box-shadow: none; filter: grayscale(50%); }
        #finish-summary-btn { background-color: var(--neon-green); --button-finish-glow: var(--glow-green); }
        #finish-summary-btn:not(:disabled):hover { filter: brightness(1.15); box-shadow: 0 4px 10px rgba(0,0,0,0.3), 0 0 10px var(--button-finish-glow); transform: translateY(-1px); text-shadow: 0 0 5px rgba(255,255,255,0.5); }
        
        .message-area { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.9); color: var(--primary-text-color); border: 1px solid var(--border-color); padding: 12px 25px; border-radius: var(--border-radius-md); z-index: 3000; opacity: 0; transition: all 0.5s ease; pointer-events: none; font-size: 0.95em; box-shadow: 0 4px 15px rgba(0,0,0,0.2); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); max-width: 90%; text-align: center; }
        .message-area.visible { opacity: 1; transform: translate(-50%, 0); bottom: 40px; pointer-events: auto; }
        .message-area.error-message { background-color: rgba(var(--neon-red-rgb), 0.8); color: #fff; border-color: var(--neon-red); text-shadow: 0 0 5px rgba(0,0,0,0.5); box-shadow: 0 4px 15px rgba(0,0,0,0.3), 0 0 10px var(--glow-red); }
        
        footer { padding: 25px; text-align: center; font-size: 0.9em; color: var(--secondary-text-color); border-top: 1px solid rgba(var(--electric-blue-rgb), 0.2); margin-top: 50px; background-color: rgba(var(--bg-color-dark-rgb), 0.7); backdrop-filter: blur(3px); transition: all 0.3s ease-in-out; position: relative;}
        footer p { margin-bottom: 8px; }
        footer a { color: var(--electric-cyan); text-decoration: none; transition: color var(--transition-speed) ease, text-shadow var(--transition-speed) ease; }
        footer a:hover { color: var(--primary-text-color); text-decoration: underline; text-shadow: 0 0 8px var(--electric-cyan); }
        footer .fab.fa-google-drive { color: var(--neon-green); } footer .fab.fa-github { color: var(--neon-purple); }
        

        @media (min-width: 769px) { 
            .timer-and-image-wrapper { flex-direction: row; justify-content: center; align-items: center; gap: 30px; }
            .exercise-image-area { max-width: 220px; margin: 0; } 
            .timer-display { margin: 0; width: 300px; height: 300px;} 
            .reactor { width: 190px; height: 190px; } 
            .timer-progress-circle-container { width: 250px; height: 250px; }
            #current-exercise-name-display { font-size: 1.5em; } 
            .exercise-details .main-stats { font-size: 1.2em; }
        }
        @media (max-width: 900px) {
            .home-grid { flex-direction: column; }
            .home-main-content, .home-sidebar { flex-basis: auto; width: 100%; }
        }
        @media (max-width: 768px) { 
            .timer-display { width: 260px; height: 260px; } 
            .reactor { width: 170px; height: 170px; } 
            .timer-progress-circle-container { width: 220px; height: 220px; }
            #time-left { font-size: 3.0em; } 
            .triangle { width: 125px; } .triangle::after { width: 95px; height: 95px; }
            .circle-2 { border-width: 7px; } 
            .circle-5 { width: 50px; height: 50px; } .circle-5 span { width: 40px; height: 40px; }
            header h1 { font-size: 1.3em; }
            .exercise-image-area { max-width: 200px; margin-bottom: 15px; } 
            .summary-item .fields-grid { grid-template-columns: 1fr; } 
        }
        @media (max-width: 480px) { 
            .timer-display { width: 220px; height: 220px; }
            .reactor { width: 140px; height: 140px; } 
            .timer-progress-circle-container { width: 190px; height: 190px; }
            #time-left { font-size: 2.5em; } 
            .triangle { width: 100px; } .triangle::after { width: 75px; height: 75px; }
            #current-exercise-name-display { font-size: 1.1em; } 
            .exercise-details .main-stats { font-size: 1.1em; }
            .controls button { flex-basis: calc(50% - 6px); }
            .header-content { justify-content: center; } 
            .header-actions { justify-content: center; width: 100%; margin-top: 10px; }
            .exercise-image-area { max-width: 160px; } 
            .post-workout-summary-content { max-width: 95%; } 
            .calendar-day { width: 28px; height: 28px; font-size: 0.8em; }
        }
    </style>
</head>
<body class="logged-out dark-theme state-idle">
    <header>
        <div class="header-content">
            <h1><i class="fas fa-bolt"></i> ArmorWorkout</h1>
            <nav>
                <ul>
                    <li><button id="edit-program-btn" disabled><i class="fas fa-edit"></i> Modifier Programme</button></li>
                </ul>
            </nav>
            <div class="header-actions">
                <div id="drive-status" style="display: none;"> 
                    <span id="drive-status-text">Connecté</span>
                </div>
                <button id="signin-button" disabled><i class="fab fa-google"></i> Se connecter à Drive</button>
            </div>
        </div>
    </header>

    <div class="container">
        <main>
            <div id="home-section" class="app-section"></div>

            <div class="workout-section app-section section-hidden" id="workout-section">
                <div class="timer-and-image-wrapper" id="timer-view" style="display: none;">
                    <div id="exercise-image-container" class="exercise-image-area">
                        <img id="exercise-image-display" src="" alt="">
                    </div>
                    <div class="timer-display" id="timer-display-clickable" aria-label="Affichage du timer Arc Reactor">
                        <div class="timer-progress-circle-container">
                            <svg viewBox="0 0 100 100">
                                <circle class="timer-progress-circle-bg" cx="50" cy="50" r="45"></circle>
                                <circle id="timer-progress-indicator" class="timer-progress-circle" cx="50" cy="50" r="45" stroke-dasharray="282.74" stroke-dashoffset="282.74"></circle>
                            </svg>
                        </div>
                        <div class="timer-step-info-display" id="workout-step-info-display">
                            <span id="workout-step-current-display" title="Étape actuelle">--</span>
                            <span id="workout-step-total-display" title="Nombre total d'étapes">--</span>
                        </div>
                        <div class="reactor">
                            <div class="triangle"></div>
                            <div class="circle-1"><span></span><span></span><span></span><span></span></div>
                            <div class="circle-2"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></div>
                            <div class="circle-3"></div>
                            <div class="circle-4"><span></span><span></span><span></span></div>
                            <div class="circle-5"><span></span><span></span><span></span></div>
                            <div class="circle-6"></div>
                            <div class="circle-7"></div>
                            <div class="circle-8"><span></span><span></span><span></span></div>
                            <div id="time-left" aria-live="polite">00:00</div>
                        </div>
                    </div>
                </div>
    
                <div class="workout-info" id="workout-info">
                    <div id="current-exercise-name-display">ArmorWorkout</div>
                    <div id="current-exercise-container" aria-live="polite"></div>
                </div>
    
                <div class="controls" style="display: none;">
                    <button id="prev-btn" disabled><i class="fas fa-backward-step"></i> Précédent</button>
                    <button id="start-pause-btn" disabled><i class="fas fa-play"></i> Démarrer</button>
                    <button id="skip-btn" disabled><i class="fas fa-forward-step"></i> Suivant</button>
                    <button id="finish-btn" disabled><i class="fas fa-flag-checkered"></i> Finir</button>
                    <button id="reset-btn" disabled><i class="fas fa-redo"></i> Reset</button>
                </div>
    
                <div class="progress-tracker" id="progress-tracker">
                    <span id="progress-text-area"></span>
                    <span id="drive-connection-status-main" style="display: none;"> 
                        <i class="fab fa-google-drive"></i>
                        <span id="drive-connection-text">Connecté</span>
                    </span>
                </div>
            </div>
        </main>
    </div>
    
    <footer>
        <p>© <span id="current-year"></span> ArmorWorkout. Sauvegarde sur <i class="fab fa-google-drive" aria-hidden="true"></i> Google Drive.</p>
        <p><a href="https://github.com/ironworkout/armorworkout" target="_blank" rel="noopener noreferrer"><i class="fab fa-github" aria-hidden="true"></i> Voir sur GitHub</a></p>
    </footer>

    <div id="message-area" class="message-area" role="status" aria-live="polite"></div>

    <div id="post-workout-summary" class="post-workout-summary" role="dialog" aria-modal="true" aria-labelledby="summary-title">
        <div class="post-workout-summary-content">
            <h2 id="summary-title">Résumé & Objectifs</h2>
            <div id="analysis-chart-container" style="padding: 0 20px; height: 0px; overflow:hidden; display: none;">
                <!-- Chart removed from summary modal to focus on main screen -->
            </div>
            <ul id="summary-items-list" class="summary-items-list"></ul>
            <div class="summary-controls">
                <button id="finish-summary-btn"><i class="fas fa-check"></i> Terminer & Sauvegarder</button>
            </div>
        </div>
    </div>
    
    <script async defer src="https://accounts.google.com/gsi/client"></script>
    <script>
        "use strict";

        // =================================================================================
        // SECTION 1: CONSTANTES GLOBALES ET ÉTAT
        // =================================================================================

        const GOOGLE_CLIENT_ID = "731283926358-viam3ulpgna14flfdeb9m92l8s620hoi.apps.googleusercontent.com";
        const GOOGLE_DRIVE_SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const HISTORY_FILENAME = "armorworkout_history.json";
        const FULL_PROGRAM_FILENAME = "programmeCompletHypertrophieElite_v1.json";
        const PREPARE_DURATION = 3;
        const IN_PROGRESS_KEY = 'armorWorkoutStateInProgress';
        const IN_PROGRESS_VERSION = 1;
        const GIS_CHECK_INTERVAL = 100;
        const GIS_MAX_RETRIES = 50;
        const TIMER_PROGRESS_CIRCLE_CIRCUMFERENCE = 2 * Math.PI * 45;
        
        // MODIFICATION: Programme par défaut VIDE comme demandé.
        const DEFAULT_PROGRAM_CONTENT = JSON.stringify({
          "nom_programme": "Nouveau Programme",
          "sessions": []
        });

        // Variables d'état
        let loadedFullProgram = null; 
        let timeDisplayDiv, currentExerciseContainer, progressTracker, startPauseBtn, skipBtn, finishBtn, resetBtn, prevBtn,
            editProgramBtn, signInButton, driveStatusElement, driveStatusTextElement,
            postWorkoutSummary, summaryTitle, summaryItemsList, finishSummaryBtn, 
            currentExerciseNameDisplay, driveConnectionStatusMain, driveConnectionText, timerDisplayElement,
            progressTextArea, messageArea, homeSection,
            workoutSection, 
            reactorElement, exerciseImageContainer, exerciseImageDisplay,
            timerProgressIndicator, workoutStepTotalDisplay, workoutStepCurrentDisplay, workoutStepInfoDisplay,
            timerView, workoutInfoView, controls;

        let currentWorkoutType = null, currentWorkoutPlan = [], originalCompletedWorkoutPlan = [];
        let currentItemIndex = 0, timerInterval = null, prepareCountdownInterval = null;
        let totalTime = 0, timeLeft = 0, prepareTimeLeft = 0;
        let isTimerRunning = false, isWorkoutActive = false, workoutFinished = false, wasFinishedState = false;
        let currentState = 'idle', previousState = 'idle';
        let workoutStartTime = null, workoutHistory = [];
        let googleAccessToken = null, tokenClient = null;
        let historyFileId = null, programFileId = null;
        let programsLoaded = false; 
        let isSavingDriveData = false;
        let messageTimeoutId = null;
        let gisCheckRetries = 0;
        let audioContext;
        let isEditMode = false;
        let currentSummaryContext = { mode: 'workout', sessionName: null };
        let activeCharts = {};
        let displayedCalendarDate = new Date();

        let soundLaser, sound5, sound4, sound3, sound2, sound1, soundWindows, soundET;

        // =================================================================================
        // SECTION 2: FONCTIONS UTILITAIRES ET HELPERS
        // =================================================================================

        function formatTime(seconds) { 
            const cleanSeconds = Math.max(0, Math.round(seconds)); 
            const minutes = Math.floor(cleanSeconds / 60); 
            const remainingSeconds = cleanSeconds % 60; 
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`; 
        }

        function parseEliteWeight(text) {
            if (!text || typeof text !== 'string') return 0;
            const numbers = text.match(/-?\d+(\.\d+)?/g);
            if (!numbers) return 0;
            return numbers.reduce((acc, curr) => acc + parseFloat(curr), 0);
        }

        function calculateEliteGap(current, target) {
            const currentVal = parseFloat(current) || 0;
            const targetVal = parseFloat(target) || 0;
            if (targetVal === 0) return 100;
            return Math.min(100, (currentVal / targetVal) * 100);
        }
        
        function calculateMasteryScore(currentWeightTxt, targetWeightTxt, currentReps, targetReps) {
            const cw = parseEliteWeight(currentWeightTxt);
            const tw = parseEliteWeight(targetWeightTxt);
            const cr = parseFloat(currentReps) || 0;
            const tr = parseFloat(targetReps) || 0;
            
            const wScore = calculateEliteGap(cw, tw);
            const rScore = calculateEliteGap(cr, tr);
            
            return (wScore + rScore) / 2;
        }

        // =================================================================================
        // SECTION 3: GESTION DE SESSION ET SAUVEGARDE (Déplacée ici pour fixer le bug)
        // =================================================================================

        // CORRECTION BUG: Définition de loadInProgressState AVANT son utilisation dans tokenCallback
        function saveInProgressState() {
            if (!isWorkoutActive || currentState === 'finished') { clearInProgressState(); return; }
            const stateToSave = {
                version: IN_PROGRESS_VERSION,
                currentWorkoutType: currentWorkoutType,
                currentWorkoutPlan: JSON.parse(JSON.stringify(currentWorkoutPlan)),
                currentItemIndex: currentItemIndex, timeLeft: timeLeft, prepareTimeLeft: prepareTimeLeft,
                workoutStartTime: workoutStartTime, currentState: currentState, previousState: previousState,
            };
            try { localStorage.setItem(IN_PROGRESS_KEY, JSON.stringify(stateToSave)); } 
            catch (e) { console.error("Erreur de sauvegarde locale:", e); }
        }

        function loadInProgressState() {
            const savedStateJSON = localStorage.getItem(IN_PROGRESS_KEY);
            if (savedStateJSON) {
                try {
                    const savedState = JSON.parse(savedStateJSON);
                    if (savedState.version !== IN_PROGRESS_VERSION) { clearInProgressState(); return; }
                    // Vérifie que le programme est chargé avant de restaurer
                    if (savedState.currentWorkoutType && savedState.currentWorkoutPlan && savedState.currentState && loadedFullProgram) {
                        currentWorkoutType = savedState.currentWorkoutType;
                        currentWorkoutPlan = savedState.currentWorkoutPlan;
                        currentItemIndex = savedState.currentItemIndex;
                        timeLeft = savedState.timeLeft;
                        prepareTimeLeft = savedState.prepareTimeLeft;
                        workoutStartTime = savedState.workoutStartTime;
                        previousState = savedState.previousState || 'idle';
                        setState(savedState.currentState);
                        showMessage("Entraînement repris.", 2500);
                        return;
                    }
                } catch (e) { console.error("Erreur parsing état en cours:", e); }
            }
            clearInProgressState();
        }
        
        function clearInProgressState() { localStorage.removeItem(IN_PROGRESS_KEY); }

        async function saveFullProgramToDrive(){ if(!googleAccessToken || !loadedFullProgram) return false; if(!programFileId) programFileId = await findOrCreateFile(FULL_PROGRAM_FILENAME, '{}', 'application/json', true); if(programFileId) return await updateFileContent(programFileId, loadedFullProgram, FULL_PROGRAM_FILENAME); else { showMessage("Sauvegarde du programme impossible.", 4000, true); return false; } }
        async function saveHistoryToDrive(){ if(!googleAccessToken || !workoutHistory) return false; if(!historyFileId) historyFileId = await findOrCreateFile(HISTORY_FILENAME, '[]', 'application/json', true); if(historyFileId) return await updateFileContent(historyFileId, workoutHistory, HISTORY_FILENAME); else { showMessage("Sauvegarde de l'historique impossible.", 4000, true); return false; } }

        function saveWorkoutToHistory() {
            if (!currentWorkoutType || !workoutStartTime || !originalCompletedWorkoutPlan || originalCompletedWorkoutPlan.length === 0) return;
            const exercisesSummary = originalCompletedWorkoutPlan
                .map((item, index) => ({ item, originalIndex: index })) 
                .filter(data => data.item.type.startsWith('exercise'))
                .map(data => ({
                    originalPlanIndex: data.originalIndex, 
                    name: data.item.name, type: data.item.type,
                    reps_target: data.item.reps || data.item.duration,
                    weight_description_target: getFormattedWeight(data.item),
                    finalReps: data.item.reps, finalDuration: data.item.duration,
                    finalWeightDescription: data.item.weight_text || getFormattedWeight(data.item)
                }));
            const localDateString = new Date().toLocaleDateString('sv-SE');
            workoutHistory.push({ date: localDateString, type: currentWorkoutType, durationSeconds: (Date.now() - workoutStartTime) / 1000, exercises: exercisesSummary });
        }
        
        async function deleteWorkoutsByDay(dateString) {
            const originalLength = workoutHistory.length;
            workoutHistory = workoutHistory.filter(h => h.date.split('T')[0] !== dateString);
            if (workoutHistory.length < originalLength) { await saveHistoryToDrive(); showMessage("Séance(s) supprimée(s).", 3000); renderHomeScreen(); }
        }
        
        async function deleteSingleWorkoutFromHistory(isoDateString) {
            const originalLength = workoutHistory.length;
            workoutHistory = workoutHistory.filter(h => h.date !== isoDateString);
            if (workoutHistory.length < originalLength) { await saveHistoryToDrive(); showMessage("Séance supprimée.", 3000); renderHomeScreen(); }
        }

        // =================================================================================
        // SECTION 8: FONCTIONS DE GESTION DES DONNÉES ET GRAPHIQUES (Définition AVANT renderHomeScreen)
        // =================================================================================
        
        function destroyChart(canvasId) {
            if (activeCharts[canvasId]) {
                activeCharts[canvasId].destroy();
                delete activeCharts[canvasId];
            }
        }
        
        // --- RADAR CHART IMPLEMENTATION ---
        function renderRadarChart(canvasEl, sessionName) {
            const canvasId = canvasEl.id;
            destroyChart(canvasId);
            const placeholderEl = document.getElementById(`${canvasId}-placeholder`);
            const sessionTemplate = loadedFullProgram.sessions.find(s => s.nom_session === sessionName);
            if (!sessionTemplate) return;

            const exercises = sessionTemplate.exercices_et_pauses.filter(ex => ex.type.startsWith('exercise'));
            if (exercises.length === 0) {
                 if (placeholderEl) { placeholderEl.textContent = 'Aucun exercice détecté.'; placeholderEl.style.display = 'flex'; }
                 return;
            }
            if (placeholderEl) placeholderEl.style.display = 'none';

            const labels = exercises.map(ex => ex.name.split(':')[0].substring(0, 15));
            const dataValues = exercises.map(ex => {
                return calculateMasteryScore(ex.weight_text, ex.final_target_poids, ex.reps, ex.final_target_reps);
            });
            const targetValues = new Array(exercises.length).fill(100);

            const ctx = canvasEl.getContext('2d');
            activeCharts[canvasId] = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Cible Absolue',
                            data: targetValues,
                            borderColor: 'rgba(255, 215, 0, 0.4)', // Or pâle
                            borderDash: [5, 5],
                            backgroundColor: 'transparent',
                            pointRadius: 0
                        },
                        {
                            label: 'Niveau Actuel',
                            data: dataValues,
                            backgroundColor: 'rgba(0, 191, 255, 0.4)', // Bleu Néon Translucide
                            borderColor: '#00BFFF',
                            pointBackgroundColor: dataValues.map(v => v >= 100 ? '#9400D3' : '#00BFFF'), // Violet si 100%
                            pointBorderColor: '#fff',
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        r: {
                            min: 0, max: 100,
                            angleLines: { color: 'rgba(255, 255, 255, 0.1)' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' },
                            pointLabels: { color: '#A0AEC0', font: { size: 10 } },
                            ticks: { display: false }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- AREA CHART IMPLEMENTATION (Sidebar) ---
        function renderProgressionAreaChart() {
            const ctx = document.getElementById('progression-area-chart').getContext('2d');
            destroyChart('progression-area-chart');

            // Extraction des données : Score moyen par date
            const historyMap = {};
            workoutHistory.forEach(h => {
                const date = h.date.split('T')[0];
                if (!historyMap[date]) historyMap[date] = [];
                if (h.exercises) {
                    let sessionScore = 0;
                    let count = 0;
                    h.exercises.forEach(ex => {
                        sessionScore += (parseEliteWeight(ex.finalWeightDescription) * (ex.finalReps || 1));
                        count++;
                    });
                    if (count > 0) historyMap[date].push(sessionScore / count);
                }
            });

            const labels = Object.keys(historyMap).sort().slice(-10); // Last 10 sessions
            const data = labels.map(date => {
                const scores = historyMap[date];
                return scores.reduce((a,b)=>a+b, 0) / scores.length;
            });

            activeCharts['progression-area-chart'] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.map(d => new Date(d).toLocaleDateString(undefined, {day:'numeric', month:'numeric'})),
                    datasets: [{
                        label: 'Indice de Puissance',
                        data: data,
                        fill: true,
                        backgroundColor: 'rgba(57, 255, 20, 0.2)', // Neon Green Area
                        borderColor: '#39FF14',
                        tension: 0.4,
                        pointRadius: 3
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { grid: { display: false }, ticks: { color: '#A0AEC0', font: {size: 10} } },
                        y: { display: false, min: 0 }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // Moteur d'Assiduité & Ligues
        function getLeagueName(streak) {
            if (streak < 2) return "Bronze";
            if (streak < 4) return "Argent";
            if (streak < 6) return "Or";
            if (streak < 8) return "Platine";
            if (streak < 10) return "Diamant";
            if (streak < 12) return "Maître";
            if (streak < 14) return "Grand Maître";
            if (streak < 16) return "Challenger";
            if (streak < 20) return "Apex";
            return "Légende";
        }

        function getLeagueIndex(streak) {
            if (streak < 2) return 1; if (streak < 4) return 2; if (streak < 6) return 3; if (streak < 8) return 4; if (streak < 10) return 5;
            if (streak < 12) return 6; if (streak < 14) return 7; if (streak < 16) return 8; if (streak < 20) return 9; return 10;
        }

        function updateLeagueVisuals(streak) {
            const leagueIndex = getLeagueIndex(streak);
            document.body.className = document.body.className.replace(/league-\d+/g, '');
            document.body.classList.add(`league-${leagueIndex}`);
        }

        function calculateWeeklyStreak() {
            if (workoutHistory.length < 2) return 0;
            const weeklyGoal = 2; 
            const workoutsByWeek = {};
            workoutHistory.forEach(h => {
                const d = new Date(h.date + 'T00:00:00');
                const firstDayOfWeek = new Date(d);
                firstDayOfWeek.setDate(d.getDate() - (d.getDay() === 0 ? 6 : d.getDay() - 1));
                firstDayOfWeek.setHours(0,0,0,0);
                const weekKey = firstDayOfWeek.toLocaleDateString('sv-SE');
                if (!workoutsByWeek[weekKey]) workoutsByWeek[weekKey] = 0;
                workoutsByWeek[weekKey]++;
            });
            
            let streak = 0;
            let currentWeek = new Date();
            currentWeek.setDate(currentWeek.getDate() - (currentWeek.getDay() === 0 ? 6 : currentWeek.getDay() - 1));
            currentWeek.setHours(0,0,0,0);
            const currentWeekKey = currentWeek.toLocaleDateString('sv-SE');
            let lastWeek = new Date(currentWeek); lastWeek.setDate(lastWeek.getDate() - 7);
            const lastWeekKey = lastWeek.toLocaleDateString('sv-SE');

            let weekToStart = null;
            if (workoutsByWeek[currentWeekKey] >= weeklyGoal) { weekToStart = currentWeek; } 
            else if (workoutsByWeek[lastWeekKey] >= weeklyGoal) { weekToStart = lastWeek; } 
            else { return 0; }
            
            streak = 1;
            let previousWeek = new Date(weekToStart);
            while (true) {
                previousWeek.setDate(previousWeek.getDate() - 7);
                const previousWeekKey = previousWeek.toLocaleDateString('sv-SE');
                if (workoutsByWeek[previousWeekKey] >= weeklyGoal) { streak++; } else { break; }
            }
            return streak;
        }

        function renderRecentWorkoutsList() {
            const container = document.createElement('div');
            container.id = "recent-workouts-container";
            if (workoutHistory.length === 0) return container;
            container.innerHTML = `<h4><i class="fas fa-history"></i> Historique Récent</h4>`;
            const list = document.createElement('ul');
            list.className = 'recent-workouts-list';
            const recentWorkouts = workoutHistory.slice().reverse().slice(0, 5);
            recentWorkouts.forEach(workout => {
                const li = document.createElement('li');
                const date = new Date(workout.date + 'T00:00:00'); 
                const formattedDate = date.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'short' });
                li.innerHTML = `<div class="workout-info-text"><span class="workout-name">${workout.type}</span><span class="workout-date">${formattedDate}</span></div><button class="delete-recent-workout-btn" data-date-iso="${workout.date}" title="Supprimer cette séance"><i class="fas fa-trash-alt"></i></button>`;
                list.appendChild(li);
            });
            container.appendChild(list);
            return container;
        }

        function renderConsistencyCalendarModule(date) {
            let module = document.getElementById('consistency-module');
            if (!module) {
                module = document.createElement('div');
                module.className = 'sidebar-module';
                module.id = 'consistency-module';
            }

            const streak = calculateWeeklyStreak();
            updateLeagueVisuals(streak);
            const leagueName = getLeagueName(streak);

            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - (today.getDay() === 0 ? 6 : today.getDay() - 1));
            startOfWeek.setHours(0, 0, 0, 0);

            const workoutsThisWeek = workoutHistory.filter(h => new Date(h.date) >= startOfWeek).length;
            const weeklyGoal = 2;
            const progressPercent = Math.min((workoutsThisWeek / weeklyGoal) * 100, 100);

            module.innerHTML = `<h3><i class="fas fa-calendar-check"></i> Ligue ${leagueName}</h3>
                <div class="consistency-info">
                    <div class="consistency-text">Objectif semaine : <strong>${workoutsThisWeek} / ${weeklyGoal}</strong></div>
                    <div id="doughnut-container" class="doughnut-chart-container ${progressPercent > 100 ? 'gold-pulse' : ''}">
                        <canvas id="consistency-doughnut-chart"></canvas>
                    </div>
                    <div class="chart-area-container">
                        <canvas id="progression-area-chart"></canvas>
                    </div>
                    <div class="streak-counter"><i class="fas fa-fire-alt"></i> ${streak} semaines consécutives</div>
                </div>
                <div class="calendar-nav">
                    <button class="prev-month"><i class="fas fa-chevron-left"></i></button>
                    <span class="calendar-title">${date.toLocaleString('fr-FR', { month: 'long', year: 'numeric' })}</span>
                    <button class="next-month"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="monthly-calendar"></div>`;

            setTimeout(() => {
                const ctx = document.getElementById('consistency-doughnut-chart').getContext('2d');
                destroyChart('consistency-doughnut-chart');
                const themeColor = getComputedStyle(document.body).getPropertyValue('--theme-color').trim();
                const remaining = Math.max(0, weeklyGoal - workoutsThisWeek);
                
                activeCharts['consistency-doughnut-chart'] = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Réalisé', 'Restant'],
                        datasets: [{ data: [workoutsThisWeek, remaining], backgroundColor: [themeColor, 'rgba(255, 255, 255, 0.1)'], borderWidth: 0, circumference: 360, rotation: 0 }]
                    },
                    options: { cutout: '75%', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } } },
                    plugins: [{
                        id: 'textCenter',
                        beforeDraw: function(chart) {
                            var width = chart.width, height = chart.height, ctx = chart.ctx;
                            ctx.restore();
                            var fontSize = (height / 114).toFixed(2);
                            ctx.font = "bold " + fontSize + "em sans-serif";
                            ctx.textBaseline = "middle";
                            ctx.fillStyle = themeColor;
                            var text = Math.round(progressPercent) + "%", textX = Math.round((width - ctx.measureText(text).width) / 2), textY = height / 2;
                            ctx.fillText(text, textX, textY);
                            ctx.save();
                        }
                    }]
                });
                
                // Render Area Chart
                if(workoutHistory.length > 0) renderProgressionAreaChart();
            }, 0);

            const calendarGrid = module.querySelector('.monthly-calendar');
            const workoutDays = new Set(workoutHistory.map(h => h.date.split('T')[0]));
            const month = date.getMonth();
            const year = date.getFullYear();
            const firstDay = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const dateOffset = (firstDay.getDay() + 6) % 7;
            const weekDays = ['L', 'M', 'M', 'J', 'V', 'S', 'D'];

            weekDays.forEach(day => { const header = document.createElement('div'); header.className = 'calendar-header'; header.textContent = day; calendarGrid.appendChild(header); });
            for (let i = 0; i < dateOffset; i++) { calendarGrid.appendChild(document.createElement('div')); }
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                dayCell.textContent = day;
                const dayString = String(day).padStart(2, '0');
                const monthString = String(month + 1).padStart(2, '0');
                const dateString = `${year}-${monthString}-${dayString}`;
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) { dayCell.classList.add('today'); }
                if (workoutDays.has(dateString)) {
                    const dot = document.createElement('span'); dot.className = 'day-dot'; dayCell.appendChild(dot);
                    const deleteBtn = document.createElement('i'); deleteBtn.className = 'fas fa-trash-alt delete-workout-btn'; deleteBtn.dataset.date = dateString; deleteBtn.title = `Supprimer les séances du ${new Date(year, month, day).toLocaleDateString('fr-FR')}`; dayCell.appendChild(deleteBtn);
                }
                calendarGrid.appendChild(dayCell);
            }

            const recentWorkoutsEl = renderRecentWorkoutsList();
            module.appendChild(recentWorkoutsEl);
            return module;
        }

        // =================================================================================
        // SECTION 4: INTÉGRATION API GOOGLE DRIVE (Retour à l'ordre)
        // =================================================================================

        async function gisInitInternal() {
            if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
                try {
                    tokenClient = google.accounts.oauth2.initTokenClient({ client_id: GOOGLE_CLIENT_ID, scope: GOOGLE_DRIVE_SCOPES, callback: tokenCallback, error_callback: handleTokenError });
                    // AJOUT: Tentative de connexion silencieuse
                    if (tokenClient) tokenClient.requestAccessToken({ prompt: '' });
                    if (signInButton) signInButton.disabled = false;
                } catch (error) { console.error(`GIS client init failed: ${error.message}`); showMessage("Erreur initialisation services Google.", 5000, true); updateAuthUI(false); if (signInButton) signInButton.disabled = true; }
            } else { if (signInButton) signInButton.disabled = true; }
        }

        function checkAndInitGis() {
            if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2 && typeof google.accounts.oauth2.initTokenClient === 'function') {
                gisInitInternal();
            } else if (gisCheckRetries < GIS_MAX_RETRIES) { 
                gisCheckRetries++; 
                setTimeout(checkAndInitGis, GIS_CHECK_INTERVAL); 
            } else { 
                console.error("Critique: Librairie GIS non chargée après plusieurs tentatives."); 
                showMessage("Erreur critique: API Google non disponible.", 10000, true); 
                if (signInButton) signInButton.disabled = true; 
            }
        }

        function handleTokenError(error) {
            let msg = `Erreur Authentification Google: ${error.type || error.error || 'Inconnue'}`;
            if (error.type === 'popup_closed_by_user' || error.error === 'popup_closed_by_user') msg = "Fenêtre de connexion Google fermée.";
            else if (error.type === 'popup_failed_to_open') msg = "Impossible d'ouvrir la fenêtre de connexion. Vérifiez les bloqueurs de popups.";
            else if (error.type === 'USER_CANCELLED' || error.error === 'access_denied') msg = "Accès aux données Drive refusé par l'utilisateur.";
            if (driveStatusElement) { driveStatusElement.className = 'error'; driveStatusElement.style.display = 'inline-flex'; }
            showMessage(msg, 7000, true); if (driveStatusTextElement) driveStatusTextElement.textContent = 'Erreur Auth'; updateAuthUI(false);
        }

        async function tokenCallback(tokenResponse) {
            if (driveStatusElement) driveStatusElement.className = '';
            if (tokenResponse.error) { if (tokenResponse.error !== "popup_failed_to_open" && tokenResponse.error !== "popup_closed_by_user") handleTokenError(tokenResponse); else updateAuthUI(false); return; }
            if (tokenResponse && tokenResponse.access_token) {
                googleAccessToken = tokenResponse.access_token; showMessage("Connecté ! Chargement des données...", 2500);
                if (driveStatusElement) { driveStatusElement.classList.remove('error', 'success'); driveStatusElement.classList.add('loading'); driveStatusElement.style.display = 'inline-flex'; }
                if (driveStatusTextElement) driveStatusTextElement.textContent = 'Chargement...';
                try {
                    await loadHistoryFromDrive();
                    const programLoadSuccess = await loadFullProgramFromDrive();
                    
                    if (programLoadSuccess) {
                        showMessage("Programme et données chargés depuis votre Drive.", 3000);
                        if (driveStatusElement) { driveStatusElement.classList.remove('loading', 'error'); driveStatusElement.classList.add('success'); }
                        if (driveStatusTextElement) driveStatusTextElement.textContent = 'Connecté';
                    } else {
                        showMessage(`Erreur chargement '${FULL_PROGRAM_FILENAME}' depuis Drive. Assurez-vous que le fichier existe.`, 8000, true);
                        if (driveStatusElement) { driveStatusElement.classList.remove('loading'); driveStatusElement.classList.add('error'); }
                        if (driveStatusTextElement) driveStatusTextElement.textContent = 'Prog absent';
                    }
                } catch (error) {
                    showMessage("Erreur majeure lors du chargement des données.", 6000, true);
                    if (driveStatusElement) { driveStatusElement.classList.remove('loading', 'success'); driveStatusElement.classList.add('error'); }
                    if (driveStatusTextElement) driveStatusTextElement.textContent = 'Erreur Données';
                } finally { 
                    updateAuthUI(true); 
                    loadInProgressState(); // Maintenant définie et accessible
                    renderHomeScreen(); // Maintenant définie
                }
            } else handleTokenError({ error: "Réponse de token invalide ou vide" });
        }

        function handleAuthClick() {
            initAudioContext();
            if (!tokenClient) { showMessage("Services Google non prêts. Veuillez patienter.", 3000); checkAndInitGis(); return; }
            if (driveStatusElement) { driveStatusElement.classList.remove('error', 'success'); driveStatusElement.classList.add('loading'); driveStatusElement.style.display = 'inline-flex'; }
            if (driveStatusTextElement) driveStatusTextElement.textContent = 'Connexion...';
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }
        
        async function handleCorruptedFile(fileId, filename) {
            const date = new Date().toISOString().split('T')[0];
            const newName = `${filename.replace('.json', '')}_CORRUPT_${date}.json`;
            showMessage(`Fichier '${filename}' corrompu. Sauvegarde de la version corrompue...`, 6000, true);
            try {
                const response = await fetch(`https://www.googleapis.com/drive/v3/files/${fileId}`, {
                    method: 'PATCH',
                    headers: { 'Authorization': `Bearer ${googleAccessToken}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: newName })
                });
                if (!response.ok) throw new Error(`Échec du renommage (${response.status})`);
                showMessage(`Fichier corrompu renommé en '${newName}'. Création d'un nouveau fichier.`, 8000);
                return true;
            } catch (error) {
                showMessage(`Action impossible sur le fichier corrompu. Veuillez vérifier votre Google Drive.`, 10000, true);
                return false;
            }
        }

        async function findOrCreateFile(filename, defaultContentStr = "{}", mimeType = 'application/json', createIfNotExist = false) {
            if (!googleAccessToken) { return null; }
            const searchUrl = `https://www.googleapis.com/drive/v3/files?q=name='${encodeURIComponent(filename)}'%20and%20trashed=false&spaces=drive&fields=files(id,name)`;
            try {
                const searchRes = await fetch(searchUrl, { headers: { 'Authorization': `Bearer ${googleAccessToken}` } });
                if (!searchRes.ok) { 
                    if (searchRes.status === 401 || searchRes.status === 403) { 
                        showMessage("Session Google expirée. Veuillez vous reconnecter.", 5000, "error"); googleAccessToken = null; updateAuthUI(false); return null; 
                    } 
                    throw new Error(`Recherche échouée (${searchRes.status})`); 
                }
                const searchData = await searchRes.json();
                if (searchData.files && searchData.files.length > 0) { return searchData.files[0].id; }
                if (!createIfNotExist) { return null; }
                
                const metadata = { name: filename, mimeType: mimeType };
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', new Blob([defaultContentStr], { type: mimeType }));

                const createRes = await fetch(`https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart`, { method: 'POST', headers: { 'Authorization': `Bearer ${googleAccessToken}` }, body: form });
                if (!createRes.ok) throw new Error(`Création échouée (${createRes.status})`);
                const createData = await createRes.json();
                return createData.id;
            } catch (error) { 
                showMessage(`Erreur Drive (${filename.substring(0, 15)}...): ${error.message}`, 6000, "error"); return null; 
            }
        }

        async function readFileContent(fileId, filename) {
            if (!googleAccessToken || !fileId) return null;
            const url = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`;
            try {
                const response = await fetch(url, { headers: { 'Authorization': `Bearer ${googleAccessToken}` } });
                if (!response.ok) {
                    if (response.status === 404) { return null; }
                    if (response.status === 401 || response.status === 403) { showMessage("Session Google expirée. Veuillez vous reconnecter.", 5000, "error"); googleAccessToken = null; updateAuthUI(false); return null; }
                    throw new Error(`Lecture échouée (${response.status})`);
                }
                return await response.text();
            } catch (error) { showMessage(`Erreur Lecture Drive: ${error.message}`, 6000, "error"); return null; }
        }

        async function updateFileContent(fileId, content, filename) {
            if (!googleAccessToken || !fileId) return false;
            if (isSavingDriveData) { return false; }
            isSavingDriveData = true;
            updateAuthUI(!!googleAccessToken);
            const url = `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`;
            const contentToSend = typeof content === 'object' ? JSON.stringify(content, null, 2) : content;
            let success = false;
            try {
                const response = await fetch(url, { method: 'PATCH', headers: { 'Authorization': `Bearer ${googleAccessToken}`, 'Content-Type': 'application/json; charset=UTF-8' }, body: contentToSend });
                if (!response.ok) { 
                    if (response.status === 401 || response.status === 403) { 
                        showMessage("Session expirée. Reconnectez-vous pour sauvegarder.", 5000, true); googleAccessToken = null; updateAuthUI(false);
                    } else throw new Error(`Écriture échouée ${response.status}`); 
                }
                else { success = true; }
            } catch (error) { 
                showMessage(`Erreur sauvegarde fichier Drive.`, 5000, true); 
            }
            finally { isSavingDriveData = false; updateAuthUI(!!googleAccessToken); } return success;
        }

        // =================================================================================
        // SECTION 9: RÉSUMÉ POST-ENTRAÎNEMENT & ÉDITION (FINAL)
        // =================================================================================
        
        function populateAndShowSummary(context) {
            currentSummaryContext = context;
            if (!postWorkoutSummary || !summaryItemsList || !summaryTitle || !finishSummaryBtn) return;
            
            let planToShow, sessionName;
            const isWorkoutMode = context.mode === 'workout';
            const chartContainer = document.getElementById('analysis-chart-container');

            if (isWorkoutMode) {
                sessionName = context.sessionName; planToShow = originalCompletedWorkoutPlan;
                summaryTitle.textContent = `Résumé: ${sessionName || 'Entraînement'}`; finishSummaryBtn.innerHTML = `<i class="fas fa-check"></i> Terminer & Sauvegarder`;
                if (chartContainer) chartContainer.style.display = 'none';

            } else { 
                sessionName = context.sessionName; 
                const session = loadedFullProgram.sessions.find(s => s.nom_session === sessionName);
                planToShow = session ? JSON.parse(JSON.stringify(session.exercices_et_pauses)) : [];
                summaryTitle.textContent = `Édition : ${sessionName}`; finishSummaryBtn.innerHTML = `<i class="fas fa-save"></i> Enregistrer`;
                if (chartContainer) chartContainer.style.display = 'none';
            }
            summaryItemsList.innerHTML = '';
            
            planToShow.forEach((item, index) => {
                if (item.type.startsWith('exercise')) {
                    const li = document.createElement('li');
                    li.classList.add('summary-item'); 
                    li.dataset.planIndex = index;
                    
                    const isTimed = item.duration !== undefined && item.duration !== null;
                    const initialValue = isTimed ? item.duration : (item.reps || 0); 
                    const parsedWeight = parseWeightDescription(getFormattedWeight(item));
                    const dynamicSetsInfo = getDynamicSetsInfo(index, planToShow);

                    // Calcul de Maîtrise pour Badge
                    let vibraniumBadge = '';
                    if (isWorkoutMode) {
                        const score = calculateMasteryScore(item.weight_text, item.final_target_poids, item.reps, item.final_target_reps);
                        if (score >= 100) {
                            li.classList.add('vibranium-mastered');
                            vibraniumBadge = `<div class="badge-vibranium"><i class="fas fa-trophy"></i> VIBRANIUM MASTERED</div>`;
                        }
                    }

                    li.innerHTML = `
                        ${vibraniumBadge}
                        <div class="exercise-name"><span class="exercise-name-text">${dynamicSetsInfo ? dynamicSetsInfo + ': ' : ''}${item.name}</span></div>
                        <div class="fields-grid" style="grid-template-columns: 1fr 1fr; gap: 20px; align-items: start;">
                             
                             <!-- COLONNE 1 : PERFORMANCE DU JOUR (TIMER) -->
                             <div style="background: rgba(0, 191, 255, 0.05); padding: 10px; border-radius: 8px; border: 1px solid rgba(0, 191, 255, 0.2);">
                                <h4 style="font-size: 0.8em; text-transform: uppercase; color: var(--electric-blue); margin-bottom: 8px;"><i class="fas fa-bolt"></i> Séance Actuelle</h4>
                                
                                <div class="input-group" data-field="performance-and-base">
                                    <label>Reps / Temps</label>
                                    <div class="stepper-control" data-type="performance-and-base"><button class="stepper-btn stepper-minus">-</button><span class="stepper-value">${initialValue}</span><button class="stepper-btn stepper-plus">+</button></div>
                                </div>
                                <div class="input-group" style="margin-top:8px;">
                                    <label>Charge / Résistance</label>
                                    <div class="resistance-controls" style="flex-direction:column;">
                                        <div class="resistance-selector" data-type="${parsedWeight.type}" style="margin-bottom:5px;">
                                            <div class="selected-resistance" style="padding: 6px;"><span>${resistanceTypes[parsedWeight.type].emoji}</span><i class="fas fa-caret-down"></i></div>
                                            <ul class="resistance-options">${Object.entries(resistanceTypes).map(([key, val]) => `<li data-value="${key}"><span>${val.emoji}</span> ${val.text}</li>`).join('')}</ul>
                                        </div>
                                        <div class="stepper-control resistance-value-stepper" data-type="weight" style="display: ${['poids', 'poids_elastique'].includes(parsedWeight.type) ? 'flex' : 'none'}">
                                            <button class="stepper-btn stepper-minus">-</button>
                                            <span class="stepper-value">${parsedWeight.value}</span>
                                            <button class="stepper-btn stepper-plus">+</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="input-group" style="margin-top:8px;"><label>Mode</label><div class="tracking-type-toggle" data-type="tracking-type"><button class="tracking-reps ${!isTimed ? 'active' : ''}" data-value="reps">Reps</button><button class="tracking-time ${isTimed ? 'active' : ''}" data-value="time">Temps</button></div></div>
                             </div>

                             <!-- COLONNE 2 : CIBLE FINALE (GRAPHIQUE) -->
                             <div class="goal-section" style="background: rgba(255, 215, 0, 0.05); padding: 10px; border-radius: 8px; border: 1px solid rgba(255, 215, 0, 0.2);">
                                <h4 style="font-size: 0.8em; text-transform: uppercase; color: #FFD700; margin-bottom: 8px;"><i class="fas fa-bullseye"></i> Objectif Final</h4>
                                <div class="input-group">
                                    <label>Cible Charge (Texte/Kg)</label>
                                    <input type="text" class="goal-weight-input" value="${item.final_target_poids || ''}" style="width:100%; background:var(--input-bg); border:1px solid var(--border-color); color:white; padding:8px; border-radius:4px; font-family:var(--font-family-main);">
                                </div>
                                <div class="input-group" style="margin-top:8px;">
                                    <label>Cible Reps</label>
                                    <input type="number" class="goal-reps-input" value="${item.final_target_reps || 12}" style="width:100%; background:var(--input-bg); border:1px solid var(--border-color); color:white; padding:8px; border-radius:4px; font-family:var(--font-family-main);">
                                </div>
                             </div>

                        </div>`;
                    summaryItemsList.appendChild(li);
                }
            });
            postWorkoutSummary.classList.add('visible');
        }

        async function finishSummary() {
            if (!finishSummaryBtn) return;
            finishSummaryBtn.disabled = true;
            finishSummaryBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sauvegarde...';

            const isWorkoutMode = currentSummaryContext.mode === 'workout';
            const sessionName = currentSummaryContext.sessionName;
            const sessionIndex = loadedFullProgram.sessions.findIndex(s => s.nom_session === sessionName);
            
            if (sessionIndex === -1) {
                closeSummary(); showMessage("Erreur Critique: Session introuvable dans le programme.", 4000, true); return;
            }

            const latestWorkoutEntry = isWorkoutMode ? workoutHistory[workoutHistory.length - 1] : null;
            const summaryItems = summaryItemsList.querySelectorAll('.summary-item');
            
            summaryItems.forEach(item => {
                const planIndex = parseInt(item.dataset.planIndex, 10);
                if (isNaN(planIndex)) return; 

                const planItemToUpdate = loadedFullProgram.sessions[sessionIndex].exercices_et_pauses[planIndex];
                if (!planItemToUpdate) return;

                // 1. Lire TOUTES les valeurs de l'UI
                const newPerformanceAndBaseValue = parseInt(item.querySelector('[data-type="performance-and-base"] .stepper-value').textContent, 10);
                const trackingType = item.querySelector('.tracking-type-toggle[data-type="tracking-type"] .active').dataset.value;
                
                // Gestion du Poids Actuel (Stepper)
                let newWeightText = planItemToUpdate.weight_text; 
                const resistanceSelector = item.querySelector('.resistance-selector');
                if (resistanceSelector) {
                    const resistanceType = resistanceSelector.dataset.type;
                    const weightValue = parseFloat(item.querySelector('.stepper-control[data-type="weight"] .stepper-value').textContent);
                    newWeightText = resistanceTypes[resistanceType].emoji;
                    if (['poids', 'poids_elastique'].includes(resistanceType)) { newWeightText += ` ${weightValue} kg`; }
                }

                // Gestion des Nouveaux Objectifs (Inputs Texte/Number)
                const newGoalWeight = item.querySelector('.goal-weight-input').value;
                const newGoalReps = item.querySelector('.goal-reps-input').value;

                // 2. Appliquer les modifications (Sauvegarde pour la prochaine fois)
                planItemToUpdate.weight_text = newWeightText;
                planItemToUpdate.final_target_poids = newGoalWeight;
                planItemToUpdate.final_target_reps = newGoalReps;
                
                delete planItemToUpdate.unit;
                delete planItemToUpdate.weight;

                if (trackingType === 'time') {
                    planItemToUpdate.duration = newPerformanceAndBaseValue;
                    delete planItemToUpdate.reps;
                    delete planItemToUpdate.reps_text;
                    delete planItemToUpdate.reps_unit;
                } else {
                    planItemToUpdate.reps = newPerformanceAndBaseValue;
                    delete planItemToUpdate.duration;
                    delete planItemToUpdate.unit_duration;
                    delete planItemToUpdate.reps_text;
                }
                
                // 3. Mettre à jour l'historique de la session si applicable
                if (isWorkoutMode && latestWorkoutEntry?.exercises) {
                    const exerciseLog = latestWorkoutEntry.exercises.find(ex => ex.originalPlanIndex === planIndex);
                    if(exerciseLog) {
                        exerciseLog.finalWeightDescription = newWeightText;
                        if (trackingType === 'time') {
                            exerciseLog.finalDuration = newPerformanceAndBaseValue;
                            delete exerciseLog.finalReps;
                        } else {
                            exerciseLog.finalReps = newPerformanceAndBaseValue;
                            delete exerciseLog.finalDuration;
                        }
                    }
                }
            });

            // 4. Sauvegarder les fichiers sur le Drive
            if (isWorkoutMode) {
                await saveHistoryToDrive();
            }
            await saveFullProgramToDrive();
            
            closeSummary(false);
            setState('idle');
            showMessage("Modifications sauvegardées avec succès !", 3500);
            if (finishSummaryBtn) {
                finishSummaryBtn.disabled = false;
                finishSummaryBtn.innerHTML = isWorkoutMode ? '<i class="fas fa-check"></i> Terminer & Sauvegarder' : '<i class="fas fa-save"></i> Enregistrer';
            }
        }
        
        function closeSummary(shouldReset = true) {
            if(postWorkoutSummary) postWorkoutSummary.classList.remove('visible');
            if (shouldReset) setState('idle');
        }

        // =================================================================================
        // SECTION 10: INITIALISATION ET ÉCOUTEURS D'ÉVÉNEMENTS
        // =================================================================================

        document.addEventListener('DOMContentLoaded', () => {
            initializeDOMReferences();
            addEventListeners();
            initSounds();
            checkAndInitGis();
            document.getElementById('current-year').textContent = new Date().getFullYear();
            setState('idle');
        });

        function initializeDOMReferences() {
            try {
                timeDisplayDiv = document.getElementById("time-left"); currentExerciseContainer = document.getElementById("current-exercise-container");
                progressTracker = document.getElementById("progress-tracker"); startPauseBtn = document.getElementById("start-pause-btn");
                skipBtn = document.getElementById("skip-btn"); finishBtn = document.getElementById("finish-btn");
                resetBtn = document.getElementById("reset-btn"); prevBtn = document.getElementById("prev-btn");
                messageArea = document.getElementById("message-area"); homeSection = document.getElementById("home-section");
                workoutSection = document.getElementById("workout-section"); signInButton = document.getElementById("signin-button");
                driveStatusElement = document.getElementById("drive-status"); driveStatusTextElement = document.getElementById("drive-status-text");
                postWorkoutSummary = document.getElementById("post-workout-summary"); summaryTitle = document.getElementById("summary-title");
                summaryItemsList = document.getElementById("summary-items-list"); finishSummaryBtn = document.getElementById("finish-summary-btn");
                currentExerciseNameDisplay = document.getElementById("current-exercise-name-display");
                driveConnectionStatusMain = document.getElementById("drive-connection-status-main"); driveConnectionText = document.getElementById("drive-connection-text");
                timerDisplayElement = document.querySelector(".timer-display"); reactorElement = document.querySelector(".reactor");
                exerciseImageContainer = document.getElementById("exercise-image-container"); exerciseImageDisplay = document.getElementById("exercise-image-display");
                progressTextArea = document.getElementById("progress-text-area"); editProgramBtn = document.getElementById("edit-program-btn");
                timerProgressIndicator = document.getElementById("timer-progress-indicator"); workoutStepTotalDisplay = document.getElementById("workout-step-total-display");
                workoutStepCurrentDisplay = document.getElementById("workout-step-current-display"); workoutStepInfoDisplay = document.getElementById("workout-step-info-display");
                timerView = document.getElementById("timer-view"); workoutInfoView = document.getElementById("workout-info");
                controls = document.querySelector(".controls");
            } catch(e) {
                document.body.innerHTML = "<p style='color:white; text-align:center; padding-top: 50px;'>Erreur critique au chargement de l'application. Veuillez rafraîchir la page.</p>";
            }
        }
        
        function addEventListeners() {
            startPauseBtn?.addEventListener('click', () => {
                initAudioContext();
                const item = currentWorkoutPlan[currentItemIndex];
                if (isTimerRunning) {
                    setState('paused');
                } else if (currentState === 'paused') {
                    if (item && item.type.startsWith('exercise')) setState('exercise');
                    else if (item && item.type === 'break') setState('break');
                } else if (currentState === 'exercise') {
                    if (item && (item.duration === undefined || item.duration === null)) {
                        handleItemCompletion();
                    }
                }
            });
            timerDisplayElement?.addEventListener('click', () => {
                initAudioContext();
                const item = currentWorkoutPlan[currentItemIndex];
                if (isWorkoutActive && currentState === 'exercise' && item && (item.duration === undefined || item.duration === null)) {
                    handleItemCompletion();
                }
            });
            skipBtn?.addEventListener('click', () => { initAudioContext(); if (isWorkoutActive) handleItemCompletion(); });
            prevBtn?.addEventListener('click', () => { initAudioContext(); handlePreviousClick(); });
            finishBtn?.addEventListener('click', () => { initAudioContext(); forceFinishWorkout(); });
            resetBtn?.addEventListener('click', () => { initAudioContext(); resetCurrentWorkout(); });
            editProgramBtn?.addEventListener('click', toggleEditMode);
            homeSection?.addEventListener('click', handleHomeInteraction);
            signInButton?.addEventListener('click', handleAuthClick);
            finishSummaryBtn?.addEventListener('click', finishSummary);
            summaryItemsList?.addEventListener('click', handleSummaryControls);
            document.addEventListener('click', (e) => { if (!e.target.closest('.resistance-selector')) { document.querySelectorAll('.resistance-selector.open').forEach(el => el.classList.remove('open')); }});
            document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'hidden' && isWorkoutActive) saveInProgressState(); });
            window.addEventListener('beforeunload', () => { if (isWorkoutActive) saveInProgressState(); });
        }

        function handleHomeInteraction(e) {
            const card = e.target.closest('.session-card-large');
            const prevMonthBtn = e.target.closest('.prev-month');
            const nextMonthBtn = e.target.closest('.next-month');
            const deleteCalendarBtn = e.target.closest('.delete-workout-btn');
            const deleteRecentBtn = e.target.closest('.delete-recent-workout-btn');

            if (deleteCalendarBtn) {
                e.stopPropagation();
                const date = deleteCalendarBtn.dataset.date;
                const formattedDate = new Date(date + 'T00:00:00').toLocaleDateString('fr-FR', {day: '2-digit', month: 'long'});
                if (confirm(`Voulez-vous vraiment supprimer TOUTES les séances du ${formattedDate} ?`)) {
                    deleteWorkoutsByDay(date);
                }
            } else if (deleteRecentBtn) {
                e.stopPropagation();
                const isoDate = deleteRecentBtn.dataset.dateIso;
                const workoutToDelete = workoutHistory.find(h => h.date === isoDate);
                if (workoutToDelete && confirm(`Voulez-vous vraiment supprimer la séance "${workoutToDelete.type}" du ${new Date(isoDate+'T00:00:00').toLocaleDateString('fr-FR')} ?`)) {
                    deleteSingleWorkoutFromHistory(isoDate);
                }
            } else if (card) {
                initAudioContext();
                if (isEditMode) {
                    populateAndShowSummary({mode: 'edit', sessionName: card.dataset.sessionName});
                } else {
                    loadSession(card.dataset.sessionName);
                }
            } else if (prevMonthBtn) {
                displayedCalendarDate.setMonth(displayedCalendarDate.getMonth() - 1);
                document.getElementById('consistency-module')?.replaceWith(renderConsistencyCalendarModule(displayedCalendarDate));
            } else if (nextMonthBtn) {
                displayedCalendarDate.setMonth(displayedCalendarDate.getMonth() + 1);
                document.getElementById('consistency-module')?.replaceWith(renderConsistencyCalendarModule(displayedCalendarDate));
            }
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            editProgramBtn.classList.toggle('active', isEditMode);
            showMessage(isEditMode ? "Mode édition activé. Cliquez sur une séance pour la modifier." : "Mode édition désactivé.", 3000);
            document.querySelectorAll('.session-card-large').forEach(card => {
                card.classList.toggle('edit-mode-active', isEditMode);
            });
        }
        
        function handleSummaryControls(e) {
            const stepperBtn = e.target.closest('.stepper-btn');
            const resistanceSelect = e.target.closest('.selected-resistance');
            const resistanceOption = e.target.closest('.resistance-options li');
            const trackingToggle = e.target.closest('.tracking-type-toggle button');

            if (stepperBtn) {
                const stepperControl = stepperBtn.closest('.stepper-control');
                const valueEl = stepperControl.querySelector('.stepper-value');
                if (!valueEl) return;
                
                let value = parseFloat(valueEl.textContent);
                const type = stepperControl.dataset.type;
                const isPlus = stepperBtn.classList.contains('stepper-plus');
                const step = (type === 'weight') ? 0.5 : 1;
                
                value = isPlus ? value + step : Math.max(0, value - step);
                valueEl.textContent = (type === 'weight') ? value.toFixed(1).replace(/\.0$/, '') : value;
            } else if (resistanceSelect) {
                const selector = resistanceSelect.closest('.resistance-selector');
                document.querySelectorAll('.resistance-selector.open').forEach(el => { if(el !== selector) el.classList.remove('open'); });
                selector.classList.toggle('open');
            } else if (resistanceOption) {
                const selector = resistanceOption.closest('.resistance-selector');
                const value = resistanceOption.dataset.value;
                selector.dataset.type = value;
                selector.querySelector('.selected-resistance span').textContent = resistanceTypes[value].emoji;
                selector.classList.remove('open');
                const weightStepper = selector.closest('.resistance-controls').querySelector('.resistance-value-stepper');
                weightStepper.style.display = ['poids', 'poids_elastique'].includes(value) ? 'flex' : 'none';
            } else if (trackingToggle) {
                const parent = trackingToggle.parentElement;
                parent.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                trackingToggle.classList.add('active');
                
                // Si c'est un toggle OUI/NON (Objectif textuel)
                if (trackingToggle.parentElement.dataset.type === 'qualitative-goal') {
                    // Rien de plus à faire ici, l'état active est géré
                } else {
                    // Si c'est un toggle Reps/Temps
                    const summaryItem = trackingToggle.closest('.summary-item');
                    const newType = trackingToggle.dataset.value;
                    const isTimed = newType === 'time';
                    summaryItem.querySelector('[data-field="performance-and-base"] label').textContent = `Performance / Prochaine Base (${isTimed ? 'secondes' : 'répétitions'})`;
                }
            }
        }

    </script>
</body>
</html>
