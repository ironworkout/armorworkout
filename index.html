```html
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArmorWorkout - Électrique</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color-dark: #030712; /* Noir bleuté très profond */
            --secondary-bg-color-dark: #0B132B; /* Bleu nuit plus sombre pour les cartes */
            --primary-text-color-dark: #F0F4F8; /* Blanc cassé / Gris très clair */
            --secondary-text-color-dark: #A0AEC0; /* Gris bleuté moyen */
            --border-color-dark: #1E293B; /* Gris-bleu sombre pour bordures subtiles */

            /* Palette électrique */
            --electric-blue: #00BFFF; /* Deep Sky Blue - Principal pour lueurs */
            --electric-cyan: #22D3EE; /* Cyan vif pour highlights */
            --electric-blue-light: #4D94FF; /* Bleu plus clair */
            --glow-accent: #0AF; /* Un bleu encore plus intense pour accents */

            --electric-blue-rgb: 0, 191, 255;
            --electric-cyan-rgb: 34, 211, 238;
            --glow-accent-rgb: 0, 170, 255;
            --secondary-bg-color-dark-rgb: 11, 19, 43;
            --bg-color-dark-rgb: 3, 7, 18;

            /* Couleurs Néon (ajoutées pour cohérence) */
            --neon-pink: #FF1493; /* DeepPink - Pour historique type */
            --neon-purple: #9400D3; /* DarkViolet - Pour historique reps */
            --neon-green: #39FF14; /* Vert Néon éclatant - Pour succès, boutons d'action */
            --neon-red: #FF3131; /* Rouge Néon vif - Pour erreurs, boutons d'action */
            --neon-yellow: #FFF01F; /* Jaune Néon - Pour avertissements, chargement */

            --neon-pink-rgb: 255, 20, 147;
            --neon-purple-rgb: 148, 0, 211;
            --neon-green-rgb: 57, 255, 20;
            --neon-red-rgb: 255, 49, 49;
            --neon-yellow-rgb: 255, 240, 31;

            /* Effets de lueur pour les couleurs néon */
            --glow-red: 0 0 8px var(--neon-red), 0 0 12px rgba(var(--neon-red-rgb),0.7);
            --glow-green: 0 0 8px var(--neon-green), 0 0 12px rgba(var(--neon-green-rgb),0.7);
            --glow-yellow: 0 0 8px var(--neon-yellow), 0 0 12px rgba(var(--neon-yellow-rgb),0.7);
            --glow-pink: 0 0 8px var(--neon-pink), 0 0 12px rgba(var(--neon-pink-rgb),0.7);
            --glow-purple: 0 0 8px var(--neon-purple), 0 0 12px rgba(var(--neon-purple-rgb),0.7);
            
            --electric-yellow: var(--neon-yellow); /* Alias pour cohérence si electric-yellow est utilisé */
            --electric-yellow-rgb: var(--neon-yellow-rgb);


            /* Couleurs par état (adaptées au thème électrique) */
            --exercise-color-val: var(--electric-blue-light);
            --break-color-val: var(--electric-cyan);
            --paused-color-val: #A78BFA; /* Violet distinct pour la pause */
            --finished-color-val: var(--neon-green); /* Vert néon pour "fini" */
            --preparing-color-val: var(--electric-cyan);
            --idle-color-val: var(--electric-blue);

            --exercise-color-rgb: 77, 148, 255; /* RGB pour --electric-blue-light */
            --break-color-rgb: var(--electric-cyan-rgb);
            --paused-color-rgb: 167, 139, 250;
            --finished-color-rgb: var(--neon-green-rgb); /* RGB pour --neon-green */
            --preparing-color-rgb: var(--electric-cyan-rgb);
            --idle-color-rgb: var(--electric-blue-rgb);

            --color-exercise: var(--exercise-color-val);
            --color-break: var(--break-color-val);
            --color-prepare: var(--preparing-color-val);
            --color-finished: var(--finished-color-val);
            --color-paused: var(--paused-color-val);
            --color-idle: var(--secondary-text-color-dark);

            --font-family-main: 'Inter', sans-serif;
            --font-family-timer: 'Orbitron', sans-serif;
            --font-family-titles: 'Orbitron', sans-serif; /* Pour les titres de section */

            --border-radius-lg: 10px;
            --border-radius-md: 8px;
            --border-radius-sm: 6px;

            --transition-speed: 0.3s;
            --section-transition-speed: 0.4s;

            /* Variables de thème (mode sombre par défaut) */
            --bg-color: var(--bg-color-dark);
            --secondary-bg-color: var(--secondary-bg-color-dark);
            --primary-text-color: var(--primary-text-color-dark);
            --secondary-text-color: var(--secondary-text-color-dark);
            --border-color: var(--border-color-dark);
            --accent-border-color: rgba(var(--electric-blue-rgb), 0.4); /* Bordure d'accentuation bleue */
            --input-bg: #1A202C; /* Fond d'input plus sombre */

            --current-timer-color: var(--idle-color-val);
            --current-timer-glow: 0 0 15px var(--idle-color-val), 0 0 25px rgba(var(--idle-color-rgb), 0.3);
            --current-timer-color-rgb: var(--idle-color-rgb); /* Ajout pour textGlowPulse */
        }

        @keyframes subtlePulse {
            0%, 100% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.015); }
        }

        @keyframes electricBorder {
            0% {
                box-shadow: 0 0 6px rgba(var(--electric-cyan-rgb), 0.6), inset 0 0 4px rgba(var(--electric-cyan-rgb), 0.4);
                border-color: rgba(var(--electric-cyan-rgb), 0.7);
            }
            50% {
                box-shadow: 0 0 18px rgba(var(--electric-blue-rgb), 0.8), inset 0 0 10px rgba(var(--electric-blue-rgb), 0.6);
                border-color: rgba(var(--electric-blue-rgb), 0.9);
            }
            100% {
                box-shadow: 0 0 6px rgba(var(--electric-cyan-rgb), 0.6), inset 0 0 4px rgba(var(--electric-cyan-rgb), 0.4);
                border-color: rgba(var(--electric-cyan-rgb), 0.7);
            }
        }

        @keyframes textGlowPulse {
            0%, 100% {
                text-shadow: 0 0 5px rgba(var(--current-timer-color-rgb), 0.7),
                             0 0 10px rgba(var(--current-timer-color-rgb), 0.5),
                             0 0 15px rgba(var(--current-timer-color-rgb), 0.3);
            }
            50% {
                text-shadow: 0 0 8px rgba(var(--current-timer-color-rgb), 0.9),
                             0 0 15px rgba(var(--current-timer-color-rgb), 0.7),
                             0 0 25px rgba(var(--current-timer-color-rgb), 0.5);
            }
        }
        
        @keyframes scanlines {
            0% { background-position: 0 0; }
            100% { background-position: 0 50px; } /* La hauteur de la ligne de scan */
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            scroll-behavior: smooth;
            font-size: 16px;
        }

        body {
            font-family: var(--font-family-main);
            background-color: var(--bg-color);
            color: var(--primary-text-color);
            line-height: 1.65;
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
            background-image: 
                radial-gradient(ellipse at center, rgba(var(--electric-blue-rgb), 0.08) 0%, transparent 60%),
                linear-gradient(0deg, rgba(var(--bg-color-dark-rgb), 0.5) 0%, rgba(var(--bg-color-dark-rgb), 0.9) 100%);
            position: relative; /* Pour le pseudo-élément de la grille */
        }
        
        body::before { /* Grille techno subtile */
            content: "";
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-image: 
                linear-gradient(rgba(var(--electric-blue-rgb), 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(var(--electric-blue-rgb), 0.05) 1px, transparent 1px);
            background-size: 30px 30px; /* Taille de la grille */
            z-index: -1; /* Derrière tout le contenu */
            opacity: 0.7;
            animation: scanlines 2s linear infinite; /* Pour l'effet de balayage subtil */
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 30px 25px;
            width: 100%;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        header {
            padding: 15px 0;
            background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.5);
            backdrop-filter: blur(8px) saturate(150%);
            border-bottom: 1px solid rgba(var(--electric-blue-rgb), 0.3);
            box-shadow: 0 2px 15px rgba(var(--electric-blue-rgb), 0.1);
            position: sticky;
            top:0;
            z-index: 1000; /* Pour que le header reste visible au scroll */
            transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out, visibility 0s linear 0s; /* Ajout de la transition par défaut */
        }
        body.workout-active header {
            transform: translateY(-100%);
            opacity: 0;
            visibility: hidden;
            transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out, visibility 0s linear 0.4s;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1100px;
            margin: 0 auto;
            padding: 0 25px;
            flex-wrap: wrap;
            gap: 15px 20px;
        }

        header h1 {
            font-size: 1.6em;
            color: var(--primary-text-color);
            margin: 0;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: var(--font-family-titles);
            text-shadow: 0 0 8px rgba(var(--electric-cyan-rgb), 0.7);
        }
        header h1 i {
            color: var(--electric-cyan);
            animation: subtlePulse 3s infinite ease-in-out;
        }

        nav ul {
            list-style: none;
            display: flex;
            gap: 15px; /* Réduit le gap */
            flex-wrap: wrap;
            justify-content: center;
            align-items: baseline;
        }

        nav button, nav a.nav-link {
            background: none;
            border: none;
            color: var(--secondary-text-color);
            font-size: 0.9em;
            font-weight: 500;
            padding: 8px 12px;
            cursor: pointer;
            text-decoration: none;
            transition: all var(--transition-speed) ease;
            position: relative;
            border-radius: var(--border-radius-sm);
            border: 1px solid transparent;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        nav button:hover, nav a.nav-link:hover:not(.disabled-link-look) { /* Ajout de :not(.disabled-link-look) */
            color: var(--primary-text-color);
            background-color: rgba(var(--electric-blue-rgb), 0.1);
            border-color: rgba(var(--electric-blue-rgb), 0.4);
            text-shadow: 0 0 5px rgba(var(--electric-blue-rgb), 0.5);
        }
        
        nav a.nav-link.disabled-link-look { /* Style pour les liens "désactivés" */
            opacity: 0.5;
            pointer-events: none;
            cursor: not-allowed;
        }

        nav button.active {
            color: var(--electric-cyan);
            font-weight: 600;
            background-color: rgba(var(--electric-cyan-rgb), 0.15);
            border-color: var(--electric-cyan);
            box-shadow: 0 0 10px rgba(var(--electric-cyan-rgb), 0.3);
        }

        /* Style spécifique pour les boutons actifs Historique et Progression (si nécessaire) */
        #nav-history.active {
             border-color: var(--neon-pink); 
             background-color: rgba(var(--neon-pink-rgb),0.15);
             color: var(--neon-pink);
        }
        #nav-progress.active {
             border-color: var(--neon-green);
             background-color: rgba(var(--neon-green-rgb),0.15);
             color: var(--neon-green);
        }

        nav button:disabled {
            color: rgba(156, 163, 175, 0.4);
            cursor: not-allowed;
            background-color: transparent !important;
            border-color: transparent !important;
            opacity: 0.6;
            pointer-events: none; 
        }

        #nav-history i, #nav-progress i, nav a.nav-link i { 
             margin-right: 5px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }


        #drive-status-text, #signin-button {
            background-color: transparent;
            border: 1px solid var(--border-color-dark);
            color: var(--secondary-text-color-dark);
            padding: 5px 12px;
            border-radius: var(--border-radius-md);
            font-size: 0.9em;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        #signin-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: var(--border-color-dark) !important;
            color: var(--secondary-text-color-dark) !important;
            background-color: transparent !important;
            box-shadow: none !important;
            text-shadow: none !important;
            pointer-events: auto; 
        }

        #drive-status-text:hover, #signin-button:not(:disabled):hover {
            border-color: var(--electric-blue);
            color: var(--electric-blue);
            background-color: rgba(var(--electric-blue-rgb), 0.1);
        }
        
        #drive-status.success #drive-status-text { /* Style quand succès */
             border-color: var(--neon-green);
             color: var(--neon-green);
             cursor: default;
        }
        #drive-status.loading #drive-status-text {
            border-color: var(--neon-yellow);
            color: var(--neon-yellow);
        }
        #drive-status.error #drive-status-text {
            border-color: var(--neon-red);
            color: var(--neon-red);
        }

        #signin-button { 
             border-color: var(--neon-green); 
             color: var(--neon-green);
        }
        
        #drive-status {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-left: 10px; 
            padding: 0; 
            background: none;
            border: none;
            font-size: 1em;
            color: inherit;
        }

        #settings-icon {
            color: var(--secondary-text-color-dark);
            font-size: 1.3em;
            cursor: pointer;
            transition: color var(--transition-speed) ease, transform var(--transition-speed) ease;
            padding: 5px; 
        }
        #settings-icon:hover {
            color: var(--electric-cyan);
            transform: rotate(60deg) scale(1.1);
        }
        
        body.logged-out #signin-button { display: inline-flex; }
        body.logged-out #drive-status { display: none; }
        body.logged-in #signin-button { display: none; }
        body.logged-in #drive-status { display: inline-flex; }


        main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 40px;
            position: relative;
        }
        body.workout-active main {
            padding-top: 20px; 
        }

        .app-section {
            background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.6);
            backdrop-filter: blur(10px) saturate(130%);
            padding: 25px;
            border: 1px solid rgba(var(--electric-blue-rgb), 0.2);
            width: 100%;
            margin-bottom: 40px;
            transition: opacity var(--section-transition-speed) ease-in-out, transform 0.3s ease-in-out, visibility 0s linear var(--section-transition-speed);
            max-height: 5000px; 
            opacity: 1;
            visibility: visible;
            overflow: hidden; 
            border-radius: var(--border-radius-lg);
            box-shadow: 0 5px 25px rgba(var(--bg-color-dark-rgb), 0.5),
                        inset 0 0 15px rgba(var(--electric-blue-rgb), 0.1);
        }
        
        .workout-section { max-width: 650px; text-align: center; }
        .history-section, .progress-section { max-width: 900px; text-align: left; }

        .section-hidden {
            opacity: 0;
            max-height: 0 !important; 
            padding-top: 0 !important;
            padding-bottom: 0 !important;
            margin-bottom: 0 !important;
            border-width: 0 !important;
            visibility: hidden;
            transform: translateY(20px) scale(0.98);
            transition: opacity var(--section-transition-speed) ease-in-out,
                        visibility 0s linear var(--section-transition-speed), 
                        max-height 0s linear var(--section-transition-speed), 
                        padding var(--section-transition-speed) ease-out,
                        margin var(--section-transition-speed) ease-out,
                        border-width var(--section-transition-speed) ease-out,
                        transform 0.3s ease-in-out;
        }

        .timer-and-image-wrapper {
            display: flex;
            flex-direction: column; 
            align-items: center;
            gap: 20px; 
            margin-bottom: 25px;
        }

        .exercise-image-area {
            width: 100%;
            max-width: 260px; 
            margin: 0 auto; 
            padding: 8px;
            background-color: rgba(var(--secondary-bg-color-dark-rgb),0.4);
            border: 1px solid rgba(var(--electric-cyan-rgb), 0.3);
            border-radius: var(--border-radius-md);
            display: none; 
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 12px rgba(var(--bg-color-dark-rgb), 0.4),
                        inset 0 0 8px rgba(var(--electric-cyan-rgb),0.2);
            z-index: 5;
            transition: opacity 0.4s ease-in-out, transform 0.3s ease-in-out;
            opacity: 0;
            transform: scale(0.95) translateY(10px);
        }
        .exercise-image-area.visible {
            display: flex; 
            opacity: 1;
            transform: scale(1) translateY(0);
        }
        #exercise-image-display {
            display: block;
            max-width: 100%;
            max-height: 200px; 
            object-fit: contain;
            border-radius: var(--border-radius-sm);
            filter: brightness(0.8) contrast(1.1); 
        }
        
        .timer-display { 
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 280px; 
            height: 230px; 
            margin: 0 auto; 
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .reactor { 
            position: relative;
            width: 180px;
            height: 180px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            overflow: hidden; 
            z-index: 10;
            background-color: transparent; 
        }

        .reactor::before { 
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(var(--bg-color-dark-rgb), 0.3);
            z-index: 1;
            border-radius: 50%;
        }

        #time-left {
            animation: textGlowPulse 2s infinite ease-in-out;
        }

        .triangle {
            z-index: 5;
            position: absolute;
            top: 66%; 
            left: 50%;
            transform: translate(-50%, -50%);
            width: 155px; 
            aspect-ratio: 1;
            background-color: var(--electric-cyan);
            -webkit-clip-path: polygon(50% 88%, 0 0, 100% 0);
            clip-path: polygon(50% 88%, 0 0, 100% 0);
            transition: transform 0.5s ease-out, background-color var(--transition-speed) ease; 
        }
        .triangle::after {
            content: '';
            display: block;
            position: absolute;
            top: 45%; 
            left: 50%;
            z-index: 6;
            width: 120px; 
            height: 120px;
            transform: translate(-50%, -50%);
            background-color: var(--bg-color); 
            -webkit-clip-path: polygon(50% 90%, 0 0, 100% 0);
            clip-path: polygon(50% 90%, 0 0, 100% 0);
            transition: background-color var(--transition-speed) ease;
        }

        @keyframes rotate-right {
            to { transform: rotate(360deg); }
        }
        @keyframes rotate-left {
            to { transform: rotate(-360deg); }
        }
        @keyframes rotate-left-right {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            50% { transform: translate(-50%, -50%) rotate(-180deg); }
            100% { transform: translate(-50%, -50%) rotate(0deg); }
        }
        
        .circle-1 {
            z-index: 2;
            position: absolute;
            width: 100%; height: 100%;
            border-radius: 50%;
            background: linear-gradient(rgba(var(--electric-cyan-rgb), 0.8), rgba(var(--electric-blue-rgb), 0.8));
            animation: rotate-right 2s linear infinite;
        }
        .circle-1::before {
            content: '';
            position: absolute;
            z-index: 1;
            inset: 10px; 
            border-radius: 50%;
            background-color: var(--bg-color); 
            transition: background-color var(--transition-speed) ease;
        }
        .circle-1 span {
            position: absolute;
            width: 100%; height: 100%;
            border-radius: 50%;
            background: linear-gradient(rgba(var(--electric-cyan-rgb), 0.8), rgba(var(--electric-blue-rgb), 0.8));
            top:0; left: 0;
        }
        .circle-1 span:nth-child(1) { filter: blur(15px); }
        .circle-1 span:nth-child(2) { filter: blur(15px); }
        .circle-1 span:nth-child(3) { filter: blur(15px); }
        .circle-1 span:nth-child(4) { filter: blur(75px); }

        .circle-2 {
            z-index: 4;
            position: absolute;
            top: 30px; left: 30px; 
            width: calc(100% - 60px); height: calc(100% - 60px); 
            border-radius: 50%;
            border: 10px solid var(--electric-cyan);
            box-shadow: 0 0 30px 30px rgba(var(--electric-cyan-rgb), 0.2);
            animation: rotate-left 4s linear infinite;
            transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
        }
        .circle-2 span { 
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: calc(100% + 20px); 
            height: 10px; 
            background-color: var(--bg-color); 
            transition: background-color var(--transition-speed) ease;
        }
        .circle-2 span:nth-child(1) { transform: translate(-50%, -50%) rotate(90deg); }
        .circle-2 span:nth-child(2) { transform: translate(-50%, -50%) rotate(45deg); }
        .circle-2 span:nth-child(3) { transform: translate(-50%, -50%) rotate(-45deg); }
        .circle-2 span:nth-child(4) { transform: translate(-50%, -50%) rotate(30deg); }
        .circle-2 span:nth-child(5) { transform: translate(-50%, -50%) rotate(-30deg); }
        .circle-2 span:nth-child(6) { transform: translate(-50%, -50%) rotate(0deg); }
        .circle-2 span:nth-child(7) { transform: translate(-50%, -50%) rotate(55deg); height: 5px; } 
        .circle-2 span:nth-child(8) { transform: translate(-50%, -50%) rotate(125deg); height: 5px; }

        .circle-3 {
            z-index: 7;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            box-shadow: 0 0 10px 10px rgba(var(--electric-cyan-rgb), 0.2);
            transition: box-shadow var(--transition-speed) ease;
        }
        .circle-3::after { 
            content: '';
            display: block;
            width: 115px; height: 115px;
            border-radius: 50%;
            border: 3px dotted rgba(var(--electric-cyan-rgb), 0.8);
            animation: rotate-right 10s linear infinite;
            transition: border-color var(--transition-speed) ease;
        }

        .circle-4 {
            z-index: 8;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 100px; height: 100px;
            border-radius: 50%;
            box-shadow: 0 0 10px 10px rgba(var(--electric-cyan-rgb), 0.1);
            animation: rotate-left-right 20s infinite ease-in;
            transition: box-shadow var(--transition-speed) ease;
        }
        .circle-4 span { 
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 100%; height: 100%;
            border-radius: 50%;
            border: 3px solid;
            border-color: var(--electric-cyan) transparent transparent; 
            transition: border-color var(--transition-speed) ease;
        }
        .circle-4 span:nth-child(1) { transform: translate(-50%, -50%) rotate(45deg); }
        .circle-4 span:nth-child(2) { transform: translate(-50%, -50%) rotate(-75deg); }
        .circle-4 span:nth-child(3) { transform: translate(-50%, -50%) rotate(165deg); }

        .circle-5 {
            z-index: 9;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 64px; height: 64px;
            border-radius: 50%;
            animation: rotate-left-right 10s infinite ease-in; 
            background-color: rgba(var(--electric-cyan-rgb), 0.2);
            box-shadow: 0 0 20px 20px rgba(var(--electric-cyan-rgb), 0.2);
            transition: background-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease, opacity 0.3s ease;
        }
        .circle-5 span { 
            position: absolute;
            inset: 0; 
            z-index: 10;
            width: 54px; height: 54px; 
            border-radius: 50%;
            border: 5px solid;
            border-color: var(--electric-cyan) transparent transparent;
            margin: auto; 
            transition: border-color var(--transition-speed) ease;
        }
        .circle-5 span:nth-child(1) { transform: rotate(0deg); }
        .circle-5 span:nth-child(2) { transform: rotate(120deg); }
        .circle-5 span:nth-child(3) { transform: rotate(240deg); }

        .circle-6 {
            z-index: 11;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
        }
        .circle-6::after { 
            content: '';
            display: block;
            width: 40px; height: 40px;
            border-radius: 50%;
            border: 3px dashed var(--electric-cyan);
            animation: rotate-left 5s infinite ease-in;
            transition: border-color var(--transition-speed) ease;
        }
        
        .circle-7 {
            z-index: 12;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
        }
        .circle-7::after { 
            content: '';
            display: block;
            width: 27px; height: 27px;
            border-radius: 50%;
            background-color: var(--electric-cyan);
            animation: rotate-left 5s infinite ease-in; 
            box-shadow: 0 0 5px 5px rgba(var(--electric-cyan-rgb), 0.2);
            transition: box-shadow var(--transition-speed) ease, transform 0.3s ease, background-color var(--transition-speed) ease;
        }

        .circle-8 {
            z-index: 13;
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 15px; height: 15px;
            border-radius: 50%;
            animation: rotate-left-right 5s infinite ease-in; 
        }
        .circle-8 span { 
            position: absolute;
            inset: 0;
            z-index: 14;
            width: 13px; height: 13px;
            border-radius: 50%;
            border: 1px solid;
            border-color: var(--bg-color) transparent transparent; 
            margin: auto;
            transition: border-color var(--transition-speed) ease;
        }
        .circle-8 span:nth-child(1) { transform: rotate(120deg); } 
        .circle-8 span:nth-child(2) { transform: rotate(240deg); }
        
        @keyframes pulsePausedGlow { 
            0%, 100% { box-shadow: 0 0 5px 5px rgba(var(--paused-color-rgb), 0.2); transform: scale(1); }
            50% { box-shadow: 0 0 10px 10px rgba(var(--paused-color-rgb), 0.4); transform: scale(1.1); }
        }
        @keyframes pulsePausedRing { 
            0%, 100% { box-shadow: 0 0 20px 20px rgba(var(--paused-color-rgb), 0.2); opacity: 1; }
            50% { box-shadow: 0 0 25px 25px rgba(var(--paused-color-rgb), 0.3); opacity: 0.8; }
        }

        .state-paused .circle-7::after {
            background-color: var(--paused-color-val);
            animation: pulsePausedGlow 1.5s infinite ease-in-out;
        }
        .state-paused .circle-5 {
            animation: pulsePausedRing 1.5s infinite ease-in-out;
            background-color: rgba(var(--paused-color-rgb), 0.3);
        }
        .state-paused .circle-1, .state-paused .circle-1 span { background: linear-gradient(rgba(var(--paused-color-rgb), 0.8), rgba(var(--paused-color-rgb),0.5));}
        .state-paused .circle-2 { border-color: var(--paused-color-val); box-shadow: 0 0 30px 30px rgba(var(--paused-color-rgb), 0.2); }
        .state-paused .circle-3::after { border-color: rgba(var(--paused-color-rgb), 0.8); }
        .state-paused .circle-4 span { border-color: var(--paused-color-val) transparent transparent; }
        .state-paused .circle-5 span { border-color: var(--paused-color-val) transparent transparent; }
        .state-paused .circle-6::after { border-color: var(--paused-color-val); }
        .state-paused .triangle { background-color: var(--paused-color-val); }


        @keyframes rotateSlow { 
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }
        @keyframes spinOnce { 
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .state-preparing .triangle {
            animation: rotateSlow 5s linear infinite;
            background-color: var(--preparing-color-val);
        }
         /* Change la couleur des éléments du réacteur pour l'état "preparing" */
        .state-preparing .circle-1, .state-preparing .circle-1 span { background: linear-gradient(rgba(var(--preparing-color-rgb), 0.8), rgba(var(--preparing-color-rgb),0.5));}
        .state-preparing .circle-2 { border-color: var(--preparing-color-val); box-shadow: 0 0 30px 30px rgba(var(--preparing-color-rgb), 0.2); }
        .state-preparing .circle-3::after { border-color: rgba(var(--preparing-color-rgb), 0.8); }
        .state-preparing .circle-4 span { border-color: var(--preparing-color-val) transparent transparent; }
        .state-preparing .circle-5 { background-color: rgba(var(--preparing-color-rgb),0.2); box-shadow: 0 0 20px 20px rgba(var(--preparing-color-rgb),0.2);}
        .state-preparing .circle-5 span { border-color: var(--preparing-color-val) transparent transparent; }
        .state-preparing .circle-6::after { border-color: var(--preparing-color-val); }
        .state-preparing .circle-7::after { background-color: var(--preparing-color-val); box-shadow: 0 0 5px 5px rgba(var(--preparing-color-rgb),0.2); }


        .triangle.spin-transition {
            animation: spinOnce 0.6s ease-out forwards;
        }


        #time-left {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 20; 
            font-family: var(--font-family-timer);
            font-size: 3.6em; 
            font-weight: 700;
            color: var(--current-timer-color);
            transition: color var(--transition-speed) ease, text-shadow var(--transition-speed) ease, font-size 0.2s ease;
            pointer-events: none; 
            white-space: nowrap; 
        }

        #timer-state {
            position: absolute;
            bottom: 8px; 
            left: 50%;
            transform: translateX(-50%);
            z-index: 20; 
            font-size: 0.85em; 
            font-family: var(--font-family-main);
            letter-spacing: 0.1em;
            font-weight: 500;
            text-transform: uppercase;
            opacity: 0; 
            transition: opacity 0.3s ease, color var(--transition-speed) ease, text-shadow var(--transition-speed) ease, font-size 0.2s ease, bottom 0.2s ease;
            color: var(--current-timer-color);
            pointer-events: none; 
            white-space: nowrap;
        }
        #timer-state.visible { opacity: 0.9; }
        #timer-state.preparing { animation: countdown-pulse 1s infinite; font-size: 1em; } 
        #timer-state.finished-state { 
            font-size: 0.95em; 
            bottom: 18px; 
            color: var(--finished-color-val);
            text-shadow: 0 0 8px var(--finished-color-val);
        }

        @keyframes countdown-pulse { 
            0%, 100% { opacity: 0.7; transform: scale(1) translateX(-50%); }
            50% { opacity: 1; transform: scale(1.05) translateX(-50%); }
        }

        .state-exercise #time-left { font-size: 4em; letter-spacing: 0.05em; }
        
         /* Change la couleur des éléments du réacteur pour l'état "exercise" */
        .state-exercise .triangle { background-color: var(--exercise-color-val); }
        .state-exercise .circle-1, .state-exercise .circle-1 span { background: linear-gradient(rgba(var(--exercise-color-rgb), 0.8), rgba(var(--exercise-color-rgb),0.5));}
        .state-exercise .circle-2 { border-color: var(--exercise-color-val); box-shadow: 0 0 30px 30px rgba(var(--exercise-color-rgb), 0.2); }
        .state-exercise .circle-3::after { border-color: rgba(var(--exercise-color-rgb), 0.8); }
        .state-exercise .circle-4 span { border-color: var(--exercise-color-val) transparent transparent; }
        .state-exercise .circle-5 { background-color: rgba(var(--exercise-color-rgb),0.2); box-shadow: 0 0 20px 20px rgba(var(--exercise-color-rgb),0.2);}
        .state-exercise .circle-5 span { border-color: var(--exercise-color-val) transparent transparent; }
        .state-exercise .circle-6::after { border-color: var(--exercise-color-val); }
        .state-exercise .circle-7::after { background-color: var(--exercise-color-val); box-shadow: 0 0 5px 5px rgba(var(--exercise-color-rgb),0.2); }

        /* Change la couleur des éléments du réacteur pour l'état "break" */
        .state-break .triangle { background-color: var(--break-color-val); }
        .state-break .circle-1, .state-break .circle-1 span { background: linear-gradient(rgba(var(--break-color-rgb), 0.8), rgba(var(--break-color-rgb),0.5));}
        .state-break .circle-2 { border-color: var(--break-color-val); box-shadow: 0 0 30px 30px rgba(var(--break-color-rgb), 0.2); }
        .state-break .circle-3::after { border-color: rgba(var(--break-color-rgb), 0.8); }
        .state-break .circle-4 span { border-color: var(--break-color-val) transparent transparent; }
        .state-break .circle-5 { background-color: rgba(var(--break-color-rgb),0.2); box-shadow: 0 0 20px 20px rgba(var(--break-color-rgb),0.2);}
        .state-break .circle-5 span { border-color: var(--break-color-val) transparent transparent; }
        .state-break .circle-6::after { border-color: var(--break-color-val); }
        .state-break .circle-7::after { background-color: var(--break-color-val); box-shadow: 0 0 5px 5px rgba(var(--break-color-rgb),0.2); }

        /* Change la couleur des éléments du réacteur pour l'état "finished" */
        .state-finished .triangle { background-color: var(--finished-color-val); }
        .state-finished .circle-1, .state-finished .circle-1 span { background: linear-gradient(rgba(var(--finished-color-rgb), 0.8), rgba(var(--finished-color-rgb),0.5));}
        .state-finished .circle-2 { border-color: var(--finished-color-val); box-shadow: 0 0 30px 30px rgba(var(--finished-color-rgb), 0.2); }
        .state-finished .circle-3::after { border-color: rgba(var(--finished-color-rgb), 0.8); }
        .state-finished .circle-4 span { border-color: var(--finished-color-val) transparent transparent; }
        .state-finished .circle-5 { background-color: rgba(var(--finished-color-rgb),0.2); box-shadow: 0 0 20px 20px rgba(var(--finished-color-rgb),0.2);}
        .state-finished .circle-5 span { border-color: var(--finished-color-val) transparent transparent; }
        .state-finished .circle-6::after { border-color: var(--finished-color-val); }
        .state-finished .circle-7::after { background-color: var(--finished-color-val); box-shadow: 0 0 5px 5px rgba(var(--finished-color-rgb),0.2); }
        

        .workout-info {
            margin-bottom: 20px; 
            min-height: auto; 
            position: relative;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px; 
        }
        #current-exercise-name-display {
            display: block;
            font-size: 1.3em; 
            font-weight: 600;
            color: var(--primary-text-color);
            margin-bottom: 8px; 
            padding: 0 10px; 
            line-height: 1.3; 
        }
        body.state-exercise #current-exercise-name-display {
            color: var(--color-exercise);
            animation: textGlowPulse 2s infinite ease-in-out;
        }
        body.state-break #current-exercise-name-display {
            color: var(--color-break);
            animation: textGlowPulse 2.5s infinite ease-in-out;
        }
        
        #current-exercise-container {
            display: flex;
            flex-direction: column;
            align-items: center; 
            gap: 6px;
            font-size: 0.95em; 
            color: var(--secondary-text-color);
            min-height: auto; 
            width: 100%;
        }
        
        .workout-prompt { 
            display: inline-flex;
            align-items: center;
            gap: 10px;
            border: 1px dashed rgba(var(--electric-blue-rgb), 0.4);
            padding: 10px 20px;
            border-radius: var(--border-radius-md);
            color: var(--secondary-text-color-dark);
            font-size: 1em;
            margin-top: 0; 
            cursor: default;
            background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.3);
        }
        .workout-prompt i { color: var(--electric-blue); }

        #current-exercise-container .exercise-details,
        #current-exercise-container .break-info {
            display: flex;
            flex-direction: column; 
            flex-wrap: nowrap;
            justify-content: center;
            align-items: center; 
            gap: 6px; 
            background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.5);
            padding: 8px 12px;
            border-radius: var(--border-radius-sm);
            border: 1px solid rgba(var(--accent-border-color), 0.5); 
            width: fit-content; 
            max-width: 95%; 
            font-size: 0.9em; 
        }
        
        #current-exercise-container .exercise-details span,
        #current-exercise-container .break-info span {
            display: flex; 
            align-items: center;
            gap: 5px;
            font-weight: 400; 
        }
        #current-exercise-container .exercise-details span i { color: var(--color-exercise); }
        #current-exercise-container .break-info i { color: var(--color-break); }

        .sets-info-text, .details-text { 
            font-size: 0.85em; 
            opacity: 0.8;
            text-align: center;
            width: 100%; 
            letter-spacing: 0.03em;
        }
        .sets-info-text i { color: var(--electric-cyan); }
        .details-text i { color: var(--electric-yellow); } 
        

        .controls {
            display: flex;
            justify-content: center;
            gap: 8px; 
            margin-top: 20px;
            flex-wrap: wrap; 
        }

        .controls button {
            background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.4);
            border: 1px solid var(--border-color);
            color: var(--secondary-text-color);
            padding: 8px 14px; 
            border-radius: var(--border-radius-md);
            font-size: 0.9em; 
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: inline-flex; 
            align-items: center;
            justify-content: center;
            gap: 6px; 
            min-width: 100px; 
            box-shadow: 0 2px 5px rgba(var(--bg-color-dark-rgb),0.3);
        }
        .controls button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.2);
            border-color: var(--border-color-dark);
            color: var(--secondary-text-color-dark);
            box-shadow: none !important;
            transform: none !important;
            text-shadow: none !important;
            pointer-events: auto; 
        }
        .controls button:not(:disabled):hover {
            border-color: var(--electric-blue);
            color: var(--electric-blue);
            background-color: rgba(var(--electric-blue-rgb), 0.15);
            box-shadow: 0 0 10px rgba(var(--electric-blue-rgb), 0.3),
                        inset 0 0 5px rgba(var(--electric-blue-rgb),0.1);
            transform: translateY(-1px);
        }
        .controls button i {
            font-size: 1em; 
            margin-right: 4px; 
            opacity: 0.8;
            transition: opacity var(--transition-speed) ease;
        }
        .controls button:not(:disabled):hover i { opacity: 1; }

        #start-pause-btn:not(:disabled) { 
            animation: electricBorder 3s infinite linear;
            border-color: var(--electric-cyan); 
        }
        #start-pause-btn:not(:disabled):hover {
            animation-play-state: paused; 
        }

        .progress-tracker {
            font-size: 0.85em;
            color: var(--secondary-text-color-dark);
            margin-top: 15px;
            opacity: 0.7;
            font-weight: 500;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            gap: 8px 15px; 
            min-height: 1.2em; 
        }
        #drive-connection-status-main {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: var(--neon-green); 
            font-weight: 500;
            transition: color 0.3s ease;
        }
        #drive-connection-status-main i.fa-google-drive {
            display: inline-block; 
            font-size: 1.1em; 
        }
        #drive-connection-status-main.error { color: var(--neon-red); }
        #drive-connection-status-main.loading { color: var(--neon-yellow); }

        #progress-text-area {
            font-weight: 500; 
            letter-spacing: 0.05em; 
        }
        

        .rep-adjustment-overlay {
            position: absolute; 
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100; 
            background-color: rgba(var(--bg-color-dark-rgb), 0.9);
            padding: 20px;
            border-radius: var(--border-radius-md);
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            display: none; 
            flex-direction: column;
            align-items: center;
            gap: 15px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            width: 280px; 
        }
        .rep-adjustment-overlay.visible {
            display: flex;
            animation: fadeInScale 0.3s ease-out forwards;
        }
        @keyframes fadeInScale {
            from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
            to   { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        }
        .rep-adjustment-overlay .title {
            font-size: 1.1em;
            font-weight: 700;
            color: var(--primary-text-color);
            text-align: center;
            margin-bottom: 5px;
        }
        .rep-adjustment-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .rep-adjustment-btn {
            width: 45px; height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4em;
            font-weight: 700;
            background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.9);
            border: 1px solid var(--border-color);
            color: var(--primary-text-color);
            cursor: pointer;
            transition: all var(--transition-speed) ease;
        }
        .rep-adjustment-btn.minus {
            border-color: var(--neon-red);
            color: var(--neon-red);
        }
        .rep-adjustment-btn.minus:hover {
            background-color: rgba(var(--neon-red-rgb), 0.15);
            box-shadow: var(--glow-red);
        }
        .rep-adjustment-btn.plus {
            border-color: var(--neon-green);
            color: var(--neon-green);
        }
        .rep-adjustment-btn.plus:hover {
            background-color: rgba(var(--neon-green-rgb), 0.15);
            box-shadow: var(--glow-green);
        }
        .rep-adjustment-btn:active { transform: scale(0.95); }

        .current-reps {
            font-size: 2.2em;
            font-weight: 900;
            color: var(--primary-text-color);
            font-variant-numeric: tabular-nums; 
            min-width: 60px; 
            text-align: center;
        }
        .rep-adjustment-next-exercise {
            font-size: 0.95em;
            color: var(--color-exercise); 
            font-weight: 500;
            text-align: center;
            margin-top: 5px;
        }
        
        .history-section h2, .progress-section h2 {
            color: var(--primary-text-color);
            margin-bottom: 25px;
            text-align: center;
            font-family: var(--font-family-titles);
            text-shadow: 0 0 6px rgba(var(--electric-cyan-rgb), 0.6);
        }

        .chart-container, .stats-display, .history-list, .progress-filters select, .exercise-chart-container {
            border-color: var(--border-color-dark); 
            background-color: transparent; 
        }
        
        .history-filters button.active, .progress-filters button.active { 
            border-color: var(--electric-cyan);
            color: var(--electric-cyan);
            background-color: rgba(var(--electric-cyan-rgb), 0.1);
            box-shadow: 0 0 8px rgba(var(--electric-cyan-rgb),0.4);
            text-shadow: 0 0 5px var(--electric-cyan);
        }

        .stats-display .motivational-message {
            background: linear-gradient(90deg, var(--neon-green), var(--electric-cyan));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; 
            font-weight: 500;
        }
        
        .history-list li:nth-child(even) {
            background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.2); 
        }
        .history-list li:hover {
            background-color: rgba(var(--electric-cyan-rgb), 0.05); 
        }
        
        .history-item-type { 
            color: var(--neon-pink);
            background-color: rgba(var(--neon-pink-rgb), 0.1);
        }
        .history-item-reps { 
            color: var(--neon-purple);
        }
        .history-item-duration { 
            color: var(--electric-blue);
        }

        .progress-filters select:hover { border-color: var(--electric-cyan); }
        .progress-filters select:focus {
            border-color: var(--electric-cyan);
            box-shadow: 0 0 0 2px rgba(var(--electric-cyan-rgb), 0.3); 
        }
        
        .history-controls, .progress-controls {
            padding-bottom: 20px; 
            margin-bottom: 25px; 
            border-bottom: 1px solid var(--border-color-dark);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; 
            gap: 15px; 
        }

        .history-filters, .progress-filters {
            display: flex;
            gap: 10px; 
            flex-wrap: wrap; 
        }

        .history-actions { 
            display: flex;
            gap: 15px;
            align-items: center;
            color: var(--secondary-text-color-dark); 
        }
        #history-drive-status {
            font-size: 0.8em;
            padding: 3px 6px;
            background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.5);
            border-radius: var(--border-radius-sm);
            border: 1px solid var(--border-color-dark);
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        #history-drive-status.syncing { color: var(--neon-yellow); border-color: var(--neon-yellow); }
        #history-drive-status.error { color: var(--neon-red); border-color: var(--neon-red); }
        #history-drive-status.success { color: var(--neon-green); border-color: var(--neon-green); }

        .chart-container, .exercise-chart-container {
            position: relative; 
            width: 100%;
            height: 300px; 
            margin-bottom: 25px;
            background-color: rgba(var(--bg-color-dark-rgb), 0.3); 
            border: 1px solid var(--border-color-dark);
            border-radius: var(--border-radius-md);
            padding: 15px;
        }
        .chart-placeholder {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: var(--secondary-text-color-dark);
            font-style: italic;
            text-align: center;
            padding: 0 10px; 
            transition: opacity 0.3s ease;
        }
        #history-chart-canvas, #exercise-progress-chart {
            display: block; 
            width: 100% !important; 
            height: 100% !important; 
            transition: opacity 0.3s ease; 
        }

        .stats-display {
            margin-bottom: 25px;
            padding: 20px;
            background-color: rgba(var(--bg-color-dark-rgb), 0.3);
            border: 1px solid var(--border-color-dark);
            border-radius: var(--border-radius-md);
        }
        .stats-display h3, .exercise-progress-container h3 {
            color: var(--primary-text-color);
            font-size: 1.15em;
            margin-bottom: 15px;
        }
        .stats-display .content-wrapper p {
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .stats-display .content-wrapper p i {
            width: 16px; 
            text-align: center;
            color: var(--electric-cyan);
            opacity: 0.8;
        }
        .stats-display .content-wrapper p strong {
            color: var(--primary-text-color);
            font-weight: 500;
        }

        .progress-filters .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 180px; 
        }
        .progress-filters .filter-group label {
            font-size: 0.85em;
            color: var(--secondary-text-color-dark);
            margin-bottom: -2px; 
        }
        .progress-filters select {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color-dark);
            color: var(--primary-text-color-dark);
            border-radius: var(--border-radius-sm);
            padding: 6px 10px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            max-width: 100%; 
            appearance: none; 
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23A0AEC0'%3E%3Cpath fill-rule='evenodd' d='M4.22 6.22a.75.75 0 011.06 0L8 8.94l2.72-2.72a.75.75 0 111.06 1.06l-3.25 3.25a.75.75 0 01-1.06 0L4.22 7.28a.75.75 0 010-1.06z' clip-rule='evenodd'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 8px center;
            background-size: 16px 16px;
            padding-right: 30px; 
        }
        .progress-filters option {
            background-color: var(--secondary-bg-color); 
            color: var(--primary-text-color);
        }
        .filter-group:has(#metric-select) { display: none; }


        .history-list {
            list-style: none;
            border: 1px solid var(--border-color-dark);
            border-radius: var(--border-radius-md);
            background-color: transparent; 
            box-shadow: none; 
            max-height: 400px; 
            overflow-y: auto;
            transition: border-color var(--transition-speed) ease;
        }
        .history-list li {
            display: grid;
            grid-template-columns: auto 1fr auto auto; 
            align-items: center;
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color-dark);
            transition: background-color 0.2s ease, border-color var(--transition-speed) ease;
            gap: 10px 15px; 
        }
        .history-list li:last-child { border-bottom: none; }
        .history-list li:nth-child(even) { background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.2); }
        .history-list li:hover { background-color: rgba(var(--electric-cyan-rgb), 0.05); }

        .history-item-date {
            color: var(--primary-text-color);
            font-size: 0.9em;
            grid-column: 1 / 2;
        }
        .history-item-date small { color: var(--secondary-text-color); font-size: 0.9em;}

        .history-item-type {
            color: var(--neon-pink); 
            background-color: rgba(var(--neon-pink-rgb), 0.1);
            border-radius: var(--border-radius-sm);
            padding: 3px 8px;
            font-size: 0.85em;
            font-weight: 500;
            text-align: center;
            grid-column: 2 / 3;
            justify-self: start; 
        }
        .history-item-reps {
            color: var(--neon-purple); 
            font-weight: 500;
            font-size: 0.9em;
            grid-column: 3 / 4;
            justify-self: end; 
        }
        .history-item-reps i { margin-right: 4px; }

        .history-item-duration {
            color: var(--electric-blue); 
            font-weight: 500;
            font-variant-numeric: tabular-nums; 
            grid-column: 4 / 5;
            justify-self: end; 
        }
        .history-list .no-history {
            grid-column: 1 / -1; 
            color: var(--secondary-text-color);
            text-align: center;
            padding: 30px 15px;
            font-style: italic;
            border: none; 
            background: none !important; 
        }
        

        .post-workout-summary {
            position: fixed;
            inset: 0; 
            background-color: rgba(var(--bg-color-dark-rgb), 0.9); 
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 2000; 
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px; 
            opacity: 0;
            visibility: hidden;
            pointer-events: none; 
            transition: opacity 0.3s ease, visibility 0s linear 0.3s;
        }
        .post-workout-summary.visible {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            transition: opacity 0.3s ease, visibility 0s linear 0s;
        }
        .post-workout-summary-content {
            background-color: var(--secondary-bg-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            box-shadow: 0 10px 30px rgba(0,0,0,0.4),
                        0 0 20px rgba(var(--electric-cyan-rgb), 0.1); 
            width: 100%;
            max-width: 550px; 
            max-height: 90vh; 
            display: flex;
            flex-direction: column;
            overflow: hidden; 
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), 
                        background-color var(--transition-speed) ease,
                        border-color var(--transition-speed) ease;
        }
        .post-workout-summary.visible .post-workout-summary-content { transform: scale(1); }

        .post-workout-summary h2 {
            color: var(--electric-cyan);
            font-size: 1.5em;
            font-weight: 700;
            padding: 20px 25px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0; 
            text-align: center;
            background-color: rgba(var(--bg-color-dark-rgb), 0.2); 
            transition: color var(--transition-speed) ease,
                        border-color var(--transition-speed) ease,
                        background-color var(--transition-speed) ease;
            text-shadow: 0 0 5px var(--electric-cyan);
        }

        .summary-items-list {
            list-style: none;
            padding: 15px 25px; 
            overflow-y: auto; 
            flex-grow: 1; 
            background: var(--bg-color); 
            border-bottom: 1px solid var(--border-color); 
            transition: background-color var(--transition-speed) ease,
                        border-color var(--transition-speed) ease;
        }
        .summary-item {
            display: grid;
            grid-template-columns: 1fr auto; 
            gap: 10px 15px;
            align-items: center;
            padding: 12px 0; 
            border-bottom: 1px solid var(--border-color);
        }
        .summary-item:last-child { border-bottom: none; }

        .summary-item .exercise-name {
            color: var(--primary-text-color);
            font-weight: 500;
            font-size: 1em;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; 
        }
        .summary-item .exercise-name i {
            color: var(--color-exercise);
            margin-right: 8px;
            opacity: 0.9;
        }
        .summary-item .exercise-name small { 
            font-size: 0.8em;
            color: var(--secondary-text-color);
            margin-left: 8px;
            display: block; 
        }

        .summary-item .input-container {
            display: flex;
            align-items: center;
            gap: 8px;
            justify-self: end; 
        }
        .summary-item label { 
            position: absolute;
            width: 1px; height: 1px;
            padding: 0; margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        .summary-item input[type="number"] {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: var(--primary-text-color);
            border-radius: var(--border-radius-sm);
            padding: 6px 10px;
            font-size: 0.95em;
            width: 70px; 
            text-align: center;
            transition: border-color var(--transition-speed) ease,
                        background-color var(--transition-speed) ease,
                        box-shadow var(--transition-speed) ease,
                        color var(--transition-speed) ease;
            -moz-appearance: textfield; 
        }
        .summary-item input[type="number"]::-webkit-outer-spin-button,
        .summary-item input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none; 
            margin: 0;
        }
        .summary-item input:focus {
            border-color: var(--electric-cyan);
            background-color: var(--secondary-bg-color); 
            outline: none;
            box-shadow: 0 0 0 3px rgba(var(--electric-cyan-rgb), 0.3); 
        }
        .summary-controls {
            padding: 20px 25px;
            display: flex;
            justify-content: center; 
            gap: 15px; 
            flex-shrink: 0; 
            flex-wrap: wrap; 
            border-top: 1px solid var(--border-color); 
            background-color: rgba(var(--bg-color-dark-rgb), 0.2); 
            transition: border-color var(--transition-speed) ease,
                        background-color var(--transition-speed) ease;
        }
        .summary-controls button {
            border: none;
            color: #fff; 
            min-width: 160px;
            padding: 10px 22px;
            border-radius: var(--border-radius-md);
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-speed) ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .summary-controls button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
            background-color: var(--secondary-text-color) !important; 
            filter: grayscale(50%);
        }
        #finish-summary-btn { 
            background-color: var(--neon-green);
            --button-finish-glow: var(--glow-green); 
        }
        #finish-summary-btn:not(:disabled):hover {
            filter: brightness(1.15);
            box-shadow: 0 4px 10px rgba(0,0,0,0.3), 0 0 10px var(--button-finish-glow);
            transform: translateY(-1px);
            text-shadow: 0 0 5px rgba(255,255,255,0.5); 
        }
        #finish-summary-btn:not(:disabled):active {
            filter: brightness(0.95);
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .message-area {
            position: fixed;
            bottom: 25px; 
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.9);
            color: var(--primary-text-color);
            border: 1px solid var(--border-color);
            padding: 12px 25px;
            border-radius: var(--border-radius-md);
            z-index: 3000; 
            opacity: 0;
            transition: all 0.5s ease; 
            pointer-events: none; 
            font-size: 0.95em;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3), 
                        0 0 10px rgba(var(--electric-cyan-rgb), 0.1); 
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            max-width: 90%; 
            text-align: center; 
        }
        .message-area.visible {
            opacity: 1;
            transform: translate(-50%, 0); 
            bottom: 40px; 
            pointer-events: auto;
        }
        .message-area.error-message { 
            background-color: rgba(var(--neon-red-rgb), 0.8); 
            color: #fff; 
            border-color: var(--neon-red);
            text-shadow: 0 0 5px rgba(0,0,0,0.5); 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3), 0 0 10px var(--glow-red); 
        }
        
        footer {
            padding: 25px;
            text-align: center;
            font-size: 0.9em;
            color: var(--secondary-text-color);
            border-top: 1px solid rgba(var(--electric-blue-rgb), 0.2);
            margin-top: 50px; 
            background-color: rgba(var(--bg-color-dark-rgb), 0.7); 
            backdrop-filter: blur(3px); 
        }
        footer p { margin-bottom: 8px; }
        footer a {
            color: var(--electric-cyan);
            text-decoration: none;
            transition: color var(--transition-speed) ease, text-shadow var(--transition-speed) ease;
        }
        footer a:hover {
            color: var(--primary-text-color);
            text-decoration: underline;
            text-shadow: 0 0 8px var(--electric-cyan);
        }
        footer .fab.fa-google-drive { color: var(--neon-green); }
        footer .fab.fa-github { color: var(--neon-purple); }


        @media (min-width: 769px) { 
            .timer-and-image-wrapper {
                flex-direction: row; 
                justify-content: center; 
                align-items: center; 
                gap: 30px; 
            }
            .exercise-image-area {
                max-width: 220px; 
                margin: 0; 
            }
            #exercise-image-display { max-height: 180px; }

            .timer-display {
                margin: 0; 
                width: 300px; height: 240px;} 
            .reactor { width: 190px; height: 190px; }
            
            #current-exercise-name-display { font-size: 1.5em; }
            #current-exercise-container .exercise-details, 
            #current-exercise-container .break-info { font-size: 1em; }
        }

        @media (max-width: 768px) { 
            .timer-display { width: 260px; height: 210px; }
            .reactor { width: 170px; height: 170px; }
            #time-left { font-size: 3.0em; }
            .triangle { width: 125px; }
            .triangle::after { width: 95px; height: 95px; }
            .circle-2 { border-width: 7px; box-shadow: 0 0 20px 20px rgba(var(--electric-cyan-rgb), 0.2); }
            .circle-3::after { width: 90px; height: 90px; }
            .circle-5 { width: 50px; height: 50px; }
            .circle-5 span { width: 40px; height: 40px; }

            .controls button { font-size: 0.85em; padding: 8px 10px; min-width: 90px; }
            header h1 { font-size: 1.3em; }
            nav ul { gap: 12px; }
            nav button, nav a.nav-link { font-size: 0.85em; padding: 6px 10px;}

            .history-list li {
                font-size: 0.9em;
                grid-template-columns: auto 1fr auto; 
                gap: 5px 10px;
            }
            .history-item-reps { 
                grid-column: 3 / 4; 
                justify-self: start; 
            }
            .history-item-duration { 
                grid-column: 1 / -1; 
                grid-row: 2 / 3; 
                justify-self: end;
            }
            .summary-item { grid-template-columns: 1fr auto; } 

            .exercise-image-area { max-width: 200px; margin-bottom: 15px; }
            #exercise-image-display { max-height: 160px; }

            #current-exercise-container .sets-info-text,
            #current-exercise-container .details-text { display: none; }
        }

        @media (max-width: 480px) { 
            .timer-and-image-wrapper { gap: 10px; margin-bottom:15px; }
            .timer-display { width: 220px; height: 180px; }
            .reactor { width: 140px; height: 140px; }
            #time-left { font-size: 2.5em; }
            .triangle { width: 100px; }
            .triangle::after { width: 75px; height: 75px; }
            .circle-1::before { inset: 6px; }
            .circle-2 { top: 20px; left: 20px; width: calc(100% - 40px); height: calc(100% - 40px); border-width: 5px; }
            .circle-3::after { width: 70px; height: 70px; }
            .circle-5 { width: 40px; height: 40px; }
            .circle-5 span { width: 32px; height: 32px; border-width: 4px;}
            .circle-7::after { width: 18px; height: 18px;}

            #current-exercise-name-display { font-size: 1.1em; }
            #current-exercise-container .exercise-details { font-size: 0.85em; padding: 6px 10px; }

            .controls button {
                flex-basis: calc(50% - 6px); 
                padding: 8px;
                font-size: 0.8em;
                min-width: 80px;
            }
            
            .header-content {
                justify-content: center; 
                text-align: center;
            }
            nav ul { justify-content: center; } 
            .header-actions { 
                justify-content: center;
                width: 100%;
                margin-top: 10px; 
            }
            .exercise-image-area { max-width: 160px; }
            #exercise-image-display { max-height: 120px; }
        }

    </style>
</head>
<body class="logged-out dark-theme state-idle"> 

    <header>
        <div class="header-content">
            <h1><i class="fas fa-bolt"></i> ArmorWorkout</h1>
            <nav>
                <ul>
                    <li><button id="nav-push" data-workout="Push" disabled>Push</button></li>
                    <li><button id="nav-pull" data-workout="Pull" disabled>Pull</button></li>
                    <li><button id="nav-legs" data-workout="Legs" disabled>Legs</button></li>
                    <li><button id="nav-history"><i class="fas fa-history"></i> Historique</button></li>
                    <li><button id="nav-progress" disabled><i class="fas fa-chart-line"></i> Progression</button></li>
                    <li><a href="https://ironworkout.github.io/armorworkout/prog" target="_blank" class="nav-link"><i class="fas fa-tasks"></i> Prog V1</a></li>
                    <li><a href="https://ironworkout.github.io/armorworkout/muscle-evolution.html" target="_blank" class="nav-link"><i class="fas fa-chart-pie"></i> Évolution</a></li>
                </ul>
            </nav>
            <div class="header-actions">
                <div id="drive-status" style="display: none;"> 
                    <span id="drive-status-text">Connecté</span>
                    <i id="settings-icon" class="fas fa-cog" title="Paramètres (à venir)"></i>
                </div>
                <button id="signin-button" disabled><i class="fab fa-google"></i> Connecter Drive</button>
            </div>
        </div>
    </header>

    <div class="container">
        <main>
            <div class="workout-section app-section" id="workout-section">
                <div class="timer-and-image-wrapper">
                    <div id="exercise-image-container" class="exercise-image-area">
                        <img id="exercise-image-display" src="" alt="">
                    </div>

                    <div class="timer-display" id="timer-display-clickable" aria-label="Affichage du timer Arc Reactor">
                        <div class="reactor">
                            <div class="triangle"></div>
                            <div class="circle-1"><span></span><span></span><span></span><span></span></div>
                            <div class="circle-2"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></div>
                            <div class="circle-3"></div>
                            <div class="circle-4"><span></span><span></span><span></span></div>
                            <div class="circle-5"><span></span><span></span><span></span></div>
                            <div class="circle-6"></div>
                            <div class="circle-7"></div>
                            <div class="circle-8"><span></span><span></span><span></span></div>

                            <div id="time-left" aria-live="polite">00:00</div>
                            <div id="timer-state" aria-live="polite">Prêt</div>
                        </div>
                        <div class="rep-adjustment-overlay" id="rep-adjustment-overlay">
                            <div class="title">Ajuster Répétitions</div>
                            <div class="rep-adjustment-next-exercise" id="rep-adjustment-exercise-name">Exercice</div>
                            <div class="rep-adjustment-controls">
                                <button class="rep-adjustment-btn minus" id="rep-adjust-minus" aria-label="Diminuer répétitions">-</button>
                                <span class="current-reps" id="current-reps-display" aria-live="polite">12</span>
                                <button class="rep-adjustment-btn plus" id="rep-adjust-plus" aria-label="Augmenter répétitions">+</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="workout-info" id="workout-info">
                    <div id="current-exercise-name-display">ArmorWorkout</div>
                    <div id="current-exercise-container" aria-live="polite">
                        <div class="workout-prompt">
                            <i class="fas fa-hand-pointer"></i>
                            <span>Sélectionnez un entraînement.</span>
                        </div>
                    </div>
                </div>

                <div class="controls">
                    <button id="prev-btn" disabled><i class="fas fa-backward-step"></i> Précédent</button>
                    <button id="start-pause-btn" disabled><i class="fas fa-play"></i> Démarrer</button>
                    <button id="skip-btn" disabled><i class="fas fa-forward-step"></i> Suivant</button>
                    <button id="finish-btn" disabled><i class="fas fa-flag-checkered"></i> Finir</button>
                    <button id="reset-btn" disabled><i class="fas fa-redo"></i> Reset</button>
                </div>

                <div class="progress-tracker" id="progress-tracker">
                    <span id="progress-text-area">Sélectionnez un entraînement</span>
                    <span id="drive-connection-status-main" style="display: none;"> 
                        <i class="fab fa-google-drive"></i>
                        <span id="drive-connection-text">Connecté</span>
                    </span>
                </div>
            </div>

            <div class="history-section app-section section-hidden" id="history-section">
                <h2><i class="fas fa-history"></i> Historique & Statistiques</h2>
                <div class="history-controls">
                    <div class="history-filters" role="group" aria-label="Filtres période historique">
                        <button data-period="week" class="active"><i class="fas fa-calendar-week"></i> Semaine</button>
                        <button data-period="month"><i class="fas fa-calendar-alt"></i> Mois</button>
                        <button data-period="year"><i class="fas fa-calendar-check"></i> Année</button>
                        <button data-period="all"><i class="fas fa-infinity"></i> Tout</button>
                    </div>
                    <div class="history-actions" style="display: none;"> 
                        <span id="history-drive-status">Synchro Drive</span>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="history-chart-canvas" role="img" aria-label="Graphique de la durée d'entraînement"></canvas>
                    <p id="history-chart-placeholder" class="chart-placeholder" style="display: none;"></p> 
                </div>

                <div class="stats-display" id="stats-display">
                    <h3>Statistiques</h3>
                    <div class="content-wrapper" aria-live="polite">
                        <p>Connectez-vous pour voir les statistiques.</p>
                    </div>
                    <p class="motivational-message"></p> 
                </div>

                <ul class="history-list" id="history-list">
                    <li class="no-history">Connectez-vous pour voir l'historique.</li> 
                </ul>
            </div>

            <div class="progress-section app-section section-hidden" id="progress-section">
                <h2><i class="fas fa-chart-line"></i> Analyse de Progression</h2>
                 <div class="progress-controls">
                    <div class="progress-filters">
                        <div class="filter-group">
                            <label for="exercise-select">Exercice</label>
                            <select id="exercise-select" aria-label="Sélectionner un exercice">
                                <option value="all">Tous les exercices (Total Reps)</option>
                            </select>
                        </div>
                        <div class="filter-group" style="display:none;"> 
                            <label for="metric-select">Métrique</label>
                            <select id="metric-select" aria-label="Sélectionner une métrique">
                                <option value="reps">Répétitions</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label for="period-select">Période</label>
                            <select id="period-select" aria-label="Sélectionner une période">
                                <option value="3months">3 derniers mois</option>
                                <option value="6months">6 derniers mois</option>
                                <option value="all">Tout l'historique</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="exercise-progress-container">
                    <h3>Progression (Répétitions)</h3> 
                    <div class="exercise-chart-container">
                        <canvas id="exercise-progress-chart" role="img" aria-label="Graphique de progression des répétitions"></canvas>
                        <p id="exercise-progress-placeholder" class="chart-placeholder">Sélectionnez un exercice.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <footer>
        <p>© <span id="current-year">2024</span> ArmorWorkout. Sauvegarde sur <i class="fab fa-google-drive" aria-hidden="true"></i> Google Drive.</p>
        <p><a href="https://github.com/ironworkout/armorworkout" target="_blank" rel="noopener noreferrer"><i class="fab fa-github" aria-hidden="true"></i> Voir sur GitHub</a></p>
    </footer>

    <div id="message-area" class="message-area" role="status" aria-live="polite"></div>

    <div id="post-workout-summary" class="post-workout-summary" role="dialog" aria-modal="true" aria-labelledby="summary-title">
        <div class="post-workout-summary-content">
            <h2 id="summary-title">Résumé & Objectifs</h2>
            <ul id="summary-items-list" class="summary-items-list">
            </ul>
            <div class="summary-controls">
                <button id="finish-summary-btn"><i class="fas fa-check"></i> Fin & Sauvegarder</button>
            </div>
        </div>
    </div>

    <script async defer src="https://accounts.google.com/gsi/client"></script>
    <script>
        // --- CONFIGURATION & CONSTANTES ---
        const GOOGLE_CLIENT_ID = "731283926358-viam3ulpgna14flfdeb9m92l8s620hoi.apps.googleusercontent.com";
        const GOOGLE_DRIVE_SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const HISTORY_FILENAME = "armorworkout_history.json";
        const PROGRAM_FILENAMES = {
            Push: "armorworkout_push_program_v4.json",
            Pull: "armorworkout_pull_program_v5_2.json",
            Legs: "armorworkout_legs_program_v1_7.json"
        };
        const PROGRAM_TYPES = ['Push', 'Pull', 'Legs'];
        const PREPARE_DURATION = 3; 
        const IN_PROGRESS_KEY = 'armorWorkoutStateInProgress';
        const GIS_CHECK_INTERVAL = 100; 
        const GIS_MAX_RETRIES = 50; 

        const defaultWorkouts = {
        Push: {
            "routine_name": "PUSH V4 - Hypertrophie Élite (Format App)",
            "description": "Séance PUSH optimisée pour hypertrophie avec matériel limité. Focus pecs, épaules, triceps.",
            "workout_data": [
                { "type": "exercise", "name": "Dumbbell Floor Flyes (Pré-Épuisement Superset 1/2)", "sets_info": "Partie 1/2 du Superset - Total 3 Supersets", "reps": 15, "weight": 10, "weight_unit": "kg (2x5kg)", "details": "Écarté au sol avec haltères 5kg. Focus contraction et contrôle.", "equipment": "Haltères 5kg, Tapis de sol", "reps_start": 15, "reps_target_max": 20, "progression_note": "Quand 20 reps (RIR 0-1) faciles, focus sur tempo excentrique plus lent (3-4s) ou pause en étirement (1s)." },
                { "type": "break", "duration": 15, "name": "Transition Superset (15s)" },
                { "type": "exercise", "name": "Pompes avec Pieds Surélevés (Pré-Épuisement Superset 2/2)", "sets_info": "Partie 2/2 du Superset - Total 3 Supersets", "reps_text": "AMRAP", "weight": 0, "weight_unit": "Poids de corps", "details": "Option: + Élastique(s) sur le dos. Pieds surélevés pour cibler haut des pecs.", "equipment": "Poids de corps, Option: Élastiques 15kg/25kg", "reps_start_text": "AMRAP", "reps_target_max_text": "AMRAP", "progression_note": "Aller à l'échec technique. Quand les reps augmentent significativamente, ajouter élastique 15kg, puis 25kg, ou surélever plus les pieds." },
                { "type": "break", "duration": 90, "name": "Repos après Superset" },
                { "type": "exercise", "name": "Dumbbell Floor Flyes (Pré-Épuisement Superset 1/2) - Série 2", "sets_info": "Partie 1/2 du Superset - Total 3 Supersets", "reps": 15, "weight": 10, "weight_unit": "kg (2x5kg)", "details": "Écarté au sol avec haltères 5kg.", "equipment": "Haltères 5kg, Tapis de sol", "reps_start": 15, "reps_target_max": 20, "progression_note": "Vise la même difficulté/reps que la 1ère série du superset." },
                { "type": "break", "duration": 15, "name": "Transition Superset (15s)" },
                { "type": "exercise", "name": "Pompes avec Pieds Surélevés (Pré-Épuisement Superset 2/2) - Série 2", "sets_info": "Partie 2/2 du Superset - Total 3 Supersets", "reps_text": "AMRAP", "weight": 0, "weight_unit": "Poids de corps", "details": "Option: + Élastique(s) sur le dos.", "equipment": "Poids de corps, Option: Élastiques 15kg/25kg", "reps_start_text": "AMRAP", "reps_target_max_text": "AMRAP", "progression_note": "Vise la même intensité que la 1ère série du superset." },
                { "type": "break", "duration": 90, "name": "Repos après Superset" },
                { "type": "exercise", "name": "Dumbbell Floor Flyes (Pré-Épuisement Superset 1/2) - Série 3", "sets_info": "Partie 1/2 du Superset - Total 3 Supersets", "reps": 15, "weight": 10, "weight_unit": "kg (2x5kg)", "details": "Écarté au sol avec haltères 5kg.", "equipment": "Haltères 5kg, Tapis de sol", "reps_start": 15, "reps_target_max": 20, "progression_note": "Donne tout sur cette dernière série du superset !" },
                { "type": "break", "duration": 15, "name": "Transition Superset (15s)" },
                { "type": "exercise", "name": "Pompes avec Pieds Surélevés (Pré-Épuisement Superset 2/2) - Série 3", "sets_info": "Partie 2/2 du Superset - Total 3 Supersets", "reps_text": "AMRAP", "weight": 0, "weight_unit": "Poids de corps", "details": "Option: + Élastique(s) sur le dos.", "equipment": "Poids de corps, Option: Élastiques 15kg/25kg", "reps_start_text": "AMRAP", "reps_target_max_text": "AMRAP", "progression_note": "Donne tout sur cette dernière série du superset !" },
                { "type": "break", "duration": 90, "name": "Repos après Superset" },
                { "type": "exercise_myo_reps", "name": "Floor Press (Combo Haltères + Élastique) - MYO-REPS", "sets_info": "1 Série d'Activation + 3-4 Mini-Séries", "activation_reps_start": 10, "activation_reps_target_max": 15, "mini_sets_count": "3-4", "mini_reps_start": 3, "mini_reps_target_max": 5, "weight_details": "2x5kg Haltères + Élastique(s) 15kg/25kg/combinés", "details": "Combo: Haltères tenus avec élastique(s) passé(s) dans le dos.", "equipment": "Haltères 5kg, Élastiques 15kg/25kg, Tapis de sol", "progression_note": "Activ: Quand 15 reps (RIR 1), augmenter résistance élastique. Mini-Séries: Viser 4 mini-séries ou plus de reps dans les mini-séries.", "rest_between_mini_sets": 15, "rest_after_exercise": 90, "reps_text": "MYO", "weight_text":"Combo" },
                { "type": "break", "duration": 90, "name": "Repos après Myo-Reps" },
                { "type": "exercise", "name": "Pike Push-ups", "reps": 6, "weight": 0, "weight_unit": "Poids de corps", "details": "Pompes piquées, focus épaules.", "equipment": "Poids de corps, Tapis de sol", "reps_start": 6, "reps_target_max": 12, "progression_note": "Quand 12 reps (RIR 1-2) maîtrisées, surélever les pieds progressivement." },
                { "type": "break", "duration": 75, "name": "Repos" },
                { "type": "exercise", "name": "Pike Push-ups - Série 2", "reps": 6, "weight": 0, "weight_unit": "Poids de corps", "details": "Pompes piquées.", "equipment": "Poids de corps, Tapis de sol", "reps_start": 6, "reps_target_max": 12, "progression_note": "Vise la même difficulté." },
                { "type": "break", "duration": 75, "name": "Repos" },
                { "type": "exercise", "name": "Pike Push-ups - Série 3", "reps": 6, "weight": 0, "weight_unit": "Poids de corps", "details": "Pompes piquées.", "equipment": "Poids de corps, Tapis de sol", "reps_start": 6, "reps_target_max": 12, "progression_note": "Dernière série, donne tout !" },
                { "type": "break", "duration": 75, "name": "Repos" },
                { "type": "exercise", "name": "Élévations Latérales avec Haltères", "reps": 15, "weight": 10, "weight_unit": "kg (2x5kg)", "details": "Focus brûlure et contrôle strict.", "equipment": "Haltères 5kg", "reps_start": 15, "reps_target_max": 30, "progression_note": "Quand 25 reps (RIR 0-1) faciles, ralentir l'excentrique (3-4s), ajouter pause en haut (1-2s), ou viser 30 reps." },
                { "type": "break", "duration": 60, "name": "Repos" },
                { "type": "exercise", "name": "Élévations Latérales avec Haltères - Série 2", "reps": 15, "weight": 10, "weight_unit": "kg (2x5kg)", "details": "Contrôle strict.", "equipment": "Haltères 5kg", "reps_start": 15, "reps_target_max": 30, "progression_note": "Maintiens la qualité." },
                { "type": "break", "duration": 60, "name": "Repos" },
                { "type": "exercise", "name": "Élévations Latérales avec Haltères - Série 3", "reps": 15, "weight": 10, "weight_unit": "kg (2x5kg)", "details": "Contrôle strict.", "equipment": "Haltères 5kg", "reps_start": 15, "reps_target_max": 30, "progression_note": "Vise la brûlure." },
                { "type": "break", "duration": 60, "name": "Repos" },
                { "type": "exercise", "name": "Élévations Latérales avec Haltères (Optionnel 4ème série)", "reps": 15, "weight": 10, "weight_unit": "kg (2x5kg)", "details": "Si énergie, pour plus de volume.", "equipment": "Haltères 5kg", "reps_start": 15, "reps_target_max": 30, "progression_note": "Dernière série, proche de l'échec." },
                { "type": "break", "duration": 60, "name": "Repos" },
                { "type": "exercise", "name": "Band Pushdowns", "reps": 12, "weight_text": "Élastique 15kg", "details": "Ancrage porte haut. Focus triceps.", "equipment": "Élastique 15kg, Accroche porte, Poignées", "reps_start": 12, "reps_target_max": 20, "progression_note": "Quand 20 reps (RIR 0-1) avec 15kg, passer au 25kg (recommencer vers 10-12 reps). Puis combiner 15+25kg. Option Drop Set." },
                { "type": "break", "duration": 60, "name": "Repos" },
                { "type": "exercise", "name": "Band Pushdowns - Série 2", "reps": 12, "weight_text": "Élastique 15kg", "details": "Garde la tension.", "equipment": "Élastique 15kg, Accroche porte, Poignées", "reps_start": 12, "reps_target_max": 20, "progression_note": "Même résistance." },
                { "type": "break", "duration": 60, "name": "Repos" },
                { "type": "exercise", "name": "Band Pushdowns - Série 3", "reps": 12, "weight_text": "Élastique 15kg", "details": "Contraction maximale.", "equipment": "Élastique 15kg, Accroche porte, Poignées", "reps_start": 12, "reps_target_max": 20, "progression_note": "Finis fort !" }
            ]
        },
        Pull: {
            "routine_name": "PULL V5.2 - Hypertrophie Élite (Format App)",
            "description": "Séance PULL optimisée. Priorité largeur dos, biceps intenses.",
            "workout_data": [
                { "type": "exercise", "name": "Band Kneeling Lat Pulldown (Avec Pauses Iso & Excentrique Lente)", "reps": 10, "weight_text": "Élastique 15kg", "details": "Ancrage porte haut. Pause Iso 2-3s en contraction + Excentrique 3-4s sur chaque rep.", "equipment": "Élastique 15kg, Accroche porte, Poignées, Tapis de sol", "reps_start": 10, "reps_target_max": 15, "progression_note": "Quand 15 reps (RIR 1-2) avec 15kg, passer au 25kg (vers 8-10 reps). Puis 15+25kg." },
                { "type": "break", "duration": 75, "name": "Repos" },
                { "type": "exercise", "name": "Band Kneeling Lat Pulldown (Avec Pauses Iso & Excentrique Lente) - Série 2", "reps": 10, "weight_text": "Élastique 15kg", "details": "Maintiens la technique.", "equipment": "Élastique 15kg, Accroche porte, Poignées, Tapis de sol", "reps_start": 10, "reps_target_max": 15, "progression_note": "Même résistance." },
                { "type": "break", "duration": 75, "name": "Repos" },
                { "type": "exercise", "name": "Band Kneeling Lat Pulldown (Avec Pauses Iso & Excentrique Lente) - Série 3", "reps": 10, "weight_text": "Élastique 15kg", "details": "Focus contraction.", "equipment": "Élastique 15kg, Accroche porte, Poignées, Tapis de sol", "reps_start": 10, "reps_target_max": 15, "progression_note": "Squeeze !" },
                { "type": "break", "duration": 75, "name": "Repos" },
                { "type": "exercise", "name": "Band Kneeling Lat Pulldown (Avec Pauses Iso & Excentrique Lente) - Série 4", "reps": 10, "weight_text": "Élastique 15kg", "details": "Dernière série, qualité maximale.", "equipment": "Élastique 15kg, Accroche porte, Poignées, Tapis de sol", "reps_start": 10, "reps_target_max": 15, "progression_note": "Finis en beauté." },
                { "type": "break", "duration": 75, "name": "Repos" },
                { "type": "exercise_myo_reps_unilateral", "name": "Band Bent-Over Row Unilatéral - MYO-REPS", "sets_info": "1 Série d'Activation + 3-4 Mini-Séries (par côté)", "activation_reps_start": 10, "activation_reps_target_max": 15, "mini_sets_count": "3-4", "mini_reps_start": 3, "mini_reps_target_max": 5, "reps_unit": "par côté", "weight_text": "Élastique 15kg", "details": "Focus épaisseur du dos, un bras à la fois.", "equipment": "Élastique 15kg, Poignées", "progression_note": "Activ: Quand 15 reps (RIR 1) avec 15kg, passer 25kg. Puis 15+25kg. Mini-Séries: Viser 4 mini-séries ou plus de reps.", "rest_between_mini_sets": 15, "rest_after_exercise": 75, "reps_text": "MYO Uni", "weight_text":"Élastique 15kg" },
                { "type": "break", "duration": 75, "name": "Repos après Myo-Reps" },
                { "type": "exercise", "name": "Band Face Pull", "reps": 15, "weight_text": "Élastique 15kg", "details": "Ancrage hauteur visage. Focus arrière d'épaules.", "equipment": "Élastique 15kg, Accroche porte, Poignées", "reps_start": 15, "reps_target_max": 25, "progression_note": "Quand 25 reps (RIR 1-2) avec 15kg, tester 25kg (vers 12-15 reps). Qualité." },
                { "type": "break", "duration": 60, "name": "Repos" },
                { "type": "exercise", "name": "Band Face Pull - Série 2", "reps": 15, "weight_text": "Élastique 15kg", "details": "Contrôle le mouvement.", "equipment": "Élastique 15kg, Accroche porte, Poignées", "reps_start": 15, "reps_target_max": 25, "progression_note": "Maintiens la forme." },
                { "type": "break", "duration": 60, "name": "Repos" },
                { "type": "exercise", "name": "Band Face Pull - Série 3", "reps": 15, "weight_text": "Élastique 15kg", "details": "Sensation dans l'arrière d'épaule.", "equipment": "Élastique 15kg, Accroche porte, Poignées", "reps_start": 15, "reps_target_max": 25, "progression_note": "Focus contraction." },
                { "type": "break", "duration": 60, "name": "Repos" },
                { "type": "exercise", "name": "Band Face Pull - Série 4", "reps": 15, "weight_text": "Élastique 15kg", "details": "Dernière série, application maximale.", "equipment": "Élastique 15kg, Accroche porte, Poignées", "reps_start": 15, "reps_target_max": 25, "progression_note": "Proche de l'échec." },
                { "type": "break", "duration": 60, "name": "Repos" },
                { "type": "exercise_myo_reps_unilateral_in_superset", "name": "Curls Marteau avec Haltères (Myo-Reps - Superset Mécanique 1/2)", "sets_info": "Partie 1/2 du Superset - Total 3 Supersets. 1 Série d'Activation + 2-3 Mini-Séries (par bras)", "activation_reps_start": 10, "activation_reps_target_max": 15, "mini_sets_count": "2-3", "mini_reps_start": 3, "mini_reps_target_max": 5, "reps_unit": "par bras", "weight": 5, "weight_unit": "kg (par haltère)", "details": "Focus brachial et brachio-radial.", "equipment": "Haltères 5kg", "progression_note": "Activ: Augmenter reps. Mini-Séries: Augmenter reps/nb de mini-séries.", "rest_between_mini_sets": 10, "reps_text": "MYO Uni", "weight_text":"5kg" },
                { "type": "break", "duration": 15, "name": "Transition Superset Biceps (15s)" },
                { "type": "exercise_unilateral_in_superset", "name": "Concentration Curl avec UN Haltère (Superset Mécanique 2/2)", "sets_info": "Partie 2/2 du Superset - Total 3 Supersets", "reps_text": "AMRAP", "reps_unit": "par bras", "weight": 5, "weight_unit": "kg", "details": "Focus pic du biceps.", "equipment": "Haltère 5kg, Tapis de sol", "progression_note": "Chercher à augmenter le nombre de reps propres." },
                { "type": "break", "duration": 75, "name": "Repos après Superset Biceps" },
                { "type": "exercise_myo_reps_unilateral_in_superset", "name": "Curls Marteau avec Haltères (Myo-Reps - Superset Mécanique 1/2) - Série 2", "sets_info": "Partie 1/2 du Superset. 1 Act. + 2-3 Mini (par bras)", "activation_reps_start": 10, "mini_reps_start": 3, "reps_unit": "par bras", "weight": 5, "weight_unit": "kg", "details": "Maintiens l'effort.", "equipment": "Haltères 5kg", "progression_note": "Vise la même intensité.", "rest_between_mini_sets": 10, "reps_text": "MYO Uni", "weight_text":"5kg" },
                { "type": "break", "duration": 15, "name": "Transition Superset Biceps (15s)" },
                { "type": "exercise_unilateral_in_superset", "name": "Concentration Curl avec UN Haltère (Superset Mécanique 2/2) - Série 2", "sets_info": "Partie 2/2 du Superset.", "reps_text": "AMRAP", "reps_unit": "par bras", "weight": 5, "weight_unit": "kg", "details": "Continue de pousser.", "equipment": "Haltère 5kg", "progression_note": "Augmente les reps si possible." },
                { "type": "break", "duration": 75, "name": "Repos après Superset Biceps" },
                { "type": "exercise_myo_reps_unilateral_in_superset", "name": "Curls Marteau avec Haltères (Myo-Reps - Superset Mécanique 1/2) - Série 3", "sets_info": "Partie 1/2 du Superset. 1 Act. + 2-3 Mini (par bras)", "activation_reps_start": 10, "mini_reps_start": 3, "reps_unit": "par bras", "weight": 5, "weight_unit": "kg", "details": "Dernier superset, à fond !", "equipment": "Haltères 5kg", "progression_note": "Donne tout !", "rest_between_mini_sets": 10, "reps_text": "MYO Uni", "weight_text":"5kg" },
                { "type": "break", "duration": 15, "name": "Transition Superset Biceps (15s)" },
                { "type": "exercise_unilateral_in_superset", "name": "Concentration Curl avec UN Haltère (Superset Mécanique 2/2) - Série 3", "sets_info": "Partie 2/2 du Superset.", "reps_text": "AMRAP", "reps_unit": "par bras", "weight": 5, "weight_unit": "kg", "details": "Échec musculaire !", "equipment": "Haltère 5kg", "progression_note": "Vide le chargeur !" },
                { "type": "break", "duration": 75, "name": "Repos après Superset Biceps" },
                { "type": "exercise", "name": "Band Scapular Retractions (Optionnel)", "reps": 15, "weight_text": "Élastique 15kg", "details": "Focus contraction omoplates.", "equipment": "Élastique 15kg", "reps_start": 15, "reps_target_max": 20, "progression_note": "Qualité du mouvement." },
                { "type": "break", "duration": 45, "name": "Repos" },
                { "type": "exercise", "name": "Band Scapular Retractions (Optionnel) - Série 2", "reps": 15, "weight_text": "Élastique 15kg", "details": "Contrôle.", "equipment": "Élastique 15kg", "reps_start": 15, "reps_target_max": 20, "progression_note": "Maintiens." },
                { "type": "break", "duration": 45, "name": "Repos (Fin si 2 séries)" },
                { "type": "exercise", "name": "Band Scapular Retractions (Optionnel) - Série 3", "reps": 15, "weight_text": "Élastique 15kg", "details": "Si 3ème série.", "equipment": "Élastique 15kg", "reps_start": 15, "reps_target_max": 20, "progression_note": "Finisher." }
            ]
        },
        Legs: {
            "routine_name": "LEGS & ABDOS V1.7 - Hypertrophie Élite (Format App)",
            "description": "Séance Jambes & Abdos. Priorité Abdos puis Quadriceps.",
            "workout_data": [
                { "type": "exercise", "name": "Front Squat Combo (Avec Pause en Bas 2-3s)", "reps": 10, "weight_text": "Élastique 15+25kg + 1 haltère 5kg", "details": "Pause en position basse. Focus quads et fessiers.", "equipment": "Élastique 15kg/25kg, Haltère 5kg, Tapis de sol", "reps_start": 10, "reps_target_max": 15, "progression_note": "Quand 15 reps (RIR 1-2) faciles, rendre la pause plus difficile (plus bas/longue) ou augmenter tension élastique." },
                { "type": "break", "duration": 105, "name": "Repos (90-120s)" },
                { "type": "exercise", "name": "Front Squat Combo (Avec Pause en Bas 2-3s) - Série 2", "reps": 10, "weight_text": "Élastique 15+25kg + 1 haltère 5kg", "details": "Maintiens la forme.", "equipment": "Élastique 15kg/25kg, Haltère 5kg, Tapis de sol", "reps_start": 10, "reps_target_max": 15, "progression_note": "Qualité." },
                { "type": "break", "duration": 105, "name": "Repos (90-120s)" },
                { "type": "exercise", "name": "Front Squat Combo (Avec Pause en Bas 2-3s) - Série 3", "reps": 10, "weight_text": "Élastique 15+25kg + 1 haltère 5kg", "details": "Pousse fort.", "equipment": "Élastique 15kg/25kg, Haltère 5kg, Tapis de sol", "reps_start": 10, "reps_target_max": 15, "progression_note": "Intensité." },
                { "type": "break", "duration": 105, "name": "Repos (90-120s)" },
                { "type": "exercise", "name": "Front Squat Combo (Avec Pause en Bas 2-3s) - Série 4", "reps": 10, "weight_text": "Élastique 15+25kg + 1 haltère 5kg", "details": "Dernière série jambes lourdes !", "equipment": "Élastique 15kg/25kg, Haltère 5kg, Tapis de sol", "reps_start": 10, "reps_target_max": 15, "progression_note": "Finis solide." },
                { "type": "break", "duration": 105, "name": "Repos (90-120s)" },
                { "type": "exercise", "name": "Fentes Arrières Alternées (Avec Haltères et Excentrique Lente 3-4s)", "reps": 8, "reps_unit": "par jambe", "weight": 10, "weight_unit": "kg (2x5kg)", "details": "Descente contrôlée. Focus quads et fessiers.", "equipment": "Haltères 5kg, Tapis de sol", "reps_start": 8, "reps_target_max": 12, "progression_note": "Quand 12 reps (RIR 1-2) faciles, ralentir excentrique (4-5s) ou envisager ajout élastique 15kg." },
                { "type": "break", "duration": 90, "name": "Repos" },
                { "type": "exercise", "name": "Fentes Arrières Alternées (Avec Haltères et Excentrique Lente 3-4s) - Série 2", "reps": 8, "reps_unit": "par jambe", "weight": 10, "weight_unit": "kg (2x5kg)", "details": "Stabilité et contrôle.", "equipment": "Haltères 5kg, Tapis de sol", "reps_start": 8, "reps_target_max": 12, "progression_note": "Maintiens la technique." },
                { "type": "break", "duration": 90, "name": "Repos" },
                { "type": "exercise", "name": "Fentes Arrières Alternées (Avec Haltères et Excentrique Lente 3-4s) - Série 3", "reps": 8, "reps_unit": "par jambe", "weight": 10, "weight_unit": "kg (2x5kg)", "details": "Dernière série, focus sur chaque jambe.", "equipment": "Haltères 5kg, Tapis de sol", "reps_start": 8, "reps_target_max": 12, "progression_note": "Bonne excentrique !" },
                { "type": "break", "duration": 90, "name": "Repos" },
                { "type": "exercise", "name": "Reverse Nordic Curls (Focus Négative LENTE)", "reps_text": "5 Négatives", "details": "Si reps complètes, contrôler remontée. Sinon, focus négative lente.", "equipment": "Support pieds/chevilles (si besoin), Tapis de sol", "reps_start_text": "5 Nég.", "reps_target_max_text": "8 Nég. / 8-10 reps complètes", "progression_note": "Quand 8 négatives très contrôlées, augmenter temps négative ou initier remontée. Si reps complètes : viser 8-10 reps, puis augmenter." },
                { "type": "break", "duration": 75, "name": "Repos" },
                { "type": "exercise", "name": "Reverse Nordic Curls (Focus Négative LENTE) - Série 2", "reps_text": "5 Négatives", "details": "Contrôle maximal de la descente.", "equipment": "Support pieds/chevilles, Tapis", "reps_start_text": "5 Nég.", "reps_target_max_text": "8 Nég. / 8-10 reps complètes", "progression_note": "Qualité avant tout." },
                { "type": "break", "duration": 75, "name": "Repos (Fin si 2 séries)" },
                { "type": "exercise", "name": "Reverse Nordic Curls (Focus Négative LENTE) - Série 3", "reps_text": "5 Négatives", "details": "Si 3ème série, maintiens l'intensité.", "equipment": "Support pieds/chevilles, Tapis", "reps_start_text": "5 Nég.", "reps_target_max_text": "8 Nég. / 8-10 reps complètes", "progression_note": "Dernière chance pour les quads !" },
                { "type": "break", "duration": 75, "name": "Repos" },
                { "type": "exercise", "name": "Calf Raises (Sur marche/livre - TEMPO COMPLET)", "reps": 15, "weight_text": "Élastique 15+25kg + 2x5kg haltères", "details": "2s montée, 2s pause contraction, 3s descente, 1s pause étirement.", "equipment": "Élastique 15kg/25kg, Haltères 5kg, Support", "reps_start": 15, "reps_target_max": 25, "progression_note": "Quand 25 reps (RIR 0-1) faciles, augmenter temps pauses ou ralentir mouvement." },
                { "type": "break", "duration": 60, "name": "Repos" },
                { "type": "exercise", "name": "Calf Raises (Sur marche/livre - TEMPO COMPLET) - Série 2", "reps": 15, "weight_text": "Élastique 15+25kg + 2x5kg haltères", "details": "Amplitude complète.", "equipment": "Élastique 15kg/25kg, Haltères 5kg, Support", "reps_start": 15, "reps_target_max": 25, "progression_note": "Squeeze en haut, étire en bas." },
                { "type": "break", "duration": 60, "name": "Repos" },
                { "type": "exercise", "name": "Calf Raises (Sur marche/livre - TEMPO COMPLET) - Série 3", "reps": 15, "weight_text": "Élastique 15+25kg + 2x5kg haltères", "details": "Dernière série mollets, brûlure !", "equipment": "Élastique 15kg/25kg, Haltères 5kg, Support", "reps_start": 15, "reps_target_max": 25, "progression_note": "Va chercher l'échec." },
                { "type": "break", "duration": 60, "name": "Repos avant Abdos" },
                { "type": "exercise", "name": "Crunch sur Swiss Ball avec Élastique 15kg", "reps": 12, "weight_text": "Élastique 15kg", "details": "Ancré bas, tiré vers poitrine/visage. Focus haut/milieu abdos.", "equipment": "Swiss Ball, Élastique 15kg, Accroche porte (bas)", "reps_start": 12, "reps_target_max": 20, "progression_note": "Quand 20 reps (RIR 0-1) faciles avec 15kg, augmenter tension élastique ou passer au 25kg (vers 10-12 reps)." },
                { "type": "break", "duration": 60, "name": "Repos" },
                { "type": "exercise", "name": "Crunch sur Swiss Ball avec Élastique 15kg - Série 2", "reps": 12, "weight_text": "Élastique 15kg", "details": "Contraction maximale.", "equipment": "Swiss Ball, Élastique 15kg, Accroche porte", "reps_start": 12, "reps_target_max": 20, "progression_note": "Focus sur l'enroulement." },
                { "type": "break", "duration": 60, "name": "Repos" },
                { "type": "exercise", "name": "Crunch sur Swiss Ball avec Élastique 15kg - Série 3", "reps": 12, "weight_text": "Élastique 15kg", "details": "Dernière série, qualité.", "equipment": "Swiss Ball, Élastique 15kg, Accroche porte", "reps_start": 12, "reps_target_max": 20, "progression_note": "Si 4ème série : optionnelle pour plus de volume." },
                { "type": "break", "duration": 60, "name": "Repos (Fin si 3 séries)" },
                { "type": "exercise", "name": "Reverse Crunches au Sol (Contrôle excentrique)", "reps": 12, "details": "Focus bas des abdos. Contrôler la descente.", "equipment": "Tapis de sol", "reps_start": 12, "reps_target_max": 20, "progression_note": "Quand 20 reps (RIR 0-1) genoux fléchis et bonne excentrique, progresser vers jambes plus tendues." },
                { "type": "break", "duration": 60, "name": "Repos" },
                { "type": "exercise", "name": "Reverse Crunches au Sol (Contrôle excentrique) - Série 2", "reps": 12, "details": "Bascule bien le bassin.", "equipment": "Tapis de sol", "reps_start": 12, "reps_target_max": 20, "progression_note": "Excentrique lente." },
                { "type": "break", "duration": 60, "name": "Repos" },
                { "type": "exercise", "name": "Reverse Crunches au Sol (Contrôle excentrique) - Série 3", "reps": 12, "details": "Dernière série, engage bien le bas.", "equipment": "Tapis de sol", "reps_start": 12, "reps_target_max": 20, "progression_note": "Qualité jusqu'au bout." },
                { "type": "break", "duration": 60, "name": "Repos" },
                { "type": "exercise", "name": "Planche sur Swiss Ball (Coudes sur le ballon)", "duration": 45, "unit": "secondes", "details": "Focus gainage profond, instabilité.", "equipment": "Swiss Ball, Tapis de sol", "duration_start": 45, "duration_target_max": 75, "progression_note": "Quand 75s facile, ajouter des petits mouvements (cercles avec coudes) pour augmenter la difficulté." },
                { "type": "break", "duration": 60, "name": "Repos" },
                { "type": "exercise", "name": "Planche sur Swiss Ball (Coudes sur le ballon) - Série 2", "duration": 45, "unit": "secondes", "details": "Gaine fort !", "equipment": "Swiss Ball, Tapis de sol", "duration_start": 45, "duration_target_max": 75, "progression_note": "Ne lâche rien." },
                { "type": "break", "duration": 60, "name": "Repos (Fin si 2 séries)" },
                { "type": "exercise", "name": "Planche sur Swiss Ball (Coudes sur le ballon) - Série 3", "duration": 45, "unit": "secondes", "details": "Si 3ème série, tiens bon !", "equipment": "Swiss Ball, Tapis de sol", "duration_start": 45, "duration_target_max": 75, "progression_note": "Dernier effort de gainage." }
            ]
        }
    };

        const exerciseImageMapping = {
            "Dumbbell Floor Flyes": "https://ironworkout.github.io/armorworkout/superhero_dumbbell_floor_flyes.png",
            "Pompes avec Pieds Surélevés": "https://ironworkout.github.io/armorworkout/superhero_elevated_pushups_band.png",
            "Floor Press (Combo Haltères + Élastique) - MYO-REPS": "https://ironworkout.github.io/armorworkout/superhero_floor_press_combo.png",
            "Pike Push-ups": "https://ironworkout.github.io/armorworkout/superhero_pike_pushups.png",
            "Élévations Latérales avec Haltères": "https://ironworkout.github.io/armorworkout/superhero_lateral_raises.png",
            "Band Pushdowns": "https://ironworkout.github.io/armorworkout/superhero_band_pushdowns.png",
            "Band Kneeling Lat Pulldown (Avec Pauses Iso & Excentrique Lente)": "https://ironworkout.github.io/armorworkout/superhero_band_kneeling_lat_pulldown.png",
            "Band Bent-Over Row Unilatéral - MYO-REPS": "https://ironworkout.github.io/armorworkout/superhero_band_bent_over_row_unilateral.png",
            "Band Face Pull": "https://ironworkout.github.io/armorworkout/superhero_band_face_pull.png",
            "Curls Marteau avec Haltères": "https://ironworkout.github.io/armorworkout/superhero_hammer_curls.png", 
            "Concentration Curl avec UN Haltère": "https://ironworkout.github.io/armorworkout/superhero_concentration_curl.png",
            "Band Scapular Retractions": "https://ironworkout.github.io/armorworkout/superhero_band_scapular_retractions.png",
            "Front Squat Combo (Avec Pause en Bas 2-3s)": "https://ironworkout.github.io/armorworkout/superhero_front_squat_combo.png",
            "Fentes Arrières Alternées (Avec Haltères et Excentrique Lente 3-4s)": "https://ironworkout.github.io/armorworkout/superhero_rear_lunges_dumbbells.png",
            "Reverse Nordic Curls (Focus Négative LENTE)": "https://ironworkout.github.io/armorworkout/superhero_reverse_nordic_curls.png",
            "Calf Raises (Sur marche/livre - TEMPO COMPLET)": "https://ironworkout.github.io/armorworkout/superhero_calf_raises_combo.png",
            "Crunch sur Swiss Ball avec Élastique 15kg": "https://ironworkout.github.io/armorworkout/superhero_swiss_ball_crunch_band.png",
            "Reverse Crunches au Sol (Contrôle excentrique)": "https://ironworkout.github.io/armorworkout/superhero_reverse_crunches.png",
            "Planche sur Swiss Ball (Coudes sur le ballon)": "https://ironworkout.github.io/armorworkout/superhero_swiss_ball_plank.png",
        };


        // --- VARIABLES GLOBALES ---
        let timeDisplayDiv, timerStateDisplay, currentExerciseContainer, progressTracker, startPauseBtn, skipBtn, finishBtn, resetBtn, prevBtn,
            navButtons = [], navHistoryBtn, navProgressBtn, signInButton, driveStatusElement, driveStatusTextElement, settingsIcon,
            postWorkoutSummary, summaryTitle, summaryItemsList, finishSummaryBtn, historyDriveStatus,
            currentExerciseNameDisplay, driveConnectionStatusMain, driveConnectionText, timerDisplayElement,
            chartPlaceholder, progressTextArea, historyActionsContainer, exerciseSelect, metricSelect, periodSelect,
            exerciseChartPlaceholder, repAdjustmentOverlay, repAdjustMinusBtn, repAdjustPlusBtn, currentRepsDisplay,
            repAdjustmentExerciseName, historyChartCanvasEl, exerciseProgressChartCanvasEl, messageArea,
            workoutSection, historySection, progressSection, statsDisplay, statsContentWrapper, historyFilterBtns,
            reactorElement, exerciseImageContainer, exerciseImageDisplay;

        let currentWorkoutType = null, currentWorkoutPlan = [], originalCompletedWorkoutPlan = [];
        let currentItemIndex = 0, timerInterval = null, prepareCountdownInterval = null;
        let totalTime = 0, timeLeft = 0, prepareTimeLeft = 0;
        let isTimerRunning = false, isWorkoutActive = false, workoutFinished = false, wasFinishedState = false;
        let currentState = 'idle';
        let previousState = 'idle'; 
        let workoutStartTime = null, workoutHistory = [];
        let currentHistoryPeriod = 'week';
        let historyChartInstance = null, exercisePerfChartInstance = null;
        let googleAccessToken = null, tokenClient = null;
        let historyFileId = null, programFileIds = { Push: null, Pull: null, Legs: null };
        let programsLoaded = false, loadedWorkouts = {};
        let isSavingDriveData = false; 
        let currentTheme = 'dark', messageTimeoutId = null; 
        let audioContext = null;
        let nextExerciseIndexForAdjustment = -1, currentRepAdjustment = 0, isRepAdjustmentVisible = false;
        let gisCheckRetries = 0; 
        let halfwayTimeoutId = null; 

        let soundLaser, sound5, sound4, sound3, sound2, sound1, soundWindows, soundET;
        let triangleSpinTimeoutId = null; 

        // --- FONCTIONS DE BASE ---

        function normalizeExerciseName(name) {
            if (!name) return "";
            let baseName = name;
            baseName = baseName.replace(/ - Série \d+/i, '');
            baseName = baseName.replace(/\s*\(Pré-Épuisement Superset \d\/\d\)/i, '');
            baseName = baseName.replace(/\s*\(Superset Mécanique \d\/\d\)/i, '');
            baseName = baseName.replace(/\s*\(Optionnel \d+ème série\)/i, '');
            baseName = baseName.replace(/\s*\(Optionnel\)/i, '');
            if (baseName.startsWith("Curls Marteau avec Haltères (Myo-Reps")) {
                return "Curls Marteau avec Haltères";
            }
            return baseName.trim();
        }

        function triggerTriangleSpin() {
            const triangle = document.querySelector('.reactor .triangle');
            if (!triangle) return;

            if (triangleSpinTimeoutId) { 
                clearTimeout(triangleSpinTimeoutId);
            }
            triangle.classList.remove('spin-transition');
            void triangle.offsetWidth; 
            triangle.classList.add('spin-transition');

            triangleSpinTimeoutId = setTimeout(() => {
                triangle.classList.remove('spin-transition');
                triangleSpinTimeoutId = null;
            }, 600); 
        }
        
        function initSounds() {
            try {
                const basePath = "https://ironworkout.github.io/armorworkout/"; 
                soundLaser = new Audio(basePath + 'laser.mp3');
                sound5 = new Audio(basePath + '5.mp3');
                sound4 = new Audio(basePath + '4.mp3');
                sound3 = new Audio(basePath + '3.mp3');
                sound2 = new Audio(basePath + '2.mp3');
                sound1 = new Audio(basePath + '1.mp3');
                soundWindows = new Audio(basePath + 'windows.mp3');
                soundET = new Audio(basePath + 'e-t.mp3');

                [soundLaser, sound5, sound4, sound3, sound2, sound1, soundWindows, soundET].forEach(sound => {
                    if (sound) sound.preload = 'auto';
                });
            } catch (e) {
                console.error("Erreur de chargement des sons:", e);
                showMessage("Erreur chargement sons.", 5000, true);
            }
        }

        function playSound(audioElement) {
            if (!audioElement || !audioContext || audioContext.state !== 'running') return;
            audioElement.currentTime = 0; 
            audioElement.play().catch(e => { /* console.warn("Erreur lecture son:", e) */ });
        }

        function initAudioContext() {
            if (audioContext && audioContext.state === 'running') return; 

            if (!audioContext) {
                try {
                    window.AudioContext = window.AudioContext || window.webkitAudioContext;
                    if (window.AudioContext) {
                        audioContext = new AudioContext();
                    } else {
                        console.warn("AudioContext non supporté.");
                        return; 
                    }
                } catch (e) {
                    console.error("Erreur création AudioContext:", e);
                    return;
                }
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume().catch(e => console.warn("Reprise AudioContext échouée:", e));
            }
        }
        const playTransitionSound = () => playSound(soundLaser); 

        const vibrate = (pattern = [100]) => { 
            if ('vibrate' in navigator) {
                try {
                    navigator.vibrate(pattern);
                } catch (e) {
                }
            }
        };


        // --- AUTHENTIFICATION GOOGLE & DRIVE ---

        async function gisInitInternal() {
            if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
                try {
                    tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: GOOGLE_CLIENT_ID,
                        scope: GOOGLE_DRIVE_SCOPES,
                        callback: tokenCallback, 
                        error_callback: handleTokenError, 
                    });
                    if (tokenClient) {
                        tokenClient.requestAccessToken({ prompt: '' }); 
                    }
                    if (signInButton) signInButton.disabled = false; 
                } catch (error) {
                    console.error("Erreur GIS initTokenClient:", error);
                    showMessage("Erreur initialisation services Google.", 5000, true);
                    updateAuthUI(false); 
                    if(signInButton) signInButton.disabled = true; 
                }
            } else {
                console.error("API Google (GIS) non chargée lors de gisInitInternal.");
                if(signInButton) signInButton.disabled = true;
            }
        }

        function checkAndInitGis() {
            if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2 && typeof google.accounts.oauth2.initTokenClient === 'function') {
                gisInitInternal();
            } else if (gisCheckRetries < GIS_MAX_RETRIES) {
                gisCheckRetries++;
                setTimeout(checkAndInitGis, GIS_CHECK_INTERVAL);
            } else {
                console.error("Échec détection API Google après plusieurs tentatives.");
                showMessage("Erreur critique: API Google non disponible.", 10000, true);
                if(signInButton) signInButton.disabled = true; 
            }
        }

        function handleTokenError(error) {
            console.error("Erreur Google Token:", error);
            let userMessage = `Erreur Authentification Google: ${error.type || error.error || 'Inconnue'}`;
            if (error.type === 'popup_closed_by_user' || error.error === 'popup_closed_by_user') {
                userMessage = "Fenêtre de connexion Google fermée.";
            } else if (error.type === 'popup_failed_to_open') {
                userMessage = "Impossible d'ouvrir la fenêtre de connexion. Vérifiez les bloqueurs de popups.";
            } else if (error.type === 'USER_CANCELLED' || error.error === 'access_denied') {
                userMessage = "Accès aux données Drive refusé par l'utilisateur.";
            }

            let statusText = 'Erreur Auth';
            if (driveStatusElement) {
                driveStatusElement.className = 'error'; 
                driveStatusElement.style.display = 'inline-flex'; 
            }
            showMessage(userMessage, 7000, true);
            if (driveStatusTextElement) driveStatusTextElement.textContent = statusText;
            updateAuthUI(false); 
        }

        async function tokenCallback(tokenResponse) {
            if (driveStatusElement) driveStatusElement.className = ''; 

            if (tokenResponse.error) {
                if (tokenResponse.error !== "popup_failed_to_open" && tokenResponse.error !== "popup_closed_by_user") {
                    handleTokenError(tokenResponse); 
                } else {
                    updateAuthUI(false); 
                }
                return;
            }

            if (tokenResponse && tokenResponse.access_token) {
                googleAccessToken = tokenResponse.access_token;
                showMessage("Connecté ! Chargement des données...", 2500);

                if (driveStatusElement) {
                    driveStatusElement.classList.remove('error', 'success'); // Reset before adding loading
                    driveStatusElement.classList.add('loading'); 
                    driveStatusElement.style.display = 'inline-flex';
                }
                if(driveStatusTextElement) driveStatusTextElement.textContent = 'Chargement...';

                let historyLoaded = false;
                let programsSuccess = false;
                try {
                    await loadHistoryFromDrive(); 
                    historyLoaded = true; 
                    
                    programsSuccess = await loadProgramsFromDrive(); 
                    programsLoaded = programsSuccess; 

                    if (programsLoaded) { // This covers both successful load from Drive and fallback to defaults
                        showMessage("Données prêtes.", 3000);
                        if (driveStatusElement) {
                            driveStatusElement.classList.remove('loading', 'error');
                            driveStatusElement.classList.add('success');
                        }
                         if(driveStatusTextElement) driveStatusTextElement.textContent = 'Connecté';
                    } else { // This case might be less likely if loadProgramsFromDrive always resolves to true on fallback
                        showMessage("Erreur chargement des programmes depuis Drive.", 5000, true);
                        if (driveStatusElement) {
                            driveStatusElement.classList.remove('loading');
                            driveStatusElement.classList.add('error');
                        }
                        if(driveStatusTextElement) driveStatusTextElement.textContent = 'Erreur Progs';
                    }
                } catch (error) {
                    console.error("Erreur majeure chargement données Drive:", error);
                    showMessage("Erreur majeure lors du chargement depuis Drive.", 6000, true);
                    if (driveStatusElement) {
                        driveStatusElement.classList.remove('loading', 'success');
                        driveStatusElement.classList.add('error');
                    }
                     if(driveStatusTextElement) driveStatusTextElement.textContent = 'Erreur Données';
                    programsLoaded = false; 
                } finally {
                    updateAuthUI(true); 
                    // Only proceed if programs are considered "available" (either from Drive or default fallbacks)
                    if (programsLoaded || Object.keys(loadedWorkouts).length > 0) { 
                        populateExerciseSelect(); 
                        displayHistory(currentHistoryPeriod); 
                        displayExerciseProgress(); 
                        loadInProgressState(); 
                    }
                }
            } else {
                handleTokenError({ error: "Réponse de token invalide ou vide" });
            }
        }
        
        function handleAuthClick() {
            initAudioContext(); 
            if (!tokenClient) {
                showMessage("Services Google non prêts. Veuillez patienter.", 3000);
                checkAndInitGis(); 
                return;
            }

            if (driveStatusElement) { 
                driveStatusElement.classList.remove('error', 'success');
                driveStatusElement.classList.add('loading');
                driveStatusElement.style.display = 'inline-flex';
            }
            if(driveStatusTextElement) driveStatusTextElement.textContent = 'Connexion...';
            
            tokenClient.requestAccessToken({ prompt: 'consent' });
        }
        
        function updateAuthUI(isLoggedIn) {
            const body = document.body;
            body.classList.toggle('logged-in', isLoggedIn);
            body.classList.toggle('logged-out', !isLoggedIn);

            if (driveStatusElement && driveStatusTextElement) {
                driveStatusElement.style.display = isLoggedIn ? 'inline-flex' : 'none';
                if (isLoggedIn) { 
                    const currentClasses = driveStatusElement.className;
                    if (currentClasses.includes('loading')) {
                         driveStatusTextElement.textContent = 'Chargement...';
                    } else if (currentClasses.includes('error')) {
                        // Le texte est déjà géré par handleTokenError ou tokenCallback
                    } else { // success
                        driveStatusElement.classList.add('success'); // Assure que la classe success est là
                        driveStatusTextElement.textContent = 'Connecté';
                    }
                } else {
                     driveStatusElement.className = ''; 
                     driveStatusTextElement.textContent = ''; // Clear text
                }
            }

            if (driveConnectionStatusMain && driveConnectionText) {
                driveConnectionStatusMain.style.display = isLoggedIn ? 'inline-flex' : 'none';
                const dsClass = driveStatusElement?.className || ''; 
                driveConnectionStatusMain.className = dsClass; 
                if (isLoggedIn) {
                    if (dsClass.includes('loading')) driveConnectionText.textContent = "Chargement...";
                    else if (dsClass.includes('error')) driveConnectionText.textContent = `Erreur Drive`;
                    else driveConnectionText.textContent = "Connecté";
                }
            }
            
            if (historyDriveStatus && historyActionsContainer) {
                historyActionsContainer.style.display = isLoggedIn ? 'flex' : 'none';
                if (isLoggedIn) {
                    historyDriveStatus.className = ''; 
                    if (isSavingDriveData) {
                        historyDriveStatus.textContent = 'Synchro...';
                        historyDriveStatus.classList.add('syncing');
                    } else if (driveStatusElement?.classList.contains('loading')) { 
                        historyDriveStatus.textContent = 'Chargement...';
                        historyDriveStatus.classList.add('syncing');
                    } else if (driveStatusElement?.classList.contains('error')) { 
                        historyDriveStatus.textContent = 'Erreur Synchro';
                        historyDriveStatus.classList.add('error');
                    } else {
                        historyDriveStatus.textContent = 'Synchro OK';
                        historyDriveStatus.classList.add('success');
                    }
                }
            }

            if(signInButton) signInButton.disabled = isLoggedIn || !tokenClient; 

            const isTimerActive = ['preparing', 'exercise', 'break', 'paused'].includes(currentState);

            navButtons.forEach(btn => {
                if(btn) btn.disabled = !(isLoggedIn && programsLoaded && !isTimerActive);
            });
            document.querySelectorAll('nav a.nav-link').forEach(link => {
                 if (isTimerActive) {
                    link.classList.add('disabled-link-look');
                 } else {
                    link.classList.remove('disabled-link-look');
                 }
            });

            if(navHistoryBtn) navHistoryBtn.disabled = isTimerActive; 
            if(navProgressBtn) navProgressBtn.disabled = !isLoggedIn || isTimerActive; 

            if (currentState === 'idle') {
                const canStartWorkout = isLoggedIn && programsLoaded && !!currentWorkoutType && currentWorkoutPlan && currentWorkoutPlan.length > 0;
                if(startPauseBtn) {
                    startPauseBtn.disabled = !canStartWorkout;
                    startPauseBtn.innerHTML = `<i class="fas fa-play"></i> Démarrer`;
                    startPauseBtn.className = ''; 
                }
            } else if (startPauseBtn) { 
                startPauseBtn.disabled = ['preparing', 'finished'].includes(currentState);
            }

            if(prevBtn) prevBtn.disabled = !(isTimerActive && currentItemIndex > 0);
            if(finishBtn) finishBtn.disabled = !isTimerActive;
            if(resetBtn) resetBtn.disabled = !isTimerActive && !isLoggedIn; 

            updateWorkoutInfo(); 
            displayHistory(currentHistoryPeriod); 
        }


        // --- GESTION DES FICHIERS SUR GOOGLE DRIVE ---

        async function findOrCreateFile(filename, defaultContent = "", mimeType = 'application/json') {
            if (!googleAccessToken) return null; 

            const searchUrl = `https://www.googleapis.com/drive/v3/files?q=name='${encodeURIComponent(filename)}'+and+trashed=false&spaces=drive&fields=files(id,name)`;
            try {
                const searchRes = await fetch(searchUrl, {
                    headers: { 'Authorization': `Bearer ${googleAccessToken}` }
                });
                if (!searchRes.ok) {
                    if (searchRes.status === 401 || searchRes.status === 403) { 
                        showMessage("Session expirée. Veuillez vous reconnecter.", 5000, true);
                        googleAccessToken = null; updateAuthUI(false);
                        return null;
                    }
                    throw new Error(`Erreur recherche fichier ${filename}: ${searchRes.status}`);
                }
                const searchData = await searchRes.json();

                if (searchData.files && searchData.files.length > 0) {
                    return searchData.files[0].id; 
                }

                const createUrl = `https://www.googleapis.com/drive/v3/files`;
                const metadata = { name: filename, mimeType: mimeType };
                const createRes = await fetch(createUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${googleAccessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(metadata)
                });
                if (!createRes.ok) throw new Error(`Erreur création fichier ${filename}: ${createRes.status}`);
                
                const createData = await createRes.json();
                const newFileId = createData.id;

                const writeSuccess = await updateFileContent(newFileId, defaultContent);
                return writeSuccess ? newFileId : null;

            } catch (error) {
                console.error(`Erreur findOrCreateFile pour ${filename}:`, error);
                showMessage(`Erreur gestion fichier ${filename}.`, 5000, true);
                return null;
            }
        }

        async function readFileContent(fileId) {
            if (!googleAccessToken || !fileId) return null;

            const url = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`;
            try {
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${googleAccessToken}` }
                });
                if (!response.ok) {
                    if (response.status === 404) return ""; 
                    if (response.status === 401 || response.status === 403) {
                        showMessage("Session expirée. Veuillez vous reconnecter.", 5000, true);
                        googleAccessToken = null; updateAuthUI(false);
                        return null;
                    }
                    throw new Error(`Erreur lecture fichier ${fileId}: ${response.status}`);
                }
                return await response.text(); 
            } catch (error) {
                console.error(`Erreur readFileContent pour ${fileId}:`, error);
                showMessage(`Erreur lecture fichier Drive.`, 5000, true);
                return null;
            }
        }

        async function updateFileContent(fileId, content) {
            if (!googleAccessToken || !fileId) return false;
            if (isSavingDriveData) { 
                console.warn("Sauvegarde Drive déjà en cours, requête ignorée.");
                return false; 
            }
            isSavingDriveData = true;
            if (historyDriveStatus) { 
                historyDriveStatus.textContent = 'Synchro...';
                historyDriveStatus.className = 'syncing';
            }
            updateAuthUI(!!googleAccessToken); 

            const url = `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`;
            const isJson = typeof content === 'object'; 
            const contentToSend = isJson ? JSON.stringify(content, null, 2) : content;
            const contentType = isJson ? 'application/json; charset=UTF-8' : 'text/plain; charset=UTF-8';
            let success = false;

            try {
                const response = await fetch(url, {
                    method: 'PATCH', 
                    headers: {
                        'Authorization': `Bearer ${googleAccessToken}`,
                        'Content-Type': contentType
                    },
                    body: contentToSend
                });
                if (!response.ok) {
                    if (response.status === 401 || response.status === 403) {
                        showMessage("Session expirée. Veuillez vous reconnecter.", 5000, true);
                         googleAccessToken = null; updateAuthUI(false);
                    } else {
                        throw new Error(`Erreur écriture fichier ${fileId}: ${response.status}`);
                    }
                } else {
                    success = true; 
                }
            } catch (error) {
                console.error(`Erreur updateFileContent pour ${fileId}:`, error);
                if (historyDriveStatus) {
                    historyDriveStatus.textContent = 'Erreur Synchro';
                    historyDriveStatus.className = 'error';
                }
                showMessage(`Erreur sauvegarde fichier Drive.`, 5000, true);
            } finally {
                isSavingDriveData = false; 
                updateAuthUI(!!googleAccessToken); 
            }
            return success;
        }


        // --- LOGIQUE DU TIMER ET DE L'ENTRAÎNEMENT ---

        function formatTime(seconds) {
            const cleanSeconds = Math.max(0, Math.round(seconds)); 
            const minutes = Math.floor(cleanSeconds / 60);
            const remainingSeconds = cleanSeconds % 60;
            return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        function updateTimerDisplay() {
            if (!timeDisplayDiv || !timerStateDisplay) return;

            let timeString = "00:00";
            let stateText = '';
            let stateClass = ''; 
            const item = currentWorkoutPlan[currentItemIndex];
            const durationSeconds = workoutStartTime ? (Date.now() - workoutStartTime) / 1000 : 0;

            switch(currentState) {
                case 'exercise':
                    timeString = "GO!"; 
                    stateText = item?.name || 'Exercice';
                    break;
                case 'break':
                    timeString = formatTime(timeLeft);
                    stateText = item?.name || 'Repos';
                    break;
                case 'paused':
                    timeString = (previousState === 'break') ? formatTime(timeLeft) : "PAUSE"; 
                    stateText = 'En Pause';
                    break;
                case 'preparing':
                    timeString = formatTime(prepareTimeLeft);
                    stateText = 'Préparation';
                    break;
                case 'finished':
                    timeString = "FINI!";
                    stateText = `Terminé ${durationSeconds > 0 ? `(${formatTime(durationSeconds)})` : ''}`;
                    stateClass = 'finished-state';
                    break;
                default: 
                    timeString = formatTime(0);
                    stateText = 'Prêt';
                    break;
            }
            timeDisplayDiv.textContent = timeString;
            timerStateDisplay.textContent = stateText;

            timerStateDisplay.className = 'timer-state'; 
            if (currentState !== 'idle') timerStateDisplay.classList.add('visible');
            if (stateClass) timerStateDisplay.classList.add(stateClass);
            if (currentState === 'preparing') timerStateDisplay.classList.add('preparing'); 
        }
        
        function updateTimerVisuals(state) {
            if (!timeDisplayDiv || !timerStateDisplay) return;

            let stateColorVar = '--idle-color-val';
            let stateGlowRgbVar = '--idle-color-rgb'; 

            switch(state) {
                case 'exercise': stateColorVar = '--exercise-color-val'; stateGlowRgbVar = '--exercise-color-rgb'; break;
                case 'break':    stateColorVar = '--break-color-val';    stateGlowRgbVar = '--break-color-rgb';    break;
                case 'paused':   stateColorVar = '--paused-color-val';   stateGlowRgbVar = '--paused-color-rgb';   break;
                case 'preparing':stateColorVar = '--preparing-color-val';stateGlowRgbVar = '--preparing-color-rgb';break;
                case 'finished': stateColorVar = '--finished-color-val'; stateGlowRgbVar = '--finished-color-rgb'; break;
                default: break;
            }
            
            const rootStyle = getComputedStyle(document.documentElement);
            const stateColor = rootStyle.getPropertyValue(stateColorVar).trim();
            const stateGlowRgb = rootStyle.getPropertyValue(stateGlowRgbVar).trim(); 

            const textGlowValue = `0 0 10px rgba(${stateGlowRgb}, 0.7), 0 0 20px rgba(${stateGlowRgb}, 0.4)`;
            timeDisplayDiv.style.color = stateColor;
            timeDisplayDiv.style.textShadow = textGlowValue;
            timerStateDisplay.style.color = stateColor;
            timerStateDisplay.style.textShadow = textGlowValue;

            document.documentElement.style.setProperty('--current-timer-color', stateColor);
            document.documentElement.style.setProperty('--current-timer-color-rgb', stateGlowRgb); 
            document.documentElement.style.setProperty('--current-timer-glow', textGlowValue);
        }

        function updateWorkoutInfo() {
            if (!currentExerciseContainer || !currentExerciseNameDisplay || !progressTracker || !progressTextArea || !exerciseImageContainer || !exerciseImageDisplay) return;

            const item = currentWorkoutPlan[currentItemIndex];
            let infoHtml = '';
            let exerciseName = '';
            let progressText = '';
            const body = document.body; 

            let showImage = false;
            let imageUrlForDisplay = '';

            if (item && (item.type === 'exercise' || item.type?.startsWith('exercise_')) && 
                (currentState === 'exercise' || (currentState === 'paused' && previousState === 'exercise'))) {
                const normalizedName = normalizeExerciseName(item.name);
                imageUrlForDisplay = exerciseImageMapping[normalizedName];
                if (imageUrlForDisplay) showImage = true;
            } else if (currentState === 'preparing' && currentWorkoutPlan[0] && 
                       (currentWorkoutPlan[0].type === 'exercise' || currentWorkoutPlan[0].type?.startsWith('exercise_'))) {
                const normalizedName = normalizeExerciseName(currentWorkoutPlan[0].name);
                imageUrlForDisplay = exerciseImageMapping[normalizedName];
                if (imageUrlForDisplay) showImage = true;
            }
            if (showImage && imageUrlForDisplay) {
                exerciseImageDisplay.src = imageUrlForDisplay;
                exerciseImageDisplay.alt = item?.name || "Image de l'exercice";
                exerciseImageContainer.classList.add('visible');
            } else {
                exerciseImageContainer.classList.remove('visible');
                setTimeout(() => {
                    if (!exerciseImageContainer.classList.contains('visible')) {
                        exerciseImageDisplay.src = '';
                        exerciseImageDisplay.alt = '';
                    }
                }, 400); 
            }


            switch (currentState) {
                case 'idle':
                    exerciseName = "ArmorWorkout";
                    const loginMsg = `<div class="workout-prompt"><i class="fas fa-sign-in-alt"></i><span>Connectez-vous pour commencer.</span></div>`;
                    const loadingMsg = `<div class="workout-prompt"><i class="fas fa-spinner fa-spin"></i><span>Chargement des données...</span></div>`;
                    const selectMsg = `<div class="workout-prompt"><i class="fas fa-hand-pointer"></i><span>Sélectionnez un entraînement (Push/Pull/Legs).</span></div>`;
                    const readyMsg = `<div class="workout-prompt"><i class="fas fa-play-circle"></i><span>Prêt à démarrer: ${currentWorkoutType || 'aucun entraînement'}.</span></div>`;


                    if (!googleAccessToken) { progressText = "Connectez-vous"; infoHtml = loginMsg; }
                    else if (!programsLoaded) { progressText = "Chargement..."; infoHtml = loadingMsg; }
                    else if (!currentWorkoutType) { progressText = "Sélectionnez P/P/L"; infoHtml = selectMsg; }
                    else { progressText = `Prêt: ${currentWorkoutType}`; infoHtml = readyMsg; }
                    break;

                case 'finished':
                    const durationSeconds = workoutStartTime ? (Date.now() - workoutStartTime) / 1000 : 0;
                    exerciseName = 'Entraînement Terminé !';
                    infoHtml = `<div class="exercise-details" style="border-color: var(--color-finished);"><i class="fas ${getIconForState('finished')}" style="color: var(--color-finished)"></i><span>Bravo ! ${durationSeconds > 0 ? `(${formatTime(durationSeconds)})` : ''}</span></div>`;
                    progressText = `Fini (${originalCompletedWorkoutPlan.length}/${originalCompletedWorkoutPlan.length})`;
                    break;

                case 'preparing':
                    const nextItem = currentWorkoutPlan[0]; 
                    exerciseName = `Préparation...`;
                    infoHtml = `<div class="break-info" style="border-color: var(--color-prepare);"><i class="fas ${getIconForState('preparing')} fa-spin" style="color: var(--color-prepare)"></i><span>Prêt pour <strong>${nextItem?.name || 'Exercice'}</strong> (${formatTime(prepareTimeLeft)})...</span></div>`;
                    progressText = `Prépa... (1/${currentWorkoutPlan.length})`;
                    break;

                case 'exercise':
                case 'paused': 
                case 'break':
                    if (!item) { 
                        exerciseName = 'Erreur';
                        infoHtml = '<p>Erreur de chargement de l\'étape.</p>';
                        progressText = `Étape ?/${currentWorkoutPlan.length}`;
                        break;
                    }
                    exerciseName = `${item.name || (item.type === 'break' ? 'Repos' : 'Exercice Inconnu')}`;
                    progressText = `Étape ${currentItemIndex + 1}/${currentWorkoutPlan.length}`;

                    if (item.type === 'exercise' || item.type?.startsWith('exercise_')) {
                        const repsDisplay = item.reps_text || (item.reps_start !== undefined ? item.reps_start : item.reps) || '-';
                        let weightDisplay = '-';
                        if (item.weight_text) weightDisplay = item.weight_text;
                        else if (item.weight_details) weightDisplay = item.weight_details;
                        else if (item.weight !== undefined && item.weight_unit) weightDisplay = `${item.weight} ${item.weight_unit}`;
                        else if (item.weight !== undefined && item.weight > 0) weightDisplay = `${item.weight} kg`;
                        else if (item.weight_unit === "Poids de corps") weightDisplay = "Poids de corps";
                        
                        const details = item.details || '';
                        const setsInfo = item.sets_info || '';
                        const repsUnit = item.reps_unit ? ` ${item.reps_unit}` : '';

                        infoHtml = `<div class="exercise-details" style="border-color: var(--color-exercise);">`;
                        if (setsInfo) infoHtml += `<span class="sets-info-text"><i class="fas fa-layer-group"></i> ${setsInfo}</span>`;
                        infoHtml += `<span><i class="fas ${getIconForType(item.type)}" style="color: var(--color-exercise)"></i> ${repsDisplay}${repsUnit}</span>`;
                        if (weightDisplay !== '-') infoHtml += `<span><i class="fas fa-weight-hanging"></i> ${weightDisplay}</span>`;
                        if (details) infoHtml += `<span class="details-text"><i class="fas fa-info-circle"></i> ${details}</span>`;
                        infoHtml += `</div>`;

                    } else if (item.type === 'break') {
                        infoHtml = `<div class="break-info" style="border-color: var(--color-break);"><i class="fas ${getIconForType('break')}" style="color: var(--color-break)"></i><span>${item.name || `Pause: ${formatTime(item.duration || 0)}`}</span></div>`;
                        
                        const nextExerciseIndex = currentItemIndex + 1;
                        if (nextExerciseIndex < currentWorkoutPlan.length && 
                            (currentWorkoutPlan[nextExerciseIndex].type === 'exercise' || currentWorkoutPlan[nextExerciseIndex].type?.startsWith('exercise_'))) {
                            const nextEx = currentWorkoutPlan[nextExerciseIndex];
                            const nextReps = nextEx.reps_text || (nextEx.reps_start !== undefined ? nextEx.reps_start : nextEx.reps) || '-';
                            let nextWeight = '-';
                             if (nextEx.weight_text) nextWeight = nextEx.weight_text;
                             else if (nextEx.weight_details) nextWeight = nextEx.weight_details;
                             else if (nextEx.weight !== undefined && nextEx.weight_unit) nextWeight = `${nextEx.weight} ${nextEx.weight_unit}`;
                             else if (nextEx.weight !== undefined && nextEx.weight > 0) nextWeight = `${nextEx.weight} kg`;
                             else if (nextEx.weight_unit === "Poids de corps") nextWeight = "Poids de corps";
                            const nextRepsUnit = nextEx.reps_unit ? ` ${nextEx.reps_unit}` : '';
                            
                            infoHtml += `<div class="break-info" style="margin-top: 8px; opacity: 0.8; border-color: var(--color-exercise);">`; 
                            infoHtml += `<i class="fas fa-arrow-right"></i>`;
                            infoHtml += `<span>Suiv: ${nextEx.name || '?'} (${nextReps}${nextRepsUnit}${nextWeight !== '-' ? '@' + nextWeight : ''})</span>`;
                            infoHtml += `</div>`;
                        }
                    }
                    break;
                default:
                    exerciseName = '?';
                    infoHtml = '<p>État inconnu.</p>';
                    progressText = '';
                    break;
            }

            if(currentExerciseNameDisplay) currentExerciseNameDisplay.textContent = exerciseName;
            if(currentExerciseContainer) currentExerciseContainer.innerHTML = infoHtml;
            if(progressTextArea) progressTextArea.textContent = progressText;

            body.className = Array.from(body.classList).filter(cls => !cls.startsWith('state-')).join(' ') + ` state-${currentState}`;
            body.classList.toggle('workout-active', !['idle', 'finished'].includes(currentState)); 
        }

        function getIconForState(state){
            switch(state){
                case 'exercise': return 'fa-dumbbell';
                case 'break': return 'fa-hourglass-half';
                case 'paused': return 'fa-pause-circle';
                case 'preparing': return 'fa-spinner'; 
                case 'finished': return 'fa-flag-checkered';
                default: return 'fa-clock'; 
            }
        }
        function getIconForType(type){
            if (type?.startsWith('exercise_myo_reps')) return 'fa-bolt'; 
            if (type?.startsWith('exercise_')) return 'fa-fire'; 
            if (type === 'break') return 'fa-coffee';
            return 'fa-question-circle'; 
        }

        function setState(newState) {
            if (!startPauseBtn || !skipBtn || !finishBtn || !resetBtn || !timerStateDisplay || !workoutSection || !timerDisplayElement || !prevBtn || !timeDisplayDiv) {
                console.error("Erreur: Éléments DOM non trouvés lors de setState.");
                return;
            }
            previousState = currentState; 
            currentState = newState;

            clearInterval(timerInterval);
            clearInterval(prepareCountdownInterval);
            clearTimeout(halfwayTimeoutId); 

            if(timerStateDisplay) {
                timerStateDisplay.classList.remove('preparing'); 
                timerStateDisplay.classList.toggle('visible', newState !== 'idle'); 
            }
            
            updateWorkoutInfo(); 

            document.body.className = Array.from(document.body.classList).filter(cls => !cls.startsWith('state-')).join(' ') + ` state-${currentState}`;
            document.body.classList.toggle('workout-active', !['idle', 'finished'].includes(newState));

            if(startPauseBtn) startPauseBtn.className = ''; 
            if(startPauseBtn) startPauseBtn.disabled = true;
            if(skipBtn) skipBtn.disabled = true;
            if(prevBtn) prevBtn.disabled = true;
            if(finishBtn) finishBtn.disabled = true;
            if(resetBtn) resetBtn.disabled = true;

            const isTimerActive = ['preparing', 'exercise', 'break', 'paused'].includes(newState);
            navButtons.forEach(btn => {
                if(btn) btn.disabled = !(googleAccessToken && programsLoaded && !isTimerActive);
            });
            document.querySelectorAll('nav a.nav-link').forEach(link => {
                 if (isTimerActive) link.classList.add('disabled-link-look');
                 else link.classList.remove('disabled-link-look');
            });
            if(navHistoryBtn) navHistoryBtn.disabled = isTimerActive;
            if(navProgressBtn) navProgressBtn.disabled = !googleAccessToken || isTimerActive; 

            hideRepAdjustmentOverlay(); 

            switch (newState) {
                case 'idle':
                    isTimerRunning = false; isWorkoutActive = false; workoutFinished = false;
                    timeLeft = 0; totalTime = 0;
                    const canStartIdle = googleAccessToken && programsLoaded && !!currentWorkoutType && currentWorkoutPlan && currentWorkoutPlan.length > 0;
                    if(startPauseBtn) {
                        startPauseBtn.disabled = !canStartIdle;
                        startPauseBtn.innerHTML = `<i class="fas fa-play"></i> Démarrer`;
                    }
                    if(resetBtn) resetBtn.disabled = !(googleAccessToken && !!currentWorkoutType); 
                    prevBtn.disabled = true; finishBtn.disabled = true;
                    if (wasFinishedState) { 
                       wasFinishedState = false;
                    }
                    break;

                case 'preparing':
                    isWorkoutActive = true;
                    if(timerStateDisplay) timerStateDisplay.classList.add('preparing');
                    prepareTimeLeft = PREPARE_DURATION;
                    if(startPauseBtn) {
                        startPauseBtn.innerHTML = `<i class="fas ${getIconForState('preparing')} fa-spin"></i> Prêt...`;
                        startPauseBtn.disabled = true; 
                    }
                    if(resetBtn) resetBtn.disabled = !googleAccessToken;
                    prevBtn.disabled = true; finishBtn.disabled = true;
                    startPrepareCountdown();
                    if (!workoutStartTime) workoutStartTime = Date.now(); 
                    vibrate([50,30,50]);
                    break;

                case 'exercise':
                    isWorkoutActive = true; isTimerRunning = false; 
                    timeLeft = 0; totalTime = 0; 
                    if (googleAccessToken) { 
                        if(startPauseBtn) { startPauseBtn.disabled = false; startPauseBtn.innerHTML = `<i class="fas ${getIconForType(currentWorkoutPlan[currentItemIndex]?.type || 'exercise')}"></i> Fait`; }
                        if(skipBtn) skipBtn.disabled = false;
                        if(prevBtn) prevBtn.disabled = currentItemIndex <= 0;
                        if(finishBtn) finishBtn.disabled = false;
                        if(resetBtn) resetBtn.disabled = false;
                    }
                    findNextExerciseForAdjustment(); 
                    vibrate([150]); playSound(soundLaser);
                    triggerTriangleSpin();
                    break;

                case 'break':
                    isTimerRunning = true; isWorkoutActive = true;
                    if (googleAccessToken) {
                        if(startPauseBtn) { startPauseBtn.disabled = false; startPauseBtn.innerHTML = `<i class="fas ${getIconForState('paused')}"></i> Pause`; }
                        if(skipBtn) skipBtn.disabled = false;
                        if(prevBtn) prevBtn.disabled = currentItemIndex <= 0;
                        if(finishBtn) finishBtn.disabled = false;
                        if(resetBtn) resetBtn.disabled = false;
                    }
                    startBreakTimer();
                    findNextExerciseForAdjustment(); 
                    vibrate([80, 50, 80]); playSound(soundLaser);
                    triggerTriangleSpin();
                    break;

                case 'paused':
                    isTimerRunning = false; isWorkoutActive = true;
                    if (googleAccessToken) {
                        if(startPauseBtn) { startPauseBtn.disabled = false; startPauseBtn.innerHTML = `<i class="fas fa-play"></i> Reprendre`; }
                        if(skipBtn) skipBtn.disabled = false;
                        if(prevBtn) prevBtn.disabled = currentItemIndex <= 0;
                        if(finishBtn) finishBtn.disabled = false;
                        if(resetBtn) resetBtn.disabled = false;
                    }
                    vibrate();
                    break;

                case 'finished':
                    isWorkoutActive = false; isTimerRunning = false; workoutFinished = true; wasFinishedState = true;
                    timeLeft = 0; totalTime = 0;
                    if(startPauseBtn) {
                        startPauseBtn.disabled = true;
                        startPauseBtn.innerHTML = `<i class="fas ${getIconForState('finished')}"></i> Terminé`;
                    }
                    if(skipBtn) skipBtn.disabled = true;
                    if(prevBtn) prevBtn.disabled = true;
                    if(finishBtn) finishBtn.disabled = true; 
                    if(resetBtn) resetBtn.disabled = !googleAccessToken; 

                    showMessage('Entraînement terminé ! 💪', 3000);
                    vibrate([150, 50, 150]); playSound(soundET);
                    originalCompletedWorkoutPlan = JSON.parse(JSON.stringify(currentWorkoutPlan)); 
                    saveWorkoutToHistory();
                    clearInProgressState(); 
                    triggerTriangleSpin();
                    setTimeout(populateAndShowSummary, 500); 
                    break;
                
                default: 
                    currentState = 'idle';
                    updateAuthUI(!!googleAccessToken); 
                    break;
            }
            updateTimerVisuals(newState); 
            updateTimerDisplay(); 
        }

        function startPrepareCountdown() {
            updateTimerDisplay(); 
            if (prepareTimeLeft === 3) playSound(sound3);

            prepareCountdownInterval = setInterval(() => {
                prepareTimeLeft--;
                updateTimerDisplay();
                if (prepareTimeLeft === 2) playSound(sound2);
                if (prepareTimeLeft === 1) playSound(sound1);

                if (prepareTimeLeft <= 0) {
                    clearInterval(prepareCountdownInterval);
                    setState('exercise'); 
                }
            }, 1000);
        }
        
        function startBreakTimer() {
            const item = currentWorkoutPlan[currentItemIndex];
            if (!item || item.type !== 'break' || !item.duration) {
                handleItemCompletion(true); 
                return;
            }
            totalTime = item.duration;
            timeLeft = totalTime;
            updateTimerDisplay();

            if (totalTime > 10) { 
                halfwayTimeoutId = setTimeout(() => {
                    playSound(soundWindows); 
                    vibrate([50]);
                }, (totalTime / 2) * 1000);
            }
            
            if (timeLeft === 5) playSound(sound5);
            else if (timeLeft === 4) playSound(sound4);
            else if (timeLeft === 3) playSound(sound3);
            else if (timeLeft === 2) playSound(sound2);
            else if (timeLeft === 1) playSound(sound1);


            timerInterval = setInterval(() => {
                timeLeft--;
                updateTimerDisplay();

                if (timeLeft === 5) playSound(sound5);
                else if (timeLeft === 4) playSound(sound4);
                else if (timeLeft === 3) playSound(sound3);
                else if (timeLeft === 2) playSound(sound2);
                else if (timeLeft === 1) playSound(sound1);

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    clearTimeout(halfwayTimeoutId); 
                    handleItemCompletion(true); 
                }
            }, 1000);
        }

        function handleItemCompletion(naturalEnd = false) {
            if (currentState === 'finished') return; 

            const currentItem = currentWorkoutPlan[currentItemIndex];
            if (currentItem && (currentItem.type === 'exercise' || currentItem.type?.startsWith('exercise_')) &&
                (currentItem.reps_start !== undefined || currentItem.activation_reps_start !== undefined || currentItem.reps_text?.toUpperCase() === "AMRAP" || currentItem.reps_text?.toUpperCase().includes("NÉG")) &&
                nextExerciseIndexForAdjustment === currentItemIndex && 
                !isRepAdjustmentVisible && naturalEnd) { 
                showRepAdjustmentOverlay();
                return; 
            }
            
            hideRepAdjustmentOverlay(); 

            currentItemIndex++;
            if (currentItemIndex >= currentWorkoutPlan.length) {
                setState('finished'); 
            } else {
                const nextItem = currentWorkoutPlan[currentItemIndex];
                setState(nextItem.type === 'break' ? 'break' : 'exercise'); 
            }
            saveInProgressState(); 
        }

        function handlePreviousClick() {
            if (currentItemIndex > 0) {
                hideRepAdjustmentOverlay();
                currentItemIndex--;
                const prevItem = currentWorkoutPlan[currentItemIndex];
                if (prevItem.type?.startsWith('exercise_myo_reps') && prevItem.completed_mini_sets) {
                    prevItem.completed_mini_sets = 0;
                }
                setState(prevItem.type === 'break' ? 'break' : 'exercise');
                saveInProgressState();
                vibrate();
            }
        }

        function forceFinishWorkout() {
            if (confirm("Êtes-vous sûr de vouloir terminer l'entraînement ?")) {
                hideRepAdjustmentOverlay();
                setState('finished');
            }
        }


        // --- CHARGEMENT ET GESTION DES PROGRAMMES ---

        function loadWorkout(type) {
            if (!type || !PROGRAM_TYPES.includes(type)) {
                showMessage("Type d'entraînement invalide.", 3000, true);
                return;
            }
            currentWorkoutType = type;
            const programToLoad = loadedWorkouts[type] || defaultWorkouts[type];

            if (!programToLoad || !programToLoad.workout_data) {
                showMessage(`Programme ${type} non trouvé ou corrompu.`, 4000, true);
                currentWorkoutPlan = [];
            } else {
                currentWorkoutPlan = JSON.parse(JSON.stringify(programToLoad.workout_data)); 
                currentWorkoutPlan.forEach(item => {
                    if (item.type === 'exercise' || item.type?.startsWith('exercise_')) {
                        if (item.reps_start !== undefined) item.current_reps = item.reps_start;
                        else if (item.reps !== undefined) item.current_reps = item.reps; 
                        
                        if (item.type === 'exercise_myo_reps' || item.type === 'exercise_myo_reps_unilateral' || item.type === 'exercise_myo_reps_unilateral_in_superset') {
                            if (item.activation_reps_start !== undefined) item.current_activation_reps = item.activation_reps_start;
                            item.completed_mini_sets = 0; 
                        }
                         // Pour AMRAP et Négatives, current_reps sera mis à jour via l'overlay ou le résumé
                        if (item.reps_text?.toUpperCase() === "AMRAP" || item.reps_text?.toUpperCase().includes("NÉG")) {
                            item.current_reps = 0; // Init à 0, sera ajusté
                        }
                    }
                });
            }
            
            currentItemIndex = 0;
            workoutStartTime = null; 
            setState('idle'); 
            setActiveWorkoutNav(type); 
            showMessage(`${programToLoad.routine_name || type} chargé. Prêt à commencer !`, 2500);
            vibrate();
            updateWorkoutInfo(); 
            clearInProgressState(); 
        }

        function resetCurrentWorkout() {
            if (currentWorkoutType) { 
                if (confirm(`Réinitialiser l'entraînement ${currentWorkoutType} ? Toute progression non sauvegardée sera perdue.`)) {
                    loadWorkout(currentWorkoutType); 
                }
            } else { 
                currentItemIndex = 0;
                currentWorkoutPlan = [];
                workoutStartTime = null;
                setState('idle');
                setActiveWorkoutNav(null);
                showMessage("Entraînement réinitialisé.", 2000);
            }
            clearInProgressState();
        }
        

        // --- INTERFACE UTILISATEUR (Messages, Thème, Sections) ---

        function showMessage(msg, duration = 3000, isError = false) {
            if (!messageArea) return;
            messageArea.textContent = msg;
            messageArea.classList.add('visible');
            messageArea.classList.toggle('error-message', isError);

            if (messageTimeoutId) clearTimeout(messageTimeoutId); 
            messageTimeoutId = setTimeout(() => {
                messageArea.classList.remove('visible');
            }, duration);
        }

        function applyTheme(theme) {
            document.body.classList.remove('light-theme', 'dark-theme'); 
            document.body.classList.add(theme + '-theme');
            currentTheme = theme;
            localStorage.setItem('armorWorkoutTheme', theme);
            updateChartColors(); 
        }
        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('armorWorkoutTheme') || 'dark'; 
            applyTheme(savedTheme);
            if (document.getElementById('current-year')) {
                document.getElementById('current-year').textContent = new Date().getFullYear();
            }
        }

        function showSection(sectionId) {
            [workoutSection, historySection, progressSection].forEach(section => {
                if (section && section.id !== sectionId) section.classList.add('section-hidden');
            });
            const sectionToShow = document.getElementById(sectionId);
            if (sectionToShow) sectionToShow.classList.remove('section-hidden');

            navButtons.forEach(btn => btn.classList.remove('active'));
            if (navHistoryBtn) navHistoryBtn.classList.remove('active');
            if (navProgressBtn) navProgressBtn.classList.remove('active');
            
            if (sectionId === 'workout-section' && currentWorkoutType) {
                const activeNavBtn = document.getElementById(`nav-${currentWorkoutType.toLowerCase()}`);
                if (activeNavBtn) activeNavBtn.classList.add('active');
            } else if (sectionId === 'history-section' && navHistoryBtn) {
                navHistoryBtn.classList.add('active');
                displayHistory(currentHistoryPeriod); 
            } else if (sectionId === 'progress-section' && navProgressBtn) {
                navProgressBtn.classList.add('active');
                displayExerciseProgress(); 
            }
        }
        
        function setActiveWorkoutNav(type) {
            navButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.workout === type);
            });
            if (type) { 
                if (navHistoryBtn) navHistoryBtn.classList.remove('active');
                if (navProgressBtn) navProgressBtn.classList.remove('active');
                showSection('workout-section'); 
            }
        }


        // --- HISTORIQUE ET STATISTIQUES ---

        function displayHistory(period = 'week') {
            if (!googleAccessToken) { 
                renderHistoryList([]); 
                calculateAndDisplayStats([]); 
                setChartPlaceholder('history-chart-canvas', "Connectez-vous pour voir l'historique.");
                if(historyFilterBtns) historyFilterBtns.forEach(b => b.classList.remove('active'));
                return;
            }
            currentHistoryPeriod = period;
            if(historyFilterBtns) { 
                historyFilterBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.period === period));
            }

            const filteredHistory = filterHistoryByPeriod(workoutHistory, period);
            renderHistoryList(filteredHistory);
            calculateAndDisplayStats(filteredHistory);
            renderHistoryChart(filteredHistory);
        }

        function filterHistoryByPeriod(history, period) {
            if (!history) return [];
            const now = new Date();
            let startDate = new Date();

            switch (period) {
                case 'week':
                    startDate.setDate(now.getDate() - now.getDay() - (now.getDay() === 0 ? 6 : -1)); 
                    startDate.setHours(0,0,0,0);
                    break;
                case 'month':
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1); 
                     startDate.setHours(0,0,0,0);
                    break;
                case 'year':
                    startDate = new Date(now.getFullYear(), 0, 1); 
                     startDate.setHours(0,0,0,0);
                    break;
                case 'all':
                    return history; 
                default:
                    return history;
            }
            return history.filter(item => new Date(item.date) >= startDate);
        }
        
        function renderHistoryList(filteredHistory) {
            if (!historyList) return;
            historyList.innerHTML = ''; 

            if (!googleAccessToken) {
                historyList.innerHTML = '<li class="no-history">Connectez-vous pour voir l\'historique.</li>';
                return;
            }
            if (!filteredHistory || filteredHistory.length === 0) {
                historyList.innerHTML = '<li class="no-history">Aucun entraînement enregistré pour cette période.</li>';
                return;
            }

            filteredHistory.sort((a, b) => new Date(b.date) - new Date(a.date)); 

            filteredHistory.forEach(item => {
                const li = document.createElement('li');
                const itemDate = new Date(item.date);
                const dateString = itemDate.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short' });
                const timeString = itemDate.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

                const totalReps = item.exercises?.reduce((sum, ex) => {
                    // Utilise finalReps si disponible et numérique, sinon current_reps, sinon reps_start/reps
                    let repsForEx = 0;
                    if (ex.finalReps !== undefined && !isNaN(parseInt(ex.finalReps, 10))) {
                        repsForEx = parseInt(ex.finalReps, 10);
                    } else if (ex.current_reps !== undefined && !isNaN(parseInt(ex.current_reps, 10))) {
                        repsForEx = parseInt(ex.current_reps, 10);
                    } else if (ex.reps_start !== undefined && !isNaN(parseInt(ex.reps_start, 10))) {
                         repsForEx = parseInt(ex.reps_start, 10);
                    } else if (ex.reps !== undefined && !isNaN(parseInt(ex.reps, 10))) {
                         repsForEx = parseInt(ex.reps, 10);
                    } else if (ex.reps_text?.toUpperCase().includes("NÉG")) { // Cas des négatives
                        const negMatch = ex.reps_text.match(/\d+/);
                        if (negMatch) repsForEx = parseInt(negMatch[0], 10);
                    }
                    // Pour AMRAP/MYO, si `finalReps` n'est pas défini numériquement, on ne peut pas les sommer ici.
                    // Ils sont comptés comme "séries" mais pas comme "répétitions" chiffrées sauf si entré.
                    return sum + repsForEx;
                }, 0) || 0;
                
                const durationFormatted = formatTime(item.durationSeconds || 0);

                li.innerHTML = `
                    <span class="history-item-date">${dateString} <small>${timeString}</small></span>
                    <span class="history-item-type">${item.type}</span>
                    <span class="history-item-reps"><i class="fas fa-running"></i> ${totalReps > 0 ? totalReps : '-'}</span>
                    <span class="history-item-duration"><i class="fas fa-stopwatch"></i> ${durationFormatted}</span>
                `;
                historyList.appendChild(li);
            });
        }

        function calculateAndDisplayStats(filteredHistory) {
            if (!statsDisplay || !statsContentWrapper) return;

            if (!googleAccessToken) {
                statsContentWrapper.innerHTML = '<p>Connectez-vous pour voir les statistiques.</p>';
                if (statsDisplay.querySelector('.motivational-message')) statsDisplay.querySelector('.motivational-message').textContent = '';
                return;
            }

            const totalWorkouts = filteredHistory.length;
            const totalDuration = filteredHistory.reduce((sum, item) => sum + (item.durationSeconds || 0), 0);
            const avgDuration = totalWorkouts > 0 ? totalDuration / totalWorkouts : 0;
            
            let totalRepsAllWorkouts = 0;
            filteredHistory.forEach(workout => {
                workout.exercises?.forEach(ex => {
                    let repsForEx = 0;
                    if (ex.finalReps !== undefined && !isNaN(parseInt(ex.finalReps, 10))) {
                        repsForEx = parseInt(ex.finalReps, 10);
                    } else if (ex.current_reps !== undefined && !isNaN(parseInt(ex.current_reps, 10))) {
                        repsForEx = parseInt(ex.current_reps, 10);
                    } else if (ex.reps_start !== undefined && !isNaN(parseInt(ex.reps_start, 10))) {
                         repsForEx = parseInt(ex.reps_start, 10);
                    } else if (ex.reps !== undefined && !isNaN(parseInt(ex.reps, 10))) {
                         repsForEx = parseInt(ex.reps, 10);
                    } else if (ex.reps_text?.toUpperCase().includes("NÉG")) {
                        const negMatch = ex.reps_text.match(/\d+/);
                        if (negMatch) repsForEx = parseInt(negMatch[0], 10);
                    }
                    totalRepsAllWorkouts += repsForEx;
                });
            });


            statsContentWrapper.innerHTML = `
                <p><i class="fas fa-dumbbell"></i> Entraînements: <strong>${totalWorkouts}</strong></p>
                <p><i class="fas fa-stopwatch"></i> Temps total: <strong>${formatTime(totalDuration)}</strong></p>
                <p><i class="fas fa-clock"></i> Durée moyenne: <strong>${formatTime(avgDuration)}</strong></p>
                <p><i class="fas fa-running"></i> Répétitions totales: <strong>${totalRepsAllWorkouts > 0 ? totalRepsAllWorkouts : '-'}</strong></p>
            `;

            const motivationalMessageEl = statsDisplay.querySelector('.motivational-message');
            if (motivationalMessageEl) {
                if (totalWorkouts === 0) motivationalMessageEl.textContent = "Commencez votre premier entraînement !";
                else if (totalWorkouts < 5) motivationalMessageEl.textContent = "Continuez comme ça, chaque séance compte !";
                else motivationalMessageEl.textContent = "Quelle régularité, impressionnant !";
            }
        }

        function aggregateChartData(hist, period, metric = 'durationSeconds') {
            if (!hist || hist.length === 0) return { labels: [], data: [] };
            
            const dataMap = new Map();
            const now = new Date();

            hist.forEach(item => {
                const itemDate = new Date(item.date);
                let key;

                if (period === 'week') { 
                    const dayIndex = itemDate.getDay(); 
                    const adjustedDayIndex = (dayIndex === 0) ? 6 : dayIndex -1;
                    const days = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
                    key = days[adjustedDayIndex];
                } else if (period === 'month') { 
                    const dayOfMonth = itemDate.getDate();
                    const weekNumber = Math.ceil(dayOfMonth / 7);
                    key = `S${weekNumber}`; 
                } else if (period === 'year') { 
                    const monthIndex = itemDate.getMonth(); 
                    const months = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Août', 'Sep', 'Oct', 'Nov', 'Déc'];
                    key = months[monthIndex];
                } else { 
                    key = `${itemDate.getFullYear()}-${String(itemDate.getMonth() + 1).padStart(2, '0')}`; 
                }
                
                const value = parseFloat(item[metric]) || 0;
                dataMap.set(key, (dataMap.get(key) || 0) + value);
            });
            
            let sortedLabels;
            if (period === 'week') {
                const dayOrder = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
                sortedLabels = Array.from(dataMap.keys()).sort((a,b) => dayOrder.indexOf(a) - dayOrder.indexOf(b));
            } else if (period === 'month') { 
                sortedLabels = Array.from(dataMap.keys()).sort((a,b) => parseInt(a.substring(1)) - parseInt(b.substring(1)));
            } else if (period === 'year') {
                const monthOrder = ['Jan', 'Fév', 'Mar', 'Avr', 'Mai', 'Juin', 'Juil', 'Août', 'Sep', 'Oct', 'Nov', 'Déc'];
                sortedLabels = Array.from(dataMap.keys()).sort((a,b) => monthOrder.indexOf(a) - monthOrder.indexOf(b));
            } else { 
                sortedLabels = Array.from(dataMap.keys()).sort();
            }

            const data = sortedLabels.map(label => dataMap.get(label) / (metric === 'durationSeconds' ? 60 : 1)); 

            return { labels: sortedLabels, data };
        }

        function getChartXAxisTitle(period){
            switch(period){
                case 'week': return 'Jour de la semaine';
                case 'month': return 'Semaine du mois';
                case 'year': return 'Mois';
                case 'all': return 'Mois (sur tout l\'historique)';
                default: return 'Période';
            }
        }

        function renderHistoryChart(filteredHistory) {
            if (!historyChartCanvasEl) return;
            const { labels, data } = aggregateChartData(filteredHistory, currentHistoryPeriod, 'durationSeconds');

            if (labels.length === 0 || data.length === 0) {
                setChartPlaceholder('history-chart-canvas', "Pas de données pour afficher le graphique.");
                if (historyChartInstance) { historyChartInstance.destroy(); historyChartInstance = null; }
                return;
            }
            setChartPlaceholder('history-chart-canvas', "", false); 

            const ctx = historyChartCanvasEl.getContext('2d');
            if (historyChartInstance) historyChartInstance.destroy(); 

            const rootStyle = getComputedStyle(document.documentElement);
            historyChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Durée Entraînement (minutes)',
                        data: data,
                        backgroundColor: `rgba(${rootStyle.getPropertyValue('--electric-cyan-rgb').trim()}, 0.6)`,
                        borderColor: `rgb(${rootStyle.getPropertyValue('--electric-cyan-rgb').trim()})`,
                        borderWidth: 1,
                        borderRadius: 4,
                        barPercentage: 0.7,
                        categoryPercentage: 0.8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Minutes', color: rootStyle.getPropertyValue('--secondary-text-color-dark').trim() },
                            ticks: { color: rootStyle.getPropertyValue('--secondary-text-color-dark').trim() },
                            grid: { color: `rgba(${rootStyle.getPropertyValue('--electric-blue-rgb').trim()}, 0.1)` }
                        },
                        x: {
                            title: { display: true, text: getChartXAxisTitle(currentHistoryPeriod), color: rootStyle.getPropertyValue('--secondary-text-color-dark').trim() },
                            ticks: { color: rootStyle.getPropertyValue('--secondary-text-color-dark').trim() },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: `rgba(${rootStyle.getPropertyValue('--secondary-bg-color-dark-rgb').trim()}, 0.9)`,
                            titleColor: rootStyle.getPropertyValue('--primary-text-color-dark').trim(),
                            bodyColor: rootStyle.getPropertyValue('--primary-text-color-dark').trim(),
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(0)} min`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateChartColors() {
            if (historyChartInstance) {
                const rootStyle = getComputedStyle(document.documentElement);
                historyChartInstance.data.datasets[0].backgroundColor = `rgba(${rootStyle.getPropertyValue('--electric-cyan-rgb').trim()}, 0.6)`;
                historyChartInstance.data.datasets[0].borderColor = `rgb(${rootStyle.getPropertyValue('--electric-cyan-rgb').trim()})`;
                historyChartInstance.options.scales.y.title.color = rootStyle.getPropertyValue('--secondary-text-color-dark').trim();
                historyChartInstance.options.scales.y.ticks.color = rootStyle.getPropertyValue('--secondary-text-color-dark').trim();
                historyChartInstance.options.scales.y.grid.color = `rgba(${rootStyle.getPropertyValue('--electric-blue-rgb').trim()}, 0.1)`;
                historyChartInstance.options.scales.x.title.color = rootStyle.getPropertyValue('--secondary-text-color-dark').trim();
                historyChartInstance.options.scales.x.ticks.color = rootStyle.getPropertyValue('--secondary-text-color-dark').trim();
                historyChartInstance.options.plugins.tooltip.backgroundColor = `rgba(${rootStyle.getPropertyValue('--secondary-bg-color-dark-rgb').trim()}, 0.9)`;
                historyChartInstance.options.plugins.tooltip.titleColor = rootStyle.getPropertyValue('--primary-text-color-dark').trim();
                historyChartInstance.options.plugins.tooltip.bodyColor = rootStyle.getPropertyValue('--primary-text-color-dark').trim();
                historyChartInstance.update();
            }
            if (exercisePerfChartInstance) { 
                const rootStyle = getComputedStyle(document.documentElement);
                exercisePerfChartInstance.data.datasets[0].borderColor = `rgb(${rootStyle.getPropertyValue('--neon-green-rgb').trim()})`;
                exercisePerfChartInstance.data.datasets[0].backgroundColor = `rgba(${rootStyle.getPropertyValue('--neon-green-rgb').trim()}, 0.1)`;
                exercisePerfChartInstance.options.scales.y.title.color = rootStyle.getPropertyValue('--secondary-text-color-dark').trim();
                exercisePerfChartInstance.options.scales.y.ticks.color = rootStyle.getPropertyValue('--secondary-text-color-dark').trim();
                exercisePerfChartInstance.options.scales.y.grid.color = `rgba(${rootStyle.getPropertyValue('--electric-blue-rgb').trim()}, 0.1)`;
                exercisePerfChartInstance.options.scales.x.ticks.color = rootStyle.getPropertyValue('--secondary-text-color-dark').trim();
                exercisePerfChartInstance.options.scales.x.grid.color = `rgba(${rootStyle.getPropertyValue('--electric-blue-rgb').trim()}, 0.05)`;
                exercisePerfChartInstance.options.plugins.tooltip.backgroundColor = `rgba(${rootStyle.getPropertyValue('--secondary-bg-color-dark-rgb').trim()}, 0.9)`;
                exercisePerfChartInstance.options.plugins.tooltip.titleColor = rootStyle.getPropertyValue('--primary-text-color-dark').trim();
                exercisePerfChartInstance.options.plugins.tooltip.bodyColor = rootStyle.getPropertyValue('--primary-text-color-dark').trim();
                exercisePerfChartInstance.update();
            }
        }

        function clearCharts() {
            if (historyChartInstance) { historyChartInstance.destroy(); historyChartInstance = null; }
            if (exercisePerfChartInstance) { exercisePerfChartInstance.destroy(); exercisePerfChartInstance = null; }
        }

        function setChartPlaceholder(canvasId, message, show = true) {
            const placeholderId = canvasId.replace('-canvas', '-placeholder'); 
            const placeholderEl = document.getElementById(placeholderId);
            const canvasEl = document.getElementById(canvasId);

            if (placeholderEl && canvasEl) {
                placeholderEl.textContent = message;
                placeholderEl.style.display = show ? 'block' : 'none';
                canvasEl.style.opacity = show ? '0.2' : '1'; 
            }
        }


        // --- PROGRESSION PAR EXERCICE ---

        function populateExerciseSelect() {
            if (!exerciseSelect || !workoutHistory) return;
            const uniqueExercises = new Set();
            workoutHistory.forEach(session => {
                session.exercises?.forEach(ex => {
                    uniqueExercises.add(normalizeExerciseName(ex.name));
                });
            });
            Object.values(loadedWorkouts).concat(Object.values(defaultWorkouts)).forEach(program => {
                program?.workout_data?.forEach(item => {
                    if (item.type === 'exercise' || item.type?.startsWith('exercise_')) {
                        uniqueExercises.add(normalizeExerciseName(item.name));
                    }
                });
            });

            exerciseSelect.innerHTML = '<option value="all">Tous les exercices (Total Reps agrégées)</option>'; 
            Array.from(uniqueExercises).sort().forEach(exName => { 
                if (exName) { 
                    const option = document.createElement('option');
                    option.value = exName;
                    option.textContent = exName;
                    exerciseSelect.appendChild(option);
                }
            });
        }

        function displayExerciseProgress() {
            if (!exerciseProgressChartCanvasEl || !exerciseSelect || !periodSelect || !googleAccessToken) {
                 setChartPlaceholder('exercise-progress-chart', "Connectez-vous pour voir la progression.");
                return;
            }

            const selectedExerciseName = exerciseSelect.value;
            const selectedPeriod = periodSelect.value;

            const exerciseData = { labels: [], data: [] };
            let filteredSessionHistory = workoutHistory;

            if (selectedPeriod !== 'all') {
                const now = new Date();
                let startDate = new Date();
                if (selectedPeriod === '3months') startDate.setMonth(now.getMonth() - 3);
                else if (selectedPeriod === '6months') startDate.setMonth(now.getMonth() - 6);
                startDate.setHours(0,0,0,0);
                filteredSessionHistory = workoutHistory.filter(session => new Date(session.date) >= startDate);
            }

            filteredSessionHistory.sort((a, b) => new Date(a.date) - new Date(b.date)); 

            filteredSessionHistory.forEach(session => {
                const sessionDate = new Date(session.date).toLocaleDateString('fr-CA'); 
                let valueForSession = 0;

                session.exercises?.forEach(ex => {
                    const normalizedExName = normalizeExerciseName(ex.name);
                    let reps = 0;
                    if (ex.finalReps !== undefined && !isNaN(parseInt(ex.finalReps, 10))) reps = parseInt(ex.finalReps, 10);
                    else if (ex.current_reps !== undefined && !isNaN(parseInt(ex.current_reps, 10))) reps = parseInt(ex.current_reps, 10);
                    else if (ex.reps_start !== undefined && !isNaN(parseInt(ex.reps_start, 10))) reps = parseInt(ex.reps_start, 10);
                    else if (ex.reps !== undefined && !isNaN(parseInt(ex.reps, 10))) reps = parseInt(ex.reps, 10);
                    else if (ex.reps_text?.toUpperCase().includes("NÉG")) {
                        const negMatch = ex.reps_text.match(/\d+/);
                        if (negMatch) reps = parseInt(negMatch[0], 10);
                    }


                    if (selectedExerciseName === "all") {
                        valueForSession += reps; 
                    } else if (normalizedExName === selectedExerciseName) {
                        valueForSession += reps; 
                    }
                });
                
                if (valueForSession > 0 || selectedExerciseName === "all") { 
                    const existingLabelIndex = exerciseData.labels.indexOf(sessionDate);
                    if (existingLabelIndex > -1) {
                        exerciseData.data[existingLabelIndex] += valueForSession;
                    } else {
                        exerciseData.labels.push(sessionDate);
                        exerciseData.data.push(valueForSession);
                    }
                }
            });

            if (exerciseData.labels.length === 0) {
                setChartPlaceholder('exercise-progress-chart', "Aucune donnée de répétition pour cet exercice/période.");
                if (exercisePerfChartInstance) { exercisePerfChartInstance.destroy(); exercisePerfChartInstance = null; }
                return;
            }
            setChartPlaceholder('exercise-progress-chart', "", false); 

            const ctx = exerciseProgressChartCanvasEl.getContext('2d');
            if (exercisePerfChartInstance) exercisePerfChartInstance.destroy();

            const rootStyle = getComputedStyle(document.documentElement);
            exercisePerfChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: exerciseData.labels,
                    datasets: [{
                        label: selectedExerciseName === "all" ? 'Total Répétitions' : `Répétitions pour ${selectedExerciseName}`,
                        data: exerciseData.data,
                        borderColor: `rgb(${rootStyle.getPropertyValue('--neon-green-rgb').trim()})`,
                        backgroundColor: `rgba(${rootStyle.getPropertyValue('--neon-green-rgb').trim()}, 0.1)`,
                        tension: 0.1, 
                        fill: true, 
                        pointRadius: 4,
                        pointBackgroundColor: `rgb(${rootStyle.getPropertyValue('--neon-green-rgb').trim()})`
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Répétitions', color: rootStyle.getPropertyValue('--secondary-text-color-dark').trim()},
                            ticks: { color: rootStyle.getPropertyValue('--secondary-text-color-dark').trim() },
                            grid: { color: `rgba(${rootStyle.getPropertyValue('--electric-blue-rgb').trim()}, 0.1)` }
                        },
                        x: {
                            ticks: { color: rootStyle.getPropertyValue('--secondary-text-color-dark').trim(), maxRotation: 70, minRotation: 20 },
                            grid: { color: `rgba(${rootStyle.getPropertyValue('--electric-blue-rgb').trim()}, 0.05)` } 
                        }
                    },
                    plugins: {
                        legend: { display: true, labels: { color: rootStyle.getPropertyValue('--primary-text-color-dark').trim()} },
                        tooltip: {
                            backgroundColor: `rgba(${rootStyle.getPropertyValue('--secondary-bg-color-dark-rgb').trim()}, 0.9)`,
                            titleColor: rootStyle.getPropertyValue('--primary-text-color-dark').trim(),
                            bodyColor: rootStyle.getPropertyValue('--primary-text-color-dark').trim(),
                        }
                    }
                }
            });
        }


        // --- RÉSUMÉ POST-ENTRAÎNEMENT ET OBJECTIFS ---

        function populateAndShowSummary() {
            if (!postWorkoutSummary || !summaryItemsList || !summaryTitle) return;

            summaryTitle.textContent = `Résumé: ${currentWorkoutType || 'Entraînement'}`;
            summaryItemsList.innerHTML = ''; 

            originalCompletedWorkoutPlan.forEach((item, index) => {
                if (item.type === 'exercise' || item.type?.startsWith('exercise_')) {
                    const li = document.createElement('li');
                    li.classList.add('summary-item');

                    const baseReps = item.reps_text || (item.reps_start !== undefined ? item.reps_start : item.reps) || 0;
                    let displayReps = baseReps;
                    let repsUnit = item.reps_unit ? ` ${item.reps_unit}` : '';
                    let inputId = `summary-reps-${index}`;
                    let currentValue = item.current_reps; // Valeur par défaut pour l'input

                    if (item.type === 'exercise_myo_reps' || item.type === 'exercise_myo_reps_unilateral' || item.type === 'exercise_myo_reps_unilateral_in_superset') {
                        currentValue = item.current_activation_reps !== undefined ? item.current_activation_reps : (item.activation_reps_start || 0);
                        repsUnit += " (Total Myo)";
                    } else if (item.reps_text?.toUpperCase() === "AMRAP") {
                        currentValue = item.current_reps || 0; 
                        repsUnit = " (AMRAP)";
                    } else if (item.reps_text?.toUpperCase().includes("NÉG")) { 
                        currentValue = item.current_reps || parseInt(item.reps_text.match(/\d+/)?.[0] || "0", 10);
                        repsUnit = " (Négatives)";
                    }
                    
                    li.innerHTML = `
                        <span class="exercise-name">
                            <i class="fas ${getIconForType(item.type)}"></i>
                            ${item.name}
                            ${item.reps_unit ? `<small>(${item.reps_unit})</small>` : ''}
                        </span>
                        <div class="input-container">
                            <label for="${inputId}">Reps effectuées pour ${item.name}:</label>
                            <input type="number" id="${inputId}" value="${currentValue}" min="0" step="1" aria-label="Répétitions pour ${item.name}">
                            <span>reps ${repsUnit.trim()}</span>
                        </div>
                    `;
                    summaryItemsList.appendChild(li);
                }
            });
            postWorkoutSummary.classList.add('visible');
        }
        
        async function finishSummary() {
            if (!finishSummaryBtn) return;
            finishSummaryBtn.disabled = true; 
            finishSummaryBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Sauvegarde...`;

            const latestWorkoutEntry = workoutHistory[workoutHistory.length - 1];
            if (!latestWorkoutEntry) {
                console.error("Aucune entrée d'historique à mettre à jour pour le résumé.");
                closeSummary();
                showMessage("Erreur: Impossible de sauvegarder le résumé.", 4000, true);
                if(finishSummaryBtn) { 
                    finishSummaryBtn.disabled = false;
                    finishSummaryBtn.innerHTML = `<i class="fas fa-check"></i> Fin & Sauvegarder`;
                }
                return;
            }

            let exerciseIndexInHistory = 0; 
            originalCompletedWorkoutPlan.forEach((item, planIndex) => {
                if (item.type === 'exercise' || item.type?.startsWith('exercise_')) {
                    const inputId = `summary-reps-${planIndex}`;
                    const inputElement = document.getElementById(inputId);
                    if (inputElement && latestWorkoutEntry.exercises[exerciseIndexInHistory]) {
                        const finalReps = parseInt(inputElement.value, 10);
                        if (!isNaN(finalReps)) {
                            latestWorkoutEntry.exercises[exerciseIndexInHistory].finalReps = finalReps;
                        }
                    }
                    exerciseIndexInHistory++;
                }
            });
            
            await saveHistoryToDrive(); 
            
            closeSummary(false); 
            const previouslyActiveWorkoutType = currentWorkoutType; // Sauvegarde avant de potentiellement le changer
            setState('idle'); 
            if (previouslyActiveWorkoutType) { // Si un type de workout était actif
                loadWorkout(previouslyActiveWorkoutType); 
            }


            showMessage("Entraînement et résumé sauvegardés !", 3000);
            if(finishSummaryBtn) { 
                finishSummaryBtn.disabled = false;
                finishSummaryBtn.innerHTML = `<i class="fas fa-check"></i> Fin & Sauvegarder`;
            }
        }

        function closeSummary(updateUIafter = true) {
            if(postWorkoutSummary) postWorkoutSummary.classList.remove('visible');
            if (updateUIafter) {
                setState('idle'); 
            }
        }
        
        // --- SAUVEGARDE ET CHARGEMENT (DRIVE & LOCALSTORAGE) ---
        
        async function saveHistoryToDrive() {
            if (!googleAccessToken || !workoutHistory) return;
            if (!historyFileId) { 
                historyFileId = await findOrCreateFile(HISTORY_FILENAME, JSON.stringify([]));
            }
            if (historyFileId) {
                const success = await updateFileContent(historyFileId, workoutHistory);
                 if (success && historyDriveStatus) {
                    historyDriveStatus.textContent = 'Synchro OK';
                    historyDriveStatus.className = 'success';
                }
            } else {
                showMessage("Impossible de sauvegarder l'historique sur Drive (ID fichier inconnu).", 4000, true);
                 if (historyDriveStatus) {
                    historyDriveStatus.textContent = 'Erreur ID';
                    historyDriveStatus.className = 'error';
                }
            }
        }
        
        async function loadHistoryFromDrive() {
            if (!googleAccessToken) return;
            historyFileId = await findOrCreateFile(HISTORY_FILENAME, JSON.stringify([])); 
            if (historyFileId) {
                const content = await readFileContent(historyFileId);
                if (content !== null) { 
                    try {
                        workoutHistory = JSON.parse(content || "[]"); 
                        workoutHistory.forEach(entry => {
                            if (!entry.exercises) entry.exercises = [];
                        });
                    } catch (e) {
                        console.error("Erreur parsing historique Drive:", e);
                        showMessage("Historique Drive corrompu. Utilisation d'un historique vierge.", 4000, true);
                        workoutHistory = [];
                    }
                } else { 
                     workoutHistory = []; 
                }
            } else { 
                 workoutHistory = []; 
            }
            displayHistory(currentHistoryPeriod); 
            populateExerciseSelect(); 
        }

        async function loadProgramsFromDrive() {
            if (!googleAccessToken) {
                loadedWorkouts = JSON.parse(JSON.stringify(defaultWorkouts)); 
                programsLoaded = true; // Important: marquer comme chargé même si ce sont les défauts
                return true; 
            }

            let allProgramsLoadedSuccessfullyFromDrive = true;
            for (const type of PROGRAM_TYPES) {
                const filename = PROGRAM_FILENAMES[type];
                if (!filename) continue;

                programFileIds[type] = await findOrCreateFile(filename, JSON.stringify(defaultWorkouts[type] || {}));
                if (programFileIds[type]) {
                    const content = await readFileContent(programFileIds[type]);
                    if (content !== null) {
                        try {
                            const parsedProgram = JSON.parse(content);
                            if (parsedProgram && parsedProgram.workout_data && Array.isArray(parsedProgram.workout_data)) {
                                loadedWorkouts[type] = parsedProgram;
                            } else {
                                throw new Error(`Programme ${type} malformé.`);
                            }
                        } catch (e) {
                            console.error(`Erreur parsing programme ${type} depuis Drive:`, e);
                            showMessage(`Programme ${type} Drive corrompu. Utilisation du programme par défaut.`, 4000, true);
                            loadedWorkouts[type] = JSON.parse(JSON.stringify(defaultWorkouts[type] || {})); 
                            allProgramsLoadedSuccessfullyFromDrive = false; 
                        }
                    } else { 
                        loadedWorkouts[type] = JSON.parse(JSON.stringify(defaultWorkouts[type] || {}));
                        allProgramsLoadedSuccessfullyFromDrive = false;
                    }
                } else { 
                    showMessage(`Impossible de charger/créer le fichier pour ${type} sur Drive. Utilisation du défaut.`, 4000, true);
                    loadedWorkouts[type] = JSON.parse(JSON.stringify(defaultWorkouts[type] || {}));
                    allProgramsLoadedSuccessfullyFromDrive = false;
                }
            }
            programsLoaded = true; 
            return allProgramsLoadedSuccessfullyFromDrive; 
        }
        
        function saveInProgressState() {
            if (!isWorkoutActive || currentState === 'finished') {
                clearInProgressState(); 
                return;
            }
            const stateToSave = {
                currentWorkoutType,
                currentWorkoutPlan: JSON.parse(JSON.stringify(currentWorkoutPlan)), 
                currentItemIndex,
                timeLeft, 
                prepareTimeLeft, 
                workoutStartTime,
                currentState,
                previousState
            };
            localStorage.setItem(IN_PROGRESS_KEY, JSON.stringify(stateToSave));
        }

        function loadInProgressState() {
            const savedState = localStorage.getItem(IN_PROGRESS_KEY);
            if (savedState) {
                try {
                    const parsedState = JSON.parse(savedState);
                    if (parsedState.currentWorkoutType && parsedState.currentWorkoutPlan && parsedState.currentState) {
                        if (confirm("Un entraînement était en cours. Voulez-vous le reprendre ?")) {
                            currentWorkoutType = parsedState.currentWorkoutType;
                            currentWorkoutPlan = parsedState.currentWorkoutPlan; 
                            currentItemIndex = parsedState.currentItemIndex;
                            timeLeft = parsedState.timeLeft;
                            prepareTimeLeft = parsedState.prepareTimeLeft;
                            workoutStartTime = parsedState.workoutStartTime;
                            previousState = parsedState.previousState || 'idle'; 

                            setActiveWorkoutNav(currentWorkoutType);
                            setState(parsedState.currentState); 
                            showMessage("Entraînement repris.", 2500);
                            return; 
                        }
                    }
                } catch (e) {
                    console.error("Erreur parsing état en cours:", e);
                }
            }
            clearInProgressState(); 
        }

        function clearInProgressState() {
            localStorage.removeItem(IN_PROGRESS_KEY);
        }
        
        function saveWorkoutToHistory() {
            if (!currentWorkoutType || !workoutStartTime || !originalCompletedWorkoutPlan || originalCompletedWorkoutPlan.length === 0) {
                console.warn("Tentative de sauvegarde d'un entraînement invalide ou vide.");
                return;
            }
            const endTime = Date.now();
            const durationSeconds = (endTime - workoutStartTime) / 1000;

            const exercisesForHistory = originalCompletedWorkoutPlan
                .filter(item => item.type === 'exercise' || item.type?.startsWith('exercise_'))
                .map(ex => ({
                    name: ex.name,
                    type: ex.type, 
                    reps: ex.reps_text || (ex.reps_start !== undefined ? ex.reps_start : ex.reps), 
                    current_reps: ex.current_reps, 
                    finalReps: ex.finalReps, 
                    weight_text: ex.weight_text,
                    weight_details: ex.weight_details,
                    weight: ex.weight,
                    weight_unit: ex.weight_unit,
                    reps_unit: ex.reps_unit,
                    ...(ex.type?.startsWith('exercise_myo_reps') && {
                        activation_reps_start: ex.activation_reps_start,
                        current_activation_reps: ex.current_activation_reps,
                        completed_mini_sets: ex.completed_mini_sets,
                        mini_reps_start: ex.mini_reps_start,
                    })
                }));

            const historyEntry = {
                date: new Date().toISOString(),
                type: currentWorkoutType,
                durationSeconds: durationSeconds,
                exercises: exercisesForHistory
            };
            workoutHistory.push(historyEntry);
        }


        // --- AJUSTEMENT DES RÉPÉTITIONS (OVERLAY) ---

        function showRepAdjustmentOverlay() {
            if (!repAdjustmentOverlay || !currentRepsDisplay || !repAdjustmentExerciseName) return;

            const item = currentWorkoutPlan[nextExerciseIndexForAdjustment];
            if (!item || !(item.type === 'exercise' || item.type?.startsWith('exercise_'))) {
                hideRepAdjustmentOverlay(); 
                return;
            }
            
            let repsToAdjust;
            let exerciseDisplayName = normalizeExerciseName(item.name);

            if (item.type === 'exercise_myo_reps' || item.type === 'exercise_myo_reps_unilateral' || item.type === 'exercise_myo_reps_unilateral_in_superset') {
                repsToAdjust = item.current_activation_reps !== undefined ? item.current_activation_reps : (item.activation_reps_start || 0);
                exerciseDisplayName += " (Activation)";
            } else if (item.reps_text?.toUpperCase() === "AMRAP" || item.reps_text?.toUpperCase().includes("NÉG")) {
                repsToAdjust = item.current_reps || 0; 
                exerciseDisplayName += ` (${item.reps_text})`;
            } else {
                repsToAdjust = item.current_reps !== undefined ? item.current_reps : (item.reps_start || item.reps || 0);
            }
            currentRepAdjustment = repsToAdjust;

            currentRepsDisplay.textContent = currentRepAdjustment;
            repAdjustmentExerciseName.textContent = exerciseDisplayName;
            repAdjustmentOverlay.classList.add('visible');
            isRepAdjustmentVisible = true;
            vibrate([50]);
        }

        function hideRepAdjustmentOverlay() {
            if (repAdjustmentOverlay) repAdjustmentOverlay.classList.remove('visible');
            isRepAdjustmentVisible = false;
            // Ne pas reset nextExerciseIndexForAdjustment ici, car on peut le réutiliser si l'utilisateur skippe l'overlay
        }

        function handleRepAdjustClick(event) {
            initAudioContext(); 
            const adjustment = event.target.id === 'rep-adjust-minus' ? -1 : 1;
            currentRepAdjustment = Math.max(0, currentRepAdjustment + adjustment); 
            if(currentRepsDisplay) currentRepsDisplay.textContent = currentRepAdjustment;
            vibrate([20]);

            const itemToUpdate = currentWorkoutPlan[nextExerciseIndexForAdjustment];
            if (itemToUpdate) {
                if (itemToUpdate.type === 'exercise_myo_reps' || itemToUpdate.type === 'exercise_myo_reps_unilateral' || itemToUpdate.type === 'exercise_myo_reps_unilateral_in_superset') {
                    itemToUpdate.current_activation_reps = currentRepAdjustment;
                } else {
                    itemToUpdate.current_reps = currentRepAdjustment;
                }
            }
        }
        
        function findNextExerciseForAdjustment() {
            nextExerciseIndexForAdjustment = -1; 
            let searchIndex = (currentState === 'break') ? currentItemIndex + 1 : currentItemIndex;

            if (searchIndex < currentWorkoutPlan.length) {
                const item = currentWorkoutPlan[searchIndex];
                if (item && (item.type === 'exercise' || item.type?.startsWith('exercise_'))) {
                    if (item.reps_start !== undefined || item.activation_reps_start !== undefined || item.reps_text?.toUpperCase() === "AMRAP" || item.reps_text?.toUpperCase().includes("NÉG") ) {
                        nextExerciseIndexForAdjustment = searchIndex;
                    }
                }
            }
        }
        
        // --- INITIALISATION ---
        function initializeDOMReferences() {
            try {
                timeDisplayDiv = document.getElementById('time-left');
                timerStateDisplay = document.getElementById('timer-state');
                currentExerciseContainer = document.getElementById('current-exercise-container');
                progressTracker = document.getElementById('progress-tracker');
                startPauseBtn = document.getElementById('start-pause-btn');
                skipBtn = document.getElementById('skip-btn');
                finishBtn = document.getElementById('finish-btn');
                resetBtn = document.getElementById('reset-btn');
                prevBtn = document.getElementById('prev-btn');
                messageArea = document.getElementById('message-area');
                workoutSection = document.getElementById('workout-section');
                historySection = document.getElementById('history-section');
                progressSection = document.getElementById('progress-section');
                historyList = document.getElementById('history-list');
                statsDisplay = document.getElementById('stats-display');
                statsContentWrapper = statsDisplay?.querySelector('.content-wrapper');
                historyFilterBtns = Array.from(document.querySelectorAll('.history-filters button'));
                historyChartCanvasEl = document.getElementById('history-chart-canvas');
                exerciseProgressChartCanvasEl = document.getElementById('exercise-progress-chart');
                signInButton = document.getElementById('signin-button');
                driveStatusElement = document.getElementById('drive-status');
                driveStatusTextElement = document.getElementById('drive-status-text');
                settingsIcon = document.getElementById('settings-icon');
                postWorkoutSummary = document.getElementById('post-workout-summary');
                summaryTitle = document.getElementById('summary-title');
                summaryItemsList = document.getElementById('summary-items-list');
                finishSummaryBtn = document.getElementById('finish-summary-btn');
                historyDriveStatus = document.getElementById('history-drive-status');
                currentExerciseNameDisplay = document.getElementById('current-exercise-name-display');
                driveConnectionStatusMain = document.getElementById('drive-connection-status-main');
                driveConnectionText = document.getElementById('drive-connection-text');
                timerDisplayElement = document.querySelector('.timer-display');
                reactorElement = document.querySelector('.reactor');
                exerciseImageContainer = document.getElementById('exercise-image-container');
                exerciseImageDisplay = document.getElementById('exercise-image-display');
                progressTextArea = document.getElementById('progress-text-area');
                historyActionsContainer = document.querySelector('.history-actions');
                exerciseSelect = document.getElementById('exercise-select');
                metricSelect = document.getElementById('metric-select');
                periodSelect = document.getElementById('period-select');
                exerciseChartPlaceholder = document.getElementById('exercise-progress-placeholder');
                repAdjustmentOverlay = document.getElementById('rep-adjustment-overlay');
                repAdjustMinusBtn = document.getElementById('rep-adjust-minus');
                repAdjustPlusBtn = document.getElementById('rep-adjust-plus');
                currentRepsDisplay = document.getElementById('current-reps-display');
                repAdjustmentExerciseName = document.getElementById('rep-adjustment-exercise-name');
                navHistoryBtn = document.getElementById('nav-history');
                navProgressBtn = document.getElementById('nav-progress');
                navButtons = [
                    document.getElementById('nav-push'),
                    document.getElementById('nav-pull'),
                    document.getElementById('nav-legs')
                ];
            } catch (e) {
                console.error("Erreur initialisation des références DOM:", e);
                // Afficher un message à l'utilisateur si l'initialisation critique échoue
                document.body.innerHTML = "<p style='color:white; text-align:center; padding-top: 50px;'>Une erreur critique est survenue lors du chargement de l'application. Veuillez rafraîchir la page ou contacter le support.</p>";
            }
        }
        
        function addEventListeners() {
            if (startPauseBtn) startPauseBtn.addEventListener('click', () => {
                initAudioContext();
                if (currentState === 'idle') setState('preparing');
                else if (currentState === 'exercise' || currentState.startsWith('exercise_')) handleItemCompletion(true); // true car clic sur "Fait"
                else if (currentState === 'break') setState('paused');
                else if (currentState === 'paused') {
                    // Déterminer si on reprend un exercice ou un repos
                    const currentPausedItem = currentWorkoutPlan[currentItemIndex];
                     setState((currentPausedItem?.type === 'exercise' || currentPausedItem?.type?.startsWith('exercise_')) ? 'exercise' : 'break');
                }
            });

            if (timerDisplayElement) timerDisplayElement.addEventListener('click', () => {
                initAudioContext();
                // Si un workout est actif et que ce n'est pas la préparation ou la fin, le clic agit comme "skip/fait"
                if (isWorkoutActive && currentState !== 'preparing' && currentState !== 'finished') {
                     handleItemCompletion(false); // false car c'est un skip/tap, pas un "Fait" naturel
                } else if (currentState === 'idle' && startPauseBtn && !startPauseBtn.disabled) {
                    // Si idle et le bouton démarrer est actif, le clic sur le timer démarre aussi
                    setState('preparing');
                }
            });
            
            if (skipBtn) skipBtn.addEventListener('click', () => {
                initAudioContext();
                if (isWorkoutActive) handleItemCompletion(false); // false car c'est un skip
            });
            if (prevBtn) prevBtn.addEventListener('click', () => {
                initAudioContext();
                handlePreviousClick();
            });
            if (finishBtn) finishBtn.addEventListener('click', () => {
                initAudioContext();
                forceFinishWorkout();
            });
            if (resetBtn) resetBtn.addEventListener('click', () => {
                initAudioContext();
                resetCurrentWorkout();
            });

            navButtons.forEach(btn => {
                if (btn) btn.addEventListener('click', () => {
                    initAudioContext();
                    loadWorkout(btn.dataset.workout);
                });
            });

            document.querySelectorAll('nav a.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    initAudioContext();
                    if (isWorkoutActive) { // Empêche la navigation si un entraînement est en cours
                        e.preventDefault(); 
                        showMessage("Terminez ou mettez en pause l'entraînement avant de naviguer.", 3000);
                    }
                });
            });

            if(navHistoryBtn) navHistoryBtn.addEventListener('click', () => { initAudioContext(); showSection('history-section'); });
            if(navProgressBtn) navProgressBtn.addEventListener('click', () => { initAudioContext(); showSection('progress-section'); });

            historyFilterBtns.forEach(btn => {
                if(btn) btn.addEventListener('click', () => { initAudioContext(); displayHistory(btn.dataset.period); });
            });

            if(exerciseSelect) exerciseSelect.addEventListener('change', displayExerciseProgress);
            if(periodSelect) periodSelect.addEventListener('change', displayExerciseProgress);

            if(settingsIcon) settingsIcon.addEventListener('click', () => { 
                initAudioContext(); 
                showMessage("Paramètres à venir !", 2000); 
            });
            if(signInButton) signInButton.addEventListener('click', handleAuthClick);
            
            if(finishSummaryBtn) finishSummaryBtn.addEventListener('click', finishSummary);
            if(postWorkoutSummary) postWorkoutSummary.addEventListener('click', (e) => { // Ferme si clic en dehors du contenu
                if (e.target === postWorkoutSummary) finishSummary(); // Ou `closeSummary()` si on ne veut pas sauvegarder
            });

            if(repAdjustMinusBtn) repAdjustMinusBtn.addEventListener('click', handleRepAdjustClick);
            if(repAdjustPlusBtn) repAdjustPlusBtn.addEventListener('click', handleRepAdjustClick);
            if(repAdjustmentOverlay) repAdjustmentOverlay.addEventListener('click', (e) => { // Ferme l'overlay si clic en dehors
                if (e.target === repAdjustmentOverlay) hideRepAdjustmentOverlay();
            });

            // Sauvegarde l'état si l'onglet devient inactif
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'hidden' && isWorkoutActive) {
                    saveInProgressState();
                }
            });
            // Sauvegarde l'état avant de quitter la page
            window.addEventListener('beforeunload', () => {
                if (isWorkoutActive) {
                    saveInProgressState();
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeDOMReferences();
            loadedWorkouts = JSON.parse(JSON.stringify(defaultWorkouts)); // Initialise avec les défauts
            initSounds();
            addEventListeners();
            loadSavedTheme(); // Charge le thème et met à jour l'année
            setState('idle'); // État initial
            updateAuthUI(!!googleAccessToken); // Met à jour l'UI en fonction de la connexion (initialement déconnecté)
            checkAndInitGis(); // Commence la vérification pour l'API Google

            setChartPlaceholder('history-chart-canvas', "Connectez-vous pour voir l'historique.");
            setChartPlaceholder('exercise-progress-chart', "Connectez-vous pour voir la progression.");
            console.log("ArmorWorkout Initialisé (Thème Électrique).");
        });

    </script>
</body>
</html>
```
