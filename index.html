<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArmorWorkout - Arc Reactor Core</title>
    <!-- Correction Favicon 404 -->
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* --- VARIABLES DYNAMIQUES DE LIGUE --- */
            --theme-color: #22D3EE; 
            --theme-color-rgb: 34, 211, 238;
            --reactor-speed: 10s;
            --league-glow: 0 0 15px rgba(34, 211, 238, 0.4);
            
            /* --- COULEURS DE BASE --- */
            --bg-color-dark: #030712; 
            --secondary-bg-color-dark: #0B132B; 
            --primary-text-color-dark: #F0F4F8; 
            --secondary-text-color-dark: #A0AEC0; 
            --border-color-dark: #1E293B; 
            
            /* --- STATUS --- */
            --neon-green: #39FF14; 
            --neon-red: #FF3131; 
            --neon-yellow: #FFF01F; 
            --neon-purple: #9400D3; 

            --font-family-main: 'Inter', sans-serif;
            --font-family-timer: 'Orbitron', sans-serif;
            --font-family-titles: 'Orbitron', sans-serif; 
            --border-radius-lg: 12px;
            --transition-speed: 0.3s;
        }

        /* --- ANIMATIONS --- */
        @keyframes rotate-reactor { from { transform: translate(-50%, -50%) rotate(0deg); } to { transform: translate(-50%, -50%) rotate(360deg); } }
        @keyframes rotate-reactor-reverse { from { transform: translate(-50%, -50%) rotate(360deg); } to { transform: translate(-50%, -50%) rotate(0deg); } }
        @keyframes pulse-glow { 0%, 100% { filter: drop-shadow(0 0 10px var(--theme-color)); } 50% { filter: drop-shadow(0 0 25px var(--theme-color)); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- GLOBAL --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: var(--font-family-main); background-color: var(--bg-color-dark); color: var(--primary-text-color-dark);
            min-height: 100vh; overflow-x: hidden;
            background-image: radial-gradient(circle at 50% 0%, rgba(var(--theme-color-rgb), 0.12) 0%, transparent 70%), linear-gradient(0deg, #030712 0%, #0b132b 100%);
        }
        body::before { 
            content: ""; position: fixed; inset: 0;
            background-image: linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 50px 50px; z-index: -1;
        }

        /* --- UI WORKOUT ACTIVE --- */
        body.workout-active header, body.workout-active footer { display: none; }
        body.workout-active main { position: fixed; inset: 0; z-index: 100; background: var(--bg-color-dark); display: flex; align-items: center; justify-content: center; }
        body.workout-active .app-section:not(#workout-section) { display: none; }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; width: 100%; flex-grow: 1; }

        /* --- HEADER --- */
        header {
            padding: 15px 0; background: rgba(11, 19, 43, 0.8); backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(var(--theme-color-rgb), 0.3); position: sticky; top: 0; z-index: 1000;
        }
        .header-content { display: flex; justify-content: space-between; align-items: center; padding: 0 20px; }
        header h1 { font-family: var(--font-family-titles); font-size: 1.4em; letter-spacing: 2px; text-shadow: 0 0 10px var(--theme-color); }
        header h1 span { color: var(--theme-color); }

        #signin-button { 
            background: transparent; border: 1px solid var(--theme-color); color: var(--theme-color);
            padding: 8px 18px; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s;
        }
        #signin-button:hover { background: rgba(var(--theme-color-rgb), 0.1); box-shadow: 0 0 15px var(--theme-color); }
        #drive-status { color: var(--neon-green); font-size: 0.9em; font-family: var(--font-family-titles); }

        /* --- HOME SECTION --- */
        .home-grid { display: grid; grid-template-columns: 1fr 360px; gap: 30px; margin-top: 20px; }
        @media (max-width: 950px) { .home-grid { grid-template-columns: 1fr; } }

        .session-card-large {
            background: rgba(30, 41, 59, 0.5); border: 1px solid var(--border-color-dark);
            padding: 30px; border-radius: var(--border-radius-lg); cursor: pointer; transition: 0.3s;
            position: relative; overflow: hidden; margin-bottom: 20px;
        }
        .session-card-large:hover { border-color: var(--theme-color); transform: translateY(-5px); background: rgba(255,255,255,0.05); }
        .session-card-large h3 { font-family: var(--font-family-titles); color: var(--theme-color); font-size: 1.5em; margin-bottom: 10px; }

        /* --- SIDEBAR --- */
        .sidebar-module {
            background: rgba(15, 23, 42, 0.7); border: 1px solid var(--border-color-dark);
            padding: 25px; border-radius: var(--border-radius-lg); margin-bottom: 25px;
        }
        .sidebar-module h3 { font-family: var(--font-family-titles); font-size: 1em; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        
        /* League Style */
        .league-badge { text-align: center; }
        .league-icon { font-size: 4em; color: var(--theme-color); margin-bottom: 10px; animation: pulse-glow 3s infinite ease-in-out; }
        .league-name { font-family: var(--font-family-titles); font-weight: 900; font-size: 1.3em; text-transform: uppercase; color: var(--theme-color); }

        /* Progress Bar */
        .weekly-bar-container { width: 100%; height: 10px; background: #0f172a; border-radius: 5px; overflow: hidden; margin: 10px 0; border: 1px solid var(--border-color-dark); }
        .weekly-bar-fill { height: 100%; background: var(--theme-color); box-shadow: 0 0 10px var(--theme-color); transition: 1s ease; }

        /* --- ARC REACTOR TIMER --- */
        #workout-section { width: 100%; max-width: 500px; text-align: center; }
        .timer-display { position: relative; width: 300px; height: 300px; margin: 0 auto 40px; }
        
        .reactor-outer {
            position: absolute; inset: 0; border-radius: 50%;
            border: 2px solid rgba(var(--theme-color-rgb), 0.1);
        }
        .reactor-core {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 210px; height: 210px; border-radius: 50%;
            background: radial-gradient(circle, #0f172a 30%, #000 100%);
            border: 6px solid #030712; box-shadow: var(--league-glow), inset var(--league-glow);
        }
        .triangle-shimmer {
            position: absolute; top: 50%; left: 50%; width: 180px; height: 180px;
            background: conic-gradient(from 0deg, transparent 0%, var(--theme-color) 10%, transparent 40%);
            border-radius: 50%; opacity: 0.4; animation: rotate-reactor var(--reactor-speed) linear infinite;
        }
        #time-left { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-family: var(--font-family-timer); font-size: 3.8em; font-weight: bold; color: #fff;
            text-shadow: 0 0 20px var(--theme-color);
        }

        /* --- EXERCISE DETAILS --- */
        .exercise-details {
            background: rgba(30, 41, 59, 0.6); border: 1px solid var(--border-color-dark);
            border-left: 5px solid var(--theme-color); padding: 20px 30px; border-radius: 10px;
            display: inline-block; margin-top: 20px;
        }
        .main-stats { display: flex; gap: 40px; font-family: var(--font-family-timer); font-size: 1.6em; font-weight: bold; }
        .main-stats i { color: var(--theme-color); font-size: 0.8em; margin-right: 10px; }

        /* --- CONTROLS --- */
        .controls { display: flex; justify-content: center; gap: 15px; margin-top: 40px; }
        .controls button {
            background: rgba(255,255,255,0.05); border: 1px solid var(--border-color-dark); color: #fff;
            padding: 15px 25px; border-radius: 10px; cursor: pointer; transition: 0.3s; font-family: var(--font-family-titles);
        }
        .controls button:hover:not(:disabled) { border-color: var(--theme-color); background: rgba(var(--theme-color-rgb), 0.1); }
        #start-pause-btn { background: var(--theme-color); color: #000; font-weight: 900; border: none; min-width: 160px; box-shadow: 0 0 20px rgba(var(--theme-color-rgb), 0.5); }

        /* --- SUMMARY MODAL --- */
        .post-workout-summary {
            position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000;
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(10px);
        }
        .post-workout-summary.visible { display: flex; }
        .summary-content {
            background: #0b132b; width: 95%; max-width: 650px; padding: 30px;
            border-radius: 20px; border: 1px solid var(--theme-color); box-shadow: 0 0 40px rgba(0,0,0,0.5);
        }
        .summary-item { 
            background: rgba(255,255,255,0.03); margin-bottom: 10px; padding: 15px; border-radius: 10px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .stepper { display: flex; align-items: center; gap: 12px; background: #030712; padding: 5px 15px; border-radius: 8px; border: 1px solid var(--border-color-dark); }
        .stepper button { background: none; border: none; color: var(--theme-color); font-size: 1.5em; cursor: pointer; }
        .stepper span { font-family: var(--font-family-timer); font-weight: bold; min-width: 40px; text-align: center; }

        .btn-finish { width: 100%; padding: 18px; background: var(--neon-green); color: #000; border: none; border-radius: 10px; font-weight: 900; font-family: var(--font-family-titles); cursor: pointer; margin-top: 20px; }

        /* --- NOTIFS --- */
        .message-area {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(var(--theme-color-rgb), 0.9); color: #000; padding: 12px 25px;
            border-radius: 8px; font-weight: bold; opacity: 0; transition: 0.4s; z-index: 9999;
        }
        .message-area.visible { opacity: 1; bottom: 45px; }

        footer { padding: 40px; text-align: center; color: var(--secondary-text-color-dark); font-size: 0.8em; border-top: 1px solid var(--border-color-dark); }
    </style>
</head>
<body class="logged-out state-idle">

    <header>
        <div class="header-content">
            <h1>ARMOR<span>WORKOUT</span></h1>
            <div class="header-actions">
                <button id="signin-button"><i class="fab fa-google"></i> SYNC DRIVE</button>
                <div id="drive-status" style="display:none"><i class="fas fa-satellite-dish"></i> CONNECT√â</div>
            </div>
        </div>
    </header>

    <div class="container">
        <main>
            <!-- ACCUEIL -->
            <div id="home-section" class="app-section">
                <div class="home-grid">
                    <div class="home-main-content" id="session-cards-container">
                        <!-- Les s√©ances appara√Ætront ici -->
                    </div>
                    <div class="home-sidebar">
                        <div class="sidebar-module">
                            <div class="league-badge" id="league-display">
                                <!-- Badge Ligue Dynamique -->
                            </div>
                        </div>
                        <div class="sidebar-module">
                            <h3>ASSIDUIT√â</h3>
                            <div class="consistency-info">
                                <p id="weekly-count" style="font-size:0.9em; margin-bottom:5px;">Objectif : 0 / 2 s√©ances</p>
                                <div class="weekly-bar-container">
                                    <div class="weekly-bar-fill" id="weekly-progress-bar" style="width: 0%"></div>
                                </div>
                                <p id="streak-text" style="font-size: 0.8em; opacity: 0.7; margin-top: 10px;">0 semaines cons√©cutives</p>
                            </div>
                        </div>
                        <div class="sidebar-module">
                            <h3>HISTORIQUE</h3>
                            <ul id="history-list" style="list-style:none; font-size: 0.85em; opacity:0.8;">
                                <!-- Historique r√©cent -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ENTRAINEMENT -->
            <div id="workout-section" class="app-section section-hidden">
                <div class="timer-display">
                    <div class="reactor-outer"></div>
                    <div class="reactor-core">
                        <div class="triangle-shimmer"></div>
                        <div id="time-left">00:00</div>
                    </div>
                </div>

                <div class="workout-info">
                    <h2 id="current-ex-name">-</h2>
                    <div id="current-ex-container"></div>
                </div>

                <div class="controls">
                    <button id="prev-btn"><i class="fas fa-chevron-left"></i></button>
                    <button id="start-pause-btn">D√âMARRER</button>
                    <button id="skip-btn"><i class="fas fa-chevron-right"></i></button>
                    <button id="quit-btn" style="color:var(--neon-red)"><i class="fas fa-power-off"></i></button>
                </div>
            </div>
        </main>
    </div>

    <!-- R√âSUM√â -->
    <div id="post-workout-summary" class="post-workout-summary">
        <div class="summary-content">
            <div style="text-align:center; margin-bottom:20px;">
                <h2 style="font-family:Orbitron; color:var(--theme-color)">RAPPORT DE MISSION</h2>
                <p style="font-size:0.9em; opacity:0.6">Ajustez vos perfs pour la prochaine fois.</p>
            </div>
            <div id="summary-items-list" style="max-height:350px; overflow-y:auto; margin-bottom:20px;"></div>
            <button id="save-summary-btn" class="btn-finish">SYNCHRONISER LES DONN√âES</button>
        </div>
    </div>

    <div id="message-area" class="message-area"></div>

    <footer>
        <p>&copy; 2026 ARMORWORKOUT | Protocol Arc Reactor v4.0</p>
    </footer>

    <script async defer src="https://accounts.google.com/gsi/client"></script>
    <script>
        "use strict";

        // =================================================================================
        // CONFIGURATION
        // =================================================================================
        const GOOGLE_CLIENT_ID = "731283926358-viam3ulpgna14flfdeb9m92l8s620hoi.apps.googleusercontent.com";
        const PROGRAM_FILE = "programme.json";
        const HISTORY_FILE = "armorworkout_history.json";
        const WEEKLY_GOAL = 2;

        const LEAGUES = [
            { name: "Ligue Bois", min: 0, color: "#A0522D", icon: "fa-tree", speed: "10s", glow: "0 0 10px #A0522D" },
            { name: "Ligue Pierre", min: 2, color: "#94a3b8", icon: "fa-mountain", speed: "8s", glow: "0 0 15px #94a3b8" },
            { name: "Ligue Bronze", min: 4, color: "#cd7f32", icon: "fa-award", speed: "6s", glow: "0 0 20px #cd7f32" },
            { name: "Ligue Argent", min: 6, color: "#cbd5e1", icon: "fa-shield-halved", speed: "5s", glow: "0 0 25px #cbd5e1" },
            { name: "Ligue Or", min: 8, color: "#fbbf24", icon: "fa-trophy", speed: "4s", glow: "0 0 30px #fbbf24" },
            { name: "Ligue Platine", min: 12, color: "#38bdf8", icon: "fa-gem", speed: "3s", glow: "0 0 35px #38bdf8" },
            { name: "Ligue √âmeraude", min: 16, color: "#10b981", icon: "fa-clover", speed: "2.5s", glow: "0 0 40px #10b981" },
            { name: "Ligue Rubis", min: 20, color: "#ef4444", icon: "fa-fire", speed: "2s", glow: "0 0 45px #ef4444" },
            { name: "Ligue Diamant", min: 26, color: "#00f2ff", icon: "fa-bolt-lightning", speed: "1.2s", glow: "0 0 50px #00f2ff" },
            { name: "Vibranium", min: 32, color: "#ffffff", icon: "fa-atom", speed: "0.6s", glow: "0 0 60px #fff" }
        ];

        let loadedProgram = null;
        let workoutHistory = [];
        let googleAccessToken = null;
        let tokenClient = null;
        let programFileId = null;
        let historyFileId = null;

        // √âtat session
        let currentPlan = [];
        let currentIdx = 0;
        let timer = null;
        let timeLeft = 0;
        let totalTime = 0;
        let isRunning = false;
        let currentSessionName = "";

        // =================================================================================
        // INIT & AUTH
        // =================================================================================
        document.addEventListener('DOMContentLoaded', () => {
            initGis();
            addEventListeners();
        });

        function initGis() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/drive.file',
                callback: async (resp) => {
                    if (resp.access_token) {
                        googleAccessToken = resp.access_token;
                        document.body.classList.replace('logged-out', 'logged-in');
                        document.getElementById('drive-status').style.display = 'block';
                        showMessage("ArmorOS Connect√©. Synchronisation...");
                        await syncDrive();
                    }
                }
            });
        }

        function handleAuth() { tokenClient.requestAccessToken(); }

        function addEventListeners() {
            document.getElementById('signin-button').onclick = handleAuth;
            document.getElementById('start-pause-btn').onclick = toggleTimer;
            document.getElementById('skip-btn').onclick = () => navigate(1);
            document.getElementById('prev-btn').onclick = () => navigate(-1);
            document.getElementById('quit-btn').onclick = quitWorkout;
            document.getElementById('save-summary-btn').onclick = finalizeWorkout;
        }

        // =================================================================================
        // DRIVE LOGIC (FIXED HTTP 400)
        // =================================================================================
        async function syncDrive() {
            try {
                programFileId = await findFile(PROGRAM_FILE);
                if (programFileId) {
                    const content = await downloadFile(programFileId);
                    loadedProgram = JSON.parse(content);
                } else {
                    showMessage("Alerte : programme.json manquant sur Drive", 6000);
                }

                historyFileId = await findFile(HISTORY_FILE);
                if (historyFileId) {
                    const content = await downloadFile(historyFileId);
                    workoutHistory = JSON.parse(content);
                } else {
                    historyFileId = await createFile(HISTORY_FILE, "[]");
                    workoutHistory = [];
                }
                renderHomeScreen();
            } catch (e) {
                console.error(e);
                showMessage("Erreur Sync Drive. V√©rifiez vos fichiers.", 5000);
            }
        }

        async function findFile(name) {
            // FIX : Utilisation d'espaces et encodeURIComponent pour √©viter l'erreur 400
            const query = `name = '${name}' and trashed = false`;
            const url = `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(query)}&fields=files(id,name)`;
            const res = await fetch(url, { headers: { Authorization: `Bearer ${googleAccessToken}` } });
            const data = await res.json();
            return data.files && data.files.length > 0 ? data.files[0].id : null;
        }

        async function downloadFile(id) {
            const res = await fetch(`https://www.googleapis.com/drive/v3/files/${id}?alt=media`, { headers: { Authorization: `Bearer ${googleAccessToken}` } });
            return await res.text();
        }

        async function createFile(name, content) {
            const metadata = { name, mimeType: 'application/json' };
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', new Blob([content], { type: 'application/json' }));
            const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST', headers: { Authorization: `Bearer ${googleAccessToken}` }, body: form
            });
            const data = await res.json();
            return data.id;
        }

        async function updateDriveFile(id, content) {
            await fetch(`https://www.googleapis.com/upload/drive/v3/files/${id}?uploadType=media`, {
                method: 'PATCH', headers: { Authorization: `Bearer ${googleAccessToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(content)
            });
        }

        // =================================================================================
        // LIGUES ENGINE
        // =================================================================================
        function calculateLeague() {
            if (workoutHistory.length === 0) return LEAGUES[0];

            const weeksMap = {};
            workoutHistory.forEach(h => {
                const d = new Date(h.date);
                const weekKey = getISOWeek(d);
                weeksMap[weekKey] = (weeksMap[weekKey] || 0) + 1;
            });

            let streak = 0;
            const now = new Date();
            let checkDate = new Date(now);

            while (true) {
                const key = getISOWeek(checkDate);
                if (weeksMap[key] >= WEEKLY_GOAL) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 7);
                } else {
                    // Si on n'a pas encore fini les 2 de cette semaine, on autorise le streak si la semaine pass√©e √©tait OK
                    if (getISOWeek(now) === key && streak === 0) {
                        checkDate.setDate(checkDate.getDate() - 7);
                        continue;
                    }
                    break;
                }
            }

            let league = LEAGUES[0];
            for (let l of LEAGUES) { if (streak >= l.min) league = l; }

            // Update UI
            const root = document.documentElement;
            root.style.setProperty('--theme-color', league.color);
            root.style.setProperty('--theme-color-rgb', hexToRgb(league.color));
            root.style.setProperty('--reactor-speed', league.speed);
            root.style.setProperty('--league-glow', league.glow);

            document.getElementById('league-display').innerHTML = `
                <i class="fas ${league.icon} league-icon"></i>
                <div class="league-name">${league.name}</div>
                <p style="font-size:0.8em; opacity:0.6; margin-top:5px;">S√©rie : ${streak} semaines</p>
            `;

            const thisWeekCount = weeksMap[getISOWeek(now)] || 0;
            document.getElementById('weekly-count').textContent = `Objectif : ${thisWeekCount} / ${WEEKLY_GOAL}`;
            document.getElementById('weekly-progress-bar').style.width = Math.min((thisWeekCount / WEEKLY_GOAL) * 100, 100) + "%";
            document.getElementById('streak-text').textContent = `${streak} semaines d'assiduit√©`;
            
            return league;
        }

        function getISOWeek(d) {
            const date = new Date(d.getTime());
            date.setHours(0, 0, 0, 0);
            date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
            const week1 = new Date(date.getFullYear(), 0, 4);
            return date.getFullYear() + "-" + (1 + Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7));
        }

        function hexToRgb(hex) {
            const r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
            return `${r}, ${g}, ${b}`;
        }

        // =================================================================================
        // WORKOUT ENGINE
        // =================================================================================
        function renderHomeScreen() {
            calculateLeague();
            const container = document.getElementById('session-cards-container');
            container.innerHTML = '<h2 style="font-family:Orbitron; margin-bottom:20px;">MISSIONS DISPONIBLES</h2>';

            if (!loadedProgram || !loadedProgram.sessions) {
                container.innerHTML += `<div class="session-card-large">Chargez un fichier programme.json pour commencer.</div>`;
                return;
            }

            loadedProgram.sessions.forEach(session => {
                const card = document.createElement('div');
                card.className = 'session-card-large';
                const count = session.exercices_et_pauses.filter(e => e.type === 'exercise').length;
                card.innerHTML = `
                    <h3>${session.nom_session}</h3>
                    <p>${session.description_session || ''}</p>
                    <div style="margin-top:15px; font-weight:bold; color:var(--theme-color)">
                        <i class="fas fa-dumbbell"></i> ${count} Exercices
                    </div>
                `;
                card.onclick = () => startWorkout(session);
                container.appendChild(card);
            });

            // Mini historique
            const hList = document.getElementById('history-list');
            hList.innerHTML = '';
            workoutHistory.slice(-4).reverse().forEach(h => {
                const li = document.createElement('li');
                li.style.marginBottom = "5px";
                li.innerHTML = `‚Ä¢ ${new Date(h.date).toLocaleDateString()} : ${h.type}`;
                hList.appendChild(li);
            });
        }

        function startWorkout(session) {
            currentSessionName = session.nom_session;
            currentPlan = JSON.parse(JSON.stringify(session.exercices_et_pauses));
            currentIdx = 0;
            document.getElementById('home-section').classList.add('section-hidden');
            document.getElementById('workout-section').classList.remove('section-hidden');
            document.body.classList.add('workout-active');
            loadStep();
        }

        function loadStep() {
            const step = currentPlan[currentIdx];
            document.getElementById('current-ex-name').textContent = step.name || "Repos";
            
            const cont = document.getElementById('current-ex-container');
            if (step.type === 'exercise') {
                cont.innerHTML = `
                    <div class="exercise-details">
                        <div class="main-stats">
                            <span><i class="fas fa-repeat"></i> ${step.reps || '-'}</span>
                            <span><i class="fas fa-weight-hanging"></i> ${cleanWeight(step.weight_text)}</span>
                        </div>
                        <p style="margin-top:10px; opacity:0.6; font-size:0.85em;">${step.details || ''}</p>
                    </div>
                `;
                totalTime = step.duration || 0;
            } else {
                cont.innerHTML = `<div class="exercise-details" style="border-color:var(--theme-color)">R√âCUP√âRATION...</div>`;
                totalTime = step.duration || 60;
            }

            timeLeft = totalTime;
            isRunning = false;
            document.getElementById('start-pause-btn').textContent = totalTime > 0 ? "D√âMARRER" : "VALIDER";
            updateTimerUI();
        }

        function toggleTimer() {
            if (totalTime === 0) { navigate(1); return; }
            if (isRunning) {
                clearInterval(timer);
                isRunning = false;
                document.getElementById('start-pause-btn').textContent = "REPRENDRE";
            } else {
                isRunning = true;
                document.getElementById('start-pause-btn').textContent = "PAUSE";
                timer = setInterval(() => {
                    timeLeft--;
                    updateTimerUI();
                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        navigate(1);
                    }
                }, 1000);
            }
        }

        function updateTimerUI() {
            const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
            const s = (timeLeft % 60).toString().padStart(2, '0');
            document.getElementById('time-left').textContent = `${m}:${s}`;
            
            const offset = 283 * (1 - timeLeft / totalTime);
            document.getElementById('timer-progress-indicator').style.strokeDashoffset = totalTime > 0 ? offset : 0;
        }

        function navigate(dir) {
            clearInterval(timer);
            currentIdx += dir;
            if (currentIdx >= currentPlan.length) finishWorkout();
            else if (currentIdx < 0) { currentIdx = 0; loadStep(); }
            else loadStep();
        }

        function finishWorkout() {
            const list = document.getElementById('summary-items-list');
            list.innerHTML = '';
            currentPlan.forEach((step, i) => {
                if (step.type === 'exercise') {
                    const weightVal = parseFloat(step.weight_text.replace(/[^0-9.]/g, '')) || 0;
                    const emoji = step.weight_text.match(/üéí|üü™|üü¶|üßò|üèãÔ∏è/) || "üèãÔ∏è";

                    const item = document.createElement('div');
                    item.className = 'summary-item';
                    item.innerHTML = `
                        <div style="font-weight:bold">${step.name}</div>
                        <div style="display:flex; gap:10px;">
                            <div class="stepper">
                                <button onclick="changeSum(${i}, 'reps', -1)">-</button>
                                <span id="sum-reps-${i}">${step.reps || 0}</span>
                                <button onclick="changeSum(${i}, 'reps', 1)">+</button>
                            </div>
                            <div class="stepper">
                                <button onclick="changeSum(${i}, 'weight', -0.5)">-</button>
                                <span id="sum-weight-${i}">${weightVal}</span>
                                <button onclick="changeSum(${i}, 'weight', 0.5)">+</button>
                                <span style="margin-left:5px">${emoji}</span>
                            </div>
                        </div>
                    `;
                    list.appendChild(item);
                }
            });
            document.getElementById('post-workout-summary').classList.add('visible');
        }

        window.changeSum = (idx, type, delta) => {
            const el = document.getElementById(`sum-${type}-${idx}`);
            let val = parseFloat(el.textContent) + delta;
            if (val < 0) val = 0;
            el.textContent = Number.isInteger(val) ? val : val.toFixed(1);
        };

        async function finalizeWorkout() {
            const btn = document.getElementById('save-summary-btn');
            btn.disabled = true; btn.textContent = "SAUVEGARDE DRIVE...";

            const sessionIdx = loadedProgram.sessions.findIndex(s => s.nom_session === currentSessionName);
            
            // 1. Update source programme
            currentPlan.forEach((step, i) => {
                if (step.type === 'exercise') {
                    const reps = parseInt(document.getElementById(`sum-reps-${i}`).textContent);
                    const weight = document.getElementById(`sum-weight-${i}`).textContent;
                    const emoji = step.weight_text.match(/üéí|üü™|üü¶|üßò|üèãÔ∏è/) || "üèãÔ∏è";
                    
                    const sourceEx = loadedProgram.sessions[sessionIdx].exercices_et_pauses.find(e => e.name === step.name);
                    if (sourceEx) {
                        sourceEx.reps = reps;
                        sourceEx.weight_text = `${emoji} ${weight} kg`;
                    }
                }
            });

            // 2. Historique
            workoutHistory.push({ date: new Date().toISOString(), type: currentSessionName });

            // 3. Drive Sync
            if (googleAccessToken) {
                await updateDriveFile(programFileId, loadedProgram);
                await updateDriveFile(historyFileId, workoutHistory);
            }

            document.getElementById('post-workout-summary').classList.remove('visible');
            quitWorkout();
        }

        function quitWorkout() {
            clearInterval(timer);
            document.body.classList.remove('workout-active');
            document.getElementById('workout-section').classList.add('section-hidden');
            document.getElementById('home-section').classList.remove('section-hidden');
            renderHomeScreen();
        }

        // =================================================================================
        // UTILS
        // =================================================================================
        function cleanWeight(txt) { return txt ? txt.replace('√âlastique', '').replace('Sac', '').trim() : "PDC"; }
        function showMessage(txt, dur = 3000) {
            const el = document.getElementById('message-area');
            el.textContent = txt; el.classList.add('visible');
            setTimeout(() => el.classList.remove('visible'), dur);
        }
    </script>
</body>
</html>
  
