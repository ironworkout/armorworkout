<!DOCTYPE html> 
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArmorWorkout - Intelligence Athl√©tique</title>
    <!-- Correction Favicon 404 -->
    <link rel="icon" href="data:;base64,iVBORw0KGgo=">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            /* --- COULEURS DYNAMIQUES DE LIGUE --- */
            /* Ces variables sont mises √† jour par le JS selon l'assiduit√© */
            --theme-color: #22D3EE; 
            --theme-rgb: 34, 211, 238;
            --reactor-speed: 10s; 
            
            /* --- BASE --- */
            --bg-color-dark: #030712; 
            --secondary-bg-color-dark: #0B132B; 
            --primary-text-color-dark: #F0F4F8; 
            --secondary-text-color-dark: #A0AEC0; 
            --border-color-dark: #1E293B; 
            
            /* --- ACCENTS STATIQUES --- */
            --electric-blue: #00BFFF; 
            --neon-green: #39FF14; 
            --neon-red: #FF3131; 
            --neon-yellow: #FFF01F; 
            --neon-purple: #9400D3; 
            --neon-green-rgb: 57, 255, 20;
            --neon-red-rgb: 255, 49, 49;

            /* --- MAPPING POUR ANCIEN CODE (COMPATIBILIT√â) --- */
            --electric-cyan: var(--theme-color);
            --electric-cyan-rgb: var(--theme-rgb);
            
            /* --- STATUS --- */
            --exercise-color-val: var(--theme-color);
            --break-color-val: #38bdf8;
            --paused-color-val: #A78BFA;
            --finished-color-val: var(--neon-green);
            --preparing-color-val: var(--theme-color);

            /* --- FONTS & UI --- */
            --font-family-main: 'Inter', sans-serif;
            --font-family-timer: 'Orbitron', sans-serif;
            --font-family-titles: 'Orbitron', sans-serif; 
            --border-radius-lg: 10px;
            --border-radius-md: 8px;
            --border-radius-sm: 6px;
            --transition-speed: 0.3s;
        }

        /* --- ANIMATIONS COMPLEXES (RETROUV√âES) --- */
        @keyframes subtlePulse { 0%, 100% { opacity: 0.7; transform: scale(1); } 50% { opacity: 1; transform: scale(1.015); } }
        @keyframes electricBorder {
            0% { box-shadow: 0 0 6px rgba(var(--theme-rgb), 0.6), inset 0 0 4px rgba(var(--theme-rgb), 0.4); border-color: rgba(var(--theme-rgb), 0.7); }
            50% { box-shadow: 0 0 18px rgba(var(--theme-rgb), 0.8), inset 0 0 10px rgba(var(--theme-rgb), 0.6); border-color: rgba(var(--theme-rgb), 0.9); }
            100% { box-shadow: 0 0 6px rgba(var(--theme-rgb), 0.6), inset 0 0 4px rgba(var(--theme-rgb), 0.4); border-color: rgba(var(--theme-rgb), 0.7); }
        }
        @keyframes textGlowPulseState {
            0%, 100% { text-shadow: 0 0 5px rgba(var(--theme-rgb), 0.7), 0 0 10px rgba(var(--theme-rgb), 0.5); }
            50% { text-shadow: 0 0 8px rgba(var(--theme-rgb), 0.9), 0 0 15px rgba(var(--theme-rgb), 0.7), 0 0 25px rgba(var(--theme-rgb), 0.5); }
        }
        @keyframes completed-pulse {
            0% { transform: scale(1); box-shadow: 0 0 10px 10px rgba(var(--neon-green-rgb), 0.2); }
            50% { transform: scale(1.05); box-shadow: 0 0 25px 25px rgba(var(--neon-green-rgb), 0.4); }
            100% { transform: scale(1); box-shadow: 0 0 10px 10px rgba(var(--neon-green-rgb), 0.2); }
        }
        @keyframes rotate-right { to { transform: rotate(360deg); } } 
        @keyframes rotate-left { to { transform: rotate(-360deg); } }
        @keyframes rotate-left-right { 0% { transform: translate(-50%, -50%) rotate(0deg); } 50% { transform: translate(-50%, -50%) rotate(-180deg); } 100% { transform: translate(-50%, -50%) rotate(0deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- GLOBAL LAYOUT --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; font-size: 16px; }
        body {
            font-family: var(--font-family-main); background-color: var(--bg-color-dark); color: var(--primary-text-color-dark); 
            line-height: 1.65; display: flex; flex-direction: column; min-height: 100vh; overflow-x: hidden;
            background-image: radial-gradient(ellipse at center, rgba(var(--theme-rgb), 0.08) 0%, transparent 60%), linear-gradient(0deg, rgba(3,7,18, 0.5) 0%, rgba(3,7,18, 0.9) 100%);
            transition: background-image 1s ease;
        }
        body::before { 
            content: ""; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-image: linear-gradient(rgba(var(--theme-rgb), 0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(var(--theme-rgb), 0.05) 1px, transparent 1px);
            background-size: 30px 30px; z-index: -1; opacity: 0.7; pointer-events: none;
        }
        
        /* Transition Workout Mode */
        body.workout-active { overflow: hidden; }
        body.workout-active header { transform: translateY(-100%); opacity: 0; visibility: hidden; transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out; }
        body.workout-active footer { display: none; }
        body.workout-active main { position: fixed; inset: 0; padding: 20px 0; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow-y: auto; z-index: 100; background: var(--bg-color-dark); }
        body.workout-active .app-section:not(#workout-section) { display: none; }
        body.workout-active #workout-section { margin: auto 0; border: none; background: transparent; box-shadow: none; padding: 0; max-height: 100%; }

        .container { max-width: 1200px; margin: 0 auto; padding: 30px 25px; width: 100%; flex-grow: 1; display: flex; flex-direction: column; }
        
        /* --- HEADER --- */
        header {
            padding: 15px 0; background-color: rgba(11, 19, 43, 0.5); backdrop-filter: blur(8px) saturate(150%);
            border-bottom: 1px solid rgba(var(--theme-rgb), 0.3); box-shadow: 0 2px 15px rgba(var(--theme-rgb), 0.1);
            position: sticky; top:0; z-index: 1000; 
        }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; padding: 0 25px; flex-wrap: wrap; gap: 15px 20px; }
        header h1 { font-size: 1.6em; color: var(--primary-text-color-dark); margin: 0; font-weight: 700; display: flex; align-items: center; gap: 10px; font-family: var(--font-family-titles); text-shadow: 0 0 8px rgba(var(--theme-rgb), 0.7); }
        header h1 i { color: var(--theme-color); animation: subtlePulse 3s infinite ease-in-out; }
        
        .header-actions { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        #drive-status-text, #signin-button {
            background-color: transparent; border: 1px solid var(--border-color-dark); color: var(--secondary-text-color-dark);
            padding: 5px 12px; border-radius: var(--border-radius-md); font-size: 0.9em; font-weight: 500; cursor: pointer;
            transition: all var(--transition-speed) ease; display: inline-flex; align-items: center; gap: 5px;
        }
        #signin-button:disabled { opacity: 0.5; cursor: not-allowed; }
        #drive-status-text:hover, #signin-button:not(:disabled):hover { border-color: var(--theme-color); color: var(--theme-color); background-color: rgba(var(--theme-rgb), 0.1); }
        #drive-status.success #drive-status-text { border-color: var(--neon-green); color: var(--neon-green); cursor: default; }
        #drive-status { display: inline-flex; align-items: center; gap: 10px; margin-left: 10px; padding: 0; background: none; border: none; font-size: 1em; color: inherit; }
        body.logged-out #signin-button { display: inline-flex; } body.logged-out #drive-status { display: none; }
        body.logged-in #signin-button { display: none; } body.logged-in #drive-status { display: inline-flex; }
        
        /* --- MAIN SECTIONS --- */
        main { flex-grow: 1; display: flex; flex-direction: column; align-items: center; padding-top: 40px; position: relative; transition: all 0.3s ease-in-out; }
        
        .app-section {
            background-color: rgba(11, 19, 43, 0.6); backdrop-filter: blur(10px) saturate(130%);
            border: 1px solid rgba(var(--theme-rgb), 0.2); width: 100%; 
            transition: opacity 0.4s ease-in-out, transform 0.3s ease-in-out;
            opacity: 1; border-radius: var(--border-radius-lg);
            box-shadow: 0 5px 25px rgba(3, 7, 18, 0.5), inset 0 0 15px rgba(var(--theme-rgb), 0.1);
        }
        #home-section { padding: 0; background: transparent; border: none; box-shadow: none; backdrop-filter: none; }
        
        .home-grid { display: flex; flex-wrap: wrap; gap: 30px; width: 100%; }
        .home-main-content { flex: 1 1 60%; min-width: 300px; display: flex; flex-direction: column; gap: 25px; }
        .home-sidebar { flex: 1 1 35%; min-width: 280px; display: flex; flex-direction: column; gap: 25px; }

        .sidebar-module {
            background-color: rgba(11, 19, 43, 0.6); backdrop-filter: blur(10px) saturate(130%);
            padding: 20px; border: 1px solid rgba(var(--theme-rgb), 0.2);
            border-radius: var(--border-radius-lg);
            box-shadow: 0 5px 25px rgba(3, 7, 18, 0.5), inset 0 0 15px rgba(var(--theme-rgb), 0.1);
            animation: fadeIn 0.5s ease-out forwards;
        }
        .sidebar-module h3 { font-family: var(--font-family-titles); color: var(--primary-text-color-dark); font-size: 1.1em; margin-bottom: 15px; border-bottom: 1px solid var(--border-color-dark); padding-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .sidebar-module h3 i { color: var(--theme-color); }
        
        /* --- CALENDAR & CONSISTENCY --- */
        .consistency-info { display: flex; flex-direction: column; gap: 12px; width: 100%; margin-bottom: 15px;}
        .weekly-goal-progress-bar { width: 100%; height: 8px; background-color: var(--border-color-dark); border-radius: 4px; overflow: hidden; }
        .weekly-goal-progress { height: 100%; width: 0%; background: var(--theme-color); box-shadow: 0 0 10px var(--theme-color); transition: width 0.5s ease; }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; margin-top: 15px; }
        .calendar-day { position: relative; font-size: 0.9em; padding: 5px 0; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; margin: 0 auto; transition: 0.2s; }
        .calendar-day.today { font-weight: 700; color: var(--theme-color); border: 1px solid var(--theme-color); box-shadow: 0 0 8px rgba(var(--theme-rgb), 0.5); background-color: rgba(var(--theme-rgb), 0.15); }
        .day-dot { position: absolute; bottom: 3px; left: 50%; transform: translateX(-50%); width: 6px; height: 6px; background-color: var(--theme-color); border-radius: 50%; box-shadow: 0 0 6px var(--theme-color); }

        /* --- SESSION CARDS --- */
        .session-card-large {
            background-color: rgba(11, 19, 43, 0.7); border: 1px solid var(--border-color-dark);
            border-radius: var(--border-radius-lg); transition: all 0.3s ease; 
            animation: fadeIn 0.5s ease-out forwards;
            position: relative; cursor: pointer; padding: 25px;
        }
        .session-card-large:hover { border-color: var(--theme-color); transform: translateY(-3px); box-shadow: 0 8px 25px rgba(var(--theme-rgb), 0.15); }
        .session-card-header h3 { font-family: var(--font-family-titles); color: var(--theme-color); font-size: 1.4em; margin: 0; text-shadow: 0 0 8px rgba(var(--theme-rgb), 0.5); }
        .session-card-large p { font-size: 0.95em; color: var(--secondary-text-color-dark); margin: 10px 0; }
        .global-performance-chart-container { min-height: 200px; position: relative; margin-top: 15px; }

        /* --- ARC REACTOR (THE COMPLEX CORE) --- */
        .workout-section { text-align: center; }
        .section-hidden { opacity: 0; visibility: hidden; display: none; }
        
        .timer-and-image-wrapper { display: flex; flex-direction: column; align-items: center; gap: 20px; margin-bottom: 25px; }
        .timer-display { position: relative; display: flex; justify-content: center; align-items: center; width: 300px; height: 300px; margin: 0 auto; cursor: pointer; user-select: none; }
        
        /* 8-Circle Layered Reactor */
        .reactor { position: relative; width: 180px; height: 180px; display: flex; align-items: center; justify-content: center; border-radius: 50%; overflow: hidden; z-index: 10; background-color: transparent; }
        .reactor::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(3, 7, 18, 0.3); z-index: 1; border-radius: 50%; }
        
        .triangle { z-index: 5; position: absolute; top: 66%; left: 50%; transform: translate(-50%, -50%); width: 155px; aspect-ratio: 1; background-color: var(--theme-color); -webkit-clip-path: polygon(50% 88%, 0 0, 100% 0); clip-path: polygon(50% 88%, 0 0, 100% 0); transition: 0.5s; opacity: 0.8; }
        
        .circle-1 { z-index: 2; position: absolute; width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(rgba(var(--theme-rgb), 0.8), rgba(var(--electric-blue-rgb), 0.8)); animation: rotate-right var(--reactor-speed) linear infinite; }
        .circle-2 { z-index: 4; position: absolute; top: 30px; left: 30px; width: calc(100% - 60px); height: calc(100% - 60px); border-radius: 50%; border: 10px solid var(--theme-color); box-shadow: 0 0 30px 30px rgba(var(--theme-rgb), 0.2); animation: rotate-left 4s linear infinite; }
        .circle-3 { z-index: 7; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: 50%; box-shadow: 0 0 10px 10px rgba(var(--theme-rgb), 0.2); }
        .circle-3::after { content: ''; display: block; width: 115px; height: 115px; border-radius: 50%; border: 3px dotted rgba(var(--theme-rgb), 0.8); animation: rotate-right 10s linear infinite; }
        .circle-4 { z-index: 8; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100px; height: 100px; border-radius: 50%; box-shadow: 0 0 10px 10px rgba(var(--theme-rgb), 0.1); animation: rotate-left-right 20s infinite ease-in; }
        .circle-5 { z-index: 9; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 64px; height: 64px; border-radius: 50%; animation: rotate-left-right 10s infinite ease-in; background-color: rgba(var(--theme-rgb), 0.2); box-shadow: 0 0 20px 20px rgba(var(--theme-rgb), 0.2); }
        
        #time-left { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 20; font-family: var(--font-family-timer); font-size: 3.6em; font-weight: 700; color: #FFFFFF; text-shadow: 0 0 15px rgba(var(--theme-rgb), 0.8); pointer-events: none; white-space: nowrap; }

        .timer-progress-circle-container { position: absolute; top: 50%; left: 50%; width: 250px; height: 250px; transform: translate(-50%, -50%); pointer-events: none; }
        .timer-progress-circle { fill: none; stroke: var(--theme-color); stroke-width: 6; stroke-linecap: round; transform-origin: center; transform: rotate(-90deg); transition: stroke-dashoffset 0.3s linear, stroke 0.3s ease; }
        .timer-progress-circle-bg { fill: none; stroke: rgba(var(--theme-rgb), 0.15); stroke-width: 6; }

        /* --- WORKOUT UI --- */
        .workout-info { margin-bottom: 20px; text-align: center; display: flex; flex-direction: column; align-items: center; gap: 8px; }
        #current-exercise-name-display { display: block; font-size: 1.5em; font-weight: 600; color: var(--theme-color); margin-bottom: 8px; text-shadow: 0 0 10px rgba(var(--theme-rgb), 0.3); }
        body.state-exercise #current-exercise-name-display { animation: textGlowPulseState 2s infinite ease-in-out; }
        
        .exercise-details, .break-info { display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 8px; background-color: rgba(11, 19, 43, 0.6); padding: 15px 20px; border-radius: var(--border-radius-sm); border: 1px solid rgba(var(--theme-rgb), 0.3); width: fit-content; max-width: 95%; box-shadow: 0 2px 5px rgba(3, 7, 18, 0.2); }
        .exercise-details .main-stats { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px 20px; font-size: 1.2em; font-weight: 500; color: var(--primary-text-color-dark); }
        .exercise-details .main-stats i { color: var(--theme-color); opacity: 0.9; }
        
        .controls { display: flex; justify-content: center; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .controls button { background-color: rgba(11, 19, 43, 0.6); border: 1px solid var(--border-color-dark); color: var(--secondary-text-color-dark); padding: 10px 20px; border-radius: var(--border-radius-md); font-size: 0.9em; font-weight: 500; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 6px; min-width: 100px; }
        .controls button:not(:disabled):hover { border-color: var(--theme-color); color: var(--theme-color); background-color: rgba(var(--theme-rgb), 0.1); transform: translateY(-2px); }
        #start-pause-btn { min-width: 140px; border-color: var(--theme-color); color: #fff; background-color: rgba(var(--theme-rgb), 0.2); font-weight: bold; }
        
        /* --- SUMMARY & MODALS --- */
        .post-workout-summary { position: fixed; inset: 0; background-color: rgba(3, 7, 18, 0.95); backdrop-filter: blur(8px); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; opacity: 0; visibility: hidden; pointer-events: none; transition: 0.3s; }
        .post-workout-summary.visible { opacity: 1; visibility: visible; pointer-events: auto; }
        .post-workout-summary-content { background-color: var(--secondary-bg-color-dark); border: 1px solid var(--theme-color); border-radius: var(--border-radius-lg); box-shadow: 0 0 30px rgba(var(--theme-rgb), 0.2); width: 100%; max-width: 680px; max-height: 90vh; display: flex; flex-direction: column; overflow: hidden; transform: scale(0.95); transition: 0.3s; }
        .post-workout-summary.visible .post-workout-summary-content { transform: scale(1); }
        .post-workout-summary h2 { color: var(--theme-color); font-size: 1.5em; font-weight: 700; padding: 20px 25px; border-bottom: 1px solid var(--border-color-dark); text-align: center; background: rgba(0,0,0,0.2); text-shadow: 0 0 10px rgba(var(--theme-rgb), 0.5); }
        .summary-items-list { list-style: none; padding: 15px 25px; overflow-y: auto; flex-grow: 1; background: var(--bg-color-dark); }
        
        .summary-item { background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; margin-bottom: 12px; border-left: 3px solid var(--theme-color); }
        .summary-item .exercise-name { font-weight: 500; font-size: 1.1em; margin-bottom: 10px; }
        .summary-item .fields-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stepper-control { display: flex; align-items: center; background: #030712; border: 1px solid var(--border-color-dark); border-radius: 6px; }
        .stepper-btn { background: transparent; border: none; color: var(--theme-color); font-size: 1.2em; padding: 5px 10px; cursor: pointer; }
        .stepper-value { flex-grow: 1; text-align: center; font-weight: bold; color: #fff; }
        
        .summary-controls { padding: 20px; border-top: 1px solid var(--border-color-dark); display: flex; justify-content: center; }
        #finish-summary-btn { background: var(--neon-green); color: #000; border: none; padding: 12px 30px; border-radius: 8px; font-weight: bold; cursor: pointer; font-family: var(--font-family-titles); font-size: 1.1em; transition: 0.2s; }
        #finish-summary-btn:hover { box-shadow: 0 0 20px var(--neon-green); transform: scale(1.05); }

        .message-area { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #1e293b; border: 1px solid var(--theme-color); color: #fff; padding: 12px 25px; border-radius: 8px; z-index: 3000; opacity: 0; transition: 0.3s; pointer-events: none; }
        .message-area.visible { opacity: 1; bottom: 40px; }

        footer { padding: 25px; text-align: center; font-size: 0.9em; color: var(--secondary-text-color-dark); border-top: 1px solid rgba(var(--theme-rgb), 0.2); margin-top: 50px; background: rgba(11, 19, 43, 0.8); }
        
        @media (max-width: 900px) { .home-grid { flex-direction: column; } }
        @media (max-width: 480px) { .timer-display { width: 250px; height: 250px; } .reactor { width: 150px; height: 150px; } }
    </style>
</head>
<body class="logged-out dark-theme state-idle">
    <header>
        <div class="header-content">
            <h1><i class="fas fa-shield-alt"></i> ARMORWORKOUT</h1>
            <nav>
                <ul><li><button id="edit-program-btn" disabled><i class="fas fa-edit"></i> √âDITION</button></li></ul>
            </nav>
            <div class="header-actions">
                <div id="drive-status" style="display: none;"> <span id="drive-status-text">CONNECT√â</span> </div>
                <button id="signin-button"><i class="fab fa-google"></i> DRIVE</button>
            </div>
        </div>
    </header>

    <div class="container">
        <main>
            <!-- ACCUEIL -->
            <div id="home-section" class="app-section">
                <div class="home-grid">
                    <div class="home-main-content" id="session-cards-container">
                        <!-- JS Generated Cards -->
                    </div>
                    <div class="home-sidebar">
                        <div class="sidebar-module" style="text-align:center;">
                            <div class="league-badge" id="league-display">
                                <!-- JS Generated League -->
                            </div>
                        </div>
                        <div class="sidebar-module">
                            <h3><i class="fas fa-calendar-check"></i> ASSIDUIT√â</h3>
                            <div class="consistency-info">
                                <div style="display:flex; justify-content:space-between; font-size:0.9em;">
                                    <span>Objectif Semaine</span>
                                    <strong id="weekly-count-display">0 / 2</strong>
                                </div>
                                <div class="weekly-goal-progress-bar"><div class="weekly-goal-progress" id="weekly-progress-bar"></div></div>
                                <p id="streak-display" style="font-size:0.85em; margin-top:5px; opacity:0.7;">S√©rie actuelle : 0 semaines</p>
                                <!-- Mini Calendrier 14 jours -->
                                <div class="calendar-grid" id="calendar-grid"></div>
                            </div>
                        </div>
                        <div class="sidebar-module">
                            <h3><i class="fas fa-history"></i> HISTORIQUE</h3>
                            <ul id="recent-history-list" style="list-style:none; padding:0; font-size:0.9em; color:var(--secondary-text-color-dark);"></ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- WORKOUT -->
            <div class="workout-section app-section section-hidden" id="workout-section">
                <div class="timer-and-image-wrapper" id="timer-view">
                    <div class="timer-display" id="timer-display-clickable">
                        <div class="timer-progress-circle-container">
                            <svg viewBox="0 0 100 100">
                                <circle class="timer-progress-circle-bg" cx="50" cy="50" r="45"></circle>
                                <circle id="timer-progress-indicator" class="timer-progress-circle" cx="50" cy="50" r="45" stroke-dasharray="282.74" stroke-dashoffset="282.74"></circle>
                            </svg>
                        </div>
                        <div class="reactor">
                            <div class="triangle"></div>
                            <div class="circle-1"><span></span><span></span><span></span><span></span></div>
                            <div class="circle-2"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></div>
                            <div class="circle-3"></div>
                            <div class="circle-4"><span></span><span></span><span></span></div>
                            <div class="circle-5"><span></span><span></span><span></span></div>
                            <div class="circle-6"></div>
                            <div class="circle-7"></div>
                            <div id="time-left">00:00</div>
                        </div>
                    </div>
                </div>
    
                <div class="workout-info" id="workout-info">
                    <div id="current-exercise-name-display">-</div>
                    <div id="current-exercise-container"></div>
                </div>
    
                <div class="controls">
                    <button id="prev-btn"><i class="fas fa-backward"></i> PR√âC√âDENT</button>
                    <button id="start-pause-btn">D√âMARRER</button>
                    <button id="skip-btn">SUIVANT <i class="fas fa-forward"></i></button>
                    <button id="finish-btn" style="color:var(--neon-green)"><i class="fas fa-flag-checkered"></i> FINIR</button>
                    <button id="reset-btn" style="color:var(--neon-red)"><i class="fas fa-times"></i></button>
                </div>
            </div>
        </main>
    </div>
    
    <footer>
        <p>¬© <span id="current-year"></span> ArmorWorkout. Powered by Arc Reactor Core.</p>
    </footer>

    <div id="message-area" class="message-area"></div>

    <div id="post-workout-summary" class="post-workout-summary">
        <div class="post-workout-summary-content">
            <h2 id="summary-title">RAPPORT DE MISSION</h2>
            <ul id="summary-items-list" class="summary-items-list"></ul>
            <div class="summary-controls">
                <button id="finish-summary-btn"><i class="fas fa-save"></i> SYNCHRONISER & QUITTER</button>
            </div>
        </div>
    </div>
    
    <script async defer src="https://accounts.google.com/gsi/client"></script>
    <script>
        "use strict";

        // =================================================================================
        // 1. CONFIGURATION & CONSTANTES
        // =================================================================================
        const GOOGLE_CLIENT_ID = "731283926358-viam3ulpgna14flfdeb9m92l8s620hoi.apps.googleusercontent.com";
        const GOOGLE_DRIVE_SCOPES = 'https://www.googleapis.com/auth/drive.file';
        
        // CIBLES FICHIERS MODIFI√âES (IMPORTANT)
        const PROGRAM_FILENAME = "programme.json";
        const HISTORY_FILENAME = "armorworkout_history.json";
        
        const WORKOUT_GOAL = 2; // Objectif 2 s√©ances / semaine
        const TIMER_CIRCUMFERENCE = 2 * Math.PI * 45;

        // SYST√àME DE LIGUES (GAMIFICATION)
        const LEAGUES = [
            { name: "Bois", min: 0, color: "#A0522D", rgb: "160, 82, 45", speed: "12s" },
            { name: "Pierre", min: 2, color: "#78909C", rgb: "120, 144, 156", speed: "10s" },
            { name: "Bronze", min: 4, color: "#CD7F32", rgb: "205, 127, 50", speed: "9s" },
            { name: "Argent", min: 6, color: "#C0C0C0", rgb: "192, 192, 192", speed: "8s" },
            { name: "Or", min: 8, color: "#FFD700", rgb: "255, 215, 0", speed: "7s" },
            { name: "Platine", min: 12, color: "#E5E4E2", rgb: "229, 228, 226", speed: "6s" },
            { name: "√âmeraude", min: 16, color: "#50C878", rgb: "80, 200, 120", speed: "5s" },
            { name: "Rubis", min: 20, color: "#E0115F", rgb: "224, 17, 95", speed: "4s" },
            { name: "Diamant", min: 26, color: "#B9F2FF", rgb: "185, 242, 255", speed: "3s" },
            { name: "Vibranium", min: 32, color: "#FFFFFF", rgb: "255, 255, 255", speed: "1s" }
        ];

        // Programme par d√©faut (S√©curit√© Anti-Crash)
        const DEFAULT_PROGRAM = {
            "nom_programme": "ROI V√äTU 2025",
            "sessions": [
                { "nom_session": "S√âANCE A : V-FRAME", "exercices_et_pauses": [] },
                { "nom_session": "S√âANCE B : THICKNESS", "exercices_et_pauses": [] }
            ]
        };

        // √âTAT GLOBAL
        let loadedProgram = null;
        let workoutHistory = [];
        let googleAccessToken = null;
        let tokenClient = null;
        let programFileId = null;
        let historyFileId = null;
        let currentLeague = LEAGUES[0];

        // √âTAT S√âANCE
        let currentSessionName = "";
        let currentPlan = [];
        let currentIdx = 0;
        let timer = null;
        let timeLeft = 0;
        let totalTime = 0;
        let isRunning = false;
        let workoutStartTime = null;
        let isEditMode = false;
        let currentState = 'idle';

        // =================================================================================
        // 2. INITIALISATION & AUTH ROBUSTE
        // =================================================================================
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('current-year').textContent = new Date().getFullYear();
            
            // Attente active du chargement de la lib Google (Fix "google is not defined")
            const checkGoogle = setInterval(() => {
                if (typeof google !== 'undefined' && google.accounts) {
                    clearInterval(checkGoogle);
                    initGis();
                }
            }, 200);

            addListeners();
            updateTheme(LEAGUES[0]); // Th√®me par d√©faut
        });

        function addListeners() {
            document.getElementById('signin-button').onclick = handleAuth;
            document.getElementById('start-pause-btn').onclick = toggleTimer;
            document.getElementById('skip-btn').onclick = () => navigate(1);
            document.getElementById('prev-btn').onclick = () => navigate(-1);
            document.getElementById('finish-btn').onclick = () => showSummary();
            document.getElementById('reset-btn').onclick = quitWorkout;
            document.getElementById('finish-summary-btn').onclick = saveWorkout;
            document.getElementById('edit-program-btn').onclick = toggleEditMode;
            
            // D√©l√©gation pour le stepper du r√©sum√©
            document.getElementById('summary-items-list').addEventListener('click', handleStepper);
        }

        function initGis() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID, scope: GOOGLE_DRIVE_SCOPES,
                callback: async (resp) => {
                    if (resp.access_token) {
                        googleAccessToken = resp.access_token;
                        document.body.classList.replace('logged-out', 'logged-in');
                        document.getElementById('drive-status').style.display = 'inline-flex';
                        showMessage("ArmorOS Connect√©. Initialisation...");
                        await syncDrive();
                    }
                }
            });
        }

        function handleAuth() { if(tokenClient) tokenClient.requestAccessToken(); }

        // =================================================================================
        // 3. DRIVE SYNC (CORRIG√â HTTP 400 + ESPACES)
        // =================================================================================
        async function syncDrive() {
            try {
                // Programme
                programFileId = await findFile(PROGRAM_FILENAME);
                if (programFileId) {
                    const content = await downloadFile(programFileId);
                    loadedProgram = JSON.parse(content);
                } else {
                    loadedProgram = DEFAULT_PROGRAM;
                    programFileId = await createFile(PROGRAM_FILENAME, JSON.stringify(DEFAULT_PROGRAM));
                    showMessage("Fichier Programme cr√©√© sur Drive.");
                }

                // Historique
                historyFileId = await findFile(HISTORY_FILENAME);
                if (historyFileId) {
                    const content = await downloadFile(historyFileId);
                    workoutHistory = JSON.parse(content);
                } else {
                    historyFileId = await createFile(HISTORY_FILENAME, "[]");
                    workoutHistory = [];
                }

                calculateLeague(); // Recalculer la ligue apr√®s chargement
                renderHome();
            } catch (e) {
                console.error(e);
                showMessage("Erreur de synchronisation Drive.");
            }
        }

        // --- Helpers Drive Corrects ---
        async function findFile(name) {
            // CORRECTION : encodeURIComponent pour √©viter l'erreur 400 avec les espaces/+
            const q = `name = '${name}' and trashed = false`;
            const url = `https://www.googleapis.com/drive/v3/files?q=${encodeURIComponent(q)}&fields=files(id,name)`;
            const res = await fetch(url, { headers: { Authorization: `Bearer ${googleAccessToken}` } });
            const data = await res.json();
            return data.files && data.files.length > 0 ? data.files[0].id : null;
        }

        async function downloadFile(id) {
            const res = await fetch(`https://www.googleapis.com/drive/v3/files/${id}?alt=media`, { headers: { Authorization: `Bearer ${googleAccessToken}` } });
            return await res.text();
        }

        async function createFile(name, content) {
            const meta = { name, mimeType: 'application/json' };
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(meta)], { type: 'application/json' }));
            form.append('file', new Blob([content], { type: 'application/json' }));
            const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST', headers: { Authorization: `Bearer ${googleAccessToken}` }, body: form
            });
            const data = await res.json();
            return data.id;
        }

        async function updateFile(id, content) {
            await fetch(`https://www.googleapis.com/upload/drive/v3/files/${id}?uploadType=media`, {
                method: 'PATCH', headers: { Authorization: `Bearer ${googleAccessToken}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(content, null, 2)
            });
        }

        // =================================================================================
        // 4. MOTEUR LIGUES (GAMIFICATION 2/SEMAINE)
        // =================================================================================
        function calculateLeague() {
            if (workoutHistory.length === 0) return updateTheme(LEAGUES[0]);

            // Grouper par semaine
            const weeks = {};
            workoutHistory.forEach(h => {
                const d = new Date(h.date);
                const k = getWeekKey(d);
                weeks[k] = (weeks[k] || 0) + 1;
            });

            // Calculer Streak
            let streak = 0;
            let checkDate = new Date();
            
            // Mise √† jour barre progression semaine courante
            const currentWeekKey = getWeekKey(checkDate);
            const countThisWeek = weeks[currentWeekKey] || 0;
            updateWeeklyBar(countThisWeek);

            // Remonter le temps pour le streak
            while(true) {
                const key = getWeekKey(checkDate);
                if (weeks[key] >= WORKOUT_GOAL) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 7);
                } else {
                    // Tol√©rance pour la semaine en cours si pas finie
                    if (key === currentWeekKey && streak === 0) {
                        checkDate.setDate(checkDate.getDate() - 7);
                        continue;
                    }
                    break;
                }
            }

            // D√©terminer Ligue
            let newLeague = LEAGUES[0];
            for (let l of LEAGUES) { if (streak >= l.min) newLeague = l; }
            
            // UI
            document.getElementById('streak-display').textContent = `S√©rie actuelle : ${streak} semaine(s)`;
            updateTheme(newLeague);
        }

        function updateWeeklyBar(count) {
            const el = document.getElementById('weekly-progress-bar');
            const txt = document.getElementById('weekly-count-display');
            const pct = Math.min((count / WORKOUT_GOAL) * 100, 100);
            el.style.width = pct + '%';
            txt.textContent = `${count} / ${WORKOUT_GOAL}`;
        }

        function updateTheme(league) {
            currentLeague = league;
            const r = document.documentElement;
            r.style.setProperty('--theme-color', league.color);
            r.style.setProperty('--theme-rgb', league.rgb);
            r.style.setProperty('--reactor-speed', league.speed);
            
            // Mettre √† jour le badge
            document.getElementById('league-display').innerHTML = `
                <i class="fas ${league.icon || 'fa-trophy'}" style="font-size:3em; color:${league.color}; margin-bottom:10px; filter:drop-shadow(0 0 10px ${league.color})"></i>
                <h3 style="color:${league.color}; margin:0; text-transform:uppercase">${league.name}</h3>
            `;
        }

        function getWeekKey(d) {
            const date = new Date(d.getTime());
            date.setHours(0, 0, 0, 0);
            date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7);
            const week1 = new Date(date.getFullYear(), 0, 4);
            return date.getFullYear() + "-" + Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7);
        }

        // =================================================================================
        // 5. MOTEUR D'ENTRA√éNEMENT (ARC REACTOR)
        // =================================================================================
        function renderHome() {
            const container = document.getElementById('session-cards-container');
            container.innerHTML = '';

            if (!loadedProgram) return;

            loadedProgram.sessions.forEach(session => {
                const card = document.createElement('div');
                card.className = 'session-card-large';
                const count = session.exercices_et_pauses.filter(e => e.type === 'exercise').length;
                card.innerHTML = `
                    <h3>${session.nom_session}</h3>
                    <p>${session.description_session || ''}</p>
                    <div style="margin-top:15px; color:var(--theme-color); font-weight:bold"><i class="fas fa-dumbbell"></i> ${count} Exercices</div>
                `;
                card.onclick = () => {
                    if (isEditMode) showSummaryModal(session.nom_session, 'edit');
                    else startSession(session);
                };
                container.appendChild(card);
            });

            // Historique
            const list = document.getElementById('recent-history-list');
            list.innerHTML = '';
            workoutHistory.slice(-5).reverse().forEach(h => {
                const li = document.createElement('li');
                li.style.marginBottom = "8px";
                li.innerHTML = `<span style="color:var(--theme-color)">${h.date}</span> ${h.type}`;
                list.appendChild(li);
            });
            
            // Calendrier
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            const now = new Date();
            for(let i=13; i>=0; i--) {
                const d = new Date(); d.setDate(now.getDate() - i);
                const iso = d.toISOString().split('T')[0];
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                if(i===0) dayEl.classList.add('today');
                dayEl.textContent = d.getDate();
                
                // Dot si s√©ance ce jour l√†
                if(workoutHistory.some(h => h.date === iso)) {
                    const dot = document.createElement('div');
                    dot.className = 'day-dot';
                    dayEl.appendChild(dot);
                }
                grid.appendChild(dayEl);
            }
        }

        function startSession(session) {
            currentSessionName = session.nom_session;
            currentPlan = JSON.parse(JSON.stringify(session.exercices_et_pauses));
            currentIdx = 0;
            workoutStartTime = new Date();
            
            document.getElementById('home-section').classList.add('section-hidden');
            document.getElementById('workout-section').classList.remove('section-hidden');
            document.body.classList.add('workout-active');
            
            loadStep();
        }

        function loadStep() {
            const item = currentPlan[currentIdx];
            const isRest = item.type === 'break';
            const nameEl = document.getElementById('current-exercise-name-display');
            const contEl = document.getElementById('current-exercise-container');
            const btn = document.getElementById('start-pause-btn');

            nameEl.textContent = item.name || (isRest ? "R√âCUP√âRATION" : "Exercice");
            
            if (isRest) {
                totalTime = item.duration || 60;
                timeLeft = totalTime;
                contEl.innerHTML = `<div class="exercise-details" style="border-color:var(--break-color-val)">Respirez calmement...</div>`;
                btn.innerHTML = `<i class="fas fa-play"></i> CHRONO`;
                isTimerRunning = false;
                document.body.className = "workout-active state-break";
            } else {
                // Parsing du mat√©riel (Sac üéí, Bandes üü™üü¶)
                const wTxt = item.weight_text || "";
                let displayWeight = wTxt;
                if (wTxt.includes('Sac')) displayWeight = wTxt.replace('Sac', 'üéí');
                else if (wTxt.includes('√âlastique')) displayWeight = wTxt.replace('√âlastique', 'üßò');
                else if (!wTxt || wTxt.includes('PDC')) displayWeight = "üí™ PDC";
                else displayWeight = `üèãÔ∏è ${parseFloat(wTxt) || 0} kg`;

                const reps = item.reps || (item.duration ? item.duration + "s" : "-");

                contEl.innerHTML = `
                    <div class="exercise-details">
                        <div class="main-stats">
                            <span><i class="fas fa-repeat"></i> ${reps}</span>
                            <span>${displayWeight}</span>
                        </div>
                        <p style="margin-top:10px; opacity:0.7; font-size:0.9em;">${item.details || ''}</p>
                    </div>
                `;
                
                if (item.duration) {
                    totalTime = item.duration;
                    timeLeft = totalTime;
                    btn.innerHTML = `<i class="fas fa-play"></i> GO`;
                    document.body.className = "workout-active state-exercise";
                    document.body.dataset.timed = "true";
                } else {
                    totalTime = 0;
                    timeLeft = 0;
                    btn.innerHTML = `<i class="fas fa-check"></i> VALID√â`;
                    document.body.className = "workout-active state-exercise";
                    document.body.dataset.timed = "false";
                }
                isTimerRunning = false;
            }
            updateTimerDisplay();
        }

        function toggleTimer() {
            const item = currentPlan[currentIdx];
            // Si pas de temps (reps), on valide direct
            if (item.type !== 'break' && !item.duration) {
                navigate(1);
                return;
            }

            if (isTimerRunning) {
                clearInterval(timer);
                isTimerRunning = false;
                document.getElementById('start-pause-btn').innerHTML = `<i class="fas fa-play"></i> REPRENDRE`;
                document.body.classList.add('state-paused');
            } else {
                isTimerRunning = true;
                document.getElementById('start-pause-btn').innerHTML = `<i class="fas fa-pause"></i> PAUSE`;
                document.body.classList.remove('state-paused');
                
                timer = setInterval(() => {
                    timeLeft--;
                    updateTimerDisplay();
                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        isTimerRunning = false;
                        if (item.type === 'break') navigate(1); // Auto-skip break
                        else document.getElementById('start-pause-btn').innerHTML = `<i class="fas fa-check"></i> FINI`;
                    }
                }, 1000);
            }
        }

        function updateTimerDisplay() {
            const el = document.getElementById('time-left');
            const circle = document.getElementById('timer-progress-indicator');
            
            if (totalTime > 0) {
                const m = Math.floor(timeLeft / 60).toString().padStart(2, '0');
                const s = (timeLeft % 60).toString().padStart(2, '0');
                el.textContent = `${m}:${s}`;
                
                const pct = timeLeft / totalTime;
                circle.style.strokeDashoffset = TIMER_CIRCUMFERENCE * (1 - pct);
            } else {
                el.textContent = "00:00";
                circle.style.strokeDashoffset = 0;
            }
        }

        function navigate(dir) {
            clearInterval(timer);
            currentIdx += dir;
            if (currentIdx >= currentPlan.length) showSummary();
            else if (currentIdx < 0) { currentIdx = 0; loadStep(); }
            else loadStep();
        }

        function quitWorkout() {
            if(confirm("Quitter la s√©ance ?")) {
                clearInterval(timer);
                document.body.className = "logged-in state-idle";
                document.getElementById('workout-section').classList.add('section-hidden');
                document.getElementById('home-section').classList.remove('section-hidden');
            }
        }

        // =================================================================================
        // 6. R√âSUM√â & √âDITION
        // =================================================================================
        function showSummary() {
            currentSummaryContext = { mode: 'workout', sessionName: currentSessionName };
            openSummary(currentSessionName, 'workout');
        }

        function openSummary(sessionName, mode) {
            currentSummaryContext = { mode: mode, sessionName: sessionName };
            
            const session = loadedProgram.sessions.find(s => s.nom_session === sessionName);
            // Mode workout = plan modifi√©, Mode edit = plan original
            const plan = (mode === 'workout') ? currentPlan : JSON.parse(JSON.stringify(session.exercices_et_pauses));
            
            const list = document.getElementById('summary-items-list');
            list.innerHTML = '';

            plan.forEach((item, idx) => {
                if (item.type === 'exercise') {
                    const li = document.createElement('li');
                    li.className = 'summary-item';
                    
                    // Extraction valeur poids et emoji
                    let weightVal = 0;
                    let emoji = "üèãÔ∏è";
                    const wTxt = item.weight_text || "";
                    
                    if (wTxt.includes('Sac')) emoji = "üéí";
                    else if (wTxt.includes('√âlastique') || wTxt.includes('Band')) emoji = "üßò";
                    else if (wTxt.includes('PDC')) emoji = "üí™";
                    
                    weightVal = parseFloat(wTxt.replace(/[^0-9.]/g, '')) || 0;

                    li.innerHTML = `
                        <div class="exercise-name">${item.name}</div>
                        <div class="fields-grid">
                            <div class="input-group">
                                <label>Reps / Temps</label>
                                <div class="stepper-control" data-type="reps" data-idx="${idx}">
                                    <button class="stepper-btn minus">-</button>
                                    <span class="stepper-value">${item.reps || item.duration || 0}</span>
                                    <button class="stepper-btn plus">+</button>
                                </div>
                            </div>
                            <div class="input-group">
                                <label>Charge (${emoji})</label>
                                <div class="stepper-control" data-type="weight" data-idx="${idx}" data-emoji="${emoji}">
                                    <button class="stepper-btn minus">-</button>
                                    <span class="stepper-value">${weightVal}</span>
                                    <button class="stepper-btn plus">+</button>
                                </div>
                            </div>
                        </div>
                    `;
                    list.appendChild(li);
                }
            });

            const btn = document.getElementById('finish-summary-btn');
            btn.innerHTML = (mode === 'workout') ? `<i class="fas fa-check"></i> VALIDER & SAUVEGARDER` : `<i class="fas fa-save"></i> ENREGISTRER MODIFICATIONS`;
            document.getElementById('post-workout-summary').classList.add('visible');
        }

        function handleStepper(e) {
            const btn = e.target.closest('.stepper-btn');
            if (!btn) return;
            
            const parent = btn.parentElement;
            const span = parent.querySelector('.stepper-value');
            let val = parseFloat(span.textContent);
            const isWeight = parent.dataset.type === 'weight';
            const step = isWeight ? 0.5 : 1;

            if (btn.classList.contains('minus')) val = Math.max(0, val - step);
            else val += step;

            // Arrondi propre
            span.textContent = Number.isInteger(val) ? val : val.toFixed(1);
        }

        async function saveWorkout() {
            const btn = document.getElementById('finish-summary-btn');
            btn.disabled = true;
            btn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> SAUVEGARDE...`;

            // 1. Appliquer les valeurs du formulaire au programme en m√©moire
            const sessionIdx = loadedProgram.sessions.findIndex(s => s.nom_session === currentSummaryContext.sessionName);
            const items = document.querySelectorAll('.summary-item');
            
            // On reconstruit un plan propre
            let planToSave = (currentSummaryContext.mode === 'workout') ? currentPlan : JSON.parse(JSON.stringify(loadedProgram.sessions[sessionIdx].exercices_et_pauses));

            items.forEach((div) => {
                const repEl = div.querySelector('[data-type="reps"]');
                const wEl = div.querySelector('[data-type="weight"]');
                const idx = parseInt(repEl.dataset.idx);
                
                const rVal = parseFloat(repEl.querySelector('.stepper-value').textContent);
                const wVal = parseFloat(wEl.querySelector('.stepper-value').textContent);
                const emoji = wEl.dataset.emoji;

                const ex = planToSave[idx];
                if (ex.reps) ex.reps = rVal;
                else if (ex.duration) ex.duration = rVal;

                // Reconstruction string poids
                if (emoji === "üéí") ex.weight_text = `üéí Sac ${wVal} kg`;
                else if (emoji === "üßò") ex.weight_text = `üßò √âlastique ${wVal} kg`;
                else if (emoji === "üí™") ex.weight_text = `üí™ PDC`;
                else ex.weight_text = `üèãÔ∏è ${wVal} kg`;
            });

            // Si c'√©tait un vrai workout, on met √† jour le programme principal ET l'historique
            if (currentSummaryContext.mode === 'workout') {
                loadedProgram.sessions[sessionIdx].exercices_et_pauses = planToSave;
                
                workoutHistory.push({
                    date: new Date().toISOString().split('T')[0],
                    type: currentSessionName,
                    exercises: planToSave.filter(e => e.type === 'exercise').map(e => ({
                        name: e.name,
                        reps: e.reps || e.duration,
                        weight: e.weight_text
                    }))
                });
                
                if (googleAccessToken) await updateFile(historyFileId, workoutHistory);
            } else {
                // Mode √©dition simple
                loadedProgram.sessions[sessionIdx].exercices_et_pauses = planToSave;
            }

            // Sauvegarde Programme
            if (googleAccessToken) await updateFile(programFileId, loadedProgram);

            // Reset UI
            document.getElementById('post-workout-summary').classList.remove('visible');
            btn.disabled = false;
            
            if (currentSummaryContext.mode === 'workout') {
                quitWorkout();
            } else {
                renderHome();
                showMessage("Modifications enregistr√©es !");
                isEditMode = false;
                document.getElementById('edit-program-btn').classList.remove('active');
            }
        }

        function toggleEditMode() {
            isEditMode = !isEditMode;
            const btn = document.getElementById('edit-program-btn');
            btn.classList.toggle('active', isEditMode);
            btn.innerHTML = isEditMode ? `<i class="fas fa-check"></i> TERMINER` : `<i class="fas fa-edit"></i> √âDITION`;
            
            const cards = document.querySelectorAll('.session-card-large');
            cards.forEach(c => {
                c.style.borderColor = isEditMode ? "var(--neon-yellow)" : "var(--border-color-dark)";
                c.querySelector('h3').innerHTML = isEditMode ? `<i class="fas fa-pen"></i> ` + c.querySelector('h3').textContent : c.querySelector('h3').textContent;
            });
            showMessage(isEditMode ? "Mode √âdition Activ√©" : "Mode √âdition D√©sactiv√©");
        }

        function showMessage(txt, duration = 3000) {
            const el = document.getElementById('message-area');
            el.textContent = txt;
            el.classList.add('visible');
            setTimeout(() => el.classList.remove('visible'), duration);
        }

    </script>
</body>
</html>
  
