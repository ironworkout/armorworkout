
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArmorWorkout - Éditeur de Programme</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color-dark: #030712; 
            --secondary-bg-color-dark: #0B132B; 
            --primary-text-color-dark: #F0F4F8; 
            --secondary-text-color-dark: #A0AEC0; 
            --border-color-dark: #1E293B; 
            --electric-blue: #00BFFF; 
            --electric-cyan: #22D3EE; 
            --electric-blue-light: #4D94FF; 
            --glow-accent: #0AF; 
            --electric-blue-rgb: 0, 191, 255;
            --electric-cyan-rgb: 34, 211, 238;
            --glow-accent-rgb: 0, 170, 255;
            --secondary-bg-color-dark-rgb: 11, 19, 43;
            --bg-color-dark-rgb: 3, 7, 18;
            --neon-pink: #FF1493; 
            --neon-purple: #9400D3; 
            --neon-green: #39FF14; 
            --neon-red: #FF3131; 
            --neon-yellow: #FFF01F; 
            --neon-pink-rgb: 255, 20, 147;
            --neon-purple-rgb: 148, 0, 211;
            --neon-green-rgb: 57, 255, 20;
            --neon-red-rgb: 255, 49, 49;
            --neon-yellow-rgb: 255, 240, 31;
            --glow-red: 0 0 8px var(--neon-red), 0 0 12px rgba(var(--neon-red-rgb),0.7);
            --glow-green: 0 0 8px var(--neon-green), 0 0 12px rgba(var(--neon-green-rgb),0.7);
            --glow-yellow: 0 0 8px var(--neon-yellow), 0 0 12px rgba(var(--neon-yellow-rgb),0.7);
            --glow-pink: 0 0 8px var(--neon-pink), 0 0 12px rgba(var(--neon-pink-rgb),0.7);
            --glow-purple: 0 0 8px var(--neon-purple), 0 0 12px rgba(var(--neon-purple-rgb),0.7);
            --electric-yellow: var(--neon-yellow); 
            --electric-yellow-rgb: var(--neon-yellow-rgb);
            --color-exercise-default: var(--neon-pink);
            --color-break: var(--neon-yellow);
            --font-family-main: 'Inter', sans-serif;
            --font-family-titles: 'Orbitron', sans-serif; 
            --border-radius-lg: 10px;
            --border-radius-md: 8px;
            --border-radius-sm: 6px;
            --transition-speed: 0.3s;
            --bg-color: var(--bg-color-dark);
            --secondary-bg-color: var(--secondary-bg-color-dark);
            --primary-text-color: var(--primary-text-color-dark);
            --secondary-text-color: var(--secondary-text-color-dark);
            --border-color: var(--border-color-dark);
            --accent-border-color: rgba(var(--electric-blue-rgb), 0.4); 
            --input-bg: #1A202C; 
            --link-color: var(--electric-cyan);
            --button-connect-color: var(--neon-green);
            --button-connect-glow: var(--glow-green);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; font-size: 16px; }
        body {
            font-family: var(--font-family-main); background-color: var(--bg-color); color: var(--primary-text-color);
            line-height: 1.65; transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
            display: flex; flex-direction: column; min-height: 100vh;
            -webkit-font-smoothing: antialiased; overflow-x: hidden;
            background-image: radial-gradient(ellipse at center, rgba(var(--electric-blue-rgb), 0.08) 0%, transparent 60%),
                              linear-gradient(0deg, rgba(var(--bg-color-dark-rgb), 0.5) 0%, rgba(var(--bg-color-dark-rgb), 0.9) 100%);
            position: relative; 
        }
        body::before { 
            content: ""; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-image: linear-gradient(rgba(var(--electric-blue-rgb), 0.05) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(var(--electric-blue-rgb), 0.05) 1px, transparent 1px);
            background-size: 30px 30px; z-index: -1; opacity: 0.7;
        }
        .container { max-width: 900px; margin: 0 auto; padding: 30px 20px; width: 100%; flex-grow: 1; display: flex; flex-direction: column; }
        header {
            padding: 15px 0; background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.5); backdrop-filter: blur(8px) saturate(150%);
            border-bottom: 1px solid rgba(var(--electric-blue-rgb), 0.3); box-shadow: 0 2px 15px rgba(var(--electric-blue-rgb), 0.1);
            position: sticky; top:0; z-index: 1000; 
        }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1100px; margin: 0 auto; padding: 0 25px; flex-wrap: wrap; gap: 15px 20px; }
        header h1 { font-size: 1.6em; color: var(--primary-text-color); margin: 0; font-weight: 700; display: flex; align-items: center; gap: 10px; font-family: var(--font-family-titles); text-shadow: 0 0 8px rgba(var(--electric-cyan-rgb), 0.7); }
        header h1 i { color: var(--electric-cyan); animation: subtlePulse 3s infinite ease-in-out; }
        @keyframes subtlePulse { 0%, 100% { opacity: 0.7; transform: scale(1); } 50% { opacity: 1; transform: scale(1.015); } }
        .header-link { color: var(--secondary-text-color); font-size: 0.9em; text-decoration: none; display: inline-flex; align-items: center; gap: 5px; transition: color var(--transition-speed) ease; padding: 8px 12px; border-radius: var(--border-radius-sm); border: 1px solid transparent; }
        .header-link:hover { color: var(--link-color); background-color: rgba(var(--electric-blue-rgb), 0.1); border-color: rgba(var(--electric-blue-rgb), 0.4); text-shadow: 0 0 5px rgba(var(--electric-blue-rgb), 0.5); }
        .header-actions { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .auth-controls { display: flex; gap: 10px; align-items: center; }
        .auth-controls button, .nav-buttons a {
            background: none; border: 1px solid var(--accent-border-color); color: var(--secondary-text-color); padding: 6px 14px;
            border-radius: var(--border-radius-md); font-size: 0.85em; font-weight: 500; cursor: pointer;
            transition: all var(--transition-speed) ease; display: inline-flex; align-items: center; gap: 6px; text-decoration: none;
        }
        .auth-controls button:disabled, .nav-buttons a.disabled-link-look { opacity: 0.5; cursor: not-allowed; pointer-events: auto; border-color: var(--border-color) !important; color: var(--secondary-text-color) !important; box-shadow: none !important; background-color: transparent !important; }
        .auth-controls button:not(:disabled):hover, .nav-buttons a:not(.disabled-link-look):hover { border-color: var(--primary-text-color); color: var(--primary-text-color); }
        #signin-button, #signin-button-prompt { border-color: var(--button-connect-color); color: var(--button-connect-color); }
        #signin-button:not(:disabled):hover, #signin-button-prompt:not(:disabled):hover { background-color: rgba(var(--neon-green-rgb), 0.1); box-shadow: var(--glow-green); border-color: var(--neon-green); }
        #drive-status { font-size: 0.8em; color: var(--secondary-text-color); margin-left: 5px; transition: opacity 0.3s, color 0.3s, border-color 0.3s; min-width: fit-content; text-align: right; font-style: normal; padding: 4px 8px; background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.5); border-radius: var(--border-radius-sm); border: 1px solid var(--border-color); display: none; }
        #drive-status.loading { color: var(--neon-yellow); border-color: var(--neon-yellow); animation: blink-border 1.5s infinite ease-in-out; }
        #drive-status.error { color: var(--neon-red); border-color: var(--neon-red); }
        #drive-status.success { color: var(--neon-green); border-color: var(--neon-green); }
        @keyframes blink-border { 50% { border-color: rgba(var(--neon-yellow-rgb), 0.4); } }
        body.logged-out #signin-button { display: inline-flex; } body.logged-out #drive-status { display: none; }
        body.logged-in #signin-button { display: none; } body.logged-in #drive-status { display: inline-block; }
        .nav-buttons { display: flex; gap: 10px; margin-bottom: 20px; padding: 0; justify-content: center; } 
        .nav-buttons a { padding: 8px 16px; font-size: 0.9em; }
        .nav-buttons a:hover { background-color: rgba(var(--electric-blue-rgb), 0.1); border-color: rgba(var(--electric-blue-rgb), 0.4); text-shadow: 0 0 5px rgba(var(--electric-blue-rgb), 0.5); color: var(--electric-blue); }
        main { flex-grow: 1; display: flex; flex-direction: column; align-items: center; padding-top: 20px; } 
        main h2 { font-size: 1.8em; font-weight: 700; margin-bottom: 25px; text-align: center; color: var(--primary-text-color); display: flex; align-items: center; gap: 12px; justify-content: center; font-family: var(--font-family-titles); text-shadow: 0 0 8px rgba(var(--electric-cyan-rgb), 0.7);}
        main h2 i { color: var(--electric-cyan); animation: subtlePulse 3s infinite ease-in-out; }
        #connection-prompt { text-align: center; padding: 40px 20px; background-color: var(--secondary-bg-color); border-radius: var(--border-radius-lg); border: 1px dashed var(--border-color); margin: 20px auto; max-width: 600px; }
        #connection-prompt p { margin-bottom: 15px; color: var(--secondary-text-color); }
        #connection-prompt button { padding: 8px 18px; border: 1px solid; font-size: 0.9em; }
        #program-editor-area { width: 100%; background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.6); backdrop-filter: blur(10px) saturate(130%); border-radius: var(--border-radius-lg); border: 1px solid rgba(var(--electric-blue-rgb), 0.2); padding: 25px; display: none; flex-direction: column; gap: 25px; box-shadow: 0 5px 25px rgba(var(--bg-color-dark-rgb), 0.5), inset 0 0 15px rgba(var(--electric-blue-rgb), 0.1); }
        body.logged-in #program-editor-area { display: flex; }
        .program-tabs { display: flex; gap: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; flex-wrap: wrap; }
        .program-tabs button { padding: 8px 18px; font-size: 1em; font-weight: 500; border: none; background: none; color: var(--secondary-text-color); cursor: pointer; transition: all var(--transition-speed) ease; border-radius: var(--border-radius-md); position: relative; }
        .program-tabs button:disabled { color: rgba(var(--secondary-text-color-dark-rgb), 0.5); cursor: not-allowed; opacity: 0.6; }
        .program-tabs button:not(:disabled):hover { background-color: rgba(var(--electric-blue-rgb), 0.1); color: var(--primary-text-color); }
        .program-tabs button.active { color: var(--electric-cyan); background-color: rgba(var(--electric-cyan-rgb), 0.15); font-weight: 700; border: 1px solid var(--electric-cyan); box-shadow: 0 0 10px rgba(var(--electric-cyan-rgb),0.3); }
        .program-tabs button.is-dirty::after { content: '●'; position: absolute; top: 5px; right: 8px; font-size: 0.7em; color: var(--neon-orange); animation: blink-dot 1.5s infinite ease-in-out; }
        @keyframes blink-dot { 50% { opacity: 0.3; } }
        #program-display { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 15px; min-height: 200px; background-color: rgba(var(--bg-color-dark-rgb), 0.15); border: 1px dashed var(--border-color); border-radius: var(--border-radius-md); padding: 15px; }
        #program-display:empty::before { content: "Connectez-vous et assurez-vous que le fichier de programme existe sur votre Drive."; display: block; text-align: center; padding: 50px 20px; color: var(--secondary-text-color); font-style: italic; }
        .program-step { background-color: var(--bg-color); border: 1px solid var(--border-color); border-left-width: 4px; border-radius: var(--border-radius-md); padding: 15px; display: grid; grid-template-columns: auto 1fr auto; gap: 10px 15px; align-items: start; position: relative; transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease; cursor: grab; }
        .program-step:hover { border-color: var(--accent-border-color); box-shadow: 0 2px 8px rgba(var(--bg-color-dark-rgb),0.3); }
        .step-icon { font-size: 1.3em; padding-top: 5px; grid-column: 1 / 2; align-self: center; transition: color var(--transition-speed) ease; }
        .break-step .step-icon { color: var(--color-break); }
        .step-content { grid-column: 2 / 3; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; }
        .step-field { display: flex; flex-direction: column; gap: 4px; }
        .step-field label { font-size: 0.8em; font-weight: 500; color: var(--secondary-text-color); }
        .step-field input[type="text"], .step-field input[type="number"], .step-field textarea, .step-field select { width: 100%; padding: 8px 10px; font-size: 0.9em; border-radius: var(--border-radius-sm); border: 1px solid var(--border-color); background-color: var(--input-bg); color: var(--primary-text-color); transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease; }
        .step-field input:focus, .step-field textarea:focus, .step-field select:focus { border-color: var(--electric-cyan); outline: none; box-shadow: 0 0 0 2px rgba(var(--electric-cyan-rgb), 0.3); }
        .step-field textarea { min-height: 60px; resize: vertical; font-family: inherit;}
        .step-field input[type="number"] { -moz-appearance: textfield; }
        .step-field input[type="number"]::-webkit-outer-spin-button, .step-field input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .step-actions { grid-column: 3 / 4; display: flex; flex-direction: column; gap: 8px; align-items: center; padding-top: 5px; }
        .step-actions button { background: none; border: none; color: var(--secondary-text-color); font-size: 1.1em; cursor: pointer; padding: 5px; transition: color var(--transition-speed) ease; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .step-actions button:hover { color: var(--primary-text-color); background-color: rgba(var(--primary-text-color-dark-rgb), 0.1); }
        .step-actions .delete-step-btn:hover { color: var(--neon-red); background-color: rgba(var(--neon-red-rgb), 0.1); }
        .program-step.sortable-ghost { opacity: 0.4; background-color: rgba(var(--electric-blue-rgb), 0.1); border-style: dashed; }
        .program-step.sortable-chosen { cursor: grabbing; border-color: var(--electric-cyan); box-shadow: 0 4px 12px rgba(var(--electric-cyan-rgb), 0.3); }
        .editor-actions { display: flex; justify-content: space-between; align-items: center; gap: 15px; flex-wrap: wrap; border-top: 1px solid var(--border-color); padding-top: 25px; margin-top: 10px; }
        .add-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .editor-actions button { padding: 9px 20px; font-size: 0.95em; font-weight: 500; border-radius: var(--border-radius-md); cursor: pointer; transition: all var(--transition-speed) ease; display: inline-flex; align-items: center; gap: 8px; border: 1px solid transparent; }
        .editor-actions button:disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; }
        #add-exercise-btn { border-color: var(--color-exercise-default); color: var(--color-exercise-default); background: transparent; }
        #add-exercise-btn:not(:disabled):hover { background-color: rgba(var(--neon-pink-rgb), 0.1); box-shadow: var(--glow-pink); }
        #add-break-btn { border-color: var(--color-break); color: var(--color-break); background: transparent; }
        #add-break-btn:not(:disabled):hover { background-color: rgba(var(--neon-yellow-rgb), 0.1); box-shadow: var(--glow-yellow); }
        #save-program-btn { border: none; background-color: var(--neon-green); color: #030712; box-shadow: 0 2px 5px rgba(0,0,0,0.2); } 
        #save-program-btn:not(:disabled):hover { filter: brightness(1.1); box-shadow: 0 4px 10px rgba(0,0,0,0.25), var(--glow-green); }
        #save-program-btn:disabled { background-color: var(--secondary-text-color); color: rgba(var(--bg-color-dark-rgb),0.7); box-shadow: none; border-color: var(--secondary-text-color); }
        .message-area { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.9); color: var(--primary-text-color); border: 1px solid var(--border-color); padding: 12px 25px; border-radius: var(--border-radius-md); z-index: 3000; opacity: 0; transition: opacity 0.5s ease, transform 0.5s ease, bottom 0.5s ease, background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; pointer-events: none; font-size: 0.95em; box-shadow: 0 4px 15px rgba(0,0,0,0.2); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); max-width: 90%; text-align: center; }
        .message-area.visible { opacity: 1; transform: translate(-50%, 0); bottom: 40px; pointer-events: auto; }
        .message-area.error { background-color: rgba(var(--neon-red-rgb), 0.8); color: #fff; border-color: var(--neon-red); text-shadow: 0 0 5px rgba(0,0,0,0.5); box-shadow: 0 4px 15px rgba(0,0,0,0.3), 0 0 10px var(--glow-red); }
        .message-area.success { background-color: rgba(var(--neon-green-rgb), 0.8); color: #030712; border-color: var(--neon-green); text-shadow: none; box-shadow: 0 4px 15px rgba(0,0,0,0.3), 0 0 10px var(--glow-green); }
        .message-area.info { background-color: rgba(var(--electric-blue-rgb), 0.8); color: #fff; border-color: var(--electric-blue); box-shadow: 0 4px 15px rgba(0,0,0,0.3), 0 0 10px var(--glow-blue); }
        footer { color: var(--secondary-text-color); opacity: 0.7; border-top: 1px solid rgba(var(--electric-blue-rgb), 0.2); margin-top: 60px; padding: 25px; text-align: center; transition: border-color var(--transition-speed) ease, color var(--transition-speed) ease; background-color: rgba(var(--bg-color-dark-rgb), 0.7); backdrop-filter: blur(3px); }
        footer a { color: var(--link-color); text-decoration: none; transition: color var(--transition-speed) ease; }
        footer a:hover { color: var(--primary-text-color); text-decoration: underline; text-shadow: 0 0 8px var(--link-color); }
        footer .fab.fa-google-drive { color: var(--neon-green); }
        @media (max-width: 768px) { .container { padding: 20px 15px; } main h2 { font-size: 1.4em; } .program-step { grid-template-columns: auto 1fr; } .step-actions { grid-column: 2 / 3; flex-direction: row; justify-content: flex-end; padding-top: 0; align-items: center; } .step-content { grid-template-columns: 1fr; } }
        @media (max-width: 480px) { .header-content { padding: 0 15px; } .header-actions { gap: 10px; } .auth-controls button, .nav-buttons a { padding: 5px 10px; font-size: 0.8em; } main h2 { font-size: 1.3em; } .program-tabs { gap: 5px; } .program-tabs button { padding: 6px 12px; font-size: 0.9em; } .program-step { padding: 12px; } .step-field input, .step-field textarea, .step-field select { padding: 6px 8px; font-size: 0.85em;} .editor-actions { flex-direction: column; align-items: stretch; } .editor-actions button { width: 100%; justify-content: center; } }
    </style>
</head>
<body class="logged-out dark-theme"> 

<header>
    <div class="header-content">
        <a href="index.html" class="header-link"><i class="fas fa-arrow-left"></i> Retour au Timer</a>
        <h1><i class="fas fa-shield-halved"></i> ArmorWorkout</h1>
        <div class="header-actions">
            <div class="auth-controls">
                <button id="signin-button" disabled><i class="fab fa-google"></i> Connecter Drive</button>
            </div>
            <span id="drive-status"></span>
        </div>
    </div>
</header>

<div class="container">
    <main>
        <h2><i class="fas fa-edit"></i> Éditeur de Programme</h2>

        <div id="connection-prompt">
            <p>Veuillez vous connecter à votre compte Google Drive pour charger et modifier votre programme d'entraînement.</p>
            <button id="signin-button-prompt" disabled><i class="fab fa-google"></i> Connecter Drive</button>
        </div>

        <div id="program-editor-area">
            <div class="program-tabs" id="program-tabs">
            </div>

            <ul id="program-display"></ul>

            <div class="editor-actions">
                <div class="add-buttons">
                    <button id="add-exercise-btn" disabled><i class="fas fa-dumbbell"></i> Ajouter Exercice</button>
                    <button id="add-break-btn" disabled><i class="fas fa-hourglass-half"></i> Ajouter Pause</button>
                </div>
                <button id="save-program-btn" disabled><i class="fas fa-save"></i> Sauvegarder Programme</button>
            </div>
        </div>
    </main>
</div>

<footer>
    <p>© <span id="current-year-editor">2024</span> ArmorWorkout Éditeur. Programme stocké sur <i class="fab fa-google-drive" aria-hidden="true"></i> Google Drive.</p>
     <p><a href="index.html">Retourner au Timer</a> | <a href="https://github.com/ironworkout/armorworkout" target="_blank" rel="noopener noreferrer"><i class="fab fa-github" aria-hidden="true"></i> Voir sur GitHub</a></p>
</footer>

<div id="message-area" class="message-area" role="status" aria-live="polite"></div>

<script async defer src="https://accounts.google.com/gsi/client"></script>
<script>
    const GOOGLE_CLIENT_ID = "731283926358-viam3ulpgna14flfdeb9m92l8s620hoi.apps.googleusercontent.com";
    const GOOGLE_DRIVE_SCOPES = 'https://www.googleapis.com/auth/drive.file';
    const FULL_PROGRAM_FILENAME = "programmeCompletHypertrophieElite_v1.json"; 
    const GIS_CHECK_INTERVAL = 100; 
    const GIS_MAX_RETRIES = 50;

    let loadedFullProgram = null; 

    let signInButton, driveStatusElement, 
        signInButtonPrompt, connectionPrompt, programEditorArea,
        programTabsContainer, programDisplay, addExerciseBtn, addBreakBtn, saveProgramBtn,
        messageArea;

    let googleAccessToken = null;
    let tokenClient = null;
    let programFileId = null; 
    let programsLoaded = false; 
    let currentEditingSessionName = null; 
    let isDirty = false;
    let messageTimeoutId = null;
    let sortableInstance = null;
    let gisCheckRetries = 0;

    function updateAuthUI(isLoggedIn) { 
        const body = document.body;
        body.classList.toggle('logged-in', isLoggedIn);
        body.classList.toggle('logged-out', !isLoggedIn); 
        if (connectionPrompt) connectionPrompt.style.display = isLoggedIn ? 'none' : 'block'; 
        if (programEditorArea) programEditorArea.style.display = isLoggedIn ? 'flex' : 'none'; 
        if(signInButton) signInButton.disabled = isLoggedIn || !tokenClient; 
        if(signInButtonPrompt) signInButtonPrompt.disabled = isLoggedIn || !tokenClient; 
        if(driveStatusElement) {
            driveStatusElement.style.display = isLoggedIn ? 'inline-block' : 'none';
            if (!isLoggedIn) driveStatusElement.textContent = '';
        } 
        if(!isLoggedIn) {
            if(programTabsContainer) programTabsContainer.innerHTML = '';
            if(programDisplay) programDisplay.innerHTML = '';
            currentEditingSessionName = null;
            isDirty = false;
        }
        updateEditorActionButtonsState(); 
    }
    
    async function gisInitInternal() { 
        if (!google || !google.accounts || !google.accounts.oauth2) { return; } 
        try { 
            tokenClient = google.accounts.oauth2.initTokenClient({ client_id: GOOGLE_CLIENT_ID, scope: GOOGLE_DRIVE_SCOPES, callback: tokenCallback, error_callback: handleTokenError }); 
            if (signInButton) signInButton.disabled = false;
            if (signInButtonPrompt) signInButtonPrompt.disabled = false; 
            if (tokenClient) tokenClient.requestAccessToken({ prompt: '' });
        } catch (error) {  
            console.error("Erreur initTokenClient (Éditeur):", error);
            showMessage("Erreur initialisation services Google.", 5000, "error");  
            updateAuthUI(false);  
        } 
    }

    function checkAndInitGis() { 
        if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2 && typeof google.accounts.oauth2.initTokenClient === 'function') { 
            gisInitInternal(); 
        } else if (gisCheckRetries < GIS_MAX_RETRIES) { 
            gisCheckRetries++; 
            setTimeout(checkAndInitGis, GIS_CHECK_INTERVAL); 
        } else { 
            showMessage("Impossible de charger l'API Google.", 10000, "error"); 
            if(signInButton) signInButton.disabled = true;
            if(signInButtonPrompt) signInButtonPrompt.disabled = true; 
        } 
    }

    function handleTokenError(error) {
        console.error("Erreur Google Token (Éditeur):", error);
        let userMessage = `Erreur Auth: ${error.type || error.error || 'Inconnue'}`;
        let statusText = 'Erreur Auth';
        if (driveStatusElement) { driveStatusElement.classList.add('error'); driveStatusElement.style.display = 'inline-block'; }
        if (error.type === 'popup_closed' || error.error === 'popup_closed_by_user') {
            userMessage = "Connexion Google annulée."; statusText = 'Annulé';
        }
        showMessage(userMessage, 6000, "error");
        if (driveStatusElement) driveStatusElement.textContent = statusText;
        updateAuthUI(false);
    }
    
    async function tokenCallback(tokenResponse) { 
        if (driveStatusElement) { driveStatusElement.className = ''; driveStatusElement.style.display = 'inline-block'; } 
        if (tokenResponse.error) { handleTokenError(tokenResponse); return; } 
        if (tokenResponse && tokenResponse.access_token) { 
            googleAccessToken = tokenResponse.access_token; 
            showMessage("Connecté ! Chargement du programme...", 2500, "info"); 
            if (driveStatusElement) { driveStatusElement.textContent = 'Chargement...'; driveStatusElement.classList.add('loading'); } 
            try { 
                const programLoadSuccess = await loadFullProgramFromDrive(); 
                if (programLoadSuccess) { 
                    programsLoaded = true;
                    setupTabs();
                    showMessage("Programme chargé.", 3000, "success"); 
                    if (driveStatusElement) { driveStatusElement.textContent = 'Connecté'; driveStatusElement.classList.remove('loading'); driveStatusElement.classList.add('success'); } 
                    handleTabClick(loadedFullProgram.sessions[0]?.nom_session); 
                } else { 
                    showMessage(`'${FULL_PROGRAM_FILENAME}' introuvable ou invalide.`, 8000, "error"); 
                    if (driveStatusElement) { driveStatusElement.textContent = 'Erreur Prog.'; driveStatusElement.classList.add('error'); } 
                    programsLoaded = false; loadedFullProgram = null; 
                } 
            } catch (error) { 
                showMessage("Erreur majeure chargement.", 6000, "error"); 
                if (driveStatusElement) { driveStatusElement.textContent = 'Erreur Données'; driveStatusElement.classList.add('error'); } 
                programsLoaded = false; loadedFullProgram = null; 
            } finally { 
                updateAuthUI(true); 
            } 
        } else { 
            handleTokenError({ error: "invalid_response" }); 
        } 
    }

    function handleAuthClick() {
        if (!tokenClient) { showMessage("Services Google non prêts...", 3000, "info"); return; }
        if (driveStatusElement) { driveStatusElement.textContent = 'Connexion...'; driveStatusElement.classList.add('loading'); driveStatusElement.style.display = 'inline-block'; }
        tokenClient.requestAccessToken({ prompt: 'consent' });
    }
    
    async function findOrCreateFile(filename) { 
        if (!googleAccessToken) return null; 
        const searchUrl = `https://www.googleapis.com/drive/v3/files?q=name='${encodeURIComponent(filename)}'+and+trashed=false&spaces=drive&fields=files(id,name)`;
        try {
            const searchRes = await fetch(searchUrl, { headers: { 'Authorization': `Bearer ${googleAccessToken}` } });
            if (!searchRes.ok) { throw new Error(`Recherche échouée (${searchRes.status})`); }
            const searchData = await searchRes.json();
            if (searchData.files && searchData.files.length > 0) { return searchData.files[0].id; }
            return null;
        } catch (error) {
            console.error(`Erreur Drive (findFile ${filename}):`, error);
            showMessage(`Erreur Drive: ${error.message}`, 6000, "error");
            return null;
        }
    }

    async function readFileContent(fileId) {
        if (!googleAccessToken || !fileId) return null;
        const url = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`;
        try {
            const response = await fetch(url, { headers: { 'Authorization': `Bearer ${googleAccessToken}` } });
            if (!response.ok) {
                if (response.status === 401 || response.status === 403) {
                    showMessage("Session Google expirée.", 5000, "error");
                    googleAccessToken = null; updateAuthUI(false); return null;
                }
                throw new Error(`Lecture échouée (${response.status})`);
            }
            return await response.text();
        } catch (error) {
            console.error(`Erreur Drive (readFile ${fileId}):`, error);
            showMessage(`Erreur Lecture Drive: ${error.message}`, 6000, "error");
            return null;
        }
    }

    async function updateFileContent(fileId, content) {
        if (!googleAccessToken || !fileId) return false;
        if(saveProgramBtn) saveProgramBtn.disabled = true;
        const url = `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`;
        const contentToSend = JSON.stringify(content, null, 2);
        try {
            const response = await fetch(url, { method: 'PATCH', headers: { 'Authorization': `Bearer ${googleAccessToken}`, 'Content-Type': 'application/json; charset=UTF-8' }, body: contentToSend });
            if (!response.ok) { throw new Error(`Écriture échouée (${response.status})`); }
            return true;
        } catch (error) {
            console.error(`Erreur Drive (updateFile ${fileId}):`, error);
            showMessage(`Erreur Écriture Drive: ${error.message}`, 6000, "error");
            return false;
        } finally {
             if(saveProgramBtn) saveProgramBtn.disabled = !isDirty;
        }
    }

    async function loadFullProgramFromDrive() {
        programsLoaded = false;
        loadedFullProgram = null; 
        programFileId = await findOrCreateFile(FULL_PROGRAM_FILENAME); 
        
        if (programFileId) {
            const content = await readFileContent(programFileId);
            if (content) {
                try {
                    let parsedProgram = JSON.parse(content);
                    if (parsedProgram && parsedProgram.sessions && Array.isArray(parsedProgram.sessions)) {
                        loadedFullProgram = parsedProgram; 
                        programsLoaded = true;
                        return true;
                    }
                } catch (e) {
                    showMessage(`Programme '${FULL_PROGRAM_FILENAME}' corrompu.`, 7000, "error");
                }
            }
        }
        return false; 
    }
    
    function setupTabs() {
        if (!programTabsContainer || !loadedFullProgram?.sessions) return;
        programTabsContainer.innerHTML = '';
        loadedFullProgram.sessions.forEach(session => {
            const button = document.createElement('button');
            button.dataset.sessionName = session.nom_session;
            button.textContent = session.nom_session;
            button.addEventListener('click', () => handleTabClick(session.nom_session));
            programTabsContainer.appendChild(button);
        });
    }

    function displayProgram(sessionName) { 
        if (!programDisplay) return; 
        const sessionToDisplay = loadedFullProgram?.sessions.find(s => s.nom_session === sessionName);
        if (!sessionToDisplay) { currentEditingSessionName = null; return; }
        
        currentEditingSessionName = sessionName;
        programDisplay.innerHTML = ''; 
        programTabsContainer.querySelectorAll('button').forEach(btn => btn.classList.toggle('active', btn.dataset.sessionName === sessionName));
        
        sessionToDisplay.exercices_et_pauses?.forEach((step, index) => {
            programDisplay.appendChild(renderStep(step, index));
        });
        
        markAsDirty(false);
        updateEditorActionButtonsState(); 
        if (sortableInstance) sortableInstance.destroy(); 
        if(programDisplay) sortableInstance = new Sortable(programDisplay, { animation: 150, ghostClass: 'sortable-ghost', chosenClass: 'sortable-chosen', handle: '.program-step', onEnd: handleDragEnd }); 
    }

    function renderStep(step, index) { 
        const li = document.createElement('li');
        li.classList.add('program-step', `${step.type}-step`);
        li.dataset.index = index;
        
        const isExercise = step.type.startsWith('exercise'); 
        const iconClass = isExercise ? 'fa-dumbbell' : 'fa-hourglass-half'; 
        const iconColor = isExercise ? 'var(--color-exercise-default)' : 'var(--color-break)';
        li.style.borderLeftColor = iconColor;
        
        let iconHtml = `<i class="fas ${iconClass} step-icon" style="color: ${iconColor};"></i>`;
        
        let fieldsHtml = `<div class="step-field"> <label for="name-${index}">Nom</label> <input type="text" id="name-${index}" data-field="name" value="${step.name || ''}"> </div>`;
        if (isExercise) {
            fieldsHtml += `
                <div class="step-field"> <label for="reps-${index}">Reps</label> <input type="text" id="reps-${index}" data-field="reps" value="${step.reps ?? ''}" placeholder="Ex: 12 ou vide"> </div>
                <div class="step-field"> <label for="reps_unit-${index}">Unité Reps</label> <input type="text" id="reps_unit-${index}" data-field="reps_unit" value="${step.reps_unit || ''}" placeholder="Ex: par jambe"> </div>
                <div class="step-field"> <label for="duration-${index}">Durée (s)</label> <input type="number" id="duration-${index}" data-field="duration" value="${step.duration ?? ''}" placeholder="Ex: 30 ou vide"> </div>
                <div class="step-field"> <label for="unit_duration-${index}">Unité Durée</label> <input type="text" id="unit_duration-${index}" data-field="unit_duration" value="${step.unit_duration || ''}" placeholder="Ex: secondes"> </div>
                <div class="step-field" style="grid-column: 1 / -1;"> <label for="weight_text-${index}">Poids / Résistance (Texte)</label> <input type="text" id="weight_text-${index}" data-field="weight_text" value="${step.weight_text || ''}" placeholder="Ex: Sac 5kg, Élastique Rouge, PDC"> </div>
                <div class="step-field" style="grid-column: 1 / -1;"> <label for="details-${index}">Détails</label> <textarea id="details-${index}" data-field="details">${step.details || ''}</textarea> </div>
                <div class="step-field" style="grid-column: 1 / -1;"> <label for="progression_note-${index}">Note Progression</label> <textarea id="progression_note-${index}" data-field="progression_note">${step.progression_note || ''}</textarea> </div>
                <div class="step-field"> <label for="image_url-${index}">URL Image</label> <input type="text" id="image_url-${index}" data-field="image_url" value="${step.image_url || ''}" placeholder="https://..."> </div>
            `;
        } else { 
            fieldsHtml += ` <div class="step-field"> <label for="duration-${index}">Durée (s)</label> <input type="number" id="duration-${index}" data-field="duration" value="${step.duration || ''}" min="1"> </div> `; 
        }
        
        li.innerHTML = ` ${iconHtml} <div class="step-content"> ${fieldsHtml} </div> <div class="step-actions"> <button class="delete-step-btn" title="Supprimer"><i class="fas fa-trash-alt"></i></button> </div> `; 
        
        li.querySelector('.delete-step-btn').addEventListener('click', () => handleDeleteStep(index)); 
        li.querySelectorAll('input, textarea').forEach(input => {
            input.addEventListener('input', () => markAsDirty(true));
            input.addEventListener('change', (e) => handleEditStep(index, e.target.dataset.field, e.target.value));
        }); 
        
        return li; 
    }

    function handleTabClick(sessionName) {
        if (!sessionName || sessionName === currentEditingSessionName) return;
        if (isDirty && !confirm(`Modifications non sauvegardées. Changer de session ?`)) return;
        displayProgram(sessionName);
    }
    
    function handleAddStep(stepType) {
        if (!currentEditingSessionName) return;
        const currentSession = loadedFullProgram.sessions.find(s => s.nom_session === currentEditingSessionName);
        if (!currentSession) return;
        
        let newStep = {};
        if (stepType === 'exercise') {
            newStep = { type: "exercise", name: "Nouvel Exercice", reps: 10, weight_text: "" };
        } else {
            newStep = { type: "break", name: "Repos", duration: 60 };
        }
        
        currentSession.exercices_et_pauses.push(newStep);
        displayProgram(currentEditingSessionName);
        markAsDirty(true);
        programDisplay.scrollTop = programDisplay.scrollHeight;
        showMessage(`${stepType === 'exercise' ? 'Exercice' : 'Pause'} ajouté.`, 1500, "success");
    }

    function handleDeleteStep(index) {
        if (!currentEditingSessionName) return;
        const currentSession = loadedFullProgram.sessions.find(s => s.nom_session === currentEditingSessionName);
        if (!currentSession?.exercices_et_pauses?.[index]) return;
        
        const stepName = currentSession.exercices_et_pauses[index].name;
        if (confirm(`Supprimer "${stepName}" ?`)) {
            currentSession.exercices_et_pauses.splice(index, 1);
            displayProgram(currentEditingSessionName);
            markAsDirty(true);
            showMessage("Étape supprimée.", 1500, "info");
        }
    }

    function handleEditStep(index, field, value) {
        if (!currentEditingSessionName) return;
        const currentSession = loadedFullProgram.sessions.find(s => s.nom_session === currentEditingSessionName);
        const step = currentSession?.exercices_et_pauses?.[index];
        if (!step) return;

        const numericFields = ['reps', 'duration'];
        let processedValue = value;
        if (numericFields.includes(field)) {
            processedValue = value.trim() === '' ? null : Number(value);
            if (isNaN(processedValue)) processedValue = value;
        }
        
        step[field] = processedValue;
        
        // Clean up conflicting fields
        if (field === 'duration' && processedValue) {
            delete step.reps;
        } else if (field === 'reps' && processedValue) {
            delete step.duration;
        }
        
        // Clean up old weight fields if weight_text is used
        if(field === 'weight_text') {
            delete step.weight;
            delete step.unit;
        }
        
        markAsDirty(true);
    }

    function handleDragEnd(event) {
        const { oldIndex, newIndex } = event;
        if (oldIndex === newIndex || !currentEditingSessionName) return;
        const currentSession = loadedFullProgram.sessions.find(s => s.nom_session === currentEditingSessionName);
        if (!currentSession?.exercices_et_pauses) return;
        
        const [movedItem] = currentSession.exercices_et_pauses.splice(oldIndex, 1);
        currentSession.exercices_et_pauses.splice(newIndex, 0, movedItem);
        
        displayProgram(currentEditingSessionName);
        markAsDirty(true);
    }
    
    async function handleSaveProgram() { 
        if (!isDirty) { showMessage("Aucune modification.", 2000, "info"); return; } 
        if (!programFileId) { showMessage("ID de fichier programme manquant.", 4000, "error"); return; } 
        
        if(saveProgramBtn) { saveProgramBtn.disabled = true; saveProgramBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Sauvegarde...`; } 
        const success = await updateFileContent(programFileId, loadedFullProgram); 
        
        if (success) { 
            markAsDirty(false);
            showMessage(`Programme sauvegardé sur Drive !`, 3000, "success"); 
        } else { 
            showMessage(`Échec de la sauvegarde.`, 5000, "error"); 
        }
        if(saveProgramBtn) { saveProgramBtn.innerHTML = `<i class="fas fa-save"></i> Sauvegarder Programme`; updateSaveButtonState(); } 
    }

    function markAsDirty(dirtyState) {
        isDirty = dirtyState;
        updateSaveButtonState();
    }

    function updateSaveButtonState() {
        if (!saveProgramBtn) return;
        saveProgramBtn.disabled = !isDirty || !googleAccessToken || !programFileId ;
    }

    function updateEditorActionButtonsState() {
        const enable = googleAccessToken && programsLoaded && !!currentEditingSessionName;
        if(addExerciseBtn) addExerciseBtn.disabled = !enable;
        if(addBreakBtn) addBreakBtn.disabled = !enable;
        updateSaveButtonState();
    }

    function loadSavedTheme() {
        const savedTheme = localStorage.getItem('armorWorkoutEditorTheme') || 'dark';
        document.body.classList.remove('light-theme', 'dark-theme');
        document.body.classList.add(savedTheme + '-theme');
        if(document.getElementById('current-year-editor')) document.getElementById('current-year-editor').textContent = new Date().getFullYear();
    }

    function showMessage(msg, duration = 3000, type = "info") { 
        if (!messageArea) return;
        messageArea.textContent = msg;
        messageArea.className = 'message-area';
        messageArea.classList.add(type); 
        messageArea.classList.add('visible');
        if (messageTimeoutId) clearTimeout(messageTimeoutId); 
        messageTimeoutId = setTimeout(() => { messageArea.classList.remove('visible'); }, duration);
    }

    function initializeDOMReferences() {
        signInButton = document.getElementById('signin-button'); 
        driveStatusElement = document.getElementById('drive-status');
        signInButtonPrompt = document.getElementById('signin-button-prompt');
        connectionPrompt = document.getElementById('connection-prompt');
        programEditorArea = document.getElementById('program-editor-area');
        programTabsContainer = document.getElementById('program-tabs');
        programDisplay = document.getElementById('program-display');
        addExerciseBtn = document.getElementById('add-exercise-btn');
        addBreakBtn = document.getElementById('add-break-btn');
        saveProgramBtn = document.getElementById('save-program-btn');
        messageArea = document.getElementById('message-area');
    }

    function addEventListeners() {
        if(signInButton) signInButton.addEventListener('click', handleAuthClick);
        if(signInButtonPrompt) signInButtonPrompt.addEventListener('click', handleAuthClick);
        if(addExerciseBtn) addExerciseBtn.addEventListener('click', () => handleAddStep('exercise'));
        if(addBreakBtn) addBreakBtn.addEventListener('click', () => handleAddStep('break'));
        if(saveProgramBtn) saveProgramBtn.addEventListener('click', handleSaveProgram);
        window.addEventListener('beforeunload', (event) => {
            if (isDirty) { event.preventDefault(); event.returnValue = ''; }
        });
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        initializeDOMReferences(); 
        addEventListeners(); 
        loadSavedTheme();
        updateAuthUI(false); 
        checkAndInitGis(); 
    });
</script>

</body>
</html>
