<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArmorWorkout - Éditeur de Programme</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&family=Orbitron:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color-dark: #030712; 
            --secondary-bg-color-dark: #0B132B; 
            --primary-text-color-dark: #F0F4F8; 
            --secondary-text-color-dark: #A0AEC0; 
            --border-color-dark: #1E293B; 
            --electric-blue: #00BFFF; 
            --electric-cyan: #22D3EE; 
            --electric-blue-light: #4D94FF; 
            --glow-accent: #0AF; 
            --electric-blue-rgb: 0, 191, 255;
            --electric-cyan-rgb: 34, 211, 238;
            --glow-accent-rgb: 0, 170, 255;
            --secondary-bg-color-dark-rgb: 11, 19, 43;
            --bg-color-dark-rgb: 3, 7, 18;
            --neon-pink: #FF1493; 
            --neon-purple: #9400D3; 
            --neon-green: #39FF14; 
            --neon-red: #FF3131; 
            --neon-yellow: #FFF01F; 
            --neon-pink-rgb: 255, 20, 147;
            --neon-purple-rgb: 148, 0, 211;
            --neon-green-rgb: 57, 255, 20;
            --neon-red-rgb: 255, 49, 49;
            --neon-yellow-rgb: 255, 240, 31;
            --glow-red: 0 0 8px var(--neon-red), 0 0 12px rgba(var(--neon-red-rgb),0.7);
            --glow-green: 0 0 8px var(--neon-green), 0 0 12px rgba(var(--neon-green-rgb),0.7);
            --glow-yellow: 0 0 8px var(--neon-yellow), 0 0 12px rgba(var(--neon-yellow-rgb),0.7);
            --glow-pink: 0 0 8px var(--neon-pink), 0 0 12px rgba(var(--neon-pink-rgb),0.7);
            --glow-purple: 0 0 8px var(--neon-purple), 0 0 12px rgba(var(--neon-purple-rgb),0.7);
            --electric-yellow: var(--neon-yellow); 
            --electric-yellow-rgb: var(--neon-yellow-rgb);
            --color-exercise-default: var(--neon-pink); /* Couleur par défaut pour les nouveaux exercices */
            --color-break: var(--neon-yellow);
            --font-family-main: 'Inter', sans-serif;
            --font-family-titles: 'Orbitron', sans-serif; 
            --border-radius-lg: 10px;
            --border-radius-md: 8px;
            --border-radius-sm: 6px;
            --transition-speed: 0.3s;
            --bg-color: var(--bg-color-dark);
            --secondary-bg-color: var(--secondary-bg-color-dark);
            --primary-text-color: var(--primary-text-color-dark);
            --secondary-text-color: var(--secondary-text-color-dark);
            --border-color: var(--border-color-dark);
            --accent-border-color: rgba(var(--electric-blue-rgb), 0.4); 
            --input-bg: #1A202C; 
            --link-color: var(--electric-cyan);
            --button-connect-color: var(--neon-green);
            --button-connect-glow: var(--glow-green);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; font-size: 16px; }
        body {
            font-family: var(--font-family-main); background-color: var(--bg-color); color: var(--primary-text-color);
            line-height: 1.65; transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
            display: flex; flex-direction: column; min-height: 100vh;
            -webkit-font-smoothing: antialiased; overflow-x: hidden;
            background-image: radial-gradient(ellipse at center, rgba(var(--electric-blue-rgb), 0.08) 0%, transparent 60%),
                              linear-gradient(0deg, rgba(var(--bg-color-dark-rgb), 0.5) 0%, rgba(var(--bg-color-dark-rgb), 0.9) 100%);
            position: relative; 
        }
        body::before { 
            content: ""; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-image: linear-gradient(rgba(var(--electric-blue-rgb), 0.05) 1px, transparent 1px),
                              linear-gradient(90deg, rgba(var(--electric-blue-rgb), 0.05) 1px, transparent 1px);
            background-size: 30px 30px; z-index: -1; opacity: 0.7;
        }
        .container { max-width: 900px; margin: 0 auto; padding: 30px 20px; width: 100%; flex-grow: 1; display: flex; flex-direction: column; }
        
        header {
            padding: 15px 0; background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.5); backdrop-filter: blur(8px) saturate(150%);
            border-bottom: 1px solid rgba(var(--electric-blue-rgb), 0.3); box-shadow: 0 2px 15px rgba(var(--electric-blue-rgb), 0.1);
            position: sticky; top:0; z-index: 1000; 
        }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1100px; margin: 0 auto; padding: 0 25px; flex-wrap: wrap; gap: 15px 20px; }
        header h1 { font-size: 1.6em; color: var(--primary-text-color); margin: 0; font-weight: 700; display: flex; align-items: center; gap: 10px; font-family: var(--font-family-titles); text-shadow: 0 0 8px rgba(var(--electric-cyan-rgb), 0.7); }
        header h1 i { color: var(--electric-cyan); animation: subtlePulse 3s infinite ease-in-out; }
        @keyframes subtlePulse { 0%, 100% { opacity: 0.7; transform: scale(1); } 50% { opacity: 1; transform: scale(1.015); } }
        .header-link { color: var(--secondary-text-color); font-size: 0.9em; text-decoration: none; display: inline-flex; align-items: center; gap: 5px; transition: color var(--transition-speed) ease; padding: 8px 12px; border-radius: var(--border-radius-sm); border: 1px solid transparent; }
        .header-link:hover { color: var(--link-color); background-color: rgba(var(--electric-blue-rgb), 0.1); border-color: rgba(var(--electric-blue-rgb), 0.4); text-shadow: 0 0 5px rgba(var(--electric-blue-rgb), 0.5); }
        
        .header-actions { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .auth-controls { display: flex; gap: 10px; align-items: center; }
        .auth-controls button, .nav-buttons a {
            background: none; border: 1px solid var(--accent-border-color); color: var(--secondary-text-color); padding: 6px 14px;
            border-radius: var(--border-radius-md); font-size: 0.85em; font-weight: 500; cursor: pointer;
            transition: all var(--transition-speed) ease; display: inline-flex; align-items: center; gap: 6px; text-decoration: none;
        }
        .auth-controls button:disabled, .nav-buttons a.disabled-link-look { opacity: 0.5; cursor: not-allowed; pointer-events: auto; border-color: var(--border-color) !important; color: var(--secondary-text-color) !important; box-shadow: none !important; background-color: transparent !important; }
        .auth-controls button:not(:disabled):hover, .nav-buttons a:not(.disabled-link-look):hover { border-color: var(--primary-text-color); color: var(--primary-text-color); }
        #signin-button, #signin-button-prompt { border-color: var(--button-connect-color); color: var(--button-connect-color); }
        #signin-button:not(:disabled):hover, #signin-button-prompt:not(:disabled):hover { background-color: rgba(var(--neon-green-rgb), 0.1); box-shadow: var(--glow-green); border-color: var(--neon-green); }
        #drive-status { font-size: 0.8em; color: var(--secondary-text-color); margin-left: 5px; transition: opacity 0.3s, color 0.3s, border-color 0.3s; min-width: fit-content; text-align: right; font-style: normal; padding: 4px 8px; background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.5); border-radius: var(--border-radius-sm); border: 1px solid var(--border-color); display: none; }
        #drive-status.loading { color: var(--neon-yellow); border-color: var(--neon-yellow); animation: blink-border 1.5s infinite ease-in-out; }
        #drive-status.error { color: var(--neon-red); border-color: var(--neon-red); }
        #drive-status.success { color: var(--neon-green); border-color: var(--neon-green); }
        @keyframes blink-border { 50% { border-color: rgba(var(--neon-yellow-rgb), 0.4); } }
        
        body.logged-out #signin-button { display: inline-flex; } body.logged-out #drive-status { display: none; }
        body.logged-in #signin-button { display: none; } body.logged-in #drive-status { display: inline-block; }

        .nav-buttons { display: flex; gap: 10px; margin-bottom: 20px; padding: 0; justify-content: center; } 
        .nav-buttons a { padding: 8px 16px; font-size: 0.9em; }
        .nav-buttons a:hover { background-color: rgba(var(--electric-blue-rgb), 0.1); border-color: rgba(var(--electric-blue-rgb), 0.4); text-shadow: 0 0 5px rgba(var(--electric-blue-rgb), 0.5); color: var(--electric-blue); }

        main { flex-grow: 1; display: flex; flex-direction: column; align-items: center; padding-top: 20px; } 
        main h2 { font-size: 1.8em; font-weight: 700; margin-bottom: 25px; text-align: center; color: var(--primary-text-color); display: flex; align-items: center; gap: 12px; justify-content: center; font-family: var(--font-family-titles); text-shadow: 0 0 8px rgba(var(--electric-cyan-rgb), 0.7);}
        main h2 i { color: var(--electric-cyan); animation: subtlePulse 3s infinite ease-in-out; }

        #connection-prompt { text-align: center; padding: 40px 20px; background-color: var(--secondary-bg-color); border-radius: var(--border-radius-lg); border: 1px dashed var(--border-color); margin: 20px auto; max-width: 600px; }
        #connection-prompt p { margin-bottom: 15px; color: var(--secondary-text-color); }
        #connection-prompt button { padding: 8px 18px; border: 1px solid; font-size: 0.9em; }

        #program-editor-area { width: 100%; background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.6); backdrop-filter: blur(10px) saturate(130%); border-radius: var(--border-radius-lg); border: 1px solid rgba(var(--electric-blue-rgb), 0.2); padding: 25px; display: none; flex-direction: column; gap: 25px; box-shadow: 0 5px 25px rgba(var(--bg-color-dark-rgb), 0.5), inset 0 0 15px rgba(var(--electric-blue-rgb), 0.1); }
        body.logged-in #program-editor-area { display: flex; }

        .program-tabs { display: flex; gap: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; flex-wrap: wrap; }
        .program-tabs button { padding: 8px 18px; font-size: 1em; font-weight: 500; border: none; background: none; color: var(--secondary-text-color); cursor: pointer; transition: all var(--transition-speed) ease; border-radius: var(--border-radius-md); position: relative; }
        .program-tabs button:disabled { color: rgba(var(--secondary-text-color-dark-rgb), 0.5); cursor: not-allowed; opacity: 0.6; }
        .program-tabs button:not(:disabled):hover { background-color: rgba(var(--electric-blue-rgb), 0.1); color: var(--primary-text-color); }
        .program-tabs button.active { color: var(--electric-cyan); background-color: rgba(var(--electric-cyan-rgb), 0.15); font-weight: 700; border: 1px solid var(--electric-cyan); box-shadow: 0 0 10px rgba(var(--electric-cyan-rgb),0.3); }
        .program-tabs button.is-dirty::after { content: '●'; position: absolute; top: 5px; right: 8px; font-size: 0.7em; color: var(--neon-orange); animation: blink-dot 1.5s infinite ease-in-out; }
        @keyframes blink-dot { 50% { opacity: 0.3; } }

        #program-display { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 15px; min-height: 200px; background-color: rgba(var(--bg-color-dark-rgb), 0.15); border: 1px dashed var(--border-color); border-radius: var(--border-radius-md); padding: 15px; }
        #program-display:empty::before { content: "Connectez-vous et assurez-vous que '" + FULL_PROGRAM_FILENAME + "' existe sur votre Drive."; display: block; text-align: center; padding: 50px 20px; color: var(--secondary-text-color); font-style: italic; }

        .program-step { background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: var(--border-radius-md); padding: 15px; display: grid; grid-template-columns: auto 1fr auto; gap: 10px 15px; align-items: start; position: relative; transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease; cursor: grab; }
        /* La couleur de la bordure gauche sera définie dynamiquement par JS */
        .program-step:hover { border-color: var(--accent-border-color); box-shadow: 0 2px 8px rgba(var(--bg-color-dark-rgb),0.3); }
        .step-icon { font-size: 1.3em; padding-top: 5px; grid-column: 1 / 2; align-self: center; transition: color var(--transition-speed) ease; }
        /* La couleur de l'icône sera définie dynamiquement par JS */
        .break-step .step-icon { color: var(--color-break); } /* Garder pour les pauses */
        
        .step-content { grid-column: 2 / 3; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; }
        .step-field { display: flex; flex-direction: column; gap: 4px; }
        .step-field label { font-size: 0.8em; font-weight: 500; color: var(--secondary-text-color); }
        .step-field input[type="text"], .step-field input[type="number"], .step-field textarea, .step-field select { width: 100%; padding: 8px 10px; font-size: 0.9em; border-radius: var(--border-radius-sm); border: 1px solid var(--border-color); background-color: var(--input-bg); color: var(--primary-text-color); transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease; }
        .step-field input:focus, .step-field textarea:focus, .step-field select:focus { border-color: var(--electric-cyan); outline: none; box-shadow: 0 0 0 2px rgba(var(--electric-cyan-rgb), 0.3); }
        .step-field textarea { min-height: 60px; resize: vertical; font-family: inherit;}
        .step-field input[type="number"] { -moz-appearance: textfield; width: 80px; }
        .step-field input[type="number"]::-webkit-outer-spin-button, .step-field input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .step-field select { appearance: none; -webkit-appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23A0AEC0'%3E%3Cpath fill-rule='evenodd' d='M4.22 6.22a.75.75 0 011.06 0L8 8.94l2.72-2.72a.75.75 0 111.06 1.06l-3.25 3.25a.75.75 0 01-1.06 0L4.22 7.28a.75.75 0 010-1.06z' clip-rule='evenodd'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 8px center; background-size: 16px 16px; padding-right: 30px; }
        .step-field option { background-color: var(--secondary-bg-color); color: var(--primary-text-color); }
        
        .color-palette { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; grid-column: 1 / -1; }
        .color-swatch { width: 22px; height: 22px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s ease, border-color 0.2s ease; }
        .color-swatch:hover { transform: scale(1.1); }
        .color-swatch.active { border-color: var(--primary-text-color); box-shadow: 0 0 0 2px var(--accent-border-color); transform: scale(1.15); }

        .step-actions { grid-column: 3 / 4; display: flex; flex-direction: column; gap: 8px; align-items: center; padding-top: 5px; }
        .step-actions button { background: none; border: none; color: var(--secondary-text-color); font-size: 1.1em; cursor: pointer; padding: 5px; transition: color var(--transition-speed) ease; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .step-actions button:hover { color: var(--primary-text-color); background-color: rgba(var(--primary-text-color-dark-rgb), 0.1); }
        .step-actions .delete-step-btn:hover { color: var(--neon-red); background-color: rgba(var(--neon-red-rgb), 0.1); }

        .program-step.sortable-ghost { opacity: 0.4; background-color: rgba(var(--electric-blue-rgb), 0.1); border-style: dashed; }
        .program-step.sortable-chosen { cursor: grabbing; border-color: var(--electric-cyan); box-shadow: 0 4px 12px rgba(var(--electric-cyan-rgb), 0.3); }

        .editor-actions { display: flex; justify-content: space-between; align-items: center; gap: 15px; flex-wrap: wrap; border-top: 1px solid var(--border-color); padding-top: 25px; margin-top: 10px; }
        .add-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .editor-actions button { padding: 9px 20px; font-size: 0.95em; font-weight: 500; border-radius: var(--border-radius-md); cursor: pointer; transition: all var(--transition-speed) ease; display: inline-flex; align-items: center; gap: 8px; border: 1px solid transparent; }
        .editor-actions button:disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; }
        #add-exercise-btn { border-color: var(--color-exercise-default); color: var(--color-exercise-default); background: transparent; } /* Couleur par défaut pour bouton exercice */
        #add-exercise-btn:not(:disabled):hover { background-color: rgba(var(--neon-pink-rgb), 0.1); box-shadow: var(--glow-pink); }
        #add-break-btn { border-color: var(--color-break); color: var(--color-break); background: transparent; }
        #add-break-btn:not(:disabled):hover { background-color: rgba(var(--neon-yellow-rgb), 0.1); box-shadow: var(--glow-yellow); }
        #save-program-btn { border: none; background-color: var(--neon-green); color: #030712; box-shadow: 0 2px 5px rgba(0,0,0,0.2); } 
        #save-program-btn:not(:disabled):hover { filter: brightness(1.1); box-shadow: 0 4px 10px rgba(0,0,0,0.25), var(--glow-green); }
        #save-program-btn:disabled { background-color: var(--secondary-text-color); color: rgba(var(--bg-color-dark-rgb),0.7); box-shadow: none; border-color: var(--secondary-text-color); }

        .message-area { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.9); color: var(--primary-text-color); border: 1px solid var(--border-color); padding: 12px 25px; border-radius: var(--border-radius-md); z-index: 3000; opacity: 0; transition: opacity 0.5s ease, transform 0.5s ease, bottom 0.5s ease, background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; pointer-events: none; font-size: 0.95em; box-shadow: 0 4px 15px rgba(0,0,0,0.2); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); max-width: 90%; text-align: center; }
        .message-area.visible { opacity: 1; transform: translate(-50%, 0); bottom: 40px; pointer-events: auto; }
        .message-area.error { background-color: rgba(var(--neon-red-rgb), 0.8); color: #fff; border-color: var(--neon-red); text-shadow: 0 0 5px rgba(0,0,0,0.5); box-shadow: 0 4px 15px rgba(0,0,0,0.3), 0 0 10px var(--glow-red); }
        .message-area.success { background-color: rgba(var(--neon-green-rgb), 0.8); color: #030712; border-color: var(--neon-green); text-shadow: none; box-shadow: 0 4px 15px rgba(0,0,0,0.3), 0 0 10px var(--glow-green); }
        .message-area.info { background-color: rgba(var(--electric-blue-rgb), 0.8); color: #fff; border-color: var(--electric-blue); box-shadow: 0 4px 15px rgba(0,0,0,0.3), 0 0 10px var(--glow-blue); }

        footer { color: var(--secondary-text-color); opacity: 0.7; border-top: 1px solid rgba(var(--electric-blue-rgb), 0.2); margin-top: 60px; padding: 25px; text-align: center; transition: border-color var(--transition-speed) ease, color var(--transition-speed) ease; background-color: rgba(var(--bg-color-dark-rgb), 0.7); backdrop-filter: blur(3px); }
        footer a { color: var(--link-color); text-decoration: none; transition: color var(--transition-speed) ease; }
        footer a:hover { color: var(--primary-text-color); text-decoration: underline; text-shadow: 0 0 8px var(--link-color); }
        footer .fab.fa-google-drive { color: var(--neon-green); }

        @media (max-width: 768px) { .container { padding: 20px 15px; } main h2 { font-size: 1.4em; } .program-step { grid-template-columns: auto 1fr; } .step-actions { grid-column: 2 / 3; flex-direction: row; justify-content: flex-end; padding-top: 0; align-items: center; } .step-content { grid-template-columns: 1fr; } }
        @media (max-width: 480px) { .header-content { padding: 0 15px; } .header-actions { gap: 10px; } .auth-controls button, .nav-buttons a { padding: 5px 10px; font-size: 0.8em; } main h2 { font-size: 1.3em; } .program-tabs { gap: 5px; } .program-tabs button { padding: 6px 12px; font-size: 0.9em; } .program-step { padding: 12px; } .step-field input, .step-field textarea, .step-field select { padding: 6px 8px; font-size: 0.85em;} .editor-actions { flex-direction: column; align-items: stretch; } .editor-actions button { width: 100%; justify-content: center; } }

    </style>
</head>
<body class="logged-out dark-theme"> 

<header>
    <div class="header-content">
        <a href="index.html" class="header-link"><i class="fas fa-arrow-left"></i> Retour au Timer</a>
        <h1><i class="fas fa-shield-halved"></i> ArmorWorkout</h1>
        <div class="header-actions">
            <div class="auth-controls">
                <button id="signin-button" disabled><i class="fab fa-google"></i> Connecter Drive</button>
                <!-- Bouton Déconnexion Supprimé -->
            </div>
            <span id="drive-status"></span>
        </div>
    </div>
</header>

<div class="container">
     <div class="nav-buttons">
        <a href="index.html" class="auth-controls button-nav"><i class="fas fa-home"></i> Accueil Timer</a>
        <a href="muscle-evolution.html" class="auth-controls button-nav"><i class="fas fa-chart-line"></i> Évolution Musculaire</a>
    </div>
    <main>
        <h2><i class="fas fa-edit"></i> Éditeur de Programme</h2>

        <div id="connection-prompt">
            <p>Veuillez vous connecter à votre compte Google Drive pour charger et modifier votre programme d'entraînement.</p>
            <button id="signin-button-prompt" disabled><i class="fab fa-google"></i> Connecter Drive</button>
        </div>

        <div id="program-editor-area">
            <div class="program-tabs" id="program-tabs">
                <button data-session-name="PUSH V4 - Pectoraux, Épaules, Triceps" disabled>Push</button>
                <button data-session-name="PULL V5.2 - Dos, Arrière Épaules, Biceps" disabled>Pull</button>
                <button data-session-name="LEGS & ABDOS V1.7 - Jambes & Sangle Abdominale" disabled>Legs</button>
            </div>

            <ul id="program-display"></ul>

            <div class="editor-actions">
                <div class="add-buttons">
                    <button id="add-exercise-btn" disabled><i class="fas fa-dumbbell"></i> Ajouter Exercice</button>
                    <button id="add-break-btn" disabled><i class="fas fa-hourglass-half"></i> Ajouter Pause</button>
                </div>
                <button id="save-program-btn" disabled><i class="fas fa-save"></i> Sauvegarder Programme Complet</button>
            </div>
        </div>
    </main>
</div>

<footer>
    <p>© <span id="current-year-editor">2024</span> ArmorWorkout Éditeur. Programme stocké sur <i class="fab fa-google-drive" aria-hidden="true"></i> Google Drive.</p>
     <p><a href="index.html">Retourner au Timer</a> | <a href="https://github.com/ironworkout/armorworkout" target="_blank" rel="noopener noreferrer"><i class="fab fa-github" aria-hidden="true"></i> Voir sur GitHub</a></p>
</footer>

<div id="message-area" class="message-area" role="status" aria-live="polite"></div>

<script async defer src="https://accounts.google.com/gsi/client"></script>
<script>
    const GOOGLE_CLIENT_ID = "731283926358-viam3ulpgna14flfdeb9m92l8s620hoi.apps.googleusercontent.com";
    const GOOGLE_DRIVE_SCOPES = 'https://www.googleapis.com/auth/drive.file';
    const FULL_PROGRAM_FILENAME = "programmeCompletHypertrophieElite_v1.json"; 
    const GIS_CHECK_INTERVAL = 100; 
    const GIS_MAX_RETRIES = 50;

    let loadedFullProgram = null; 
    const stepColorPalette = ['#22D3EE', '#00BFFF', '#4D94FF', '#FF1493', '#9400D3', '#39FF14', '#A78BFA', '#FF7B72', '#FACC15', '#F0F4F8'];


    let signInButton, driveStatusElement, 
        signInButtonPrompt, connectionPrompt, programEditorArea,
        programTabsContainer, programDisplay, addExerciseBtn, addBreakBtn, saveProgramBtn,
        messageArea;

    let googleAccessToken = null;
    let tokenClient = null;
    let programFileId = null; 
    let programsLoaded = false; 
    let currentEditingSessionName = null; 
    let isDirty = false;
    let currentTheme = 'dark';
    let messageTimeoutId = null;
    let sortableInstance = null;
    let audioContext = null;
    let gisCheckRetries = 0;

    function updateAuthUI(isLoggedIn) { 
        const body = document.body; body.classList.toggle('logged-in', isLoggedIn); body.classList.toggle('logged-out', !isLoggedIn); 
        if (connectionPrompt) connectionPrompt.style.display = isLoggedIn && programsLoaded && loadedFullProgram ? 'none' : 'block'; 
        if (programEditorArea) programEditorArea.style.display = isLoggedIn && programsLoaded && loadedFullProgram ? 'flex' : 'none'; 
        if(signInButton) signInButton.disabled = isLoggedIn || !tokenClient; 
        if(signInButtonPrompt) signInButtonPrompt.disabled = isLoggedIn || !tokenClient; 
        if(driveStatusElement) { driveStatusElement.style.display = isLoggedIn ? 'inline-block' : 'none'; if (!isLoggedIn) driveStatusElement.textContent = ''; } 
        programTabsContainer?.querySelectorAll('button').forEach(btn => { btn.disabled = !isLoggedIn || !programsLoaded || !loadedFullProgram; btn.classList.remove('is-dirty'); }); 
        if (!isLoggedIn) { if(programDisplay) programDisplay.innerHTML = ''; currentEditingSessionName = null; isDirty = false; } 
        updateEditorActionButtonsState(); 
    }

    function initAudioContext() { if (!audioContext && typeof AudioContext !== 'undefined') { try { audioContext = new AudioContext(); } catch (e) { console.warn("AudioContext non supporté ou bloqué.", e); } } }
    
    async function gisInitInternal() { 
        const clientIdValid = GOOGLE_CLIENT_ID && !GOOGLE_CLIENT_ID.includes("YOUR_CLIENT_ID"); 
        if (!clientIdValid) { console.error("CRITICAL: GOOGLE_CLIENT_ID non configuré !"); showMessage("Erreur critique : ID Client Google manquant.", 10000, "error"); if(signInButton) signInButton.disabled = true; if(signInButtonPrompt) signInButtonPrompt.disabled = true; return; } 
        if (!google || !google.accounts || !google.accounts.oauth2) { console.error("L'API Google Identity Services n'est pas prête (Éditeur)."); showMessage("Erreur chargement API Google.", 6000, "error"); if(signInButton) signInButton.disabled = true; if(signInButtonPrompt) signInButtonPrompt.disabled = true; return; } 
        try { 
            tokenClient = google.accounts.oauth2.initTokenClient({ client_id: GOOGLE_CLIENT_ID, scope: GOOGLE_DRIVE_SCOPES, callback: tokenCallback, error_callback: handleTokenError }); 
            console.log("Token Client Google initialisé (Éditeur). Tentative de reconnexion silencieuse..."); 
            if (signInButton) signInButton.disabled = false; if (signInButtonPrompt) signInButtonPrompt.disabled = false; 
            if (tokenClient) tokenClient.requestAccessToken({ prompt: '' });
        } catch (error) {  
            console.error("Erreur lors de l'appel à google.accounts.oauth2.initTokenClient (Éditeur):", error); showMessage("Erreur initialisation services Google.", 5000, "error");  
            updateAuthUI(false);  
            if (driveStatusElement) { driveStatusElement.textContent = 'Erreur Init Auth'; driveStatusElement.classList.remove('loading', 'success'); driveStatusElement.classList.add('error'); driveStatusElement.style.display = 'inline-block'; }  
            if(signInButton) signInButton.disabled = true; if(signInButtonPrompt) signInButtonPrompt.disabled = true;  
        } 
    }

    function checkAndInitGis() { 
        console.log(`Vérification GIS (Éditeur - Essai ${gisCheckRetries + 1}/${GIS_MAX_RETRIES})...`);
        if (typeof google !== 'undefined' && typeof google.accounts !== 'undefined' && typeof google.accounts.oauth2 !== 'undefined' && typeof google.accounts.oauth2.initTokenClient === 'function') { 
            console.log("API Google OAuth2 détectée (Éditeur)! Lancement de gisInitInternal.");
            gisInitInternal(); 
        } else if (gisCheckRetries < GIS_MAX_RETRIES) { 
            gisCheckRetries++; 
            setTimeout(checkAndInitGis, GIS_CHECK_INTERVAL); 
        } else { 
            console.error(`Échec de la détection de l'API Google (Éditeur) après ${GIS_MAX_RETRIES} essais.`); 
            showMessage("Impossible de charger les services Google. Vérifiez votre connexion ou bloqueur de script.", 10000, "error"); 
            if(signInButton) signInButton.disabled = true; if(signInButtonPrompt) signInButtonPrompt.disabled = true; 
        } 
    }

    function handleTokenError(error) { console.error("Erreur Google Token Client (Éditeur):", error); let userMessage = `Erreur Auth Google: ${error.type || error.error || 'Inconnue'}`; let statusText = 'Erreur Auth'; if (driveStatusElement) { driveStatusElement.classList.remove('loading', 'success'); driveStatusElement.classList.add('error'); driveStatusElement.style.display = 'inline-block'; } if (error.error === 'popup_closed_by_user' || error.error === 'user_cancel' || error.type === 'popup_closed') { userMessage = "Connexion Google annulée."; statusText = 'Annulé'; } else if (error.error === 'popup_failed_to_open' || error.type === 'popup_failed_to_open') { userMessage = "Pop-up Google bloquée."; statusText = 'Popup Bloqué'; } else if (error.error === 'access_denied' || error.type === 'access_denied') { userMessage = "Accès Drive refusé."; statusText = 'Accès Refusé'; } else if (error.error === 'token_network_error') { userMessage = "Erreur réseau lors de l'auth."; statusText = 'Erreur Réseau'; } else if (error.error === 'invalid_grant') { userMessage = "Autorisation invalide."; statusText = 'Autorisation Invalide'; googleAccessToken = null; } showMessage(userMessage, 6000, "error"); if (driveStatusElement) driveStatusElement.textContent = statusText; updateAuthUI(false); }
    
    async function tokenCallback(tokenResponse) { 
        console.log("tokenCallback (Éditeur) déclenché. Réponse:", tokenResponse);
        if (driveStatusElement) { driveStatusElement.classList.remove('loading', 'error', 'success'); driveStatusElement.style.display = 'inline-block'; } 
        if (tokenResponse.error) { handleTokenError(tokenResponse); return; } 
        if (tokenResponse && tokenResponse.access_token) { 
            googleAccessToken = tokenResponse.access_token; 
            showMessage("Connecté ! Chargement du programme...", 2500, "info"); 
            if (driveStatusElement) { driveStatusElement.textContent = 'Chargement...'; driveStatusElement.classList.add('loading'); } 
            try { 
                const programLoadSuccess = await loadFullProgramFromDrive(); 
                if (programLoadSuccess && loadedFullProgram && loadedFullProgram.sessions && loadedFullProgram.sessions.length > 0) { 
                    programsLoaded = true; 
                    showMessage("Programme chargé depuis Drive.", 3000, "success"); 
                    if (driveStatusElement) { driveStatusElement.textContent = 'Connecté'; driveStatusElement.classList.remove('loading', 'error'); driveStatusElement.classList.add('success'); } 
                    handleTabClick(loadedFullProgram.sessions[0]?.nom_session); 
                } else { 
                    showMessage(`'${FULL_PROGRAM_FILENAME}' non trouvé, vide, ou invalide sur Drive. Assurez-vous qu'il existe et contient des sessions.`, 8000, "error"); 
                    if (driveStatusElement) { driveStatusElement.textContent = 'Erreur Prog.'; driveStatusElement.classList.remove('loading'); driveStatusElement.classList.add('error'); } 
                    programsLoaded = false; loadedFullProgram = null; 
                } 
            } catch (error) { 
                console.error("Erreur CRITIQUE pendant le chargement du programme Drive (Éditeur):", error); 
                showMessage("Erreur majeure chargement programme.", 6000, "error"); 
                if (driveStatusElement) { driveStatusElement.textContent = 'Erreur Données'; driveStatusElement.classList.remove('loading', 'success'); driveStatusElement.classList.add('error'); } 
                programsLoaded = false; loadedFullProgram = null; 
            } finally { 
                updateAuthUI(true); 
            } 
        } else { 
            handleTokenError({ error: "invalid_response", details: "Réponse inattendue du serveur Google (Éditeur)." }); 
        } 
    }

    function handleAuthClick() { initAudioContext(); if (!tokenClient) { showMessage("Services Google non prêts...", 3000, "info"); if (!GOOGLE_CLIENT_ID || GOOGLE_CLIENT_ID.includes("YOUR_CLIENT_ID")) { showMessage("Erreur critique : ID Client Google manquant.", 8000, "error"); } return; } if (driveStatusElement) { driveStatusElement.textContent = 'Connexion...'; driveStatusElement.classList.add('loading'); driveStatusElement.classList.remove('error', 'success'); driveStatusElement.style.display = 'inline-block'; } tokenClient.requestAccessToken({ prompt: 'consent' }); }
    
    async function findOrCreateFile(filename, defaultContentStr = "{}", mimeType = 'application/json', createIfNotExist = false) { 
        if (!googleAccessToken) return null; 
        const searchUrl = `https://www.googleapis.com/drive/v3/files?q=name='${encodeURIComponent(filename)}'+and+trashed=false&spaces=drive&fields=files(id,name)`;
        try {
            const searchRes = await fetch(searchUrl, { headers: { 'Authorization': `Bearer ${googleAccessToken}` } });
            if (!searchRes.ok) { if (searchRes.status === 401 || searchRes.status === 403) { /* handleSignoutClick(false); */ showMessage("Session Google expirée.", 5000, "error"); googleAccessToken = null; updateAuthUI(false); return null; } throw new Error(`Recherche échouée (${searchRes.status})`); }
            const searchData = await searchRes.json();
            if (searchData.files && searchData.files.length > 0) { console.log(`Drive (Éditeur): Fichier ${filename} trouvé (ID: ${searchData.files[0].id}).`); return searchData.files[0].id; }
            if (!createIfNotExist) { console.log(`Drive (Éditeur): Fichier ${filename} non trouvé et création désactivée.`); return null; } 
            console.log(`Drive (Éditeur): Fichier ${filename} non trouvé. Tentative de création...`);
            const createUrl = `https://www.googleapis.com/drive/v3/files`;
            const metadata = { name: filename, mimeType: mimeType };
            const createRes = await fetch(createUrl, { method: 'POST', headers: { 'Authorization': `Bearer ${googleAccessToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify(metadata) });
            if (!createRes.ok) throw new Error(`Création échouée (${createRes.status})`);
            const createData = await createRes.json(); const newFileId = createData.id;
            const writeSuccess = await updateFileContent(newFileId, defaultContentStr);
            console.log(`Drive (Éditeur): Fichier ${filename} créé (ID: ${newFileId}). Succès écriture contenu par défaut: ${writeSuccess}`);
            return writeSuccess ? newFileId : null;
        } catch (error) { console.error(`Erreur Drive (Éditeur - findOrCreate ${filename}):`, error); showMessage(`Erreur Drive (${filename.substring(0, 15)}...): ${error.message}`, 6000, "error"); return null; }
    }
    async function readFileContent(fileId) { if (!googleAccessToken || !fileId) return null; console.log(`Drive (Éditeur): Lecture du fichier ${fileId}`); const url = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`; try { const response = await fetch(url, { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }); if (!response.ok) { if (response.status === 404) { console.warn(`readFileContent(${fileId}) (Éditeur): Fichier non trouvé (404).`); return null; } if (response.status === 401 || response.status === 403) { /* handleSignoutClick(false); */ showMessage("Session Google expirée.", 5000, "error"); googleAccessToken = null; updateAuthUI(false); return null; } throw new Error(`Lecture échouée (${response.status})`); } const content = await response.text(); console.log(`Drive (Éditeur): Contenu du fichier ${fileId} lu.`); return content; } catch (error) { console.error(`Erreur Drive (Éditeur - readFile ${fileId}):`, error); showMessage(`Erreur Lecture Drive (${fileId}): ${error.message}`, 6000, "error"); return null; } }
    async function updateFileContent(fileId, content) { if (!googleAccessToken || !fileId) return false; console.log(`Drive (Éditeur): Écriture dans le fichier ${fileId}...`); if(saveProgramBtn) saveProgramBtn.disabled = true; const url = `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`; const isJson = typeof content === 'object'; const contentToSend = isJson ? JSON.stringify(content, null, 2) : content; const contentType = isJson ? 'application/json; charset=UTF-8' : 'text/plain; charset=UTF-8'; let success = false; try { const response = await fetch(url, { method: 'PATCH', headers: { 'Authorization': `Bearer ${googleAccessToken}`, 'Content-Type': contentType }, body: contentToSend }); if (!response.ok) { if (response.status === 401 || response.status === 403) { /* handleSignoutClick(false); */ showMessage("Session expirée. Sauvegarde échouée.", 6000, "error"); googleAccessToken = null; updateAuthUI(false); } else { throw new Error(`Écriture échouée (${response.status})`); } } else { console.log(`Drive (Éditeur): Fichier ${fileId} mis à jour.`); success = true; } } catch (error) { console.error(`Erreur Drive (Éditeur - updateFile ${fileId}):`, error); showMessage(`Erreur Écriture Drive: ${error.message}`, 6000, "error"); success = false; } finally { if(saveProgramBtn) saveProgramBtn.disabled = !success && isDirty; console.log(`Drive (Éditeur): Écriture ${fileId} terminée. Succès: ${success}`); } return success; }

    async function loadFullProgramFromDrive() {
        programsLoaded = false; loadedFullProgram = null; 
        if (!googleAccessToken) { showMessage("Connectez-vous à Drive pour charger votre programme.", 5000, "info"); return false; }
        console.log(`Tentative de chargement du programme global '${FULL_PROGRAM_FILENAME}' depuis Drive...`);
        programFileId = await findOrCreateFile(FULL_PROGRAM_FILENAME, "{}", false); 
        
        if (programFileId) {
            const content = await readFileContent(programFileId);
            if (content && content.trim() !== "") {
                try {
                    const parsedProgram = JSON.parse(content);
                    if (parsedProgram && parsedProgram.sessions && Array.isArray(parsedProgram.sessions)) {
                        loadedFullProgram = parsedProgram; programsLoaded = true;
                        console.log(`Programme global '${FULL_PROGRAM_FILENAME}' chargé avec succès depuis Drive.`);
                        return true;
                    } else {
                        console.error(`'${FULL_PROGRAM_FILENAME}' malformé. Structure attendue : { "sessions": [...] }.`);
                        showMessage(`'${FULL_PROGRAM_FILENAME}' sur Drive est malformé ou ne contient pas de sessions.`, 5000, "error"); return false; 
                    }
                } catch (e) {
                    console.error(`Erreur parsing programme global '${FULL_PROGRAM_FILENAME}' depuis Drive:`, e, "\nContenu (début):", content.substring(0, 200) + "...");
                    showMessage(`Programme '${FULL_PROGRAM_FILENAME}' sur Drive corrompu ou invalide. Vérifiez sa syntaxe JSON. Erreur: ${e.message}`, 7000, "error"); return false;
                }
            } else { 
                 console.log(`Aucun contenu pour '${FULL_PROGRAM_FILENAME}' sur Drive ou fichier vide. L'utilisateur doit créer/remplir le fichier.`); 
                 showMessage(`Fichier '${FULL_PROGRAM_FILENAME}' vide ou non trouvé sur Drive. Veuillez le créer et le remplir correctement.`, 7000, "info"); return false; 
            }
        } else { 
            console.log(`Fichier '${FULL_PROGRAM_FILENAME}' non trouvé sur Drive. L'utilisateur doit le créer.`); 
            showMessage(`Fichier '${FULL_PROGRAM_FILENAME}' non trouvé sur Drive. Veuillez le créer et le remplir.`, 7000, "info"); return false; 
        }
    }

    function displayProgram(sessionName) { 
        if (!programDisplay) { console.error("Élément #program-display non trouvé."); return; }
        if (!loadedFullProgram || !loadedFullProgram.sessions) { 
            programDisplay.innerHTML = `<li style="text-align:center; padding:20px; color:var(--secondary-text-color);">Aucun programme chargé. Connectez-vous et vérifiez '${FULL_PROGRAM_FILENAME}' sur votre Drive.</li>`; 
            currentEditingSessionName = null; markAsDirty(false); updateEditorActionButtonsState(); return;
        }
        const sessionToDisplay = loadedFullProgram.sessions.find(s => s.nom_session === sessionName);
        if (!sessionToDisplay) { 
            programDisplay.innerHTML = `<li style="text-align:center; padding:20px; color:var(--secondary-text-color);">Session '${sessionName}' non trouvée dans le programme chargé.</li>`; 
            currentEditingSessionName = null; markAsDirty(false); updateEditorActionButtonsState(); return;
        }
        currentEditingSessionName = sessionName; programDisplay.innerHTML = ''; 
        programTabsContainer.querySelectorAll('button').forEach(btn => { btn.classList.toggle('active', btn.dataset.sessionName === sessionName); btn.disabled = !programsLoaded; }); 
        if (sessionToDisplay.exercices_et_pauses && sessionToDisplay.exercices_et_pauses.length > 0) {
            sessionToDisplay.exercices_et_pauses.forEach((step, index) => { const stepElement = renderStep(step, index, sessionName); programDisplay.appendChild(stepElement); });
        } else { programDisplay.innerHTML = `<li style="text-align:center; padding:20px; color:var(--secondary-text-color);">Cette session est vide. Ajoutez des étapes !</li>`; }
        markAsDirty(false); updateEditorActionButtonsState(); 
        if (sortableInstance) sortableInstance.destroy(); 
        if(programDisplay) sortableInstance = new Sortable(programDisplay, { animation: 150, ghostClass: 'sortable-ghost', chosenClass: 'sortable-chosen', handle: '.program-step', onEnd: handleDragEnd }); 
    }

    function renderStep(step, index, sessionNameForDataset) { 
        const li = document.createElement('li'); li.classList.add('program-step', `${step.type}-step`); li.dataset.index = index; li.dataset.session = sessionNameForDataset;
        const isExercise = step.type === 'exercise'; 
        const defaultColorForNewExercise = stepColorPalette[0]; // Utiliser la première couleur de la palette comme défaut
        const currentStepColor = step.step_color || defaultColorForNewExercise;
        li.style.borderLeftColor = isExercise ? currentStepColor : 'var(--color-break)';
        
        const iconClass = isExercise ? 'fa-dumbbell' : 'fa-hourglass-half'; 
        let iconHtml = `<i class="fas ${iconClass} step-icon" style="color: ${isExercise ? currentStepColor : 'var(--color-break)'};" aria-hidden="true"></i>`;

        const commonFields = ` <div class="step-field"> <label for="name-${index}">Nom</label> <input type="text" id="name-${index}" data-field="name" value="${step.name ?? ''}" ${!isExercise && step.name === 'Repos' ? 'readonly' : ''}> </div> <div class="step-field" style="grid-column: 1 / -1;"> <label for="details-${index}">Détails</label> <textarea id="details-${index}" data-field="details" placeholder="Infos supplémentaires...">${step.details || ''}</textarea> </div>`;
        let exerciseSpecificFields = '';
        let colorPaletteHtml = '';

        if (isExercise) {
            exerciseSpecificFields = `
                <div class="step-field"> <label for="reps-${index}">Reps</label> <input type="number" id="reps-${index}" data-field="reps" value="${step.reps ?? ''}" min="0" step="1" placeholder="Ex: 12"> </div>
                <div class="step-field"> <label for="weight-${index}">Poids/Rés.</label> <input type="number" id="weight-${index}" data-field="weight" value="${step.weight ?? ''}" min="0" step="0.5" placeholder="Ex: 25"> </div>
                <div class="step-field"> <label for="unit-${index}">Unité</label> <input type="text" id="unit-${index}" data-field="unit" value="${step.unit || ''}" placeholder="kg, PDC, etc."> </div>
                <div class="step-field"> <label for="equipment-${index}">Équipement</label> <input type="text" id="equipment-${index}" data-field="equipment" value="${step.equipment || ''}" placeholder="Haltères, Élastique"> </div>
                <div class="step-field"> <label for="image_url-${index}">URL Image</label> <input type="text" id="image_url-${index}" data-field="image_url" value="${step.image_url || ''}" placeholder="https://..."> </div>
                <div class="step-field" style="grid-column: 1 / -1;"> <label for="progression_note-${index}">Note Progression</label> <textarea id="progression_note-${index}" data-field="progression_note" placeholder="Comment progresser...">${step.progression_note || ''}</textarea> </div>
            `;
            colorPaletteHtml = `<div class="step-field color-palette-container" style="grid-column: 1 / -1;"><label>Couleur de l'étape</label><div class="color-palette">`;
            stepColorPalette.forEach(color => {
                colorPaletteHtml += `<span class="color-swatch ${color === currentStepColor ? 'active' : ''}" style="background-color: ${color};" data-color="${color}" title="${color}"></span>`;
            });
            colorPaletteHtml += `</div></div>`;
        } else { 
            exerciseSpecificFields = ` <div class="step-field"> <label for="duration-${index}">Durée (secs)</label> <input type="number" id="duration-${index}" data-field="duration" value="${step.duration ?? ''}" min="1" step="1" placeholder="Ex: 75"> </div> `; 
        }
        li.innerHTML = ` ${iconHtml} <div class="step-content"> ${commonFields} ${exerciseSpecificFields} ${colorPaletteHtml} </div> <div class="step-actions"> <button class="delete-step-btn" title="Supprimer l'étape" aria-label="Supprimer l'étape ${index + 1}"><i class="fas fa-trash-alt"></i></button> </div> `; 
        li.querySelector('.delete-step-btn').addEventListener('click', () => handleDeleteStep(index)); 
        li.querySelectorAll('input, textarea, select').forEach(input => { input.addEventListener('input', () => markAsDirty(true)); input.addEventListener('change', (event) => handleEditStep(parseInt(li.dataset.index, 10), event.target.dataset.field, event.target.value)); }); 
        li.querySelectorAll('.color-swatch').forEach(swatch => { swatch.addEventListener('click', (event) => handleColorChange(index, event.target.dataset.color)); });
        return li; 
    }
    function handleColorChange(stepIndex, newColor) {
        if (!currentEditingSessionName || !loadedFullProgram || !loadedFullProgram.sessions) return;
        const currentSession = loadedFullProgram.sessions.find(s => s.nom_session === currentEditingSessionName);
        if (!currentSession || !currentSession.exercices_et_pauses || stepIndex < 0 || stepIndex >= currentSession.exercices_et_pauses.length) return;
        const step = currentSession.exercices_et_pauses[stepIndex];
        if (step.type === 'exercise') {
            step.step_color = newColor;
            markAsDirty(true);
            displayProgram(currentEditingSessionName); 
        }
    }

    function handleTabClick(sessionName) { initAudioContext(); if (!programsLoaded || !loadedFullProgram) return; if (!sessionName && loadedFullProgram.sessions && loadedFullProgram.sessions.length > 0) { sessionName = loadedFullProgram.sessions[0].nom_session; } else if (!sessionName) { return; } if (sessionName === currentEditingSessionName) return; if (isDirty) { if (!confirm(`Vous avez des modifications non sauvegardées pour la session "${currentEditingSessionName}". Voulez-vous continuer sans sauvegarder ?`)) { programTabsContainer.querySelectorAll('button').forEach(btn => { btn.classList.toggle('active', btn.dataset.sessionName === currentEditingSessionName); }); return; } } displayProgram(sessionName); }
    function handleAddStep(stepType) { initAudioContext(); if (!currentEditingSessionName || !loadedFullProgram || !loadedFullProgram.sessions) return; const currentSession = loadedFullProgram.sessions.find(s => s.nom_session === currentEditingSessionName); if (!currentSession) return; let newStep = {}; if (stepType === 'exercise') newStep = { type: "exercise", name: "Nouvel Exercice", reps: 10, weight: null, unit: "kg", details: "", equipment: "", image_url: "", progression_note: "", step_color: stepColorPalette[0] }; else newStep = { type: "break", duration: 60, name: "Repos", details: "" }; if (!currentSession.exercices_et_pauses) currentSession.exercices_et_pauses = []; currentSession.exercices_et_pauses.push(newStep); displayProgram(currentEditingSessionName); markAsDirty(true); programDisplay.scrollTop = programDisplay.scrollHeight; showMessage(`${stepType === 'exercise' ? 'Exercice' : 'Pause'} ajouté(e).`, 1500, "success"); }
    function handleDeleteStep(index) { initAudioContext(); if (!currentEditingSessionName || !loadedFullProgram || !loadedFullProgram.sessions) return; const currentSession = loadedFullProgram.sessions.find(s => s.nom_session === currentEditingSessionName); if (!currentSession || !currentSession.exercices_et_pauses || index < 0 || index >= currentSession.exercices_et_pauses.length) return; const stepToDelete = currentSession.exercices_et_pauses[index]; if (confirm(`Êtes-vous sûr de vouloir supprimer l'étape "${stepToDelete.name || 'Pause'}" ?`)) { currentSession.exercices_et_pauses.splice(index, 1); displayProgram(currentEditingSessionName); markAsDirty(true); showMessage("Étape supprimée.", 1500, "info"); } }
    function handleEditStep(index, field, value) { if (!currentEditingSessionName || !loadedFullProgram || !loadedFullProgram.sessions) return; const currentSession = loadedFullProgram.sessions.find(s => s.nom_session === currentEditingSessionName); if (!currentSession || !currentSession.exercices_et_pauses || index < 0 || index >= currentSession.exercices_et_pauses.length) return; const step = currentSession.exercices_et_pauses[index]; const numericFields = ['reps', 'weight', 'duration', 'reps_start', 'reps_target_max']; let processedValue = value; if (numericFields.includes(field)) processedValue = value.trim() === '' ? null : (isNaN(Number(value)) ? value : Number(value)); if(step.type === 'break' && field === 'name' && value.trim() === '') { processedValue = "Repos"; const inputElement = programDisplay.querySelector(`li[data-index="${index}"] #name-${index}`); if (inputElement) inputElement.value = "Repos"; } step[field] = processedValue; markAsDirty(true); }
    function handleDragEnd(event) { if (!currentEditingSessionName || !loadedFullProgram || !loadedFullProgram.sessions) return; const { oldIndex, newIndex } = event; if (oldIndex === newIndex) return; const currentSession = loadedFullProgram.sessions.find(s => s.nom_session === currentEditingSessionName); if (!currentSession || !currentSession.exercices_et_pauses) return; const itemToMove = currentSession.exercices_et_pauses.splice(oldIndex, 1)[0]; currentSession.exercices_et_pauses.splice(newIndex, 0, itemToMove); displayProgram(currentEditingSessionName); markAsDirty(true); }
    async function handleSaveProgram() { initAudioContext(); if (!googleAccessToken || !programFileId) { showMessage("Connexion Drive ou ID de fichier programme manquant.", 4000, "error"); return; } if (!isDirty) { showMessage("Aucune modification à sauvegarder.", 2000, "info"); return; } if (!loadedFullProgram) { showMessage("Aucun programme chargé à sauvegarder.", 3000, "error"); return; } console.log(`Sauvegarde du programme global sur Drive...`); showMessage(`Sauvegarde du programme en cours...`, 2000, "info"); if(saveProgramBtn) { saveProgramBtn.disabled = true; saveProgramBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Sauvegarde...`; } const success = await updateFileContent(programFileId, loadedFullProgram); if(saveProgramBtn) { saveProgramBtn.innerHTML = `<i class="fas fa-save"></i> Sauvegarder Programme Complet`; } if (success) { markAsDirty(false); showMessage(`Programme sauvegardé sur Drive !`, 3000, "success"); } else { showMessage(`Échec de la sauvegarde. Veuillez réessayer.`, 5000, "error"); if(saveProgramBtn) saveProgramBtn.disabled = false; } }
    function markAsDirty(dirtyState) { isDirty = dirtyState; updateSaveButtonState(); const currentTab = programTabsContainer.querySelector(`button[data-session-name="${currentEditingSessionName}"]`); if (currentTab) currentTab.classList.toggle('is-dirty', dirtyState); }
    function updateSaveButtonState() { if (!saveProgramBtn) return; saveProgramBtn.disabled = !isDirty || !googleAccessToken || !programFileId ; saveProgramBtn.innerHTML = `<i class="fas fa-save"></i> Sauvegarder Programme Complet`; }
    function updateEditorActionButtonsState() { const enable = googleAccessToken && programsLoaded && !!currentEditingSessionName && loadedFullProgram && loadedFullProgram.sessions && loadedFullProgram.sessions.length > 0; if(addExerciseBtn) addExerciseBtn.disabled = !enable; if(addBreakBtn) addBreakBtn.disabled = !enable; updateSaveButtonState(); }

    function applyTheme(theme) { const body = document.body; currentTheme = theme; body.classList.remove('light-theme', 'dark-theme'); body.classList.add(theme + '-theme'); try { localStorage.setItem('armorWorkoutEditorTheme', theme); } catch (e) {} }
    function loadSavedTheme() { let savedTheme = 'dark'; try { savedTheme = localStorage.getItem('armorWorkoutEditorTheme') || 'dark'; } catch (e) {} applyTheme(savedTheme); if(document.getElementById('current-year-editor')) document.getElementById('current-year-editor').textContent = new Date().getFullYear(); }

    function showMessage(msg, duration = 3000, type = "info") { 
        if (!messageArea) return;
        messageArea.textContent = msg;
        messageArea.classList.remove('error', 'success', 'info'); 
        messageArea.classList.add(type); 
        messageArea.classList.add('visible');
        if (messageTimeoutId) clearTimeout(messageTimeoutId); 
        messageTimeoutId = setTimeout(() => { messageArea.classList.remove('visible'); }, duration);
    }

    function initializeDOMReferences() {
        signInButton = document.getElementById('signin-button'); 
        driveStatusElement = document.getElementById('drive-status'); signInButtonPrompt = document.getElementById('signin-button-prompt');
        connectionPrompt = document.getElementById('connection-prompt'); programEditorArea = document.getElementById('program-editor-area');
        programTabsContainer = document.getElementById('program-tabs'); programDisplay = document.getElementById('program-display');
        addExerciseBtn = document.getElementById('add-exercise-btn'); addBreakBtn = document.getElementById('add-break-btn');
        saveProgramBtn = document.getElementById('save-program-btn'); messageArea = document.getElementById('message-area');
    }
    function addEventListeners() {
        if(signInButton) signInButton.addEventListener('click', handleAuthClick);
        if(signInButtonPrompt) signInButtonPrompt.addEventListener('click', handleAuthClick);
        programTabsContainer?.querySelectorAll('button').forEach(btn => { btn.addEventListener('click', () => handleTabClick(btn.dataset.sessionName)); });
        if(addExerciseBtn) addExerciseBtn.addEventListener('click', () => handleAddStep('exercise'));
        if(addBreakBtn) addBreakBtn.addEventListener('click', () => handleAddStep('break'));
        if(saveProgramBtn) saveProgramBtn.addEventListener('click', handleSaveProgram);
        window.addEventListener('beforeunload', (event) => { if (isDirty) { event.preventDefault(); event.returnValue = ''; } });
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        initializeDOMReferences(); 
        initAudioContext(); 
        addEventListeners(); 
        loadSavedTheme();
        updateAuthUI(false); 
        checkAndInitGis(); 
        console.log("Éditeur ArmorWorkout Initialisé (v10).");
    });

</script>

</body>
</html>
