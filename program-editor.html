<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ArmorWorkout - Éditeur de Programme</title>
    <!-- Font Awesome (CDNJS for reliability) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet">
    <!-- SortableJS (pour Drag & Drop) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js" integrity="sha512-Eezs+g9Lq4TCCq0wae01s97utZtkr9UDGtuZEGNeQpVzAKDUt/dgT9GEXtAPostKfFGzA5HaLGTlwMFepPnp1Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <!-- Google Identity Services (GIS) - chargé à la fin du body -->
    <style>
        /* --- Variables Globales & Thèmes (Identiques à l'autre page) --- */
        :root {
            /* Thème Sombre (Base) */
            --bg-color-dark: #0D1117; --secondary-bg-color-dark: #161B22; --primary-text-color-dark: #c9d1d9; --secondary-text-color-dark: #8b949e; --border-color-dark: #30363d; --accent-border-color-dark: #58a6ff33; --input-bg-dark: #0d1117;
            /* Couleurs Néon (Thème Sombre) */
            --neon-blue: #58a6ff; --neon-pink: #f778ba; --neon-red: #ff7b72; --neon-yellow: #facc15; --neon-green: #3fb950; --neon-purple: #bc8cff; --neon-orange: #f9a825;
            /* Glows (Thème Sombre) */
            --glow-blue: 0 0 12px rgba(88, 166, 255, 0.6); --glow-pink: 0 0 12px rgba(247, 120, 186, 0.6); --glow-red: 0 0 10px rgba(255, 123, 114, 0.6); --glow-yellow: 0 0 10px rgba(250, 204, 21, 0.5); --glow-green: 0 0 10px rgba(63, 185, 80, 0.6); --glow-purple: 0 0 12px rgba(188, 140, 255, 0.6); --glow-orange: 0 0 10px rgba(249, 168, 37, 0.6);
             /* Couleurs spécifiques aux types (simplifié pour éditeur) */
            --color-exercise: var(--neon-pink);
            --color-break: var(--neon-yellow);
            /* --- Autres Variables --- */
            --font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; --border-radius-lg: 12px; --border-radius-md: 8px; --border-radius-sm: 6px; --transition-speed: 0.25s;
            /* Initialisation Thème Sombre par Défaut */
            --bg-color: var(--bg-color-dark); --secondary-bg-color: var(--secondary-bg-color-dark); --primary-text-color: var(--primary-text-color-dark); --secondary-text-color: var(--secondary-text-color-dark); --border-color: var(--border-color-dark); --accent-border-color: var(--accent-border-color-dark); --input-bg: var(--input-bg-dark);
            /* Variables RGBA */
            --neon-blue-rgb: 88, 166, 255; --neon-pink-rgb: 247, 120, 186; --neon-red-rgb: 255, 123, 114; --neon-yellow-rgb: 250, 204, 21; --neon-green-rgb: 63, 185, 80; --neon-purple-rgb: 188, 140, 255; --neon-orange-rgb: 249, 168, 37;
            --secondary-text-color-dark-rgb: 139, 148, 158; --bg-color-dark-rgb: 13, 17, 23; --secondary-bg-color-dark-rgb: 22, 27, 34; --primary-text-color-dark-rgb: 201, 209, 217;
            --color-exercise-rgb: 247, 120, 186; --color-break-rgb: 250, 204, 21;
             --link-color: var(--neon-blue); /* Ajout link color */
             --button-connect-color: var(--neon-green); --button-connect-glow: var(--glow-green); --button-disconnect-color: var(--neon-red); --button-disconnect-glow: var(--glow-red);
        }

        body.light-theme {
            /* Thème Clair */
            --bg-color: #ffffff; --secondary-bg-color: #f6f8fa; --primary-text-color: #24292f; --secondary-text-color: #57606a; --border-color: #d0d7de; --accent-border-color: #0969da33; --input-bg: #f6f8fa;
            /* Couleurs Néon adaptées */
            --neon-blue: #0969da; --neon-pink: #bf3989; --neon-red: #d73a49; --neon-yellow: #dbab09; --neon-green: #2da44e; --neon-purple: #8250df; --neon-orange: #f66a0a;
            /* Glows (Subtils ou désactivés en clair) */
            --glow-blue: 0 0 8px rgba(9, 105, 218, 0.3); --glow-pink: 0 0 8px rgba(191, 57, 137, 0.3); --glow-red: 0 0 8px rgba(215, 58, 73, 0.3); --glow-yellow: 0 0 8px rgba(219, 171, 9, 0.3); --glow-green: 0 0 8px rgba(45, 164, 78, 0.3); --glow-purple: 0 0 8px rgba(130, 80, 223, 0.3); --glow-orange: 0 0 8px rgba(246, 106, 10, 0.3);
             --link-color: #0969da;
            /* Adapter les variables RGBA */
            --bg-color-dark-rgb: 255, 255, 255; --secondary-bg-color-dark-rgb: 246, 248, 250; --primary-text-color-dark-rgb: 36, 41, 47; --secondary-text-color-dark-rgb: 87, 96, 106;
            --color-exercise-rgb: 191, 57, 137; --color-break-rgb: 219, 171, 9; --neon-orange-rgb: 246, 106, 10;
        }

        /* --- Styles de Base & Réinitialisation (Identiques) --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; font-size: 16px; }
        body {
            font-family: var(--font-family); background-color: var(--bg-color); color: var(--primary-text-color);
            line-height: 1.6; transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
            display: flex; flex-direction: column; min-height: 100vh;
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }
        .container { max-width: 900px; /* Un peu moins large pour l'éditeur */ margin: 0 auto; padding: 30px 20px; width: 100%; flex-grow: 1; display: flex; flex-direction: column; }

        /* --- En-tête (Adapté) --- */
        header {
            padding: 15px 0; border-bottom: 1px solid var(--border-color);
            transition: border-color var(--transition-speed) ease, background-color var(--transition-speed) ease;
            position: sticky; top: 0; z-index: 1000;
            background-color: rgba(var(--bg-color-dark-rgb), 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
        }
        .header-content { display: flex; justify-content: space-between; align-items: center; max-width: 1100px; margin: 0 auto; padding: 0 25px; flex-wrap: wrap; gap: 15px 20px; }
        header h1 { font-size: 1.5em; color: var(--primary-text-color); margin: 0; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        header h1 i { color: var(--neon-blue); animation: pulse 2s infinite ease-in-out; }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 0.8; } 50% { transform: scale(1.1); opacity: 1; } }
        .header-link { /* Nouveau: Lien retour */
            color: var(--secondary-text-color); font-size: 0.9em; text-decoration: none;
             display: inline-flex; align-items: center; gap: 5px; transition: color var(--transition-speed) ease;
        }
        .header-link:hover { color: var(--link-color); }

        /* Actions Header (Identique pour Auth/Thème) */
        .header-actions { display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
        .auth-controls { display: flex; gap: 10px; align-items: center; }
        .auth-controls button { background: none; border: 1px solid var(--accent-border-color); color: var(--secondary-text-color); padding: 6px 14px; border-radius: var(--border-radius-md); font-size: 0.85em; font-weight: 500; cursor: pointer; transition: all var(--transition-speed) ease; display: inline-flex; align-items: center; gap: 6px; }
        .auth-controls button:disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; border-color: var(--border-color) !important; color: var(--secondary-text-color) !important; box-shadow: none !important; background-color: transparent !important; }
        .auth-controls button:not(:disabled):hover { border-color: var(--primary-text-color); color: var(--primary-text-color); }
        #signin-button { border-color: var(--button-connect-color); color: var(--button-connect-color); }
        #signin-button:not(:disabled):hover { background-color: rgba(var(--neon-green-rgb), 0.1); box-shadow: var(--glow-green); border-color: var(--neon-green); }
        #signout-button { border-color: var(--button-disconnect-color); color: var(--button-disconnect-color); }
        #signout-button:not(:disabled):hover { background-color: rgba(var(--neon-red-rgb), 0.1); box-shadow: var(--glow-red); border-color: var(--neon-red); }
        #drive-status { font-size: 0.8em; color: var(--secondary-text-color); margin-left: 5px; transition: opacity 0.3s, color 0.3s, border-color 0.3s; min-width: fit-content; text-align: right; font-style: normal; padding: 4px 8px; background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.5); border-radius: var(--border-radius-sm); border: 1px solid var(--border-color); display: none; }
        #drive-status.loading { color: var(--neon-yellow); border-color: var(--neon-yellow); animation: blink-border 1.5s infinite ease-in-out; }
        #drive-status.error { color: var(--neon-red); border-color: var(--neon-red); }
        #drive-status.success { color: var(--neon-green); border-color: var(--neon-green); }
        @keyframes blink-border { 50% { border-color: rgba(var(--neon-yellow-rgb), 0.4); } }
        .theme-toggle button { background: none; border: none; color: var(--secondary-text-color); font-size: 1.2em; padding: 5px; cursor: pointer; transition: color var(--transition-speed) ease; }
        .theme-toggle button:hover { color: var(--neon-yellow); }
        body.logged-out #signin-button { display: inline-flex; } body.logged-out #signout-button { display: none; } body.logged-out #drive-status { display: none; }
        body.logged-in #signin-button { display: none; } body.logged-in #signout-button { display: inline-flex; } body.logged-in #drive-status { display: inline-block; }


        /* --- Contenu Principal --- */
        main { flex-grow: 1; display: flex; flex-direction: column; align-items: center; padding-top: 40px; }
        main h2 { font-size: 1.6em; font-weight: 700; margin-bottom: 30px; text-align: center; color: var(--primary-text-color); display: flex; align-items: center; gap: 10px; justify-content: center;}
        main h2 i { color: var(--neon-blue); }

        /* Message si non connecté */
        #connection-prompt {
            text-align: center; padding: 40px 20px; background-color: var(--secondary-bg-color); border-radius: var(--border-radius-lg);
            border: 1px dashed var(--border-color); margin: 20px auto; max-width: 600px;
        }
        #connection-prompt p { margin-bottom: 15px; color: var(--secondary-text-color); }
        #connection-prompt button { /* Style du bouton connecter DANS le prompt */
            border-color: var(--button-connect-color); color: var(--button-connect-color); background: transparent; padding: 8px 18px;
            border-radius: var(--border-radius-md); font-size: 0.9em; font-weight: 500; cursor: pointer;
            transition: all var(--transition-speed) ease; display: inline-flex; align-items: center; gap: 6px;
        }
         #connection-prompt button:disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; border-color: var(--border-color) !important; color: var(--secondary-text-color) !important; box-shadow: none !important; background-color: transparent !important; }
        #connection-prompt button:not(:disabled):hover { background-color: rgba(var(--neon-green-rgb), 0.1); box-shadow: var(--glow-green); border-color: var(--neon-green); }

        /* Zone de l'éditeur (cachée si non connecté) */
        #program-editor-area {
            width: 100%;
            background-color: var(--secondary-bg-color);
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--border-color);
            padding: 25px;
            display: none; /* Caché par défaut, affiché via JS */
            flex-direction: column;
            gap: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        body.logged-in #program-editor-area { display: flex; } /* Afficher si connecté */

        /* Onglets de sélection du programme */
        .program-tabs {
            display: flex; gap: 10px; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; flex-wrap: wrap;
        }
        .program-tabs button {
            padding: 8px 18px; font-size: 1em; font-weight: 500; border: none; background: none; color: var(--secondary-text-color);
            cursor: pointer; transition: all var(--transition-speed) ease; border-radius: var(--border-radius-md); position: relative;
        }
         .program-tabs button:disabled { color: rgba(var(--secondary-text-color-dark-rgb), 0.5); cursor: not-allowed; opacity: 0.6; }
        .program-tabs button:not(:disabled):hover { background-color: rgba(var(--primary-text-color-dark-rgb), 0.05); color: var(--primary-text-color); }
        .program-tabs button.active {
            color: var(--neon-blue); background-color: rgba(var(--neon-blue-rgb), 0.1); font-weight: 700;
        }
         .program-tabs button.is-dirty::after { /* Indicateur de modif non sauvegardée */
             content: '●';
             position: absolute; top: 5px; right: 8px; font-size: 0.7em; color: var(--neon-orange);
             animation: blink-dot 1.5s infinite ease-in-out;
         }
         @keyframes blink-dot { 50% { opacity: 0.3; } }

        /* Zone d'affichage du programme */
        #program-display {
            list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 15px;
             min-height: 200px; /* Pour voir le drop si vide */
             background-color: rgba(var(--bg-color-dark-rgb), 0.1);
             border: 1px dashed var(--border-color);
             border-radius: var(--border-radius-md);
             padding: 15px;
        }
         #program-display:empty::before { /* Message si programme vide */
             content: "Glissez-déposez les étapes ici ou utilisez les boutons 'Ajouter'.";
             display: block; text-align: center; padding: 50px 20px; color: var(--secondary-text-color); font-style: italic;
         }

        /* Style d'une étape (carte) */
        .program-step {
            background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: var(--border-radius-md);
            padding: 15px; display: grid; grid-template-columns: auto 1fr auto; /* Icon | Contenu | Actions */ gap: 10px 15px;
            align-items: start; position: relative; transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
            cursor: grab; /* Indicateur pour drag */
        }
        .program-step.exercise-step { border-left: 4px solid var(--color-exercise); }
        .program-step.break-step { border-left: 4px solid var(--color-break); }
        .program-step:hover { border-color: var(--accent-border-color); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

        .step-icon { font-size: 1.3em; color: var(--secondary-text-color); padding-top: 5px; grid-column: 1 / 2; align-self: center; }
        .exercise-step .step-icon { color: var(--color-exercise); }
        .break-step .step-icon { color: var(--color-break); }

        .step-content { grid-column: 2 / 3; display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; }
        .step-field { display: flex; flex-direction: column; gap: 4px; }
        .step-field label { font-size: 0.8em; font-weight: 500; color: var(--secondary-text-color); }
        .step-field input[type="text"],
        .step-field input[type="number"],
        .step-field textarea {
            width: 100%; padding: 8px 10px; font-size: 0.9em; border-radius: var(--border-radius-sm); border: 1px solid var(--border-color);
            background-color: var(--input-bg); color: var(--primary-text-color); transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
        }
        .step-field input:focus, .step-field textarea:focus { border-color: var(--neon-blue); outline: none; box-shadow: 0 0 0 2px rgba(var(--neon-blue-rgb), 0.3); }
        .step-field textarea { min-height: 60px; resize: vertical; font-family: inherit;}
        .step-field input[type="number"] { -moz-appearance: textfield; width: 80px; } /* Réduire largeur nb */
        .step-field input[type="number"]::-webkit-outer-spin-button, .step-field input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        .step-actions { grid-column: 3 / 4; display: flex; flex-direction: column; gap: 8px; align-items: center; padding-top: 5px; }
        .step-actions button {
            background: none; border: none; color: var(--secondary-text-color); font-size: 1.1em; cursor: pointer;
            padding: 5px; transition: color var(--transition-speed) ease; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 50%;
        }
        .step-actions button:hover { color: var(--primary-text-color); background-color: rgba(var(--primary-text-color-dark-rgb), 0.1); }
        .step-actions .delete-step-btn:hover { color: var(--neon-red); background-color: rgba(var(--neon-red-rgb), 0.1); }
         /* Masquer boutons move pour l'instant, géré par drag */
         /*.move-step-btn { } */

        /* Styles pour Drag & Drop (SortableJS) */
        .program-step.sortable-ghost { /* Élément en cours de drag */
            opacity: 0.4; background-color: rgba(var(--neon-blue-rgb), 0.1); border-style: dashed;
        }
        .program-step.sortable-chosen { /* Élément sélectionné */
             cursor: grabbing; border-color: var(--neon-blue); box-shadow: 0 4px 12px rgba(var(--neon-blue-rgb), 0.3);
        }


        /* Boutons d'action globaux (Ajouter, Sauvegarder) */
        .editor-actions {
            display: flex; justify-content: space-between; align-items: center; gap: 15px; flex-wrap: wrap;
            border-top: 1px solid var(--border-color); padding-top: 25px; margin-top: 10px;
        }
        .add-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .editor-actions button {
            padding: 9px 20px; font-size: 0.95em; font-weight: 500; border-radius: var(--border-radius-md); cursor: pointer;
            transition: all var(--transition-speed) ease; display: inline-flex; align-items: center; gap: 8px;
        }
        .editor-actions button:disabled { opacity: 0.5; cursor: not-allowed; pointer-events: none; }

        #add-exercise-btn { border: 1px solid var(--color-exercise); color: var(--color-exercise); background: transparent; }
        #add-exercise-btn:not(:disabled):hover { background-color: rgba(var(--color-exercise-rgb), 0.1); box-shadow: 0 0 8px rgba(var(--color-exercise-rgb), 0.5); }
        #add-break-btn { border: 1px solid var(--color-break); color: var(--color-break); background: transparent; }
        #add-break-btn:not(:disabled):hover { background-color: rgba(var(--color-break-rgb), 0.1); box-shadow: 0 0 8px rgba(var(--color-break-rgb), 0.5); }
        #save-program-btn { border: none; background-color: var(--neon-green); color: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        #save-program-btn:not(:disabled):hover { filter: brightness(1.1); box-shadow: 0 4px 10px rgba(0,0,0,0.25); }
        #save-program-btn:disabled { background-color: var(--secondary-text-color); color: rgba(255,255,255,0.7); box-shadow: none; }


        /* --- Zone de Messages Flottante (Identique) --- */
        .message-area { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); background-color: rgba(var(--secondary-bg-color-dark-rgb), 0.9); color: var(--primary-text-color); border: 1px solid var(--border-color); padding: 12px 25px; border-radius: var(--border-radius-md); z-index: 3000; opacity: 0; transition: opacity 0.5s ease, transform 0.5s ease, bottom 0.5s ease, background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; pointer-events: none; font-size: 0.95em; box-shadow: 0 4px 15px rgba(0,0,0,0.2); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); max-width: 90%; text-align: center; }
        .message-area.visible { opacity: 1; transform: translate(-50%, 0); bottom: 40px; pointer-events: auto; }

        /* --- Pied de Page (Identique) --- */
        footer { color: var(--secondary-text-color); opacity: 0.7; border-top: 1px solid var(--border-color); margin-top: 60px; padding: 25px; text-align: center; transition: border-color var(--transition-speed) ease, color var(--transition-speed) ease; }
        footer a { color: var(--link-color); text-decoration: none; transition: color var(--transition-speed) ease; }
        footer a:hover { color: var(--primary-text-color); text-decoration: underline; }
        footer .fab.fa-google-drive { color: #4CAF50; }

        /* --- Responsive --- */
        @media (max-width: 768px) {
            .container { padding: 20px 15px; }
            main h2 { font-size: 1.4em; }
            .program-step { grid-template-columns: auto 1fr; } /* Icon | Content+Actions */
            .step-actions { grid-column: 2 / 3; flex-direction: row; justify-content: flex-end; padding-top: 0; align-items: center; }
            .step-content { grid-template-columns: 1fr; } /* Forcer une seule colonne pour les champs */
        }
         @media (max-width: 480px) {
             .header-content { padding: 0 15px; }
             .header-actions { gap: 10px; }
             .auth-controls button { padding: 5px 10px; font-size: 0.8em; }
              main h2 { font-size: 1.3em; }
             .program-tabs { gap: 5px; }
             .program-tabs button { padding: 6px 12px; font-size: 0.9em; }
             .program-step { padding: 12px; }
             .step-field input, .step-field textarea { padding: 6px 8px; font-size: 0.85em;}
             .editor-actions { flex-direction: column; align-items: stretch; }
             .editor-actions button { width: 100%; justify-content: center; }
         }

    </style>
</head>
<body class="logged-out dark-theme"> <!-- Initialement logged-out -->

<header>
    <div class="header-content">
        <a href="timer.html" class="header-link"><i class="fas fa-arrow-left"></i> Retour au Timer</a>
        <h1><i class="fas fa-shield-halved"></i> ArmorWorkout</h1>
        <div class="header-actions">
            <div class="auth-controls">
                <button id="signin-button" disabled><i class="fab fa-google"></i> Connecter Drive</button>
                <button id="signout-button" disabled><i class="fas fa-sign-out-alt"></i> Déconnecter</button>
                <!-- Pas de bouton Export ici -->
            </div>
            <span id="drive-status"></span>
            <div class="theme-toggle">
                <button id="theme-toggle-btn" aria-label="Basculer le thème"><i class="fas fa-sun"></i></button>
            </div>
        </div>
    </div>
</header>

<div class="container">
    <main>
        <h2><i class="fas fa-edit"></i> Éditeur de Programme</h2>

        <div id="connection-prompt">
            <p>Veuillez vous connecter à votre compte Google Drive pour charger et modifier vos programmes d'entraînement.</p>
            <button id="signin-button-prompt" disabled><i class="fab fa-google"></i> Connecter Drive</button>
        </div>

        <div id="program-editor-area">
            <div class="program-tabs" id="program-tabs">
                <button data-type="Push" disabled>Push</button>
                <button data-type="Pull" disabled>Pull</button>
                <button data-type="Legs" disabled>Legs</button>
            </div>

            <ul id="program-display">
                <!-- Les étapes du programme seront chargées ici par JS -->
            </ul>

            <div class="editor-actions">
                <div class="add-buttons">
                    <button id="add-exercise-btn" disabled><i class="fas fa-dumbbell"></i> Ajouter Exercice</button>
                    <button id="add-break-btn" disabled><i class="fas fa-hourglass-half"></i> Ajouter Pause</button>
                </div>
                <button id="save-program-btn" disabled><i class="fas fa-save"></i> Sauvegarder</button>
            </div>
        </div>

    </main>
</div>

<footer>
    <p>© 2024 ArmorWorkout Editor. Sauvegarde sur <i class="fab fa-google-drive" aria-hidden="true"></i> Google Drive.</p>
     <p><a href="timer.html">Retourner au Timer</a> | <a href="https://github.com/ironworkout/armorworkout" target="_blank" rel="noopener noreferrer"><i class="fab fa-github" aria-hidden="true"></i> Voir sur GitHub</a></p>
</footer>

<!-- Zone de Message Flottante -->
<div id="message-area" class="message-area" role="status" aria-live="polite"></div>

<!-- Google Identity Services Script - SANS onload -->
<script async defer src="https://accounts.google.com/gsi/client"></script>

<script>
    // --- CONFIGURATION & CONSTANTES (Partagées avec Timer) ---
    const GOOGLE_CLIENT_ID = "731283926358-viam3ulpgna14flfdeb9m92l8s620hoi.apps.googleusercontent.com"; // **UTILISER LE MÊME CLIENT ID**
    const GOOGLE_DRIVE_SCOPES = 'https://www.googleapis.com/auth/drive.file';
    const PROGRAM_FILENAMES = { Push: "armorworkout_push_program.json", Pull: "armorworkout_pull_program.json", Legs: "armorworkout_legs_program.json" };
    const PROGRAM_TYPES = ['Push', 'Pull', 'Legs'];
    const GIS_CHECK_INTERVAL = 100; // ms
    const GIS_MAX_RETRIES = 50; // 50 * 100ms = 5 secondes

    // --- DONNÉES PAR DÉFAUT (Utilisées si fichier non trouvé/vide) ---
    const defaultWorkouts = {
        Push: [ {"type": "exercise", "name": "Pompes (Push-ups)", "reps": 8, "weight": 0, "details": "Poids de corps", "equipment": "Bodyweight", "reps_start": 8, "reps_target_max": 20, "progression_note": "Quand 20 reps faciles: Augmenter difficulté (pieds plus hauts)."}, {"type": "break", "duration": 75, "name": "Repos"}, {"type": "exercise", "name": "Band Standing Chest Press", "reps": 10, "weight": 15, "details": "Élastique 15kg, ancrage porte", "equipment": "Élastique 15kg", "reps_start": 10, "reps_target_max": 15, "progression_note": "Quand 15 reps: Essayer Élastique 25kg."} ],
        Pull: [ {"type": "exercise", "name": "Band Bent-over Row", "reps": 10, "weight": 25, "details": "Élastique 25kg", "equipment": "Élastique 25kg", "reps_start": 10, "reps_target_max": 15, "progression_note": "Quand 15 reps: Combiner 15+25kg."}, {"type": "break", "duration": 75, "name": "Repos"}, {"type": "exercise", "name": "Band Face Pull", "reps": 15, "weight": 15, "details": "Élastique 15kg", "equipment": "Élastique 15kg", "reps_start": 15, "reps_target_max": 25, "progression_note": "Quand 25 reps: Essayer 25kg ou tempo lent."}],
        Legs: [ {"type": "exercise", "name": "Front Squat Combo", "reps": 10, "weight": 45, "details": "Élastique 15+25kg + 1 haltère 5kg", "equipment": "Élastique 15+25kg, Haltère 5kg", "reps_start": 10, "reps_target_max": 15, "progression_note": "Augmenter reps."}, {"type": "break", "duration": 90, "name": "Repos"}, {"type": "exercise", "name": "Calf Raises", "reps": 15, "weight": 50, "details": "Sur livre, Élastiques 15+25kg + 2 haltères 5kg", "equipment": "Élastique 15+25kg, Haltères 5kg", "reps_start": 15, "reps_target_max": 30, "progression_note": "Amplitude complète."}]
    };


    // --- Éléments DOM ---
    let signInButton, signOutButton, driveStatusElement, themeToggleBtn,
        signInButtonPrompt, connectionPrompt, programEditorArea,
        programTabsContainer, programDisplay, addExerciseBtn, addBreakBtn, saveProgramBtn,
        messageArea;

    // --- Variables d'État ---
    let googleAccessToken = null;
    let tokenClient = null;
    let programFileIds = { Push: null, Pull: null, Legs: null };
    let loadedPrograms = { Push: [], Pull: [], Legs: [] }; // Initialiser vide
    let programsLoaded = false;
    let currentEditingType = null; // 'Push', 'Pull', ou 'Legs'
    let isDirty = false; // Changements non sauvegardés ?
    let currentTheme = 'dark';
    let messageTimeoutId = null;
    let gisCheckRetries = 0;
    let sortableInstance = null; // Pour SortableJS

    // --- Audio (Minime ici, juste pour clics potentiels) ---
    let audioContext = null;
    function initAudioContext() { if (!audioContext && typeof AudioContext !== 'undefined') { try { audioContext = new AudioContext(); } catch (e) { console.warn("AudioContext non supporté ou bloqué.", e); } } }

    // --- Google Identity Services (GIS) & Drive API (Identiques au Timer) ---
    async function gisInitInternal() { /* ... (Code identique à la page Timer) ... */ console.log(">>> gisInitInternal appelée (Éditeur)..."); const clientIdValid = GOOGLE_CLIENT_ID && !GOOGLE_CLIENT_ID.includes("YOUR_CLIENT_ID"); if (!clientIdValid) { console.error("CRITICAL: GOOGLE_CLIENT_ID non configuré !"); showMessage("Erreur critique : ID Client Google manquant.", 10000, true); if(signInButton) signInButton.disabled = true; if(signInButtonPrompt) signInButtonPrompt.disabled = true; return; } if (!google || !google.accounts || !google.accounts.oauth2) { console.error("L'API Google Identity Services n'a pas été correctement chargée ou initialisée (Éditeur)."); showMessage("Erreur chargement API Google.", 6000, true); if(signInButton) signInButton.disabled = true; if(signInButtonPrompt) signInButtonPrompt.disabled = true; return; } try { console.log("Tentative d'initialisation de initTokenClient (Éditeur)..."); tokenClient = google.accounts.oauth2.initTokenClient({ client_id: GOOGLE_CLIENT_ID, scope: GOOGLE_DRIVE_SCOPES, callback: tokenCallback, error_callback: handleTokenError, prompt: '' }); console.log("Token Client Google initialisé avec succès (Éditeur)."); if (signInButton) signInButton.disabled = false; if (signInButtonPrompt) signInButtonPrompt.disabled = false; } catch (error) { console.error("Erreur lors de l'appel à google.accounts.oauth2.initTokenClient (Éditeur):", error); showMessage("Erreur initialisation services Google.", 5000, true); updateAuthUI(false); if (driveStatusElement) { driveStatusElement.textContent = 'Erreur Init Auth'; driveStatusElement.classList.remove('loading', 'success'); driveStatusElement.classList.add('error'); driveStatusElement.style.display = 'inline-block'; } if(signInButton) signInButton.disabled = true; if(signInButtonPrompt) signInButtonPrompt.disabled = true; } console.log(">>> gisInitInternal (Éditeur) - Fin d'exécution"); }
    function checkAndInitGis() { /* ... (Code identique à la page Timer) ... */ console.log(`Vérification GIS (Éditeur - Essai ${gisCheckRetries + 1}/${GIS_MAX_RETRIES})...`); if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2 && typeof google.accounts.oauth2.initTokenClient === 'function') { console.log("API Google OAuth2 détectée (Éditeur)! Lancement de gisInitInternal."); gisInitInternal(); } else if (gisCheckRetries < GIS_MAX_RETRIES) { gisCheckRetries++; setTimeout(checkAndInitGis, GIS_CHECK_INTERVAL); } else { console.error(`Échec de la détection de l'API Google (Éditeur) après ${GIS_MAX_RETRIES} essais.`); showMessage("Impossible de charger les services Google. Vérifiez votre connexion ou bloqueur de script.", 10000, true); if(signInButton) signInButton.disabled = true; if(signInButtonPrompt) signInButtonPrompt.disabled = true; } }
    function handleTokenError(error) { /* ... (Code identique à la page Timer) ... */ console.error("Erreur Google Token Client (Éditeur):", error); let userMessage = `Erreur Auth Google: ${error.type || error.error || 'Inconnue'}`; let statusText = 'Erreur Auth'; if (driveStatusElement) { driveStatusElement.classList.remove('loading', 'success'); driveStatusElement.classList.add('error'); driveStatusElement.style.display = 'inline-block'; } if (error.error === 'popup_closed_by_user' || error.error === 'user_cancel' || error.type === 'popup_closed') { userMessage = "Connexion Google annulée."; statusText = 'Annulé'; } else if (error.error === 'popup_failed_to_open' || error.type === 'popup_failed_to_open') { userMessage = "Pop-up Google bloquée."; statusText = 'Popup Bloqué'; } else if (error.error === 'access_denied' || error.type === 'access_denied') { userMessage = "Accès Drive refusé."; statusText = 'Accès Refusé'; } else if (error.error === 'token_network_error') { userMessage = "Erreur réseau lors de l'auth."; statusText = 'Erreur Réseau'; } else if (error.error === 'invalid_grant') { userMessage = "Autorisation invalide."; statusText = 'Autorisation Invalide'; googleAccessToken = null; } showMessage(userMessage, 6000, true); if (driveStatusElement) driveStatusElement.textContent = statusText; updateAuthUI(false); }
    async function tokenCallback(tokenResponse) { // Adapté pour l'éditeur
        if (driveStatusElement) { driveStatusElement.classList.remove('loading', 'error', 'success'); driveStatusElement.style.display = 'inline-block'; }
        if (tokenResponse.error) { handleTokenError(tokenResponse); return; }
        if (tokenResponse && tokenResponse.access_token) {
            console.log("Access Token reçu (Éditeur).");
            googleAccessToken = tokenResponse.access_token;
            showMessage("Connecté ! Chargement des programmes...", 2500);
            if (driveStatusElement) { driveStatusElement.textContent = 'Chargement...'; driveStatusElement.classList.add('loading'); }

            try {
                programsLoaded = await loadProgramsFromDrive(); // Charge les 3 programmes
                if (programsLoaded) {
                     showMessage("Programmes chargés depuis Drive.", 3000);
                     if (driveStatusElement) { driveStatusElement.textContent = 'Connecté'; driveStatusElement.classList.remove('loading', 'error'); driveStatusElement.classList.add('success'); }
                     // Sélectionner le premier onglet par défaut
                     handleTabClick(PROGRAM_TYPES[0]);
                } else {
                    showMessage("Certains programmes non trouvés/invalides. Utilisation des défauts.", 5000, true);
                     if (driveStatusElement) { driveStatusElement.textContent = 'Erreur Progs'; driveStatusElement.classList.remove('loading'); driveStatusElement.classList.add('error'); }
                     programsLoaded = true; // Permet quand même l'édition des défauts
                     handleTabClick(PROGRAM_TYPES[0]); // Afficher quand même le premier
                }
            } catch (error) {
                console.error("Erreur CRITIQUE pendant le chargement des programmes Drive (Éditeur):", error);
                showMessage("Erreur majeure chargement programmes Drive.", 6000, true);
                if (driveStatusElement) { driveStatusElement.textContent = 'Erreur Données'; driveStatusElement.classList.remove('loading', 'success'); driveStatusElement.classList.add('error'); }
                programsLoaded = false;
            } finally {
                updateAuthUI(true); // Mettre à jour l'UI à la fin
            }
        } else {
            handleTokenError({ error: "invalid_response", details: "Réponse inattendue du serveur Google (Éditeur)." });
        }
    }
    function handleAuthClick() { /* ... (Code identique à la page Timer) ... */ initAudioContext(); if (!tokenClient) { showMessage("Services Google non prêts...", 3000); console.warn("Tentative de connexion avant init tokenClient (Éditeur)."); if (!GOOGLE_CLIENT_ID || GOOGLE_CLIENT_ID.includes("YOUR_CLIENT_ID")) { showMessage("Erreur critique : ID Client Google manquant.", 8000, true); } return; } if (driveStatusElement) { driveStatusElement.textContent = 'Connexion...'; driveStatusElement.classList.add('loading'); driveStatusElement.classList.remove('error', 'success'); driveStatusElement.style.display = 'inline-block'; } tokenClient.requestAccessToken({ prompt: 'consent' }); }
    function handleSignoutClick(showMessages = true) { /* ... (Code quasi identique, pas de reset de workout) ... */ const token = googleAccessToken; if (!token) { console.log("Déjà déconnecté (Éditeur)."); updateAuthUI(false); return; } if (showMessages && driveStatusElement) { driveStatusElement.textContent = 'Déconnexion...'; driveStatusElement.classList.add('loading'); driveStatusElement.style.display = 'inline-block'; } google.accounts.oauth2.revoke(token, () => { console.log('Token Google révoqué (Éditeur).'); googleAccessToken = null; programFileIds = { Push: null, Pull: null, Legs: null }; programsLoaded = false; loadedPrograms = { Push: [], Pull: [], Legs: [] }; currentEditingType = null; isDirty = false; if (showMessages) { showMessage("Déconnecté de Google Drive.", 3000); } if (driveStatusElement) { driveStatusElement.textContent = ''; driveStatusElement.style.display = 'none'; } if(programDisplay) programDisplay.innerHTML = ''; // Vider l'éditeur updateAuthUI(false); // Mettre à jour l'UI }); }
    async function findOrCreateFile(filename, defaultContent = "[]", mimeType = 'application/json') { /* ... (Code identique à la page Timer) ... */ console.log(`Drive (Éditeur): Recherche/Création de ${filename}`); if (!googleAccessToken) { console.warn("findOrCreateFile (Éditeur): Pas de token Google."); return null; } const searchUrl = `https://www.googleapis.com/drive/v3/files?q=name='${encodeURIComponent(filename)}'+and+trashed=false&spaces=drive&fields=files(id,name)`; try { const searchRes = await fetch(searchUrl, { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }); if (!searchRes.ok) { if (searchRes.status === 401 || searchRes.status === 403) { console.warn(`findOrCreateFile(${filename}): Erreur d'autorisation (${searchRes.status}) (Éditeur). Déconnexion.`); handleSignoutClick(false); showMessage("Session Google expirée. Reconnectez-vous.", 5000, true); return null; } throw new Error(`Recherche échouée (${searchRes.status}) (Éditeur): ${await searchRes.text()}`); } const searchData = await searchRes.json(); if (searchData.files && searchData.files.length > 0) { console.log(`Drive (Éditeur): Fichier ${filename} trouvé (ID: ${searchData.files[0].id}).`); return searchData.files[0].id; } console.log(`Drive (Éditeur): Fichier ${filename} non trouvé. Création...`); const createUrl = `https://www.googleapis.com/drive/v3/files`; const metadata = { name: filename, mimeType: mimeType }; const createRes = await fetch(createUrl, { method: 'POST', headers: { 'Authorization': `Bearer ${googleAccessToken}`, 'Content-Type': 'application/json' }, body: JSON.stringify(metadata) }); if (!createRes.ok) { throw new Error(`Création échouée (${createRes.status}) (Éditeur): ${await createRes.text()}`); } const createData = await createRes.json(); const newFileId = createData.id; console.log(`Drive (Éditeur): Fichier ${filename} créé (ID: ${newFileId}). Écriture du contenu par défaut...`); const writeSuccess = await updateFileContent(newFileId, defaultContent); if (writeSuccess) { console.log(`Drive (Éditeur): Contenu par défaut écrit avec succès dans ${filename}.`); return newFileId; } else { console.error(`Drive (Éditeur): Échec de l'écriture du contenu par défaut dans ${filename}.`); return null; } } catch (error) { console.error(`Erreur Drive (Éditeur - findOrCreate ${filename}):`, error); showMessage(`Erreur Drive (${filename.substring(0, 15)}...): ${error.message}`, 6000, true); return null; } }
    async function readFileContent(fileId) { /* ... (Code identique à la page Timer) ... */ if (!googleAccessToken || !fileId) { console.warn("readFileContent (Éditeur): Pas de token ou d'ID."); return null; } console.log(`Drive (Éditeur): Lecture du fichier ${fileId}`); const url = `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media`; try { const response = await fetch(url, { headers: { 'Authorization': `Bearer ${googleAccessToken}` } }); if (!response.ok) { if (response.status === 404) { console.warn(`readFileContent(${fileId}) (Éditeur): Fichier non trouvé (404). Retourne chaîne vide pour création.`); return ""; } if (response.status === 401 || response.status === 403) { console.warn(`readFileContent(${fileId}): Erreur d'autorisation (${response.status}) (Éditeur). Déconnexion.`); handleSignoutClick(false); showMessage("Session Google expirée. Reconnectez-vous.", 5000, true); return null; } throw new Error(`Lecture échouée (${response.status}) (Éditeur): ${await response.text()}`); } const content = await response.text(); console.log(`Drive (Éditeur): Contenu du fichier ${fileId} lu.`); return content; } catch (error) { console.error(`Erreur Drive (Éditeur - readFile ${fileId}):`, error); showMessage(`Erreur Lecture Drive (${fileId}): ${error.message}`, 6000, true); return null; } }
    async function updateFileContent(fileId, content) { /* ... (Code identique, sans historyDriveStatus) ... */ if (!googleAccessToken || !fileId) { console.warn("updateFileContent (Éditeur): Pas de token ou d'ID."); return false; } console.log(`Drive (Éditeur): Écriture dans le fichier ${fileId}...`); /* isSavingDriveData retiré pour simplicité ici, gérer via disable bouton save */ if(saveProgramBtn) saveProgramBtn.disabled = true; // Désactiver pendant sauvegarde
        const url = `https://www.googleapis.com/upload/drive/v3/files/${fileId}?uploadType=media`; const isJson = typeof content === 'object'; const contentToSend = isJson ? JSON.stringify(content, null, 2) : content; const contentType = isJson ? 'application/json; charset=UTF-8' : 'text/plain; charset=UTF-8'; let success = false; try { const response = await fetch(url, { method: 'PATCH', headers: { 'Authorization': `Bearer ${googleAccessToken}`, 'Content-Type': contentType }, body: contentToSend }); if (!response.ok) { if (response.status === 401 || response.status === 403) { console.warn(`updateFileContent(${fileId}): Erreur d'autorisation (${response.status}) (Éditeur). Déconnexion.`); handleSignoutClick(false); showMessage("Session expirée. Sauvegarde échouée.", 6000, true); } else { throw new Error(`Écriture échouée (${response.status}) (Éditeur): ${await response.text()}`); } } else { console.log(`Drive (Éditeur): Fichier ${fileId} mis à jour.`); success = true; } } catch (error) { console.error(`Erreur Drive (Éditeur - updateFile ${fileId}):`, error); showMessage(`Erreur Écriture Drive: ${error.message}`, 6000, true); success = false; } finally { if(saveProgramBtn) saveProgramBtn.disabled = !isDirty; // Réactiver seulement si encore des modifs non sauvées console.log(`Drive (Éditeur): Écriture ${fileId} terminée. Succès: ${success}`); } return success; }

    // --- Chargement des Programmes ---
    async function loadProgramsFromDrive() {
        if (!googleAccessToken) return false;
        console.log("Chargement des programmes depuis Drive (Éditeur)...");
        let allLoadedSuccessfully = true;
        const tempLoadedPrograms = {}; // Utiliser un objet temporaire

        for (const type of PROGRAM_TYPES) {
            console.log(`Chargement programme: ${type}...`);
            // Assurer la création avec le contenu par défaut JSON si inexistant
            const defaultJsonString = JSON.stringify(defaultWorkouts[type] || [], null, 2);
            programFileIds[type] = await findOrCreateFile(PROGRAM_FILENAMES[type], defaultJsonString);

            if (programFileIds[type]) {
                const content = await readFileContent(programFileIds[type]);
                if (content !== null) {
                    try {
                         // Si le contenu est vide (cas fichier trouvé mais jamais écrit), utiliser défaut
                         const parsedContent = JSON.parse(content || defaultJsonString);
                         // Assurer que c'est un array
                         tempLoadedPrograms[type] = Array.isArray(parsedContent) ? parsedContent : JSON.parse(defaultJsonString);
                         console.log(`Programme ${type} chargé/parsé (${tempLoadedPrograms[type].length} étapes).`);
                    } catch (e) {
                        console.error(`Erreur parsing JSON programme ${type}:`, e, "Contenu:", content);
                        showMessage(`Erreur format programme ${type}. Utilisation défaut.`, 4000, true);
                        tempLoadedPrograms[type] = JSON.parse(JSON.stringify(defaultWorkouts[type] || []));
                        allLoadedSuccessfully = false;
                    }
                } else {
                    console.warn(`Lecture programme ${type} échouée. Utilisation défaut.`);
                    tempLoadedPrograms[type] = JSON.parse(JSON.stringify(defaultWorkouts[type] || []));
                    allLoadedSuccessfully = false;
                }
            } else {
                console.error(`Impossible d'obtenir/créer l'ID pour ${type}. Utilisation défaut.`);
                tempLoadedPrograms[type] = JSON.parse(JSON.stringify(defaultWorkouts[type] || []));
                allLoadedSuccessfully = false;
            }
        }
        loadedPrograms = tempLoadedPrograms; // Assigner à la variable globale
        console.log("Fin chargement programmes. Global success:", allLoadedSuccessfully);
        return allLoadedSuccessfully;
    }

    // --- Logique de l'Éditeur ---

    function displayProgram(type) {
        if (!programDisplay || !loadedPrograms[type]) return;
        console.log(`Affichage du programme: ${type}`);
        currentEditingType = type;
        programDisplay.innerHTML = ''; // Vider l'affichage actuel

        // Activer/Désactiver les onglets
        programTabsContainer.querySelectorAll('button').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.type === type);
            btn.disabled = !programsLoaded; // Désactiver si programmes pas chargés
             // Mettre à jour l'indicateur isDirty pour cet onglet (sera géré par markAsDirty)
        });

        // Rendre chaque étape
        loadedPrograms[type].forEach((step, index) => {
            const stepElement = renderStep(step, index);
            programDisplay.appendChild(stepElement);
        });

        // Activer les boutons d'ajout et sauvegarde (initialement désactivé)
        updateEditorActionButtonsState();
        markAsDirty(false); // Reset le flag dirty lors du changement d'onglet

         // Initialiser SortableJS sur la nouvelle liste
         if (sortableInstance) { sortableInstance.destroy(); }
         if(programDisplay) {
              sortableInstance = new Sortable(programDisplay, {
                   animation: 150,
                   ghostClass: 'sortable-ghost', // Classe pour l'élément fantôme
                   chosenClass: 'sortable-chosen', // Classe pour l'élément sélectionné
                   handle: '.program-step', // On peut attraper toute la carte
                   onEnd: handleDragEnd // Fonction appelée après le drag
              });
         }
    }

     function renderStep(step, index) {
         const li = document.createElement('li');
         li.classList.add('program-step', `${step.type}-step`);
         li.dataset.index = index; // Stocker l'index pour référence future

         const isExercise = step.type === 'exercise';
         const iconClass = isExercise ? 'fa-dumbbell' : 'fa-hourglass-half';

         // Simplification des champs affichés pour clarté
         const fieldsHtml = `
             <div class="step-field">
                 <label for="name-${index}">Nom</label>
                 <input type="text" id="name-${index}" data-field="name" value="${step.name || ''}" ${!isExercise && step.name === 'Repos' ? 'readonly' : ''}>
             </div>
             ${isExercise ? `
                 <div class="step-field">
                     <label for="reps-${index}">Reps Actuel</label>
                     <input type="number" id="reps-${index}" data-field="reps" value="${step.reps ?? ''}" min="0" step="1">
                 </div>
                 <div class="step-field">
                     <label for="reps_start-${index}">Reps Début (Fourch.)</label>
                     <input type="number" id="reps_start-${index}" data-field="reps_start" value="${step.reps_start ?? ''}" min="0" step="1">
                 </div>
                 <div class="step-field">
                     <label for="reps_target_max-${index}">Reps Max (Fourch.)</label>
                     <input type="number" id="reps_target_max-${index}" data-field="reps_target_max" value="${step.reps_target_max ?? ''}" min="0" step="1">
                 </div>
                 <div class="step-field">
                     <label for="weight-${index}">Poids/Res.</label>
                     <input type="number" id="weight-${index}" data-field="weight" value="${step.weight ?? ''}" min="0" step="0.5">
                 </div>
                 <div class="step-field">
                     <label for="equipment-${index}">Équipement</label>
                     <input type="text" id="equipment-${index}" data-field="equipment" value="${step.equipment || ''}">
                 </div>
             ` : `
                 <div class="step-field">
                     <label for="duration-${index}">Durée (secs)</label>
                     <input type="number" id="duration-${index}" data-field="duration" value="${step.duration || ''}" min="1" step="1">
                 </div>
             `}
             <div class="step-field" style="grid-column: 1 / -1;"> <!-- Prend toute la largeur -->
                 <label for="details-${index}">Détails</label>
                 <textarea id="details-${index}" data-field="details">${step.details || ''}</textarea>
             </div>
             ${isExercise ? `
                 <div class="step-field" style="grid-column: 1 / -1;">
                     <label for="progression_note-${index}">Note de Progression</label>
                     <textarea id="progression_note-${index}" data-field="progression_note">${step.progression_note || ''}</textarea>
                 </div>
             ` : ''}
         `;

         li.innerHTML = `
             <i class="fas ${iconClass} step-icon" aria-hidden="true"></i>
             <div class="step-content">
                 ${fieldsHtml}
             </div>
             <div class="step-actions">
                 <button class="delete-step-btn" title="Supprimer l'étape" aria-label="Supprimer l'étape ${index + 1}"><i class="fas fa-trash-alt"></i></button>
                 <!-- Boutons Move retirés, remplacés par Drag & Drop -->
             </div>
         `;

         // Ajouter les écouteurs pour la suppression et la modification
         li.querySelector('.delete-step-btn').addEventListener('click', () => handleDeleteStep(index));
         li.querySelectorAll('input, textarea').forEach(input => {
            input.addEventListener('change', (event) => handleEditStep(index, event.target.dataset.field, event.target.value));
             input.addEventListener('input', () => markAsDirty(true)); // Marquer comme modifié pendant la saisie
         });


         return li;
     }

    function handleTabClick(type) {
        initAudioContext();
        if (!programsLoaded) return;
        if (type === currentEditingType) return; // Ne rien faire si clic sur l'onglet actif

        if (isDirty) {
            if (!confirm(`Vous avez des modifications non sauvegardées pour le programme "${currentEditingType}". Voulez-vous continuer sans sauvegarder ?`)) {
                // Remettre l'onglet actif visuellement si l'utilisateur annule
                programTabsContainer.querySelectorAll('button').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.type === currentEditingType);
                });
                return;
            }
        }
        displayProgram(type);
    }

    function handleAddStep(stepType) {
         initAudioContext();
         if (!currentEditingType || !loadedPrograms[currentEditingType]) return;

         let newStep = {};
         if (stepType === 'exercise') {
             newStep = {
                 type: "exercise", name: "Nouvel Exercice", reps: 10, weight: 0,
                 details: "", equipment: "", reps_start: 10, reps_target_max: 15,
                 progression_note: "Définir la progression"
             };
         } else { // break
             newStep = { type: "break", duration: 60, name: "Repos" };
         }

         loadedPrograms[currentEditingType].push(newStep);
         const newIndex = loadedPrograms[currentEditingType].length - 1;
         const stepElement = renderStep(newStep, newIndex);
         programDisplay.appendChild(stepElement);
         stepElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); // Scroll vers le nouvel élément
         markAsDirty(true);
         showMessage(`${stepType === 'exercise' ? 'Exercice' : 'Pause'} ajouté(e).`, 1500);
    }

     function handleDeleteStep(index) {
          initAudioContext();
          if (!currentEditingType || !loadedPrograms[currentEditingType] || index < 0 || index >= loadedPrograms[currentEditingType].length) return;

          const stepToDelete = loadedPrograms[currentEditingType][index];
          if (confirm(`Êtes-vous sûr de vouloir supprimer l'étape "${stepToDelete.name || 'Pause'}" ?`)) {
              loadedPrograms[currentEditingType].splice(index, 1);
              // Re-rendre tout le programme pour mettre à jour les index
              displayProgram(currentEditingType);
              markAsDirty(true);
              showMessage("Étape supprimée.", 1500);
          }
     }

    function handleEditStep(index, field, value) {
        if (!currentEditingType || !loadedPrograms[currentEditingType] || index < 0 || index >= loadedPrograms[currentEditingType].length) return;

        const step = loadedPrograms[currentEditingType][index];
        // Convertir en nombre si nécessaire (pour reps, weight, duration)
        const numericFields = ['reps', 'reps_start', 'reps_target_max', 'weight', 'duration'];
        let processedValue = value;
        if (numericFields.includes(field)) {
             // Garder null si vide, sinon convertir en nombre ou laisser tel quel si invalide
             processedValue = value.trim() === '' ? null : (isNaN(Number(value)) ? value : Number(value));
        }

        // Gérer le cas spécial du nom de la pause
        if(step.type === 'break' && field === 'name' && value.trim() === '') {
             processedValue = "Repos"; // Remettre "Repos" si vidé
             // Mettre à jour l'input visuellement aussi
             const inputElement = programDisplay.querySelector(`#name-${index}`);
             if (inputElement) inputElement.value = "Repos";
        }

        step[field] = processedValue;
        console.log(`Modification: Programme ${currentEditingType}, Index ${index}, Champ ${field}, Nouvelle valeur:`, processedValue);
        markAsDirty(true);
    }

     function handleDragEnd(event) {
         if (!currentEditingType || !loadedPrograms[currentEditingType]) return;
         console.log('Drag ended:', event);

         const { oldIndex, newIndex } = event;
         if (oldIndex === newIndex) return; // Pas de changement

         // Mettre à jour l'ordre dans le tableau de données
         const item = loadedPrograms[currentEditingType].splice(oldIndex, 1)[0];
         loadedPrograms[currentEditingType].splice(newIndex, 0, item);

         // Re-rendre pour mettre à jour les data-index et l'affichage
         displayProgram(currentEditingType);
         markAsDirty(true);
     }

    async function handleSaveProgram() {
        initAudioContext();
        if (!currentEditingType || !googleAccessToken || !programFileIds[currentEditingType]) {
             showMessage("Impossible de sauvegarder: Programme ou connexion manquante.", 4000, true);
             return;
        }
        if (!isDirty) {
            showMessage("Aucune modification à sauvegarder.", 2000);
            return;
        }

        const programToSave = loadedPrograms[currentEditingType];
        console.log(`Sauvegarde du programme: ${currentEditingType} sur Drive...`);
        showMessage(`Sauvegarde de "${currentEditingType}" en cours...`, 2000);
        if(saveProgramBtn) {
            saveProgramBtn.disabled = true;
             saveProgramBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Sauvegarde...`;
        }

        const success = await updateFileContent(programFileIds[currentEditingType], programToSave);

        if(saveProgramBtn) {
            saveProgramBtn.innerHTML = `<i class="fas fa-save"></i> Sauvegarder ${currentEditingType}`;
            // Ne réactiver que si la sauvegarde échoue ET qu'il y a encore des modifs (?)
            // Ou simplement désactiver après succès
        }

        if (success) {
            markAsDirty(false); // Reset le flag après sauvegarde réussie
            showMessage(`Programme "${currentEditingType}" sauvegardé sur Drive !`, 3000);
        } else {
            showMessage(`Échec de la sauvegarde de "${currentEditingType}". Veuillez réessayer.`, 5000, true);
            if(saveProgramBtn) saveProgramBtn.disabled = false; // Laisser la possibilité de réessayer
        }
    }

    function markAsDirty(dirtyState) {
         isDirty = dirtyState;
         updateSaveButtonState();

         // Mettre à jour l'indicateur visuel sur l'onglet
         const currentTab = programTabsContainer.querySelector(`button[data-type="${currentEditingType}"]`);
         if (currentTab) {
             currentTab.classList.toggle('is-dirty', dirtyState);
         }
    }

    function updateSaveButtonState() {
        if (!saveProgramBtn) return;
        saveProgramBtn.disabled = !isDirty || !googleAccessToken || !currentEditingType;
        if (currentEditingType) {
            saveProgramBtn.innerHTML = `<i class="fas fa-save"></i> Sauvegarder ${currentEditingType}`;
        } else {
             saveProgramBtn.innerHTML = `<i class="fas fa-save"></i> Sauvegarder`;
        }
    }

    function updateEditorActionButtonsState() {
         const enable = googleAccessToken && programsLoaded && currentEditingType;
         if(addExerciseBtn) addExerciseBtn.disabled = !enable;
         if(addBreakBtn) addBreakBtn.disabled = !enable;
         updateSaveButtonState(); // Gère aussi le bouton Save
    }

    // --- UI Update (Simplifié pour l'éditeur) ---
    function updateAuthUI(isLoggedIn) {
        console.log(`Update UI (Éditeur) - Connecté: ${isLoggedIn}, Programmes Chargés: ${programsLoaded}`);
        const body = document.body;
        body.classList.toggle('logged-in', isLoggedIn);
        body.classList.toggle('logged-out', !isLoggedIn);

        if (connectionPrompt) connectionPrompt.style.display = isLoggedIn ? 'none' : 'block';
        if (programEditorArea) programEditorArea.style.display = isLoggedIn ? 'flex' : 'none';

        if(signInButton) signInButton.disabled = isLoggedIn || !tokenClient;
        if(signInButtonPrompt) signInButtonPrompt.disabled = isLoggedIn || !tokenClient;
        if(signOutButton) signOutButton.disabled = !isLoggedIn;
        if(themeToggleBtn) themeToggleBtn.disabled = false;

        if(driveStatusElement) {
            driveStatusElement.style.display = isLoggedIn ? 'inline-block' : 'none';
             if (!isLoggedIn) driveStatusElement.textContent = '';
             // Le texte (Loading, Error, Success) est géré dans tokenCallback et handleTokenError
        }

         // Activer/désactiver les onglets et boutons d'action
         programTabsContainer.querySelectorAll('button').forEach(btn => {
             btn.disabled = !isLoggedIn || !programsLoaded;
         });
         updateEditorActionButtonsState(); // Met à jour les boutons Ajouter/Sauvegarder

         if (!isLoggedIn && programDisplay) {
             programDisplay.innerHTML = ''; // Vider l'éditeur si déconnecté
             currentEditingType = null;
             isDirty = false;
         }
    }

    // --- Gestion Thème (Identique) ---
    function applyTheme(theme) { /* ... (Code identique) ... */ const body = document.body; currentTheme = theme; body.classList.remove('light-theme', 'dark-theme'); body.classList.add(theme + '-theme'); if (themeToggleBtn) { themeToggleBtn.innerHTML = theme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>'; themeToggleBtn.setAttribute('aria-label', theme === 'dark' ? 'Passer au thème clair' : 'Passer au thème sombre'); } try { localStorage.setItem('theme', theme); console.log(`Thème appliqué/sauvegardé (Éditeur): ${theme}`); } catch (e) { console.warn("Impossible de sauvegarder le thème (Éditeur):", e); } }
    function toggleTheme() { /* ... (Code identique) ... */ const newTheme = currentTheme === 'dark' ? 'light' : 'dark'; applyTheme(newTheme); }
    function loadSavedTheme() { /* ... (Code identique) ... */ let savedTheme = 'dark'; try { savedTheme = localStorage.getItem('theme') || 'dark'; } catch (e) { console.warn("Impossible de lire le thème depuis localStorage (Éditeur):", e); } applyTheme(savedTheme); }

    // --- Message Area (Identique) ---
    function showMessage(msg, duration = 3000, isError = false) { /* ... (Code identique) ... */ if (!messageArea) return; messageArea.textContent = msg; messageArea.style.backgroundColor = isError ? 'var(--neon-red)' : 'rgba(var(--secondary-bg-color-dark-rgb), 0.9)'; messageArea.style.color = isError ? '#fff' : 'var(--primary-text-color)'; messageArea.style.borderColor = isError ? 'var(--neon-red)' : 'var(--border-color)'; messageArea.classList.add('visible'); if (messageTimeoutId) clearTimeout(messageTimeoutId); messageTimeoutId = setTimeout(() => { messageArea.classList.remove('visible'); }, duration); }


    // --- Initialisation ---
    function initializeDOMReferences() {
        console.log("Init DOM Refs (Éditeur)...");
        signInButton = document.getElementById('signin-button');
        signOutButton = document.getElementById('signout-button');
        driveStatusElement = document.getElementById('drive-status');
        themeToggleBtn = document.getElementById('theme-toggle-btn');
        signInButtonPrompt = document.getElementById('signin-button-prompt');
        connectionPrompt = document.getElementById('connection-prompt');
        programEditorArea = document.getElementById('program-editor-area');
        programTabsContainer = document.getElementById('program-tabs');
        programDisplay = document.getElementById('program-display');
        addExerciseBtn = document.getElementById('add-exercise-btn');
        addBreakBtn = document.getElementById('add-break-btn');
        saveProgramBtn = document.getElementById('save-program-btn');
        messageArea = document.getElementById('message-area');
        console.log("DOM Refs initialisées (Éditeur).");
    }

    function addEventListeners() {
         console.log("Ajout Event Listeners (Éditeur)...");
         if(signInButton) signInButton.addEventListener('click', handleAuthClick);
         if(signInButtonPrompt) signInButtonPrompt.addEventListener('click', handleAuthClick); // Aussi sur le bouton du prompt
         if(signOutButton) signOutButton.addEventListener('click', handleSignoutClick);
         if(themeToggleBtn) themeToggleBtn.addEventListener('click', toggleTheme);

         programTabsContainer?.querySelectorAll('button').forEach(btn => {
             btn.addEventListener('click', () => handleTabClick(btn.dataset.type));
         });

         if(addExerciseBtn) addExerciseBtn.addEventListener('click', () => handleAddStep('exercise'));
         if(addBreakBtn) addBreakBtn.addEventListener('click', () => handleAddStep('break'));
         if(saveProgramBtn) saveProgramBtn.addEventListener('click', handleSaveProgram);

         // Les listeners pour edit/delete/drag sont ajoutés dynamiquement dans renderStep et displayProgram
         console.log("Event Listeners ajoutés (Éditeur).");
    }

    // --- Point d'entrée ---
    document.addEventListener('DOMContentLoaded', () => {
        console.log("DOM Chargé (Éditeur). Initialisation...");
        try {
            initializeDOMReferences();
            addEventListeners();
            loadSavedTheme();
            updateAuthUI(false); // État initial déconnecté
            checkAndInitGis(); // Lancer la vérification/initialisation GIS
            console.log("Initialisation Éditeur terminée. Attente API Google...");
        } catch (error) {
            console.error("Erreur majeure lors de l'initialisation DOMContentLoaded (Éditeur):", error);
             showMessage("Erreur critique au chargement de l'éditeur.", 10000, true);
        }
    });

</script>

</body>
</html>
